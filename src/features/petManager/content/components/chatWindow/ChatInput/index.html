<template id="yi-pet-chat-input-template">
    <div class="yi-pet-chat-input-container chat-input-container" ref="rootEl">
        <div class="yi-pet-chat-toolbar chat-input-toolbar">
            <div class="yi-pet-chat-toolbar-left chat-input-btn-group">
                <button type="button" class="yi-pet-chat-btn chat-input-btn chat-input-text-btn ui-btn" title="ç¼–è¾‘é¡µé¢ä¸Šä¸‹æ–‡" aria-label="é¡µé¢ä¸Šä¸‹æ–‡" @click.stop="onContextClick">ğŸ“</button>
                <button type="button" class="yi-pet-chat-btn chat-input-btn chat-input-text-btn ui-btn" title="ç¼–è¾‘å½“å‰ä¼šè¯ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€æè¿°ç­‰ï¼‰" aria-label="ç¼–è¾‘ä¼šè¯" id="edit-session-btn" @click.stop="onEditSessionClick">âœï¸</button>
                <button type="button" class="yi-pet-chat-btn chat-input-btn chat-input-text-btn ui-btn" title="ç®¡ç†ä¼šè¯æ ‡ç­¾" aria-label="æ ‡ç­¾ç®¡ç†" @click.stop="onTagManagerClick">ğŸ·ï¸</button>
                <button type="button" class="yi-pet-chat-btn chat-input-btn chat-input-text-btn ui-btn" title="å¸¸è§é—®é¢˜" aria-label="å¸¸è§é—®é¢˜" @click.stop="onFaqClick">ğŸ’¡</button>
                <button type="button" class="yi-pet-chat-btn chat-input-btn chat-input-text-btn ui-btn" title="å¾®ä¿¡æœºå™¨äººè®¾ç½®" aria-label="å¾®ä¿¡æœºå™¨äººè®¾ç½®" @click.stop="onWeChatClick">ğŸ¤–</button>
                <button type="button" class="yi-pet-chat-btn chat-input-btn chat-input-text-btn ui-btn" title="ä¸Šä¼ å›¾ç‰‡" aria-label="ä¸Šä¼ å›¾ç‰‡" @click.stop="onImageClick">ğŸ–¼ï¸</button>
                <input ref="imageInputEl" type="file" accept="image/*" multiple class="js-hidden" id="yi-pet-chat-image-input" @change="onImageInputChange" />
            </div>

            <div class="yi-pet-chat-toolbar-right chat-input-btn-group">
                <div
                    ref="contextSwitchContainerEl"
                    class="context-switch-container"
                    :class="{ active: contextSwitchEnabled }"
                    title="å¼€å¯/å…³é—­é¡µé¢ä¸Šä¸‹æ–‡ï¼Œå¸®åŠ©AIç†è§£å½“å‰é¡µé¢å†…å®¹"
                    @click.stop="toggleContextSwitch"
                >
                    <span class="context-switch-label">é¡µé¢ä¸Šä¸‹æ–‡</span>
                    <div class="context-switch-wrapper">
                        <div class="context-switch-thumb"></div>
                    </div>
                    <input
                        type="checkbox"
                        id="context-switch"
                        class="context-switch-input"
                        :checked="contextSwitchEnabled"
                        @click.stop
                        @change.stop="onContextSwitchChange"
                    />
                </div>

                <button
                    ref="requestStatusButtonEl"
                    type="button"
                    id="request-status-btn"
                    class="chat-input-status-btn"
                    aria-label="è¯·æ±‚çŠ¶æ€"
                    title="è¯·æ±‚çŠ¶æ€ï¼šç©ºé—²"
                    disabled
                    @click.stop="onRequestStatusClick"
                >â¹ï¸</button>
            </div>
        </div>

        <div class="chat-input-wrapper">
            <div
                ref="draftImagesEl"
                class="yi-pet-chat-draft-images"
                :class="{ 'js-hidden': !draftImages || draftImages.length === 0 }"
                aria-label="å¾…å‘é€å›¾ç‰‡"
            >
                <div
                    v-for="(src, index) in draftImages"
                    :key="`${index}-${String(src).slice(0, 24)}`"
                    class="yi-pet-chat-draft-image"
                    :class="{
                        'yi-pet-chat-draft-image-loading': !!draftImageMeta?.[index]?.loading,
                        'yi-pet-chat-draft-image-error': !!draftImageMeta?.[index]?.error
                    }"
                    :data-image-index="index"
                    @click="onDraftImageClick(src, index, $event)"
                >
                    <img
                        class="yi-pet-chat-draft-image-preview"
                        :class="{ 'tw-hidden': !!draftImageMeta?.[index]?.error }"
                        :src="src"
                        :alt="`å¾…å‘é€å›¾ç‰‡ ${index + 1}`"
                        loading="lazy"
                        @load="onDraftImageLoad(index)"
                        @error="onDraftImageError(index)"
                    />
                    <button
                        type="button"
                        class="yi-pet-chat-draft-image-remove"
                        :aria-label="`ç§»é™¤ç¬¬ ${index + 1} å¼ å›¾ç‰‡`"
                        title="ç§»é™¤"
                        @click.stop="onRemoveDraftImage(index)"
                    >âœ•</button>
                </div>

                <button
                    v-if="draftImages && draftImages.length > 0"
                    type="button"
                    class="yi-pet-chat-draft-images-clear"
                    :aria-label="`æ¸…ç©ºæ‰€æœ‰ ${draftImages.length} å¼ å›¾ç‰‡`"
                    title="æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡"
                    @click.stop="onClearDraftImages"
                >æ¸…ç©ºå›¾ç‰‡ ({{ draftImages.length }})</button>
            </div>
            <div class="yi-pet-chat-input-row">
                <textarea
                    ref="textareaEl"
                    id="yi-pet-chat-input"
                    class="yi-pet-chat-textarea chat-message-input"
                    placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œï¼ŒEnter å‘é€)"
                    rows="4"
                    aria-label="ä¼šè¯è¾“å…¥æ¡†"
                    @input="onTextareaInput"
                    @keydown="onTextareaKeydown"
                    @paste="onTextareaPaste"
                    @compositionstart="onCompositionStart"
                    @compositionupdate="onCompositionUpdate"
                    @compositionend="onCompositionEnd"
                ></textarea>
            </div>
        </div>

        <teleport to="body">
            <div v-if="previewVisible" class="pet-draft-image-preview-modal" @click="onPreviewOverlayClick">
                <img :src="previewSrc" :alt="previewAlt" />
                <button type="button" class="modal-close-btn" @click.stop="closePreview">âœ•</button>
            </div>
        </teleport>
    </div>
</template>
