
/**
 * Chromeæ‰©å±•Content Script
 * è´Ÿè´£åœ¨ç½‘é¡µä¸­åˆ›å»ºå’Œç®¡ç†å® ç‰©
 */

// ä½¿ç”¨å…¬å…±æ—¥å¿—å·¥å…·ï¼ˆå¦‚æœå¯ç”¨ï¼‰
(function() {
    try {
        if (typeof LoggerUtils !== 'undefined' && LoggerUtils.initMuteLogger) {
            LoggerUtils.initMuteLogger('petDevMode', false);
        } else {
            // é™çº§åˆ°æœ¬åœ°å®ç°
            const keyName = 'petDevMode';
            const defaultEnabled = false;
            const original = {
                log: console.log,
                info: console.info,
                debug: console.debug,
                warn: console.warn
            };
            const muteIfNeeded = (enabled) => {
                if (enabled) {
                    console.log = original.log;
                    console.info = original.info;
                    console.debug = original.debug;
                    console.warn = original.warn;
                } else {
                    const noop = () => {};
                    console.log = noop;
                    console.info = noop;
                    console.debug = noop;
                    console.warn = noop;
                }
            };
            chrome.storage.sync.get([keyName], (res) => {
                const enabled = res[keyName];
                muteIfNeeded(typeof enabled === 'boolean' ? enabled : defaultEnabled);
            });
            chrome.storage.onChanged.addListener((changes, namespace) => {
                if (namespace !== 'sync') return;
                if (changes[keyName]) {
                    muteIfNeeded(changes[keyName].newValue);
                }
            });
        }
    } catch (e) {}
})();

console.log('Content Script åŠ è½½');

// æ£€æŸ¥PET_CONFIGæ˜¯å¦å¯ç”¨
if (typeof PET_CONFIG === 'undefined') {
    console.error('PET_CONFIGæœªå®šä¹‰ï¼Œå°è¯•é‡æ–°åŠ è½½config.js');

    // åˆ›å»ºé»˜è®¤é…ç½®ä½œä¸ºå¤‡ç”¨
    window.PET_CONFIG = {
        pet: {
            defaultSize: 180,
            defaultColorIndex: 0,
            defaultVisible: false,
            colors: [
                'linear-gradient(135deg, #ff6b6b, #ff8e8e)',
                'linear-gradient(135deg, #4ecdc4, #44a08d)',
                'linear-gradient(135deg, #ff9a9e, #fecfef)',
                'linear-gradient(135deg, #a8edea, #fed6e3)',
                'linear-gradient(135deg, #ffecd2, #fcb69f)'
            ],
            sizeLimits: { min: 80, max: 400 }
        },
        chatWindow: {
            defaultSize: { width: 700, height: 600 },
            sizeLimits: { minWidth: 300, maxWidth: 10000, minHeight: 200, maxHeight: 10000 },
            input: { maxLength: 200, placeholder: 'è¾“å…¥æ¶ˆæ¯...' },
            message: { maxLength: 1000, thinkingDelay: { min: 1000, max: 2000 } }
        },
        ui: {
            zIndex: {
                pet: 2147483647,
                chatWindow: 2147483648,
                resizeHandle: 20,
                inputContainer: 10,
                modal: 2147483649 // å¼¹æ¡†å±‚çº§ï¼Œç¡®ä¿åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Š
            }
        },
        storage: {
            keys: { globalState: 'petGlobalState' },
            syncInterval: 3000
        },
        chatModels: {
            default: 'qwen3',
            models: [
                { id: 'qwen3', name: 'Qwen3', icon: 'ğŸ¤–' },
                { id: 'qwen3-vl', name: 'Qwen3-VL', icon: 'ğŸ‘ï¸' },
                { id: 'qwq', name: 'QWQ', icon: 'ğŸ’¬' },
                { id: 'gpt-oss', name: 'GPT-OSS', icon: 'âœ¨' }
            ]
        },
        api: {
            streamPromptUrl: 'https://api.effiy.cn/prompt',
            promptUrl: 'https://api.effiy.cn/prompt/',
            yiaiBaseUrl: 'https://api.effiy.cn',
            syncSessionsToBackend: true
        }
    };

    console.log('å·²åˆ›å»ºé»˜è®¤PET_CONFIGé…ç½®');
}

// å­˜å‚¨å·¥å…·å‡½æ•° - ç»Ÿä¸€å¤„ç†é…é¢é”™è¯¯å’Œæ•°æ®æ¸…ç†
if (typeof window.StorageHelper === 'undefined') {
    window.StorageHelper = {
        // æ£€æŸ¥chrome.storageæ˜¯å¦å¯ç”¨
        isChromeStorageAvailable() {
            try {
                // æ£€æŸ¥åŸºæœ¬å¯¹è±¡æ˜¯å¦å­˜åœ¨
                if (typeof chrome === 'undefined' || 
                    !chrome.storage || 
                    !chrome.storage.local ||
                    !chrome.runtime) {
                    return false;
                }
                
                // æ£€æŸ¥ runtime.id æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œè¯´æ˜ä¸Šä¸‹æ–‡å·²å¤±æ•ˆï¼‰
                try {
                    const runtimeId = chrome.runtime.id;
                    if (!runtimeId) {
                        return false;
                    }
                } catch (error) {
                    // å¦‚æœè®¿é—® runtime.id æŠ›å‡ºé”™è¯¯ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ä¸Šä¸‹æ–‡å¤±æ•ˆé”™è¯¯
                    const errorMsg = (error.message || error.toString() || '').toLowerCase();
                    if (errorMsg.includes('extension context invalidated') ||
                        errorMsg.includes('context invalidated')) {
                        return false;
                    }
                    throw error;
                }
                
                return true;
            } catch (error) {
                // å¦‚æœæ•è·åˆ°ä¸Šä¸‹æ–‡å¤±æ•ˆé”™è¯¯ï¼Œè¿”å› false
                const errorMsg = (error.message || error.toString() || '').toLowerCase();
                if (errorMsg.includes('extension context invalidated') ||
                    errorMsg.includes('context invalidated')) {
                    return false;
                }
                return false;
            }
        },
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯é…é¢é”™è¯¯
        isQuotaError(error) {
            if (!error) return false;
            const errorMsg = error.message || error.toString();
            return errorMsg.includes('QUOTA_BYTES') || 
                   errorMsg.includes('quota exceeded') ||
                   errorMsg.includes('QuotaExceededError') ||
                   errorMsg.includes('MAX_WRITE_OPERATIONS') ||
                   errorMsg.includes('QUOTA_BYTES_PER_HOUR');
        },
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸Šä¸‹æ–‡å¤±æ•ˆé”™è¯¯
        isContextInvalidatedError(error) {
            if (!error) return false;
            const errorMsg = (error.message || error.toString() || '').toLowerCase();
            return errorMsg.includes('extension context invalidated') ||
                   errorMsg.includes('context invalidated') ||
                   errorMsg.includes('the message port closed') ||
                   errorMsg.includes('message port closed') ||
                   errorMsg.includes('receiving end does not exist') ||
                   errorMsg.includes('could not establish connection');
        },
        
        
        // æ¸…ç†æ—§æ•°æ®ä»¥é‡Šæ”¾ç©ºé—´
        async cleanupOldData() {
            try {
                // æ£€æŸ¥chrome.storageæ˜¯å¦å¯ç”¨
                if (!this.isChromeStorageAvailable()) {
                    console.debug('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè·³è¿‡æ¸…ç†');
                    return;
                }
                
                // è·å–æ‰€æœ‰å­˜å‚¨çš„æ•°æ®
                const allData = await new Promise((resolve) => {
                    try {
                        chrome.storage.local.get(null, (items) => {
                            if (chrome.runtime.lastError) {
                                const error = chrome.runtime.lastError;
                                if (this.isContextInvalidatedError(error)) {
                                    console.debug('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè·³è¿‡æ¸…ç†');
                                    resolve({});
                                    return;
                                }
                            }
                            resolve(items || {});
                        });
                    } catch (error) {
                        if (this.isContextInvalidatedError(error)) {
                            console.debug('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè·³è¿‡æ¸…ç†');
                            resolve({});
                        } else {
                            throw error;
                        }
                    }
                });
                
                // æŒ‰ä¼˜å…ˆçº§æ¸…ç†æ•°æ®
                const cleanupKeys = [
                    'petOssFiles', // OSSæ–‡ä»¶åˆ—è¡¨ï¼ˆå¯ä»¥é‡æ–°åŠ è½½ï¼‰
                ];
                
                for (const key of cleanupKeys) {
                    if (allData[key]) {
                        // å…¶ä»–æ•°æ®ç›´æ¥æ¸…ç©º
                        if (this.isChromeStorageAvailable()) {
                            await new Promise((resolve) => {
                                try {
                                    chrome.storage.local.remove(key, () => {
                                        if (chrome.runtime.lastError && this.isContextInvalidatedError(chrome.runtime.lastError)) {
                                            console.debug('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè·³è¿‡æ¸…ç†');
                                        }
                                        resolve();
                                    });
                                } catch (error) {
                                    if (this.isContextInvalidatedError(error)) {
                                        console.debug('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè·³è¿‡æ¸…ç†');
                                    }
                                    resolve();
                                }
                            });
                            console.log(`å·²æ¸…ç†å­˜å‚¨é”®: ${key}`);
                        }
                    }
                }
                
            } catch (error) {
                console.error('æ¸…ç†å­˜å‚¨æ•°æ®å¤±è´¥:', error);
            }
        },
        
        // é™çº§åˆ°localStorageçš„è¾…åŠ©å‡½æ•°
        _fallbackToLocalStorage(key, value, contextInvalidated = false) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return { success: true, fallback: 'localStorage', contextInvalidated };
            } catch (localError) {
                console.error('localStorageå­˜å‚¨å¤±è´¥:', localError);
                return { success: false, error: localError.message || 'å­˜å‚¨å¤±è´¥' };
            }
        },
        
        // å¤„ç†å­˜å‚¨é”™è¯¯çš„è¾…åŠ©å‡½æ•°
        _handleStorageError(key, value, error, resolve) {
            if (this.isContextInvalidatedError(error)) {
                resolve(this._fallbackToLocalStorage(key, value, true));
                return true;
            }
            
            if (this.isQuotaError(error)) {
                console.warn('å­˜å‚¨é…é¢è¶…å‡ºï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®...');
                this.cleanupOldData().then(() => {
                    if (!this.isChromeStorageAvailable()) {
                        resolve(this._fallbackToLocalStorage(key, value, true));
                        return;
                    }
                    // é‡è¯•ä¿å­˜
                    chrome.storage.local.set({ [key]: value }, (retryError) => {
                        if (chrome.runtime.lastError) {
                            const retryErr = chrome.runtime.lastError;
                            if (this.isContextInvalidatedError(retryErr) || this.isQuotaError(retryErr)) {
                                resolve(this._fallbackToLocalStorage(key, value, this.isContextInvalidatedError(retryErr)));
                            } else {
                                resolve({ success: false, error: retryErr.message });
                            }
                        } else {
                            resolve({ success: true, retried: true });
                        }
                    });
                });
                return true;
            }
            
            // å…¶ä»–é”™è¯¯ï¼Œé™çº§åˆ°localStorage
            console.debug('å­˜å‚¨æ“ä½œå·²é™çº§åˆ°localStorage');
            resolve(this._fallbackToLocalStorage(key, value));
            return true;
        },
        
        // å®‰å…¨çš„å­˜å‚¨è®¾ç½®å‡½æ•°
        async set(key, value, options = {}) {
            return new Promise(async (resolve) => {
                // å¦‚æœchrome.storageä¸å¯ç”¨ï¼Œç›´æ¥é™çº§åˆ°localStorage
                if (!this.isChromeStorageAvailable()) {
                    resolve(this._fallbackToLocalStorage(key, value, true));
                    return;
                }
                
                try {
                    chrome.storage.local.set({ [key]: value }, async () => {
                        if (chrome.runtime.lastError) {
                            const error = chrome.runtime.lastError;
                            if (!this._handleStorageError(key, value, error, resolve)) {
                                resolve({ success: true });
                            }
                        } else {
                            resolve({ success: true });
                        }
                    });
                } catch (error) {
                    const errorMsg = (error.message || error.toString() || '').toLowerCase();
                    const isContextInvalidated = this.isContextInvalidatedError(error) || 
                                                !this.isChromeStorageAvailable() ||
                                                errorMsg.includes('invalidated');
                    resolve(this._fallbackToLocalStorage(key, value, isContextInvalidated));
                }
            });
        },
        
        // ä»localStorageè¯»å–çš„è¾…åŠ©å‡½æ•°
        _getFromLocalStorage(key) {
            try {
                const localValue = localStorage.getItem(key);
                return localValue ? JSON.parse(localValue) : null;
            } catch (error) {
                console.warn('ä»localStorageè¯»å–å¤±è´¥:', error);
                return null;
            }
        },
        
        // å®‰å…¨çš„å­˜å‚¨è·å–å‡½æ•°
        async get(key) {
            return new Promise((resolve) => {
                // å¦‚æœchrome.storageä¸å¯ç”¨ï¼Œç›´æ¥ä½¿ç”¨localStorage
                if (!this.isChromeStorageAvailable()) {
                    console.debug('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè‡ªåŠ¨ä½¿ç”¨localStorage');
                    resolve(this._getFromLocalStorage(key));
                    return;
                }
                
                try {
                    chrome.storage.local.get([key], (result) => {
                        if (chrome.runtime.lastError) {
                            const error = chrome.runtime.lastError;
                            if (this.isContextInvalidatedError(error)) {
                                console.debug('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè‡ªåŠ¨ä½¿ç”¨localStorage');
                            } else {
                                console.debug('å·²è‡ªåŠ¨é™çº§åˆ°localStorage');
                            }
                            resolve(this._getFromLocalStorage(key));
                        } else {
                            resolve(result[key] || null);
                        }
                    });
                } catch (error) {
                    const errorMsg = (error.message || error.toString() || '').toLowerCase();
                    const isContextInvalidated = this.isContextInvalidatedError(error) || 
                                                !this.isChromeStorageAvailable() || 
                                                errorMsg.includes('invalidated');
                    if (isContextInvalidated) {
                        console.debug('æ‰©å±•å·²é‡æ–°åŠ è½½ï¼Œè‡ªåŠ¨ä½¿ç”¨localStorage');
                    } else {
                        console.debug('å·²è‡ªåŠ¨é™çº§åˆ°localStorage');
                    }
                    resolve(this._getFromLocalStorage(key));
                }
            });
        }
    };
}

// æ·»åŠ é»˜è®¤å·¥å…·å‡½æ•°
if (typeof getPetDefaultPosition === 'undefined') {
    window.getPetDefaultPosition = function() {
        return { x: 20, y: Math.round(window.innerHeight * 0.2) };
    };
}

if (typeof getChatWindowDefaultPosition === 'undefined') {
    window.getChatWindowDefaultPosition = function(width, height) {
        return {
            x: Math.max(0, (window.innerWidth - width) / 2),
            y: Math.round(window.innerHeight * 0.12)
        };
    };
}

if (typeof getCenterPosition === 'undefined') {
    window.getCenterPosition = function(elementSize, windowSize) {
        return Math.max(0, (windowSize - elementSize) / 2);
    };
}

// é˜²æ­¢é‡å¤å£°æ˜ PetManager
(function() {
    'use strict';
    if (typeof window.PetManager !== 'undefined') {
        return; // å¦‚æœå·²ç»å­˜åœ¨ï¼Œç›´æ¥è¿”å›
    }
    
    class PetManager {
    constructor() {
        this.pet = null;
        this.isVisible = PET_CONFIG.pet.defaultVisible;
        this.colorIndex = PET_CONFIG.pet.defaultColorIndex;
        this.size = PET_CONFIG.pet.defaultSize;
        this.position = getPetDefaultPosition();
        this.role = 'æ•™å¸ˆ'; // é»˜è®¤è§’è‰²ä¸ºæ•™å¸ˆ
        this.chatWindow = null;
        this.isChatOpen = false;
        this.currentModel = (PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3';

        this.colors = PET_CONFIG.pet.colors;
        this.mermaidLoaded = false;
        this.mermaidLoading = false;
        this.jszipLoaded = false;
        this.jszipLoading = false;

        // ä¼šè¯ç®¡ç†ç›¸å…³å±æ€§
        this.currentSessionId = null;
        this.sessions = {}; // å­˜å‚¨æ‰€æœ‰ä¼šè¯ï¼Œkeyä¸ºsessionIdï¼Œvalueä¸ºä¼šè¯æ•°æ®
        this.sessionSidebar = null; // ä¼šè¯ä¾§è¾¹æ å…ƒç´ 
        this.isSwitchingSession = false; // æ˜¯å¦æ­£åœ¨åˆ‡æ¢ä¼šè¯ï¼ˆé˜²æŠ–æ ‡å¿—ï¼‰
        this.currentPageUrl = null; // å½“å‰é¡µé¢URLï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºæ–°é¡µé¢
        this.hasAutoCreatedSessionForPage = false; // å½“å‰é¡µé¢æ˜¯å¦å·²ç»è‡ªåŠ¨åˆ›å»ºäº†ä¼šè¯
        this.sessionInitPending = false; // ä¼šè¯åˆå§‹åŒ–æ˜¯å¦æ­£åœ¨è¿›è¡Œä¸­
        this.sidebarWidth = 200; // ä¾§è¾¹æ å®½åº¦ï¼ˆåƒç´ ï¼‰
        this.isResizingSidebar = false; // æ˜¯å¦æ­£åœ¨è°ƒæ•´ä¾§è¾¹æ å®½åº¦
        this.sidebarCollapsed = false; // ä¾§è¾¹æ æ˜¯å¦æŠ˜å 
        this.inputContainerCollapsed = false; // è¾“å…¥æ¡†å®¹å™¨æ˜¯å¦æŠ˜å 
        
        // ä¼šè¯æ›´æ–°ä¼˜åŒ–ç›¸å…³
        this.sessionUpdateTimer = null; // ä¼šè¯æ›´æ–°é˜²æŠ–å®šæ—¶å™¨
        this.pendingSessionUpdate = false; // æ˜¯å¦æœ‰å¾…å¤„ç†çš„ä¼šè¯æ›´æ–°
        this.lastSessionSaveTime = 0; // ä¸Šæ¬¡ä¿å­˜ä¼šè¯çš„æ—¶é—´
        this.SESSION_UPDATE_DEBOUNCE = 300; // ä¼šè¯æ›´æ–°é˜²æŠ–æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        this.SESSION_SAVE_THROTTLE = 1000; // ä¼šè¯ä¿å­˜èŠ‚æµæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        
        // æ ‡ç­¾è¿‡æ»¤ç›¸å…³
        this.selectedFilterTags = []; // é€‰ä¸­çš„è¿‡æ»¤æ ‡ç­¾ï¼ˆä¼šè¯ï¼‰
        this.tagFilterReverse = false; // æ˜¯å¦åå‘è¿‡æ»¤ï¼ˆä¼šè¯ï¼‰
        this.tagFilterNoTags = false; // æ˜¯å¦ç­›é€‰æ— æ ‡ç­¾çš„ä¼šè¯
        this.tagFilterExpanded = false; // æ ‡ç­¾åˆ—è¡¨æ˜¯å¦å±•å¼€ï¼ˆä¼šè¯ï¼‰
        this.tagFilterVisibleCount = 8; // æŠ˜å æ—¶æ˜¾ç¤ºçš„æ ‡ç­¾æ•°é‡ï¼ˆä¼šè¯ï¼‰
        this.tagFilterSearchKeyword = ''; // æ ‡ç­¾æœç´¢å…³é”®è¯
        this.tagOrder = null; // æ ‡ç­¾é¡ºåºï¼ˆä»localStorageåŠ è½½ï¼‰
        
        // OSSæ–‡ä»¶æ ‡ç­¾è¿‡æ»¤ç›¸å…³
        this.selectedOssFilterTags = []; // é€‰ä¸­çš„OSSæ–‡ä»¶è¿‡æ»¤æ ‡ç­¾
        this.ossTagFilterReverse = false; // æ˜¯å¦åå‘è¿‡æ»¤OSSæ–‡ä»¶
        this.ossTagFilterNoTags = false; // æ˜¯å¦ç­›é€‰æ— æ ‡ç­¾çš„OSSæ–‡ä»¶
        this.ossTagFilterExpanded = false; // OSSæ ‡ç­¾åˆ—è¡¨æ˜¯å¦å±•å¼€
        this.ossTagFilterVisibleCount = 8; // æŠ˜å æ—¶æ˜¾ç¤ºçš„OSSæ ‡ç­¾æ•°é‡
        this.ossTagFilterSearchKeyword = ''; // OSSæ ‡ç­¾æœç´¢å…³é”®è¯
        
        // æ–°é—»æ ‡ç­¾è¿‡æ»¤ç›¸å…³
        this.selectedNewsFilterTags = []; // é€‰ä¸­çš„æ–°é—»è¿‡æ»¤æ ‡ç­¾
        this.newsTagFilterReverse = false; // æ˜¯å¦åå‘è¿‡æ»¤æ–°é—»
        this.newsTagFilterNoTags = false; // æ˜¯å¦ç­›é€‰æ— æ ‡ç­¾çš„æ–°é—»
        this.newsTagFilterExpanded = false; // æ–°é—»æ ‡ç­¾åˆ—è¡¨æ˜¯å¦å±•å¼€
        this.newsTagFilterVisibleCount = 8; // æŠ˜å æ—¶æ˜¾ç¤ºçš„æ–°é—»æ ‡ç­¾æ•°é‡
        this.newsTagFilterSearchKeyword = ''; // æ–°é—»æ ‡ç­¾æœç´¢å…³é”®è¯
        
        // è¯·æ±‚æ¥å£æ ‡ç­¾è¿‡æ»¤ç›¸å…³
        this.selectedApiRequestFilterTags = []; // é€‰ä¸­çš„è¯·æ±‚æ¥å£è¿‡æ»¤æ ‡ç­¾
        this.apiRequestTagFilterReverse = false; // æ˜¯å¦åå‘è¿‡æ»¤è¯·æ±‚æ¥å£
        this.apiRequestTagFilterNoTags = false; // æ˜¯å¦ç­›é€‰æ— æ ‡ç­¾çš„è¯·æ±‚æ¥å£
        this.apiRequestTagFilterExpanded = false; // è¯·æ±‚æ¥å£æ ‡ç­¾åˆ—è¡¨æ˜¯å¦å±•å¼€
        this.apiRequestTagFilterVisibleCount = 8; // æŠ˜å æ—¶æ˜¾ç¤ºçš„è¯·æ±‚æ¥å£æ ‡ç­¾æ•°é‡
        this.apiRequestTagFilterSearchKeyword = ''; // è¯·æ±‚æ¥å£æ ‡ç­¾æœç´¢å…³é”®è¯
        
        this.sessionTitleFilter = ''; // ä¼šè¯æ ‡é¢˜æœç´¢è¿‡æ»¤å…³é”®è¯
        this.dateRangeFilter = null; // æ—¥æœŸåŒºé—´è¿‡æ»¤ { startDate: Date, endDate: Date } æˆ– nullï¼Œæ”¯æŒåªé€‰æ‹©ç»“æŸæ—¥æœŸæ¥ç­›é€‰ç»“æŸæ—¥æœŸä¹‹å‰çš„è®°å½•
        this.calendarCollapsed = true; // æ—¥å†æ˜¯å¦æŠ˜å 
        this.calendarMonth = null; // å½“å‰æ˜¾ç¤ºçš„æ—¥å†æœˆä»½
        
        // æ‰¹é‡æ“ä½œç›¸å…³
        this.batchMode = false; // æ˜¯å¦å¤„äºæ‰¹é‡é€‰æ‹©æ¨¡å¼
        this.selectedSessionIds = new Set(); // é€‰ä¸­çš„ä¼šè¯IDé›†åˆ
        this.selectedFileNames = new Set(); // é€‰ä¸­çš„æ–‡ä»¶åç§°é›†åˆ
        this.selectedApiRequestIds = new Set(); // é€‰ä¸­çš„è¯·æ±‚æ¥å£ key é›†åˆï¼ˆä½¿ç”¨ key å­—æ®µä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
        this.selectedNewsIds = new Set(); // é€‰ä¸­çš„æ–°é—»IDé›†åˆï¼ˆä½¿ç”¨linkä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
        this.currentFile = null; // å½“å‰é€‰ä¸­çš„æ–‡ä»¶
        
        // ä¼šè¯APIç®¡ç†å™¨
        this.sessionApi = null;
        this.lastSessionListLoadTime = 0;
        this.SESSION_LIST_RELOAD_INTERVAL = 10000; // ä¼šè¯åˆ—è¡¨é‡æ–°åŠ è½½é—´éš”ï¼ˆ10ç§’ï¼‰
        this.isPageFirstLoad = true; // æ ‡è®°æ˜¯å¦æ˜¯é¡µé¢é¦–æ¬¡åŠ è½½/åˆ·æ–°
        this.skipSessionListRefresh = false; // æ ‡è®°æ˜¯å¦è·³è¿‡ä¼šè¯åˆ—è¡¨åˆ·æ–°ï¼ˆpromptè°ƒç”¨åä½¿ç”¨ï¼‰
        this.backendSessionIds = new Set(); // å­˜å‚¨åç«¯ä¼šè¯IDé›†åˆï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºä¿å­˜æŒ‰é’®
        this.isChatWindowFirstOpen = true; // æ ‡è®°æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€èŠå¤©çª—å£
        
        // OSSæ–‡ä»¶ç®¡ç†ç›¸å…³å±æ€§
        this.ossApi = null;
        this.ossFileManager = null;
        this.ossFileListVisible = false; // OSSæ–‡ä»¶åˆ—è¡¨æ˜¯å¦å¯è§
        this.currentOssDirectory = ''; // å½“å‰OSSç›®å½•
        this.ossImagePreviewEnabled = false; // OSSå›¾ç‰‡é¢„è§ˆå¼€å…³ï¼ˆé»˜è®¤å…³é—­ï¼Œç”¨äºæ ‡ç­¾æ¨¡å—çš„æ‰¹é‡æ§åˆ¶ï¼‰
        this.ossFilePreviewStates = {}; // æ¯ä¸ªæ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€ { fileName: true/false }
        this.hasRequestedFiles = false; // æ ‡è®°æ˜¯å¦å·²ç»è¯·æ±‚è¿‡æ–‡ä»¶åˆ—è¡¨ï¼ˆç”¨äºå»¶è¿ŸåŠ è½½ï¼‰
        
        // æ–°é—»ç®¡ç†ç›¸å…³å±æ€§
        this.newsManager = null;
        this.newsListVisible = false; // æ–°é—»åˆ—è¡¨æ˜¯å¦å¯è§
        this.hasRequestedNews = false; // æ ‡è®°æ˜¯å¦å·²ç»è¯·æ±‚è¿‡æ–°é—»åˆ—è¡¨ï¼ˆç”¨äºå»¶è¿ŸåŠ è½½ï¼‰
        this.lastNewsDateRange = null; // ä¸Šæ¬¡åŠ è½½æ–°é—»çš„æ—¥æœŸåŒºé—´ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½ï¼‰
        
        // æ¥å£è¯·æ±‚ç®¡ç†ç›¸å…³å±æ€§
        this.apiRequestManager = null;
        this.apiRequestListVisible = false; // æ¥å£è¯·æ±‚åˆ—è¡¨æ˜¯å¦å¯è§
        
        // RSSæºç®¡ç†å™¨
        this.rssSourceManager = null;
        this.rssSourceManagerVisible = false; // RSSæºç®¡ç†ç•Œé¢æ˜¯å¦å¯è§
        
        // FAQ APIç®¡ç†å™¨
        this.faqApi = null;
        
        // è¯·æ±‚æ¥å£ APIç®¡ç†å™¨
        this.apiRequestApi = null;

        // çŠ¶æ€ä¿å­˜èŠ‚æµç›¸å…³
        this.lastStateSaveTime = 0; // ä¸Šæ¬¡ä¿å­˜çŠ¶æ€çš„æ—¶é—´
        this.STATE_SAVE_THROTTLE = 2000; // çŠ¶æ€ä¿å­˜èŠ‚æµæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé¿å…è¶…è¿‡chrome.storage.syncçš„å†™å…¥é™åˆ¶
        this.stateSaveTimer = null; // çŠ¶æ€ä¿å­˜é˜²æŠ–å®šæ—¶å™¨
        this.pendingStateUpdate = null; // å¾…ä¿å­˜çš„çŠ¶æ€æ•°æ®
        this.useLocalStorage = false; // æ˜¯å¦ä½¿ç”¨localStorageä½œä¸ºé™çº§æ–¹æ¡ˆï¼ˆå½“é‡åˆ°é…é¢é”™è¯¯æ—¶ï¼‰

        // åŠ è½½åŠ¨ç”»è®¡æ•°å™¨
        this.activeRequestCount = 0;

        this.init();
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
     */
    _showLoadingAnimation() {
        this.activeRequestCount++;
        if (this.activeRequestCount === 1 && typeof window !== 'undefined' && window.petLoadingAnimation) {
            window.petLoadingAnimation.show();
        }
    }
    
    /**
     * éšè—åŠ è½½åŠ¨ç”»
     */
    _hideLoadingAnimation() {
        this.activeRequestCount = Math.max(0, this.activeRequestCount - 1);
        if (this.activeRequestCount === 0 && typeof window !== 'undefined' && window.petLoadingAnimation) {
            window.petLoadingAnimation.hide();
        }
    }
    
    /**
     * å¸¦åŠ è½½åŠ¨ç”»çš„ fetch åŒ…è£…å‡½æ•°
     * @param {string} url - è¯·æ±‚URL
     * @param {Object} options - fetché€‰é¡¹
     * @returns {Promise<Response>} fetchå“åº”
     */
    async _fetchWithLoading(url, options = {}) {
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        this._showLoadingAnimation();
        
        try {
            const response = await fetch(url, options);
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            return response;
        } catch (error) {
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            throw error;
        }
    }

    async init() {
        // åŠ è½½æ ‡ç­¾é¡ºåº
        this.loadTagOrder();
        console.log('åˆå§‹åŒ–å® ç‰©ç®¡ç†å™¨');
        
        // åˆå§‹åŒ–ä¼šè¯APIç®¡ç†å™¨
        if (typeof SessionApiManager !== 'undefined' && PET_CONFIG.api.syncSessionsToBackend) {
            this.sessionApi = new SessionApiManager(
                PET_CONFIG.api.yiaiBaseUrl,
                PET_CONFIG.api.syncSessionsToBackend
            );
            console.log('ä¼šè¯APIç®¡ç†å™¨å·²åˆå§‹åŒ–');
        } else {
            console.log('ä¼šè¯APIç®¡ç†å™¨æœªå¯ç”¨');
        }
        
        // åˆå§‹åŒ–OSS APIç®¡ç†å™¨
        if (typeof OssApiManager !== 'undefined' && PET_CONFIG.api.yiaiBaseUrl) {
            this.ossApi = new OssApiManager(
                PET_CONFIG.api.yiaiBaseUrl,
                true
            );
            console.log('OSS APIç®¡ç†å™¨å·²åˆå§‹åŒ–');
            
            // åˆå§‹åŒ–OSSæ–‡ä»¶ç®¡ç†å™¨
            if (typeof OssFileManager !== 'undefined') {
                this.ossFileManager = new OssFileManager({
                    ossApi: this.ossApi,
                    enableBackendSync: true,
                    directory: this.currentOssDirectory
                });
                await this.ossFileManager.initialize();
                console.log('OSSæ–‡ä»¶ç®¡ç†å™¨å·²åˆå§‹åŒ–');
            }
        } else {
            console.log('OSS APIç®¡ç†å™¨æœªå¯ç”¨');
        }
        
        // åˆå§‹åŒ–FAQ APIç®¡ç†å™¨
        if (typeof FaqApiManager !== 'undefined') {
            this.faqApi = new FaqApiManager('https://api.effiy.cn/mongodb', true);
            console.log('FAQ APIç®¡ç†å™¨å·²åˆå§‹åŒ–');
        } else {
            console.log('FAQ APIç®¡ç†å™¨æœªå¯ç”¨');
        }
        
        // åˆå§‹åŒ–è¯·æ±‚æ¥å£ APIç®¡ç†å™¨
        if (typeof ApiRequestApiManager !== 'undefined') {
            this.apiRequestApi = new ApiRequestApiManager('https://api.effiy.cn/mongodb', true);
            console.log('è¯·æ±‚æ¥å£ APIç®¡ç†å™¨å·²åˆå§‹åŒ–');
        } else {
            console.log('è¯·æ±‚æ¥å£ APIç®¡ç†å™¨æœªå¯ç”¨');
        }
        
        // åˆå§‹åŒ–æ–°é—»ç®¡ç†å™¨
        if (typeof NewsManager !== 'undefined') {
            this.newsManager = new NewsManager({
                apiUrl: 'https://api.effiy.cn/mongodb/',
                cname: 'rss',
                enableCache: true
            });
            await this.newsManager.initialize();
            console.log('æ–°é—»ç®¡ç†å™¨å·²åˆå§‹åŒ–');
        } else {
            console.log('æ–°é—»ç®¡ç†å™¨æœªå¯ç”¨');
        }
        
        // åˆå§‹åŒ–æ¥å£è¯·æ±‚ç®¡ç†å™¨ï¼ˆä»…ç”¨äºå­˜å‚¨ä»APIè·å–çš„æ•°æ®ï¼Œä¸æ‹¦æˆªæœ¬åœ°è¯·æ±‚ï¼‰
        if (typeof ApiRequestManager !== 'undefined') {
            this.apiRequestManager = new ApiRequestManager({
                enableRecording: false, // ç¦ç”¨è¯·æ±‚æ‹¦æˆªï¼Œä¸è®°å½•æœ¬åœ°è¯·æ±‚
                maxRecords: 1000,
                filterExtensionRequests: true,
                enableStorageSync: false // ç¦ç”¨å­˜å‚¨åŒæ­¥ï¼Œä¸ä» storage åŒæ­¥æœ¬åœ°è¯·æ±‚
            });
            await this.apiRequestManager.initialize();
            console.log('æ¥å£è¯·æ±‚ç®¡ç†å™¨å·²åˆå§‹åŒ–ï¼ˆä»…APIæ¨¡å¼ï¼‰');
            
            // ä¸å†ç›‘å¬æ¥å£è¯·æ±‚è®°å½•äº‹ä»¶ï¼Œå› ä¸ºå·²ç¦ç”¨æœ¬åœ°è¯·æ±‚æ‹¦æˆª
        } else {
            console.log('æ¥å£è¯·æ±‚ç®¡ç†å™¨æœªå¯ç”¨');
        }
        
        // åˆå§‹åŒ–RSSæºç®¡ç†å™¨
        if (typeof RssSourceManager !== 'undefined') {
            const yiaiBaseUrl = PET_CONFIG?.api?.yiaiBaseUrl || 'https://api.effiy.cn';
            this.rssSourceManager = new RssSourceManager({
                apiUrl: `${yiaiBaseUrl}/mongodb/`,
                rssApiUrl: `${yiaiBaseUrl}/rss`,
                cname: 'seeds',
                enabled: true
            });
            await this.rssSourceManager.initialize();
            console.log('RSSæºç®¡ç†å™¨å·²åˆå§‹åŒ–');
        } else {
            console.log('RSSæºç®¡ç†å™¨æœªå¯ç”¨');
        }
        
        this.loadState(); // åŠ è½½ä¿å­˜çš„çŠ¶æ€
        this.loadOssImagePreviewState(); // åŠ è½½OSSå›¾ç‰‡é¢„è§ˆå¼€å…³çŠ¶æ€
        this.loadOssFilePreviewStates(); // åŠ è½½æ¯ä¸ªæ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€
        this.setupMessageListener();
        this.createPet();
        
        // å»¶è¿Ÿæ£€æŸ¥å¹¶æ›´æ–°å® ç‰©æ˜¾ç¤ºçŠ¶æ€ï¼Œç¡®ä¿çŠ¶æ€åŠ è½½å®Œæˆåæ ·å¼æ­£ç¡®
        setTimeout(() => {
            if (this.pet) {
                console.log('å»¶è¿Ÿæ£€æŸ¥ï¼šæ›´æ–°å® ç‰©æ ·å¼ï¼Œå¯è§æ€§:', this.isVisible);
                this.updatePetStyle();
                // å¦‚æœå® ç‰©å·²åˆ›å»ºä½†è¿˜æ²¡æœ‰æ·»åŠ åˆ°é¡µé¢ï¼Œå°è¯•å†æ¬¡æ·»åŠ 
                if (!this.pet.parentNode) {
                    console.log('å»¶è¿Ÿæ£€æŸ¥ï¼šå® ç‰©æœªæ·»åŠ åˆ°é¡µé¢ï¼Œå°è¯•é‡æ–°æ·»åŠ ');
                    this.addPetToPage();
                }
            }
        }, 500);
        
        // å¯åŠ¨å®šæœŸåŒæ­¥ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
        this.startPeriodicSync();

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        this.setupKeyboardShortcuts();

        // åˆå§‹åŒ–ä¼šè¯ï¼šç­‰å¾…é¡µé¢åŠ è½½å®Œæˆå1ç§’å†åˆ›å»ºæ–°ä¼šè¯
        this.initSessionWithDelay();
        
        // ç›‘å¬é¡µé¢æ ‡é¢˜å˜åŒ–ï¼Œä»¥ä¾¿åœ¨æ ‡é¢˜æ”¹å˜æ—¶æ›´æ–°ä¼šè¯
        this.setupTitleChangeListener();
        
        // ç›‘å¬URLå˜åŒ–ï¼Œä»¥ä¾¿åœ¨URLæ”¹å˜æ—¶åˆ›å»ºæ–°ä¼šè¯ï¼ˆæ”¯æŒå•é¡µåº”ç”¨ï¼‰
        this.setupUrlChangeListener();
        
        // æ³¨æ„ï¼šå·²ç§»é™¤å¤šé¡µé¢ä¼šè¯åˆ—è¡¨åŒæ­¥é€»è¾‘ï¼Œå¤šé¡µé¢ä¹‹é—´çš„ä¼šè¯äº’ç›¸ç‹¬ç«‹
    }

    // å»¶è¿Ÿåˆå§‹åŒ–ä¼šè¯ï¼šç­‰å¾…é¡µé¢åŠ è½½å®Œæˆå1ç§’å†æ‰§è¡Œ
    async initSessionWithDelay() {
        // ä½¿ç”¨æ ‡å¿—é˜²æ­¢é‡å¤æ‰§è¡Œ
        if (this.sessionInitPending) {
            return;
        }
        this.sessionInitPending = true;

        // æ£€æŸ¥é¡µé¢æ˜¯å¦å·²ç»åŠ è½½å®Œæˆ
        const isPageLoaded = document.readyState === 'complete';
        
        if (isPageLoaded) {
            // é¡µé¢å·²ç»åŠ è½½å®Œæˆï¼Œå»¶è¿Ÿ1ç§’ååˆå§‹åŒ–ä¼šè¯
            console.log('é¡µé¢å·²åŠ è½½å®Œæˆï¼Œç­‰å¾…1ç§’ååˆå§‹åŒ–ä¼šè¯');
            await new Promise(resolve => setTimeout(resolve, 1000));
            await this.initSession();
        } else {
            // é¡µé¢å°šæœªåŠ è½½å®Œæˆï¼Œç­‰å¾…åŠ è½½å®Œæˆåå†å»¶è¿Ÿ1ç§’
            console.log('ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆï¼Œç„¶åå»¶è¿Ÿ1ç§’ååˆå§‹åŒ–ä¼šè¯');
            const handleLoad = async () => {
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ‰§è¡Œ
                window.removeEventListener('load', handleLoad);
                
                // å»¶è¿Ÿ1ç§’ååˆå§‹åŒ–ä¼šè¯
                await new Promise(resolve => setTimeout(resolve, 1000));
                await this.initSession();
            };
            
            // ç›‘å¬é¡µé¢å®Œå…¨åŠ è½½å®Œæˆäº‹ä»¶ï¼ˆåŒ…æ‹¬æ‰€æœ‰èµ„æºï¼‰
            window.addEventListener('load', handleLoad);
        }
    }

    setupMessageListener() {
        // ç›‘å¬chrome.runtimeæ¶ˆæ¯
        chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', request);

            switch (request.action) {
                case 'ping':
                    sendResponse({ success: true, message: 'pong' });
                    break;

                case 'initPet':
                    this.createPet();
                    sendResponse({ success: true });
                    break;

                case 'toggleVisibility':
                    this.toggleVisibility();
                    sendResponse({ success: true, visible: this.isVisible });
                    break;

                case 'changeColor':
                    this.changeColor();
                    sendResponse({ success: true, color: this.colorIndex });
                    break;

                case 'setColor':
                    this.setColor(request.color);
                    sendResponse({ success: true, color: this.colorIndex });
                    break;

                case 'changeSize':
                    this.setSize(request.size);
                    sendResponse({ success: true, size: this.size });
                    break;

                case 'resetPosition':
                    this.resetPosition();
                    sendResponse({ success: true });
                    break;

                case 'centerPet':
                    this.centerPet();
                    sendResponse({ success: true });
                    break;

                case 'setRole':
                    this.setRole(request.role);
                    sendResponse({ success: true, role: this.role });
                    break;

                case 'setModel':
                    this.setModel(request.model);
                    sendResponse({ success: true, model: this.currentModel });
                    break;

                case 'getStatus':
                    sendResponse({
                        visible: this.isVisible,
                        color: this.colorIndex,
                        size: this.size,
                        position: this.position,
                        role: this.role || 'æ•™å¸ˆ',
                        model: this.currentModel
                    });
                    break;

                case 'ossFileClick':
                    // å¤„ç†OSSæ–‡ä»¶ç‚¹å‡»
                    this.handleOssFileClick(request.file).catch(error => {
                        console.error('å¤„ç†OSSæ–‡ä»¶ç‚¹å‡»å¤±è´¥:', error);
                    });
                    sendResponse({ success: true });
                    break;

                case 'getFullPageText':
                    const text = this.getFullPageText();
                    sendResponse({ text: text });
                    break;

                case 'removePet':
                    this.removePet();
                    sendResponse({ success: true });
                    break;

                case 'globalStateUpdated':
                    this.handleGlobalStateUpdate(request.data);
                    sendResponse({ success: true });
                    break;

                case 'chatWithPet':
                    // æ·»åŠ èŠå¤©åŠ¨ç”»æ•ˆæœ
                    this.playChatAnimation();
                    // å¼‚æ­¥å¤„ç†
                    (async () => {
                        try {
                            // ç¡®ä¿æœ‰å½“å‰ä¼šè¯
                            if (!this.currentSessionId) {
                                await this.initSessionWithDelay();
                            }
                            
                            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ä¼šè¯
                            if (this.currentSessionId && request.message) {
                                await this.addMessageToSession('user', request.message, null, false);
                            }
                            
                            // ç”Ÿæˆå® ç‰©å›å¤
                            const reply = await this.generatePetResponse(request.message);
                            
                            // æ·»åŠ å® ç‰©å›å¤åˆ°ä¼šè¯
                            if (this.currentSessionId && reply) {
                                await this.addMessageToSession('pet', reply, null, true);
                                
                                // è°ƒç”¨ session/save ä¿å­˜ä¼šè¯åˆ°åç«¯
                                if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                                    await this.syncSessionToBackend(this.currentSessionId, true);
                                }
                            }
                            
                            sendResponse({ success: true, reply: reply });
                        } catch (error) {
                            console.error('ç”Ÿæˆå›å¤å¤±è´¥:', error);
                            sendResponse({ success: false, error: error.message });
                        }
                    })();
                    return true; // ä¿æŒæ¶ˆæ¯é€šé“å¼€æ”¾

                default:
                    sendResponse({ success: false, error: 'Unknown action' });
            }
        });
        
        // ç›‘å¬window.postMessageæ¶ˆæ¯ï¼ˆç”¨äºOSSæ–‡ä»¶ç‚¹å‡»ï¼‰
        window.addEventListener('message', (event) => {
            // éªŒè¯æ¶ˆæ¯æ¥æºï¼ˆå¯é€‰ï¼Œæ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ï¼‰
            if (event.data && event.data.type === 'ossFileClick' && event.data.file) {
                console.log('æ”¶åˆ°OSSæ–‡ä»¶ç‚¹å‡»æ¶ˆæ¯:', event.data.file);
                this.handleOssFileClick(event.data.file).catch(error => {
                    console.error('å¤„ç†OSSæ–‡ä»¶ç‚¹å‡»å¤±è´¥:', error);
                });
            }
        });
    }
    
    // å¤„ç†OSSæ–‡ä»¶ç‚¹å‡»ï¼Œåˆ›å»ºä¼šè¯å¹¶æ‰“å¼€èŠå¤©çª—å£
    async handleOssFileClick(file) {
        try {
            console.log('å¤„ç†OSSæ–‡ä»¶ç‚¹å‡»:', file);
            
            // æ£€æŸ¥æ–‡ä»¶å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
            if (!file) {
                console.error('æ–‡ä»¶å¯¹è±¡ä¸ºç©º');
                this.showNotification('æ–‡ä»¶ä¿¡æ¯æ— æ•ˆ', 'error');
                return;
            }
            
            // ç¡®ä¿æ–‡ä»¶æœ‰urlå­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨nameç”Ÿæˆ
            if (!file.url && file.name) {
                // å¦‚æœæ–‡ä»¶å¯¹è±¡æ²¡æœ‰urlï¼Œå°è¯•ä»nameç”Ÿæˆ
                // è¿™é‡Œå‡è®¾urlæ ¼å¼ä¸ºï¼šbaseUrl + nameï¼Œä½†å®é™…åº”è¯¥ç”±åç«¯æä¾›
                console.warn('æ–‡ä»¶å¯¹è±¡ç¼ºå°‘urlå­—æ®µï¼Œä½¿ç”¨nameä½œä¸ºæ ‡è¯†');
                file.url = file.name;
            }
            
            if (!file.url) {
                console.error('æ–‡ä»¶å¯¹è±¡ç¼ºå°‘urlå’Œnameå­—æ®µ');
                this.showNotification('æ–‡ä»¶ä¿¡æ¯ä¸å®Œæ•´', 'error');
                return;
            }
            
            // ç¡®ä¿èŠå¤©çª—å£å·²æ‰“å¼€
            if (!this.chatWindow || !this.isChatOpen) {
                await this.openChatWindow();
            }
            
            // ç”ŸæˆåŸºäºæ–‡ä»¶URLçš„ä¼šè¯ID
            let sessionId = await this.generateSessionId(file.url);
            
            // åŠ è½½æ‰€æœ‰ä¼šè¯ï¼ˆåŒ…æ‹¬ä»åç«¯åŠ è½½ï¼‰
            await this.loadAllSessions();
            
            // æ£€æŸ¥ä¼šè¯åˆ—è¡¨ä¸­æ˜¯å¦æœ‰URLåŒ¹é…çš„ä¼šè¯
            let matchedSession = null;
            let matchedSessionId = null;
            
            // é¦–å…ˆæ£€æŸ¥æœ¬åœ°ä¼šè¯
            for (const [sid, session] of Object.entries(this.sessions)) {
                if (session && session.url === file.url) {
                    matchedSession = session;
                    matchedSessionId = sid;
                    break;
                }
            }
            
            // å¦‚æœæœ¬åœ°æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨å¹¶æŸ¥æ‰¾
            if (!matchedSession && this.sessionApi && this.sessionApi.isEnabled()) {
                try {
                    console.log('æœ¬åœ°æœªæ‰¾åˆ°åŒ¹é…ä¼šè¯ï¼Œå°è¯•ä»åç«¯æŸ¥æ‰¾:', file.url);
                    const backendSessions = await this.sessionApi.getSessionsList({ forceRefresh: false });
                    
                    // æ£€æŸ¥å½“å‰é¡µé¢URLæ˜¯å¦åœ¨ä¼šè¯åˆ—è¡¨ä¸­ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨è¯¦æƒ…æ¥å£
                    const currentPageUrl = window.location.href;
                    for (const backendSession of backendSessions) {
                        if (backendSession.url === currentPageUrl) {
                            const sessionId = backendSession.id || backendSession.conversation_id;
                            if (sessionId) {
                                console.log('å½“å‰é¡µé¢URLåœ¨ä¼šè¯åˆ—è¡¨ä¸­ï¼Œæ­£åœ¨åŠ è½½ä¼šè¯è¯¦æƒ…:', sessionId);
                                try {
                                    const sessionDetail = await this.sessionApi.getSession(sessionId, true);
                                    if (sessionDetail) {
                                        console.log('ä¼šè¯è¯¦æƒ…åŠ è½½æˆåŠŸ:', sessionId);
                                        // æ›´æ–°æœ¬åœ°ä¼šè¯æ•°æ®
                                        if (this.sessions && this.sessions[sessionId]) {
                                            this.sessions[sessionId] = {
                                                ...this.sessions[sessionId],
                                                ...sessionDetail,
                                                id: sessionId
                                            };
                                        }
                                    }
                                } catch (error) {
                                    console.warn('åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥:', error);
                                }
                            }
                            break; // æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯åé€€å‡ºå¾ªç¯
                        }
                    }
                    
                    // åœ¨åç«¯ä¼šè¯åˆ—è¡¨ä¸­æŸ¥æ‰¾URLåŒ¹é…çš„ä¼šè¯
                    for (const backendSession of backendSessions) {
                        if (backendSession.url === file.url) {
                            const backendSessionId = backendSession.id || backendSession.conversation_id;
                            if (backendSessionId) {
                                // æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯ï¼Œä»åç«¯åŠ è½½å®Œæ•´æ•°æ®
                                console.log('åœ¨åç«¯æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯ï¼Œæ­£åœ¨åŠ è½½å®Œæ•´æ•°æ®:', backendSessionId);
                                try {
                                    const fullSession = await this.sessionApi.getSession(backendSessionId, true);
                                    if (fullSession) {
                                        // å°†åç«¯ä¼šè¯æ•°æ®åˆå¹¶åˆ°æœ¬åœ°
                                        this.sessions[backendSessionId] = {
                                            id: backendSessionId,
                                            url: fullSession.url || backendSession.url || file.url,
                                            pageTitle: fullSession.pageTitle || fullSession.title || file.name || 'OSSæ–‡ä»¶',
                                            pageDescription: fullSession.pageDescription || '',
                                            pageContent: fullSession.pageContent || '',
                                            messages: fullSession.messages || [],
                                            tags: fullSession.tags || [],
                                            createdAt: fullSession.createdAt || Date.now(),
                                            updatedAt: fullSession.updatedAt || Date.now(),
                                            lastAccessTime: fullSession.lastAccessTime || Date.now(),
                                            _isOssFileSession: true,
                                            _ossFileInfo: {
                                                name: file.name || '',
                                                url: file.url || '',
                                                description: file.description || '',
                                                tags: file.tags || [],
                                                isImage: file.isImage || false,
                                                size: file.size || 0,
                                                size_human: file.size_human || '',
                                                last_modified_str: file.last_modified_str || ''
                                            }
                                        };
                                        matchedSession = this.sessions[backendSessionId];
                                        matchedSessionId = backendSessionId;
                                        console.log('å·²ä»åç«¯åŠ è½½åŒ¹é…ä¼šè¯çš„å®Œæ•´æ•°æ®:', backendSessionId);
                                        break;
                                    }
                                } catch (error) {
                                    console.warn('ä»åç«¯åŠ è½½ä¼šè¯æ•°æ®å¤±è´¥:', error);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.warn('ä»åç«¯è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                }
            }
            
            // å¦‚æœæ‰¾åˆ°äº†åŒ¹é…çš„ä¼šè¯ï¼Œä½¿ç”¨è¯¥ä¼šè¯
            if (matchedSession && matchedSessionId) {
                console.log('æ‰¾åˆ°URLåŒ¹é…çš„ä¼šè¯ï¼Œä½¿ç”¨è¯¥ä¼šè¯:', matchedSessionId);
                
                // æ›´æ–°OSSæ–‡ä»¶ä¿¡æ¯
                matchedSession._isOssFileSession = true;
                matchedSession._ossFileInfo = {
                    name: file.name || '',
                    url: file.url || '',
                    description: file.description || '',
                    tags: file.tags || [],
                    isImage: file.isImage || false,
                    size: file.size || 0,
                    size_human: file.size_human || '',
                    last_modified_str: file.last_modified_str || ''
                };
                
                // ä¿å­˜åˆ°æœ¬åœ°
                await this.saveAllSessions(false, false);
                
                // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºOSSæ–‡ä»¶åˆ—è¡¨
                const ossFileList = this.sessionSidebar?.querySelector('.oss-file-list');
                const isOssFileListVisible = ossFileList && ossFileList.style.display !== 'none';
                
                // è®¾ç½®å½“å‰æ–‡ä»¶ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
                this.currentFile = file.name;
                
                // æ¿€æ´»ä¼šè¯ï¼ˆä¸è·³è¿‡åç«¯è·å–ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä»åç«¯åŠ è½½äº†æ•°æ®ï¼‰
                await this.activateSession(matchedSessionId, {
                    saveCurrent: false,
                    updateConsistency: false, // OSSæ–‡ä»¶ä¼šè¯ä¸éœ€è¦æ›´æ–°é¡µé¢ä¸€è‡´æ€§
                    updateUI: true,
                    syncToBackend: false,
                    skipBackendFetch: false, // ä¸è·³è¿‡ï¼Œç¡®ä¿è·å–æœ€æ–°æ•°æ®
                    keepOssFileListView: isOssFileListVisible // å¦‚æœå½“å‰æ˜¾ç¤ºOSSæ–‡ä»¶åˆ—è¡¨ï¼Œä¿æŒè¯¥è§†å›¾
                });
                
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯OSSæ–‡ä»¶åˆ—è¡¨ï¼Œæ›´æ–°OSSæ–‡ä»¶åˆ—è¡¨çš„activeçŠ¶æ€
                if (isOssFileListVisible) {
                    await this.updateOssFileSidebar(false);
                }
                
                console.log('OSSæ–‡ä»¶ä¼šè¯å·²æ¿€æ´»ï¼ˆä½¿ç”¨åŒ¹é…çš„ä¼šè¯ï¼‰:', matchedSessionId);
                return;
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯ï¼Œä½¿ç”¨åŸæœ‰çš„é€»è¾‘ï¼ˆåŸºäºæ–‡ä»¶URLç”Ÿæˆä¼šè¯IDï¼‰
            let session = this.sessions[sessionId];
            
            if (!session) {
                // åˆ›å»ºæ–°ä¼šè¯
                // OSSæ–‡ä»¶ä¼šè¯ï¼špageTitleä½¿ç”¨æ–‡ä»¶åï¼ŒpageDescriptionä¸ºç©º
                // pageContentåˆå§‹ä¸ºç©ºï¼Œåç»­å¯ä»¥é€šè¿‡æ‰‹åŠ¨ä¿å­˜ç­‰æ–¹å¼å¡«å……
                session = this.createSessionObject(sessionId, {
                    url: file.url,
                    title: file.name || 'OSSæ–‡ä»¶',
                    pageTitle: file.name || 'OSSæ–‡ä»¶',
                    pageDescription: '', // OSSæ–‡ä»¶ä¼šè¯çš„pageDescriptionåº”è¯¥ä¸ºç©º
                    pageContent: '' // OSSæ–‡ä»¶ä¼šè¯çš„pageContentåˆå§‹ä¸ºç©ºï¼Œåç»­å¯ä»¥å¡«å……
                });
                this.sessions[sessionId] = session;
                
                // æ ‡è®°ä¸ºOSSæ–‡ä»¶ä¼šè¯
                session._isOssFileSession = true;
                session._ossFileInfo = {
                    name: file.name || '',
                    url: file.url || '',
                    description: file.description || '',
                    tags: file.tags || [],
                    isImage: file.isImage || false,
                    size: file.size || 0,
                    size_human: file.size_human || '',
                    last_modified_str: file.last_modified_str || ''
                };
                
                // ä¿å­˜ä¼šè¯åˆ°æœ¬åœ°
                await this.saveAllSessions(false, false);
            } else {
                // æ›´æ–°ç°æœ‰ä¼šè¯çš„OSSæ–‡ä»¶ä¿¡æ¯
                session._isOssFileSession = true;
                session._ossFileInfo = {
                    name: file.name || '',
                    url: file.url || '',
                    description: file.description || '',
                    tags: file.tags || [],
                    isImage: file.isImage || false,
                    size: file.size || 0,
                    size_human: file.size_human || '',
                    last_modified_str: file.last_modified_str || ''
                };
                // ç¡®ä¿OSSæ–‡ä»¶ä¼šè¯çš„pageTitleã€pageDescriptionæ­£ç¡®
                // pageContentä¿ç•™å·²æœ‰å†…å®¹ï¼Œå¦‚æœä¸ºç©ºåˆ™ä¿æŒä¸ºç©º
                session.pageTitle = file.name || 'OSSæ–‡ä»¶';
                session.pageDescription = ''; // OSSæ–‡ä»¶ä¼šè¯çš„pageDescriptionåº”è¯¥ä¸ºç©º
                // pageContentä¿ç•™å·²æœ‰å†…å®¹ï¼Œä¸å¼ºåˆ¶æ¸…ç©º
                // session.pageContent = session.pageContent || '';
            }
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºOSSæ–‡ä»¶åˆ—è¡¨
            const ossFileList = this.sessionSidebar?.querySelector('.oss-file-list');
            const isOssFileListVisible = ossFileList && ossFileList.style.display !== 'none';
            
            // è®¾ç½®å½“å‰æ–‡ä»¶ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
            this.currentFile = file.name;
            
            // æ¿€æ´»ä¼šè¯
            await this.activateSession(sessionId, {
                saveCurrent: false,
                updateConsistency: false, // OSSæ–‡ä»¶ä¼šè¯ä¸éœ€è¦æ›´æ–°é¡µé¢ä¸€è‡´æ€§
                updateUI: true,
                syncToBackend: false,
                skipBackendFetch: true,
                keepOssFileListView: isOssFileListVisible // å¦‚æœå½“å‰æ˜¾ç¤ºOSSæ–‡ä»¶åˆ—è¡¨ï¼Œä¿æŒè¯¥è§†å›¾
            });
            
            // ç¡®ä¿ä¼šè¯ä¿¡æ¯å·²æ›´æ–°ï¼ˆåœ¨æ¿€æ´»ä¼šè¯åï¼‰
            const activatedSession = this.sessions[sessionId];
            if (activatedSession) {
                activatedSession._isOssFileSession = true;
                activatedSession._ossFileInfo = {
                    name: file.name || '',
                    url: file.url || '',
                    description: file.description || '',
                    tags: file.tags || [],
                    isImage: file.isImage || false,
                    size: file.size || 0,
                    size_human: file.size_human || '',
                    last_modified_str: file.last_modified_str || ''
                };
                // ç¡®ä¿OSSæ–‡ä»¶ä¼šè¯çš„pageTitleã€pageDescriptionæ­£ç¡®
                // pageContentä¿ç•™å·²æœ‰å†…å®¹ï¼Œå¦‚æœä¸ºç©ºåˆ™ä¿æŒä¸ºç©º
                activatedSession.pageTitle = file.name || 'OSSæ–‡ä»¶';
                activatedSession.pageDescription = ''; // OSSæ–‡ä»¶ä¼šè¯çš„pageDescriptionåº”è¯¥ä¸ºç©º
                // pageContentä¿ç•™å·²æœ‰å†…å®¹ï¼Œä¸å¼ºåˆ¶æ¸…ç©º
                // activatedSession.pageContent = activatedSession.pageContent || '';
            }
            
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯OSSæ–‡ä»¶åˆ—è¡¨ï¼Œæ›´æ–°OSSæ–‡ä»¶åˆ—è¡¨çš„activeçŠ¶æ€ï¼Œå¹¶ç¡®ä¿ä¿æŒOSSæ–‡ä»¶åˆ—è¡¨è§†å›¾
            if (isOssFileListVisible) {
                // æ›´æ–°OSSæ–‡ä»¶åˆ—è¡¨çš„activeçŠ¶æ€ï¼ˆåœ¨æ¿€æ´»ä¼šè¯åï¼Œç¡®ä¿currentSessionIdå·²è®¾ç½®ï¼‰
                await this.updateOssFileSidebar(false);
            }
            
            console.log('OSSæ–‡ä»¶ä¼šè¯å·²åˆ›å»ºå¹¶æ¿€æ´»:', sessionId);
        } catch (error) {
            console.error('å¤„ç†OSSæ–‡ä»¶ç‚¹å‡»å¤±è´¥:', error);
            this.showNotification('æ‰“å¼€OSSæ–‡ä»¶ä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    createPet() {
        // é˜²æ­¢é‡å¤åˆ›å»º
        if (document.getElementById('minimal-pet')) {
            console.log('å® ç‰©å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
            // å¦‚æœå® ç‰©å·²å­˜åœ¨ï¼Œç¡®ä¿æ ·å¼æ˜¯æœ€æ–°çš„
            this.pet = document.getElementById('minimal-pet');
            this.updatePetStyle();
            return;
        }

        console.log('å¼€å§‹åˆ›å»ºå® ç‰©...');
        console.log('å½“å‰å¯è§æ€§çŠ¶æ€:', this.isVisible);

        // åˆ›å»ºå® ç‰©å®¹å™¨
        this.pet = document.createElement('div');
        this.pet.id = 'minimal-pet';
        this.updatePetStyle();

        // ä½¿ç”¨ icon.png ä½œä¸ºå® ç‰©å›¾æ ‡ï¼Œä¸éœ€è¦æ·»åŠ çœ¼ç›å’Œå˜´å·´

        // æ·»åŠ åˆ°é¡µé¢
        this.addPetToPage();

        // æ·»åŠ äº¤äº’åŠŸèƒ½
        this.addInteractions();

        console.log('å® ç‰©åˆ›å»ºæˆåŠŸï¼');
        console.log('å® ç‰©æ˜¾ç¤ºçŠ¶æ€:', this.isVisible ? 'æ˜¾ç¤º' : 'éšè—');
    }

    addPetToPage() {
        console.log('å°è¯•æ·»åŠ å® ç‰©åˆ°é¡µé¢...');
        console.log('document.body å­˜åœ¨:', !!document.body);
        console.log('document.readyState:', document.readyState);

        if (document.body) {
            console.log('ç›´æ¥æ·»åŠ åˆ° body');
            document.body.appendChild(this.pet);
            console.log('å® ç‰©å·²æ·»åŠ åˆ°é¡µé¢');
            // ç¡®ä¿æ ·å¼å·²æ›´æ–°
            this.updatePetStyle();
        } else {
            console.log('body ä¸å­˜åœ¨ï¼Œç­‰å¾… DOMContentLoaded');
            // å¦‚æœbodyè¿˜æ²¡æœ‰åŠ è½½ï¼Œç­‰å¾…DOMåŠ è½½å®Œæˆ
            const handleDOMReady = () => {
                console.log('DOMContentLoaded äº‹ä»¶è§¦å‘');
                if (document.body && this.pet) {
                    console.log('ç°åœ¨æ·»åŠ åˆ° body');
                    document.body.appendChild(this.pet);
                    console.log('å® ç‰©å·²æ·»åŠ åˆ°é¡µé¢ï¼ˆå»¶è¿Ÿï¼‰');
                    // ç¡®ä¿æ ·å¼å·²æ›´æ–°
                    this.updatePetStyle();
                } else {
                    console.log('DOMContentLoaded åä»ç„¶æ— æ³•æ·»åŠ å® ç‰©');
                }
            };
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½å®Œæˆ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', handleDOMReady);
            } else {
                // å¦‚æœå·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥æ‰§è¡Œ
                setTimeout(handleDOMReady, 0);
            }
        }
    }

    updatePetStyle() {
        if (!this.pet) return;

        // æ ¹æ®è§’è‰²è·å–å¯¹åº”çš„å›¾æ ‡URLï¼Œé»˜è®¤ä½¿ç”¨æ•™å¸ˆè§’è‰²
        const role = this.role || 'æ•™å¸ˆ';
        const iconUrl = chrome.runtime.getURL(`roles/${role}/icon.png`);

        this.pet.style.cssText = `
            position: fixed !important;
            top: ${this.position.y}px !important;
            left: ${this.position.x}px !important;
            width: ${this.size}px !important;
            height: ${this.size}px !important;
            background: url(${iconUrl}) center/contain no-repeat !important;
            border-radius: 12px !important;
            z-index: ${PET_CONFIG.ui.zIndex.pet} !important;
            cursor: grab !important;
            pointer-events: auto !important;
            box-shadow: none !important;
            transition: all 0.3s ease !important;
            display: ${this.isVisible ? 'block' : 'none'} !important;
            background-color: transparent !important;
        `;
    }

    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆä½¿ç”¨è§’è‰²runç›®å½•ä¸‹çš„è¿ç»­å›¾ç‰‡ï¼‰
    showLoadingAnimation() {
        if (!this.pet) return;
        
        const role = this.role || 'æ•™å¸ˆ';
        const runImages = [
            chrome.runtime.getURL(`roles/${role}/run/1.png`),
            chrome.runtime.getURL(`roles/${role}/run/2.png`),
            chrome.runtime.getURL(`roles/${role}/run/3.png`)
        ];
        
        // ä¿å­˜åŸå§‹èƒŒæ™¯å›¾ç‰‡
        if (!this.originalBackgroundImage) {
            const role = this.role || 'æ•™å¸ˆ';
            this.originalBackgroundImage = chrome.runtime.getURL(`roles/${role}/icon.png`);
        }
        
        // å¦‚æœå½“å‰å·²ç»æœ‰åŠ¨ç”»åœ¨è¿è¡Œï¼Œä¸é‡å¤å¯åŠ¨
        if (this.loadingAnimationInterval) {
            return;
        }
        
        let currentFrame = 0;
        
        // è®¾ç½®åˆå§‹å¸§
        this.pet.style.backgroundImage = `url(${runImages[currentFrame]})`;
        this.pet.style.backgroundSize = 'contain';
        this.pet.style.backgroundPosition = 'center';
        this.pet.style.backgroundRepeat = 'no-repeat';
        
        // åˆ›å»ºåŠ¨ç”»å¾ªç¯ï¼ˆæ¯200msåˆ‡æ¢ä¸€å¸§ï¼‰
        this.loadingAnimationInterval = setInterval(() => {
            if (!this.pet) {
                this.stopLoadingAnimation();
                return;
            }
            
            currentFrame = (currentFrame + 1) % runImages.length;
            this.pet.style.backgroundImage = `url(${runImages[currentFrame]})`;
        }, 200);
        
        console.log('å¼€å§‹æ˜¾ç¤ºåŠ è½½åŠ¨ç”»');
    }

    // åœæ­¢åŠ è½½åŠ¨ç”»ï¼Œæ¢å¤åŸå§‹å›¾ç‰‡
    stopLoadingAnimation() {
        if (this.loadingAnimationInterval) {
            clearInterval(this.loadingAnimationInterval);
            this.loadingAnimationInterval = null;
        }
        
        if (this.pet && this.originalBackgroundImage) {
            this.pet.style.backgroundImage = `url(${this.originalBackgroundImage})`;
            this.pet.style.backgroundSize = 'contain';
            this.pet.style.backgroundPosition = 'center';
            this.pet.style.backgroundRepeat = 'no-repeat';
        }
        
        console.log('åœæ­¢åŠ è½½åŠ¨ç”»');
    }

    addInteractions() {
        if (!this.pet) return;

        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;

        this.pet.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = this.position.x;
            startTop = this.position.y;
            this.pet.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging && this.pet) {
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                this.position.x = Math.max(0, Math.min(window.innerWidth - this.size, startLeft + deltaX));
                this.position.y = Math.max(0, Math.min(window.innerHeight - this.size, startTop + deltaY));
                this.pet.style.left = this.position.x + 'px';
                this.pet.style.top = this.position.y + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            if (this.pet) {
                this.pet.style.cursor = 'grab';
                this.saveState(); // æ‹–æ‹½ç»“æŸåä¿å­˜çŠ¶æ€
                // ç«‹å³åŒæ­¥åˆ°å…¨å±€çŠ¶æ€
                this.syncToGlobalState();
            }
        });

        this.pet.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            this.pet.style.transform = 'scale(1.1)';
            setTimeout(() => {
                if (this.pet) {
                    this.pet.style.transform = 'scale(1)';
                }
            }, 150);

            // åˆ‡æ¢èŠå¤©çª—å£
            this.toggleChatWindow();
        });
    }

    toggleVisibility() {
        this.isVisible = !this.isVisible;
        this.updatePetStyle();
        this.saveState(); // ä¿å­˜çŠ¶æ€
        this.syncToGlobalState(); // åŒæ­¥åˆ°å…¨å±€çŠ¶æ€
        console.log('å® ç‰©å¯è§æ€§åˆ‡æ¢ä¸º:', this.isVisible);
    }

    changeColor() {
        this.colorIndex = (this.colorIndex + 1) % this.colors.length;
        this.updatePetStyle();
        this.updateChatWindowColor();
        console.log('å® ç‰©é¢œè‰²åˆ‡æ¢ä¸º:', this.colorIndex);
    }

    setColor(colorIndex) {
        if (colorIndex >= 0 && colorIndex < this.colors.length) {
            this.colorIndex = colorIndex;
            this.updatePetStyle();
            this.updateChatWindowColor();
            this.saveState();
            this.syncToGlobalState();
            console.log('å® ç‰©é¢œè‰²è®¾ç½®ä¸º:', this.colorIndex);
        }
    }

    setSize(size) {
        this.size = Math.max(PET_CONFIG.pet.sizeLimits.min, Math.min(PET_CONFIG.pet.sizeLimits.max, size));
        this.updatePetStyle();
        this.saveState();
        this.syncToGlobalState();
        console.log('å® ç‰©å¤§å°è®¾ç½®ä¸º:', this.size);
    }

    setRole(role) {
        // éªŒè¯è§’è‰²æ˜¯å¦æœ‰æ•ˆï¼ˆæ£€æŸ¥ roles æ–‡ä»¶å¤¹ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„æ–‡ä»¶å¤¹ï¼‰
        const validRoles = ['æ•™å¸ˆ', 'åŒ»ç”Ÿ', 'ç”œå“å¸ˆ', 'è­¦å¯Ÿ'];
        if (validRoles.includes(role)) {
            this.role = role;
            this.updatePetStyle();
            this.saveState();
            this.syncToGlobalState();
            console.log('å® ç‰©è§’è‰²è®¾ç½®ä¸º:', this.role);
        } else {
            console.warn('æ— æ•ˆçš„è§’è‰²ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²æ•™å¸ˆ:', role);
            this.role = 'æ•™å¸ˆ';
            this.updatePetStyle();
        }
    }

    setModel(modelId) {
        if (PET_CONFIG.chatModels && PET_CONFIG.chatModels.models && PET_CONFIG.chatModels.models.some(m => m.id === modelId)) {
            this.currentModel = modelId;
            this.saveState();
            this.syncToGlobalState();
            this.updateChatModelSelector(); // æ›´æ–°èŠå¤©çª—å£ä¸­çš„æ¨¡å‹é€‰æ‹©å™¨
            console.log('èŠå¤©æ¨¡å‹è®¾ç½®ä¸º:', modelId);
        } else {
            console.error('æ— æ•ˆçš„æ¨¡å‹ID:', modelId);
        }
    }

    resetPosition() {
        this.position = getPetDefaultPosition();
        this.updatePetStyle();
        this.saveState();
        this.syncToGlobalState();
        console.log('å® ç‰©ä½ç½®å·²é‡ç½®');
    }

    centerPet() {
        const centerX = getCenterPosition(this.size, window.innerWidth);
        const centerY = getCenterPosition(this.size, window.innerHeight);
        this.position = { x: centerX, y: centerY };
        this.updatePetStyle();
        this.saveState();
        this.syncToGlobalState();
        console.log('å® ç‰©å·²å±…ä¸­ï¼Œä½ç½®:', this.position);
    }

    removePet() {
        if (this.pet && this.pet.parentNode) {
            this.pet.parentNode.removeChild(this.pet);
            this.pet = null;
            console.log('å® ç‰©å·²ç§»é™¤');
        }
    }

    // ä¿å­˜çŠ¶æ€ï¼ˆå¸¦èŠ‚æµæœºåˆ¶ï¼Œé¿å…è¶…è¿‡å†™å…¥é…é¢ï¼‰
    saveState() {
        this._saveStateInternal(true);
    }

    // åŒæ­¥å½“å‰çŠ¶æ€åˆ°å…¨å±€çŠ¶æ€ï¼ˆå¸¦èŠ‚æµæœºåˆ¶ï¼‰
    syncToGlobalState() {
        this._saveStateInternal(false);
    }

    // å†…éƒ¨ä¿å­˜çŠ¶æ€æ–¹æ³•ï¼Œç»Ÿä¸€å¤„ç†èŠ‚æµå’Œé”™è¯¯å¤„ç†
    _saveStateInternal(includeLocalStorage = false) {
        const now = Date.now();
        const state = {
            visible: this.isVisible,
            color: this.colorIndex,
            size: this.size,
            position: this.position,
            role: this.role || 'æ•™å¸ˆ',
            model: this.currentModel,
            timestamp: now
        };

        // ä¿å­˜å¾…æ›´æ–°çš„çŠ¶æ€
        this.pendingStateUpdate = state;

        // å¦‚æœè·ç¦»ä¸Šæ¬¡ä¿å­˜æ—¶é—´å¤ªçŸ­ï¼Œä½¿ç”¨é˜²æŠ–å»¶è¿Ÿä¿å­˜
        const timeSinceLastSave = now - this.lastStateSaveTime;
        if (timeSinceLastSave < this.STATE_SAVE_THROTTLE) {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (this.stateSaveTimer) {
                clearTimeout(this.stateSaveTimer);
            }
            // è®¾ç½®æ–°çš„å»¶è¿Ÿä¿å­˜
            this.stateSaveTimer = setTimeout(() => {
                this._doSaveState(includeLocalStorage);
            }, this.STATE_SAVE_THROTTLE - timeSinceLastSave);
            return;
        }

        // ç«‹å³ä¿å­˜
        this._doSaveState(includeLocalStorage);
    }

    // æ‰§è¡Œå®é™…ä¿å­˜æ“ä½œ
    async _doSaveState(includeLocalStorage = false) {
        if (!this.pendingStateUpdate) {
            return;
        }

        const state = this.pendingStateUpdate;
        this.lastStateSaveTime = Date.now();
        this.pendingStateUpdate = null;

        if (this.stateSaveTimer) {
            clearTimeout(this.stateSaveTimer);
            this.stateSaveTimer = null;
        }

        try {
            // ä½¿ç”¨StorageHelperå¤„ç†é…é¢é”™è¯¯
            if (typeof window.StorageHelper !== 'undefined') {
                const result = await window.StorageHelper.set(PET_CONFIG.storage.keys.globalState, state);
                if (!result.success) {
                    console.warn('ä¿å­˜çŠ¶æ€å¤±è´¥:', result.error);
                } else if (result.fallback === 'localStorage') {
                    console.log('å·²é™çº§åˆ°localStorageä¿å­˜çŠ¶æ€');
                } else {
                    console.log('å® ç‰©å…¨å±€çŠ¶æ€å·²ä¿å­˜åˆ°localå­˜å‚¨:', state);
                }
            } else {
                // é™çº§åˆ°åŸå§‹æ–¹æ³•
                chrome.storage.local.set({ [PET_CONFIG.storage.keys.globalState]: state }, () => {
                    if (chrome.runtime.lastError) {
                        const error = chrome.runtime.lastError;
                        console.warn('ä¿å­˜çŠ¶æ€åˆ°chrome.storage.localå¤±è´¥:', error.message);
                        
                        // å¦‚æœé‡åˆ°é…é¢é”™è¯¯ï¼Œé™çº§åˆ°localStorage
                        if (error.message.includes('MAX_WRITE_OPERATIONS_PER_HOUR') || 
                            error.message.includes('QUOTA_BYTES_PER_HOUR') ||
                            error.message.includes('QUOTA_BYTES') ||
                            error.message.includes('quota exceeded')) {
                            console.warn('é‡åˆ°å­˜å‚¨é…é¢é™åˆ¶ï¼Œé™çº§åˆ°localStorage');
                            this.useLocalStorage = true;
                            try {
                                localStorage.setItem('petState', JSON.stringify(state));
                            } catch (localError) {
                                console.error('ä¿å­˜åˆ°localStorageä¹Ÿå¤±è´¥:', localError);
                            }
                        }
                    } else {
                        console.log('å® ç‰©å…¨å±€çŠ¶æ€å·²ä¿å­˜åˆ°localå­˜å‚¨:', state);
                    }
                });
            }

            // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ç”¨
            if (includeLocalStorage) {
                try {
                    localStorage.setItem('petState', JSON.stringify(state));
                } catch (error) {
                    console.warn('ä¿å­˜åˆ°localStorageå¤±è´¥:', error);
                }
            }
        } catch (error) {
            console.log('ä¿å­˜çŠ¶æ€å¤±è´¥:', error);
            // é™çº§åˆ°localStorage
            try {
                localStorage.setItem('petState', JSON.stringify(state));
            } catch (e) {
                console.error('ä¿å­˜åˆ°localStorageä¹Ÿå¤±è´¥:', e);
            }
        }
    }

    loadState() {
        try {
            // é¦–å…ˆå°è¯•ä»chrome.storage.localåŠ è½½ï¼ˆæ–°ç‰ˆæœ¬ä½¿ç”¨localï¼‰
            chrome.storage.local.get([PET_CONFIG.storage.keys.globalState], (result) => {
                let state = result[PET_CONFIG.storage.keys.globalState];
                
                // å¦‚æœlocalä¸­æ²¡æœ‰ï¼Œå°è¯•ä»syncåŠ è½½ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
                if (!state) {
                    chrome.storage.sync.get([PET_CONFIG.storage.keys.globalState], (syncResult) => {
                        if (syncResult[PET_CONFIG.storage.keys.globalState]) {
                            state = syncResult[PET_CONFIG.storage.keys.globalState];
                            // è¿ç§»åˆ°localå­˜å‚¨
                            chrome.storage.local.set({ [PET_CONFIG.storage.keys.globalState]: state }, () => {
                                console.log('å·²ä»syncè¿ç§»åˆ°localå­˜å‚¨');
                            });
                        }
                        this._applyLoadedState(state);
                    });
                } else {
                    this._applyLoadedState(state);
                }
            });
            
            // åŒæ—¶å°è¯•ä»localStorageåŠ è½½ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
            try {
                const localState = localStorage.getItem('petState');
                if (localState) {
                    const state = JSON.parse(localState);
                    // å¦‚æœchrome.storageä¸­æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨localStorageçš„æ•°æ®
                    chrome.storage.local.get([PET_CONFIG.storage.keys.globalState], (result) => {
                        if (!result[PET_CONFIG.storage.keys.globalState] && state) {
                            this._applyLoadedState(state);
                        }
                    });
                }
            } catch (error) {
                console.warn('ä»localStorageåŠ è½½çŠ¶æ€å¤±è´¥:', error);
            }
        } catch (error) {
            console.log('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // åº”ç”¨åŠ è½½çš„çŠ¶æ€æ•°æ®
    _applyLoadedState(state) {
        if (!state) {
            return;
        }

        this.isVisible = state.visible !== undefined ? state.visible : PET_CONFIG.pet.defaultVisible;
        this.colorIndex = state.color !== undefined ? state.color : PET_CONFIG.pet.defaultColorIndex;

        // æ£€æŸ¥å¹¶è¿ç§»æ—§çš„å¤§å°å€¼ï¼ˆä» 60 å‡çº§åˆ° 180ï¼‰
        if (state.size && state.size < 100) {
            // æ—§ç‰ˆæœ¬çš„å¤§å°èŒƒå›´æ˜¯ 40-120ï¼Œå°äº 100 çš„å¯èƒ½æ˜¯æ—§ç‰ˆæœ¬
            this.size = PET_CONFIG.pet.defaultSize;
            // æ›´æ–°å­˜å‚¨ä¸­çš„å€¼ï¼ˆä½¿ç”¨èŠ‚æµä¿å­˜ï¼‰
            const updatedState = { ...state, size: this.size };
            this.pendingStateUpdate = updatedState;
            setTimeout(() => this._doSaveState(false), this.STATE_SAVE_THROTTLE);
        } else {
            this.size = state.size !== undefined ? state.size : PET_CONFIG.pet.defaultSize;
        }

        this.currentModel = state.model !== undefined ? state.model : ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3');
        // åŠ è½½è§’è‰²ï¼Œé»˜è®¤ä¸ºæ•™å¸ˆ
        this.role = state.role || 'æ•™å¸ˆ';
        // ä½ç½®ä¹Ÿä½¿ç”¨å…¨å±€çŠ¶æ€ï¼Œä½†ä¼šè¿›è¡Œè¾¹ç•Œæ£€æŸ¥
        this.position = this.validatePosition(state.position || getPetDefaultPosition());
        console.log('å® ç‰©å…¨å±€çŠ¶æ€å·²æ¢å¤:', state);
        console.log('å® ç‰©å¯è§æ€§:', this.isVisible);
        console.log('å® ç‰©è§’è‰²:', this.role);

        // æ›´æ–°å® ç‰©æ ·å¼ï¼ˆå¦‚æœå® ç‰©å·²åˆ›å»ºï¼‰
        this.updatePetStyle();
        
        // å¦‚æœå® ç‰©å·²åˆ›å»ºä½†è¿˜æ²¡æœ‰æ·»åŠ åˆ°é¡µé¢ï¼Œå°è¯•å†æ¬¡æ·»åŠ 
        if (this.pet && !this.pet.parentNode) {
            console.log('å® ç‰©å·²åˆ›å»ºä½†æœªæ·»åŠ åˆ°é¡µé¢ï¼Œå°è¯•é‡æ–°æ·»åŠ ');
            this.addPetToPage();
        }
    }

    loadStateFromLocalStorage() {
        try {
            const savedState = localStorage.getItem('petState');
            if (savedState) {
                const state = JSON.parse(savedState);
                this.isVisible = state.visible !== undefined ? state.visible : PET_CONFIG.pet.defaultVisible;
                this.colorIndex = state.color !== undefined ? state.color : PET_CONFIG.pet.defaultColorIndex;

                // æ£€æŸ¥å¹¶è¿ç§»æ—§çš„å¤§å°å€¼
                if (state.size && state.size < 100) {
                    this.size = PET_CONFIG.pet.defaultSize;
                } else {
                    this.size = state.size !== undefined ? state.size : PET_CONFIG.pet.defaultSize;
                }

                // åŠ è½½è§’è‰²ï¼Œé»˜è®¤ä¸ºæ•™å¸ˆ
                this.role = state.role || 'æ•™å¸ˆ';

                this.position = state.position || getPetDefaultPosition();
                console.log('å® ç‰©æœ¬åœ°çŠ¶æ€å·²æ¢å¤:', state);
                console.log('å® ç‰©å¯è§æ€§:', this.isVisible);
                console.log('å® ç‰©è§’è‰²:', this.role);
                
                // æ›´æ–°å® ç‰©æ ·å¼ï¼ˆå¦‚æœå® ç‰©å·²åˆ›å»ºï¼‰
                this.updatePetStyle();
                
                // å¦‚æœå® ç‰©å·²åˆ›å»ºä½†è¿˜æ²¡æœ‰æ·»åŠ åˆ°é¡µé¢ï¼Œå°è¯•å†æ¬¡æ·»åŠ 
                if (this.pet && !this.pet.parentNode) {
                    console.log('å® ç‰©å·²åˆ›å»ºä½†æœªæ·»åŠ åˆ°é¡µé¢ï¼Œå°è¯•é‡æ–°æ·»åŠ ');
                    this.addPetToPage();
                }
                
                return true;
            }
        } catch (error) {
            console.log('æ¢å¤æœ¬åœ°çŠ¶æ€å¤±è´¥:', error);
        }
        return false;
    }

    handleGlobalStateUpdate(newState) {
        if (newState) {
            // æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆé¢œè‰²ã€å¤§å°ã€å¯è§æ€§ã€ä½ç½®ã€è§’è‰²ï¼‰
            this.isVisible = newState.visible !== undefined ? newState.visible : this.isVisible;
            this.colorIndex = newState.color !== undefined ? newState.color : this.colorIndex;

            // æ£€æŸ¥å¹¶è¿ç§»æ—§çš„å¤§å°å€¼
            if (newState.size && newState.size < 100) {
                this.size = PET_CONFIG.pet.defaultSize;
            } else {
                this.size = newState.size !== undefined ? newState.size : this.size;
            }

            // æ›´æ–°è§’è‰²
            if (newState.role) {
                this.role = newState.role;
            }

            // ä½ç½®ä¹Ÿè¿›è¡Œè·¨é¡µé¢åŒæ­¥ï¼Œä½†ä¼šè¿›è¡Œè¾¹ç•Œæ£€æŸ¥
            if (newState.position) {
                this.position = this.validatePosition(newState.position);
            }

            console.log('å¤„ç†å…¨å±€çŠ¶æ€æ›´æ–°:', newState);
            this.updatePetStyle();
        }
    }

    // åŠ è½½OSSå›¾ç‰‡é¢„è§ˆå¼€å…³çŠ¶æ€
    loadOssImagePreviewState() {
        try {
            chrome.storage.local.get(['ossImagePreviewEnabled'], (result) => {
                if (result.ossImagePreviewEnabled !== undefined) {
                    this.ossImagePreviewEnabled = result.ossImagePreviewEnabled;
                } else {
                    // é»˜è®¤å…³é—­
                    this.ossImagePreviewEnabled = false;
                }
                console.log('OSSå›¾ç‰‡é¢„è§ˆå¼€å…³çŠ¶æ€å·²åŠ è½½:', this.ossImagePreviewEnabled);
            });
        } catch (error) {
            console.log('åŠ è½½OSSå›¾ç‰‡é¢„è§ˆå¼€å…³çŠ¶æ€å¤±è´¥:', error);
            this.ossImagePreviewEnabled = false;
        }
    }

    // ä¿å­˜OSSå›¾ç‰‡é¢„è§ˆå¼€å…³çŠ¶æ€
    saveOssImagePreviewState() {
        try {
            chrome.storage.local.set({ ossImagePreviewEnabled: this.ossImagePreviewEnabled }, () => {
                console.log('OSSå›¾ç‰‡é¢„è§ˆå¼€å…³çŠ¶æ€å·²ä¿å­˜:', this.ossImagePreviewEnabled);
            });
        } catch (error) {
            console.log('ä¿å­˜OSSå›¾ç‰‡é¢„è§ˆå¼€å…³çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // åŠ è½½æ¯ä¸ªæ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€
    loadOssFilePreviewStates() {
        try {
            chrome.storage.local.get(['ossFilePreviewStates'], (result) => {
                if (result.ossFilePreviewStates && typeof result.ossFilePreviewStates === 'object') {
                    this.ossFilePreviewStates = result.ossFilePreviewStates;
                } else {
                    this.ossFilePreviewStates = {};
                }
                console.log('æ¯ä¸ªæ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€å·²åŠ è½½:', this.ossFilePreviewStates);
            });
        } catch (error) {
            console.log('åŠ è½½æ¯ä¸ªæ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€å¤±è´¥:', error);
            this.ossFilePreviewStates = {};
        }
    }

    // ä¿å­˜æ¯ä¸ªæ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€
    saveOssFilePreviewStates() {
        try {
            chrome.storage.local.set({ ossFilePreviewStates: this.ossFilePreviewStates }, () => {
                console.log('æ¯ä¸ªæ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€å·²ä¿å­˜:', this.ossFilePreviewStates);
            });
        } catch (error) {
            console.log('ä¿å­˜æ¯ä¸ªæ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // è·å–æ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€ï¼ˆå¦‚æœæœªè®¾ç½®ï¼Œé»˜è®¤è¿”å›falseï¼‰
    getFilePreviewEnabled(fileName) {
        return this.ossFilePreviewStates[fileName] === true;
    }

    // è®¾ç½®æ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€
    setFilePreviewEnabled(fileName, enabled) {
        this.ossFilePreviewStates[fileName] = enabled === true;
        this.saveOssFilePreviewStates();
    }

    // éªŒè¯ä½ç½®æ˜¯å¦åœ¨å½“å‰çª—å£èŒƒå›´å†…
    validatePosition(position) {
        if (!position || typeof position.x !== 'number' || typeof position.y !== 'number') {
            return getPetDefaultPosition();
        }

        const maxX = Math.max(0, window.innerWidth - this.size);
        const maxY = Math.max(0, window.innerHeight - this.size);

        return {
            x: Math.max(0, Math.min(maxX, position.x)),
            y: Math.max(0, Math.min(maxY, position.y))
        };
    }

    // å¯åŠ¨å®šæœŸåŒæ­¥
    startPeriodicSync() {
        // å®šæœŸåŒæ­¥çŠ¶æ€ï¼Œç¡®ä¿è·¨é¡µé¢ä¸€è‡´æ€§
        this.syncInterval = setInterval(() => {
            this.syncToGlobalState();
        }, PET_CONFIG.storage.syncInterval);

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°éªŒè¯ä½ç½®
        window.addEventListener('resize', () => {
            this.position = this.validatePosition(this.position);
            this.updatePetStyle();
            this.syncToGlobalState();
        });
    }

    // åœæ­¢å®šæœŸåŒæ­¥
    stopPeriodicSync() {
        if (this.syncInterval) {
            clearInterval(this.syncInterval);
            this.syncInterval = null;
        }
    }

    // è®¾ç½®é”®ç›˜å¿«æ·é”®
    setupKeyboardShortcuts() {
        // ä½¿ç”¨ç®­å¤´å‡½æ•°ç¡®ä¿ this ç»‘å®šæ­£ç¡®
        const handleKeyDown = (e) => {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† Ctrl+Shift+S (æˆªå›¾å¿«æ·é”®)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('æ£€æµ‹åˆ°æˆªå›¾å¿«æ·é”® Ctrl+Shift+S');

                // ç›´æ¥è¿›è¡Œæˆªå›¾ï¼Œä¸éœ€è¦æ‰“å¼€èŠå¤©çª—å£
                this.takeScreenshot();

                return false;
            }

            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† Ctrl+Shift+X (åˆ‡æ¢èŠå¤©çª—å£å¿«æ·é”®)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'x') {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('æ£€æµ‹åˆ°èŠå¤©å¿«æ·é”® Ctrl+Shift+X');

                // ä»…åˆ‡æ¢æ˜¾ç¤º/éšè—ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
                this.toggleChatWindowVisibility();
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† Ctrl+Shift+P (åˆ‡æ¢å® ç‰©æ˜¾ç¤º/éšè—å¿«æ·é”®)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key.toLowerCase() === 'p' || e.code === 'KeyP')) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('æ£€æµ‹åˆ°åˆ‡æ¢å® ç‰©æ˜¾ç¤º/éšè—å¿«æ·é”® Ctrl+Shift+P');
                this.toggleVisibility();
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† Esc (å…³é—­èŠå¤©çª—å£)
            if (e.key === 'Escape' && this.isChatOpen) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                this.closeChatWindow();
                return false;
            }
        };

        // åŒæ—¶ç›‘å¬ window å’Œ documentï¼Œç¡®ä¿èƒ½å¤Ÿæ•è·æ‰€æœ‰é”®ç›˜äº‹ä»¶
        window.addEventListener('keydown', handleKeyDown, true); // ä½¿ç”¨æ•è·é˜¶æ®µ
        document.addEventListener('keydown', handleKeyDown, true); // ä½¿ç”¨æ•è·é˜¶æ®µ

        // ä¿å­˜äº‹ä»¶å¤„ç†å™¨å¼•ç”¨ï¼Œä»¥ä¾¿åç»­æ¸…ç†
        this._keyboardShortcutHandler = handleKeyDown;

        console.log('é”®ç›˜å¿«æ·é”®å·²è®¾ç½®ï¼š');
        console.log('  - Ctrl+Shift+Sï¼šæˆªå›¾');
        console.log('  - Ctrl+Shift+Xï¼šåˆ‡æ¢èŠå¤©çª—å£');
        console.log('  - Ctrl+Shift+Pï¼šåˆ‡æ¢å® ç‰©æ˜¾ç¤º/éšè—');
        console.log('  - Escï¼šå…³é—­èŠå¤©çª—å£');
    }

    // æ¸…ç†èµ„æº
    cleanup() {
        console.log('æ¸…ç†å® ç‰©ç®¡ç†å™¨èµ„æº...');

        // åœæ­¢å®šæœŸåŒæ­¥
        this.stopPeriodicSync();

        // ç§»é™¤é”®ç›˜å¿«æ·é”®ç›‘å¬å™¨
        if (this._keyboardShortcutHandler) {
            window.removeEventListener('keydown', this._keyboardShortcutHandler, true);
            document.removeEventListener('keydown', this._keyboardShortcutHandler, true);
            this._keyboardShortcutHandler = null;
        }

        // ç§»é™¤å® ç‰©
        this.removePet();

        // å…³é—­èŠå¤©çª—å£
        if (this.chatWindow) {
            this.closeChatWindow();
        }

        // æ¸…ç†æˆªå›¾é¢„è§ˆ
        this.closeScreenshotPreview();

        console.log('èµ„æºæ¸…ç†å®Œæˆ');
    }

    // è®¡ç®—ä¸¤ä¸ªæ–‡æœ¬çš„ç›¸ä¼¼åº¦ï¼ˆç®€åŒ–ç‰ˆï¼‰
    calculateSimilarity(text1, text2) {
        if (text1 === text2) return 1.0;
        if (text1.length === 0 || text2.length === 0) return 0;

        // ä½¿ç”¨ç®€å•çš„å­—ç¬¦åŒ¹é…åº¦
        const longer = text1.length > text2.length ? text1 : text2;
        const shorter = text1.length > text2.length ? text2 : text1;

        if (longer.length === 0) return 1.0;

        // è®¡ç®—ç›¸åŒå­—ç¬¦çš„æ•°é‡
        let matches = 0;
        for (let i = 0; i < shorter.length; i++) {
            if (longer.includes(shorter[i])) {
                matches++;
            }
        }

        return matches / longer.length;
    }

    // è·å–é¡µé¢çš„å®Œæ•´æ­£æ–‡å†…å®¹
    getFullPageText() {
        try {
            // å®šä¹‰éœ€è¦æ’é™¤çš„é€‰æ‹©å™¨
            const excludeSelectors = [
                'script', 'style', 'nav', 'header', 'footer', 'aside',
                'noscript', 'iframe', 'embed', 'svg', 'canvas',
                '.ad', '.advertisement', '.ads', '.advertisement-container',
                '.sidebar', '.menu', '.navigation', '.navbar', '.nav',
                '.header', '.footer', '.comment', '.comments', '.social-share',
                '.related-posts', '.related', '.widget', '.sidebar-widget',
                '[class*="ad"]', '[class*="banner"]', '[class*="promo"]',
                '[id*="ad"]', '[id*="banner"]', '[id*="promo"]',
                'iframe', 'embed', 'object', 'form', 'button', 'input'
            ];

            // å®šä¹‰ä¸»è¦æ­£æ–‡å†…å®¹é€‰æ‹©å™¨ï¼ŒæŒ‰ä¼˜å…ˆçº§é¡ºåº
            const contentSelectors = [
                'main',
                'article',
                '[role="main"]',
                '.content', '.main-content', '.page-content',
                '.post-content', '.entry-content', '.article-content',
                '.post-body', '.text-content', '.article-body',
                '#content', '#main-content', '#main',
                '.article', '.blog-post', '.entry', '.post',
                '.content-area', '.content-wrapper',
                '.text-wrapper', '.text-container'
            ];

            // å°è¯•ä»ä¸»è¦å†…å®¹åŒºåŸŸè·å–
            let mainContent = null;
            let foundSelector = '';
            for (const selector of contentSelectors) {
                mainContent = document.querySelector(selector);
                if (mainContent) {
                    foundSelector = selector;
                    console.log('æ‰¾åˆ°ä¸»è¦å†…å®¹åŒºåŸŸ:', selector);
                    break;
                }
            }

            // å¦‚æœæ‰¾åˆ°äº†ä¸»è¦å†…å®¹åŒºåŸŸ
            if (mainContent) {
                // å…‹éš†å†…å®¹ä»¥é¿å…ä¿®æ”¹åŸå§‹DOM
                const cloned = mainContent.cloneNode(true);

                // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
                excludeSelectors.forEach(sel => {
                    try {
                        const elements = cloned.querySelectorAll(sel);
                        elements.forEach(el => el.remove());
                    } catch (e) {
                        // å¿½ç•¥æ— æ•ˆçš„é€‰æ‹©å™¨
                    }
                });

                const textContent = cloned.textContent || cloned.innerText || '';
                const trimmedText = textContent.trim();

                // å¦‚æœå†…å®¹è¶³å¤Ÿé•¿ï¼Œè¿”å›
                if (trimmedText.length > 100) {
                    return trimmedText;
                }
            }

            // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å†…å®¹ï¼Œè·å–é¡µé¢ä¸­æ‰€æœ‰çš„æ–‡æœ¬æ®µè½
            const textElements = Array.from(document.querySelectorAll(
                'p, div, section, article, main, li, blockquote, ' +
                'h1, h2, h3, h4, h5, h6, span, pre, code, td, th, dd, dt, ' +
                'label, legend, caption, summary, details, address, time'
            ));

            const allTexts = textElements
                .map(el => (el.textContent || el.innerText || '').trim())
                .filter(text => {
                    // è¿›ä¸€æ­¥æ”¾å®½æ–‡æœ¬é•¿åº¦è¦æ±‚ï¼šåªè¦è¶…è¿‡3ä¸ªå­—ç¬¦å°±ä¿ç•™
                    if (text.length < 3) return false;

                    // åªè¿‡æ»¤æ˜æ˜¾çš„åƒåœ¾å†…å®¹
                    const lowerText = text.toLowerCase();

                    // åªè¿‡æ»¤æœ€æ˜æ˜¾ã€æœ€ç®€çŸ­çš„æ— æ„ä¹‰æ–‡æœ¬
                    if (text.length <= 5 &&
                        (lowerText === 'æ›´å¤š' || lowerText === 'more' || lowerText === 'ç‚¹å‡»')) {
                        return false;
                    }

                    return true;
                });

            // å»é‡å¹¶åˆå¹¶æ–‡æœ¬ï¼ˆä½¿ç”¨æ›´å®½æ¾çš„å»é‡ç­–ç•¥ï¼‰
            const uniqueTexts = [];
            const seenTexts = new Set();

            for (const text of allTexts) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç¡®åˆ‡çš„é‡å¤
                let isExactDuplicate = seenTexts.has(text);

                if (!isExactDuplicate) {
                    // æ›´å®½æ¾çš„å»é‡ï¼šåªåœ¨æ–‡æœ¬éå¸¸ç›¸ä¼¼æ—¶è§†ä¸ºé‡å¤
                    let isSimilar = false;
                    for (const seenText of seenTexts) {
                        // åªæœ‰å½“ä¸¤ä¸ªé•¿æ–‡æœ¬å‡ ä¹å®Œå…¨ç›¸åŒæ—¶æ‰è§†ä¸ºé‡å¤
                        if (text.length > 100 && seenText.length > 100) {
                            // è®¡ç®—ç›¸ä¼¼åº¦ï¼šä½¿ç”¨Levenshteinè·ç¦»çš„ç®€åŒ–ç‰ˆæœ¬
                            const similarity = calculateSimilarity(text, seenText);
                            if (similarity > 0.99) { // 99%ä»¥ä¸Šç›¸ä¼¼æ‰è§†ä¸ºé‡å¤ï¼ˆå‡ ä¹å®Œå…¨ä¸€è‡´ï¼‰
                                isSimilar = true;
                                break;
                            }
                        }
                    }

                    if (!isSimilar) {
                        seenTexts.add(text);
                        uniqueTexts.push(text);
                    }
                }
            }

            if (uniqueTexts.length > 0) {
                return uniqueTexts.join('\n\n').trim();
            }

            // æœ€åå°è¯•ä»æ•´ä¸ªbodyè·å–
            const body = document.body;
            if (body) {
                const clonedBody = body.cloneNode(true);

                // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
                excludeSelectors.forEach(sel => {
                    try {
                        const elements = clonedBody.querySelectorAll(sel);
                        elements.forEach(el => el.remove());
                    } catch (e) {
                        // å¿½ç•¥æ— æ•ˆçš„é€‰æ‹©å™¨
                    }
                });

                const textContent = clonedBody.textContent || clonedBody.innerText || '';
                return textContent.trim();
            }

            return '';
        } catch (error) {
            console.error('è·å–é¡µé¢å†…å®¹æ—¶å‡ºé”™:', error);
            return '';
        }
    }

    // è·å–é¡µé¢å†…å®¹å¹¶è½¬æ¢ä¸º Markdown
    // ç»Ÿä¸€è·å–é¡µé¢ä¿¡æ¯çš„æ–¹æ³•ï¼šæ ‡é¢˜ã€æè¿°ã€URLã€å†…å®¹
    getPageInfo() {
        const pageTitle = document.title || 'æœªå‘½åé¡µé¢';
        const pageUrl = window.location.href;
        
        // è·å–é¡µé¢æè¿°ï¼ˆmeta descriptionï¼‰
        const metaDescription = document.querySelector('meta[name="description"]');
        const pageDescription = metaDescription ? metaDescription.content.trim() : '';
        
        // è·å–é¡µé¢å†…å®¹
        const pageContent = this.getPageContentAsMarkdown();
        
        return {
            title: pageTitle.trim(),
            url: pageUrl,
            description: pageDescription,
            content: pageContent
        };
    }

    getPageContentAsMarkdown() {
        try {
            // æ£€æŸ¥ Turndown æ˜¯å¦å¯ç”¨
            if (typeof TurndownService === 'undefined') {
                console.warn('Turndown æœªåŠ è½½ï¼Œè¿”å›çº¯æ–‡æœ¬å†…å®¹');
                return this.getFullPageText();
            }

            // å®šä¹‰éœ€è¦æ’é™¤çš„é€‰æ‹©å™¨
            const excludeSelectors = [
                'script', 'style', 'nav', 'header', 'footer', 'aside',
                'noscript', 'iframe', 'embed', 'svg', 'canvas',
                '.ad', '.advertisement', '.ads', '.advertisement-container',
                '.sidebar', '.menu', '.navigation', '.navbar', '.nav',
                '.header', '.footer', '.comment', '.comments', '.social-share',
                '.related-posts', '.related', '.widget', '.sidebar-widget',
                '[class*="ad"]', '[class*="banner"]', '[class*="promo"]',
                '[id*="ad"]', '[id*="banner"]', '[id*="promo"]',
                'iframe', 'embed', 'object', 'form', 'button', 'input'
            ];

            // å®šä¹‰ä¸»è¦æ­£æ–‡å†…å®¹é€‰æ‹©å™¨
            const contentSelectors = [
                'main',
                'article',
                '[role="main"]',
                '.content', '.main-content', '.page-content',
                '.post-content', '.entry-content', '.article-content',
                '.post-body', '.text-content', '.article-body',
                '#content', '#main-content', '#main',
                '.article', '.blog-post', '.entry', '.post',
                '.content-area', '.content-wrapper',
                '.text-wrapper', '.text-container'
            ];

            // å°è¯•ä»ä¸»è¦å†…å®¹åŒºåŸŸè·å–
            let mainContent = null;
            for (const selector of contentSelectors) {
                mainContent = document.querySelector(selector);
                if (mainContent) break;
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸»è¦å†…å®¹åŒºåŸŸï¼Œä½¿ç”¨body
            if (!mainContent) {
                mainContent = document.body;
            }

            // å…‹éš†å†…å®¹
            const cloned = mainContent.cloneNode(true);

            // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
            excludeSelectors.forEach(sel => {
                try {
                    const elements = cloned.querySelectorAll(sel);
                    elements.forEach(el => el.remove());
                } catch (e) {}
            });

            // ä½¿ç”¨ Turndown è½¬æ¢
            const turndownService = new TurndownService({
                headingStyle: 'atx',
                bulletListMarker: '-',
                codeBlockStyle: 'fenced',
                fence: '```',
                emDelimiter: '*',
                strongDelimiter: '**',
                linkStyle: 'inlined',
                linkReferenceStyle: 'collapsed'
            });

            const markdown = turndownService.turndown(cloned);

            // å¦‚æœ Markdown å†…å®¹å¤ªçŸ­æˆ–ä¸ºç©ºï¼Œè¿”å›çº¯æ–‡æœ¬
            if (!markdown || markdown.trim().length < 100) {
                const textContent = cloned.textContent || cloned.innerText || '';
                return textContent.trim();
            }

            return markdown.trim();
        } catch (error) {
            console.error('è½¬æ¢ä¸º Markdown æ—¶å‡ºé”™:', error);
            // å‡ºé”™æ—¶è¿”å›çº¯æ–‡æœ¬
            return this.getFullPageText();
        }
    }


    // é€šç”¨çš„æµå¼å“åº”å¤„ç†æ–¹æ³•
    async processStreamingResponse(response, onContent) {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullContent = '';

        while (true) {
            const { done, value } = await reader.read();

            if (done) {
                break;
            }

            buffer += decoder.decode(value, { stream: true });

            const messages = buffer.split('\n\n');
            buffer = messages.pop() || '';

            for (const message of messages) {
                if (message.startsWith('data: ')) {
                    try {
                        const dataStr = message.substring(6);
                        const chunk = JSON.parse(dataStr);

                        // å¤„ç†åç«¯è¿”å›çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                        if (chunk.type === 'context_info') {
                            const contextData = chunk.data || {};
                            if (contextData.chats_count > 0) {
                                console.log(`æ£€ç´¢åˆ° ${contextData.chats_count} æ¡èŠå¤©è®°å½•`);
                            }
                        }
                        // å¤„ç†åç«¯è¿”å›çš„èŠå¤©ä¿å­˜æˆåŠŸäº‹ä»¶ï¼ŒåŒæ­¥ä¼šè¯ ID
                        else if (chunk.type === 'chat_saved') {
                            const conversationId = chunk.conversation_id;
                            if (conversationId && !this.currentSessionId) {
                                // å¦‚æœå½“å‰æ²¡æœ‰ä¼šè¯ IDï¼Œä½¿ç”¨åç«¯è¿”å›çš„ä¼šè¯ ID
                                this.currentSessionId = conversationId;
                                console.log('ä»åç«¯åŒæ­¥ä¼šè¯ ID:', conversationId);
                            } else if (conversationId && this.currentSessionId !== conversationId) {
                                // å¦‚æœåç«¯è¿”å›çš„ä¼šè¯ ID ä¸å½“å‰ä¸åŒï¼Œè®°å½•æ—¥å¿—ï¼ˆä½†ä¸å¼ºåˆ¶æ›´æ–°ï¼Œå› ä¸ºå‰ç«¯å¯èƒ½æœ‰è‡ªå·±çš„ä¼šè¯ç®¡ç†é€»è¾‘ï¼‰
                                console.log('åç«¯è¿”å›çš„ä¼šè¯ ID ä¸å½“å‰ä¸åŒ:', conversationId, 'vs', this.currentSessionId);
                            }
                        }
                        // æ”¯æŒ Ollama æ ¼å¼: chunk.message.content
                        else if (chunk.message && chunk.message.content) {
                            fullContent += chunk.message.content;
                            if (onContent) {
                                onContent(chunk.message.content, fullContent);
                            }
                        }
                        // æ”¯æŒæ—§çš„è‡ªå®šä¹‰æ ¼å¼: data.type === 'content'
                        else if (chunk.type === 'content') {
                            fullContent += chunk.data;
                            if (onContent) {
                                onContent(chunk.data, fullContent);
                            }
                        }
                        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                        else if (chunk.done === true) {
                            console.log('æµå¼å“åº”å®Œæˆ');
                        }
                            // å¤„ç†é”™è¯¯
                        else if (chunk.type === 'error' || chunk.error) {
                            const errorMsg = chunk.data || chunk.error || 'æœªçŸ¥é”™è¯¯';
                            console.error('æµå¼å“åº”é”™è¯¯:', errorMsg);
                            throw new Error(errorMsg);
                        }
                    } catch (e) {
                        console.warn('è§£æ SSE æ¶ˆæ¯å¤±è´¥:', message, e);
                    }
                }
            }
        }

        // å¤„ç†æœ€åçš„ç¼“å†²åŒºæ¶ˆæ¯
        if (buffer.trim()) {
            const message = buffer.trim();
            if (message.startsWith('data: ')) {
                try {
                    const chunk = JSON.parse(message.substring(6));
                    if (chunk.done === true || chunk.type === 'done') {
                        console.log('æµå¼å“åº”å®Œæˆ');
                    } else if (chunk.type === 'error' || chunk.error) {
                        const errorMsg = chunk.data || chunk.error || 'æœªçŸ¥é”™è¯¯';
                        throw new Error(errorMsg);
                    }
                } catch (e) {
                    console.warn('è§£ææœ€åçš„ SSE æ¶ˆæ¯å¤±è´¥:', message, e);
                }
            }
        }

        // prompt æ¥å£è°ƒç”¨åè§¦å‘ session/save
        if (this.currentSessionId && this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
            try {
                // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                await this.saveCurrentSession(false, false);
                
                // è°ƒç”¨ session/save æ¥å£ä¿å­˜ä¼šè¯
                await this.syncSessionToBackend(this.currentSessionId, true);
                console.log(`processStreamingResponse å®Œæˆåï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
            } catch (error) {
                console.warn('processStreamingResponse å®Œæˆåä¿å­˜ä¼šè¯å¤±è´¥:', error);
            }
        }

        return fullContent;
    }

    // ä»æ–‡æœ¬ä¸­æå–å›¾ç‰‡å’Œè§†é¢‘ URL
    extractMediaUrls(text) {
        const images = [];
        const videos = [];
        let cleanedText = text || '';
        
        if (!text || typeof text !== 'string') {
            return { images, videos, cleanedText };
        }
        
        // æå– data URL æ ¼å¼çš„å›¾ç‰‡ï¼ˆdata:image/...ï¼‰
        const dataImageRegex = /data:image\/[^;]+;base64,[^\s"'<>]+/gi;
        const dataImageMatches = text.match(dataImageRegex);
        if (dataImageMatches) {
            images.push(...dataImageMatches);
            // ä»æ–‡æœ¬ä¸­ç§»é™¤è¿™äº› data URL
            dataImageMatches.forEach(url => {
                cleanedText = cleanedText.replace(url, '');
            });
        }
        
        // æå–æ™®é€š URL æ ¼å¼çš„å›¾ç‰‡ï¼ˆhttp:// æˆ– https:// ç»“å°¾æ˜¯å›¾ç‰‡æ‰©å±•åï¼‰
        const imageUrlRegex = /https?:\/\/[^\s"'<>]+\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?[^\s"'<>]*)?/gi;
        const imageUrlMatches = text.match(imageUrlRegex);
        if (imageUrlMatches) {
            imageUrlMatches.forEach(url => {
                if (!images.includes(url)) {
                    images.push(url);
                }
                // ä»æ–‡æœ¬ä¸­ç§»é™¤è¿™äº› URL
                cleanedText = cleanedText.replace(url, '');
            });
        }
        
        // æå–è§†é¢‘ URLï¼ˆhttp:// æˆ– https:// ç»“å°¾æ˜¯è§†é¢‘æ‰©å±•åï¼‰
        const videoUrlRegex = /https?:\/\/[^\s"'<>]+\.(mp4|webm|ogg|mov|avi|wmv|flv|mkv)(\?[^\s"'<>]*)?/gi;
        const videoUrlMatches = text.match(videoUrlRegex);
        if (videoUrlMatches) {
            videos.push(...videoUrlMatches);
            // ä»æ–‡æœ¬ä¸­ç§»é™¤è¿™äº› URL
            videoUrlMatches.forEach(url => {
                cleanedText = cleanedText.replace(url, '');
            });
        }
        
        // æå– data URL æ ¼å¼çš„è§†é¢‘ï¼ˆdata:video/...ï¼‰
        const dataVideoRegex = /data:video\/[^;]+;base64,[^\s"'<>]+/gi;
        const dataVideoMatches = text.match(dataVideoRegex);
        if (dataVideoMatches) {
            videos.push(...dataVideoMatches);
            // ä»æ–‡æœ¬ä¸­ç§»é™¤è¿™äº› data URL
            dataVideoMatches.forEach(url => {
                cleanedText = cleanedText.replace(url, '');
            });
        }
        
        // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦
        cleanedText = cleanedText.replace(/\s+/g, ' ').trim();
        
        return { images, videos, cleanedText };
    }

    // ä»æ¶ˆæ¯ DOM å…ƒç´ æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯å¯¹è±¡
    findMessageObjectByDiv(messageDiv) {
        if (!messageDiv || !this.currentSessionId || !this.sessions[this.currentSessionId]) {
            return null;
        }

        const session = this.sessions[this.currentSessionId];
        if (!session.messages || !Array.isArray(session.messages)) {
            return null;
        }

        // è·å–æ¶ˆæ¯å†…å®¹ï¼ˆæ–‡æœ¬å’Œå›¾ç‰‡ï¼‰
        const isUserMessage = messageDiv.querySelector('[data-message-type="user-bubble"]');
        const messageBubble = isUserMessage 
            ? messageDiv.querySelector('[data-message-type="user-bubble"]')
            : messageDiv.querySelector('[data-message-type="pet-bubble"]');
        
        if (!messageBubble) {
            return null;
        }

        // è·å–æ¶ˆæ¯æ–‡æœ¬å†…å®¹
        const messageContent = messageBubble.getAttribute('data-original-text') || 
                              messageBubble.innerText || 
                              messageBubble.textContent || '';
        
        // è·å–æ¶ˆæ¯ç±»å‹
        const messageType = isUserMessage ? 'user' : 'pet';

        // åœ¨ä¼šè¯æ¶ˆæ¯åˆ—è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„æ¶ˆæ¯å¯¹è±¡
        // ä¼˜å…ˆåŒ¹é…å†…å®¹å’Œç±»å‹ï¼Œå¦‚æœæœ‰å¤šæ¡åŒ¹é…ï¼Œé€‰æ‹©æœ€è¿‘çš„ä¸€æ¡
        for (let i = session.messages.length - 1; i >= 0; i--) {
            const msg = session.messages[i];
            if (msg.type === messageType) {
                // æ¯”è¾ƒæ¶ˆæ¯å†…å®¹ï¼ˆå»é™¤é¦–å°¾ç©ºç™½ï¼‰
                const msgContent = (msg.content || '').trim();
                const divContent = messageContent.trim();
                
                // å¦‚æœå†…å®¹åŒ¹é…ï¼Œè¿”å›è¯¥æ¶ˆæ¯å¯¹è±¡
                if (msgContent === divContent || 
                    (msgContent && divContent && msgContent.includes(divContent)) ||
                    (divContent && msgContent && divContent.includes(msgContent))) {
                    return msg;
                }
            }
        }

        // å¦‚æœæ‰¾ä¸åˆ°å®Œå…¨åŒ¹é…çš„ï¼Œè¿”å›æœ€åä¸€æ¡åŒç±»å‹çš„æ¶ˆæ¯
        for (let i = session.messages.length - 1; i >= 0; i--) {
            const msg = session.messages[i];
            if (msg.type === messageType) {
                return msg;
            }
        }

        return null;
    }

    // æ„å»º prompt è¯·æ±‚ payloadï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID
    buildPromptPayload(fromSystem, fromUser, model = null, options = {}) {
        const payload = {
            fromSystem: fromSystem || 'ä½ æ˜¯ä¸€ä¸ªä¿çš®æ´»æ³¼ã€å¤çµç²¾æ€ªçš„å°å¥³å‹ï¼Œèªæ˜æœ‰è¶£ï¼Œæ—¶è€Œè°ƒä¾ƒæ—¶è€Œè´´å¿ƒã€‚è¯­æ°”æ´»æ³¼å¯çˆ±ï¼Œä¼šå¼€å°ç©ç¬‘ï¼Œä½†ä¹Ÿä¼šå…³å¿ƒç”¨æˆ·ã€‚',
            fromUser: fromUser
        };
        
        // æ·»åŠ æ¨¡å‹åç§°ï¼ˆå¦‚æœæä¾›ï¼‰
        const modelName = model || this.currentModel;
        if (modelName) {
            payload.model = modelName;
        }
        
        // å½“æ¨¡å‹æ˜¯ qwen3-vl æ—¶ï¼Œä» fromUser ä¸­æå–å›¾ç‰‡å’Œè§†é¢‘
        if (modelName === 'qwen3-vl' && fromUser && typeof fromUser === 'string') {
            const { images, videos, cleanedText } = this.extractMediaUrls(fromUser);
            
            // æ›´æ–° fromUser ä¸ºæ¸…ç†åçš„æ–‡æœ¬
            payload.fromUser = cleanedText || '';
            
            // åˆå¹¶ä» fromUser æå–çš„å›¾ç‰‡å’Œ options ä¸­æä¾›çš„å›¾ç‰‡
            const allImages = [...images];
            
            // è·å–å›¾ç‰‡ï¼šä¼˜å…ˆä½¿ç”¨ options ä¸­æä¾›çš„
            // å¦‚æœ options ä¸­æ²¡æœ‰æä¾›ï¼Œä¸” options.messageDiv å­˜åœ¨ï¼Œåˆ™ä» DOM å…ƒç´ ä¸­ç›´æ¥æå–å›¾ç‰‡
            let imageDataUrls = [];
            if (options.imageDataUrl) {
                // å¦‚æœæä¾›äº†å•ä¸ªå›¾ç‰‡ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                imageDataUrls = Array.isArray(options.imageDataUrl) ? options.imageDataUrl : [options.imageDataUrl];
            }
            
            if (imageDataUrls.length === 0 && options.messageDiv) {
                // ä¼˜å…ˆä» DOM å…ƒç´ ä¸­ç›´æ¥æŸ¥æ‰¾å›¾ç‰‡ï¼ˆæ›´å‡†ç¡®ï¼‰
                const userBubble = options.messageDiv.querySelector('[data-message-type="user-bubble"]');
                if (userBubble) {
                    // æŸ¥æ‰¾ç”¨æˆ·æ¶ˆæ¯ä¸­çš„æ‰€æœ‰ img æ ‡ç­¾
                    const imgElements = userBubble.querySelectorAll('img');
                    imgElements.forEach(img => {
                        if (img.src && !imageDataUrls.includes(img.src)) {
                            imageDataUrls.push(img.src);
                        }
                    });
                }
                
                // å¦‚æœä» DOM ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä»æ¶ˆæ¯å¯¹è±¡ä¸­è·å–ï¼ˆä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼‰
                if (imageDataUrls.length === 0) {
                    const messageObj = this.findMessageObjectByDiv(options.messageDiv);
                    if (messageObj && messageObj.imageDataUrl) {
                        const imgUrl = messageObj.imageDataUrl;
                        if (typeof imgUrl === 'string') {
                            imageDataUrls.push(imgUrl);
                        } else if (Array.isArray(imgUrl)) {
                            imageDataUrls = imgUrl;
                        }
                    }
                }
            }
            // å¦‚æœä»ç„¶æ²¡æœ‰è·å–åˆ°ï¼Œä¸”æ²¡æœ‰æŒ‡å®š messageDivï¼Œåˆ™ä»å½“å‰ä¼šè¯æ¶ˆæ¯ä¸­è·å–ï¼ˆå‘åå…¼å®¹ï¼‰
            if (imageDataUrls.length === 0 && !options.messageDiv && this.currentSessionId && this.sessions[this.currentSessionId]) {
                const session = this.sessions[this.currentSessionId];
                if (session.messages && Array.isArray(session.messages) && session.messages.length > 0) {
                    // ä»åå¾€å‰æŸ¥æ‰¾æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„ imageDataUrl
                    for (let i = session.messages.length - 1; i >= 0; i--) {
                        const msg = session.messages[i];
                        if (msg.type === 'user' && msg.imageDataUrl) {
                            const imgUrl = msg.imageDataUrl;
                            if (typeof imgUrl === 'string') {
                                imageDataUrls.push(imgUrl);
                            } else if (Array.isArray(imgUrl)) {
                                imageDataUrls = imgUrl;
                            }
                            break;
                        }
                    }
                }
            }
            
            // å°†ä»æ¶ˆæ¯ä¸­è·å–åˆ°çš„å›¾ç‰‡è¿½åŠ åˆ°å›¾ç‰‡åˆ—è¡¨ä¸­
            imageDataUrls.forEach(imgUrl => {
                if (imgUrl && typeof imgUrl === 'string' && !allImages.includes(imgUrl)) {
                    allImages.push(imgUrl);
                }
            });
            
            if (options.images && Array.isArray(options.images)) {
                options.images.forEach(img => {
                    if (!allImages.includes(img)) {
                        allImages.push(img);
                    }
                });
            }
            if (allImages.length > 0) {
                payload.images = allImages;
            }
            
            // åˆå¹¶ä» fromUser æå–çš„è§†é¢‘å’Œ options ä¸­æä¾›çš„è§†é¢‘
            const allVideos = [...videos];
            if (options.videos && Array.isArray(options.videos)) {
                options.videos.forEach(video => {
                    if (!allVideos.includes(video)) {
                        allVideos.push(video);
                    }
                });
            }
            if (allVideos.length > 0) {
                payload.videos = allVideos;
            }
        } else {
            // å¦‚æœæ¨¡å‹ä¸æ˜¯ qwen3-vlï¼Œç›´æ¥ä½¿ç”¨ options ä¸­çš„ images/videosï¼ˆå¦‚æœæœ‰ï¼‰
            if (options.images !== undefined) {
                payload.images = options.images;
            }
            if (options.videos !== undefined) {
                payload.videos = options.videos;
            }
        }
        
        // æ·»åŠ ä¼šè¯ IDï¼ˆconversation_idï¼‰- ä½¿ç”¨å½“å‰ä¼šè¯ ID
        if (this.currentSessionId) {
            payload.conversation_id = this.currentSessionId;
        }
        
        // æ·»åŠ ç”¨æˆ· IDï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        if (options.user_id) {
            payload.user_id = options.user_id;
        }
        
        return payload;
    }

    // ç”Ÿæˆå® ç‰©å“åº”ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
    async generatePetResponseStream(message, onContent, abortController = null) {
        // å¼€å§‹åŠ è½½åŠ¨ç”»
        this.showLoadingAnimation();
        
        try {
            // æ£€æŸ¥å¼€å…³çŠ¶æ€
            let includeContext = true; // é»˜è®¤åŒ…å«ä¸Šä¸‹æ–‡
            const contextSwitch = this.chatWindow ? this.chatWindow.querySelector('#context-switch') : null;
            if (contextSwitch) {
                includeContext = contextSwitch.checked;
            }

            // ä¼˜å…ˆä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰é¡µé¢å†…å®¹
            let fullPageMarkdown = '';
            let pageTitle = document.title || 'å½“å‰é¡µé¢';
            
            if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                const session = this.sessions[this.currentSessionId];
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç™½ä¼šè¯ï¼ˆç©ºç™½ä¼šè¯ä¸åº”è¯¥å¡«å……é¡µé¢å†…å®¹ï¼‰
                const isBlankSession = session._isBlankSession || 
                                      !session.url || 
                                      session.url.startsWith('blank-session://');
                
                // å¦‚æœä¼šè¯æœ‰ä¿å­˜çš„é¡µé¢å†…å®¹ï¼Œä½¿ç”¨å®ƒ
                if (session.pageContent && session.pageContent.trim() !== '') {
                    fullPageMarkdown = session.pageContent;
                    pageTitle = session.pageTitle || pageTitle;
                } else if (!isBlankSession) {
                    // å¦‚æœä¸æ˜¯ç©ºç™½ä¼šè¯ä¸”æ²¡æœ‰ä¿å­˜çš„é¡µé¢å†…å®¹ï¼Œè·å–å½“å‰é¡µé¢å†…å®¹å¹¶ä¿å­˜åˆ°ä¼šè¯
                    fullPageMarkdown = this.getPageContentAsMarkdown();
                    pageTitle = document.title || 'å½“å‰é¡µé¢';
                    session.pageContent = fullPageMarkdown;
                    session.pageTitle = pageTitle;
                    // æ³¨æ„ï¼šå·²ç§»é™¤ä¸´æ—¶ä¿å­˜ï¼Œé¡µé¢å†…å®¹ä¼šåœ¨ prompt æ¥å£è°ƒç”¨å®Œæˆåç»Ÿä¸€ä¿å­˜
                } else {
                    // ç©ºç™½ä¼šè¯ï¼šä¸å¡«å……é¡µé¢å†…å®¹ï¼Œä½¿ç”¨ç©ºå†…å®¹
                    fullPageMarkdown = '';
                    pageTitle = session.pageTitle || 'æ–°ä¼šè¯';
                    console.log('ç©ºç™½ä¼šè¯ï¼Œä¸å¡«å……é¡µé¢å†…å®¹');
                }
            } else {
                // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ï¼Œä½¿ç”¨å½“å‰é¡µé¢å†…å®¹
                fullPageMarkdown = this.getPageContentAsMarkdown();
            }

            // æ„å»ºåŒ…å«é¡µé¢å†…å®¹çš„å®Œæ•´æ¶ˆæ¯
            const pageUrl = window.location.href;

            // æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦åŒ…å«é¡µé¢å†…å®¹
            let userMessage = message;
            if (includeContext && fullPageMarkdown) {
                userMessage = `ã€å½“å‰é¡µé¢ä¸Šä¸‹æ–‡ã€‘\né¡µé¢æ ‡é¢˜ï¼š${pageTitle}\né¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š\n${fullPageMarkdown}\n\nã€ç”¨æˆ·é—®é¢˜ã€‘\n${message}`;
            }

            // è°ƒç”¨ APIï¼Œä½¿ç”¨é…ç½®ä¸­çš„ URL
            const apiUrl = PET_CONFIG.api.streamPromptUrl;

            // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID å’Œ imageDataUrlï¼ˆå¦‚æœæ˜¯ qwen3-vl æ¨¡å‹ï¼‰
            const payload = this.buildPromptPayload(
                'ä½ æ˜¯ä¸€ä¸ªä¿çš®æ´»æ³¼ã€å¤çµç²¾æ€ªçš„å°å¥³å‹ï¼Œèªæ˜æœ‰è¶£ï¼Œæ—¶è€Œè°ƒä¾ƒæ—¶è€Œè´´å¿ƒã€‚è¯­æ°”æ´»æ³¼å¯çˆ±ï¼Œä¼šå¼€å°ç©ç¬‘ï¼Œä½†ä¹Ÿä¼šå…³å¿ƒç”¨æˆ·ã€‚',
                userMessage,
                this.currentModel
            );
            
            const fetchOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            };

            // å¦‚æœæä¾›äº† AbortControllerï¼Œæ·»åŠ  signal
            if (abortController) {
                fetchOptions.signal = abortController.signal;
            }

            const response = await fetch(apiUrl, fetchOptions);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            // è¯»å–æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullContent = '';

            while (true) {
                // æ£€æŸ¥æ˜¯å¦å·²ä¸­æ­¢
                if (abortController && abortController.signal.aborted) {
                    reader.cancel();
                    throw new Error('è¯·æ±‚å·²å–æ¶ˆ');
                }

                const { done, value } = await reader.read();

                if (done) {
                    break;
                }

                // è§£ç æ•°æ®å¹¶æ·»åŠ åˆ°ç¼“å†²åŒº
                buffer += decoder.decode(value, { stream: true });

                // å¤„ç†å®Œæ•´çš„ SSE æ¶ˆæ¯
                const messages = buffer.split('\n\n');
                buffer = messages.pop() || '';

                for (const message of messages) {
                    if (message.startsWith('data: ')) {
                        try {
                            const dataStr = message.substring(6);
                            const chunk = JSON.parse(dataStr);

                            // å¤„ç†åç«¯è¿”å›çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                            if (chunk.type === 'context_info') {
                                const contextData = chunk.data || {};
                                if (contextData.chats_count > 0) {
                                    console.log(`æ£€ç´¢åˆ° ${contextData.chats_count} æ¡èŠå¤©è®°å½•`);
                                }
                            }
                            // å¤„ç†åç«¯è¿”å›çš„èŠå¤©ä¿å­˜æˆåŠŸäº‹ä»¶ï¼ŒåŒæ­¥ä¼šè¯ ID
                            else if (chunk.type === 'chat_saved') {
                                const conversationId = chunk.conversation_id;
                                if (conversationId && !this.currentSessionId) {
                                    // å¦‚æœå½“å‰æ²¡æœ‰ä¼šè¯ IDï¼Œä½¿ç”¨åç«¯è¿”å›çš„ä¼šè¯ ID
                                    this.currentSessionId = conversationId;
                                    console.log('ä»åç«¯åŒæ­¥ä¼šè¯ ID:', conversationId);
                                } else if (conversationId && this.currentSessionId !== conversationId) {
                                    // å¦‚æœåç«¯è¿”å›çš„ä¼šè¯ ID ä¸å½“å‰ä¸åŒï¼Œè®°å½•æ—¥å¿—ï¼ˆä½†ä¸å¼ºåˆ¶æ›´æ–°ï¼Œå› ä¸ºå‰ç«¯å¯èƒ½æœ‰è‡ªå·±çš„ä¼šè¯ç®¡ç†é€»è¾‘ï¼‰
                                    console.log('åç«¯è¿”å›çš„ä¼šè¯ ID ä¸å½“å‰ä¸åŒ:', conversationId, 'vs', this.currentSessionId);
                                }
                            }
                            // æ”¯æŒ Ollama æ ¼å¼: chunk.message.content
                            else if (chunk.message && chunk.message.content) {
                                fullContent += chunk.message.content;
                                if (onContent) {
                                    onContent(chunk.message.content, fullContent);
                                }
                            }
                            // æ”¯æŒæ—§çš„è‡ªå®šä¹‰æ ¼å¼: data.type === 'content'
                            else if (chunk.type === 'content') {
                                fullContent += chunk.data;
                                if (onContent) {
                                    onContent(chunk.data, fullContent);
                                }
                            }
                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            else if (chunk.done === true) {
                                console.log('æµå¼å“åº”å®Œæˆ');
                            }
                            // å¤„ç†é”™è¯¯
                            else if (chunk.type === 'error' || chunk.error) {
                                const errorMsg = chunk.data || chunk.error || 'æœªçŸ¥é”™è¯¯';
                                console.error('æµå¼å“åº”é”™è¯¯:', errorMsg);
                                throw new Error(errorMsg);
                            }
                        } catch (e) {
                            console.warn('è§£æ SSE æ¶ˆæ¯å¤±è´¥:', message, e);
                        }
                    }
                }
            }

            // å¤„ç†æœ€åçš„ç¼“å†²åŒºæ¶ˆæ¯
            if (buffer.trim()) {
                const message = buffer.trim();
                if (message.startsWith('data: ')) {
                    try {
                        const chunk = JSON.parse(message.substring(6));
                        if (chunk.done === true || chunk.type === 'done') {
                            console.log('æµå¼å“åº”å®Œæˆ');
                        } else if (chunk.type === 'error' || chunk.error) {
                            const errorMsg = chunk.data || chunk.error || 'æœªçŸ¥é”™è¯¯';
                            throw new Error(errorMsg);
                        }
                    } catch (e) {
                        console.warn('è§£ææœ€åçš„ SSE æ¶ˆæ¯å¤±è´¥:', message, e);
                    }
                }
            }

            // prompt æ¥å£è°ƒç”¨åè§¦å‘ session/save
            if (this.currentSessionId && this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                try {
                    // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                    await this.saveCurrentSession(false, false);
                    
                    // è°ƒç”¨ session/save æ¥å£ä¿å­˜ä¼šè¯
                    await this.syncSessionToBackend(this.currentSessionId, true);
                    console.log(`æµå¼ prompt æ¥å£è°ƒç”¨åï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
                } catch (error) {
                    console.warn('æµå¼ prompt æ¥å£è°ƒç”¨åä¿å­˜ä¼šè¯å¤±è´¥:', error);
                }
            }

            return fullContent;
        } catch (error) {
            // å¦‚æœæ˜¯ä¸­æ­¢é”™è¯¯ï¼Œä¸è®°å½•ä¸ºé”™è¯¯
            if (error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ') {
                console.log('è¯·æ±‚å·²å–æ¶ˆ');
                throw error;
            }
            console.error('API è°ƒç”¨å¤±è´¥:', error);
            throw error;
        } finally {
            // åœæ­¢åŠ è½½åŠ¨ç”»
            this.stopLoadingAnimation();
        }
    }

    // ç”Ÿæˆå® ç‰©å“åº”
    async generatePetResponse(message) {
        // å¼€å§‹åŠ è½½åŠ¨ç”»
        this.showLoadingAnimation();
        
        try {
            // æ£€æŸ¥å¼€å…³çŠ¶æ€
            let includeContext = true; // é»˜è®¤åŒ…å«ä¸Šä¸‹æ–‡
            const contextSwitch = this.chatWindow ? this.chatWindow.querySelector('#context-switch') : null;
            if (contextSwitch) {
                includeContext = contextSwitch.checked;
            }

            // ä¼˜å…ˆä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰é¡µé¢å†…å®¹
            let fullPageMarkdown = '';
            let pageTitle = document.title || 'å½“å‰é¡µé¢';
            
            if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                const session = this.sessions[this.currentSessionId];
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç™½ä¼šè¯ï¼ˆç©ºç™½ä¼šè¯ä¸åº”è¯¥å¡«å……é¡µé¢å†…å®¹ï¼‰
                const isBlankSession = session._isBlankSession || 
                                      !session.url || 
                                      session.url.startsWith('blank-session://');
                
                // å¦‚æœä¼šè¯æœ‰ä¿å­˜çš„é¡µé¢å†…å®¹ï¼Œä½¿ç”¨å®ƒ
                if (session.pageContent && session.pageContent.trim() !== '') {
                    fullPageMarkdown = session.pageContent;
                    pageTitle = session.pageTitle || pageTitle;
                } else if (!isBlankSession) {
                    // å¦‚æœä¸æ˜¯ç©ºç™½ä¼šè¯ä¸”æ²¡æœ‰ä¿å­˜çš„é¡µé¢å†…å®¹ï¼Œè·å–å½“å‰é¡µé¢å†…å®¹å¹¶ä¿å­˜åˆ°ä¼šè¯
                    fullPageMarkdown = this.getPageContentAsMarkdown();
                    pageTitle = document.title || 'å½“å‰é¡µé¢';
                    session.pageContent = fullPageMarkdown;
                    session.pageTitle = pageTitle;
                    // æ³¨æ„ï¼šå·²ç§»é™¤ä¸´æ—¶ä¿å­˜ï¼Œé¡µé¢å†…å®¹ä¼šåœ¨ prompt æ¥å£è°ƒç”¨å®Œæˆåç»Ÿä¸€ä¿å­˜
                } else {
                    // ç©ºç™½ä¼šè¯ï¼šä¸å¡«å……é¡µé¢å†…å®¹ï¼Œä½¿ç”¨ç©ºå†…å®¹
                    fullPageMarkdown = '';
                    pageTitle = session.pageTitle || 'æ–°ä¼šè¯';
                    console.log('ç©ºç™½ä¼šè¯ï¼Œä¸å¡«å……é¡µé¢å†…å®¹');
                }
            } else {
                // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ï¼Œä½¿ç”¨å½“å‰é¡µé¢å†…å®¹
                fullPageMarkdown = this.getPageContentAsMarkdown();
            }

            // æ„å»ºåŒ…å«é¡µé¢å†…å®¹çš„å®Œæ•´æ¶ˆæ¯
            // æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦åŒ…å«é¡µé¢å†…å®¹
            let userMessage = message;
            if (includeContext && fullPageMarkdown) {
                userMessage = `ã€å½“å‰é¡µé¢ä¸Šä¸‹æ–‡ã€‘\né¡µé¢æ ‡é¢˜ï¼š${pageTitle}\né¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š\n${fullPageMarkdown}\n\nã€ç”¨æˆ·é—®é¢˜ã€‘\n${message}`;
            }

            // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID å’Œ imageDataUrlï¼ˆå¦‚æœæ˜¯ qwen3-vl æ¨¡å‹ï¼‰
            const payload = this.buildPromptPayload(
                'ä½ æ˜¯ä¸€ä¸ªä¿çš®æ´»æ³¼ã€å¤çµç²¾æ€ªçš„å°å¥³å‹ï¼Œèªæ˜æœ‰è¶£ï¼Œæ—¶è€Œè°ƒä¾ƒæ—¶è€Œè´´å¿ƒã€‚è¯­æ°”æ´»æ³¼å¯çˆ±ï¼Œä¼šå¼€å°ç©ç¬‘ï¼Œä½†ä¹Ÿä¼šå…³å¿ƒç”¨æˆ·ã€‚',
                userMessage,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            this._showLoadingAnimation();
            
            // è°ƒç”¨ APIï¼Œä½¿ç”¨é…ç½®ä¸­çš„ URL
            let response, result;
            try {
                response = await fetch(PET_CONFIG.api.promptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                result = await response.json();
                
                // éšè—åŠ è½½åŠ¨ç”»
                this._hideLoadingAnimation();
            } catch (error) {
                // éšè—åŠ è½½åŠ¨ç”»
                this._hideLoadingAnimation();
                throw error;
            }

            // é€‚é…æ–°çš„å“åº”æ ¼å¼: {status, msg, data, pagination}
            let responseContent;
            if (result.status === 200 && result.data) {
                // æˆåŠŸå“åº”ï¼Œæå– data å­—æ®µ
                responseContent = result.data;
            } else if (result.status !== 200) {
                // API è¿”å›é”™è¯¯ï¼Œä½¿ç”¨ msg å­—æ®µ
                responseContent = result.msg || 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†é”™è¯¯ã€‚';
            } else if (result.content) {
                responseContent = result.content;
            } else if (result.message) {
                responseContent = result.message;
            } else if (typeof result === 'string') {
                responseContent = result;
            } else {
                // æœªçŸ¥æ ¼å¼ï¼Œå°è¯•æå–å¯èƒ½çš„æ–‡æœ¬å†…å®¹
                responseContent = JSON.stringify(result);
            }

            // prompt æ¥å£è°ƒç”¨åè§¦å‘ session/save
            if (this.currentSessionId && this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                try {
                    // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                    await this.saveCurrentSession(false, false);
                    
                    // è°ƒç”¨ session/save æ¥å£ä¿å­˜ä¼šè¯
                    await this.syncSessionToBackend(this.currentSessionId, true);
                    console.log(`éæµå¼ prompt æ¥å£è°ƒç”¨åï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
                } catch (error) {
                    console.warn('éæµå¼ prompt æ¥å£è°ƒç”¨åä¿å­˜ä¼šè¯å¤±è´¥:', error);
                }
            }

            return responseContent;
        } catch (error) {
            console.error('API è°ƒç”¨å¤±è´¥:', error);
            // å¦‚æœ API è°ƒç”¨å¤±è´¥ï¼Œè¿”å›é»˜è®¤å“åº”
            return 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·ç¨åå†è¯•ã€‚ğŸ˜”';
        } finally {
            // åœæ­¢åŠ è½½åŠ¨ç”»
            this.stopLoadingAnimation();
        }
    }

    // è·å–éšæœºå“åº”
    getRandomResponse(responses) {
        return responses[Math.floor(Math.random() * responses.length)];
    }

    // åˆ‡æ¢èŠå¤©çª—å£
    toggleChatWindow() {
        if (this.isChatOpen) {
            this.closeChatWindow();
        } else {
            this.openChatWindow();
        }
    }

    // ä»…åˆ‡æ¢èŠå¤©çª—å£çš„æ˜¾ç¤º/éšè—çŠ¶æ€ï¼ˆç”¨äºå¿«æ·é”®ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½ï¼‰
    toggleChatWindowVisibility() {
        if (!this.chatWindow) {
            // å¦‚æœçª—å£è¿˜æœªåˆ›å»ºï¼Œéœ€è¦å…ˆåˆ›å»º
            this.openChatWindow();
            return;
        }
        
        if (this.isChatOpen) {
            // ä»…éšè—çª—å£ï¼Œä¸ä¿å­˜ä¼šè¯ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
            this.chatWindow.style.display = 'none';
            this.isChatOpen = false;
        } else {
            // ä»…æ˜¾ç¤ºçª—å£ï¼Œä¸é‡æ–°åˆå§‹åŒ–ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
            this.chatWindow.style.display = 'block';
            this.isChatOpen = true;
        }
    }

    // é¢„åŠ è½½ html2canvas åº“ï¼ˆç”¨äºå¯¼å‡ºèŠå¤©è®°å½•åŠŸèƒ½ï¼‰
    // æ³¨æ„ï¼šhtml2canvas ç°åœ¨é€šè¿‡ manifest.json çš„ content_scripts è‡ªåŠ¨åŠ è½½
    preloadHtml2Canvas() {
        // html2canvas å·²ç»é€šè¿‡ content_scripts åŠ è½½ï¼Œè¿™ä¸ªæ–¹æ³•ä¿ç•™ç”¨äºå‘åå…¼å®¹
        if (typeof html2canvas !== 'undefined') {
            console.log('html2canvas å·²åŠ è½½');
        } else {
            console.warn('html2canvas æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥æ‰©å±•é…ç½®');
        }
    }

    // æ‰“å¼€èŠå¤©çª—å£
    async openChatWindow() {
        // é¢„åŠ è½½ html2canvas åº“ï¼ˆç”¨äºå¯¼å‡ºåŠŸèƒ½ï¼‰
        this.preloadHtml2Canvas();
        
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€èŠå¤©çª—å£ï¼ŒåŠ è½½ä¼šè¯åˆ—è¡¨å’Œæ–‡ä»¶åˆ—è¡¨
        if (this.isChatWindowFirstOpen) {
            this.isChatWindowFirstOpen = false;
            console.log('ç¬¬ä¸€æ¬¡æ‰“å¼€èŠå¤©çª—å£ï¼ŒåŠ è½½ä¼šè¯åˆ—è¡¨å’Œæ–‡ä»¶åˆ—è¡¨...');
            
            // åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
            if (this.sessionApi && this.sessionApi.isEnabled()) {
                try {
                    await this.loadSessionsFromBackend(true);
                } catch (error) {
                    console.warn('ç¬¬ä¸€æ¬¡æ‰“å¼€èŠå¤©çª—å£æ—¶åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                }
            }
            
            // ä¸å†è‡ªåŠ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼Œæ”¹ä¸ºåœ¨ç¬¬ä¸€æ¬¡åˆ‡æ¢æ–‡ä»¶è§†å›¾æ—¶æ‰è¯·æ±‚
        }
        
        if (this.chatWindow) {
            this.chatWindow.style.display = 'block';
            this.isChatOpen = true;

            // åˆå§‹åŒ–ä¼šè¯
            await this.initSession();

            // é‡æ–°åˆå§‹åŒ–æ»šåŠ¨åŠŸèƒ½
            this.initializeChatScroll();

            // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨æ˜¾ç¤º
            this.updateChatModelSelector();

            // æ›´æ–°èŠå¤©çª—å£é¢œè‰²
            this.updateChatWindowColor();
            
            // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜ï¼ˆæ˜¾ç¤ºå½“å‰ä¼šè¯åç§°ï¼‰
            this.updateChatHeaderTitle();
            
            // ç¡®ä¿ä¼šè¯ä¾§è¾¹æ å·²æ›´æ–°ï¼ˆå¦‚æœä¾§è¾¹æ å·²åˆ›å»ºï¼‰
            if (this.sessionSidebar) {
                await this.loadAllSessions(); // ç¡®ä¿æ•°æ®å·²åŠ è½½
                await this.updateSessionSidebar();
            }
            
            
            return;
        }

        // åˆå§‹åŒ–èŠå¤©çª—å£çŠ¶æ€ï¼ˆå…ˆè®¾ç½®é»˜è®¤å€¼ï¼‰
        const defaultSize = PET_CONFIG.chatWindow.defaultSize;
        const defaultPosition = getChatWindowDefaultPosition(defaultSize.width, defaultSize.height);

        this.chatWindowState = {
            x: defaultPosition.x,
            y: defaultPosition.y,
            width: defaultSize.width,
            height: defaultSize.height,
            isDragging: false,
            isResizing: false,
            resizeType: 'bottom-right', // é»˜è®¤ç¼©æ”¾ç±»å‹
            dragStart: { x: 0, y: 0 },
            resizeStart: { x: 0, y: 0, width: 0, height: 0 },
            isFullscreen: false,
            originalState: null // ä¿å­˜å…¨å±å‰çš„åŸå§‹çŠ¶æ€
        };

        // å°è¯•åŠ è½½ä¿å­˜çš„èŠå¤©çª—å£çŠ¶æ€ï¼ˆä¼šè¦†ç›–é»˜è®¤å€¼ï¼‰
        // åŠ è½½å®Œæˆååˆ›å»ºçª—å£
        this.loadChatWindowState(async (success) => {
            if (success) {
                console.log('èŠå¤©çª—å£çŠ¶æ€å·²åŠ è½½ï¼Œåˆ›å»ºçª—å£');
            } else {
                console.log('ä½¿ç”¨é»˜è®¤èŠå¤©çª—å£çŠ¶æ€ï¼Œåˆ›å»ºçª—å£');
            }

            // åˆå§‹åŒ–ä¼šè¯
            await this.initSession();

            await this.createChatWindow();
            this.isChatOpen = true;
            
            // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜ï¼ˆæ˜¾ç¤ºå½“å‰ä¼šè¯åç§°ï¼‰
            this.updateChatHeaderTitle();
        });
    }

    // å…³é—­èŠå¤©çª—å£
    closeChatWindow() {
        if (this.chatWindow) {
            // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
            this.chatWindow.style.display = 'none';
            this.isChatOpen = false;
        }
    }

    // ä¼šè¯ç®¡ç†æ–¹æ³•
    // è·å–å½“å‰ä¼šè¯IDï¼ˆåŸºäºç½‘é¡µæ ‡é¢˜ï¼‰
    // åŸºäºURLç”Ÿæˆä¼šè¯IDï¼Œç¡®ä¿æ¯ä¸ªURLå¯¹åº”å”¯ä¸€ä¼šè¯
    getCurrentSessionId() {
        const currentUrl = window.location.href;
        // ä½¿ç”¨URLä½œä¸ºä¼šè¯IDçš„åŸºç¡€ï¼Œå¦‚æœURLè¿‡é•¿åˆ™ä½¿ç”¨hash
        // ä¸ºäº†ä¿æŒå‘åå…¼å®¹å’Œå”¯ä¸€æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨generateSessionIdï¼Œä½†åœ¨initSessionä¸­é€šè¿‡URLæŸ¥æ‰¾
        return currentUrl;
    }

    // ç”Ÿæˆå”¯ä¸€ä¼šè¯IDï¼ˆMD5æ ¼å¼ï¼‰
    generateSessionId() {
        // ç¡®ä¿md5å‡½æ•°å¯ç”¨
        const md5Func = typeof md5 !== 'undefined' ? md5 : 
                       (typeof window !== 'undefined' && window.md5) ? window.md5 : null;
        
        if (!md5Func) {
            console.error('MD5å‡½æ•°æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿å·²åŠ è½½md5.js');
            // é™çº§æ–¹æ¡ˆï¼šç”Ÿæˆ32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
            const input = `session_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
            let hash = 0;
            for (let i = 0; i < input.length; i++) {
                const char = input.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            const hex = Math.abs(hash).toString(16).padStart(32, '0');
            return hex.substring(0, 32);
        }
        
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2, 9);
        const input = `session_${timestamp}_${random}`;
        return md5Func(input);
    }

    // æ£€æŸ¥å¹¶ä¿®å¤ä¼šè¯æ•°æ®ä¸€è‡´æ€§
    ensureSessionConsistency(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            return false;
        }

        const session = this.sessions[sessionId];
        const pageInfo = this.getPageInfo();
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç™½ä¼šè¯ï¼ˆä¸åº”è¯¥æ›´æ–°é¡µé¢ä¿¡æ¯ï¼‰
        const isBlankSession = session._isBlankSession || 
                              !session.url || 
                              session.url.startsWith('blank-session://');
        
        if (isBlankSession) {
            console.log(`ç¡®ä¿ä¼šè¯ä¸€è‡´æ€§ ${sessionId}ï¼šç©ºç™½ä¼šè¯ï¼Œè·³è¿‡é¡µé¢ä¿¡æ¯æ›´æ–°`);
            // ç©ºç™½ä¼šè¯åªéœ€è¦ç¡®ä¿åŸºæœ¬ç»“æ„å­˜åœ¨ï¼Œä¸æ›´æ–°é¡µé¢å†…å®¹
            let updated = false;
            if (!Array.isArray(session.messages)) {
                session.messages = [];
                updated = true;
            }
            if (!session.createdAt) {
                session.createdAt = Date.now();
                updated = true;
            }
            if (!session.updatedAt) {
                session.updatedAt = Date.now();
                updated = true;
            }
            return updated;
        }
        
        // å…³é”®æ£€æŸ¥ï¼šåªæœ‰å½“ä¼šè¯URLå’Œå½“å‰é¡µé¢URLåŒ¹é…æ—¶ï¼Œæ‰æ›´æ–°ä¸€è‡´æ€§
        // è¿™æ ·å¯ä»¥é˜²æ­¢ä¿®æ”¹ä¸åŒURLçš„ä¼šè¯æ•°æ®
        if (session.url !== pageInfo.url) {
            console.log(`ç¡®ä¿ä¼šè¯ä¸€è‡´æ€§ ${sessionId}ï¼šURLä¸åŒ¹é…ï¼Œè·³è¿‡æ›´æ–°ã€‚ä¼šè¯URL: ${session.url}, å½“å‰é¡µé¢URL: ${pageInfo.url}`);
            return false; // URLä¸åŒ¹é…ï¼Œä¸æ›´æ–°ï¼Œä¿æŒæ•°æ®éš”ç¦»
        }
        
        let updated = false;

        // ç¡®ä¿URLä¸€è‡´
        if (session.url !== pageInfo.url) {
            console.log(`ä¿®å¤ä¼šè¯ ${sessionId} çš„URLä¸ä¸€è‡´:`, session.url, '->', pageInfo.url);
            session.url = pageInfo.url;
            updated = true;
        }

        // ç¡®ä¿é¡µé¢æ ‡é¢˜ä¸€è‡´
        if (session.pageTitle !== pageInfo.title) {
            console.log(`ä¿®å¤ä¼šè¯ ${sessionId} çš„é¡µé¢æ ‡é¢˜ä¸ä¸€è‡´:`, session.pageTitle, '->', pageInfo.title);
            session.pageTitle = pageInfo.title;
            updated = true;
        }

        // ç¡®ä¿é¡µé¢æè¿°ä¸€è‡´
        const pageDescription = pageInfo.description || '';
        if (session.pageDescription !== pageDescription) {
            console.log(`ä¿®å¤ä¼šè¯ ${sessionId} çš„é¡µé¢æè¿°ä¸ä¸€è‡´`);
            session.pageDescription = pageDescription;
            updated = true;
        }

        // ç¡®ä¿é¡µé¢å†…å®¹å­˜åœ¨ï¼ˆå¦‚æœç¼ºå¤±åˆ™è¡¥å……ï¼‰
        // æ³¨æ„ï¼šç©ºç™½ä¼šè¯ä¸ä¼šè¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼Œå› ä¸ºå‰é¢å·²ç»å¤„ç†äº†
        if (!session.pageContent || session.pageContent.trim() === '') {
            console.log(`è¡¥å……ä¼šè¯ ${sessionId} çš„é¡µé¢å†…å®¹`);
            session.pageContent = pageInfo.content;
            updated = true;
        }

        // ç¡®ä¿messagesæ•°ç»„å­˜åœ¨
        if (!Array.isArray(session.messages)) {
            console.log(`ä¿®å¤ä¼šè¯ ${sessionId} çš„æ¶ˆæ¯æ•°ç»„`);
            session.messages = [];
            updated = true;
        }

        // ç¡®ä¿æ—¶é—´æˆ³å­˜åœ¨
        if (!session.createdAt) {
            session.createdAt = Date.now();
            updated = true;
        }
        if (!session.updatedAt) {
            session.updatedAt = Date.now();
            updated = true;
        }
        
        // ç¡®ä¿æœ€åè®¿é—®æ—¶é—´å­˜åœ¨å¹¶æ›´æ–°ï¼ˆèŠ‚æµï¼šè‡³å°‘é—´éš”1åˆ†é’Ÿï¼‰
        const now = Date.now();
        if (!session.lastAccessTime || (now - session.lastAccessTime) > 60000) {
            session.lastAccessTime = now;
            updated = true;
        }

        return updated;
    }

    // åˆ›å»ºæ ‡å‡†åŒ–çš„ä¼šè¯å¯¹è±¡
    // æ¯ä¸ªä¼šè¯éƒ½ä¼šä¿å­˜ä»¥ä¸‹ä¿¡æ¯ï¼š
    // - ç½‘é¡µæ ‡é¢˜ï¼ˆpageTitleï¼‰ï¼šç”¨äºæ˜¾ç¤ºå’Œè¯†åˆ«
    // - ç½‘é¡µæè¿°ï¼ˆpageDescriptionï¼‰ï¼šmeta description ä¿¡æ¯
    // - ç½‘é¡µç½‘å€ï¼ˆurlï¼‰ï¼šç”¨äºå”¯ä¸€æ ‡è¯†ä¼šè¯ï¼Œä½œä¸ºä¼šè¯IDçš„åŸºç¡€
    // - ç½‘é¡µä¸Šä¸‹æ–‡ï¼ˆpageContentï¼‰ï¼šé¡µé¢çš„å®Œæ•´Markdownå†…å®¹ï¼Œç”¨äºAIç†è§£é¡µé¢ä¸Šä¸‹æ–‡
    // - èŠå¤©è®°å½•ï¼ˆmessagesï¼‰ï¼šè¯¥ä¼šè¯çš„æ‰€æœ‰èŠå¤©æ¶ˆæ¯
    // - æ—¶é—´æˆ³ï¼ˆcreatedAt, updatedAt, lastAccessTimeï¼‰ï¼šç”¨äºæ’åºå’Œç®¡ç†
    createSessionObject(sessionId, pageInfo, existingSession = null) {
        const now = Date.now();
        
        // å¦‚æœæ˜¯å·²æœ‰ä¼šè¯ï¼Œä¿ç•™æ¶ˆæ¯å’Œåˆ›å»ºæ—¶é—´
        const messages = existingSession?.messages || [];
        const createdAt = existingSession?.createdAt || now;
        const lastAccessTime = now; // æ¯æ¬¡åˆ›å»ºæˆ–æ›´æ–°æ—¶éƒ½æ›´æ–°è®¿é—®æ—¶é—´
        
        return {
            id: sessionId, // ä¼šè¯IDï¼ˆåŸºäºURLç”Ÿæˆï¼‰
            url: pageInfo.url, // é¡µé¢URLï¼ˆç”¨äºæŸ¥æ‰¾ä¼šè¯ï¼Œä½œä¸ºä¼šè¯çš„å”¯ä¸€æ ‡è¯†ï¼‰
            pageTitle: pageInfo.title, // é¡µé¢æ ‡é¢˜ï¼ˆä¸é¡µé¢ä¸Šä¸‹æ–‡å¯¹åº”ï¼‰
            pageDescription: pageInfo.description || '', // é¡µé¢æè¿°ï¼ˆmeta descriptionï¼‰
            pageContent: pageInfo.content || '', // é¡µé¢å†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼Œç”¨äºAIç†è§£ä¸Šä¸‹æ–‡ï¼‰
            messages: messages, // èŠå¤©è®°å½•ï¼ˆè¯¥ä¼šè¯çš„æ‰€æœ‰å¯¹è¯ï¼‰
            createdAt: createdAt, // åˆ›å»ºæ—¶é—´
            updatedAt: now, // æ›´æ–°æ—¶é—´
            lastAccessTime: lastAccessTime // æœ€åè®¿é—®æ—¶é—´
        };
    }

    // ==================== ä¼šè¯ç®¡ç†è¾…åŠ©æ–¹æ³• ====================
    
    // æ ¹æ®URLæŸ¥æ‰¾ä¼šè¯
    findSessionByUrl(url) {
        return Object.values(this.sessions).find(session => session.url === url) || null;
    }
    
    // ç”Ÿæˆä¼šè¯IDï¼ˆä½¿ç”¨MD5å“ˆå¸Œï¼Œç¡®ä¿æ‰€æœ‰ä¼šè¯IDéƒ½æ˜¯32ä½MD5æ ¼å¼ï¼‰
    async generateSessionId(url) {
        // ç¡®ä¿md5å‡½æ•°å¯ç”¨
        const md5Func = typeof md5 !== 'undefined' ? md5 : 
                       (typeof window !== 'undefined' && window.md5) ? window.md5 : null;
        
        if (!md5Func) {
            console.error('MD5å‡½æ•°æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿å·²åŠ è½½md5.js');
            // é™çº§æ–¹æ¡ˆï¼šç”Ÿæˆ32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
            if (!url) {
                const input = `session_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                let hash = 0;
                for (let i = 0; i < input.length; i++) {
                    const char = input.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                const hex = Math.abs(hash).toString(16).padStart(32, '0');
                return hex.substring(0, 32);
            }
            const hash = await this.hashString(url);
            return hash;
        }
        
        // å§‹ç»ˆä½¿ç”¨MD5ï¼Œä¸ç®¡URLé•¿åº¦å¦‚ä½•ï¼Œç¡®ä¿æ‰€æœ‰ä¼šè¯IDéƒ½æ˜¯ç»Ÿä¸€çš„32ä½MD5æ ¼å¼
        return md5Func(url);
    }
    
    // æ›´æ–°ä¼šè¯é¡µé¢ä¿¡æ¯ï¼ˆä¿æŒæ¶ˆæ¯ä¸å˜ï¼Œä½†æ›´æ–°æ‰€æœ‰é¡µé¢ä¿¡æ¯ï¼šæ ‡é¢˜ã€æè¿°ã€ç½‘å€ã€ä¸Šä¸‹æ–‡ï¼‰
    // é‡è¦ï¼šåªæœ‰å½“ä¼šè¯URLå’Œé¡µé¢URLåŒ¹é…æ—¶ï¼Œæ‰æ›´æ–°é¡µé¢ä¿¡æ¯ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
    updateSessionPageInfo(sessionId, pageInfo) {
        if (!this.sessions[sessionId]) return false;
        
        const session = this.sessions[sessionId];
        
        // OSSæ–‡ä»¶ä¼šè¯ä¸åº”è¯¥æ›´æ–°URLã€pageTitleã€pageDescriptionå’ŒpageContent
        // è¿™äº›ä¿¡æ¯åº”è¯¥ä¿æŒä¸ºOSSæ–‡ä»¶çš„ä¿¡æ¯
        if (session._isOssFileSession) {
            console.log(`æ›´æ–°ä¼šè¯é¡µé¢ä¿¡æ¯ ${sessionId}ï¼šOSSæ–‡ä»¶ä¼šè¯ï¼Œè·³è¿‡é¡µé¢ä¿¡æ¯æ›´æ–°`);
            // OSSæ–‡ä»¶ä¼šè¯çš„é¡µé¢ä¿¡æ¯ä¸åº”è¯¥è¢«æ›´æ–°ï¼Œåªæ›´æ–°è®¿é—®æ—¶é—´
            const now = Date.now();
            Object.assign(session, {
                updatedAt: now,
                lastAccessTime: now
            });
            return true;
        }
        
        // ç©ºç™½ä¼šè¯ä¸åº”è¯¥æ›´æ–°URLã€pageTitleã€pageDescriptionå’ŒpageContent
        // è¿™äº›ä¿¡æ¯åº”è¯¥ä¿æŒä¸ºåˆ›å»ºæ—¶çš„ä¿¡æ¯
        const isBlankSession = session._isBlankSession || 
                              !session.url || 
                              session.url.startsWith('blank-session://');
        if (isBlankSession) {
            console.log(`æ›´æ–°ä¼šè¯é¡µé¢ä¿¡æ¯ ${sessionId}ï¼šç©ºç™½ä¼šè¯ï¼Œè·³è¿‡é¡µé¢ä¿¡æ¯æ›´æ–°`);
            // ç©ºç™½ä¼šè¯çš„é¡µé¢ä¿¡æ¯ä¸åº”è¯¥è¢«æ›´æ–°ï¼Œåªæ›´æ–°è®¿é—®æ—¶é—´
            const now = Date.now();
            Object.assign(session, {
                updatedAt: now,
                lastAccessTime: now
            });
            return true;
        }
        
        // å…³é”®æ£€æŸ¥ï¼šåªæœ‰å½“ä¼šè¯URLå’Œé¡µé¢URLåŒ¹é…æ—¶ï¼Œæ‰æ›´æ–°é¡µé¢ä¿¡æ¯
        // è¿™æ ·å¯ä»¥é˜²æ­¢æ„å¤–ä¿®æ”¹ä¸åŒURLçš„ä¼šè¯æ•°æ®
        if (session.url !== pageInfo.url) {
            console.log(`æ›´æ–°ä¼šè¯é¡µé¢ä¿¡æ¯ ${sessionId}ï¼šURLä¸åŒ¹é…ï¼Œè·³è¿‡æ›´æ–°ã€‚ä¼šè¯URL: ${session.url}, é¡µé¢URL: ${pageInfo.url}`);
            return false; // URLä¸åŒ¹é…ï¼Œä¸æ›´æ–°ï¼Œä¿æŒæ•°æ®éš”ç¦»
        }
        
        const sessionData = this.createSessionObject(sessionId, pageInfo, session);
        const now = Date.now();
        
        // æ›´æ–°æ‰€æœ‰é¡µé¢ç›¸å…³ä¿¡æ¯ï¼Œä¿ç•™æ¶ˆæ¯å’Œå…¶ä»–ä¼šè¯æ•°æ®
        Object.assign(session, {
            url: sessionData.url,
            pageTitle: sessionData.pageTitle,
            pageDescription: sessionData.pageDescription || '',
            pageContent: sessionData.pageContent || session.pageContent || '', // ä¿ç•™å·²æœ‰å†…å®¹ï¼Œä½†å¦‚æœç¼ºå¤±åˆ™è¡¥å……
            updatedAt: sessionData.updatedAt,
            lastAccessTime: now // æ›´æ–°æœ€åè®¿é—®æ—¶é—´
        });
        
        return true;
    }
    
    // ç»Ÿä¸€æ›´æ–°UIï¼ˆä¾§è¾¹æ ã€æ ‡é¢˜ç­‰ï¼‰
    async updateSessionUI(options = {}) {
        const { 
            updateSidebar = true, 
            updateTitle = true, 
            loadMessages = false,
            highlightSessionId = null,
            keepOssFileListView = false, // æ˜¯å¦ä¿æŒOSSæ–‡ä»¶åˆ—è¡¨è§†å›¾ï¼ˆä¸åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨ï¼‰
            keepNewsListView = false, // æ˜¯å¦ä¿æŒæ–°é—»åˆ—è¡¨è§†å›¾ï¼ˆä¸åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨ï¼‰
            keepApiRequestListView = false // æ˜¯å¦ä¿æŒè¯·æ±‚æ¥å£åˆ—è¡¨è§†å›¾ï¼ˆä¸åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨ï¼‰
        } = options;
        
        if (updateSidebar && this.sessionSidebar) {
            // å¦‚æœæŒ‡å®šä¿æŒOSSæ–‡ä»¶åˆ—è¡¨è§†å›¾ã€æ–°é—»åˆ—è¡¨è§†å›¾æˆ–è¯·æ±‚æ¥å£åˆ—è¡¨è§†å›¾ï¼Œåˆ™ä¸æ›´æ–°ä¾§è¾¹æ ï¼ˆé¿å…åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨ï¼‰
            if (!keepOssFileListView && !keepNewsListView && !keepApiRequestListView) {
                await this.updateSessionSidebar();
            } else if (keepOssFileListView) {
                // å¦‚æœä¿æŒOSSæ–‡ä»¶åˆ—è¡¨è§†å›¾ï¼Œåªæ›´æ–°OSSæ–‡ä»¶åˆ—è¡¨çš„activeçŠ¶æ€
                await this.updateOssFileSidebar(false);
            } else if (keepNewsListView) {
                // å¦‚æœä¿æŒæ–°é—»åˆ—è¡¨è§†å›¾ï¼Œåªæ›´æ–°æ–°é—»åˆ—è¡¨çš„activeçŠ¶æ€
                await this.updateNewsSidebar(false);
            } else if (keepApiRequestListView) {
                // å¦‚æœä¿æŒè¯·æ±‚æ¥å£åˆ—è¡¨è§†å›¾ï¼Œåªæ›´æ–°è¯·æ±‚æ¥å£åˆ—è¡¨çš„activeçŠ¶æ€
                await this.updateApiRequestSidebar(false);
            }
        }
        
        if (updateTitle) {
            this.updateChatHeaderTitle();
        }
        
        if (loadMessages && this.chatWindow && this.isChatOpen) {
            await this.loadSessionMessages();
            
            // é«˜äº®æ˜¾ç¤ºæ–°ä¼šè¯
            if (highlightSessionId) {
                setTimeout(() => {
                    const sessionItem = this.sessionSidebar?.querySelector(`[data-session-id="${highlightSessionId}"]`);
                    if (sessionItem) {
                        sessionItem.classList.add('new-session-highlight');
                        setTimeout(() => {
                            sessionItem.classList.remove('new-session-highlight');
                        }, 1500);
                    }
                }, 100);
            }
        }
    }
    
    // åˆ›å»ºç©ºç™½æ–°ä¼šè¯ï¼ˆæ‰‹åŠ¨æ·»åŠ ï¼‰
    async createBlankSession() {
        // ç¡®ä¿å·²åŠ è½½æ‰€æœ‰ä¼šè¯
        await this.loadAllSessions();
        
        // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ä¼šè¯IDï¼ˆä¸åŸºäºURLï¼Œä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ï¼‰
        const uniqueId = `blank_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        const sessionId = await this.generateSessionId(uniqueId);
        
        // æ£€æŸ¥ä¼šè¯IDæ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™é‡æ–°ç”Ÿæˆ
        let finalSessionId = sessionId;
        let attempts = 0;
        while (this.sessions[finalSessionId] && attempts < 10) {
            const newUniqueId = `blank_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
            finalSessionId = await this.generateSessionId(newUniqueId);
            attempts++;
        }
        
        // ç”Ÿæˆå”¯ä¸€çš„ç©ºç™½ä¼šè¯URLï¼ˆç¡®ä¿ä¸ä¼šé‡å¤ï¼‰
        // ä½¿ç”¨è‡ªå®šä¹‰åè®®æ ¼å¼ï¼šblank-session://{timestamp}-{random}
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substring(2, 11); // 9ä½éšæœºå­—ç¬¦ä¸²
        const uniqueUrl = `blank-session://${timestamp}-${randomStr}`;
        
        // ç¡®ä¿URLå”¯ä¸€ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒURLçš„ä¼šè¯
        let finalUrl = uniqueUrl;
        let urlAttempts = 0;
        while (Object.values(this.sessions).some(s => s && s.url === finalUrl) && urlAttempts < 10) {
            const newTimestamp = Date.now();
            const newRandomStr = Math.random().toString(36).substring(2, 11);
            finalUrl = `blank-session://${newTimestamp}-${newRandomStr}`;
            urlAttempts++;
        }
        
        // åˆ›å»ºç©ºç™½ä¼šè¯å¯¹è±¡ï¼ˆåŒ…å«å½“å‰é¡µé¢ä¿¡æ¯ä»¥ä¾¿ä¿ç•™ä¸Šä¸‹æ–‡ï¼‰
        const now = Date.now();
        // è·å–å½“å‰é¡µé¢ä¿¡æ¯ï¼Œç”¨äºä¿ç•™é¡µé¢ä¸Šä¸‹æ–‡
        const pageInfo = this.getPageInfo();
        const blankSession = {
            id: finalSessionId,
            url: finalUrl, // ç©ºç™½ä¼šè¯ä½¿ç”¨å”¯ä¸€çš„éšæœºURLï¼ˆä¸ä¼šä¸åŸºäºURLçš„ä¼šè¯å†²çªï¼‰
            pageTitle: pageInfo.title || 'æ–°ä¼šè¯', // ä½¿ç”¨å½“å‰é¡µé¢æ ‡é¢˜
            pageDescription: pageInfo.description || '', // ä½¿ç”¨å½“å‰é¡µé¢æè¿°
            pageContent: pageInfo.content || '', // ä¿å­˜å½“å‰é¡µé¢å†…å®¹ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨
            messages: [], // ç©ºçš„å¯¹è¯åˆ—è¡¨
            createdAt: now,
            updatedAt: now,
            lastAccessTime: now,
            _isBlankSession: true, // æ ‡è®°ä¸ºç©ºç™½ä¼šè¯ï¼Œç”¨äºåç»­å¤„ç†
            _originalUrl: finalUrl // ä¿å­˜åŸå§‹URLï¼Œé˜²æ­¢è¢«æ„å¤–æ›´æ–°
        };
        
        // ä¿å­˜æ–°ä¼šè¯åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä»…å†…å­˜ï¼Œä¸è‡ªåŠ¨ä¿å­˜ï¼‰
        this.sessions[finalSessionId] = blankSession;
        // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
        
        console.log('å·²åˆ›å»ºç©ºç™½æ–°ä¼šè¯:', finalSessionId);
        
        // æ³¨æ„ï¼šå·²ç§»é™¤åˆ›å»ºç©ºç™½ä¼šè¯åçš„è‡ªåŠ¨åŒæ­¥ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
        
        // æ¿€æ´»æ–°åˆ›å»ºçš„ä¼šè¯ï¼ˆè·³è¿‡ä»åç«¯è·å–æ•°æ®ï¼Œå› ä¸ºè¿™æ˜¯æ–°åˆ›å»ºçš„ç©ºç™½ä¼šè¯ï¼‰
        await this.activateSession(finalSessionId, {
            saveCurrent: true, // ä¿å­˜å½“å‰ä¼šè¯
            updateConsistency: false, // ç©ºç™½ä¼šè¯ä¸éœ€è¦æ›´æ–°é¡µé¢ä¸€è‡´æ€§
            updateUI: true, // æ›´æ–°UI
            syncToBackend: false, // å·²ç«‹å³åŒæ­¥ï¼Œä¸å†é‡å¤åŒæ­¥
            skipBackendFetch: true // è·³è¿‡ä»åç«¯è·å–æ•°æ®ï¼ˆé¿å…404ï¼‰
        });
        
        // æ›´æ–°èŠå¤©çª—å£ï¼ˆå¦‚æœå·²æ‰“å¼€ï¼‰
        if (this.isChatOpen && this.chatWindow) {
            // æ¸…ç©ºæ¶ˆæ¯å®¹å™¨å¹¶æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
                const welcomeMessage = await this.createWelcomeMessage(messagesContainer);
            }
            
            // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜
            this.updateChatHeaderTitle();
            
        }
        
        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
        this.showNotification('å·²åˆ›å»ºæ–°ä¼šè¯', 'success');
        
        return finalSessionId;
    }
    
    // åˆ‡æ¢åˆ°ä¼šè¯ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
    // é‡è¦ï¼šç¡®ä¿æ•°æ®éš”ç¦»ï¼Œåˆ‡æ¢åˆ°ä¸åŒURLçš„ä¼šè¯æ—¶ï¼Œä¸ä¼šæ›´æ–°è¯¥ä¼šè¯çš„é¡µé¢ä¿¡æ¯
    async activateSession(sessionId, options = {}) {
        const { 
            saveCurrent = true,
            updateConsistency = true,
            updateUI = true,
            syncToBackend = true,
            skipBackendFetch = false, // æ˜¯å¦è·³è¿‡ä»åç«¯è·å–æ•°æ®ï¼ˆç”¨äºæ–°åˆ›å»ºçš„ç©ºç™½ä¼šè¯ï¼‰
            keepOssFileListView = false, // æ˜¯å¦ä¿æŒOSSæ–‡ä»¶åˆ—è¡¨è§†å›¾ï¼ˆä¸åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨ï¼‰
            keepNewsListView = false, // æ˜¯å¦ä¿æŒæ–°é—»åˆ—è¡¨è§†å›¾ï¼ˆä¸åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨ï¼‰
            keepApiRequestListView = false // æ˜¯å¦ä¿æŒè¯·æ±‚æ¥å£åˆ—è¡¨è§†å›¾ï¼ˆä¸åˆ‡æ¢åˆ°ä¼šè¯åˆ—è¡¨ï¼‰
        } = options;
        
        // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
        // åˆ‡æ¢ä¼šè¯æ—¶ä¸å†è‡ªåŠ¨ä¿å­˜
        
        // åˆ‡æ¢åˆ°ç›®æ ‡ä¼šè¯
        const targetSession = this.sessions[sessionId];
        if (!targetSession) {
            console.error('ç›®æ ‡ä¼šè¯ä¸å­˜åœ¨:', sessionId);
            return;
        }
        
        this.currentSessionId = sessionId;
        this.currentPageUrl = targetSession.url || null;
        
        // æ£€æŸ¥å½“å‰é¡µé¢URLå’Œç›®æ ‡ä¼šè¯URLæ˜¯å¦åŒ¹é…
        const pageInfo = this.getPageInfo();
        const isUrlMatched = targetSession.url === pageInfo.url;
        
        // åªæœ‰å½“URLåŒ¹é…æ—¶ï¼Œæ‰æ ‡è®°ä¸ºå½“å‰é¡µé¢çš„ä¼šè¯
        // å¦‚æœURLä¸åŒ¹é…ï¼ˆä¾‹å¦‚ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢çš„ä¼šè¯ï¼‰ï¼Œä¸æ ‡è®°ä¸ºè‡ªåŠ¨åˆ›å»º
        this.hasAutoCreatedSessionForPage = isUrlMatched;
        
        // å½“ä¼šè¯é«˜äº®æ—¶ï¼Œè°ƒç”¨ getSession è·å–å®Œæ•´æ•°æ®
        // è·³è¿‡æƒ…å†µï¼š1. æ˜ç¡®æŒ‡å®šè·³è¿‡ï¼›2. æ–°åˆ›å»ºçš„ä¼šè¯ï¼ˆåˆ›å»ºæ—¶é—´å¾ˆè¿‘ï¼Œ5ç§’å†…ï¼‰
        // æ³¨æ„ï¼šå³ä½¿æ˜¯ç©ºç™½ä¼šè¯ï¼Œå¦‚æœå·²ç»åŒæ­¥åˆ°åç«¯ï¼Œä¹Ÿåº”è¯¥å°è¯•è·å–æœ€æ–°æ•°æ®
        const isBlankSession = !targetSession.url || 
                              targetSession.url.startsWith('blank-session://') || 
                              targetSession._isBlankSession;
        const isNewSession = targetSession.createdAt && (Date.now() - targetSession.createdAt) < 5000; // 5ç§’å†…åˆ›å»ºçš„ä¼šè¯è§†ä¸ºæ–°ä¼šè¯
        
        // å³ä½¿åˆ¤å®šä¸ºç©ºç™½ä¼šè¯ï¼Œä¹Ÿåº”è¯¥å°è¯•ä»åç«¯è·å–æ•°æ®ï¼ˆé™¤éæ˜ç¡®æŒ‡å®šè·³è¿‡æˆ–æ–°åˆ›å»ºï¼‰
        // è¿™æ ·å·²åŒæ­¥åˆ°åç«¯çš„ç©ºç™½ä¼šè¯ä¹Ÿèƒ½è·å–æœ€æ–°æ•°æ®
        // åªæœ‰åœ¨èŠå¤©çª—å£å·²ç»æ‰“å¼€è¿‡çš„æƒ…å†µä¸‹æ‰è°ƒç”¨åç«¯æ¥å£ï¼Œé¿å…é¡µé¢åˆ·æ–°æ—¶è‡ªåŠ¨è°ƒç”¨
        if (!skipBackendFetch && !isNewSession && this.sessionApi && this.sessionApi.isEnabled() && !this.isChatWindowFirstOpen) {
            try {
                console.log('ä¼šè¯é«˜äº®ï¼Œæ­£åœ¨ä»åç«¯è·å–å®Œæ•´æ•°æ®:', sessionId);
                const fullSession = await this.sessionApi.getSession(sessionId, true); // å¼ºåˆ¶åˆ·æ–°
                
                if (fullSession) {
                    // æ›´æ–°æœ¬åœ°ä¼šè¯æ•°æ®
                    const existingSession = this.sessions[sessionId];
                    if (existingSession) {
                        // åˆå¹¶å®Œæ•´æ•°æ®
                        if (fullSession.messages && Array.isArray(fullSession.messages)) {
                            existingSession.messages = fullSession.messages;
                        }
                        if (fullSession.pageDescription) {
                            existingSession.pageDescription = fullSession.pageDescription;
                        }
                        if (fullSession.pageContent) {
                            existingSession.pageContent = fullSession.pageContent;
                        }
                        if (fullSession.pageTitle || fullSession.title) {
                            existingSession.pageTitle = fullSession.pageTitle || fullSession.title || '';
                        }
                        existingSession.updatedAt = fullSession.updatedAt || existingSession.updatedAt;
                        existingSession.createdAt = fullSession.createdAt || existingSession.createdAt;
                        existingSession.lastAccessTime = fullSession.lastAccessTime || existingSession.lastAccessTime;
                        
                        // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œæ¢å¤OSSæ–‡ä»¶ä¿¡æ¯
                        if (fullSession._isOssFileSession && fullSession._ossFileInfo) {
                            existingSession._isOssFileSession = true;
                            existingSession._ossFileInfo = fullSession._ossFileInfo;
                        }
                    } else {
                        // å¦‚æœæœ¬åœ°ä¸å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨åç«¯æ•°æ®ï¼ˆåŒ…æ‹¬OSSæ–‡ä»¶ä¿¡æ¯ï¼‰
                        this.sessions[sessionId] = fullSession;
                    }
                    
                    // ä¿å­˜æ›´æ–°åçš„ä¼šè¯æ•°æ®åˆ°æœ¬åœ°
                    await this.saveAllSessions(false, false); // ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸åŒæ­¥åˆ°åç«¯ï¼ˆå› ä¸ºåˆšåŒæ­¥è¿‡ï¼‰
                }
            } catch (error) {
                // ä¼˜é›…å¤„ç†404é”™è¯¯å’Œå…¶ä»–é”™è¯¯
                const is404 = error.message && (
                    error.message.includes('404') || 
                    error.message.includes('Not Found') ||
                    error.status === 404 ||
                    error.response?.status === 404
                );
                
                if (is404) {
                    // 404é”™è¯¯æ˜¯æ­£å¸¸çš„ï¼ˆä¼šè¯å¯èƒ½è¿˜æœªåŒæ­¥åˆ°åç«¯ï¼‰ï¼Œé™é»˜å¤„ç†
                    console.log('ä¼šè¯åœ¨åç«¯ä¸å­˜åœ¨ï¼ˆå¯èƒ½è¿˜æœªåŒæ­¥ï¼‰ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', sessionId);
                } else {
                    // å…¶ä»–é”™è¯¯æ‰è­¦å‘Š
                    console.warn('ä»åç«¯è·å–ä¼šè¯å®Œæ•´æ•°æ®å¤±è´¥:', error.message);
                }
                // ç»§ç»­ä½¿ç”¨æœ¬åœ°æ•°æ®
            }
        } else if (skipBackendFetch || isNewSession) {
            if (skipBackendFetch) {
                console.log('è·³è¿‡ä»åç«¯è·å–æ•°æ®ï¼ˆæ˜ç¡®æŒ‡å®šè·³è¿‡ï¼‰:', sessionId);
            } else if (isNewSession) {
                console.log('è·³è¿‡ä»åç«¯è·å–æ•°æ®ï¼ˆæ–°åˆ›å»ºçš„ä¼šè¯ï¼‰:', sessionId);
            }
        }
        
        // æ›´æ–°ä¼šè¯ä¸€è‡´æ€§ï¼ˆåªæœ‰åœ¨URLåŒ¹é…æ—¶æ‰æ›´æ–°ï¼Œç¡®ä¿æ•°æ®éš”ç¦»ï¼‰
        if (updateConsistency && isUrlMatched) {
            // åªæœ‰å½“ç›®æ ‡ä¼šè¯çš„URLå’Œå½“å‰é¡µé¢URLåŒ¹é…æ—¶ï¼Œæ‰æ›´æ–°ä¸€è‡´æ€§
            // è¿™æ ·å¯ä»¥é˜²æ­¢åˆ‡æ¢åˆ°ä¸åŒURLçš„ä¼šè¯æ—¶ï¼Œæ„å¤–ä¿®æ”¹é‚£ä¸ªä¼šè¯çš„é¡µé¢ä¿¡æ¯
            const needsUpdate = this.ensureSessionConsistency(sessionId);
            if (needsUpdate) {
                // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
            }
        } else if (!isUrlMatched) {
            // URLä¸åŒ¹é…æ—¶ï¼Œåªæ›´æ–°æœ€åè®¿é—®æ—¶é—´ï¼Œä¸æ›´æ–°é¡µé¢ä¿¡æ¯ï¼ˆä¿æŒæ•°æ®éš”ç¦»ï¼‰
            console.log(`åˆ‡æ¢åˆ°ä¼šè¯ ${sessionId}ï¼šURLä¸åŒ¹é…ï¼Œä¸æ›´æ–°é¡µé¢ä¿¡æ¯ã€‚ä¼šè¯URL: ${targetSession.url}, å½“å‰é¡µé¢URL: ${pageInfo.url}`);
            const now = Date.now();
            if (!targetSession.lastAccessTime || (now - targetSession.lastAccessTime) > 60000) {
                targetSession.lastAccessTime = now;
                // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
            }
        }
        
        // æ›´æ–°UI
        if (updateUI) {
            await this.updateSessionUI({
                updateSidebar: true,
                updateTitle: true,
                loadMessages: this.isChatOpen,
                keepOssFileListView: keepOssFileListView, // ä¼ é€’ä¿æŒOSSæ–‡ä»¶åˆ—è¡¨è§†å›¾çš„é€‰é¡¹
                keepNewsListView: keepNewsListView, // ä¼ é€’ä¿æŒæ–°é—»åˆ—è¡¨è§†å›¾çš„é€‰é¡¹
                keepApiRequestListView: keepApiRequestListView // ä¼ é€’ä¿æŒè¯·æ±‚æ¥å£åˆ—è¡¨è§†å›¾çš„é€‰é¡¹
            });
        }
    }
    
    // è¾…åŠ©æ–¹æ³•ï¼šç”Ÿæˆå­—ç¬¦ä¸²çš„MD5 hashå€¼ï¼ˆ32ä½åå…­è¿›åˆ¶ï¼‰
    async hashString(str) {
        // ç¡®ä¿md5å‡½æ•°å¯ç”¨
        const md5Func = typeof md5 !== 'undefined' ? md5 : 
                       (typeof window !== 'undefined' && window.md5) ? window.md5 : null;
        
        if (!md5Func) {
            console.error('MD5å‡½æ•°æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿å·²åŠ è½½md5.js');
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨SHA-256å¹¶è¿”å›32ä½
            if (window.crypto && window.crypto.subtle) {
                try {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(str);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    // è¿”å›32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
                    return hashHex.substring(0, 32);
                } catch (error) {
                    console.warn('ä½¿ç”¨ SHA-256 ç”Ÿæˆhashå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:', error);
                }
            }
            // å¤‡ç”¨æ–¹æ³•ï¼šç®€å•å“ˆå¸Œ
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            const hex = Math.abs(hash).toString(16).padStart(32, '0');
            return hex.substring(0, 32);
        }
        
        // ä½¿ç”¨MD5ï¼Œè¿”å›32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
        return md5Func(str);
    }

    // åˆå§‹åŒ–æˆ–æ¢å¤ä¼šè¯ - åŸºäºURLåˆ›å»ºå”¯ä¸€ä¼šè¯ï¼Œç¡®ä¿æ¯ä¸ªä¼šè¯ä¸é¡µé¢ä¸Šä¸‹æ–‡ä¸€ä¸€å¯¹åº”
    async initSession() {
        const pageInfo = this.getPageInfo();
        const currentUrl = pageInfo.url;
        const isSamePage = this.currentPageUrl === currentUrl;
        
        // åŠ è½½æ‰€æœ‰ä¼šè¯æ•°æ®
        await this.loadAllSessions();
        
        // å¤„ç†åŒä¸€é¡µé¢çš„æƒ…å†µï¼šå¦‚æœå·²é€‰ä¸­ä¼šè¯ï¼Œåªæ›´æ–°ä¸€è‡´æ€§
        if (isSamePage && this.hasAutoCreatedSessionForPage && this.currentSessionId) {
            if (this.sessions[this.currentSessionId]) {
                const needsUpdate = this.ensureSessionConsistency(this.currentSessionId);
                if (needsUpdate) {
                    // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
                    await this.updateSessionUI({ updateTitle: true });
                } else {
                    // æ›´æ–°è®¿é—®æ—¶é—´ï¼ˆèŠ‚æµï¼‰
                    const session = this.sessions[this.currentSessionId];
                    const now = Date.now();
                    if (!session.lastAccessTime || (now - session.lastAccessTime) > 60000) {
                        session.lastAccessTime = now;
                    }
                }
                await this.updateSessionUI({ updateSidebar: true });
            }
            return this.currentSessionId;
        }
        
        // å¤„ç†æ–°é¡µé¢çš„æƒ…å†µ
        if (!isSamePage) {
            this.currentPageUrl = currentUrl;
            this.hasAutoCreatedSessionForPage = false;
        }
        
        // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
        
        // é¦–å…ˆæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨URLåŒ¹é…çš„ä¼šè¯ï¼ˆéå†æ‰€æœ‰ä¼šè¯ï¼‰
        let matchedSessionId = null;
        for (const [sessionId, session] of Object.entries(this.sessions)) {
            if (session && session.url === currentUrl) {
                matchedSessionId = sessionId;
                break;
            }
        }
        
        // å¦‚æœæ‰¾åˆ°äº†åŒ¹é…çš„ä¼šè¯ï¼Œç›´æ¥é€‰ä¸­
        if (matchedSessionId) {
            const existingSession = this.sessions[matchedSessionId];
            if (existingSession) {
                // æ›´æ–°ä¼šè¯é¡µé¢ä¿¡æ¯
                this.updateSessionPageInfo(matchedSessionId, pageInfo);
                // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
                
                // è‡ªåŠ¨é€‰ä¸­åŒ¹é…çš„ä¼šè¯
                await this.activateSession(matchedSessionId, {
                    saveCurrent: false, // å·²ç»åœ¨å‰é¢ä¿å­˜äº†
                    updateConsistency: true,
                    updateUI: true
                });
                
                console.log('æ‰¾åˆ°URLåŒ¹é…çš„ä¼šè¯ï¼Œå·²è‡ªåŠ¨é€‰ä¸­:', matchedSessionId);
                return matchedSessionId;
            }
        }
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°URLåŒ¹é…çš„ä¼šè¯ï¼Œä½¿ç”¨URLç”Ÿæˆä¼šè¯ID
        const sessionId = await this.generateSessionId(currentUrl);
        
        // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¯¥ä¼šè¯IDçš„ä¼šè¯
        let existingSession = this.sessions[sessionId];
        
        if (existingSession) {
            // æ›´æ–°ä¼šè¯é¡µé¢ä¿¡æ¯
            this.updateSessionPageInfo(sessionId, pageInfo);
            // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
            
            // è‡ªåŠ¨é€‰ä¸­åŒ¹é…çš„ä¼šè¯
            await this.activateSession(sessionId, {
                saveCurrent: false, // å·²ç»åœ¨å‰é¢ä¿å­˜äº†
                updateConsistency: true,
                updateUI: true
            });
            
            console.log('æ‰¾åˆ°åŸºäºURLçš„å·²æœ‰ä¼šè¯ï¼Œå·²è‡ªåŠ¨é€‰ä¸­:', sessionId);
            return sessionId;
        } else {
            // æ²¡æœ‰æ‰¾åˆ°ä¼šè¯ï¼Œä½¿ç”¨URLä½œä¸ºä¼šè¯IDè‡ªåŠ¨åˆ›å»ºæ–°ä¼šè¯
            const newSession = this.createSessionObject(sessionId, pageInfo);
            this.sessions[sessionId] = newSession;
            // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
            
            // è‡ªåŠ¨æ¿€æ´»æ–°åˆ›å»ºçš„ä¼šè¯
            await this.activateSession(sessionId, {
                saveCurrent: false, // å·²ç»åœ¨å‰é¢ä¿å­˜äº†
                updateConsistency: true,
                updateUI: true
            });
            
            console.log('ä½¿ç”¨URLä½œä¸ºä¼šè¯IDï¼Œå·²è‡ªåŠ¨åˆ›å»ºæ–°ä¼šè¯:', sessionId, 'URL:', currentUrl);
            
            return sessionId;
        }
    }

    // è®¾ç½®é¡µé¢æ ‡é¢˜å˜åŒ–ç›‘å¬ï¼ˆå¸¦é˜²æŠ–ä¼˜åŒ–ï¼‰
    setupTitleChangeListener() {
        let titleUpdateTimer = null;
        let lastTitle = document.title;
        
        // é˜²æŠ–çš„ä¼šè¯æ›´æ–°å‡½æ•°
        const debouncedUpdateSession = () => {
            if (titleUpdateTimer) {
                clearTimeout(titleUpdateTimer);
            }
            titleUpdateTimer = setTimeout(() => {
                this.initSession();
            }, this.SESSION_UPDATE_DEBOUNCE);
        };
        
        // ä½¿ç”¨ MutationObserver ç›‘å¬æ ‡é¢˜å˜åŒ–
        const titleObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    const currentTitle = document.title;
                    // åªæœ‰æ ‡é¢˜çœŸçš„å˜åŒ–äº†æ‰è§¦å‘æ›´æ–°
                    if (currentTitle !== lastTitle) {
                        lastTitle = currentTitle;
                        debouncedUpdateSession();
                    }
                }
            });
        });

        // è§‚å¯Ÿ title å…ƒç´ çš„å˜åŒ–
        const titleElement = document.querySelector('title');
        if (titleElement) {
            titleObserver.observe(titleElement, {
                childList: true,
                characterData: true,
                subtree: true
            });
        }

        // ä¹Ÿç›‘å¬ document.title çš„ç›´æ¥å˜åŒ–ï¼ˆæŸäº›åŠ¨æ€é¡µé¢ä¼šç›´æ¥ä¿®æ”¹ï¼‰
        // ä½¿ç”¨æ›´é•¿çš„æ£€æŸ¥é—´éš”ï¼Œå‡å°‘ä¸å¿…è¦çš„æ£€æŸ¥
        setInterval(() => {
            const currentTitle = document.title;
            if (currentTitle !== lastTitle) {
                lastTitle = currentTitle;
                debouncedUpdateSession();
            }
        }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡æ ‡é¢˜å˜åŒ–ï¼ˆé™ä½é¢‘ç‡ï¼‰
    }

    // è®¾ç½®URLå˜åŒ–ç›‘å¬ï¼Œç”¨äºå•é¡µåº”ç”¨ï¼ˆSPAï¼‰çš„è·¯ç”±å˜åŒ–ï¼ˆå¸¦é˜²æŠ–ä¼˜åŒ–ï¼‰
    setupUrlChangeListener() {
        let lastUrl = window.location.href;
        let urlUpdateTimer = null;
        const self = this;
        
        // é˜²æŠ–çš„ä¼šè¯æ›´æ–°å‡½æ•°
        const debouncedUpdateSession = (reason = '') => {
            if (urlUpdateTimer) {
                clearTimeout(urlUpdateTimer);
            }
            urlUpdateTimer = setTimeout(() => {
                self.initSession();
            }, self.SESSION_UPDATE_DEBOUNCE);
        };
        
        // ç›‘å¬popstateäº‹ä»¶ï¼ˆæµè§ˆå™¨å‰è¿›/åé€€ï¼‰
        window.addEventListener('popstate', () => {
            const currentUrl = window.location.href;
            if (currentUrl !== lastUrl) {
                console.log('æ£€æµ‹åˆ°URLå˜åŒ–ï¼ˆpopstateï¼‰:', lastUrl, '->', currentUrl);
                lastUrl = currentUrl;
                debouncedUpdateSession('popstate');
            }
        });
        
        // ç›‘å¬pushStateå’ŒreplaceStateï¼ˆå•é¡µåº”ç”¨è·¯ç”±å˜åŒ–ï¼‰
        const originalPushState = history.pushState;
        const originalReplaceState = history.replaceState;
        
        history.pushState = function(...args) {
            originalPushState.apply(history, args);
            const currentUrl = window.location.href;
            if (currentUrl !== lastUrl) {
                console.log('æ£€æµ‹åˆ°URLå˜åŒ–ï¼ˆpushStateï¼‰:', lastUrl, '->', currentUrl);
                lastUrl = currentUrl;
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å·²æ›´æ–°ï¼Œå¹¶ä½¿ç”¨é˜²æŠ–
                setTimeout(() => {
                    debouncedUpdateSession('pushState');
                }, 100);
            }
        };
        
        history.replaceState = function(...args) {
            originalReplaceState.apply(history, args);
            const currentUrl = window.location.href;
            if (currentUrl !== lastUrl) {
                console.log('æ£€æµ‹åˆ°URLå˜åŒ–ï¼ˆreplaceStateï¼‰:', lastUrl, '->', currentUrl);
                lastUrl = currentUrl;
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å·²æ›´æ–°ï¼Œå¹¶ä½¿ç”¨é˜²æŠ–
                setTimeout(() => {
                    debouncedUpdateSession('replaceState');
                }, 100);
            }
        };
        
        // å®šæœŸæ£€æŸ¥URLå˜åŒ–ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼Œé˜²æ­¢æŸäº›è¾¹ç¼˜æƒ…å†µï¼‰
        // é™ä½æ£€æŸ¥é¢‘ç‡ï¼Œå‡å°‘æ€§èƒ½å¼€é”€
        setInterval(() => {
            const currentUrl = window.location.href;
            if (currentUrl !== lastUrl) {
                console.log('æ£€æµ‹åˆ°URLå˜åŒ–ï¼ˆå®šæœŸæ£€æŸ¥ï¼‰:', lastUrl, '->', currentUrl);
                lastUrl = currentUrl;
                debouncedUpdateSession('periodic');
            }
        }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆé™ä½é¢‘ç‡ï¼‰
    }

    // æ³¨æ„ï¼šå·²ç§»é™¤ setupSessionSyncListener() æ–¹æ³•ï¼Œå¤šé¡µé¢ä¹‹é—´çš„ä¼šè¯äº’ç›¸ç‹¬ç«‹

    /**
     * æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦å·²å­˜åœ¨äºåç«¯ä¼šè¯åˆ—è¡¨ä¸­
     * @param {string} sessionId - ä¼šè¯IDï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰ä¼šè¯IDï¼‰
     * @returns {Promise<boolean>} å¦‚æœä¼šè¯å·²å­˜åœ¨äºåç«¯åˆ—è¡¨ä¸­è¿”å›trueï¼Œå¦åˆ™è¿”å›false
     */
    async isSessionInBackendList(sessionId = null) {
        const targetSessionId = sessionId || this.currentSessionId;
        if (!targetSessionId) {
            return false;
        }

        // å¦‚æœåç«¯åˆ—è¡¨è¿˜æ²¡æœ‰åŠ è½½ï¼Œä¸”èŠå¤©çª—å£å·²ç»æ‰“å¼€è¿‡ï¼ˆä¸æ˜¯é¡µé¢åˆ·æ–°æ—¶ï¼‰ï¼Œæ‰å°è¯•åŠ è½½
        // é¿å…åœ¨é¡µé¢åˆ·æ–°æ—¶è‡ªåŠ¨è°ƒç”¨åç«¯æ¥å£
        if (this.backendSessionIds.size === 0 && this.sessionApi && !this.isChatWindowFirstOpen) {
            try {
                // å°è¯•ä»åç«¯è·å–æœ€æ–°çš„ä¼šè¯åˆ—è¡¨
                const backendSessions = await this.sessionApi.getSessionsList({ forceRefresh: false });
                
                // æ£€æŸ¥å½“å‰é¡µé¢URLæ˜¯å¦åœ¨ä¼šè¯åˆ—è¡¨ä¸­ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨è¯¦æƒ…æ¥å£
                const currentPageUrl = window.location.href;
                for (const backendSession of backendSessions) {
                    if (backendSession.url === currentPageUrl) {
                        const sessionId = backendSession.id || backendSession.conversation_id;
                        if (sessionId) {
                            console.log('å½“å‰é¡µé¢URLåœ¨ä¼šè¯åˆ—è¡¨ä¸­ï¼Œæ­£åœ¨åŠ è½½ä¼šè¯è¯¦æƒ…:', sessionId);
                            try {
                                const sessionDetail = await this.sessionApi.getSession(sessionId, true);
                                if (sessionDetail) {
                                    console.log('ä¼šè¯è¯¦æƒ…åŠ è½½æˆåŠŸ:', sessionId);
                                    // æ›´æ–°æœ¬åœ°ä¼šè¯æ•°æ®
                                    if (this.sessions && this.sessions[sessionId]) {
                                        this.sessions[sessionId] = {
                                            ...this.sessions[sessionId],
                                            ...sessionDetail,
                                            id: sessionId
                                        };
                                    }
                                }
                            } catch (error) {
                                console.warn('åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥:', error);
                            }
                        }
                        break; // æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯åé€€å‡ºå¾ªç¯
                    }
                }
                
                this.backendSessionIds.clear();
                backendSessions.forEach(backendSession => {
                    const id = backendSession.id || backendSession.conversation_id;
                    if (id) {
                        this.backendSessionIds.add(id);
                    }
                });
            } catch (error) {
                console.warn('è·å–åç«¯ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›falseï¼Œæ˜¾ç¤ºä¿å­˜æŒ‰é’®
                return false;
            }
        }

        // æ£€æŸ¥ä¼šè¯IDæ˜¯å¦åœ¨åç«¯åˆ—è¡¨ä¸­
        return this.backendSessionIds.has(targetSessionId);
    }

    // ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆä½¿ç”¨APIç®¡ç†å™¨ï¼‰
    async loadSessionsFromBackend(forceRefresh = false) {
        try {
            // ä½¿ç”¨æ–°çš„APIç®¡ç†å™¨
            if (this.sessionApi) {
                // åªåœ¨å¼ºåˆ¶åˆ·æ–°æ—¶è°ƒç”¨ getSessionsListï¼Œä¸å†åœ¨é¡µé¢é¦–æ¬¡åŠ è½½æ—¶è‡ªåŠ¨è°ƒç”¨
                // æ”¹ä¸ºåœ¨ç¬¬ä¸€æ¬¡æ‰“å¼€èŠå¤©çª—å£æ—¶è°ƒç”¨
                if (!forceRefresh) {
                    console.log('è·³è¿‡ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆç­‰å¾…æ‰“å¼€èŠå¤©çª—å£æ—¶å†åŠ è½½ï¼‰');
                    return;
                }
                
                console.log('ä½¿ç”¨APIç®¡ç†å™¨åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰...');
                const backendSessions = await this.sessionApi.getSessionsList({ forceRefresh });
                
                // æ£€æŸ¥å½“å‰é¡µé¢URLæ˜¯å¦åœ¨ä¼šè¯åˆ—è¡¨ä¸­ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨è¯¦æƒ…æ¥å£
                const currentPageUrl = window.location.href;
                for (const backendSession of backendSessions) {
                    if (backendSession.url === currentPageUrl) {
                        const sessionId = backendSession.id || backendSession.conversation_id;
                        if (sessionId) {
                            console.log('å½“å‰é¡µé¢URLåœ¨ä¼šè¯åˆ—è¡¨ä¸­ï¼Œæ­£åœ¨åŠ è½½ä¼šè¯è¯¦æƒ…:', sessionId);
                            try {
                                const sessionDetail = await this.sessionApi.getSession(sessionId, true);
                                if (sessionDetail) {
                                    console.log('ä¼šè¯è¯¦æƒ…åŠ è½½æˆåŠŸ:', sessionId);
                                    // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†è¯¦æƒ…æ•°æ®ï¼Œæ¯”å¦‚æ›´æ–°æœ¬åœ°ä¼šè¯
                                    if (this.sessions && this.sessions[sessionId]) {
                                        // æ›´æ–°æœ¬åœ°ä¼šè¯æ•°æ®
                                        this.sessions[sessionId] = {
                                            ...this.sessions[sessionId],
                                            ...sessionDetail,
                                            id: sessionId
                                        };
                                    }
                                }
                            } catch (error) {
                                console.warn('åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥:', error);
                            }
                        }
                        break; // æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯åé€€å‡ºå¾ªç¯
                    }
                }
                
                // æ›´æ–°åç«¯ä¼šè¯IDé›†åˆ
                this.backendSessionIds.clear();
                backendSessions.forEach(backendSession => {
                    const sessionId = backendSession.id || backendSession.conversation_id;
                    if (sessionId) {
                        this.backendSessionIds.add(sessionId);
                    }
                });
                
                // åˆå¹¶åç«¯æ•°æ®åˆ°æœ¬åœ° sessions
                if (!this.sessions) {
                    this.sessions = {};
                }
                
                // å¤„ç†æ¯ä¸ªåç«¯ä¼šè¯æ•°æ®
                const backendSessionsMap = {};
                
                backendSessions.forEach(backendSession => {
                    const sessionId = backendSession.id || backendSession.conversation_id;
                    if (!sessionId) return;
                    
                    // è·³è¿‡OSSæ–‡ä»¶ä¼šè¯ï¼Œä¸åœ¨ä¼šè¯åˆ—è¡¨ä¸­æ˜¾ç¤º
                    if (backendSession._isOssFileSession) {
                        return;
                    }
                    
                    const sessionUrl = backendSession.url || '';
                    const isBlankSession = sessionUrl.startsWith('blank-session://') || backendSession._isBlankSession;
                    const localSession = {
                        id: sessionId,
                        url: sessionUrl,
                        pageTitle: backendSession.pageTitle || backendSession.title || '',
                        pageDescription: backendSession.pageDescription || '',
                        pageContent: backendSession.pageContent || '',
                        messages: backendSession.messages || [],
                        tags: backendSession.tags || [],
                        createdAt: backendSession.createdAt || Date.now(),
                        updatedAt: backendSession.updatedAt || Date.now(),
                        lastAccessTime: backendSession.lastAccessTime || Date.now()
                    };
                    
                    // å¦‚æœæ˜¯ç©ºç™½ä¼šè¯ï¼Œä¿å­˜åŸå§‹URLå’Œæ ‡è®°
                    if (isBlankSession) {
                        localSession._isBlankSession = true;
                        localSession._originalUrl = sessionUrl; // ä¿å­˜åŸå§‹URLï¼Œé˜²æ­¢è¢«æ„å¤–æ›´æ–°
                    }
                    
                    backendSessionsMap[sessionId] = localSession;
                });
                
                // åˆå¹¶ç­–ç•¥
                for (const [sessionId, backendSession] of Object.entries(backendSessionsMap)) {
                    const localSession = this.sessions[sessionId];
                    
                    // å¦‚æœæœ¬åœ°ä¼šè¯æ˜¯OSSæ–‡ä»¶ä¼šè¯ä¸”ä¸æ˜¯å½“å‰ä¼šè¯ï¼Œè·³è¿‡åˆå¹¶ï¼ˆä¸åœ¨ä¼šè¯åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼‰
                    if (localSession && localSession._isOssFileSession && localSession.id !== this.currentSessionId) {
                        // åˆ é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„OSSæ–‡ä»¶ä¼šè¯ï¼ˆé™¤éæ˜¯å½“å‰ä¼šè¯ï¼‰
                        delete this.sessions[sessionId];
                        continue;
                    }
                    
                    if (!localSession) {
                        this.sessions[sessionId] = backendSession;
                    } else {
                        const localUpdatedAt = localSession.updatedAt || 0;
                        const backendUpdatedAt = backendSession.updatedAt || 0;
                        const localMessages = localSession.messages || [];
                        const backendMessages = backendSession.messages || [];
                        
                        let finalMessages = localMessages;
                        if (backendMessages.length > 0) {
                            if (backendUpdatedAt >= localUpdatedAt && backendMessages.length >= localMessages.length) {
                                finalMessages = backendMessages;
                            } else if (localMessages.length === 0 && backendMessages.length > 0) {
                                finalMessages = backendMessages;
                            }
                        }
                        
                        // åˆå¹¶ tagsï¼šå¦‚æœåç«¯æ›´æ–°ï¼Œä½¿ç”¨åç«¯çš„ tagsï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä¿ç•™æœ¬åœ°çš„
                        let finalTags = localSession.tags || [];
                        if (backendUpdatedAt >= localUpdatedAt && backendSession.tags && Array.isArray(backendSession.tags)) {
                            finalTags = backendSession.tags;
                        }
                        
                        if (backendUpdatedAt >= localUpdatedAt) {
                            this.sessions[sessionId] = {
                                ...backendSession,
                                messages: finalMessages,
                                tags: finalTags,
                                // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ pageTitleï¼ˆå¦‚æœæœ¬åœ°æœ‰å†…å®¹ï¼‰
                                pageTitle: (localSession.pageTitle && localSession.pageTitle.trim() !== '')
                                    ? localSession.pageTitle
                                    : (backendSession.pageTitle || backendSession.title || ''),
                                pageDescription: localSession.pageDescription || backendSession.pageDescription,
                                // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ pageContentï¼ˆå¦‚æœæœ¬åœ°æœ‰å†…å®¹ï¼‰ï¼Œé¿å…é¡µé¢ä¸Šä¸‹æ–‡ä¸¢å¤±
                                pageContent: (localSession.pageContent && localSession.pageContent.trim() !== '')
                                    ? localSession.pageContent
                                    : (backendSession.pageContent || ''),
                                // ä¿ç•™OSSæ–‡ä»¶ä¼šè¯ä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨åç«¯çš„ï¼Œå¦‚æœåç«¯æ²¡æœ‰åˆ™ä½¿ç”¨æœ¬åœ°çš„ï¼‰
                                _isOssFileSession: backendSession._isOssFileSession || localSession._isOssFileSession || false,
                                _ossFileInfo: backendSession._ossFileInfo || localSession._ossFileInfo || null
                            };
                        } else {
                            this.sessions[sessionId] = {
                                ...localSession,
                                url: backendSession.url || localSession.url,
                                pageTitle: localSession.pageTitle || backendSession.pageTitle || backendSession.title || '',
                                pageDescription: localSession.pageDescription || backendSession.pageDescription,
                                pageContent: localSession.pageContent || backendSession.pageContent,
                                messages: localMessages,
                                tags: finalTags,
                                // ä¿ç•™OSSæ–‡ä»¶ä¼šè¯ä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨æœ¬åœ°çš„ï¼Œå¦‚æœæœ¬åœ°æ²¡æœ‰åˆ™ä½¿ç”¨åç«¯çš„ï¼‰
                                _isOssFileSession: localSession._isOssFileSession || backendSession._isOssFileSession || false,
                                _ossFileInfo: localSession._ossFileInfo || backendSession._ossFileInfo || null
                            };
                        }
                    }
                }
                
                // å»é‡ï¼ŒåŒæ—¶è¿‡æ»¤æ‰OSSæ–‡ä»¶ä¼šè¯ï¼ˆé™¤éæ˜¯å½“å‰ä¼šè¯ï¼‰
                const deduplicatedSessions = {};
                for (const [sessionId, session] of Object.entries(this.sessions)) {
                    if (!session || !session.id) continue;
                    
                    // è·³è¿‡OSSæ–‡ä»¶ä¼šè¯ï¼ˆé™¤éæ˜¯å½“å‰ä¼šè¯ï¼‰
                    if (session._isOssFileSession && session.id !== this.currentSessionId) {
                        continue;
                    }
                    
                    const id = session.id;
                    if (!deduplicatedSessions[id]) {
                        deduplicatedSessions[id] = session;
                    } else {
                        const existingUpdatedAt = deduplicatedSessions[id].updatedAt || 0;
                        const currentUpdatedAt = session.updatedAt || 0;
                        if (currentUpdatedAt > existingUpdatedAt) {
                            deduplicatedSessions[id] = session;
                        }
                    }
                }
                this.sessions = {};
                for (const session of Object.values(deduplicatedSessions)) {
                    if (session && session.id) {
                        this.sessions[session.id] = session;
                    }
                }
                
                // ä»åç«¯åŠ è½½æ•°æ®åï¼Œåªä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸è§¦å‘åç«¯åŒæ­¥ï¼ˆé¿å…ä¸å¿…è¦çš„ session/save è°ƒç”¨ï¼‰
                await this.saveAllSessions(true, false);
                console.log('ä¼šè¯åˆ—è¡¨å·²ä»åç«¯åŒæ­¥ï¼ˆAPIç®¡ç†å™¨ï¼‰ï¼Œå½“å‰ä¼šè¯æ•°é‡:', Object.keys(this.sessions).length);
                return;
            }
            
            // å¦‚æœæ²¡æœ‰APIç®¡ç†å™¨ï¼Œä½¿ç”¨æ—§æ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰
            if (!PET_CONFIG.api.syncSessionsToBackend) {
                console.log('ä¼šè¯åŒæ­¥æœªå¯ç”¨ï¼Œè·³è¿‡ä»åç«¯åŠ è½½');
                return;
            }
            
            const baseUrl = PET_CONFIG.api.yiaiBaseUrl;
            if (!baseUrl) {
                console.warn('YiAiåç«¯åœ°å€æœªé…ç½®ï¼Œè·³è¿‡ä»åç«¯åŠ è½½');
                return;
            }
            
            // åªåœ¨é¡µé¢é¦–æ¬¡åŠ è½½/åˆ·æ–°æ—¶è°ƒç”¨ï¼Œæˆ–è€…å¼ºåˆ¶åˆ·æ–°æ—¶
            const shouldLoadFromBackend = forceRefresh || this.isPageFirstLoad;
            
            if (!shouldLoadFromBackend) {
                console.log('è·³è¿‡ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆéé¡µé¢åˆ·æ–°ï¼‰');
                return;
            }
            
            // æ ‡è®°é¡µé¢å·²åŠ è½½
            this.isPageFirstLoad = false;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆé¿å…é¢‘ç¹è°ƒç”¨ï¼‰
            const now = Date.now();
            if (!forceRefresh && (now - this.lastSessionListLoadTime) < this.SESSION_LIST_RELOAD_INTERVAL) {
                return;
            }
            
            console.log('å¼€å§‹ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆé¡µé¢åˆ·æ–°ï¼‰...');
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            this._showLoadingAnimation();
            
            // è°ƒç”¨åç«¯APIè·å–ä¼šè¯åˆ—è¡¨
            let response, result;
            try {
                response = await fetch(`${baseUrl}/session/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.warn(`ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥: HTTP ${response.status}: ${errorText}`);
                    // éšè—åŠ è½½åŠ¨ç”»
                    this._hideLoadingAnimation();
                    return;
                }
                
                result = await response.json();
                
                // éšè—åŠ è½½åŠ¨ç”»
                this._hideLoadingAnimation();
            } catch (error) {
                // éšè—åŠ è½½åŠ¨ç”»
                this._hideLoadingAnimation();
                console.warn('ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                return;
            }
            this.lastSessionListLoadTime = now;
            
            if (result.success && result.sessions && Array.isArray(result.sessions)) {
                console.log(`ä»åç«¯åŠ è½½åˆ° ${result.sessions.length} ä¸ªä¼šè¯`);
                
                // æ›´æ–°åç«¯ä¼šè¯IDé›†åˆ
                this.backendSessionIds.clear();
                result.sessions.forEach(backendSession => {
                    const sessionId = backendSession.id || backendSession.conversation_id;
                    if (sessionId) {
                        this.backendSessionIds.add(sessionId);
                    }
                });
                
                // å°†åç«¯è¿”å›çš„ä¼šè¯æ•°æ®åˆå¹¶åˆ°æœ¬åœ° sessions å¯¹è±¡
                // å¦‚æœåç«¯æ•°æ®æ›´æ–°ï¼ˆupdatedAt æ›´æ™šï¼‰ï¼Œåˆ™ä½¿ç”¨åç«¯æ•°æ®
                // å¦åˆ™ä¿ç•™æœ¬åœ°æ•°æ®ï¼ˆå¯èƒ½åŒ…å«æœªåŒæ­¥çš„æœ€æ–°æ¶ˆæ¯ï¼‰
                const backendSessions = {};
                const sessionsToFetch = []; // éœ€è¦è·å–å®Œæ•´æ•°æ®çš„ä¼šè¯IDåˆ—è¡¨
                
                result.sessions.forEach(backendSession => {
                    const sessionId = backendSession.id || backendSession.conversation_id;
                    if (!sessionId) return;
                    
                    // è·³è¿‡OSSæ–‡ä»¶ä¼šè¯ï¼Œä¸åœ¨ä¼šè¯åˆ—è¡¨ä¸­æ˜¾ç¤º
                    if (backendSession._isOssFileSession) {
                        return;
                    }
                    
                    // å°†åç«¯ä¼šè¯æ•°æ®è½¬æ¢ä¸ºæœ¬åœ°æ ¼å¼
                    // æ³¨æ„ï¼šåç«¯åˆ—è¡¨APIä¸è¿”å›messageså­—æ®µï¼Œéœ€è¦å•ç‹¬è·å–
                    const sessionUrl = backendSession.url || '';
                    const isBlankSession = sessionUrl.startsWith('blank-session://') || backendSession._isBlankSession;
                    const localSession = {
                        id: sessionId,
                        url: sessionUrl,
                        pageTitle: backendSession.pageTitle || backendSession.title || '',
                        pageDescription: backendSession.pageDescription || '',
                        pageContent: backendSession.pageContent || '',
                        messages: backendSession.messages || [], // åç«¯åˆ—è¡¨APIé€šå¸¸ä¸åŒ…å«messages
                        tags: backendSession.tags || [],
                        createdAt: backendSession.createdAt || backendSession.created_time || Date.now(),
                        updatedAt: backendSession.updatedAt || backendSession.updated_time || Date.now(),
                        lastAccessTime: backendSession.lastAccessTime || backendSession.last_access_time || Date.now()
                    };
                    
                    // å¦‚æœæ˜¯ç©ºç™½ä¼šè¯ï¼Œä¿å­˜åŸå§‹URLå’Œæ ‡è®°
                    if (isBlankSession) {
                        localSession._isBlankSession = true;
                        localSession._originalUrl = sessionUrl; // ä¿å­˜åŸå§‹URLï¼Œé˜²æ­¢è¢«æ„å¤–æ›´æ–°
                    }
                    
                    // å¦‚æœåç«¯ä¼šè¯æ²¡æœ‰æ¶ˆæ¯ï¼Œä½†åç«¯æœ‰message_countä¸”å¤§äº0ï¼Œéœ€è¦è·å–å®Œæ•´æ•°æ®
                    const messageCount = backendSession.message_count || 0;
                    if (!localSession.messages || localSession.messages.length === 0) {
                        if (messageCount > 0) {
                            sessionsToFetch.push(sessionId);
                        }
                    }
                    
                    backendSessions[sessionId] = localSession;
                });
            
                // å¯¹äºæ²¡æœ‰æ¶ˆæ¯çš„ä¼šè¯ï¼Œå°è¯•ä»åç«¯è·å–å®Œæ•´æ•°æ®
                if (sessionsToFetch.length > 0) {
                    console.log(`å‘ç° ${sessionsToFetch.length} ä¸ªéœ€è¦è·å–å®Œæ•´æ•°æ®çš„ä¼šè¯`);
                    await Promise.all(sessionsToFetch.map(async (sessionId) => {
                        try {
                            const sessionResponse = await fetch(`${baseUrl}/session/${sessionId}`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (sessionResponse.ok) {
                                const sessionResult = await sessionResponse.json();
                                if (sessionResult.success && sessionResult.data) {
                                    const fullSession = sessionResult.data;
                                    // æ›´æ–°åç«¯ä¼šè¯æ•°æ®ï¼ŒåŒ…å«å®Œæ•´çš„messages
                                    if (fullSession.messages && Array.isArray(fullSession.messages)) {
                                        backendSessions[sessionId].messages = fullSession.messages;
                                        // åŒæ—¶æ›´æ–°å…¶ä»–å¯èƒ½ç¼ºå¤±çš„å­—æ®µ
                                        if (fullSession.pageDescription) {
                                            backendSessions[sessionId].pageDescription = fullSession.pageDescription;
                                        }
                                        if (fullSession.pageContent) {
                                            backendSessions[sessionId].pageContent = fullSession.pageContent;
                                        }
                                        if (fullSession.tags && Array.isArray(fullSession.tags)) {
                                            backendSessions[sessionId].tags = fullSession.tags;
                                        }
                                    }
                                    console.log(`å·²è·å–ä¼šè¯ ${sessionId} çš„å®Œæ•´æ•°æ®ï¼ŒåŒ…å« ${fullSession.messages?.length || 0} æ¡æ¶ˆæ¯`);
                                }
                            }
                        } catch (error) {
                            console.warn(`è·å–ä¼šè¯ ${sessionId} çš„å®Œæ•´æ•°æ®å¤±è´¥:`, error.message);
                        }
                    }));
                }
                
                // åˆå¹¶åç«¯æ•°æ®åˆ°æœ¬åœ° sessions
                // åˆå§‹åŒ– sessions å¯¹è±¡å¦‚æœä¸å­˜åœ¨
                if (!this.sessions) {
                    this.sessions = {};
                }
                
                // åˆå¹¶ç­–ç•¥ï¼šå¦‚æœæœ¬åœ°æ²¡æœ‰è¯¥ä¼šè¯ï¼Œç›´æ¥ä½¿ç”¨åç«¯æ•°æ®
                // å¦‚æœæœ¬åœ°æœ‰è¯¥ä¼šè¯ï¼Œæ¯”è¾ƒ updatedAtï¼Œä½¿ç”¨æ›´æ–°çš„ä¸€æ–¹
                // å…³é”®ï¼šå§‹ç»ˆä¿ç•™æœ¬åœ°çš„æ¶ˆæ¯ï¼Œé™¤éåç«¯æœ‰æ›´å¤šæ¶ˆæ¯
                for (const [sessionId, backendSession] of Object.entries(backendSessions)) {
                    const localSession = this.sessions[sessionId];
                    
                    // å¦‚æœæœ¬åœ°ä¼šè¯æ˜¯OSSæ–‡ä»¶ä¼šè¯ä¸”ä¸æ˜¯å½“å‰ä¼šè¯ï¼Œè·³è¿‡åˆå¹¶ï¼ˆä¸åœ¨ä¼šè¯åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼‰
                    if (localSession && localSession._isOssFileSession && localSession.id !== this.currentSessionId) {
                        // åˆ é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„OSSæ–‡ä»¶ä¼šè¯ï¼ˆé™¤éæ˜¯å½“å‰ä¼šè¯ï¼‰
                        delete this.sessions[sessionId];
                        continue;
                    }
                    
                    if (!localSession) {
                        // æœ¬åœ°æ²¡æœ‰ï¼Œç›´æ¥ä½¿ç”¨åç«¯æ•°æ®ï¼ˆå·²åŒ…å«å®Œæ•´çš„messagesï¼‰
                        this.sessions[sessionId] = backendSession;
                    } else {
                        // æœ¬åœ°æœ‰ï¼Œæ¯”è¾ƒæ›´æ–°æ—¶é—´
                        const localUpdatedAt = localSession.updatedAt || 0;
                        const backendUpdatedAt = backendSession.updatedAt || 0;
                        
                        const localMessages = localSession.messages || [];
                        const backendMessages = backendSession.messages || [];
                        
                        // å…³é”®ä¿®å¤ï¼šå§‹ç»ˆä¼˜å…ˆä¿ç•™æœ¬åœ°æ¶ˆæ¯ï¼Œé™¤éåç«¯æ¶ˆæ¯æ›´å¤šæˆ–æ›´æ–°æ—¶é—´æ›´æ™š
                        let finalMessages = localMessages;
                        if (backendMessages.length > 0) {
                            if (backendUpdatedAt >= localUpdatedAt && backendMessages.length >= localMessages.length) {
                                // åç«¯æ›´æ–°ä¸”æ¶ˆæ¯æ›´å¤šï¼Œä½¿ç”¨åç«¯æ¶ˆæ¯
                                finalMessages = backendMessages;
                            } else if (localMessages.length === 0 && backendMessages.length > 0) {
                                // æœ¬åœ°æ²¡æœ‰æ¶ˆæ¯ä½†åç«¯æœ‰ï¼Œä½¿ç”¨åç«¯æ¶ˆæ¯
                                finalMessages = backendMessages;
                            }
                            // å¦åˆ™ä¿ç•™æœ¬åœ°æ¶ˆæ¯ï¼ˆä¸è¦†ç›–ï¼‰
                        }
                        
                        // åˆå¹¶ tagsï¼šå¦‚æœåç«¯æ›´æ–°ï¼Œä½¿ç”¨åç«¯çš„ tagsï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä¿ç•™æœ¬åœ°çš„
                        let finalTags = localSession.tags || [];
                        if (backendUpdatedAt >= localUpdatedAt && backendSession.tags && Array.isArray(backendSession.tags)) {
                            finalTags = backendSession.tags;
                        }
                        
                        if (backendUpdatedAt >= localUpdatedAt) {
                            // åç«¯æ•°æ®æ›´æ–°ï¼Œä½¿ç”¨åç«¯æ•°æ®ï¼Œä½†ä¿ç•™æœ¬åœ°æ¶ˆæ¯ï¼ˆå¦‚æœæœ¬åœ°æ¶ˆæ¯æ›´å¤šæˆ–æ›´æ–°ï¼‰
                            this.sessions[sessionId] = {
                                ...backendSession,
                                messages: finalMessages, // ä½¿ç”¨åˆå¹¶åçš„æ¶ˆæ¯
                                tags: finalTags,
                                // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ pageTitleï¼ˆå¦‚æœæœ¬åœ°æœ‰å†…å®¹ï¼‰
                                pageTitle: (localSession.pageTitle && localSession.pageTitle.trim() !== '')
                                    ? localSession.pageTitle
                                    : (backendSession.pageTitle || backendSession.title || ''),
                                pageDescription: localSession.pageDescription || backendSession.pageDescription,
                                // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ pageContentï¼ˆå¦‚æœæœ¬åœ°æœ‰å†…å®¹ï¼‰ï¼Œé¿å…é¡µé¢ä¸Šä¸‹æ–‡ä¸¢å¤±
                                pageContent: (localSession.pageContent && localSession.pageContent.trim() !== '')
                                    ? localSession.pageContent
                                    : (backendSession.pageContent || '')
                            };
                        } else {
                            // æœ¬åœ°æ›´æ–°ï¼Œä¿ç•™æœ¬åœ°æ•°æ®ï¼Œä½†æ›´æ–°å…¶ä»–å­—æ®µï¼ˆå¦‚æœåç«¯æœ‰æ›´æ–°çš„å…ƒæ•°æ®ï¼‰
                            this.sessions[sessionId] = {
                                ...localSession,
                                // æ›´æ–°å…ƒæ•°æ®å­—æ®µï¼ˆå¦‚æœåç«¯æœ‰æ›´æ–°çš„å€¼ï¼‰
                                url: backendSession.url || localSession.url,
                                pageTitle: localSession.pageTitle || backendSession.pageTitle || backendSession.title || '',
                                pageDescription: localSession.pageDescription || backendSession.pageDescription,
                                pageContent: localSession.pageContent || backendSession.pageContent,
                                // æ¶ˆæ¯å§‹ç»ˆä½¿ç”¨æœ¬åœ°çš„ï¼ˆå› ä¸ºæœ¬åœ°æ›´æ–°ï¼‰
                                messages: localMessages,
                                tags: finalTags
                            };
                        }
                    }
                }
                
                // å»é‡ï¼šç¡®ä¿ this.sessions ä¸­æ¯ä¸ª id åªæœ‰ä¸€ä¸ªä¼šè¯ï¼ˆä¿ç•™ updatedAt æœ€æ–°çš„ï¼‰
                const deduplicatedSessions = {};
                for (const [sessionId, session] of Object.entries(this.sessions)) {
                    if (!session || !session.id) continue;
                    
                    const id = session.id;
                    if (!deduplicatedSessions[id]) {
                        deduplicatedSessions[id] = session;
                    } else {
                        // å¦‚æœå·²å­˜åœ¨ï¼Œæ¯”è¾ƒ updatedAtï¼Œä¿ç•™æ›´æ–°çš„
                        const existingUpdatedAt = deduplicatedSessions[id].updatedAt || 0;
                        const currentUpdatedAt = session.updatedAt || 0;
                        if (currentUpdatedAt > existingUpdatedAt) {
                            deduplicatedSessions[id] = session;
                        }
                    }
                }
                // å°†å»é‡åçš„ä¼šè¯é‡æ–°æ˜ å°„å› sessionIdï¼ˆä½¿ç”¨ä¼šè¯çš„ id ä½œä¸º keyï¼‰
                this.sessions = {};
                for (const session of Object.values(deduplicatedSessions)) {
                    if (session && session.id) {
                        this.sessions[session.id] = session;
                    }
                }
                
                // ä¿å­˜åˆå¹¶åçš„ä¼šè¯æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¸è§¦å‘åç«¯åŒæ­¥ï¼ˆé¿å…ä¸å¿…è¦çš„ session/save è°ƒç”¨ï¼‰
                await this.saveAllSessions(true, false);
                
                console.log('ä¼šè¯åˆ—è¡¨å·²ä»åç«¯åŒæ­¥ï¼ˆæ—§æ–¹å¼ï¼‰ï¼Œå½“å‰ä¼šè¯æ•°é‡ï¼ˆå»é‡åï¼‰:', Object.keys(this.sessions).length);
                } else {
                    console.warn('ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯:', result);
                }
        } catch (error) {
            // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸é˜»å¡ä¸»æµç¨‹
            console.warn('ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨æ—¶å‡ºé”™:', error.message);
        }
    }

    // åŠ è½½æ‰€æœ‰ä¼šè¯ï¼ˆä»åç«¯åŠ è½½ï¼‰
    async loadAllSessions() {
        // ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨
        await this.loadSessionsFromBackend();
        
        // å¦‚æœåç«¯æ²¡æœ‰åŠ è½½åˆ°ä¼šè¯ï¼Œåˆå§‹åŒ–ç©ºå¯¹è±¡
        if (!this.sessions) {
            this.sessions = {};
        }
    }

    // ä¿å­˜æ‰€æœ‰ä¼šè¯ï¼ˆå¸¦èŠ‚æµä¼˜åŒ–ï¼‰
    async saveAllSessions(force = false, syncToBackend = true) {
        const now = Date.now();
        
        // å¦‚æœä¸åœ¨å¼ºåˆ¶æ¨¡å¼ä¸‹ï¼Œä¸”è·ç¦»ä¸Šæ¬¡ä¿å­˜æ—¶é—´å¤ªçŸ­ï¼Œåˆ™å»¶è¿Ÿä¿å­˜
        if (!force && (now - this.lastSessionSaveTime) < this.SESSION_SAVE_THROTTLE) {
            // æ ‡è®°æœ‰å¾…å¤„ç†çš„æ›´æ–°
            this.pendingSessionUpdate = true;
            
            // å¦‚æœå·²æœ‰å®šæ—¶å™¨åœ¨ç­‰å¾…ï¼Œæ¸…é™¤å®ƒ
            if (this.sessionUpdateTimer) {
                clearTimeout(this.sessionUpdateTimer);
            }
            
            // å»¶è¿Ÿä¿å­˜
            return new Promise((resolve) => {
                this.sessionUpdateTimer = setTimeout(async () => {
                    this.pendingSessionUpdate = false;
                    await this._doSaveAllSessions(syncToBackend);
                    resolve();
                }, this.SESSION_SAVE_THROTTLE - (now - this.lastSessionSaveTime));
            });
        }
        
        // ç«‹å³ä¿å­˜
        this.pendingSessionUpdate = false;
        if (this.sessionUpdateTimer) {
            clearTimeout(this.sessionUpdateTimer);
            this.sessionUpdateTimer = null;
        }
        return await this._doSaveAllSessions(syncToBackend);
    }
    
    // å®é™…æ‰§è¡Œä¿å­˜æ“ä½œ
    async _doSaveAllSessions(syncToBackend = true) {
        this.lastSessionSaveTime = Date.now();
        
        // å¼‚æ­¥åŒæ­¥åˆ°åç«¯ï¼ˆä½¿ç”¨é˜Ÿåˆ—æ‰¹é‡ä¿å­˜ï¼Œä¸é˜»å¡ä¿å­˜æµç¨‹ï¼‰
        // åªæœ‰åœ¨å…è®¸åŒæ­¥ä¸”å¯ç”¨åç«¯åŒæ­¥æ—¶ï¼Œæ‰åŒæ­¥åˆ°åç«¯
        if (syncToBackend && PET_CONFIG.api.syncSessionsToBackend && this.currentSessionId) {
            // ä½¿ç”¨é˜Ÿåˆ—æ‰¹é‡ä¿å­˜ï¼Œæé«˜æ€§èƒ½
            this.syncSessionToBackend(this.currentSessionId, false).catch(err => {
                console.warn('åŒæ­¥ä¼šè¯åˆ°åç«¯å¤±è´¥:', err);
            });
        }
    }
    
    // åŒæ­¥ä¼šè¯åˆ°YiAiåç«¯ï¼ˆä½¿ç”¨APIç®¡ç†å™¨ï¼Œæ”¯æŒæ‰¹é‡ä¿å­˜ï¼‰
    /**
     * å°† base64 å›¾ç‰‡ä¸Šä¼ åˆ° OSS å¹¶è¿”å› URL
     * @param {string} base64Data - base64 å›¾ç‰‡æ•°æ®ï¼ˆå¯ä»¥æ˜¯ data:image/png;base64,xxx æ ¼å¼æˆ–çº¯ base64 å­—ç¬¦ä¸²ï¼‰
     * @returns {Promise<string|null>} è¿”å› OSS URLï¼Œå¦‚æœä¸Šä¼ å¤±è´¥åˆ™è¿”å› null
     */
    async uploadBase64ImageToOss(base64Data) {
        if (!base64Data || typeof base64Data !== 'string') {
            return null;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ data:image æ ¼å¼
        const dataImageMatch = base64Data.match(/^data:image\/([^;]+);base64,(.+)$/);
        if (!dataImageMatch) {
            // å¦‚æœä¸æ˜¯ data:image æ ¼å¼ï¼Œå°è¯•ä½œä¸ºçº¯ base64 å¤„ç†
            if (!base64Data.match(/^[A-Za-z0-9+/=]+$/)) {
                console.warn('æ— æ•ˆçš„ base64 å›¾ç‰‡æ•°æ®');
                return null;
            }
        }
        
        try {
            // æå– MIME ç±»å‹å’Œ base64 æ•°æ®
            let mimeType = 'image/png';
            let base64String = base64Data;
            
            if (dataImageMatch) {
                mimeType = `image/${dataImageMatch[1]}`;
                base64String = dataImageMatch[2];
            }
            
            // å°† base64 å­—ç¬¦ä¸²è§£ç ä¸ºäºŒè¿›åˆ¶æ•°æ®
            const binaryString = atob(base64String);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            // æ ¹æ® MIME ç±»å‹ç¡®å®šæ–‡ä»¶æ‰©å±•å
            const extensionMap = {
                'image/png': 'png',
                'image/jpeg': 'jpg',
                'image/jpg': 'jpg',
                'image/gif': 'gif',
                'image/webp': 'webp',
                'image/svg+xml': 'svg'
            };
            const extension = extensionMap[mimeType] || 'png';
            
            // åˆ›å»º Blob å¯¹è±¡
            const blob = new Blob([bytes], { type: mimeType });
            
            // ç”Ÿæˆæ–‡ä»¶åï¼ˆä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ï¼‰
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 9);
            const fileName = `${timestamp}_${random}.${extension}`;
            
            // å°† Blob è½¬æ¢ä¸º File å¯¹è±¡
            const file = new File([blob], fileName, { type: mimeType });
            
            // æ£€æŸ¥ OSS API æ˜¯å¦å¯ç”¨
            if (!this.ossApi || !this.ossApi.isEnabled()) {
                console.warn('OSS API æœªå¯ç”¨ï¼Œæ— æ³•ä¸Šä¼ å›¾ç‰‡');
                return null;
            }
            
            // ä¸Šä¼ åˆ° OSSï¼ˆä½¿ç”¨ chat-images ç›®å½•ï¼‰
            const result = await this.ossApi.uploadFile(file, 'chat-images');
            
            if (result && result.code === 200 && result.data) {
                // æ£€æŸ¥è¿”å›çš„æ•°æ®ç»“æ„ï¼Œå¯èƒ½åŒ…å« url æˆ– object_name
                let ossUrl = result.data.url;
                if (!ossUrl && result.data.object_name) {
                    // å¦‚æœæ²¡æœ‰ç›´æ¥è¿”å› URLï¼Œå°è¯•è·å–ä¸‹è½½ URL
                    try {
                        ossUrl = await this.ossApi.getDownloadUrl(result.data.object_name);
                    } catch (error) {
                        console.warn('è·å– OSS ä¸‹è½½ URL å¤±è´¥:', error);
                    }
                }
                
                if (ossUrl) {
                    console.log('Base64 å›¾ç‰‡å·²ä¸Šä¼ åˆ° OSS:', ossUrl);
                    return ossUrl;
                } else {
                    console.warn('ä¸Šä¼ å›¾ç‰‡åˆ° OSS æˆåŠŸï¼Œä½†æœªè·å–åˆ° URL:', result);
                    return null;
                }
            } else {
                console.warn('ä¸Šä¼ å›¾ç‰‡åˆ° OSS å¤±è´¥:', result);
                return null;
            }
        } catch (error) {
            console.error('ä¸Šä¼  base64 å›¾ç‰‡åˆ° OSS æ—¶å‡ºé”™:', error);
            return null;
        }
    }
    
    /**
     * å¤„ç†æ¶ˆæ¯ä¸­çš„ base64 å›¾ç‰‡ï¼Œå°†å…¶ä¸Šä¼ åˆ° OSS å¹¶æ›¿æ¢ä¸º URL
     * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
     * @returns {Promise<Array>} å¤„ç†åçš„æ¶ˆæ¯æ•°ç»„
     */
    async processBase64ImagesInMessages(messages) {
        if (!Array.isArray(messages) || messages.length === 0) {
            return messages;
        }
        
        const processedMessages = [];
        
        for (const message of messages) {
            const processedMessage = { ...message };
            let hasBase64Image = false;
            
            // æ£€æŸ¥ imageDataUrl å­—æ®µä¸­çš„ base64 å›¾ç‰‡
            if (message.imageDataUrl && typeof message.imageDataUrl === 'string') {
                if (message.imageDataUrl.startsWith('data:image/')) {
                    hasBase64Image = true;
                    const ossUrl = await this.uploadBase64ImageToOss(message.imageDataUrl);
                    if (ossUrl) {
                        processedMessage.imageDataUrl = ossUrl;
                        console.log('å·²å°† imageDataUrl ä¸­çš„ base64 å›¾ç‰‡æ›¿æ¢ä¸º OSS URL');
                    } else {
                        console.warn('ä¸Šä¼  imageDataUrl ä¸­çš„ base64 å›¾ç‰‡å¤±è´¥ï¼Œä¿ç•™åŸå§‹æ•°æ®');
                    }
                }
            }
            
            // æ£€æŸ¥ content å­—æ®µä¸­çš„ base64 å›¾ç‰‡ï¼ˆdata:image/png;base64,xxx æ ¼å¼ï¼‰
            if (message.content && typeof message.content === 'string') {
                const dataImageRegex = /data:image\/[^;]+;base64,[^\s"'<>]+/gi;
                const matches = message.content.match(dataImageRegex);
                
                if (matches && matches.length > 0) {
                    hasBase64Image = true;
                    let processedContent = message.content;
                    
                    // æ›¿æ¢æ‰€æœ‰åŒ¹é…çš„ base64 å›¾ç‰‡
                    for (const match of matches) {
                        const ossUrl = await this.uploadBase64ImageToOss(match);
                        if (ossUrl) {
                            processedContent = processedContent.replace(match, ossUrl);
                            console.log('å·²å°† content ä¸­çš„ base64 å›¾ç‰‡æ›¿æ¢ä¸º OSS URL');
                        } else {
                            console.warn('ä¸Šä¼  content ä¸­çš„ base64 å›¾ç‰‡å¤±è´¥ï¼Œä¿ç•™åŸå§‹æ•°æ®');
                        }
                    }
                    
                    processedMessage.content = processedContent;
                }
            }
            
            processedMessages.push(processedMessage);
        }
        
        return processedMessages;
    }
    
    async syncSessionToBackend(sessionId, immediate = false, includePageContent = false, processImages = false) {
        try {
            if (!PET_CONFIG.api.syncSessionsToBackend) {
                return;
            }
            
            const session = this.sessions[sessionId];
            if (!session) {
                console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•åŒæ­¥:', sessionId);
                return;
            }
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç™½ä¼šè¯
            const isBlankSession = session._isBlankSession || 
                                  !session.url || 
                                  session.url.startsWith('blank-session://');
            
            // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œurlåº”è¯¥ä½¿ç”¨OSSæ–‡ä»¶çš„urlï¼Œè€Œä¸æ˜¯session.urlï¼ˆå¯èƒ½è¢«æ›´æ–°ä¸ºå½“å‰é¡µé¢URLï¼‰
            // å¦‚æœæ˜¯ç©ºç™½ä¼šè¯ï¼Œåº”è¯¥ä¿æŒä½¿ç”¨åŸå§‹çš„blank-session://URLï¼Œè€Œä¸æ˜¯å½“å‰é¡µé¢URL
            let sessionUrl = '';
            if (session._isOssFileSession && session._ossFileInfo?.url) {
                sessionUrl = session._ossFileInfo.url;
            } else if (isBlankSession) {
                // å¯¹äºç©ºç™½ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„åŸå§‹URLï¼Œé˜²æ­¢è¢«æ„å¤–æ›´æ–°ä¸ºå½“å‰é¡µé¢URL
                if (session._originalUrl && session._originalUrl.startsWith('blank-session://')) {
                    sessionUrl = session._originalUrl;
                } else if (session.url && session.url.startsWith('blank-session://')) {
                    sessionUrl = session.url;
                } else {
                    // å¦‚æœURLå·²ç»è¢«æ›´æ–°ï¼Œä½¿ç”¨åˆ›å»ºæ—¶çš„URLæˆ–é‡æ–°ç”Ÿæˆä¸€ä¸ªblank-session://URL
                    sessionUrl = session._originalUrl || `blank-session://${session.createdAt || Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
                }
            } else {
                sessionUrl = session.url || '';
            }
            
            // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨å·²æ›´æ–°çš„ pageTitle å’Œ pageDescription
            // å¦‚æœæœªæ›´æ–°ï¼Œåˆ™ä½¿ç”¨ OSS æ–‡ä»¶çš„åç§°ä½œä¸ºé»˜è®¤å€¼
            // pageContentåº”è¯¥ä¿ç•™ä¼šè¯ä¸­ä¿å­˜çš„å†…å®¹
            let pageTitle = session.pageTitle || '';
            let pageDescription = session.pageDescription || '';
            let pageContent = session.pageContent || '';
            
            if (session._isOssFileSession && session._ossFileInfo) {
                // ç›´æ¥ä½¿ç”¨ session.pageTitle å’Œ session.pageDescription
                // è¿™äº›å€¼åœ¨ saveOssFileTitleInfo ä¸­å·²ç»è¢«æ›´æ–°ä¸ºç¼–è¾‘åçš„æ ‡é¢˜å’Œæè¿°
                // å¦‚æœå®ƒä»¬ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ OSS æ–‡ä»¶ä¿¡æ¯ä¸­çš„é»˜è®¤å€¼
                if (!pageTitle) {
                    pageTitle = session._ossFileInfo.name || 'OSSæ–‡ä»¶';
                }
                // pageDescription å·²ç»åœ¨ä¸Šé¢ä» session.pageDescription è·å–
                // å¦‚æœç”¨æˆ·åœ¨ OSS æ–‡ä»¶åˆ—è¡¨ä¸­ç¼–è¾‘äº†æè¿°ï¼Œsession.pageDescription ä¼šè¢«æ›´æ–°
                // å¦‚æœæœªç¼–è¾‘ï¼ŒpageDescription å¯èƒ½ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¿™æ˜¯æ­£å¸¸çš„
                // OSSæ–‡ä»¶ä¼šè¯çš„pageContentåº”è¯¥ä¿ç•™ä¼šè¯ä¸­ä¿å­˜çš„å†…å®¹ï¼Œè€Œä¸æ˜¯è®¾ç½®ä¸ºç©º
                // pageContent = session.pageContent || '';
            }
            
            // å¦‚æœæ˜¯æ–°é—»ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨æ–°é—»æœ¬èº«çš„æ ‡é¢˜ã€ç½‘å€ç­‰ä¿¡æ¯
            if (session._isNewsSession && session._newsInfo) {
                // ä¼˜å…ˆä½¿ç”¨æ–°é—»ä¿¡æ¯ä¸­çš„æ ‡é¢˜å’Œç½‘å€ï¼Œç¡®ä¿ä¿å­˜çš„ä¼šè¯ä¿¡æ¯ä¸æ–°é—»ä¸€è‡´
                if (session._newsInfo.title) {
                    pageTitle = session._newsInfo.title;
                    // åŒæ—¶æ›´æ–°ä¼šè¯å¯¹è±¡æœ¬èº«ï¼Œç¡®ä¿ä¿å­˜åˆ°åç«¯çš„æ•°æ®å’Œä¼šè¯æ˜¾ç¤ºçš„æ ‡é¢˜ä¸€è‡´
                    session.pageTitle = session._newsInfo.title;
                }
                if (session._newsInfo.link) {
                    sessionUrl = session._newsInfo.link;
                    // åŒæ—¶æ›´æ–°ä¼šè¯å¯¹è±¡æœ¬èº«ï¼Œç¡®ä¿ä¿å­˜åˆ°åç«¯çš„æ•°æ®å’Œä¼šè¯æ˜¾ç¤ºçš„ç½‘å€ä¸€è‡´
                    session.url = session._newsInfo.link;
                }
                if (session._newsInfo.description || session._newsInfo.content) {
                    pageDescription = session._newsInfo.description || session._newsInfo.content || '';
                    // åŒæ—¶æ›´æ–°ä¼šè¯å¯¹è±¡æœ¬èº«ï¼Œç¡®ä¿ä¿å­˜åˆ°åç«¯çš„æ•°æ®å’Œä¼šè¯æ˜¾ç¤ºçš„æè¿°ä¸€è‡´
                    session.pageDescription = pageDescription;
                }
                if (session._newsInfo.content) {
                    pageContent = session._newsInfo.content;
                    // åŒæ—¶æ›´æ–°ä¼šè¯å¯¹è±¡æœ¬èº«ï¼Œç¡®ä¿ä¿å­˜åˆ°åç«¯çš„æ•°æ®å’Œä¼šè¯æ˜¾ç¤ºçš„å†…å®¹ä¸€è‡´
                    session.pageContent = session._newsInfo.content;
                }
                // å¦‚æœæ–°é—»æœ‰æ ‡ç­¾ï¼Œä½¿ç”¨æ–°é—»çš„æ ‡ç­¾
                if (session._newsInfo.tags && Array.isArray(session._newsInfo.tags)) {
                    session.tags = session._newsInfo.tags;
                }
                console.log('æ–°é—»ä¼šè¯ä¿å­˜æ—¶ä½¿ç”¨æ–°é—»æœ¬èº«çš„ä¿¡æ¯:', {
                    pageTitle: pageTitle,
                    url: sessionUrl,
                    pageDescription: pageDescription,
                    tags: session.tags
                });
            }
            
            // å¦‚æœæ˜¯æ¥å£ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨æ¥å£æœ¬èº«çš„æ ‡é¢˜ã€ç½‘å€ç­‰ä¿¡æ¯
            if (session._isApiRequestSession && session._apiRequestInfo) {
                // ä¼˜å…ˆä½¿ç”¨æ¥å£ä¿¡æ¯ä¸­çš„æ ‡é¢˜å’Œç½‘å€ï¼Œç¡®ä¿ä¿å­˜çš„ä¼šè¯ä¿¡æ¯ä¸æ¥å£ä¸€è‡´
                // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                const requestUrl = session._apiRequestInfo.requestUrl || session._apiRequestInfo.url || '';
                if (requestUrl) {
                    // ä½¿ç”¨æ¥å£çš„pageUrlï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨æ¥å£çš„requestUrl
                    sessionUrl = session._apiRequestInfo.pageUrl || requestUrl;
                    // åŒæ—¶æ›´æ–°ä¼šè¯å¯¹è±¡æœ¬èº«ï¼Œç¡®ä¿ä¿å­˜åˆ°åç«¯çš„æ•°æ®å’Œä¼šè¯æ˜¾ç¤ºçš„ç½‘å€ä¸€è‡´
                    session.url = sessionUrl;
                }
                // æ„å»ºæ¥å£æ ‡é¢˜ï¼šæ–¹æ³• + è·¯å¾„
                const apiPath = this._extractApiPath(requestUrl);
                pageTitle = `${session._apiRequestInfo.method || 'GET'} ${apiPath}`;
                // åŒæ—¶æ›´æ–°ä¼šè¯å¯¹è±¡æœ¬èº«ï¼Œç¡®ä¿ä¿å­˜åˆ°åç«¯çš„æ•°æ®å’Œä¼šè¯æ˜¾ç¤ºçš„æ ‡é¢˜ä¸€è‡´
                session.pageTitle = pageTitle;
                
                // ä½¿ç”¨æ¥å£çš„æè¿°
                pageDescription = `æ¥å£è¯·æ±‚ï¼š${requestUrl}`;
                // åŒæ—¶æ›´æ–°ä¼šè¯å¯¹è±¡æœ¬èº«ï¼Œç¡®ä¿ä¿å­˜åˆ°åç«¯çš„æ•°æ®å’Œä¼šè¯æ˜¾ç¤ºçš„æè¿°ä¸€è‡´
                session.pageDescription = pageDescription;
                
                // ä½¿ç”¨æ¥å£çš„pageContentï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (session.pageContent && session.pageContent.trim() !== '') {
                    pageContent = session.pageContent;
                }
                
                // å¦‚æœæ¥å£æœ‰æ ‡ç­¾ï¼Œä½¿ç”¨æ¥å£çš„æ ‡ç­¾
                if (session._apiRequestInfo.tags && Array.isArray(session._apiRequestInfo.tags)) {
                    session.tags = session._apiRequestInfo.tags;
                }
                console.log('æ¥å£ä¼šè¯ä¿å­˜æ—¶ä½¿ç”¨æ¥å£æœ¬èº«çš„ä¿¡æ¯:', {
                    pageTitle: pageTitle,
                    url: sessionUrl,
                    pageDescription: pageDescription,
                    tags: session.tags
                });
            }
            
            // å¤„ç†æ¶ˆæ¯ä¸­çš„ base64 å›¾ç‰‡ï¼ˆåœ¨ä¸Šä¼ åˆ° OSS åæ›¿æ¢ä¸º URLï¼‰
            // åªæœ‰åœ¨ processImages ä¸º true æ—¶æ‰å¤„ç†ï¼ˆå³ç”¨æˆ·å‘é€å›¾ç‰‡æ¶ˆæ¯æ—¶ï¼‰
            let messages = session.messages || [];
            if (processImages && messages.length > 0) {
                messages = await this.processBase64ImagesInMessages(messages);
                // å°†å¤„ç†åçš„æ¶ˆæ¯ï¼ˆåŒ…å« OSS URLï¼‰æ›´æ–°å›æœ¬åœ°ä¼šè¯
                // è¿™æ ·æœ¬åœ°ä¼šè¯ä¸­çš„ imageDataUrl ä¹Ÿä¼šæ˜¯ OSS URLï¼Œè€Œä¸æ˜¯ base64
                this.sessions[sessionId].messages = messages;
            }
            
            const sessionData = {
                id: session.id || sessionId,
                url: sessionUrl,
                pageTitle: pageTitle,
                pageDescription: pageDescription,
                messages: messages,
                tags: session.tags || [],
                createdAt: session.createdAt || Date.now(),
                updatedAt: session.updatedAt || Date.now(),
                lastAccessTime: session.lastAccessTime || Date.now()
            };
            
            // åŒ…å« pageContent å­—æ®µçš„æƒ…å†µï¼š
            // 1. æ‰‹åŠ¨ä¿å­˜é¡µé¢ä¸Šä¸‹æ–‡æ—¶ï¼ˆincludePageContent = trueï¼‰
            // 2. OSSæ–‡ä»¶ä¼šè¯ä¸­æœ‰pageContentæ—¶ï¼ˆå³ä½¿includePageContent = falseï¼Œä¹Ÿåº”è¯¥ä¿å­˜ï¼‰
            // 3. æ–°é—»ä¼šè¯ä¸­ä½¿ç”¨äº†å½“å‰é€‰ä¸­ä¼šè¯çš„pageContentæ—¶ï¼ˆå³ä½¿includePageContent = falseï¼Œä¹Ÿåº”è¯¥ä¿å­˜ï¼‰
            // 4. æ¥å£ä¼šè¯ä¸­æœ‰pageContentæ—¶ï¼ˆå³ä½¿includePageContent = falseï¼Œä¹Ÿåº”è¯¥ä¿å­˜ï¼‰
            if (includePageContent || 
                (session._isOssFileSession && pageContent && pageContent.trim() !== '') ||
                (session._isNewsSession && pageContent && pageContent.trim() !== '') ||
                (session._isApiRequestSession && pageContent && pageContent.trim() !== '')) {
                sessionData.pageContent = pageContent;
            }
            
            // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼ŒåŒ…å«OSSæ–‡ä»¶ä¿¡æ¯
            if (session._isOssFileSession && session._ossFileInfo) {
                sessionData._isOssFileSession = true;
                sessionData._ossFileInfo = session._ossFileInfo;
            }
            
            // å¦‚æœæ˜¯æ–°é—»ä¼šè¯ï¼ŒåŒ…å«æ–°é—»ä¿¡æ¯ï¼ˆä¿ç•™åŸå§‹æ–°é—»ä¿¡æ¯ï¼Œå³ä½¿ä½¿ç”¨äº†å½“å‰é€‰ä¸­ä¼šè¯çš„æ ‡é¢˜å’Œç½‘å€ï¼‰
            if (session._isNewsSession && session._newsInfo) {
                sessionData._isNewsSession = true;
                sessionData._newsInfo = session._newsInfo;
            }
            
            // å¦‚æœæ˜¯æ¥å£ä¼šè¯ï¼ŒåŒ…å«æ¥å£ä¿¡æ¯ï¼ˆä¿ç•™åŸå§‹æ¥å£ä¿¡æ¯ï¼Œå³ä½¿ä½¿ç”¨äº†å½“å‰é€‰ä¸­ä¼šè¯çš„æ ‡é¢˜å’Œç½‘å€ï¼‰
            if (session._isApiRequestSession && session._apiRequestInfo) {
                sessionData._isApiRequestSession = true;
                sessionData._apiRequestInfo = session._apiRequestInfo;
            }
            
            // ä½¿ç”¨APIç®¡ç†å™¨
            if (this.sessionApi) {
                if (immediate) {
                    // ç«‹å³ä¿å­˜ï¼ˆåŒ…æ‹¬ç©ºç™½ä¼šè¯ï¼Œåˆ›å»ºæ–°ä¼šè¯æ—¶éœ€è¦ç«‹å³å‘é€è¯·æ±‚ï¼‰
                    try {
                        const result = await this.sessionApi.saveSession(sessionData);
                        
                        // å¦‚æœè¿”å›äº†å®Œæ•´çš„ä¼šè¯æ•°æ®ï¼Œæ›´æ–°æœ¬åœ°ä¼šè¯æ•°æ®
                        if (result?.data?.session) {
                            const updatedSession = result.data.session;
                            if (this.sessions[sessionId]) {
                                const localSession = this.sessions[sessionId];
                                // æ›´æ–°æœ¬åœ°ä¼šè¯æ•°æ®ï¼Œä½†ä¿ç•™æœ¬åœ°çš„ messages å’Œ pageContentï¼ˆå¯èƒ½åŒ…å«æœªåŒæ­¥çš„æœ€æ–°æ•°æ®ï¼‰
                                this.sessions[sessionId] = {
                                    ...updatedSession,
                                    // å¦‚æœæœ¬åœ°æ¶ˆæ¯æ›´æ–°ï¼Œä¿ç•™æœ¬åœ°æ¶ˆæ¯
                                    messages: localSession.messages?.length > updatedSession.messages?.length
                                        ? localSession.messages
                                        : updatedSession.messages,
                                    // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ pageContentï¼ˆå¦‚æœæœ¬åœ°æœ‰å†…å®¹ï¼‰ï¼Œé¿å…é¡µé¢ä¸Šä¸‹æ–‡ä¸¢å¤±
                                    pageContent: (localSession.pageContent && localSession.pageContent.trim() !== '')
                                        ? localSession.pageContent
                                        : (updatedSession.pageContent || localSession.pageContent || ''),
                                    // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ pageTitleï¼ˆå¦‚æœæœ¬åœ°æœ‰å†…å®¹ï¼‰
                                    pageTitle: (localSession.pageTitle && localSession.pageTitle.trim() !== '')
                                        ? localSession.pageTitle
                                        : (updatedSession.pageTitle || localSession.pageTitle || ''),
                                    // ä¿ç•™OSSæ–‡ä»¶ä¼šè¯ä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨åç«¯çš„ï¼Œå¦‚æœåç«¯æ²¡æœ‰åˆ™ä½¿ç”¨æœ¬åœ°çš„ï¼‰
                                    _isOssFileSession: updatedSession._isOssFileSession !== undefined 
                                        ? updatedSession._isOssFileSession 
                                        : (localSession._isOssFileSession || false),
                                    _ossFileInfo: updatedSession._ossFileInfo || localSession._ossFileInfo || null
                                };
                            }
                        }
                        
                        // æ¸…é™¤åˆ—è¡¨ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡åˆ·æ–°æ—¶ä»æ¥å£è·å–æœ€æ–°æ•°æ®
                        this.lastSessionListLoadTime = 0;
                        
                        console.log(`ä¼šè¯ ${sessionId} å·²ç«‹å³åŒæ­¥åˆ°åç«¯`);
                    } catch (error) {
                        // å¦‚æœç«‹å³ä¿å­˜å¤±è´¥ï¼Œé™çº§ä¸ºé˜Ÿåˆ—ä¿å­˜
                        const is404 = error.message && (
                            error.message.includes('404') || 
                            error.message.includes('Not Found') ||
                            error.status === 404 ||
                            error.response?.status === 404
                        );
                        
                        if (is404) {
                            console.log('ç«‹å³ä¿å­˜å¤±è´¥ï¼ˆ404ï¼‰ï¼Œé™çº§ä¸ºé˜Ÿåˆ—ä¿å­˜:', sessionId);
                            this.sessionApi.queueSave(sessionId, sessionData);
                        } else {
                            throw error; // é‡æ–°æŠ›å‡ºé404é”™è¯¯
                        }
                    }
                } else {
                    // åŠ å…¥é˜Ÿåˆ—æ‰¹é‡ä¿å­˜
                    this.sessionApi.queueSave(sessionId, sessionData);
                    console.log(`ä¼šè¯ ${sessionId} å·²åŠ å…¥ä¿å­˜é˜Ÿåˆ—`);
                }
            } else {
                // å‘åå…¼å®¹ï¼šä½¿ç”¨æ—§æ–¹å¼
                // session/save è°ƒç”¨å·²åˆ é™¤ï¼Œè·³è¿‡åŒæ­¥
                console.log(`ä¼šè¯ ${sessionId} åŒæ­¥å·²è·³è¿‡ï¼ˆsessionApi æœªåˆå§‹åŒ–ï¼‰`);
            }
        } catch (error) {
            // ä¼˜é›…å¤„ç†é”™è¯¯ï¼Œä¸é˜»å¡ä¸»æµç¨‹
            const is404 = error.message && (
                error.message.includes('404') || 
                error.message.includes('Not Found') ||
                error.status === 404 ||
                error.response?.status === 404
            );
            
            if (is404) {
                // 404é”™è¯¯æ˜¯æ­£å¸¸çš„ï¼ˆä¼šè¯å¯èƒ½è¿˜æœªåŒæ­¥åˆ°åç«¯ï¼‰ï¼Œå°è¯•ä½¿ç”¨é˜Ÿåˆ—ä¿å­˜
                if (this.sessionApi && session) {
                    try {
                        // æ„å»ºä¼šè¯æ•°æ®ï¼Œå¯¹äºæ–°é—»ä¼šè¯ä½¿ç”¨å½“å‰é€‰ä¸­ä¼šè¯çš„ä¿¡æ¯
                        // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç™½ä¼šè¯
                        const isBlankSession = session._isBlankSession || 
                                              !session.url || 
                                              session.url.startsWith('blank-session://');
                        
                        // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œurlåº”è¯¥ä½¿ç”¨OSSæ–‡ä»¶çš„urlï¼Œè€Œä¸æ˜¯session.urlï¼ˆå¯èƒ½è¢«æ›´æ–°ä¸ºå½“å‰é¡µé¢URLï¼‰
                        // å¦‚æœæ˜¯æ¥å£ä¼šè¯ï¼Œurlåº”è¯¥ä½¿ç”¨æ¥å£çš„pageUrlæˆ–urlï¼Œè€Œä¸æ˜¯session.urlï¼ˆå¯èƒ½è¢«æ›´æ–°ä¸ºå½“å‰é¡µé¢URLï¼‰
                        // å¦‚æœæ˜¯ç©ºç™½ä¼šè¯ï¼Œåº”è¯¥ä¿æŒä½¿ç”¨åŸå§‹çš„blank-session://URLï¼Œè€Œä¸æ˜¯å½“å‰é¡µé¢URL
                        let fallbackSessionUrl = '';
                        if (session._isOssFileSession && session._ossFileInfo?.url) {
                            fallbackSessionUrl = session._ossFileInfo.url;
                        } else if (session._isApiRequestSession && session._apiRequestInfo) {
                            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                            const requestUrl = session._apiRequestInfo.requestUrl || session._apiRequestInfo.url || '';
                            if (requestUrl) {
                                // ä½¿ç”¨æ¥å£çš„pageUrlï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨æ¥å£çš„requestUrl
                                fallbackSessionUrl = session._apiRequestInfo.pageUrl || requestUrl;
                            }
                        } else if (isBlankSession) {
                            // å¯¹äºç©ºç™½ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„åŸå§‹URLï¼Œé˜²æ­¢è¢«æ„å¤–æ›´æ–°ä¸ºå½“å‰é¡µé¢URL
                            if (session._originalUrl && session._originalUrl.startsWith('blank-session://')) {
                                fallbackSessionUrl = session._originalUrl;
                            } else if (session.url && session.url.startsWith('blank-session://')) {
                                fallbackSessionUrl = session.url;
                            } else {
                                // å¦‚æœURLå·²ç»è¢«æ›´æ–°ï¼Œä½¿ç”¨åˆ›å»ºæ—¶çš„URLæˆ–é‡æ–°ç”Ÿæˆä¸€ä¸ªblank-session://URL
                                fallbackSessionUrl = session._originalUrl || `blank-session://${session.createdAt || Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
                            }
                        } else {
                            fallbackSessionUrl = session.url || '';
                        }
                        
                        // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨å·²æ›´æ–°çš„ pageTitle å’Œ pageDescription
                        // å¦‚æœæœªæ›´æ–°ï¼Œåˆ™ä½¿ç”¨ OSS æ–‡ä»¶çš„åç§°ä½œä¸ºé»˜è®¤å€¼
                        let fallbackPageTitle = session.pageTitle || '';
                        let fallbackPageDescription = session.pageDescription || '';
                        let fallbackPageContent = session.pageContent || '';
                        
                        if (session._isOssFileSession && session._ossFileInfo) {
                            // ç›´æ¥ä½¿ç”¨ session.pageTitle å’Œ session.pageDescription
                            // è¿™äº›å€¼åœ¨ saveOssFileTitleInfo ä¸­å·²ç»è¢«æ›´æ–°ä¸ºç¼–è¾‘åçš„æ ‡é¢˜å’Œæè¿°
                            // å¦‚æœå®ƒä»¬ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ OSS æ–‡ä»¶ä¿¡æ¯ä¸­çš„é»˜è®¤å€¼
                            if (!fallbackPageTitle) {
                                fallbackPageTitle = session._ossFileInfo.name || 'OSSæ–‡ä»¶';
                            }
                            // pageDescription å·²ç»åœ¨ä¸Šé¢ä» session.pageDescription è·å–
                            // å¦‚æœç”¨æˆ·åœ¨ OSS æ–‡ä»¶åˆ—è¡¨ä¸­ç¼–è¾‘äº†æè¿°ï¼Œsession.pageDescription ä¼šè¢«æ›´æ–°
                            // å¦‚æœæœªç¼–è¾‘ï¼ŒpageDescription å¯èƒ½ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¿™æ˜¯æ­£å¸¸çš„
                            // OSSæ–‡ä»¶ä¼šè¯çš„pageContentåº”è¯¥ä¿ç•™ä¼šè¯ä¸­ä¿å­˜çš„å†…å®¹ï¼Œè€Œä¸æ˜¯è®¾ç½®ä¸ºç©º
                        }
                        
                        // å¦‚æœæ˜¯æ–°é—»ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨æ–°é—»æœ¬èº«çš„æ ‡é¢˜ã€ç½‘å€ç­‰ä¿¡æ¯
                        if (session._isNewsSession && session._newsInfo) {
                            // ä¼˜å…ˆä½¿ç”¨æ–°é—»ä¿¡æ¯ä¸­çš„æ ‡é¢˜å’Œç½‘å€ï¼Œç¡®ä¿ä¿å­˜çš„ä¼šè¯ä¿¡æ¯ä¸æ–°é—»ä¸€è‡´
                            if (session._newsInfo.title) {
                                fallbackPageTitle = session._newsInfo.title;
                            }
                            if (session._newsInfo.link) {
                                fallbackSessionUrl = session._newsInfo.link;
                            }
                            if (session._newsInfo.description || session._newsInfo.content) {
                                fallbackPageDescription = session._newsInfo.description || session._newsInfo.content || '';
                            }
                            if (session._newsInfo.content) {
                                fallbackPageContent = session._newsInfo.content;
                            }
                            // å¦‚æœæ–°é—»æœ‰æ ‡ç­¾ï¼Œä½¿ç”¨æ–°é—»çš„æ ‡ç­¾
                            if (session._newsInfo.tags && Array.isArray(session._newsInfo.tags)) {
                                session.tags = session._newsInfo.tags;
                            }
                        }
                        
                        // å¦‚æœæ˜¯æ¥å£ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨æ¥å£æœ¬èº«çš„æ ‡é¢˜ã€ç½‘å€ç­‰ä¿¡æ¯
                        if (session._isApiRequestSession && session._apiRequestInfo) {
                            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                            const requestUrl = session._apiRequestInfo.requestUrl || session._apiRequestInfo.url || '';
                            // ä¼˜å…ˆä½¿ç”¨æ¥å£ä¿¡æ¯ä¸­çš„æ ‡é¢˜å’Œç½‘å€ï¼Œç¡®ä¿ä¿å­˜çš„ä¼šè¯ä¿¡æ¯ä¸æ¥å£ä¸€è‡´
                            if (requestUrl) {
                                // ä½¿ç”¨æ¥å£çš„pageUrlï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨æ¥å£çš„requestUrl
                                fallbackSessionUrl = session._apiRequestInfo.pageUrl || requestUrl;
                            }
                            // æ„å»ºæ¥å£æ ‡é¢˜ï¼šæ–¹æ³• + è·¯å¾„
                            const apiPath = this._extractApiPath(requestUrl);
                            fallbackPageTitle = `${session._apiRequestInfo.method || 'GET'} ${apiPath}`;
                            
                            // ä½¿ç”¨æ¥å£çš„æè¿°
                            fallbackPageDescription = `æ¥å£è¯·æ±‚ï¼š${requestUrl}`;
                            
                            // ä½¿ç”¨æ¥å£çš„pageContentï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            if (session.pageContent && session.pageContent.trim() !== '') {
                                fallbackPageContent = session.pageContent;
                            }
                            
                            // å¦‚æœæ¥å£æœ‰æ ‡ç­¾ï¼Œä½¿ç”¨æ¥å£çš„æ ‡ç­¾
                            if (session._apiRequestInfo.tags && Array.isArray(session._apiRequestInfo.tags)) {
                                session.tags = session._apiRequestInfo.tags;
                            }
                        }
                        
                        const sessionData = {
                            id: session.id || sessionId,
                            url: fallbackSessionUrl,
                            pageTitle: fallbackPageTitle,
                            pageDescription: fallbackPageDescription,
                            messages: session.messages || [],
                            tags: session.tags || [],
                            createdAt: session.createdAt || Date.now(),
                            updatedAt: session.updatedAt || Date.now(),
                            lastAccessTime: session.lastAccessTime || Date.now()
                        };
                        
                        // åŒ…å« pageContent å­—æ®µçš„æƒ…å†µï¼š
                        // 1. æ‰‹åŠ¨ä¿å­˜é¡µé¢ä¸Šä¸‹æ–‡æ—¶ï¼ˆincludePageContent = trueï¼‰
                        // 2. OSSæ–‡ä»¶ä¼šè¯ä¸­æœ‰pageContentæ—¶ï¼ˆå³ä½¿includePageContent = falseï¼Œä¹Ÿåº”è¯¥ä¿å­˜ï¼‰
                        // 3. æ–°é—»ä¼šè¯ä¸­æœ‰pageContentæ—¶ï¼ˆå³ä½¿includePageContent = falseï¼Œä¹Ÿåº”è¯¥ä¿å­˜ï¼‰
                        // 4. æ¥å£ä¼šè¯ä¸­æœ‰pageContentæ—¶ï¼ˆå³ä½¿includePageContent = falseï¼Œä¹Ÿåº”è¯¥ä¿å­˜ï¼‰
                        if (includePageContent || 
                            (session._isOssFileSession && fallbackPageContent && fallbackPageContent.trim() !== '') ||
                            (session._isNewsSession && fallbackPageContent && fallbackPageContent.trim() !== '') ||
                            (session._isApiRequestSession && fallbackPageContent && fallbackPageContent.trim() !== '')) {
                            sessionData.pageContent = fallbackPageContent;
                        }
                        
                        // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼ŒåŒ…å«OSSæ–‡ä»¶ä¿¡æ¯
                        if (session._isOssFileSession && session._ossFileInfo) {
                            sessionData._isOssFileSession = true;
                            sessionData._ossFileInfo = session._ossFileInfo;
                        }
                        
                        // å¦‚æœæ˜¯æ–°é—»ä¼šè¯ï¼ŒåŒ…å«æ–°é—»ä¿¡æ¯ï¼ˆä¿ç•™åŸå§‹æ–°é—»ä¿¡æ¯ï¼Œå³ä½¿ä½¿ç”¨äº†å½“å‰é€‰ä¸­ä¼šè¯çš„æ ‡é¢˜å’Œç½‘å€ï¼‰
                        if (session._isNewsSession && session._newsInfo) {
                            sessionData._isNewsSession = true;
                            sessionData._newsInfo = session._newsInfo;
                        }
                        
                        // å¦‚æœæ˜¯æ¥å£ä¼šè¯ï¼ŒåŒ…å«æ¥å£ä¿¡æ¯ï¼ˆä¿ç•™åŸå§‹æ¥å£ä¿¡æ¯ï¼Œå³ä½¿ä½¿ç”¨äº†å½“å‰é€‰ä¸­ä¼šè¯çš„æ ‡é¢˜å’Œç½‘å€ï¼‰
                        if (session._isApiRequestSession && session._apiRequestInfo) {
                            sessionData._isApiRequestSession = true;
                            sessionData._apiRequestInfo = session._apiRequestInfo;
                        }
                        
                        this.sessionApi.queueSave(sessionId, sessionData);
                        console.log('åŒæ­¥å¤±è´¥ï¼ˆ404ï¼‰ï¼Œå·²åŠ å…¥é˜Ÿåˆ—ç¨åé‡è¯•:', sessionId);
                    } catch (queueError) {
                        console.warn('åŠ å…¥é˜Ÿåˆ—ä¹Ÿå¤±è´¥:', queueError.message);
                    }
                }
            } else {
                console.warn('åŒæ­¥ä¼šè¯åˆ°åç«¯æ—¶å‡ºé”™:', error.message);
            }
        }
    }

    // ç›´æ¥æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰ä¼šè¯å¯¹è±¡ï¼ˆå®æ—¶ä¿å­˜ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¼šè¯ä¸€ä¸€å¯¹åº”ï¼‰
    async addMessageToSession(type, content, timestamp = null, syncToBackend = true, imageDataUrl = null) {
        if (!this.currentSessionId) {
            console.warn('æ²¡æœ‰å½“å‰ä¼šè¯ï¼Œæ— æ³•æ·»åŠ æ¶ˆæ¯');
            return;
        }
        
        // ç¡®ä¿ä¼šè¯å­˜åœ¨
        if (!this.sessions[this.currentSessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ æ¶ˆæ¯:', this.currentSessionId);
            return;
        }
        
        const session = this.sessions[this.currentSessionId];
        
        // ç¡®ä¿messagesæ•°ç»„å­˜åœ¨
        if (!Array.isArray(session.messages)) {
            session.messages = [];
        }
        
        // éªŒè¯æ¶ˆæ¯å†…å®¹ï¼šå¿…é¡»æœ‰æ–‡æœ¬å†…å®¹æˆ–å›¾ç‰‡æ•°æ®
        const hasTextContent = content && typeof content === 'string' && content.trim();
        const hasImage = imageDataUrl && typeof imageDataUrl === 'string';
        
        if (!hasTextContent && !hasImage) {
            console.warn('æ¶ˆæ¯å†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆï¼ˆæ—¢æ— æ–‡æœ¬ä¹Ÿæ— å›¾ç‰‡ï¼‰ï¼Œè·³è¿‡ä¿å­˜');
            return;
        }
        
        // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
        const message = {
            type: type, // 'user' æˆ– 'pet'
            content: hasTextContent ? content.trim() : '', // å»é™¤é¦–å°¾ç©ºç™½ï¼Œå¦‚æœæ²¡æœ‰æ–‡æœ¬åˆ™ä¸ºç©ºå­—ç¬¦ä¸²
            timestamp: timestamp || Date.now()
        };
        
        // å¦‚æœæœ‰å›¾ç‰‡æ•°æ®ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯å¯¹è±¡ä¸­
        if (hasImage) {
            message.imageDataUrl = imageDataUrl;
        }
        
        // æ£€æŸ¥æ˜¯å¦é‡å¤ï¼ˆé¿å…é‡å¤ä¿å­˜ç›¸åŒçš„æ¶ˆæ¯ï¼‰
        // å¦‚æœæœ€åä¸€æ¡æ¶ˆæ¯çš„ç±»å‹å’Œå†…å®¹éƒ½ç›¸åŒï¼Œå¯èƒ½æ˜¯é‡å¤æ·»åŠ ï¼Œè·³è¿‡
        const lastMessage = session.messages[session.messages.length - 1];
        if (lastMessage && 
            lastMessage.type === message.type && 
            lastMessage.content === message.content &&
            lastMessage.imageDataUrl === message.imageDataUrl &&
            (Date.now() - lastMessage.timestamp) < 1000) { // 1ç§’å†…çš„ç›¸åŒæ¶ˆæ¯è§†ä¸ºé‡å¤
            const previewText = hasTextContent ? message.content.substring(0, 30) : (hasImage ? '[å›¾ç‰‡]' : '');
            console.log('æ£€æµ‹åˆ°é‡å¤æ¶ˆæ¯ï¼Œè·³è¿‡ä¿å­˜:', previewText);
            return;
        }
        
        // å¦‚æœæ˜¯æ¬¢è¿æ¶ˆæ¯ï¼ˆç¬¬ä¸€æ¡å® ç‰©æ¶ˆæ¯ï¼‰ï¼Œä¸æ·»åŠ åˆ°ä¼šè¯ä¸­
        if (type === 'pet' && session.messages.length === 0) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ¬¢è¿æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ·»åŠ 
            return;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°ä¼šè¯å¯¹è±¡
        session.messages.push(message);
        session.updatedAt = Date.now();
        
        const previewText = hasTextContent ? message.content.substring(0, 50) : (hasImage ? '[å›¾ç‰‡æ¶ˆæ¯]' : '');
        console.log(`æ¶ˆæ¯å·²æ·»åŠ åˆ°ä¼šè¯ ${this.currentSessionId} (${session.messages.length} æ¡):`, 
            message.type, previewText);
        
        // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
        // addMessageToSession ä¸å†è‡ªåŠ¨ä¿å­˜ï¼Œä¿å­˜é€»è¾‘ç”± prompt æ¥å£è°ƒç”¨åç»Ÿä¸€å¤„ç†
    }

    // ä¿å­˜å½“å‰ä¼šè¯çš„æ¶ˆæ¯å’Œé¡µé¢ä¿¡æ¯ï¼ˆç¡®ä¿ä¸€è‡´æ€§ï¼Œä¼˜åŒ–ç‰ˆæœ¬ï¼‰
    // é‡è¦ï¼šåªæœ‰å½“ä¼šè¯URLå’Œå½“å‰é¡µé¢URLåŒ¹é…æ—¶ï¼Œæ‰æ›´æ–°é¡µé¢ä¿¡æ¯ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
    async saveCurrentSession(force = false, syncToBackend = true) {
        if (!this.currentSessionId) return;
        
        // ç¡®ä¿ä¼šè¯å­˜åœ¨
        if (!this.sessions[this.currentSessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ä¿å­˜:', this.currentSessionId);
            return;
        }

        // è·å–å½“å‰é¡µé¢ä¿¡æ¯
        const pageInfo = this.getPageInfo();
        const session = this.sessions[this.currentSessionId];
        let hasActualChanges = false;
        let messagesChanged = false;
        
        // å…³é”®æ£€æŸ¥ï¼šåªæœ‰å½“ä¼šè¯URLå’Œå½“å‰é¡µé¢URLåŒ¹é…æ—¶ï¼Œæ‰å…è®¸æ›´æ–°é¡µé¢ä¿¡æ¯
        // è¿™æ ·å¯ä»¥ç¡®ä¿åˆ‡æ¢åˆ°ä¸åŒURLçš„ä¼šè¯æ—¶ï¼Œä¸ä¼šäº’ç›¸å½±å“æ•°æ®
        const isUrlMatched = session.url === pageInfo.url;
        
        // å¦‚æœèŠå¤©çª—å£å·²æ‰“å¼€ï¼ŒåŒæ­¥æ¶ˆæ¯è®°å½•ï¼ˆä»DOMä¸­æå–ï¼Œç¡®ä¿å®Œæ•´æ€§ï¼‰
        if (this.chatWindow) {
            const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
            if (messagesContainer) {
                // è·å–æ‰€æœ‰æ¶ˆæ¯å…ƒç´ 
                const messageElements = Array.from(messagesContainer.children);
                const messages = [];
                
                for (const msgEl of messageElements) {
                    const userBubble = msgEl.querySelector('[data-message-type="user-bubble"]');
                    const petBubble = msgEl.querySelector('[data-message-type="pet-bubble"]');
                    
                    if (userBubble) {
                        // æå–æ–‡æœ¬å†…å®¹ï¼ˆä¼˜å…ˆä½¿ç”¨ data-original-textï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ textContentï¼‰
                        const content = userBubble.getAttribute('data-original-text') || userBubble.textContent || '';
                        
                        // æŸ¥æ‰¾å›¾ç‰‡å…ƒç´ ï¼ˆå¦‚æœæœ‰ï¼‰
                        const imgElement = userBubble.querySelector('img');
                        const imageDataUrl = imgElement ? imgElement.src : null;
                        
                        // å¦‚æœæœ‰æ–‡æœ¬å†…å®¹æˆ–å›¾ç‰‡ï¼Œåˆ™ä¿å­˜æ¶ˆæ¯
                        if (content.trim() || imageDataUrl) {
                            const message = {
                                type: 'user',
                                content: content.trim() || '', // å³ä½¿ä¸ºç©ºå­—ç¬¦ä¸²ä¹Ÿä¿å­˜
                                timestamp: this.getMessageTimestamp(msgEl)
                            };
                            
                            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯å¯¹è±¡ä¸­
                            if (imageDataUrl) {
                                message.imageDataUrl = imageDataUrl;
                            }
                            
                            messages.push(message);
                        }
                    } else if (petBubble) {
                        // è·³è¿‡æ¬¢è¿æ¶ˆæ¯ï¼ˆç¬¬ä¸€æ¡å® ç‰©æ¶ˆæ¯ï¼‰
                        const isWelcome = msgEl.hasAttribute('data-welcome-message');
                        if (!isWelcome) {
                            const content = petBubble.getAttribute('data-original-text') || petBubble.textContent || '';
                            if (content.trim()) {
                                messages.push({
                                    type: 'pet',
                                    content: content,
                                    timestamp: this.getMessageTimestamp(msgEl)
                                });
                            }
                        }
                    }
                }
                
                // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦çœŸçš„å‘ç”Ÿäº†å˜åŒ–ï¼ˆæ¯”è¾ƒæ¶ˆæ¯æ•°é‡å’Œå†…å®¹ï¼‰
                const existingMessages = session.messages || [];
                
                // æ·±åº¦æ¯”è¾ƒæ¶ˆæ¯æ•°ç»„ï¼ˆåŒ…æ‹¬å›¾ç‰‡æ¶ˆæ¯ï¼‰
                const messagesEqual = (msgs1, msgs2) => {
                    if (msgs1.length !== msgs2.length) return false;
                    for (let i = 0; i < msgs1.length; i++) {
                        if (msgs1[i].type !== msgs2[i].type || 
                            msgs1[i].content !== msgs2[i].content ||
                            msgs1[i].imageDataUrl !== msgs2[i].imageDataUrl) {
                            return false;
                        }
                    }
                    return true;
                };
                
                messagesChanged = !messagesEqual(existingMessages, messages);
                
                // åªæœ‰åœ¨æ¶ˆæ¯å‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°ï¼ˆå¼ºåˆ¶æ¨¡å¼ä¸‹ä¹Ÿä¼šæ›´æ–°ï¼‰
                if (messagesChanged || force) {
                    session.messages = messages;
                    session.updatedAt = Date.now();
                    hasActualChanges = true;
                    console.log(`ä¼šè¯ ${this.currentSessionId} æ¶ˆæ¯å·²åŒæ­¥ï¼Œå…± ${messages.length} æ¡æ¶ˆæ¯`);
                }
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç™½ä¼šè¯ï¼ˆä¸åº”è¯¥æ›´æ–°é¡µé¢ä¿¡æ¯ï¼‰
        const isBlankSession = session._isBlankSession || 
                              !session.url || 
                              session.url.startsWith('blank-session://');
        
        // åŒæ­¥æ›´æ–°é¡µé¢ä¿¡æ¯ï¼ˆåªæœ‰åœ¨URLåŒ¹é…ä¸”ä¸æ˜¯ç©ºç™½ä¼šè¯æ—¶æ‰æ›´æ–°ï¼Œç¡®ä¿æ•°æ®éš”ç¦»ï¼‰
        // å½“ç”¨æˆ·åˆ‡æ¢åˆ°ä¸åŒURLçš„ä¼šè¯æ—¶ï¼Œä¸ä¼šå½±å“é‚£ä¸ªä¼šè¯çš„é¡µé¢ä¿¡æ¯
        if (isUrlMatched && !isBlankSession) {
            const pageInfoChanged = (
                session.url !== pageInfo.url ||
                session.pageTitle !== pageInfo.title ||
                session.pageDescription !== (pageInfo.description || '') ||
                (!session.pageContent || session.pageContent.trim() === '')
            );
            
            // åªæœ‰åœ¨URLåŒ¹é…ä¸”ä¸æ˜¯ç©ºç™½ä¼šè¯æ—¶ï¼Œæ‰æ›´æ–°é¡µé¢ä¿¡æ¯ï¼ˆç¡®ä¿ä¼šè¯ä¿¡æ¯å®Œæ•´ä¸”éš”ç¦»ï¼‰
            if (pageInfoChanged) {
                if (session.url !== pageInfo.url) {
                    session.url = pageInfo.url;
                    hasActualChanges = true;
                }
                if (session.pageTitle !== pageInfo.title) {
                    session.pageTitle = pageInfo.title;
                    hasActualChanges = true;
                }
                if (session.pageDescription !== (pageInfo.description || '')) {
                    session.pageDescription = pageInfo.description || '';
                    hasActualChanges = true;
                }
                // å¦‚æœ pageContent ç¼ºå¤±ï¼Œåˆ™è¡¥å……ï¼ˆä¿ç•™åŸå§‹å¿«ç…§ï¼Œä½†ç¡®ä¿ä¿¡æ¯å®Œæ•´ï¼‰
                // æ³¨æ„ï¼šç©ºç™½ä¼šè¯ä¸åº”è¯¥å¡«å……é¡µé¢å†…å®¹
                if (!session.pageContent || session.pageContent.trim() === '') {
                    session.pageContent = pageInfo.content || '';
                    hasActualChanges = true;
                }
                
                // å¦‚æœæœ‰å®é™…å˜åŒ–ï¼Œæ›´æ–°æ—¶é—´æˆ³
                if (hasActualChanges && !messagesChanged) {
                    // å¦‚æœæ¶ˆæ¯æœªå˜åŒ–ï¼Œæ›´æ–°æ›´æ–°æ—¶é—´æˆ³
                    session.updatedAt = Date.now();
                }
            }
        } else if (isBlankSession) {
            // ç©ºç™½ä¼šè¯ï¼šåªæ›´æ–°æœ€åè®¿é—®æ—¶é—´ï¼Œä¸æ›´æ–°é¡µé¢ä¿¡æ¯
            console.log(`ä¿å­˜ç©ºç™½ä¼šè¯ ${this.currentSessionId}ï¼šè·³è¿‡é¡µé¢ä¿¡æ¯æ›´æ–°`);
        } else {
            // URLä¸åŒ¹é…æ—¶ï¼Œåªè®°å½•æ—¥å¿—ï¼Œä¸æ›´æ–°é¡µé¢ä¿¡æ¯ï¼ˆä¿æŒæ•°æ®éš”ç¦»ï¼‰
            console.log(`ä¿å­˜ä¼šè¯ ${this.currentSessionId}ï¼šURLä¸åŒ¹é…ï¼Œä¸æ›´æ–°é¡µé¢ä¿¡æ¯ã€‚ä¼šè¯URL: ${session.url}, å½“å‰é¡µé¢URL: ${pageInfo.url}`);
        }
        
        // æ›´æ–°æœ€åè®¿é—®æ—¶é—´ï¼ˆæ¯æ¬¡ä¿å­˜æ—¶éƒ½æ›´æ–°ï¼Œå³ä½¿URLä¸åŒ¹é…ä¹Ÿæ›´æ–°ï¼‰
        const now = Date.now();
        if (!session.lastAccessTime || (now - session.lastAccessTime) > 60000) {
            session.lastAccessTime = now;
            hasActualChanges = true;
        }
        
        // å¼ºåˆ¶ä¿å­˜æ¨¡å¼ï¼šæ— è®ºæ˜¯å¦æœ‰å˜åŒ–éƒ½ä¿å­˜ï¼ˆç”¨äºåˆ‡æ¢ä¼šè¯å‰çš„ä¿å­˜ï¼‰
        // æˆ–è€…æœ‰å®é™…å˜åŒ–æ—¶æ‰ä¿å­˜
        if (hasActualChanges || force) {
            await this.saveAllSessions(force, syncToBackend);
            return true; // è¿”å›trueè¡¨ç¤ºæœ‰å˜åŒ–
        }
        
        return false; // è¿”å›falseè¡¨ç¤ºæ— å˜åŒ–
    }

    // ä»æ¶ˆæ¯å…ƒç´ è·å–æ—¶é—´æˆ³
    getMessageTimestamp(msgEl) {
        const timeEl = msgEl.querySelector('[data-message-time="true"]');
        if (timeEl) {
            const timeText = timeEl.textContent.trim();
            // å°è¯•è§£ææ—¶é—´æˆ³ï¼Œå¦‚æœæ— æ³•è§£æåˆ™ä½¿ç”¨å½“å‰æ—¶é—´
            return Date.now();
        }
        return Date.now();
    }

    // åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯ï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
    // æ³¨æ„ï¼šæ‰‹åŠ¨åˆ‡æ¢ä¼šè¯æ—¶ä¸è°ƒç”¨ session/save æ¥å£
    async switchSession(sessionId) {
        // é˜²æŠ–ï¼šå¦‚æœæ­£åœ¨åˆ‡æ¢æˆ–ç‚¹å‡»çš„æ˜¯å½“å‰ä¼šè¯ï¼Œç›´æ¥è¿”å›
        if (this.isSwitchingSession || sessionId === this.currentSessionId) {
            return;
        }
        
        // æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦æ˜¾ç¤ºä¿å­˜æŒ‰é’®ï¼ˆå¦‚æœæ˜¾ç¤ºï¼Œåˆ™ä¸å…è®¸åˆ‡æ¢ï¼‰
        if (this.currentSessionId) {
            const isInBackendList = await this.isSessionInBackendList(this.currentSessionId);
            if (!isInBackendList) {
                // å½“å‰ä¼šè¯ä¸åœ¨åç«¯åˆ—è¡¨ä¸­ï¼Œæ˜¾ç¤ºä¿å­˜æŒ‰é’®ï¼Œä¸å…è®¸åˆ‡æ¢
                this.showNotification('è¯·å…ˆä¿å­˜å½“å‰ä¼šè¯åå†åˆ‡æ¢', 'warning');
                console.log('å½“å‰ä¼šè¯æœªä¿å­˜ï¼Œé˜»æ­¢åˆ‡æ¢ä¼šè¯');
                return;
            }
        }
        
        // éªŒè¯ä¼šè¯æ˜¯å¦å­˜åœ¨
        if (!this.sessions[sessionId]) {
            console.error('ä¼šè¯ä¸å­˜åœ¨:', sessionId);
            this.showNotification('ä¼šè¯ä¸å­˜åœ¨', 'error');
            return;
        }

        // è®¾ç½®åˆ‡æ¢çŠ¶æ€
        this.isSwitchingSession = true;
        
        // è·å–UIå…ƒç´ å¼•ç”¨
        const clickedItem = this.sessionSidebar?.querySelector(`[data-session-id="${sessionId}"]`);
        const previousActiveItem = this.sessionSidebar?.querySelector('.session-item.active');
        const messagesContainer = this.chatWindow?.querySelector('#pet-chat-messages');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (clickedItem) {
            clickedItem.classList.add('switching');
            if (previousActiveItem && previousActiveItem !== clickedItem) {
                previousActiveItem.classList.remove('active');
            }
        }
        
        // æ·»åŠ æ·¡å‡ºæ•ˆæœ
        if (messagesContainer && this.isChatOpen) {
            messagesContainer.style.opacity = '0.5';
            messagesContainer.style.transition = 'opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
        }
        
        try {
            // ä½¿ç”¨ç»Ÿä¸€çš„æ¿€æ´»ä¼šè¯æ–¹æ³•
            // æ³¨æ„ï¼šsaveCurrentè®¾ä¸ºfalseï¼Œæ‰‹åŠ¨åˆ‡æ¢ä¼šè¯æ—¶ä¸ä¿å­˜å½“å‰ä¼šè¯
            // syncToBackendè®¾ä¸ºfalseï¼Œæ‰‹åŠ¨åˆ‡æ¢ä¼šè¯æ—¶ä¸è°ƒç”¨ session/save æ¥å£
            await this.activateSession(sessionId, {
                saveCurrent: false, // æ‰‹åŠ¨åˆ‡æ¢ä¼šè¯æ—¶ä¸ä¿å­˜ï¼Œé¿å…è°ƒç”¨ session/save æ¥å£
                updateConsistency: true,
                updateUI: false, // ç¨åæ‰‹åŠ¨æ›´æ–°UIä»¥ä¾¿æ·»åŠ è¿‡æ¸¡æ•ˆæœ
                syncToBackend: false // æ‰‹åŠ¨åˆ‡æ¢ä¼šè¯æ—¶ä¸åŒæ­¥åˆ°åç«¯ï¼Œé¿å…è°ƒç”¨ session/save æ¥å£
            });
            
            // æ›´æ–°ä¾§è¾¹æ 
            await new Promise(resolve => {
                requestAnimationFrame(async () => {
                    await this.updateSessionSidebar();
                    resolve();
                });
            });
            
            // åŠ è½½æ¶ˆæ¯å¹¶æ·»åŠ æ·¡å…¥æ•ˆæœï¼ˆç¡®ä¿æ¶ˆæ¯æ­£ç¡®æ¢å¤ï¼‰
            if (this.chatWindow && this.isChatOpen) {
                // å…ˆç¡®ä¿ä¼šè¯æ•°æ®å·²åŠ è½½
                if (!this.sessions[sessionId]) {
                    await this.loadAllSessions();
                }
                
                // åŠ è½½ä¼šè¯æ¶ˆæ¯ï¼ˆç¡®ä¿æ¶ˆæ¯ä¸ä¼šè¯ä¸€ä¸€å¯¹åº”ï¼‰
                await this.loadSessionMessages();
                
                // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜ï¼ˆæ˜¾ç¤ºå½“å‰ä¼šè¯åç§°ï¼‰
                this.updateChatHeaderTitle();
                
                // éªŒè¯æ¶ˆæ¯æ˜¯å¦å·²æ­£ç¡®åŠ è½½
                const loadedMessagesCount = messagesContainer?.querySelectorAll('[data-message-type="user-bubble"], [data-message-type="pet-bubble"]:not([data-welcome-message])').length || 0;
                const sessionMessagesCount = this.sessions[sessionId]?.messages?.length || 0;
                console.log(`ä¼šè¯åˆ‡æ¢å®Œæˆï¼Œå·²åŠ è½½ ${loadedMessagesCount} æ¡æ¶ˆæ¯ï¼ˆä¼šè¯ä¸­å­˜å‚¨äº† ${sessionMessagesCount} æ¡ï¼‰`);
                
                requestAnimationFrame(() => {
                    if (messagesContainer) {
                        messagesContainer.style.opacity = '1';
                    }
                });
            }
        } catch (error) {
            console.error('åˆ‡æ¢ä¼šè¯æ—¶å‡ºé”™:', error);
            
            // æ¢å¤UIçŠ¶æ€
            if (previousActiveItem) {
                previousActiveItem.classList.add('active');
            }
            if (clickedItem) {
                clickedItem.classList.remove('switching');
            }
            if (messagesContainer) {
                messagesContainer.style.opacity = '1';
            }
            
            this.showNotification('åˆ‡æ¢ä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            throw error;
        } finally {
            // æ¸…é™¤åŠ è½½çŠ¶æ€
            if (clickedItem) {
                clickedItem.classList.remove('switching');
            }
            this.isSwitchingSession = false;
        }
    }

    // åŠ è½½å½“å‰ä¼šè¯çš„æ¶ˆæ¯ï¼ˆç¡®ä¿æ¶ˆæ¯ä¸ä¼šè¯ä¸€ä¸€å¯¹åº”ï¼‰
    async loadSessionMessages() {
        if (!this.chatWindow || !this.currentSessionId) {
            console.warn('æ— æ³•åŠ è½½æ¶ˆæ¯ï¼šèŠå¤©çª—å£æˆ–ä¼šè¯IDä¸å­˜åœ¨');
            return;
        }
        
        const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
        if (!messagesContainer) {
            console.warn('æ— æ³•åŠ è½½æ¶ˆæ¯ï¼šæ¶ˆæ¯å®¹å™¨ä¸å­˜åœ¨');
            return;
        }
        
        // è·å–å½“å‰ä¼šè¯æ•°æ®
        const session = this.sessions[this.currentSessionId];
        if (!session) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•åŠ è½½æ¶ˆæ¯:', this.currentSessionId);
            return;
        }
        
        console.log(`åŠ è½½ä¼šè¯ ${this.currentSessionId} çš„æ¶ˆæ¯ï¼Œå…± ${session.messages?.length || 0} æ¡`);
        
        // æ¸…ç©ºç°æœ‰æ¶ˆæ¯ï¼ˆç¡®ä¿å¹²å‡€çš„åŠ è½½çŠ¶æ€ï¼‰
        messagesContainer.innerHTML = '';
        
        // åˆ›å»ºæ¬¢è¿æ¶ˆæ¯ï¼ˆä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢ä¿¡æ¯ï¼‰
        const pageInfo = {
            title: session.pageTitle || document.title || 'å½“å‰é¡µé¢',
            url: session.url || window.location.href,
            description: session.pageDescription || ''
        };
        await this.createWelcomeMessage(messagesContainer, pageInfo);
        
        // ç¡®ä¿æ¬¢è¿æ¶ˆæ¯çš„æŒ‰é’®å®¹å™¨å­˜åœ¨å¹¶åˆ·æ–°è§’è‰²æŒ‰é’®
        // å¦‚æœæŒ‰é’®å®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ä»¥ç¡®ä¿ refreshWelcomeActionButtons èƒ½æ­£å¸¸å·¥ä½œ
        setTimeout(async () => {
            let welcomeActionsContainer = this.chatWindow.querySelector('#pet-welcome-actions');
            if (!welcomeActionsContainer) {
                // å¦‚æœæŒ‰é’®å®¹å™¨ä¸å­˜åœ¨ï¼Œæ‰¾åˆ°æ¬¢è¿æ¶ˆæ¯çš„æ—¶é—´å®¹å™¨å¹¶åˆ›å»ºæŒ‰é’®å®¹å™¨
                const welcomeMessage = messagesContainer.querySelector('[data-welcome-message]');
                if (welcomeMessage) {
                    let messageTime = welcomeMessage.querySelector('[data-message-time]');
                    if (messageTime) {
                        // æ£€æŸ¥ messageTime æ˜¯å¦åœ¨ messageTimeWrapper ä¸­ï¼Œå¦‚æœæ˜¯ï¼Œä½¿ç”¨ messageTimeWrapper
                        // å› ä¸º createMessageElement ä¼šåˆ›å»º messageTimeWrapper åŒ…è£¹ messageTime
                        const messageTimeWrapper = messageTime.parentElement;
                        let targetContainer = messageTime;
                        
                        // å¦‚æœ messageTime æœ‰çˆ¶å®¹å™¨ä¸”çˆ¶å®¹å™¨æ˜¯ messageTimeWrapperï¼Œä½¿ç”¨ messageTime æœ¬èº«
                        // ä½†éœ€è¦æ£€æŸ¥çˆ¶å®¹å™¨çš„ç»“æ„
                        const timeAndCopyContainer = messageTimeWrapper?.parentElement;
                        if (timeAndCopyContainer && timeAndCopyContainer.querySelector('[data-copy-button-container]')) {
                            // è¿™æ˜¯æ ‡å‡†çš„æ¶ˆæ¯ç»“æ„ï¼ŒmessageTime åœ¨ messageTimeWrapper ä¸­
                            // æˆ‘ä»¬éœ€è¦ä¿®æ”¹ messageTime çš„æ ·å¼ï¼Œä½¿å…¶æˆä¸º flex å®¹å™¨
                            targetContainer = messageTime;
                        }
                        
                        // åˆ›å»ºæŒ‰é’®å®¹å™¨ï¼ˆä¸ createChatWindow ä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
                        // å°†æŒ‰é’®ç›´æ¥æ·»åŠ åˆ° data-message-time å…ƒç´ ä¸­ï¼Œå’Œæ—¶é—´åŒä¸€è¡Œ
                        // é¦–å…ˆç¡®ä¿ messageTime æ˜¯ flex å¸ƒå±€
                        targetContainer.style.cssText = `
                            display: flex !important;
                            justify-content: space-between !important;
                            align-items: center !important;
                            font-size: 11px !important;
                            color: #999 !important;
                            margin-top: 4px !important;
                            max-width: 100% !important;
                            width: 100% !important;
                        `;
                        
                        // å¦‚æœ targetContainer æ²¡æœ‰æ—¶é—´æ–‡æœ¬ï¼Œåˆ›å»ºä¸€ä¸ª
                        let timeText = targetContainer.querySelector('span');
                        if (!timeText) {
                            timeText = document.createElement('span');
                            timeText.style.cssText = 'flex: 1 !important; min-width: 0 !important;';
                            timeText.textContent = this.getCurrentTime();
                            // å¦‚æœ targetContainer æœ‰æ–‡æœ¬å†…å®¹ï¼Œå…ˆæ¸…é™¤
                            if (targetContainer.textContent.trim()) {
                                const originalText = targetContainer.textContent.trim();
                                targetContainer.innerHTML = '';
                                timeText.textContent = originalText || this.getCurrentTime();
                            }
                            targetContainer.appendChild(timeText);
                        }
                        
                        // åˆ›å»ºæŒ‰é’®å®¹å™¨
                        const actionsGroup = document.createElement('div');
                        actionsGroup.id = 'pet-welcome-actions';
                        actionsGroup.style.cssText = `
                            display: inline-flex !important;
                            align-items: center !important;
                            gap: 8px !important;
                            flex-shrink: 0 !important;
                        `;
                        
                        const actionsWrapper = document.createElement('div');
                        actionsWrapper.style.cssText = `
                            position: relative !important;
                            display: inline-flex !important;
                            align-items: center !important;
                            gap: 8px !important;
                        `;
                        actionsWrapper.appendChild(actionsGroup);
                        targetContainer.appendChild(actionsWrapper);
                    }
                }
            }
            // åˆ·æ–°è§’è‰²æŒ‰é’®ï¼ˆç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„è§’è‰²åˆ—è¡¨ï¼‰
            await this.refreshWelcomeActionButtons();
            
        }, 150);
        
        // åŠ è½½ä¼šè¯æ¶ˆæ¯ï¼ˆç¡®ä¿æ¶ˆæ¯é¡ºåºå’Œå†…å®¹æ­£ç¡®ï¼‰
        if (session.messages && Array.isArray(session.messages) && session.messages.length > 0) {
            // å…ˆä½¿ç”¨ DocumentFragment æ‰¹é‡æ·»åŠ æ¶ˆæ¯ï¼Œæé«˜æ€§èƒ½
            const fragment = document.createDocumentFragment();
            const petMessages = []; // ä¿å­˜æ‰€æœ‰å® ç‰©æ¶ˆæ¯ï¼Œç”¨äºåç»­æ·»åŠ æŒ‰é’®
            const userMessages = []; // ä¿å­˜æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œç”¨äºåç»­æ·»åŠ æŒ‰é’®
            let isFirstPetMessage = true; // æ ‡è®°æ˜¯å¦æ˜¯ç¬¬ä¸€æ¡å® ç‰©æ¶ˆæ¯
            
            for (const msg of session.messages) {
                // éªŒè¯æ¶ˆæ¯æ ¼å¼ï¼šå¿…é¡»æœ‰ç±»å‹ï¼Œå¹¶ä¸”æœ‰å†…å®¹æˆ–å›¾ç‰‡
                if (!msg || !msg.type || (!msg.content && !msg.imageDataUrl)) {
                    console.warn('è·³è¿‡æ— æ•ˆæ¶ˆæ¯:', msg);
                    continue;
                }
                
                // ä½¿ç”¨æ¶ˆæ¯ä¿å­˜çš„æ—¶é—´æˆ³ï¼ˆå¦‚æœæœ‰ï¼‰
                const timestamp = msg.timestamp || null;
                
                // è·å–å›¾ç‰‡æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
                const imageDataUrl = msg.imageDataUrl || null;
                
                if (msg.type === 'pet') {
                    isFirstPetMessage = false;
                }
                
                const msgEl = this.createMessageElement(msg.content || '', msg.type, imageDataUrl, timestamp);
                fragment.appendChild(msgEl);
                
                // å¦‚æœæ˜¯å® ç‰©æ¶ˆæ¯ï¼Œæ¸²æŸ“ Markdown
                if (msg.type === 'pet') {
                    const petBubble = msgEl.querySelector('[data-message-type="pet-bubble"]');
                    if (petBubble) {
                        petBubble.innerHTML = this.renderMarkdown(msg.content);
                        petBubble.setAttribute('data-original-text', msg.content);
                        
                        // ä¿å­˜å® ç‰©æ¶ˆæ¯å¼•ç”¨ï¼Œç”¨äºåç»­æ·»åŠ æŒ‰é’®
                        petMessages.push(msgEl);
                        
                        // å¤„ç† Mermaid å›¾è¡¨ï¼ˆå¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡å…¶ä»–æ¶ˆæ¯æ¸²æŸ“ï¼‰
                        this.processMermaidBlocks(petBubble).catch(err => {
                            console.error('å¤„ç† Mermaid å›¾è¡¨å¤±è´¥:', err);
                        });
                    }
                } else if (msg.type === 'user') {
                    // æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯ï¼ˆä½¿ç”¨ Markdown æ¸²æŸ“ï¼Œä¸ pet æ¶ˆæ¯ä¸€è‡´ï¼‰
                    const userBubble = msgEl.querySelector('[data-message-type="user-bubble"]');
                    if (userBubble) {
                        // å¦‚æœæœ‰å›¾ç‰‡ï¼Œå…ˆæ·»åŠ å›¾ç‰‡å…ƒç´ 
                        if (imageDataUrl) {
                            const imageContainer = document.createElement('div');
                            imageContainer.style.cssText = `
                                margin-bottom: ${msg.content ? '8px' : '0'} !important;
                                border-radius: 8px !important;
                                overflow: hidden !important;
                                max-width: 100% !important;
                                width: 100% !important;
                            `;

                            const img = document.createElement('img');
                            img.src = imageDataUrl;
                            img.style.cssText = `
                                max-width: 100% !important;
                                width: 100% !important;
                                height: auto !important;
                                max-height: 300px !important;
                                border-radius: 8px !important;
                                display: block !important;
                                cursor: pointer !important;
                                object-fit: contain !important;
                            `;

                            // ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
                            img.addEventListener('click', () => {
                                this.showImagePreview(imageDataUrl);
                            });

                            imageContainer.appendChild(img);
                            userBubble.innerHTML = '';
                            userBubble.appendChild(imageContainer);
                        } else {
                            userBubble.innerHTML = '';
                        }
                        
                        // å¦‚æœæœ‰æ–‡æœ¬å†…å®¹ï¼Œæ·»åŠ æ–‡æœ¬
                        if (msg.content) {
                            const displayText = this.renderMarkdown(msg.content);
                            if (imageDataUrl) {
                                // å¦‚æœå·²ç»æ·»åŠ äº†å›¾ç‰‡ï¼Œåˆ™è¿½åŠ æ–‡æœ¬
                                const textSpan = document.createElement('span');
                                textSpan.innerHTML = displayText;
                                userBubble.appendChild(textSpan);
                            } else {
                                userBubble.innerHTML = displayText;
                            }
                        } else if (imageDataUrl) {
                            // å¦‚æœæ²¡æœ‰æ–‡æœ¬åªæœ‰å›¾ç‰‡ï¼Œä¿æŒå®¹å™¨ä¸ºç©º
                            userBubble.style.padding = '0';
                        }
                        
                        userBubble.setAttribute('data-original-text', msg.content || '');
                        userBubble.classList.add('markdown-content');
                        
                        // å¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨
                        this.processMermaidBlocks(userBubble).catch(err => {
                            console.error('å¤„ç†ç”¨æˆ·æ¶ˆæ¯çš„ Mermaid å›¾è¡¨å¤±è´¥:', err);
                        });
                    }
                    // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å¼•ç”¨ï¼Œç”¨äºåç»­æ·»åŠ æŒ‰é’®
                    userMessages.push(msgEl);
                }
            }
            
            // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰æ¶ˆæ¯
            messagesContainer.appendChild(fragment);
            
            // ä¸ºæ‰€æœ‰æ¶ˆæ¯æ·»åŠ æŒ‰é’®ï¼ˆå¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡æ¸²æŸ“ï¼‰
            // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å®Œå…¨æ›´æ–°åå†æ·»åŠ æŒ‰é’®
            setTimeout(async () => {
                // ä¸ºå® ç‰©æ¶ˆæ¯æ·»åŠ æŒ‰é’®
                for (const petMsg of petMessages) {
                    try {
                        const petBubble = petMsg.querySelector('[data-message-type="pet-bubble"]');
                        if (!petBubble) continue;
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ¬¢è¿æ¶ˆæ¯ï¼ˆç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰ï¼Œæ¬¢è¿æ¶ˆæ¯ä¸éœ€è¦æ·»åŠ æŒ‰é’®
                        const isWelcome = petMsg.hasAttribute('data-welcome-message');
                        if (isWelcome) continue;
                        
                        // æ·»åŠ å¤åˆ¶æŒ‰é’®ï¼ˆç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®ï¼‰
                        const copyButtonContainer = petMsg.querySelector('[data-copy-button-container]');
                        if (copyButtonContainer) {
                            // å¦‚æœè¿˜æ²¡æœ‰å¤åˆ¶æŒ‰é’®ï¼Œå°±æ·»åŠ ï¼ˆåŒ…æ‹¬å¤åˆ¶ã€ç¼–è¾‘ã€åˆ é™¤æŒ‰é’®ï¼‰
                            if (!copyButtonContainer.querySelector('.copy-button')) {
                                this.addCopyButton(copyButtonContainer, petBubble);
                            }
                        }
                        
                        // ä¸ºå® ç‰©æ¶ˆæ¯æ·»åŠ å¯¼å‡ºæŒ‰é’®
                        if (copyButtonContainer) {
                            this.addExportButtonForMessage(copyButtonContainer, petMsg, 'pet');
                        }
                        
                        // æ·»åŠ é‡è¯•æŒ‰é’®ï¼ˆä»…å½“ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¡å® ç‰©æ¶ˆæ¯
                        const allPetMessages = Array.from(messagesContainer.children).filter(
                            child => child.querySelector('[data-message-type="pet-bubble"]') && 
                            !child.hasAttribute('data-welcome-message')
                        );
                        
                        if (allPetMessages.length > 0) {
                            const tryAgainContainer = petMsg.querySelector('[data-try-again-button-container]');
                            if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                // æ£€æŸ¥æ˜¯å¦æ˜¯æŒ‰é’®æ“ä½œç”Ÿæˆçš„æ¶ˆæ¯ï¼Œä¸æ·»åŠ é‡è¯•æŒ‰é’®
                                if (!petMsg.hasAttribute('data-button-action')) {
                                    this.addTryAgainButton(tryAgainContainer, petMsg);
                                }
                            }
                        }
                        
                        // æ·»åŠ åŠ¨ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬è§’è‰²æŒ‰é’®å’Œè®¾ç½®æŒ‰é’®ï¼‰
                        await this.addActionButtonsToMessage(petMsg);
                        
                        // ä¸ºå® ç‰©æ¶ˆæ¯æ·»åŠ æ’åºæŒ‰é’®
                        if (copyButtonContainer) {
                            this.addSortButtons(copyButtonContainer, petMsg);
                        }
                    } catch (error) {
                        console.error('ä¸ºæ¶ˆæ¯æ·»åŠ æŒ‰é’®æ—¶å‡ºé”™:', error);
                    }
                }
                
                // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ æŒ‰é’®
                for (const userMsg of userMessages) {
                    try {
                        // ç¡®ä¿copyButtonContainerå­˜åœ¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼ŒaddActionButtonsToMessageä¼šåˆ›å»ºå®ƒï¼‰
                        // æ·»åŠ åŠ¨ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬æœºå™¨äººæŒ‰é’®ï¼‰
                        await this.addActionButtonsToMessage(userMsg);
                        
                        // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ å¤åˆ¶æŒ‰é’®
                        const userBubble = userMsg.querySelector('[data-message-type="user-bubble"]');
                        let copyButtonContainer = userMsg.querySelector('[data-copy-button-container]');
                        
                        // å¦‚æœcopyButtonContainerä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»ºå®ƒ
                        if (!copyButtonContainer && userBubble) {
                            // æŸ¥æ‰¾ç”¨æˆ·æ¶ˆæ¯çš„contentå®¹å™¨
                            const content = userMsg.querySelector('div[style*="flex: 1"]') || 
                                           userMsg.querySelector('div:last-child');
                            if (content) {
                                // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰timeAndCopyContainer
                                let timeAndCopyContainer = content.querySelector('div[style*="justify-content: space-between"]');
                                if (!timeAndCopyContainer) {
                                    // åˆ›å»ºtimeAndCopyContainer
                                    timeAndCopyContainer = document.createElement('div');
                                    timeAndCopyContainer.style.cssText = `
                                        display: flex !important;
                                        align-items: center !important;
                                        justify-content: space-between !important;
                                        max-width: 80% !important;
                                        width: 100% !important;
                                        margin-top: 4px !important;
                                        margin-left: auto !important;
                                        box-sizing: border-box !important;
                                    `;
                                    content.appendChild(timeAndCopyContainer);
                                }
                                
                                // åˆ›å»ºcopyButtonContainer
                                copyButtonContainer = document.createElement('div');
                                copyButtonContainer.setAttribute('data-copy-button-container', 'true');
                                copyButtonContainer.style.cssText = 'display: flex;';
                                timeAndCopyContainer.insertBefore(copyButtonContainer, timeAndCopyContainer.firstChild);
                            }
                        }
                        
                        if (copyButtonContainer && userBubble && !copyButtonContainer.querySelector('.copy-button')) {
                            this.addCopyButton(copyButtonContainer, userBubble);
                        }
                        
                        // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ é™¤ã€ç¼–è¾‘å’Œé‡æ–°å‘é€æŒ‰é’®
                        if (copyButtonContainer && userBubble) {
                            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™äº›æŒ‰é’®ï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æŒ‰é’®ï¼‰
                            if (!copyButtonContainer.querySelector('.delete-button')) {
                                this.addDeleteButtonForUserMessage(copyButtonContainer, userBubble);
                            }
                        }
                        
                        // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ æ’åºæŒ‰é’®
                        if (copyButtonContainer) {
                            this.addSortButtons(copyButtonContainer, userMsg);
                        }
                        
                        // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ å¯¼å‡ºæŒ‰é’®
                        if (copyButtonContainer) {
                            this.addExportButtonForMessage(copyButtonContainer, userMsg, 'user');
                        }
                    } catch (error) {
                        console.error('ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ æŒ‰é’®æ—¶å‡ºé”™:', error);
                    }
                }
                
                
                // ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM æ›´æ–°å®Œæˆåå†æ»šåŠ¨
            requestAnimationFrame(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        } else {
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
            requestAnimationFrame(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }
    }

    // ä»æœ¬åœ° sessions å¯¹è±¡è·å–ä¼šè¯åˆ—è¡¨ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
    _getSessionsFromLocal() {
        // ç¡®ä¿ sessions å¯¹è±¡å·²åˆå§‹åŒ–
        if (!this.sessions) {
            this.sessions = {};
            return [];
        }
        
        // è·å–æ‰€æœ‰ä¼šè¯å¹¶å»é‡ï¼ˆæŒ‰ id å»é‡ï¼Œä¿ç•™ updatedAt æœ€æ–°çš„ï¼‰
        const sessionMap = new Map();
        for (const session of Object.values(this.sessions)) {
            if (!session || !session.id) {
                continue;
            }
            
            const sessionId = session.id;
            const existingSession = sessionMap.get(sessionId);
            
            if (!existingSession) {
                // å¦‚æœä¸å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ 
                sessionMap.set(sessionId, session);
            } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œæ¯”è¾ƒ updatedAtï¼Œä¿ç•™æ›´æ–°çš„ç‰ˆæœ¬
                const existingUpdatedAt = existingSession.updatedAt || existingSession.createdAt || 0;
                const currentUpdatedAt = session.updatedAt || session.createdAt || 0;
                
                if (currentUpdatedAt > existingUpdatedAt) {
                    sessionMap.set(sessionId, session);
                }
            }
        }
        
        return Array.from(sessionMap.values());
    }

    // æ›´æ–°ä¼šè¯ä¾§è¾¹æ 
    // åŠ è½½æ ‡ç­¾é¡ºåº
    loadTagOrder() {
        try {
            const savedOrder = localStorage.getItem('pet_session_tag_order');
            if (savedOrder) {
                this.tagOrder = JSON.parse(savedOrder);
            } else {
                this.tagOrder = null;
            }
        } catch (error) {
            console.warn('åŠ è½½æ ‡ç­¾é¡ºåºå¤±è´¥:', error);
            this.tagOrder = null;
        }
    }

    // ä¿å­˜æ ‡ç­¾é¡ºåº
    saveTagOrder(tagOrder) {
        try {
            localStorage.setItem('pet_session_tag_order', JSON.stringify(tagOrder));
            this.tagOrder = tagOrder;
        } catch (error) {
            console.warn('ä¿å­˜æ ‡ç­¾é¡ºåºå¤±è´¥:', error);
        }
    }

    // æ”¶é›†æ‰€æœ‰ä¼šè¯çš„æ ‡ç­¾
    getAllTags() {
        // ä½¿ç”¨ä¸updateSessionSidebarç›¸åŒçš„è¿‡æ»¤é€»è¾‘ï¼Œç¡®ä¿åªä»å½“å‰å¯è§çš„ä¼šè¯ä¸­æå–æ ‡ç­¾
        let allSessions = this._getSessionsFromLocal();
        
        // æ’é™¤OSSæ–‡ä»¶ä¼šè¯
        allSessions = allSessions.filter(session => {
            return !session._isOssFileSession;
        });
        
        // æ’é™¤ä¸æ–‡ä»¶åˆ—è¡¨ä¸­å…·æœ‰ç›¸åŒurlçš„ä¼šè¯
        if (this.ossFileManager) {
            const files = this.ossFileManager.getAllFiles();
            const fileUrls = new Set(files.map(file => file.url).filter(url => url));
            allSessions = allSessions.filter(session => {
                const sessionUrl = session.url;
                return !sessionUrl || !fileUrls.has(sessionUrl);
            });
        }
        
        // ä»è¿‡æ»¤åçš„ä¼šè¯ä¸­æå–æ ‡ç­¾
        const tagSet = new Set();
        allSessions.forEach(session => {
            if (session.tags && Array.isArray(session.tags)) {
                session.tags.forEach(tag => {
                    if (tag && tag.trim()) {
                        tagSet.add(tag.trim());
                    }
                });
            }
        });
        
        const allTags = Array.from(tagSet);
        
        // å¦‚æœå·²ä¿å­˜æ ‡ç­¾é¡ºåºï¼Œä½¿ç”¨ä¿å­˜çš„é¡ºåº
        if (this.tagOrder && Array.isArray(this.tagOrder)) {
            // æŒ‰ä¿å­˜çš„é¡ºåºæ’åºï¼Œæ–°æ ‡ç­¾è¿½åŠ åˆ°æœ«å°¾
            const orderedTags = [];
            const unorderedTags = [];
            
            // å…ˆæ·»åŠ å·²æ’åºçš„æ ‡ç­¾ï¼ˆæŒ‰ä¿å­˜çš„é¡ºåºï¼‰
            this.tagOrder.forEach(tag => {
                if (allTags.includes(tag)) {
                    orderedTags.push(tag);
                }
            });
            
            // æ·»åŠ æœªæ’åºçš„æ–°æ ‡ç­¾ï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰
            allTags.forEach(tag => {
                if (!this.tagOrder.includes(tag)) {
                    unorderedTags.push(tag);
                }
            });
            unorderedTags.sort();
            
            return [...orderedTags, ...unorderedTags];
        }
        
        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é¡ºåºï¼Œä½¿ç”¨é»˜è®¤ä¼˜å…ˆæ ‡ç­¾åˆ—è¡¨
        const priorityTags = ['ç½‘æ–‡', 'æ–‡æ¡£', 'å·¥å…·', 'å·¥ä½œ', 'å®¶åº­', 'å¨±ä¹', 'æ—¥è®°', 'å¼€æºé¡¹ç›®'];
        const priorityTagSet = new Set(priorityTags);
        const priorityTagList = [];
        const otherTags = [];
        
        // å…ˆæ·»åŠ å­˜åœ¨çš„ä¼˜å…ˆæ ‡ç­¾ï¼ˆæŒ‰é¡ºåºï¼‰
        priorityTags.forEach(tag => {
            if (allTags.includes(tag)) {
                priorityTagList.push(tag);
            }
        });
        
        // æ·»åŠ å…¶ä»–æ ‡ç­¾ï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰
        allTags.forEach(tag => {
            if (!priorityTagSet.has(tag)) {
                otherTags.push(tag);
            }
        });
        otherTags.sort();
        
        // åˆå¹¶ï¼šä¼˜å…ˆæ ‡ç­¾åœ¨å‰ï¼Œå…¶ä»–æ ‡ç­¾åœ¨å
        return [...priorityTagList, ...otherTags];
    }

    // æ”¶é›†æ‰€æœ‰è¯·æ±‚æ¥å£çš„æ ‡ç­¾
    // @param {boolean} useFilteredRequests - æ˜¯å¦ä½¿ç”¨è¿‡æ»¤åçš„è¯·æ±‚åˆ—è¡¨ï¼ˆé»˜è®¤falseï¼Œè·å–æ‰€æœ‰æ ‡ç­¾ï¼‰
    getAllApiRequestTags(useFilteredRequests = false) {
        if (!this.apiRequestManager) {
            return [];
        }
        
        // æ ¹æ®å‚æ•°å†³å®šä½¿ç”¨æ‰€æœ‰è¯·æ±‚è¿˜æ˜¯è¿‡æ»¤åçš„è¯·æ±‚
        let requests = useFilteredRequests ? this._getFilteredApiRequests() : this.apiRequestManager.getAllRequests();
        
        // ç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½æœ‰åŸŸåæ ‡ç­¾ï¼ˆä¸ºæ—§è¯·æ±‚è‡ªåŠ¨æ·»åŠ ï¼‰
        // è¿™ä¸ _getFilteredApiRequests() ä¸­çš„é€»è¾‘ä¿æŒä¸€è‡´ï¼Œç¡®ä¿æ ‡ç­¾ç»Ÿè®¡æ­£ç¡®
        requests.forEach(req => {
            if (req.url) {
                // å¦‚æœè¯·æ±‚è¿˜æ²¡æœ‰tagså­—æ®µï¼Œæˆ–è€…tagsä¸ºç©ºï¼Œåˆ™æ·»åŠ åŸŸåæ ‡ç­¾
                if (!req.tags || !Array.isArray(req.tags) || req.tags.length === 0) {
                    const domain = this.apiRequestManager._extractDomain(req.url);
                    if (domain) {
                        req.tags = [domain];
                    }
                } else {
                    // å¦‚æœå·²æœ‰æ ‡ç­¾ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«åŸŸåæ ‡ç­¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ 
                    const domain = this.apiRequestManager._extractDomain(req.url);
                    if (domain && !req.tags.includes(domain)) {
                        req.tags.push(domain);
                    }
                }
            }
        });
        
        const tagSet = new Set();
        
        requests.forEach(request => {
            if (request.tags && Array.isArray(request.tags)) {
                request.tags.forEach(tag => {
                    if (tag && tag.trim()) {
                        tagSet.add(tag.trim());
                    }
                });
            }
        });
        
        // è¯·æ±‚æ¥å£æ ‡ç­¾æŒ‰å­—æ¯é¡ºåºæ’åºï¼ˆåŸŸåæ ‡ç­¾é€šå¸¸ä¸éœ€è¦ä¼˜å…ˆçº§ï¼‰
        const allTags = Array.from(tagSet);
        allTags.sort();
        
        return allTags;
    }

    // æ”¶é›†æ‰€æœ‰æ–°é—»çš„æ ‡ç­¾
    getAllNewsTags() {
        if (!this.newsManager) {
            return [];
        }
        
        const allNews = this.newsManager.getAllNews();
        const tagSet = new Set();
        
        allNews.forEach(news => {
            if (news.tags && Array.isArray(news.tags)) {
                news.tags.forEach(tag => {
                    if (tag && tag.trim()) {
                        tagSet.add(tag.trim());
                    }
                });
            }
        });
        
        // ä¼˜å…ˆæ ‡ç­¾åˆ—è¡¨ï¼ˆæŒ‰é¡ºåºï¼‰
        const priorityTags = ['ç½‘æ–‡', 'æ–‡æ¡£', 'å·¥å…·', 'å·¥ä½œ', 'å®¶åº­', 'å¨±ä¹', 'æ—¥è®°', 'å¼€æºé¡¹ç›®'];
        
        // åˆ†ç¦»ä¼˜å…ˆæ ‡ç­¾å’Œå…¶ä»–æ ‡ç­¾
        const allTags = Array.from(tagSet);
        const priorityTagSet = new Set(priorityTags);
        const priorityTagList = [];
        const otherTags = [];
        
        // å…ˆæ·»åŠ å­˜åœ¨çš„ä¼˜å…ˆæ ‡ç­¾ï¼ˆæŒ‰é¡ºåºï¼‰
        priorityTags.forEach(tag => {
            if (allTags.includes(tag)) {
                priorityTagList.push(tag);
            }
        });
        
        // æ·»åŠ å…¶ä»–æ ‡ç­¾ï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰
        allTags.forEach(tag => {
            if (!priorityTagSet.has(tag)) {
                otherTags.push(tag);
            }
        });
        otherTags.sort();
        
        // åˆå¹¶ï¼šä¼˜å…ˆæ ‡ç­¾åœ¨å‰ï¼Œå…¶ä»–æ ‡ç­¾åœ¨å
        return [...priorityTagList, ...otherTags];
    }

    getAllOssTags() {
        if (!this.ossFileManager) {
            return [];
        }
        
        const allFiles = this.ossFileManager.getAllFiles();
        const tagSet = new Set();
        
        allFiles.forEach(file => {
            if (file.tags && Array.isArray(file.tags)) {
                file.tags.forEach(tag => {
                    if (tag && tag.trim()) {
                        tagSet.add(tag.trim());
                    }
                });
            }
        });
        
        // ä¼˜å…ˆæ ‡ç­¾åˆ—è¡¨ï¼ˆæŒ‰é¡ºåºï¼Œä¸æ–°é—»åˆ—è¡¨ä¿æŒä¸€è‡´ï¼‰
        const priorityTags = ['ç½‘æ–‡', 'æ–‡æ¡£', 'å·¥å…·', 'å·¥ä½œ', 'å®¶åº­', 'å¨±ä¹', 'æ—¥è®°', 'å¼€æºé¡¹ç›®'];
        
        // åˆ†ç¦»ä¼˜å…ˆæ ‡ç­¾å’Œå…¶ä»–æ ‡ç­¾
        const allTags = Array.from(tagSet);
        const priorityTagSet = new Set(priorityTags);
        const priorityTagList = [];
        const otherTags = [];
        
        // å…ˆæ·»åŠ å­˜åœ¨çš„ä¼˜å…ˆæ ‡ç­¾ï¼ˆæŒ‰é¡ºåºï¼‰
        priorityTags.forEach(tag => {
            if (allTags.includes(tag)) {
                priorityTagList.push(tag);
            }
        });
        
        // æ·»åŠ å…¶ä»–æ ‡ç­¾ï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰
        allTags.forEach(tag => {
            if (!priorityTagSet.has(tag)) {
                otherTags.push(tag);
            }
        });
        otherTags.sort();
        
        // åˆå¹¶ï¼šä¼˜å…ˆæ ‡ç­¾åœ¨å‰ï¼Œå…¶ä»–æ ‡ç­¾åœ¨å
        return [...priorityTagList, ...otherTags];
    }

    // è·å–ä¼šè¯çš„æ˜¾ç¤ºæ ‡é¢˜ï¼ˆç”¨äºè¿‡æ»¤å’Œæ˜¾ç¤ºï¼‰
    _getSessionDisplayTitle(session) {
        if (!session) return 'æœªå‘½åä¼šè¯';
        
        // ä¼˜å…ˆä½¿ç”¨ä¼šè¯çš„ pageTitle
        let sessionTitle = session.pageTitle || 'æœªå‘½åä¼šè¯';
        
        // å¦‚æœæ˜¯ç©ºç™½ä¼šè¯ä¸”æ ‡é¢˜æ˜¯é»˜è®¤å€¼ï¼Œå°è¯•ç”Ÿæˆæ›´å‹å¥½çš„æ ‡é¢˜
        if (session._isBlankSession || (session.url && session.url.startsWith('blank-session://'))) {
            if (!session.pageTitle || session.pageTitle === 'æ–°ä¼šè¯' || session.pageTitle === 'æœªå‘½åä¼šè¯') {
                // å¦‚æœæœ‰æ¶ˆæ¯ï¼Œä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„å‰å‡ ä¸ªå­—
                if (session.messages && session.messages.length > 0) {
                    const firstUserMessage = session.messages.find(m => m.type === 'user');
                    if (firstUserMessage && firstUserMessage.content) {
                        const content = firstUserMessage.content.trim();
                        const preview = content.length > 30 ? content.substring(0, 30) + '...' : content;
                        sessionTitle = preview;
                    } else {
                        // æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œä½¿ç”¨åˆ›å»ºæ—¶é—´
                        const createDate = new Date(session.createdAt || Date.now());
                        const month = String(createDate.getMonth() + 1).padStart(2, '0');
                        const day = String(createDate.getDate()).padStart(2, '0');
                        const hour = String(createDate.getHours()).padStart(2, '0');
                        const minute = String(createDate.getMinutes()).padStart(2, '0');
                        sessionTitle = `${month}-${day} ${hour}:${minute}`;
                    }
                } else {
                    // æ²¡æœ‰æ¶ˆæ¯ï¼Œä½¿ç”¨åˆ›å»ºæ—¶é—´
                    const createDate = new Date(session.createdAt || Date.now());
                    const month = String(createDate.getMonth() + 1).padStart(2, '0');
                    const day = String(createDate.getDate()).padStart(2, '0');
                    const hour = String(createDate.getHours()).padStart(2, '0');
                    const minute = String(createDate.getMinutes()).padStart(2, '0');
                    sessionTitle = `${month}-${day} ${hour}:${minute}`;
                }
            }
        }
        
        return sessionTitle;
    }

    // è·å–ç­›é€‰åçš„ä¼šè¯åˆ—è¡¨
    _getFilteredSessions() {
        let allSessions = this._getSessionsFromLocal();
        
        // æ’é™¤OSSæ–‡ä»¶ä¼šè¯
        allSessions = allSessions.filter(session => {
            return !session._isOssFileSession;
        });
        
        // æ’é™¤ä¸æ–‡ä»¶åˆ—è¡¨ä¸­å…·æœ‰ç›¸åŒurlçš„ä¼šè¯
        if (this.ossFileManager) {
            const files = this.ossFileManager.getAllFiles();
            const fileUrls = new Set(files.map(file => file.url).filter(url => url));
            allSessions = allSessions.filter(session => {
                const sessionUrl = session.url;
                return !sessionUrl || !fileUrls.has(sessionUrl);
            });
        }
        
        // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰
        if (this.tagFilterNoTags) {
            allSessions = allSessions.filter(session => {
                const sessionTags = session.tags || [];
                const hasTags = sessionTags.length > 0 && sessionTags.some(tag => tag && tag.trim().length > 0);
                return !hasTags; // åªæ˜¾ç¤ºæ²¡æœ‰æ ‡ç­¾çš„ä¼šè¯
            });
        }
        
        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤ï¼ˆä¸updateSessionSidebarä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
        if (this.selectedFilterTags && this.selectedFilterTags.length > 0) {
            allSessions = allSessions.filter(session => {
                const sessionTags = (session.tags || []).map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const normalizedSelectedTags = this.selectedFilterTags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const hasSelectedTags = normalizedSelectedTags.some(selectedTag => 
                    sessionTags.includes(selectedTag)
                );
                
                if (this.tagFilterReverse) {
                    // åå‘è¿‡æ»¤ï¼šæ’é™¤åŒ…å«é€‰ä¸­æ ‡ç­¾çš„ä¼šè¯
                    return !hasSelectedTags;
                } else {
                    // æ­£å‘è¿‡æ»¤ï¼šåªæ˜¾ç¤ºåŒ…å«é€‰ä¸­æ ‡ç­¾çš„ä¼šè¯
                    return hasSelectedTags;
                }
            });
        }
        
        // åº”ç”¨æ ‡é¢˜å’Œç½‘å€æ¨¡ç³ŠåŒ¹é…è¿‡æ»¤
        if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
            const filterKeyword = this.sessionTitleFilter.trim().toLowerCase();
            allSessions = allSessions.filter(session => {
                const sessionTitle = this._getSessionDisplayTitle(session);
                const sessionUrl = (session.url || '').toLowerCase();
                return sessionTitle.toLowerCase().includes(filterKeyword) || 
                       sessionUrl.includes(filterKeyword);
            });
        }
        
        return allSessions;
    }
    
    // è·å–ç­›é€‰åçš„æ–‡ä»¶åˆ—è¡¨
    _getFilteredFiles() {
        let files = this.ossFileManager ? this.ossFileManager.getAllFiles() : [];
        
        // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤æ–‡ä»¶ï¼ˆæœç´¢æ–‡ä»¶åï¼‰
        if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
            const filterKeyword = this.sessionTitleFilter.trim().toLowerCase();
            files = files.filter(file => {
                const fileName = (file.name || '').toLowerCase();
                return fileName.includes(filterKeyword);
            });
        }
        
        // åº”ç”¨æ—¥æœŸåŒºé—´è¿‡æ»¤
        if (this.dateRangeFilter) {
            if (this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // æœ‰å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼šç­›é€‰åŒºé—´å†…çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const endDate = this.dateRangeFilter.endDate;
                const startTime = startDate.getTime();
                const endTime = endDate.getTime() + 24 * 60 * 60 * 1000 - 1; // åŒ…å«ç»“æŸæ—¥æœŸçš„æ•´å¤©
                
                files = files.filter(file => {
                    const fileTime = file.last_modified || file.created_at || 0;
                    return fileTime >= startTime && fileTime <= endTime;
                });
            } else if (this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
                // åªæœ‰å¼€å§‹æ—¥æœŸï¼šç­›é€‰å¼€å§‹æ—¥æœŸå½“å¤©çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const startTime = startDate.getTime();
                const endTime = startTime + 24 * 60 * 60 * 1000 - 1; // åŒ…å«å¼€å§‹æ—¥æœŸçš„æ•´å¤©
                
                files = files.filter(file => {
                    const fileTime = file.last_modified || file.created_at || 0;
                    return fileTime >= startTime && fileTime <= endTime;
                });
            } else if (!this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // åªæœ‰ç»“æŸæ—¥æœŸï¼šç­›é€‰ç»“æŸæ—¥æœŸä¹‹å‰çš„è®°å½•
                const endDate = this.dateRangeFilter.endDate;
                const endTime = endDate.getTime(); // ä¸åŒ…å«ç»“æŸæ—¥æœŸå½“å¤©
                
                files = files.filter(file => {
                    const fileTime = file.last_modified || file.created_at || 0;
                    return fileTime < endTime;
                });
            }
        }
        
        // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰
        if (this.ossTagFilterNoTags) {
            files = files.filter(file => {
                const fileTags = file.tags || [];
                const hasTags = fileTags.length > 0 && fileTags.some(tag => tag && tag.trim().length > 0);
                return !hasTags; // åªæ˜¾ç¤ºæ²¡æœ‰æ ‡ç­¾çš„æ–‡ä»¶
            });
        }
        
        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤ï¼ˆå¦‚æœåç«¯æ²¡æœ‰ç­›é€‰ï¼Œåˆ™åœ¨å‰ç«¯ç­›é€‰ï¼‰
        if (this.selectedOssFilterTags && this.selectedOssFilterTags.length > 0) {
            files = files.filter(file => {
                const fileTags = file.tags || [];
                const hasSelectedTags = this.selectedOssFilterTags.some(selectedTag => 
                    fileTags.includes(selectedTag)
                );
                
                if (this.ossTagFilterReverse) {
                    // åå‘è¿‡æ»¤ï¼šæ’é™¤åŒ…å«é€‰ä¸­æ ‡ç­¾çš„æ–‡ä»¶
                    return !hasSelectedTags;
                } else {
                    // æ­£å‘è¿‡æ»¤ï¼šåªæ˜¾ç¤ºåŒ…å«é€‰ä¸­æ ‡ç­¾çš„æ–‡ä»¶
                    return hasSelectedTags;
                }
            });
        }
        
        return files;
    }

    // æ—¥æœŸå¤„ç†è¾…åŠ©å‡½æ•°
    _getDateInfo(timestamp) {
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = date.getMonth() + 1; // 0-11 -> 1-12
        const day = date.getDate();
        
        // è®¡ç®—å­£åº¦
        const quarter = Math.floor((month - 1) / 3) + 1;
        
        // è®¡ç®—è¯¥å‘¨çš„èµ·å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ï¼‰å’Œç»“æŸæ—¥æœŸï¼ˆå‘¨æ—¥ï¼‰
        const dayOfWeek = date.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // è·ç¦»å‘¨ä¸€çš„å¤©æ•°
        const monday = new Date(date);
        monday.setDate(date.getDate() + mondayOffset);
        const weekStart = monday.getDate();
        const weekStartMonth = monday.getMonth() + 1;
        
        // è®¡ç®—è¯¥å‘¨çš„ç»“æŸæ—¥æœŸï¼ˆå‘¨æ—¥ï¼‰
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        const weekEnd = sunday.getDate();
        const weekEndMonth = sunday.getMonth() + 1;
        
        // è®¡ç®—å½“æœˆç¬¬å‡ å‘¨ï¼ˆä»å½“æœˆ1æ—¥æ‰€åœ¨å‘¨å¼€å§‹è®¡ç®—ï¼‰
        const firstDayOfMonth = new Date(year, month - 1, 1);
        const firstDayOfWeek = firstDayOfMonth.getDay(); // å½“æœˆ1æ—¥æ˜¯æ˜ŸæœŸå‡ 
        const daysSinceMonthStart = Math.floor((date - firstDayOfMonth) / 86400000);
        // è®¡ç®—å‘¨æ•°ï¼šä»å½“æœˆ1æ—¥æ‰€åœ¨å‘¨å¼€å§‹ï¼Œæ¯7å¤©ä¸€å‘¨
        const weekNumber = Math.floor((daysSinceMonthStart + firstDayOfWeek) / 7) + 1;
        
        return {
            year: year.toString(),
            quarter: `Q${quarter}`,
            month: month.toString().padStart(2, '0'),
            week: `W${weekNumber}[${weekStartMonth}-${weekStart}_${weekEndMonth}-${weekEnd}]`,
            day: day.toString().padStart(2, '0'),
            date: date
        };
    }

    // æ¸…ç†æ–‡ä»¶åï¼ˆç§»é™¤éæ³•å­—ç¬¦ï¼‰
    _sanitizeFileName(fileName) {
        // ç§»é™¤æˆ–æ›¿æ¢Windows/Linuxæ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
        return fileName.replace(/[<>:"/\\|?*\x00-\x1f]/g, '_').trim();
    }

    // åŠ è½½JSZipåº“ï¼ˆå‚è€ƒloadMermaidçš„æ–¹å¼ï¼‰
    async _loadJSZip() {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
        if (this.jszipLoaded || this.jszipLoading) {
            return this.jszipLoaded;
        }

        this.jszipLoading = true;

        return new Promise((resolve, reject) => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­åŠ è½½
            const checkLoaded = () => {
                return window.__JSZIP_LOADED__ || window.__JSZIP_READY__;
            };
            
            if (checkLoaded()) {
                this.jszipLoaded = true;
                this.jszipLoading = false;
                console.log('JSZipå·²åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­åŠ è½½');
                resolve(true);
                return;
            }

            // æ£€æŸ¥æ‰©å±•ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
            let scriptUrl, loadScriptUrl;
            try {
                // æ£€æŸ¥ chrome å¯¹è±¡å’Œ runtime æ˜¯å¦å­˜åœ¨
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šchrome.runtime ä¸å¯ç”¨');
                }
                
                // å°è¯•è®¿é—® runtime.id æ¥æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
                try {
                    const runtimeId = chrome.runtime.id;
                    if (!runtimeId) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šruntime.id ä¸ºç©º');
                    }
                } catch (idError) {
                    const errorMsg = (idError.message || idError.toString() || '').toLowerCase();
                    if (errorMsg.includes('extension context invalidated') || 
                        errorMsg.includes('context invalidated')) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡å·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    }
                    throw idError;
                }
                
                // è·å–è„šæœ¬ URL
                scriptUrl = chrome.runtime.getURL('jszip.min.js');
                loadScriptUrl = chrome.runtime.getURL('load-jszip.js');
            } catch (error) {
                this.jszipLoading = false;
                const errorMsg = error.message || 'æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆ';
                console.error('è·å–JSZipè„šæœ¬URLå¤±è´¥:', error);
                reject(new Error(errorMsg));
                return;
            }
            
            console.log('å°è¯•åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­åŠ è½½ JSZip.jsï¼ŒURL:', scriptUrl);
            
            // é€šè¿‡ data å±æ€§ä¼ é€’ URLï¼ˆé¿å…å†…è”è„šæœ¬ï¼‰
            const urlContainer = document.createElement('div');
            urlContainer.id = '__jszip_url_container__';
            urlContainer.style.display = 'none';
            urlContainer.setAttribute('data-jszip-url', scriptUrl);
            (document.head || document.documentElement).appendChild(urlContainer);
            
            // åŠ è½½å¤–éƒ¨è„šæœ¬æ–‡ä»¶ï¼ˆé¿å… CSP é™åˆ¶ï¼‰
            const injectedScript = document.createElement('script');
            injectedScript.src = loadScriptUrl;
            injectedScript.charset = 'UTF-8';
            injectedScript.async = false;
            
            // ç›‘å¬é¡µé¢ä¸­çš„ JSZip åŠ è½½äº‹ä»¶ï¼ˆåœ¨è„šæœ¬åŠ è½½å‰è®¾ç½®ï¼‰
            const handleJSZipLoaded = () => {
                console.log('[Content] æ”¶åˆ° JSZip åŠ è½½å®Œæˆäº‹ä»¶');
                this.jszipLoaded = true;
                this.jszipLoading = false;
                console.log('[Content] JSZip.js åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­å·²åŠ è½½');
                window.removeEventListener('jszip-loaded', handleJSZipLoaded);
                window.removeEventListener('jszip-error', handleJSZipError);
                resolve(true);
            };
            
            const handleJSZipError = (event) => {
                console.error('[Content] æ”¶åˆ° JSZip åŠ è½½å¤±è´¥äº‹ä»¶', event);
                this.jszipLoading = false;
                window.removeEventListener('jszip-loaded', handleJSZipLoaded);
                window.removeEventListener('jszip-error', handleJSZipError);
                const errorMsg = event && event.detail && event.detail.error ? event.detail.error : 'é¡µé¢ä¸Šä¸‹æ–‡ä¸­çš„ JSZip.js åŠ è½½å¤±è´¥';
                reject(new Error(errorMsg));
            };
            
            // ç›‘å¬é¡µé¢äº‹ä»¶ï¼ˆé€šè¿‡æ³¨å…¥çš„äº‹ä»¶ç›‘å¬å™¨ï¼‰
            window.addEventListener('jszip-loaded', handleJSZipLoaded);
            window.addEventListener('jszip-error', handleJSZipError);
            
            // æ³¨å…¥è„šæœ¬åˆ°é¡µé¢ä¸Šä¸‹æ–‡
            (document.head || document.documentElement).appendChild(injectedScript);
            
            // æ¸…ç†æ³¨å…¥çš„è„šæœ¬
            setTimeout(() => {
                if (injectedScript.parentNode) {
                    injectedScript.parentNode.removeChild(injectedScript);
                }
            }, 1000);
        });
    }

    // ç”Ÿæˆcontext.mdå†…å®¹
    _generateContextMd(session) {
        let content = `# ${session.pageTitle || 'æœªå‘½åä¼šè¯'}\n\n`;
        content += `**åˆ›å»ºæ—¶é—´**: ${new Date(session.createdAt || Date.now()).toLocaleString('zh-CN')}\n\n`;
        content += `**æ›´æ–°æ—¶é—´**: ${new Date(session.updatedAt || session.createdAt || Date.now()).toLocaleString('zh-CN')}\n\n`;
        content += `**URL**: ${session.url || ''}\n\n`;
        
        if (session.pageDescription) {
            content += `**é¡µé¢æè¿°**: ${session.pageDescription}\n\n`;
        }
        
        if (session.tags && session.tags.length > 0) {
            content += `**æ ‡ç­¾**: ${session.tags.join(', ')}\n\n`;
        }
        
        if (session.pageContent) {
            content += `## é¡µé¢å†…å®¹\n\n${session.pageContent}\n`;
        }
        
        return content;
    }

    // ç”Ÿæˆchat.mdå†…å®¹
    _generateChatMd(session) {
        let content = `# èŠå¤©è®°å½•\n\n`;
        
        if (!session.messages || session.messages.length === 0) {
            content += `æš‚æ— èŠå¤©è®°å½•ã€‚\n`;
            return content;
        }
        
        session.messages.forEach((message, index) => {
            const role = message.role || 'unknown';
            const text = message.content || message.text || '';
            const timestamp = message.timestamp || message.createdAt || '';
            
            content += `## æ¶ˆæ¯ ${index + 1}\n\n`;
            content += `**è§’è‰²**: ${role}\n\n`;
            if (timestamp) {
                content += `**æ—¶é—´**: ${new Date(timestamp).toLocaleString('zh-CN')}\n\n`;
            }
            content += `**å†…å®¹**:\n\n${text}\n\n`;
            content += `---\n\n`;
        });
        
        return content;
    }

    // è§£æmarkdownå†…å®¹ï¼Œæå–é¡µé¢ä¿¡æ¯å’ŒèŠå¤©è®°å½•
    _parseMarkdownContent(markdownContent) {
        const result = {
            pageTitle: '',
            url: '',
            pageDescription: '',
            pageContent: '',
            tags: [],
            messages: [],
            createdAt: null,
            updatedAt: null
        };
        
        if (!markdownContent || typeof markdownContent !== 'string') {
            return result;
        }
        
        // åˆ†å‰²å†…å®¹ï¼šé¡µé¢ä¿¡æ¯å’ŒèŠå¤©è®°å½•
        const chatRecordIndex = markdownContent.indexOf('# èŠå¤©è®°å½•');
        const pageInfoContent = chatRecordIndex >= 0 
            ? markdownContent.substring(0, chatRecordIndex).trim()
            : markdownContent.trim();
        const chatContent = chatRecordIndex >= 0 
            ? markdownContent.substring(chatRecordIndex).trim()
            : '';
        
        // è§£æé¡µé¢ä¿¡æ¯éƒ¨åˆ†
        // æå–æ ‡é¢˜ï¼ˆç¬¬ä¸€è¡Œçš„ # æ ‡é¢˜ï¼‰
        const titleMatch = pageInfoContent.match(/^#\s+(.+?)$/m);
        if (titleMatch) {
            result.pageTitle = titleMatch[1].trim();
        }
        
        // æå–åˆ›å»ºæ—¶é—´
        const createdAtMatch = pageInfoContent.match(/\*\*åˆ›å»ºæ—¶é—´\*\*:\s*(.+?)$/m);
        if (createdAtMatch) {
            try {
                result.createdAt = new Date(createdAtMatch[1].trim()).getTime();
            } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
            }
        }
        
        // æå–æ›´æ–°æ—¶é—´
        const updatedAtMatch = pageInfoContent.match(/\*\*æ›´æ–°æ—¶é—´\*\*:\s*(.+?)$/m);
        if (updatedAtMatch) {
            try {
                result.updatedAt = new Date(updatedAtMatch[1].trim()).getTime();
            } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
            }
        }
        
        // æå–URL
        const urlMatch = pageInfoContent.match(/\*\*URL\*\*:\s*(.+?)$/m);
        if (urlMatch) {
            result.url = urlMatch[1].trim();
        }
        
        // æå–é¡µé¢æè¿°
        const descMatch = pageInfoContent.match(/\*\*é¡µé¢æè¿°\*\*:\s*(.+?)$/m);
        if (descMatch) {
            result.pageDescription = descMatch[1].trim();
        }
        
        // æå–æ ‡ç­¾
        const tagsMatch = pageInfoContent.match(/\*\*æ ‡ç­¾\*\*:\s*(.+?)$/m);
        if (tagsMatch) {
            result.tags = tagsMatch[1].split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
        }
        
        // æå–é¡µé¢å†…å®¹ï¼ˆ## é¡µé¢å†…å®¹ ä¹‹åçš„å†…å®¹ï¼‰
        const pageContentMatch = pageInfoContent.match(/##\s+é¡µé¢å†…å®¹\s*\n\n(.+?)(?:\n\n#|$)/s);
        if (pageContentMatch) {
            result.pageContent = pageContentMatch[1].trim();
        } else {
            // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„é¡µé¢å†…å®¹æ ‡è®°ï¼Œå°è¯•æå–æ‰€æœ‰éå…ƒä¿¡æ¯çš„å†…å®¹
            const lines = pageInfoContent.split('\n');
            let inPageContent = false;
            let pageContentLines = [];
            for (const line of lines) {
                if (line.startsWith('## é¡µé¢å†…å®¹')) {
                    inPageContent = true;
                    continue;
                }
                if (inPageContent && !line.match(/^\*\*/)) {
                    pageContentLines.push(line);
                }
            }
            if (pageContentLines.length > 0) {
                result.pageContent = pageContentLines.join('\n').trim();
            }
        }
        
        // è§£æèŠå¤©è®°å½•éƒ¨åˆ†
        if (chatContent) {
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ¯ä¸ªæ¶ˆæ¯
            const messagePattern = /##\s+æ¶ˆæ¯\s+\d+\s*\n\n\*\*è§’è‰²\*\*:\s*(.+?)\s*\n\n(?:\*\*æ—¶é—´\*\*:\s*(.+?)\s*\n\n)?\*\*å†…å®¹\*\*:\s*\n\n(.+?)\n\n---/gs;
            let messageMatch;
            while ((messageMatch = messagePattern.exec(chatContent)) !== null) {
                const role = messageMatch[1].trim();
                const timestamp = messageMatch[2] ? new Date(messageMatch[2].trim()).getTime() : Date.now();
                const content = messageMatch[3].trim();
                
                // å°†è§’è‰²æ˜ å°„ä¸ºtypeï¼ˆuseræˆ–petï¼‰
                const type = role.toLowerCase().includes('user') || role.toLowerCase().includes('ç”¨æˆ·') ? 'user' : 'pet';
                
                result.messages.push({
                    type: type,
                    role: role,
                    content: content,
                    timestamp: timestamp
                });
            }
        }
        
        return result;
    }
    
    // æ ¹æ®æ ‡ç­¾å’Œæ ‡é¢˜æŸ¥æ‰¾ä¼šè¯
    _findSessionByTagsAndTitle(tags, title) {
        const allSessions = this._getSessionsFromLocal();
        
        // å°†æ ‡ç­¾æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ç”¨äºæ¯”è¾ƒï¼ˆæ’åºåæ¯”è¾ƒï¼Œç¡®ä¿é¡ºåºä¸€è‡´ï¼‰
        const normalizedTags = [...tags].sort().join(',');
        
        for (const session of allSessions) {
            const sessionTags = session.tags || [];
            const sessionNormalizedTags = [...sessionTags].sort().join(',');
            
            // æ¯”è¾ƒæ ‡ç­¾å’Œæ ‡é¢˜
            if (sessionNormalizedTags === normalizedTags && 
                session.pageTitle === title) {
                return session;
            }
        }
        
        return null;
    }
    
    // å¯¼å…¥ä¼šè¯ä»ZIPæ–‡ä»¶
    async importSessionsFromZip(file) {
        try {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.showNotification('æ­£åœ¨å‡†å¤‡å¯¼å…¥...', 'info');
            
            // åŠ è½½JSZipåº“ï¼ˆåœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­ï¼‰
            await this._loadJSZip();
            
            // è¯»å–æ–‡ä»¶ä¸ºbase64
            const fileReader = new FileReader();
            const fileData = await new Promise((resolve, reject) => {
                fileReader.onload = (e) => resolve(e.target.result);
                fileReader.onerror = (e) => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                fileReader.readAsDataURL(file);
            });
            
            // æå–base64æ•°æ®ï¼ˆå»æ‰data:application/zip;base64,å‰ç¼€ï¼‰
            const base64Data = fileData.split(',')[1];
            
            if (!base64Data) {
                throw new Error('æ— æ³•è¯»å–æ–‡ä»¶æ•°æ®');
            }
            
            // åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¯¼å…¥é€»è¾‘
            this.showNotification('æ­£åœ¨è§£æZIPæ–‡ä»¶...', 'info');
            
            // æ ¹æ®æ–‡ä»¶å¤§å°åŠ¨æ€è®¡ç®—è¶…æ—¶æ—¶é—´ï¼ˆæœ€å°5åˆ†é’Ÿï¼Œæ¯MBå¢åŠ 1åˆ†é’Ÿï¼Œæœ€å¤§30åˆ†é’Ÿï¼‰
            const fileSizeMB = file.size / (1024 * 1024);
            const baseTimeout = 5 * 60 * 1000; // 5åˆ†é’ŸåŸºç¡€è¶…æ—¶
            const sizeBasedTimeout = Math.min(fileSizeMB * 60 * 1000, 25 * 60 * 1000); // æ¯MBå¢åŠ 1åˆ†é’Ÿï¼Œæœ€å¤š25åˆ†é’Ÿ
            const timeoutDuration = Math.max(baseTimeout + sizeBasedTimeout, 5 * 60 * 1000); // æœ€å°‘5åˆ†é’Ÿ
            const maxTimeout = 30 * 60 * 1000; // æœ€å¤š30åˆ†é’Ÿ
            const finalTimeout = Math.min(timeoutDuration, maxTimeout);
            
            console.log(`å¯¼å…¥è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º: ${Math.round(finalTimeout / 1000)}ç§’ (æ–‡ä»¶å¤§å°: ${fileSizeMB.toFixed(2)}MB)`);
            
            // æ£€æŸ¥æ‰©å±•ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
            let importScriptUrl;
            try {
                // æ£€æŸ¥ chrome å¯¹è±¡å’Œ runtime æ˜¯å¦å­˜åœ¨
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šchrome.runtime ä¸å¯ç”¨');
                }
                
                // å°è¯•è®¿é—® runtime.id æ¥æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
                try {
                    const runtimeId = chrome.runtime.id;
                    if (!runtimeId) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šruntime.id ä¸ºç©º');
                    }
                } catch (idError) {
                    const errorMsg = (idError.message || idError.toString() || '').toLowerCase();
                    if (errorMsg.includes('extension context invalidated') || 
                        errorMsg.includes('context invalidated')) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡å·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    }
                    throw idError;
                }
                
                // è·å–å¯¼å…¥è„šæœ¬ URL
                importScriptUrl = chrome.runtime.getURL('import-sessions.js');
            } catch (error) {
                const errorMsg = error.message || 'æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆ';
                console.error('è·å–å¯¼å…¥è„šæœ¬URLå¤±è´¥:', error);
                this.showNotification('å¯¼å…¥å¤±è´¥: ' + errorMsg + 'ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚', 'error');
                throw new Error(errorMsg);
            }
            
            return new Promise((resolve, reject) => {
                // åˆ›å»ºæ•°æ®å®¹å™¨
                const dataContainer = document.createElement('div');
                dataContainer.id = '__jszip_import_data__';
                dataContainer.style.display = 'none';
                dataContainer.setAttribute('data-import', base64Data);
                (document.head || document.documentElement).appendChild(dataContainer);
                
                // åŠ è½½å¤–éƒ¨å¯¼å…¥è„šæœ¬
                const importScript = document.createElement('script');
                importScript.src = importScriptUrl;
                importScript.charset = 'UTF-8';
                importScript.async = false;
                
                // è¶…æ—¶å®šæ—¶å™¨å¼•ç”¨
                let timeoutTimer = null;
                
                // æ¸…ç†å‡½æ•°
                const cleanup = () => {
                    if (timeoutTimer) {
                        clearTimeout(timeoutTimer);
                        timeoutTimer = null;
                    }
                    window.removeEventListener('jszip-import-success', handleSuccess);
                    window.removeEventListener('jszip-import-error', handleError);
                    
                    // æ¸…ç†DOMå…ƒç´ 
                    if (importScript.parentNode) {
                        importScript.parentNode.removeChild(importScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                };
                
                // ç›‘å¬å¯¼å…¥ç»“æœ
                const handleSuccess = async (event) => {
                    cleanup();
                    
                    try {
                        const importData = event.detail.importData;
                        if (!importData || importData.length === 0) {
                            throw new Error('æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å…¥çš„ä¼šè¯');
                        }
                        
                        this.showNotification(`æ­£åœ¨å¯¼å…¥ ${importData.length} ä¸ªä¼šè¯...`, 'info');
                        
                        // å¤„ç†æ¯ä¸ªå¯¼å…¥çš„ä¼šè¯
                        let createdCount = 0;
                        let updatedCount = 0;
                        let errorCount = 0;
                        // è®°å½•å·²å¤„ç†çš„ä¼šè¯IDï¼Œç”¨äºåç»­åŒæ­¥
                        const processedSessionIds = [];
                        
                        for (let i = 0; i < importData.length; i++) {
                            const item = importData[i];
                            let processedSessionId = null;
                            
                            try {
                                // è§£æmarkdownå†…å®¹
                                const parsed = this._parseMarkdownContent(item.pageContent);
                                
                                // ä½¿ç”¨å¯¼å…¥çš„æ ‡ç­¾ï¼ˆå¦‚æœmarkdownä¸­æ²¡æœ‰æ ‡ç­¾ï¼Œä½¿ç”¨ç›®å½•ç»“æ„ä¸­çš„æ ‡ç­¾ï¼‰
                                let tags = parsed.tags.length > 0 ? parsed.tags : item.tags;
                                
                                // è¿‡æ»¤æ‰"æœªåˆ†ç±»"æ ‡ç­¾ï¼Œæ ¹ç›®å½•å’Œ"æœªåˆ†ç±»"ç›®å½•ä¸éœ€è¦åˆ›å»ºæ ‡ç­¾
                                tags = tags.filter(tag => tag !== 'æœªåˆ†ç±»');
                                
                                // ä½¿ç”¨å¯¼å…¥çš„æ ‡é¢˜ï¼ˆå¦‚æœmarkdownä¸­æ²¡æœ‰æ ‡é¢˜ï¼Œä½¿ç”¨æ–‡ä»¶åï¼‰
                                const title = parsed.pageTitle || item.title;
                                
                                // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç›¸åŒçš„ä¼šè¯ï¼ˆæ ¹æ®æ ‡ç­¾å’Œæ ‡é¢˜ï¼‰
                                const existingSession = this._findSessionByTagsAndTitle(tags, title);
                                
                                if (existingSession) {
                                    // æ›´æ–°ç°æœ‰ä¼šè¯
                                    const sessionId = existingSession.id;
                                    const session = this.sessions[sessionId];
                                    
                                    if (session) {
                                        // æ›´æ–°ä¼šè¯ä¿¡æ¯
                                        session.pageTitle = title;
                                        session.pageDescription = parsed.pageDescription || session.pageDescription || '';
                                        // ç”¨æ–°æ–‡ä»¶é‡Œé¢çš„å†…å®¹è¦†ç›–åŸæ¥ä¼šè¯çš„é¡µé¢ä¸Šä¸‹æ–‡å†…å®¹
                                        session.pageContent = parsed.pageContent || item.pageContent || '';
                                        session.tags = tags;
                                        
                                        // ç”Ÿæˆå”¯ä¸€çš„éšæœºURLï¼ˆå‚è€ƒæ‰‹åŠ¨åˆ›å»ºä¼šè¯çš„æ–¹å¼ï¼‰
                                        if (!parsed.url && !session.url) {
                                            const timestamp = Date.now();
                                            const randomStr = Math.random().toString(36).substring(2, 11); // 9ä½éšæœºå­—ç¬¦ä¸²
                                            let uniqueUrl = `import-session://${timestamp}-${randomStr}`;
                                            
                                            // ç¡®ä¿URLå”¯ä¸€ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒURLçš„ä¼šè¯
                                            let urlAttempts = 0;
                                            while (Object.values(this.sessions).some(s => s && s.url === uniqueUrl) && urlAttempts < 10) {
                                                const newTimestamp = Date.now();
                                                const newRandomStr = Math.random().toString(36).substring(2, 11);
                                                uniqueUrl = `import-session://${newTimestamp}-${newRandomStr}`;
                                                urlAttempts++;
                                            }
                                            session.url = uniqueUrl;
                                        } else {
                                            session.url = parsed.url || session.url;
                                        }
                                        
                                        // æ›´æ–°æ¶ˆæ¯ï¼ˆå¦‚æœå¯¼å…¥çš„å†…å®¹ä¸­æœ‰æ¶ˆæ¯ï¼‰
                                        if (parsed.messages && parsed.messages.length > 0) {
                                            session.messages = parsed.messages.map(msg => ({
                                                type: msg.type,
                                                content: msg.content,
                                                timestamp: msg.timestamp || Date.now()
                                            }));
                                        }
                                        
                                        session.updatedAt = parsed.updatedAt || Date.now();
                                        
                                        // ç¡®ä¿ä¼šè¯IDæ­£ç¡®è®¾ç½®
                                        if (!session.id) {
                                            session.id = sessionId;
                                        }
                                        
                                        // ç¡®ä¿æ›´æ–°åçš„ä¼šè¯è¢«ä¿å­˜åˆ° this.sessions
                                        this.sessions[sessionId] = session;
                                        
                                        // è®°å½•å·²å¤„ç†çš„ä¼šè¯ID
                                        processedSessionId = sessionId;
                                        
                                        updatedCount++;
                                    }
                                } else {
                                    // åˆ›å»ºæ–°ä¼šè¯
                                    // ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯IDï¼ˆä½¿ç”¨æ ‡é¢˜å’Œæ ‡ç­¾ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼‰
                                    const tagsStr = tags.length > 0 ? tags.join('_') : 'no_tags';
                                    const uniqueId = `import_${title}_${tagsStr}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                                    const sessionId = await this.generateSessionId(uniqueId);
                                    
                                    // æ£€æŸ¥ä¼šè¯IDæ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™é‡æ–°ç”Ÿæˆ
                                    let finalSessionId = sessionId;
                                    let attempts = 0;
                                    while (this.sessions[finalSessionId] && attempts < 10) {
                                        const newTagsStr = tags.length > 0 ? tags.join('_') : 'no_tags';
                                        const newUniqueId = `import_${title}_${newTagsStr}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                                        finalSessionId = await this.generateSessionId(newUniqueId);
                                        attempts++;
                                    }
                                    
                                    // ç”Ÿæˆå”¯ä¸€çš„éšæœºURLï¼ˆå‚è€ƒæ‰‹åŠ¨åˆ›å»ºä¼šè¯çš„æ–¹å¼ï¼‰
                                    let uniqueUrl;
                                    if (!parsed.url) {
                                        const timestamp = Date.now();
                                        const randomStr = Math.random().toString(36).substring(2, 11); // 9ä½éšæœºå­—ç¬¦ä¸²
                                        uniqueUrl = `import-session://${timestamp}-${randomStr}`;
                                        
                                        // ç¡®ä¿URLå”¯ä¸€ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒURLçš„ä¼šè¯
                                        let urlAttempts = 0;
                                        while (Object.values(this.sessions).some(s => s && s.url === uniqueUrl) && urlAttempts < 10) {
                                            const newTimestamp = Date.now();
                                            const newRandomStr = Math.random().toString(36).substring(2, 11);
                                            uniqueUrl = `import-session://${newTimestamp}-${newRandomStr}`;
                                            urlAttempts++;
                                        }
                                    } else {
                                        uniqueUrl = parsed.url;
                                    }
                                    
                                    const pageInfo = {
                                        url: uniqueUrl,
                                        title: title,
                                        pageTitle: title,
                                        description: parsed.pageDescription || '',
                                        pageDescription: parsed.pageDescription || '',
                                        // ä¼˜å…ˆä½¿ç”¨è§£æå‡ºçš„é¡µé¢å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå§‹å¯¼å…¥å†…å®¹
                                        content: parsed.pageContent || item.pageContent || '',
                                        pageContent: parsed.pageContent || item.pageContent || ''
                                    };
                                    
                                    // ä½¿ç”¨createSessionObjectåˆ›å»ºä¼šè¯å¯¹è±¡
                                    const newSession = this.createSessionObject(finalSessionId, pageInfo);
                                    newSession.tags = tags;
                                    newSession.messages = parsed.messages && parsed.messages.length > 0 
                                        ? parsed.messages.map(msg => ({
                                            type: msg.type,
                                            content: msg.content,
                                            timestamp: msg.timestamp || Date.now()
                                        }))
                                        : [];
                                    newSession.createdAt = parsed.createdAt || Date.now();
                                    newSession.updatedAt = parsed.updatedAt || Date.now();
                                    
                                    // ä¿å­˜ä¼šè¯åˆ°æœ¬åœ°
                                    this.sessions[finalSessionId] = newSession;
                                    
                                    // è®°å½•å·²å¤„ç†çš„ä¼šè¯ID
                                    processedSessionId = finalSessionId;
                                    
                                    createdCount++;
                                }
                                
                                // å°†å·²å¤„ç†çš„ä¼šè¯IDæ·»åŠ åˆ°æ•°ç»„ä¸­
                                if (processedSessionId) {
                                    processedSessionIds.push(processedSessionId);
                                }
                                
                                // åŒæ­¥åˆ°åç«¯ï¼ˆæ‰¹é‡å¤„ç†ï¼Œæ¯10ä¸ªä¼šè¯åŒæ­¥ä¸€æ¬¡ï¼‰
                                if ((i + 1) % 10 === 0 || (i + 1) === importData.length) {
                                    // ä¿å­˜æ‰€æœ‰ä¼šè¯åˆ°æœ¬åœ°
                                    await this.saveAllSessions(true, false);
                                    
                                    // æ‰¹é‡åŒæ­¥åˆ°åç«¯
                                    if (this.sessionApi && this.sessionApi.isEnabled()) {
                                        // ä½¿ç”¨è®°å½•çš„ä¼šè¯IDè¿›è¡ŒåŒæ­¥ï¼Œç¡®ä¿ä½¿ç”¨æ›´æ–°åçš„æ•°æ®
                                        const sessionsToSync = processedSessionIds.slice(Math.max(0, processedSessionIds.length - 10));
                                        
                                        // åŒæ­¥æ¯ä¸ªä¼šè¯ï¼Œç¡®ä¿åŒ…å« pageContent
                                        for (const syncSessionId of sessionsToSync) {
                                            try {
                                                // ç¡®ä¿ä¼šè¯å­˜åœ¨ä¸”åŒ…å«æ›´æ–°åçš„ pageContent
                                                const sessionToSync = this.sessions[syncSessionId];
                                                if (sessionToSync) {
                                                    await this.syncSessionToBackend(syncSessionId, true, true);
                                                }
                                            } catch (error) {
                                                console.warn(`åŒæ­¥ä¼šè¯ ${syncSessionId} å¤±è´¥:`, error);
                                            }
                                        }
                                        
                                        // æ¸…ç©ºå·²å¤„ç†çš„ä¼šè¯IDåˆ—è¡¨ï¼ˆåªä¿ç•™æœ€å10ä¸ªï¼Œç”¨äºä¸‹ä¸€æ‰¹ï¼‰
                                        if (processedSessionIds.length > 10) {
                                            processedSessionIds.splice(0, processedSessionIds.length - 10);
                                        }
                                    }
                                }
                                
                                // æ›´æ–°è¿›åº¦æç¤ºï¼ˆæ¯10ä¸ªä¼šè¯æ›´æ–°ä¸€æ¬¡ï¼‰
                                if ((i + 1) % 10 === 0 || (i + 1) === importData.length) {
                                    this.showNotification(`å·²å¤„ç† ${i + 1}/${importData.length} ä¸ªä¼šè¯...`, 'info');
                                }
                            } catch (error) {
                                console.error(`å¯¼å…¥ä¼šè¯å¤±è´¥ [${item.title}]:`, error);
                                errorCount++;
                            }
                        }
                        
                        // åˆ·æ–°ä¼šè¯åˆ—è¡¨ï¼šä»åç«¯é‡æ–°è¯·æ±‚ä¼šè¯åˆ—è¡¨
                        if (this.sessionApi && this.sessionApi.isEnabled()) {
                            try {
                                this.showNotification('æ­£åœ¨åˆ·æ–°ä¼šè¯åˆ—è¡¨...', 'info');
                                // å¼ºåˆ¶åˆ·æ–°åç«¯ä¼šè¯åˆ—è¡¨ï¼ˆè·³è¿‡ç¼“å­˜ï¼‰
                                await this.loadSessionsFromBackend(true);
                                // é‡æ–°åŠ è½½æ‰€æœ‰ä¼šè¯ï¼ˆåŒ…æ‹¬æœ¬åœ°å­˜å‚¨çš„ä¼šè¯ï¼‰
                                await this.loadAllSessions();
                                console.log('ä¼šè¯åˆ—è¡¨å·²ä»åç«¯åˆ·æ–°');
                            } catch (error) {
                                console.warn('åˆ·æ–°ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                                // å³ä½¿åˆ·æ–°å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ›´æ–°UIï¼ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰
                            }
                        } else {
                            // å¦‚æœæ²¡æœ‰åç«¯APIï¼Œåªé‡æ–°åŠ è½½æœ¬åœ°ä¼šè¯
                            await this.loadAllSessions();
                        }
                        
                        // åˆ·æ–°ä¼šè¯åˆ—è¡¨UIï¼ˆä¿æŒå½“å‰è§†å›¾æ¨¡å¼ï¼‰
                        const currentViewMode = this.ossFileListVisible ? 'oss' : 'session';
                        await this.updateSessionUI({ 
                            updateSidebar: true,
                            keepOssFileListView: currentViewMode === 'oss' // å¦‚æœå½“å‰æ˜¯OSSæ–‡ä»¶åˆ—è¡¨è§†å›¾ï¼Œä¿æŒè¯¥è§†å›¾
                        });
                        
                        // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
                        let resultMsg = `å¯¼å…¥å®Œæˆï¼šåˆ›å»º ${createdCount} ä¸ªï¼Œæ›´æ–° ${updatedCount} ä¸ª`;
                        if (errorCount > 0) {
                            resultMsg += `ï¼Œå¤±è´¥ ${errorCount} ä¸ª`;
                        }
                        this.showNotification(resultMsg, 'success');
                        
                        resolve({
                            created: createdCount,
                            updated: updatedCount,
                            errors: errorCount,
                            total: importData.length
                        });
                    } catch (error) {
                        console.error('å¤„ç†å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                        reject(error);
                    }
                };
                
                const handleError = (event) => {
                    cleanup();
                    
                    const errorMsg = event.detail && event.detail.error ? event.detail.error : 'å¯¼å…¥å¤±è´¥';
                    reject(new Error(errorMsg));
                };
                
                window.addEventListener('jszip-import-success', handleSuccess);
                window.addEventListener('jszip-import-error', handleError);
                
                // æ³¨å…¥è„šæœ¬
                (document.head || document.documentElement).appendChild(importScript);
                
                // è®¾ç½®è¶…æ—¶ï¼ˆæ ¹æ®æ–‡ä»¶å¤§å°åŠ¨æ€è°ƒæ•´ï¼‰
                timeoutTimer = setTimeout(() => {
                    cleanup();
                    const timeoutMinutes = Math.round(finalTimeout / 60000);
                    reject(new Error(`å¯¼å…¥è¶…æ—¶ï¼ˆå·²ç­‰å¾… ${timeoutMinutes} åˆ†é’Ÿï¼‰ã€‚å¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼Œè¯·å°è¯•åˆ†æ‰¹å¯¼å…¥è¾ƒå°çš„æ–‡ä»¶ã€‚`));
                }, finalTimeout);
            });
        } catch (error) {
            console.error('å¯¼å…¥ä¼šè¯å¤±è´¥:', error);
            this.showNotification('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            throw error;
        }
    }
    
    // å¯¼å‡ºä¼šè¯ä¸ºZIPæ–‡ä»¶ï¼ˆä½¿ç”¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­çš„JSZipï¼‰
    async exportSessionsToZip() {
        try {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.showNotification('æ­£åœ¨å‡†å¤‡å¯¼å‡º...', 'info');
            
            // åŠ è½½JSZipåº“ï¼ˆåœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­ï¼‰
            await this._loadJSZip();
            
            // åˆ¤æ–­å½“å‰è§†å›¾æ¨¡å¼
            const sessionList = this.sessionSidebar?.querySelector('.session-list');
            const ossFileList = this.sessionSidebar?.querySelector('.oss-file-list');
            const newsList = this.sessionSidebar?.querySelector('.news-list');
            const apiRequestList = this.sessionSidebar?.querySelector('.api-request-list');
            const isFileListMode = ossFileList && ossFileList.style.display !== 'none';
            const isNewsListMode = newsList && newsList.style.display !== 'none';
            const isApiRequestListMode = apiRequestList && apiRequestList.style.display !== 'none' || this.apiRequestListVisible;
            
            // å¦‚æœæ˜¯æ–°é—»åˆ—è¡¨æ¨¡å¼ï¼Œå¯¼å‡ºæ–°é—»
            if (isNewsListMode) {
                return await this._exportNewsToZip();
            }
            
            // å¦‚æœæ˜¯è¯·æ±‚æ¥å£åˆ—è¡¨æ¨¡å¼ï¼Œå¯¼å‡ºè¯·æ±‚æ¥å£
            if (isApiRequestListMode) {
                return await this._exportApiRequestsToZip();
            }
            
            let sessions = [];
            
            // å¦‚æœåœ¨ OSS æ–‡ä»¶æ¨¡å¼ä¸‹ï¼Œå¯¼å‡ºä¸ OSS æ–‡ä»¶åˆ—è¡¨ä¸­å…·æœ‰ç›¸åŒ URL çš„ä¼šè¯
            if (isFileListMode) {
                // è·å– OSS æ–‡ä»¶åˆ—è¡¨ï¼ˆä» /oss/files/ æ¥å£ï¼‰
                if (!this.ossApi || !this.ossApi.isEnabled()) {
                    this.showNotification('OSS APIæœªå¯ç”¨ï¼Œæ— æ³•å¯¼å‡º', 'error');
                    return;
                }
                
                this.showNotification('æ­£åœ¨è·å– OSS æ–‡ä»¶åˆ—è¡¨...', 'info');
                let ossFiles = [];
                try {
                    // å¼ºåˆ¶åˆ·æ–°ï¼Œè·å–æœ€æ–°çš„æ–‡ä»¶åˆ—è¡¨
                    ossFiles = await this.ossApi.getFilesList({ forceRefresh: true });
                } catch (error) {
                    console.warn('è·å– OSS æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°ç¼“å­˜:', error);
                    // å¦‚æœ API è¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç®¡ç†å™¨
                    if (this.ossFileManager) {
                        ossFiles = this.ossFileManager.getAllFiles();
                    }
                }
                
                if (!Array.isArray(ossFiles) || ossFiles.length === 0) {
                    this.showNotification('OSS æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼Œæ²¡æœ‰å¯å¯¼å‡ºçš„ä¼šè¯', 'error');
                    return;
                }
                
                // æå– OSS æ–‡ä»¶åˆ—è¡¨ä¸­çš„ URLï¼ˆä» /oss/files/ æ¥å£è¿”å›çš„å®Œæ•´åˆ—è¡¨ï¼‰
                const ossFileUrls = new Set();
                ossFiles.forEach(file => {
                    if (file.url) {
                        ossFileUrls.add(file.url);
                    }
                });
                
                if (ossFileUrls.size === 0) {
                    this.showNotification('OSS æ–‡ä»¶åˆ—è¡¨ä¸­æ²¡æœ‰æœ‰æ•ˆçš„ URLï¼Œæ²¡æœ‰å¯å¯¼å‡ºçš„ä¼šè¯', 'error');
                    return;
                }
                
                // è·å–ç­›é€‰åçš„ OSS æ–‡ä»¶åˆ—è¡¨ï¼ˆåº”ç”¨äº†æ ‡ç­¾ç­›é€‰ã€æœç´¢ç­‰ï¼‰
                const filteredOssFiles = this._getFilteredFiles();
                
                // æå–ç­›é€‰åçš„ OSS æ–‡ä»¶åˆ—è¡¨ä¸­çš„ URL
                const filteredOssFileUrls = new Set();
                filteredOssFiles.forEach(file => {
                    if (file.url) {
                        filteredOssFileUrls.add(file.url);
                    }
                });
                
                if (filteredOssFileUrls.size === 0) {
                    this.showNotification('ç­›é€‰åçš„ OSS æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼Œæ²¡æœ‰å¯å¯¼å‡ºçš„ä¼šè¯', 'error');
                    return;
                }
                
                // è·å–æ‰€æœ‰ä¼šè¯åˆ—è¡¨
                const allSessionsRaw = this._getSessionsFromLocal();
                
                // æ’é™¤ OSS æ–‡ä»¶ä¼šè¯ï¼ˆä¿æŒä¸ _getFilteredSessions çš„ä¸€è‡´æ€§ï¼‰
                const allSessions = allSessionsRaw.filter(session => {
                    return !session._isOssFileSession;
                });
                
                // ç­›é€‰å‡º URL åŒæ—¶å­˜åœ¨äº OSS æ–‡ä»¶åˆ—è¡¨å’Œç­›é€‰åçš„ OSS æ–‡ä»¶åˆ—è¡¨ä¸­çš„ä¼šè¯
                sessions = allSessions.filter(session => {
                    const sessionUrl = session.url;
                    // å¿…é¡»åŒæ—¶æ»¡è¶³ï¼šåœ¨ OSS æ–‡ä»¶åˆ—è¡¨ä¸­ï¼Œä¸”åœ¨ç­›é€‰åçš„ OSS æ–‡ä»¶åˆ—è¡¨ä¸­
                    return sessionUrl && ossFileUrls.has(sessionUrl) && filteredOssFileUrls.has(sessionUrl);
                });
                
                console.log(`OSS æ–‡ä»¶æ¨¡å¼ä¸‹ï¼Œæ‰¾åˆ° ${sessions.length} ä¸ªåŒ¹é…çš„ä¼šè¯ï¼ˆå…± ${allSessions.length} ä¸ªä¼šè¯ï¼Œ${ossFileUrls.size} ä¸ª OSS æ–‡ä»¶ URLï¼Œ${filteredOssFileUrls.size} ä¸ªç­›é€‰åçš„ OSS æ–‡ä»¶ URLï¼‰`);
            } else {
                // é OSS æ–‡ä»¶æ¨¡å¼ï¼Œä½¿ç”¨åŸæ¥çš„é€»è¾‘
                sessions = this._getFilteredSessions();
            }
            
            if (sessions.length === 0) {
                this.showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„ä¼šè¯', 'error');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦æç¤º
            this.showNotification(`æ­£åœ¨è·å– ${sessions.length} ä¸ªä¼šè¯çš„å®Œæ•´æ•°æ®...`, 'info');
            
            // éå†æ¯ä¸ªä¼šè¯ï¼Œä»åç«¯APIè·å–å®Œæ•´æ•°æ®ï¼ˆåŒ…æ‹¬é¡µé¢ä¸Šä¸‹æ–‡å’ŒèŠå¤©æ¶ˆæ¯ï¼‰
            const exportData = [];
            for (let i = 0; i < sessions.length; i++) {
                const session = sessions[i];
                const sessionId = session.id || session.session_id;
                
                let fullSessionData = session; // é»˜è®¤ä½¿ç”¨æœ¬åœ°æ•°æ®
                
                // å¦‚æœå¯ç”¨äº†åç«¯åŒæ­¥ï¼Œå°è¯•ä»åç«¯è·å–å®Œæ•´çš„ä¼šè¯æ•°æ®
                if (sessionId && this.sessionApi && this.sessionApi.isEnabled()) {
                    try {
                        // å¼ºåˆ¶åˆ·æ–°ï¼Œè·å–æœ€æ–°çš„å®Œæ•´ä¼šè¯æ•°æ®
                        const backendSession = await this.sessionApi.getSession(sessionId, true);
                        
                        if (backendSession) {
                            // åˆå¹¶æ•°æ®ï¼šåç«¯æ•°æ®ä¼˜å…ˆï¼Œä½†ä¿ç•™æœ¬åœ°æ•°æ®ä¸­å¯èƒ½ç¼ºå¤±çš„å­—æ®µ
                            fullSessionData = {
                                ...session, // å…ˆä½¿ç”¨æœ¬åœ°æ•°æ®
                                ...backendSession, // åç«¯æ•°æ®è¦†ç›–ï¼ˆåŒ…å«å®Œæ•´çš„ pageContent å’Œ messagesï¼‰
                                id: sessionId, // ç¡®ä¿ ID ä¸€è‡´
                            };
                            console.log(`å·²ä»åç«¯è·å–ä¼šè¯ ${sessionId} çš„å®Œæ•´æ•°æ®`);
                        }
                    } catch (error) {
                        console.warn(`è·å–ä¼šè¯ ${sessionId} çš„å®Œæ•´æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:`, error.message);
                        // å¦‚æœè·å–å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨æœ¬åœ°æ•°æ®
                    }
                }
                
                // ç”Ÿæˆå¯¼å‡ºæ•°æ®
                const timestamp = fullSessionData.updatedAt || fullSessionData.createdAt || Date.now();
                const title = this._sanitizeFileName(fullSessionData.pageTitle || 'æœªå‘½åä¼šè¯');
                const tags = fullSessionData.tags || [];
                
                // ç”Ÿæˆé¡µé¢ä¸Šä¸‹æ–‡å†…å®¹ï¼ˆåˆå¹¶ context å’Œ chatï¼‰
                const contextMd = this._generateContextMd(fullSessionData);
                const chatMd = this._generateChatMd(fullSessionData);
                const pageContent = contextMd + '\n\n' + chatMd;
                
                exportData.push({
                    tags: tags,
                    title: title,
                    pageContent: pageContent
                });
                
                // æ›´æ–°è¿›åº¦æç¤ºï¼ˆæ¯10ä¸ªä¼šè¯æ›´æ–°ä¸€æ¬¡ï¼‰
                if ((i + 1) % 10 === 0 || (i + 1) === sessions.length) {
                    this.showNotification(`å·²å¤„ç† ${i + 1}/${sessions.length} ä¸ªä¼šè¯...`, 'info');
                }
            }
            
            // åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¯¼å‡ºé€»è¾‘
            this.showNotification('æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...', 'info');
            
            // æ£€æŸ¥æ‰©å±•ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
            let exportScriptUrl;
            try {
                // æ£€æŸ¥ chrome å¯¹è±¡å’Œ runtime æ˜¯å¦å­˜åœ¨
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šchrome.runtime ä¸å¯ç”¨');
                }
                
                // å°è¯•è®¿é—® runtime.id æ¥æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
                try {
                    const runtimeId = chrome.runtime.id;
                    if (!runtimeId) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šruntime.id ä¸ºç©º');
                    }
                } catch (idError) {
                    const errorMsg = (idError.message || idError.toString() || '').toLowerCase();
                    if (errorMsg.includes('extension context invalidated') || 
                        errorMsg.includes('context invalidated')) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡å·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    }
                    throw idError;
                }
                
                // è·å–å¯¼å‡ºè„šæœ¬ URL
                exportScriptUrl = chrome.runtime.getURL('export-sessions.js');
            } catch (error) {
                const errorMsg = error.message || 'æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆ';
                console.error('è·å–å¯¼å‡ºè„šæœ¬URLå¤±è´¥:', error);
                this.showNotification('å¯¼å‡ºå¤±è´¥: ' + errorMsg + 'ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚', 'error');
                throw new Error(errorMsg);
            }
            
            // ä½¿ç”¨æ³¨å…¥å¤–éƒ¨è„šæœ¬çš„æ–¹å¼ï¼ˆé¿å…CSPé™åˆ¶ï¼‰
            return new Promise((resolve, reject) => {
                // åˆ›å»ºæ•°æ®å®¹å™¨ï¼ˆé€šè¿‡dataå±æ€§ä¼ é€’æ•°æ®ï¼Œé¿å…å†…è”è„šæœ¬ï¼‰
                const dataContainer = document.createElement('div');
                dataContainer.id = '__jszip_export_data__';
                dataContainer.style.display = 'none';
                dataContainer.setAttribute('data-export', JSON.stringify(exportData));
                dataContainer.setAttribute('data-export-type', 'session');
                (document.head || document.documentElement).appendChild(dataContainer);
                
                // åŠ è½½å¤–éƒ¨å¯¼å‡ºè„šæœ¬
                const exportScript = document.createElement('script');
                exportScript.src = exportScriptUrl;
                exportScript.charset = 'UTF-8';
                exportScript.async = false;
                
                // ç›‘å¬å¯¼å‡ºç»“æœ
                const handleSuccess = (event) => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    // æ¸…ç†
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    this.showNotification(`æˆåŠŸå¯¼å‡º ${event.detail.count} ä¸ªä¼šè¯`, 'success');
                    resolve();
                };
                
                const handleError = (event) => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    // æ¸…ç†
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    const errorMsg = event.detail && event.detail.error ? event.detail.error : 'å¯¼å‡ºå¤±è´¥';
                    reject(new Error(errorMsg));
                };
                
                window.addEventListener('jszip-export-success', handleSuccess);
                window.addEventListener('jszip-export-error', handleError);
                
                // æ³¨å…¥è„šæœ¬
                (document.head || document.documentElement).appendChild(exportScript);
                
                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    reject(new Error('å¯¼å‡ºè¶…æ—¶'));
                }, 30000);
            });
        } catch (error) {
            console.error('å¯¼å‡ºä¼šè¯å¤±è´¥:', error);
            throw error;
        }
    }

    // å¯¼å‡ºæ–°é—»ä¸ºZIPæ–‡ä»¶
    async _exportNewsToZip() {
        try {
            // è·å–è¿‡æ»¤åçš„æ–°é—»åˆ—è¡¨
            let news = this._getFilteredNews();
            
            // å¦‚æœæœ‰é€‰ä¸­çš„æ–°é—»ï¼Œåªå¯¼å‡ºé€‰ä¸­çš„æ–°é—»
            if (this.batchMode && this.selectedNewsIds && this.selectedNewsIds.size > 0) {
                news = news.filter(item => {
                    const newsId = item.link || item.id || '';
                    return newsId && this.selectedNewsIds.has(newsId);
                });
            }
            
            if (news.length === 0) {
                this.showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„æ–°é—»', 'error');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦æç¤º
            this.showNotification(`æ­£åœ¨å¤„ç† ${news.length} æ¡æ–°é—»...`, 'info');
            
            // éå†æ¯æ¡æ–°é—»ï¼Œç”Ÿæˆå¯¼å‡ºæ•°æ®
            const exportData = [];
            for (let i = 0; i < news.length; i++) {
                const item = news[i];
                
                // ç”Ÿæˆæ ‡é¢˜ï¼ˆä½¿ç”¨æ–°é—»æ ‡é¢˜ï¼‰
                const title = this._sanitizeFileName(item.title || 'æœªå‘½åæ–°é—»');
                
                // è·å–æ ‡ç­¾
                const tags = item.tags || [];
                
                // ç”Ÿæˆæ–°é—»Markdownå†…å®¹
                const newsContent = this._generateNewsMd(item);
                
                exportData.push({
                    tags: tags,
                    title: title,
                    pageContent: newsContent
                });
                
                // æ›´æ–°è¿›åº¦æç¤ºï¼ˆæ¯10æ¡æ–°é—»æ›´æ–°ä¸€æ¬¡ï¼‰
                if ((i + 1) % 10 === 0 || (i + 1) === news.length) {
                    this.showNotification(`å·²å¤„ç† ${i + 1}/${news.length} æ¡æ–°é—»...`, 'info');
                }
            }
            
            // åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¯¼å‡ºé€»è¾‘
            this.showNotification('æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...', 'info');
            
            // æ£€æŸ¥æ‰©å±•ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
            let exportScriptUrl;
            try {
                // æ£€æŸ¥ chrome å¯¹è±¡å’Œ runtime æ˜¯å¦å­˜åœ¨
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šchrome.runtime ä¸å¯ç”¨');
                }
                
                // å°è¯•è®¿é—® runtime.id æ¥æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
                try {
                    const runtimeId = chrome.runtime.id;
                    if (!runtimeId) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šruntime.id ä¸ºç©º');
                    }
                } catch (idError) {
                    const errorMsg = (idError.message || idError.toString() || '').toLowerCase();
                    if (errorMsg.includes('extension context invalidated') || 
                        errorMsg.includes('context invalidated')) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡å·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    }
                    throw idError;
                }
                
                // è·å–å¯¼å‡ºè„šæœ¬ URL
                exportScriptUrl = chrome.runtime.getURL('export-sessions.js');
            } catch (error) {
                const errorMsg = error.message || 'æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆ';
                console.error('è·å–å¯¼å‡ºè„šæœ¬URLå¤±è´¥:', error);
                this.showNotification('å¯¼å‡ºå¤±è´¥: ' + errorMsg + 'ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚', 'error');
                throw new Error(errorMsg);
            }
            
            // ä½¿ç”¨æ³¨å…¥å¤–éƒ¨è„šæœ¬çš„æ–¹å¼ï¼ˆé¿å…CSPé™åˆ¶ï¼‰
            return new Promise((resolve, reject) => {
                // åˆ›å»ºæ•°æ®å®¹å™¨ï¼ˆé€šè¿‡dataå±æ€§ä¼ é€’æ•°æ®ï¼Œé¿å…å†…è”è„šæœ¬ï¼‰
                const dataContainer = document.createElement('div');
                dataContainer.id = '__jszip_export_data__';
                dataContainer.style.display = 'none';
                dataContainer.setAttribute('data-export', JSON.stringify(exportData));
                dataContainer.setAttribute('data-export-type', 'news');
                (document.head || document.documentElement).appendChild(dataContainer);
                
                // åŠ è½½å¤–éƒ¨å¯¼å‡ºè„šæœ¬
                const exportScript = document.createElement('script');
                exportScript.src = exportScriptUrl;
                exportScript.charset = 'UTF-8';
                exportScript.async = false;
                
                // ç›‘å¬å¯¼å‡ºç»“æœ
                const handleSuccess = (event) => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    // æ¸…ç†
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    this.showNotification(`æˆåŠŸå¯¼å‡º ${event.detail.count} æ¡æ–°é—»`, 'success');
                    resolve();
                };
                
                const handleError = (event) => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    // æ¸…ç†
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    const errorMsg = event.detail && event.detail.error ? event.detail.error : 'å¯¼å‡ºå¤±è´¥';
                    reject(new Error(errorMsg));
                };
                
                window.addEventListener('jszip-export-success', handleSuccess);
                window.addEventListener('jszip-export-error', handleError);
                
                // æ³¨å…¥è„šæœ¬
                (document.head || document.documentElement).appendChild(exportScript);
                
                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    reject(new Error('å¯¼å‡ºè¶…æ—¶'));
                }, 30000);
            });
        } catch (error) {
            console.error('å¯¼å‡ºæ–°é—»å¤±è´¥:', error);
            throw error;
        }
    }

    // ç”Ÿæˆæ–°é—»Markdownå†…å®¹
    _generateNewsMd(newsItem) {
        let content = `# ${newsItem.title || 'æœªå‘½åæ–°é—»'}\n\n`;
        
        // å‘å¸ƒæ—¶é—´
        const newsTime = this.getNewsTime(newsItem);
        if (newsTime > 0) {
            content += `**å‘å¸ƒæ—¶é—´**: ${this.formatNewsTime(newsTime)}\n\n`;
        }
        
        // é“¾æ¥
        if (newsItem.link) {
            content += `**åŸæ–‡é“¾æ¥**: ${newsItem.link}\n\n`;
        }
        
        // æ¥æº
        if (newsItem.source) {
            content += `**æ¥æº**: ${newsItem.source}\n\n`;
        }
        
        // æ ‡ç­¾
        if (newsItem.tags && newsItem.tags.length > 0) {
            content += `**æ ‡ç­¾**: ${newsItem.tags.join(', ')}\n\n`;
        }
        
        // æè¿°
        if (newsItem.description) {
            content += `## æ‘˜è¦\n\n${newsItem.description}\n\n`;
        }
        
        // æ­£æ–‡å†…å®¹
        if (newsItem.content) {
            content += `## æ­£æ–‡\n\n${newsItem.content}\n`;
        } else if (newsItem.description) {
            // å¦‚æœæ²¡æœ‰æ­£æ–‡ï¼Œä½¿ç”¨æè¿°ä½œä¸ºæ­£æ–‡
            content += `## æ­£æ–‡\n\n${newsItem.description}\n`;
        }
        
        return content;
    }

    // å¯¼å‡ºè¯·æ±‚æ¥å£ä¸ºZIPæ–‡ä»¶
    async _exportApiRequestsToZip() {
        try {
            // è·å–è¿‡æ»¤åçš„è¯·æ±‚æ¥å£åˆ—è¡¨
            let requests = this._getFilteredApiRequests();
            
            // å¦‚æœæœ‰é€‰ä¸­çš„è¯·æ±‚æ¥å£ï¼Œåªå¯¼å‡ºé€‰ä¸­çš„ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
            if (this.batchMode && this.selectedApiRequestIds && this.selectedApiRequestIds.size > 0) {
                requests = requests.filter(req => {
                    // ç¡®ä¿è¯·æ±‚æœ‰ key å­—æ®µ
                    this._ensureRequestKey(req);
                    const requestKey = this._getRequestKey(req);
                    return requestKey && this.selectedApiRequestIds.has(requestKey);
                });
            }
            
            if (requests.length === 0) {
                this.showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„è¯·æ±‚æ¥å£', 'error');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦æç¤º
            this.showNotification(`æ­£åœ¨å¤„ç† ${requests.length} ä¸ªè¯·æ±‚æ¥å£...`, 'info');
            
            // éå†æ¯ä¸ªè¯·æ±‚æ¥å£ï¼Œç”Ÿæˆå¯¼å‡ºæ•°æ®
            const exportData = [];
            for (let i = 0; i < requests.length; i++) {
                const req = requests[i];
                
                // ç”Ÿæˆæ ‡é¢˜ï¼ˆä½¿ç”¨è¯·æ±‚æ–¹æ³•å’ŒURLè·¯å¾„ï¼‰
                const apiPath = this._extractApiPath(req.url || '');
                const title = this._sanitizeFileName(`${req.method || 'GET'} ${apiPath}` || 'æœªå‘½åè¯·æ±‚æ¥å£');
                
                // è·å–æ ‡ç­¾
                const tags = req.tags || [];
                
                // ç”Ÿæˆè¯·æ±‚æ¥å£Markdownå†…å®¹
                const requestContent = this._generateApiRequestMd(req);
                
                exportData.push({
                    tags: tags,
                    title: title,
                    pageContent: requestContent
                });
                
                // æ›´æ–°è¿›åº¦æç¤ºï¼ˆæ¯10ä¸ªè¯·æ±‚æ›´æ–°ä¸€æ¬¡ï¼‰
                if ((i + 1) % 10 === 0 || (i + 1) === requests.length) {
                    this.showNotification(`å·²å¤„ç† ${i + 1}/${requests.length} ä¸ªè¯·æ±‚æ¥å£...`, 'info');
                }
            }
            
            // åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¯¼å‡ºé€»è¾‘
            this.showNotification('æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...', 'info');
            
            // æ£€æŸ¥æ‰©å±•ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
            let exportScriptUrl;
            try {
                // æ£€æŸ¥ chrome å¯¹è±¡å’Œ runtime æ˜¯å¦å­˜åœ¨
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šchrome.runtime ä¸å¯ç”¨');
                }
                
                // å°è¯•è®¿é—® runtime.id æ¥æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
                try {
                    const runtimeId = chrome.runtime.id;
                    if (!runtimeId) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆï¼šruntime.id ä¸ºç©º');
                    }
                } catch (idError) {
                    const errorMsg = (idError.message || idError.toString() || '').toLowerCase();
                    if (errorMsg.includes('extension context invalidated') || 
                        errorMsg.includes('context invalidated')) {
                        throw new Error('æ‰©å±•ä¸Šä¸‹æ–‡å·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    }
                    throw idError;
                }
                
                // è·å–å¯¼å‡ºè„šæœ¬ URL
                exportScriptUrl = chrome.runtime.getURL('export-sessions.js');
            } catch (error) {
                const errorMsg = error.message || 'æ‰©å±•ä¸Šä¸‹æ–‡æ— æ•ˆ';
                console.error('è·å–å¯¼å‡ºè„šæœ¬URLå¤±è´¥:', error);
                this.showNotification('å¯¼å‡ºå¤±è´¥: ' + errorMsg + 'ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚', 'error');
                throw new Error(errorMsg);
            }
            
            // ä½¿ç”¨æ³¨å…¥å¤–éƒ¨è„šæœ¬çš„æ–¹å¼ï¼ˆé¿å…CSPé™åˆ¶ï¼‰
            return new Promise((resolve, reject) => {
                // åˆ›å»ºæ•°æ®å®¹å™¨ï¼ˆé€šè¿‡dataå±æ€§ä¼ é€’æ•°æ®ï¼Œé¿å…å†…è”è„šæœ¬ï¼‰
                const dataContainer = document.createElement('div');
                dataContainer.id = '__jszip_export_data__';
                dataContainer.style.display = 'none';
                dataContainer.setAttribute('data-export', JSON.stringify(exportData));
                dataContainer.setAttribute('data-export-type', 'apiRequest');
                (document.head || document.documentElement).appendChild(dataContainer);
                
                // åŠ è½½å¤–éƒ¨å¯¼å‡ºè„šæœ¬
                const exportScript = document.createElement('script');
                exportScript.src = exportScriptUrl;
                exportScript.charset = 'UTF-8';
                exportScript.async = false;
                
                // ç›‘å¬å¯¼å‡ºç»“æœ
                const handleSuccess = (event) => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    // æ¸…ç†
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    this.showNotification(`æˆåŠŸå¯¼å‡º ${event.detail.count} ä¸ªè¯·æ±‚æ¥å£`, 'success');
                    resolve();
                };
                
                const handleError = (event) => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    // æ¸…ç†
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    const errorMsg = event.detail && event.detail.error ? event.detail.error : 'å¯¼å‡ºå¤±è´¥';
                    reject(new Error(errorMsg));
                };
                
                window.addEventListener('jszip-export-success', handleSuccess);
                window.addEventListener('jszip-export-error', handleError);
                
                // æ³¨å…¥è„šæœ¬
                (document.head || document.documentElement).appendChild(exportScript);
                
                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    window.removeEventListener('jszip-export-success', handleSuccess);
                    window.removeEventListener('jszip-export-error', handleError);
                    if (exportScript.parentNode) {
                        exportScript.parentNode.removeChild(exportScript);
                    }
                    if (dataContainer.parentNode) {
                        dataContainer.parentNode.removeChild(dataContainer);
                    }
                    reject(new Error('å¯¼å‡ºè¶…æ—¶'));
                }, 30000);
            });
        } catch (error) {
            console.error('å¯¼å‡ºè¯·æ±‚æ¥å£å¤±è´¥:', error);
            throw error;
        }
    }

    // ç”Ÿæˆè¯·æ±‚æ¥å£Markdownå†…å®¹
    _generateApiRequestMd(request) {
        let content = `# ${request.method || 'GET'} ${this._extractApiPath(request.url || '')}\n\n`;
        
        // è¯·æ±‚URL
        if (request.url) {
            content += `**è¯·æ±‚URL**: ${request.url}\n\n`;
        }
        
        // è¯·æ±‚æ–¹æ³•
        if (request.method) {
            content += `**è¯·æ±‚æ–¹æ³•**: ${request.method}\n\n`;
        }
        
        // çŠ¶æ€ç 
        if (request.status) {
            content += `**çŠ¶æ€ç **: ${request.status} ${request.statusText || ''}\n\n`;
        }
        
        // æ—¶é—´æˆ³
        if (request.timestamp) {
            const date = new Date(request.timestamp);
            content += `**è¯·æ±‚æ—¶é—´**: ${date.toLocaleString('zh-CN')}\n\n`;
        }
        
        // è€—æ—¶
        if (request.duration) {
            content += `**è€—æ—¶**: ${request.duration}ms\n\n`;
        }
        
        // é¡µé¢URL
        if (request.pageUrl) {
            content += `**é¡µé¢URL**: ${request.pageUrl}\n\n`;
        }
        
        // æ ‡ç­¾
        if (request.tags && request.tags.length > 0) {
            content += `**æ ‡ç­¾**: ${request.tags.join(', ')}\n\n`;
        }
        
        // è¯·æ±‚å¤´
        if (request.headers && Object.keys(request.headers).length > 0) {
            content += `## è¯·æ±‚å¤´\n\n\`\`\`json\n${JSON.stringify(request.headers, null, 2)}\n\`\`\`\n\n`;
        }
        
        // è¯·æ±‚ä½“
        if (request.body) {
            content += `## è¯·æ±‚ä½“\n\n`;
            if (typeof request.body === 'string') {
                try {
                    // å°è¯•æ ¼å¼åŒ–JSON
                    const parsed = JSON.parse(request.body);
                    content += `\`\`\`json\n${JSON.stringify(parsed, null, 2)}\n\`\`\`\n\n`;
                } catch (e) {
                    content += `\`\`\`\n${request.body}\n\`\`\`\n\n`;
                }
            } else if (typeof request.body === 'object') {
                content += `\`\`\`json\n${JSON.stringify(request.body, null, 2)}\n\`\`\`\n\n`;
            } else {
                content += `${request.body}\n\n`;
            }
        }
        
        // å“åº”å¤´
        if (request.responseHeaders && Object.keys(request.responseHeaders).length > 0) {
            content += `## å“åº”å¤´\n\n\`\`\`json\n${JSON.stringify(request.responseHeaders, null, 2)}\n\`\`\`\n\n`;
        }
        
        // å“åº”ä½“
        if (request.responseText) {
            content += `## å“åº”ä½“\n\n`;
            if (request.responseBody && typeof request.responseBody === 'object') {
                content += `\`\`\`json\n${JSON.stringify(request.responseBody, null, 2)}\n\`\`\`\n\n`;
            } else if (typeof request.responseText === 'string') {
                try {
                    // å°è¯•è§£æä¸ºJSONå¹¶æ ¼å¼åŒ–
                    const parsed = JSON.parse(request.responseText);
                    content += `\`\`\`json\n${JSON.stringify(parsed, null, 2)}\n\`\`\`\n\n`;
                } catch (e) {
                    // ä¸æ˜¯JSONï¼Œç›´æ¥æ˜¾ç¤º
                    content += `\`\`\`\n${request.responseText}\n\`\`\`\n\n`;
                }
            } else {
                content += `${request.responseText}\n\n`;
            }
        }
        
        // CURLå‘½ä»¤
        if (request.curl) {
            content += `## CURLå‘½ä»¤\n\n\`\`\`bash\n${request.curl}\n\`\`\`\n\n`;
        }
        
        return content;
    }

    // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
    updateTagFilterUI() {
        if (!this.sessionSidebar) return;
        
        // æ›´æ–°åå‘è¿‡æ»¤æŒ‰é’®çŠ¶æ€
        const reverseFilterBtn = this.sessionSidebar.querySelector('.tag-filter-reverse');
        if (reverseFilterBtn) {
            reverseFilterBtn.style.color = this.tagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.tagFilterReverse ? '1' : '0.6';
        }
        
        // æ›´æ–°æ— æ ‡ç­¾ç­›é€‰æŒ‰é’®çŠ¶æ€
        const noTagsFilterBtn = this.sessionSidebar.querySelector('.tag-filter-no-tags');
        if (noTagsFilterBtn) {
            noTagsFilterBtn.style.color = this.tagFilterNoTags ? '#4CAF50' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.tagFilterNoTags ? '1' : '0.6';
        }
        
        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ï¼ˆå¦‚æœæœ‰é€‰ä¸­çš„æ ‡ç­¾ã€å¯ç”¨äº†æ— æ ‡ç­¾ç­›é€‰æˆ–æœ‰æœç´¢å…³é”®è¯æ‰æ˜¾ç¤ºä¸ºå¯ç”¨çŠ¶æ€ï¼‰
        const clearFilterBtn = this.sessionSidebar.querySelector('.tag-filter-clear');
        if (clearFilterBtn) {
            const hasSelectedTags = this.selectedFilterTags && this.selectedFilterTags.length > 0;
            const hasSearchKeyword = this.tagFilterSearchKeyword && this.tagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.tagFilterNoTags || hasSearchKeyword;
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.cursor = hasActiveFilter ? 'pointer' : 'default';
        }
        
        const tagFilterList = this.sessionSidebar.querySelector('.tag-filter-list');
        if (!tagFilterList) return;
        
        // æ¸…ç©ºç°æœ‰æ ‡ç­¾
        tagFilterList.innerHTML = '';
        
        // è·å–æ‰€æœ‰æ ‡ç­¾
        const allTags = this.getAllTags();
        
        // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤æ ‡ç­¾
        let filteredTags = allTags;
        const searchKeyword = (this.tagFilterSearchKeyword || '').trim().toLowerCase();
        if (searchKeyword) {
            filteredTags = allTags.filter(tag => 
                tag.toLowerCase().includes(searchKeyword)
            );
        }
        
        if (filteredTags.length === 0) {
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ ‡ç­¾ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const expandToggleBtn = this.sessionSidebar.querySelector('.tag-filter-expand-btn');
            if (expandToggleBtn) {
                expandToggleBtn.style.display = 'none';
            }
            // æ˜¾ç¤º"æ— åŒ¹é…æ ‡ç­¾"æç¤º
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = searchKeyword ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ ‡ç­¾' : 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                padding: 8px !important;
                text-align: center !important;
                color: #9ca3af !important;
                font-size: 11px !important;
            `;
            tagFilterList.appendChild(emptyMsg);
            return;
        }
        
        // ç¡®å®šè¦æ˜¾ç¤ºçš„æ ‡ç­¾ï¼ˆæ ¹æ®æŠ˜å çŠ¶æ€ï¼‰
        // ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾å§‹ç»ˆæ˜¾ç¤º
        const selectedTags = this.selectedFilterTags || [];
        let visibleTags;
        let hasMoreTags;
        
        if (this.tagFilterExpanded || searchKeyword) {
            // å±•å¼€çŠ¶æ€æˆ–æœ‰æœç´¢å…³é”®è¯æ—¶ï¼šæ˜¾ç¤ºæ‰€æœ‰è¿‡æ»¤åçš„æ ‡ç­¾
            visibleTags = filteredTags;
            hasMoreTags = false;
        } else {
            // æŠ˜å çŠ¶æ€ï¼šæ˜¾ç¤ºå‰Nä¸ªæ ‡ç­¾ï¼Œä½†ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾ä¹Ÿåœ¨å…¶ä¸­
            const defaultVisible = filteredTags.slice(0, this.tagFilterVisibleCount);
            const selectedNotInDefault = selectedTags.filter(tag => !defaultVisible.includes(tag));
            
            // ä¿æŒfilteredTagsçš„åŸå§‹é¡ºåºï¼Œä½†ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾ä¹Ÿåœ¨å¯è§åˆ—è¡¨ä¸­
            const visibleSet = new Set([...defaultVisible, ...selectedNotInDefault]);
            visibleTags = filteredTags.filter(tag => visibleSet.has(tag));
            hasMoreTags = filteredTags.length > visibleTags.length;
        }
        
        // æ›´æ–°å±•å¼€/æŠ˜å æŒ‰é’®ï¼ˆæœ‰æœç´¢å…³é”®è¯æ—¶éšè—ï¼‰
        const expandToggleBtn = this.sessionSidebar.querySelector('.tag-filter-expand-btn');
        if (expandToggleBtn) {
            if (searchKeyword) {
                // æœ‰æœç´¢å…³é”®è¯æ—¶éšè—å±•å¼€/æŠ˜å æŒ‰é’®
                expandToggleBtn.style.display = 'none';
            } else if (hasMoreTags || this.tagFilterExpanded) {
                expandToggleBtn.style.display = 'block';
                if (this.tagFilterExpanded) {
                    expandToggleBtn.innerHTML = 'â–²';
                    expandToggleBtn.title = 'æ”¶èµ·æ ‡ç­¾';
                } else {
                    expandToggleBtn.innerHTML = 'â–¼';
                    expandToggleBtn.title = 'å±•å¼€æ ‡ç­¾';
                }
            } else {
                expandToggleBtn.style.display = 'none';
            }
        }
        
        // è®¡ç®—æ¯ä¸ªæ ‡ç­¾å¯¹åº”çš„ä¼šè¯æ•°é‡
        const tagCounts = {};
        const allSessions = this._getSessionsFromLocal();
        allSessions.forEach(session => {
            if (session.tags && Array.isArray(session.tags)) {
                session.tags.forEach(t => {
                    if (t && t.trim()) {
                        const normalizedTag = t.trim();
                        tagCounts[normalizedTag] = (tagCounts[normalizedTag] || 0) + 1;
                    }
                });
            }
        });
        
        // è®¾ç½®æ ‡ç­¾åˆ—è¡¨ä¸ºå¯æ‹–æ‹½å®¹å™¨
        tagFilterList.style.cssText += `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 6px !important;
            position: relative !important;
        `;
        
        // æ·»åŠ æ‹–æ‹½æ ·å¼è¡¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
        if (!document.getElementById('tag-drag-styles')) {
            const style = document.createElement('style');
            style.id = 'tag-drag-styles';
            style.textContent = `
                .tag-filter-item {
                    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
                }
                .tag-filter-item:hover:not(.dragging) {
                    transform: translateY(-1px) !important;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                }
                .tag-filter-item.dragging {
                    opacity: 0.5 !important;
                    transform: scale(0.92) rotate(2deg) !important;
                    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3) !important;
                    cursor: grabbing !important;
                    z-index: 1000 !important;
                }
                .tag-filter-item.drag-over-top {
                    border-top: 3px solid #4CAF50 !important;
                    margin-top: 4px !important;
                    padding-top: 2px !important;
                    animation: pulse-top 0.3s ease !important;
                }
                .tag-filter-item.drag-over-bottom {
                    border-bottom: 3px solid #4CAF50 !important;
                    margin-bottom: 4px !important;
                    padding-bottom: 2px !important;
                    animation: pulse-bottom 0.3s ease !important;
                }
                @keyframes pulse-top {
                    0%, 100% { border-top-width: 3px; margin-top: 4px; }
                    50% { border-top-width: 4px; margin-top: 6px; }
                }
                @keyframes pulse-bottom {
                    0%, 100% { border-bottom-width: 3px; margin-bottom: 4px; }
                    50% { border-bottom-width: 4px; margin-bottom: 6px; }
                }
                .tag-filter-item.drag-hover {
                    background: #f0fdf4 !important;
                    border-color: #86efac !important;
                    transform: scale(1.05) !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // åˆ›å»ºæ ‡ç­¾æŒ‰é’®ï¼ˆæ”¯æŒæ‹–æ‹½æ’åºï¼‰
        visibleTags.forEach((tag, index) => {
            const tagBtn = document.createElement('button');
            tagBtn.className = 'tag-filter-item';
            tagBtn.draggable = true;
            tagBtn.dataset.tagName = tag;
            const count = tagCounts[tag] || 0;
            tagBtn.textContent = `${tag} (${count})`;
            tagBtn.title = `æ‹–æ‹½è°ƒæ•´é¡ºåº | ç‚¹å‡»ç­›é€‰`;
            const isSelected = this.selectedFilterTags && this.selectedFilterTags.includes(tag);
            
            tagBtn.style.cssText = `
                padding: 4px 10px !important;
                border-radius: 12px !important;
                border: 1.5px solid ${isSelected ? '#4CAF50' : '#e5e7eb'} !important;
                background: ${isSelected ? '#4CAF50' : '#f9fafb'} !important;
                color: ${isSelected ? 'white' : '#6b7280'} !important;
                font-size: 10px !important;
                font-weight: ${isSelected ? '500' : '400'} !important;
                cursor: grab !important;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
                white-space: nowrap !important;
                line-height: 1.4 !important;
                position: relative !important;
                user-select: none !important;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
            `;
            
            // æ‹–æ‹½å¼€å§‹
            tagBtn.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', tagBtn.outerHTML);
                e.dataTransfer.setData('text/plain', tag);
                
                // æ·»åŠ æ‹–æ‹½ä¸­çš„ç±»åï¼ˆCSSä¼šå¤„ç†æ ·å¼ï¼‰
                tagBtn.classList.add('dragging');
                
                // è®¾ç½®è‡ªå®šä¹‰æ‹–æ‹½å›¾åƒ
                const dragImage = tagBtn.cloneNode(true);
                dragImage.style.opacity = '0.8';
                dragImage.style.transform = 'rotate(3deg)';
                dragImage.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.2)';
                dragImage.style.position = 'absolute';
                dragImage.style.top = '-1000px';
                document.body.appendChild(dragImage);
                e.dataTransfer.setDragImage(dragImage, e.offsetX, e.offsetY);
                
                // å»¶è¿Ÿç§»é™¤æ‹–æ‹½å›¾åƒ
                setTimeout(() => {
                    if (dragImage.parentNode) {
                        dragImage.parentNode.removeChild(dragImage);
                    }
                }, 0);
            });
            
            // æ‹–æ‹½ç»“æŸ
            tagBtn.addEventListener('dragend', (e) => {
                tagBtn.classList.remove('dragging');
                tagBtn.style.cursor = 'grab';
                
                // ç§»é™¤æ‰€æœ‰æ‹–æ‹½ç›¸å…³çš„æ ·å¼å’Œç±»å
                document.querySelectorAll('.tag-filter-item').forEach(item => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-hover');
                    item.style.borderTop = '';
                    item.style.borderBottom = '';
                    item.style.marginTop = '';
                    item.style.marginBottom = '';
                    item.style.paddingTop = '';
                    item.style.paddingBottom = '';
                });
            });
            
            // æ‹–æ‹½ç»è¿‡
            tagBtn.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                
                // å¦‚æœå½“å‰å…ƒç´ æ­£åœ¨è¢«æ‹–æ‹½ï¼Œè·³è¿‡
                if (tagBtn.classList.contains('dragging')) {
                    return;
                }
                
                const rect = tagBtn.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                
                // ç§»é™¤æ‰€æœ‰æ‹–æ‹½æŒ‡ç¤ºæ ·å¼å’Œç±»å
                document.querySelectorAll('.tag-filter-item').forEach(item => {
                    if (!item.classList.contains('dragging')) {
                        item.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-hover');
                    }
                });
                
                // æ ¹æ®é¼ æ ‡ä½ç½®æ˜¾ç¤ºæ’å…¥ä½ç½®æŒ‡ç¤º
                if (e.clientY < midY) {
                    tagBtn.classList.add('drag-over-top');
                    tagBtn.classList.remove('drag-over-bottom');
                } else {
                    tagBtn.classList.add('drag-over-bottom');
                    tagBtn.classList.remove('drag-over-top');
                }
                
                // æ·»åŠ æ‚¬åœæ•ˆæœ
                tagBtn.classList.add('drag-hover');
            });
            
            // æ‹–æ‹½ç¦»å¼€
            tagBtn.addEventListener('dragleave', (e) => {
                // æ£€æŸ¥é¼ æ ‡æ˜¯å¦çœŸçš„ç¦»å¼€äº†å…ƒç´ 
                const rect = tagBtn.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;
                
                if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                    tagBtn.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-hover');
                }
            });
            
            // æ”¾ç½®
            tagBtn.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const draggedTag = e.dataTransfer.getData('text/plain');
                const targetTag = tagBtn.dataset.tagName;
                
                if (draggedTag === targetTag) {
                    return;
                }
                
                // è·å–æ‰€æœ‰æ ‡ç­¾ï¼ˆåŒ…æ‹¬ä¸å¯è§çš„ï¼‰
                const allTags = this.getAllTags();
                const draggedIndex = allTags.indexOf(draggedTag);
                const targetIndex = allTags.indexOf(targetTag);
                
                if (draggedIndex === -1 || targetIndex === -1) {
                    return;
                }
                
                // è®¡ç®—æ–°çš„æ’å…¥ä½ç½®
                const rect = tagBtn.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                let insertIndex = targetIndex;
                if (e.clientY < midY) {
                    insertIndex = targetIndex;
                } else {
                    insertIndex = targetIndex + 1;
                }
                
                // è°ƒæ•´æ’å…¥ä½ç½®ï¼ˆå¦‚æœæ‹–æ‹½çš„å…ƒç´ åœ¨ç›®æ ‡ä½ç½®ä¹‹å‰ï¼Œéœ€è¦å‡1ï¼‰
                if (draggedIndex < insertIndex) {
                    insertIndex -= 1;
                }
                
                // é‡æ–°æ’åºæ ‡ç­¾æ•°ç»„
                const newOrder = [...allTags];
                newOrder.splice(draggedIndex, 1);
                newOrder.splice(insertIndex, 0, draggedTag);
                
                // ä¿å­˜æ–°çš„é¡ºåº
                this.saveTagOrder(newOrder);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                this.showNotification('æ ‡ç­¾é¡ºåºå·²æ›´æ–°', 'success');
                
                // æ›´æ–°UIï¼ˆæ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœï¼‰
                setTimeout(() => {
                    this.updateTagFilterUI();
                }, 100);
            });
            
            tagBtn.addEventListener('mouseenter', (e) => {
                // å¦‚æœæ­£åœ¨æ‹–æ‹½ï¼Œä¸æ”¹å˜æ ·å¼
                if (document.querySelector('.tag-filter-item.dragging')) {
                    return;
                }
                
                if (!isSelected) {
                    tagBtn.style.borderColor = '#4CAF50';
                    tagBtn.style.background = '#f0fdf4';
                    tagBtn.style.color = '#4CAF50';
                } else {
                    tagBtn.style.opacity = '0.95';
                }
            });
            tagBtn.addEventListener('mouseleave', () => {
                // å¦‚æœæ­£åœ¨æ‹–æ‹½ï¼Œä¸æ”¹å˜æ ·å¼
                if (document.querySelector('.tag-filter-item.dragging')) {
                    return;
                }
                
                if (!isSelected) {
                    tagBtn.style.borderColor = '#e5e7eb';
                    tagBtn.style.background = '#f9fafb';
                    tagBtn.style.color = '#6b7280';
                } else {
                    tagBtn.style.opacity = '1';
                }
            });
            tagBtn.addEventListener('click', (e) => {
                // å¦‚æœæ˜¯åœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­ç‚¹å‡»ï¼Œä¸è§¦å‘é€‰ä¸­é€»è¾‘
                if (e.detail === 0) {
                    return;
                }
                
                if (!this.selectedFilterTags) {
                    this.selectedFilterTags = [];
                }
                
                const index = this.selectedFilterTags.indexOf(tag);
                if (index > -1) {
                    // å–æ¶ˆé€‰ä¸­
                    this.selectedFilterTags.splice(index, 1);
                } else {
                    // é€‰ä¸­
                    this.selectedFilterTags.push(tag);
                }
                
                // æ›´æ–°æ‰€æœ‰æ ‡ç­¾æŒ‰é’®ï¼ˆç¡®ä¿çŠ¶æ€ä¸€è‡´ï¼‰
                this.updateTagFilterUI();
                // æ›´æ–°ä¼šè¯åˆ—è¡¨ï¼ˆåº”ç”¨è¿‡æ»¤ï¼‰
                this.updateSessionSidebar();
            });
            
            tagFilterList.appendChild(tagBtn);
        });
    }

    // åˆ›å»ºOSSæ ‡ç­¾ç­›é€‰å™¨
    /**
     * åˆ›å»ºæ—¥å†ç»„ä»¶
     * æ”¯æŒæ—¥æœŸåŒºé—´é€‰æ‹©å’ŒæŠ˜å /å±•å¼€åŠŸèƒ½
     */
    createCalendarComponent() {
        const mainColor = PET_CONFIG?.theme?.primaryColor || '#6366f1';
        
        // æ—¥å†å®¹å™¨
        const calendarContainer = document.createElement('div');
        calendarContainer.className = 'date-range-calendar-container';
        calendarContainer.style.cssText = `
            width: 100% !important;
            margin-bottom: 8px !important;
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            transition: all 0.3s ease !important;
        `;
        
        // æ—¥å†å¤´éƒ¨ï¼ˆæŠ˜å /å±•å¼€æŒ‰é’®å’Œæ—¥æœŸæ˜¾ç¤ºï¼‰
        const calendarHeader = document.createElement('div');
        calendarHeader.style.cssText = `
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 8px 12px !important;
            background: #f9fafb !important;
            border-bottom: 1px solid #e5e7eb !important;
            cursor: pointer !important;
            user-select: none !important;
        `;
        
        // å·¦ä¾§ï¼šå›¾æ ‡å’Œæ ‡é¢˜
        const headerLeft = document.createElement('div');
        headerLeft.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            flex: 1 !important;
        `;
        
        const calendarIcon = document.createElement('span');
        calendarIcon.textContent = 'ğŸ“…';
        calendarIcon.style.cssText = `
            font-size: 16px !important;
        `;
        
        // æ—¥æœŸåŒºé—´æ˜¾ç¤ºå’Œæ¸…é™¤æŒ‰é’®å®¹å™¨
        const dateRangeContainer = document.createElement('div');
        dateRangeContainer.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            margin-left: 8px !important;
        `;
        
        const dateRangeDisplay = document.createElement('span');
        dateRangeDisplay.className = 'date-range-display';
        dateRangeDisplay.style.cssText = `
            font-size: 11px !important;
            color: #6b7280 !important;
        `;
        this.updateDateRangeDisplay(dateRangeDisplay);
        
        // æ¸…é™¤æ—¥æœŸè¿‡æ»¤æŒ‰é’®
        const clearDateBtn = document.createElement('button');
        clearDateBtn.innerHTML = 'âœ•';
        clearDateBtn.className = 'clear-date-filter-btn';
        clearDateBtn.title = 'æ¸…é™¤æ—¥æœŸç­›é€‰';
        clearDateBtn.style.cssText = `
            width: 16px !important;
            height: 16px !important;
            border: none !important;
            background: #e5e7eb !important;
            color: #6b7280 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: ${this.dateRangeFilter ? 'flex' : 'none'} !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            padding: 0 !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
        `;
        
        clearDateBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.dateRangeFilter = null;
            this.updateDateRangeDisplay(dateRangeDisplay);
            clearDateBtn.style.display = 'none';
            this.updateCalendarDays(this.calendarDaysGrid, this.calendarMonth);
            this.applyDateFilter();
        });
        
        clearDateBtn.addEventListener('mouseenter', () => {
            clearDateBtn.style.background = '#d1d5db';
            clearDateBtn.style.transform = 'scale(1.1)';
        });
        
        clearDateBtn.addEventListener('mouseleave', () => {
            clearDateBtn.style.background = '#e5e7eb';
            clearDateBtn.style.transform = 'scale(1)';
        });
        
        dateRangeContainer.appendChild(dateRangeDisplay);
        dateRangeContainer.appendChild(clearDateBtn);
        
        // å³ä¾§å®¹å™¨ï¼šæ—¥æœŸå¯¼èˆªæŒ‰é’®ç»„å’ŒæŠ˜å /å±•å¼€æŒ‰é’®
        const headerRight = document.createElement('div');
        headerRight.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
        `;
        
        // æ—¥æœŸå¯¼èˆªæŒ‰é’®ç»„å®¹å™¨
        const dayNavContainer = document.createElement('div');
        dayNavContainer.className = 'day-navigation-container';
        dayNavContainer.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 2px !important;
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 6px !important;
            padding: 2px !important;
            margin-right: 8px !important;
        `;
        
        // ä¸Šä¸€å¤©å¿«æ·æŒ‰é’®
        const prevDayBtn = document.createElement('button');
        prevDayBtn.innerHTML = 'â—€';
        prevDayBtn.className = 'prev-day-btn';
        prevDayBtn.title = 'ä¸Šä¸€å¤©';
        prevDayBtn.style.cssText = `
            width: 24px !important;
            height: 24px !important;
            border: none !important;
            background: transparent !important;
            color: #6b7280 !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            padding: 0 !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            line-height: 1 !important;
            position: relative !important;
        `;
        
        prevDayBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const oldMonth = this.calendarMonth ? new Date(this.calendarMonth) : null;
            this.navigateDay(-1);
            this.updateDateRangeDisplay(dateRangeDisplay);
            if (this.clearDateBtn) {
                this.clearDateBtn.style.display = this.dateRangeFilter ? 'flex' : 'none';
            }
            // å¦‚æœæœˆä»½æ”¹å˜äº†ï¼Œæ›´æ–°æœˆä»½æ ‡é¢˜
            if (oldMonth && this.calendarMonth && 
                (oldMonth.getFullYear() !== this.calendarMonth.getFullYear() || 
                 oldMonth.getMonth() !== this.calendarMonth.getMonth())) {
                if (this.calendarMonthTitle) {
                    this.updateMonthTitle(this.calendarMonthTitle, this.calendarMonth);
                }
            }
            this.updateCalendarDays(this.calendarDaysGrid, this.calendarMonth);
            this.applyDateFilter();
        });
        
        prevDayBtn.addEventListener('mouseenter', () => {
            prevDayBtn.style.background = '#f3f4f6';
            prevDayBtn.style.color = mainColor;
            prevDayBtn.style.transform = 'scale(1.1)';
        });
        
        prevDayBtn.addEventListener('mouseleave', () => {
            prevDayBtn.style.background = 'transparent';
            prevDayBtn.style.color = '#6b7280';
            prevDayBtn.style.transform = 'scale(1)';
        });
        
        prevDayBtn.addEventListener('mousedown', () => {
            prevDayBtn.style.transform = 'scale(0.95)';
        });
        
        prevDayBtn.addEventListener('mouseup', () => {
            prevDayBtn.style.transform = 'scale(1.1)';
        });
        
        // ä¸‹ä¸€å¤©å¿«æ·æŒ‰é’®
        const nextDayBtn = document.createElement('button');
        nextDayBtn.innerHTML = 'â–¶';
        nextDayBtn.className = 'next-day-btn';
        nextDayBtn.title = 'ä¸‹ä¸€å¤©';
        nextDayBtn.style.cssText = `
            width: 24px !important;
            height: 24px !important;
            border: none !important;
            background: transparent !important;
            color: #6b7280 !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            padding: 0 !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            line-height: 1 !important;
            position: relative !important;
        `;
        
        nextDayBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const oldMonth = this.calendarMonth ? new Date(this.calendarMonth) : null;
            this.navigateDay(1);
            this.updateDateRangeDisplay(dateRangeDisplay);
            if (this.clearDateBtn) {
                this.clearDateBtn.style.display = this.dateRangeFilter ? 'flex' : 'none';
            }
            // å¦‚æœæœˆä»½æ”¹å˜äº†ï¼Œæ›´æ–°æœˆä»½æ ‡é¢˜
            if (oldMonth && this.calendarMonth && 
                (oldMonth.getFullYear() !== this.calendarMonth.getFullYear() || 
                 oldMonth.getMonth() !== this.calendarMonth.getMonth())) {
                if (this.calendarMonthTitle) {
                    this.updateMonthTitle(this.calendarMonthTitle, this.calendarMonth);
                }
            }
            this.updateCalendarDays(this.calendarDaysGrid, this.calendarMonth);
            this.applyDateFilter();
        });
        
        nextDayBtn.addEventListener('mouseenter', () => {
            nextDayBtn.style.background = '#f3f4f6';
            nextDayBtn.style.color = mainColor;
            nextDayBtn.style.transform = 'scale(1.1)';
        });
        
        nextDayBtn.addEventListener('mouseleave', () => {
            nextDayBtn.style.background = 'transparent';
            nextDayBtn.style.color = '#6b7280';
            nextDayBtn.style.transform = 'scale(1)';
        });
        
        nextDayBtn.addEventListener('mousedown', () => {
            nextDayBtn.style.transform = 'scale(0.95)';
        });
        
        nextDayBtn.addEventListener('mouseup', () => {
            nextDayBtn.style.transform = 'scale(1.1)';
        });
        
        dayNavContainer.appendChild(prevDayBtn);
        dayNavContainer.appendChild(nextDayBtn);
        
        // å³ä¾§ï¼šæŠ˜å /å±•å¼€æŒ‰é’®
        const toggleBtn = document.createElement('span');
        toggleBtn.className = 'calendar-toggle-btn';
        toggleBtn.textContent = this.calendarCollapsed ? 'â–¶' : 'â–¼';
        toggleBtn.style.cssText = `
            font-size: 12px !important;
            color: #6b7280 !important;
            transition: transform 0.3s ease !important;
            cursor: pointer !important;
        `;
        
        headerRight.appendChild(dayNavContainer);
        headerRight.appendChild(toggleBtn);
        
        headerLeft.appendChild(calendarIcon);
        headerLeft.appendChild(dateRangeContainer);
        calendarHeader.appendChild(headerLeft);
        calendarHeader.appendChild(headerRight);
        
        // æ—¥å†å†…å®¹åŒºåŸŸ
        const calendarContent = document.createElement('div');
        calendarContent.className = 'calendar-content';
        calendarContent.style.cssText = `
            display: ${this.calendarCollapsed ? 'none' : 'block'} !important;
            padding: 12px !important;
        `;
        
        // åˆ›å»ºæ—¥å†ä¸»ä½“
        const calendarBody = this.createCalendarBody();
        calendarContent.appendChild(calendarBody);
        
        // æŠ˜å /å±•å¼€åŠŸèƒ½
        const toggleCalendar = () => {
            this.calendarCollapsed = !this.calendarCollapsed;
            calendarContent.style.display = this.calendarCollapsed ? 'none' : 'block';
            toggleBtn.textContent = this.calendarCollapsed ? 'â–¶' : 'â–¼';
            toggleBtn.style.transform = this.calendarCollapsed ? 'rotate(0deg)' : 'rotate(0deg)';
            this.saveCalendarCollapsed();
        };
        
        calendarHeader.addEventListener('click', (e) => {
            if (e.target !== toggleBtn && !toggleBtn.contains(e.target)) {
                toggleCalendar();
            }
        });
        
        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleCalendar();
        });
        
        calendarContainer.appendChild(calendarHeader);
        calendarContainer.appendChild(calendarContent);
        
        // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­æ›´æ–°
        this.calendarContainer = calendarContainer;
        this.dateRangeDisplay = dateRangeDisplay;
        this.calendarContent = calendarContent;
        this.clearDateBtn = clearDateBtn;
        this.prevDayBtn = prevDayBtn;
        this.nextDayBtn = nextDayBtn;
        
        return calendarContainer;
    }
    
    /**
     * åˆ›å»ºæ—¥å†ä¸»ä½“ï¼ˆåŒ…å«æœˆä»½å¯¼èˆªå’Œæ—¥æœŸç½‘æ ¼ï¼‰
     */
    createCalendarBody() {
        const mainColor = PET_CONFIG?.theme?.primaryColor || '#6366f1';
        const today = new Date();
        const currentMonth = this.calendarMonth || new Date(today.getFullYear(), today.getMonth(), 1);
        
        // æ—¥å†ä¸»ä½“å®¹å™¨
        const calendarBody = document.createElement('div');
        calendarBody.className = 'calendar-body';
        calendarBody.style.cssText = `
            width: 100% !important;
        `;
        
        // æœˆä»½å¯¼èˆª
        const monthNav = document.createElement('div');
        monthNav.style.cssText = `
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            margin-bottom: 12px !important;
        `;
        
        const prevMonthBtn = document.createElement('button');
        prevMonthBtn.innerHTML = 'â€¹';
        prevMonthBtn.style.cssText = `
            width: 28px !important;
            height: 28px !important;
            border: 1px solid #e5e7eb !important;
            background: #ffffff !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 18px !important;
            color: #374151 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
        `;
        
        const monthTitle = document.createElement('div');
        monthTitle.className = 'calendar-month-title';
        monthTitle.style.cssText = `
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #374151 !important;
            flex: 1 !important;
            text-align: center !important;
        `;
        this.updateMonthTitle(monthTitle, currentMonth);
        
        const nextMonthBtn = document.createElement('button');
        nextMonthBtn.innerHTML = 'â€º';
        nextMonthBtn.style.cssText = `
            width: 28px !important;
            height: 28px !important;
            border: 1px solid #e5e7eb !important;
            background: #ffffff !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 18px !important;
            color: #374151 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
        `;
        
        // æŒ‰é’®æ‚¬åœæ•ˆæœ
        const addButtonHover = (btn) => {
            btn.addEventListener('mouseenter', () => {
                btn.style.background = '#f3f4f6';
                btn.style.borderColor = mainColor;
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.background = '#ffffff';
                btn.style.borderColor = '#e5e7eb';
            });
        };
        addButtonHover(prevMonthBtn);
        addButtonHover(nextMonthBtn);
        
        // æœˆä»½åˆ‡æ¢
        prevMonthBtn.addEventListener('click', () => {
            const baseMonth = this.calendarMonth || currentMonth;
            const newMonth = new Date(baseMonth.getFullYear(), baseMonth.getMonth() - 1, 1);
            this.calendarMonth = newMonth;
            this.updateCalendarDays(calendarDaysGrid, newMonth);
            this.updateMonthTitle(monthTitle, newMonth);
        });
        
        nextMonthBtn.addEventListener('click', () => {
            const baseMonth = this.calendarMonth || currentMonth;
            const newMonth = new Date(baseMonth.getFullYear(), baseMonth.getMonth() + 1, 1);
            this.calendarMonth = newMonth;
            this.updateCalendarDays(calendarDaysGrid, newMonth);
            this.updateMonthTitle(monthTitle, newMonth);
        });
        
        monthNav.appendChild(prevMonthBtn);
        monthNav.appendChild(monthTitle);
        monthNav.appendChild(nextMonthBtn);
        
        // æ˜ŸæœŸæ ‡é¢˜
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekdaysRow = document.createElement('div');
        weekdaysRow.style.cssText = `
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            gap: 2px !important;
            margin-bottom: 4px !important;
        `;
        
        weekdays.forEach(day => {
            const weekdayCell = document.createElement('div');
            weekdayCell.textContent = day;
            weekdayCell.style.cssText = `
                text-align: center !important;
                font-size: 11px !important;
                font-weight: 600 !important;
                color: #6b7280 !important;
                padding: 4px 0 !important;
            `;
            weekdaysRow.appendChild(weekdayCell);
        });
        
        // æ—¥æœŸç½‘æ ¼
        const calendarDaysGrid = document.createElement('div');
        calendarDaysGrid.className = 'calendar-days-grid';
        calendarDaysGrid.style.cssText = `
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            gap: 2px !important;
        `;
        
        this.updateCalendarDays(calendarDaysGrid, currentMonth);
        
        calendarBody.appendChild(monthNav);
        calendarBody.appendChild(weekdaysRow);
        calendarBody.appendChild(calendarDaysGrid);
        
        // ä¿å­˜å¼•ç”¨
        this.calendarMonthTitle = monthTitle;
        this.calendarDaysGrid = calendarDaysGrid;
        this.calendarMonth = currentMonth;
        
        return calendarBody;
    }
    
    /**
     * æ›´æ–°æœˆä»½æ ‡é¢˜
     */
    updateMonthTitle(element, date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        element.textContent = `${year}å¹´${month}æœˆ`;
    }
    
    /**
     * æ›´æ–°æ—¥å†æ—¥æœŸç½‘æ ¼
     */
    updateCalendarDays(grid, month) {
        grid.innerHTML = '';
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const year = month.getFullYear();
        const monthIndex = month.getMonth();
        
        // è·å–æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
        const firstDay = new Date(year, monthIndex, 1);
        const lastDay = new Date(year, monthIndex + 1, 0);
        
        // è·å–ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥ï¼‰
        const firstDayWeek = firstDay.getDay();
        
        // è·å–ä¸Šä¸ªæœˆçš„æœ€åå‡ å¤©ï¼ˆç”¨äºå¡«å……ç¬¬ä¸€å‘¨ï¼‰
        const prevMonthLastDay = new Date(year, monthIndex, 0).getDate();
        
        const mainColor = PET_CONFIG?.theme?.primaryColor || '#6366f1';
        const selectedStart = this.dateRangeFilter?.startDate;
        const selectedEnd = this.dateRangeFilter?.endDate;
        
        // å°†ä¸»é¢˜è‰²è½¬æ¢ä¸ºRGBå¹¶æ·»åŠ é€æ˜åº¦ï¼ˆåœ¨å¾ªç¯å¤–éƒ¨è®¡ç®—ä¸€æ¬¡ï¼‰
        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        };
        const rgb = hexToRgb(mainColor) || { r: 99, g: 102, b: 241 };
        const rangeBgColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15)`;
        const rangeHoverBgColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.25)`;
        
        // åˆ›å»ºæ—¥æœŸå•å…ƒæ ¼
        for (let i = 0; i < 42; i++) {
            let date, isCurrentMonth, dayNumber;
            
            if (i < firstDayWeek) {
                // ä¸Šä¸ªæœˆçš„æ—¥æœŸ
                dayNumber = prevMonthLastDay - firstDayWeek + i + 1;
                date = new Date(year, monthIndex - 1, dayNumber);
                isCurrentMonth = false;
            } else if (i < firstDayWeek + lastDay.getDate()) {
                // å½“å‰æœˆçš„æ—¥æœŸ
                dayNumber = i - firstDayWeek + 1;
                date = new Date(year, monthIndex, dayNumber);
                isCurrentMonth = true;
            } else {
                // ä¸‹ä¸ªæœˆçš„æ—¥æœŸ
                dayNumber = i - firstDayWeek - lastDay.getDate() + 1;
                date = new Date(year, monthIndex + 1, dayNumber);
                isCurrentMonth = false;
            }
            
            date.setHours(0, 0, 0, 0);
            
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day-cell';
            dayCell.dataset.date = this.formatDate(date);
            
            // åˆ¤æ–­æ—¥æœŸçŠ¶æ€
            const isToday = date.getTime() === today.getTime();
            const isSelected = this.isDateInRange(date, selectedStart, selectedEnd);
            const isStart = selectedStart && date.getTime() === selectedStart.getTime();
            const isEnd = selectedEnd && date.getTime() === selectedEnd.getTime();
            
            // ä¼˜åŒ–æ—¥æœŸæ ·å¼
            let textColor = isCurrentMonth ? '#374151' : '#d1d5db';
            let bgColor = 'transparent';
            let borderStyle = '';
            let fontWeight = 'normal';
            
            if (isStart || isEnd) {
                // å¼€å§‹æˆ–ç»“æŸæ—¥æœŸï¼šä½¿ç”¨ä¸»é¢˜è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—
                bgColor = mainColor;
                textColor = '#ffffff';
                fontWeight = '700';
                borderStyle = `border: 2px solid ${mainColor} !important;`;
                if (isToday) {
                    // ä»Šå¤©ä¸”æ˜¯å¼€å§‹/ç»“æŸæ—¥æœŸï¼šæ·»åŠ å¤–åœˆè¾¹æ¡†çªå‡ºæ˜¾ç¤º
                    borderStyle = `border: 2px solid ${mainColor} !important; box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8) inset, 0 0 0 1px ${mainColor} !important;`;
                }
            } else if (isSelected) {
                // åŒºé—´å†…çš„æ—¥æœŸï¼šä½¿ç”¨ä¸»é¢˜è‰²æµ…è‰²èƒŒæ™¯
                bgColor = rangeBgColor;
                textColor = isCurrentMonth ? '#374151' : '#9ca3af';
                fontWeight = '500';
                if (isToday) {
                    // ä»Šå¤©ä¸”åœ¨åŒºé—´å†…ï¼šæ·»åŠ è¾¹æ¡†
                    borderStyle = `border: 1.5px solid ${mainColor} !important;`;
                    textColor = mainColor;
                    fontWeight = '600';
                }
            } else if (isToday) {
                // ä»Šå¤©ä½†æœªé€‰ä¸­ï¼šä½¿ç”¨æµ…è‰²èƒŒæ™¯å’Œè¾¹æ¡†
                bgColor = `${mainColor}20`;
                borderStyle = `border: 1.5px solid ${mainColor} !important;`;
                textColor = mainColor;
                fontWeight = '600';
            }
            
            dayCell.textContent = dayNumber;
            dayCell.style.cssText = `
                aspect-ratio: 1 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 12px !important;
                cursor: ${isCurrentMonth ? 'pointer' : 'default'} !important;
                border-radius: 4px !important;
                transition: all 0.2s ease !important;
                position: relative !important;
                color: ${textColor} !important;
                background: ${bgColor} !important;
                ${borderStyle}
                font-weight: ${fontWeight} !important;
                ${!isCurrentMonth ? 'opacity: 0.4 !important;' : ''}
            `;
            
            if (isCurrentMonth) {
                dayCell.addEventListener('click', () => {
                    this.handleDateClick(date);
                });
                
                dayCell.addEventListener('mouseenter', () => {
                    if (isStart || isEnd) {
                        // å¼€å§‹/ç»“æŸæ—¥æœŸæ‚¬åœï¼šç¨å¾®åŠ æ·±
                        dayCell.style.background = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.9)`;
                    } else if (isSelected) {
                        // åŒºé—´å†…æ—¥æœŸæ‚¬åœï¼šåŠ æ·±èƒŒæ™¯
                        dayCell.style.background = rangeHoverBgColor;
                    } else {
                        // æœªé€‰ä¸­æ—¥æœŸæ‚¬åœï¼šæµ…ç°è‰²èƒŒæ™¯
                        dayCell.style.background = '#f3f4f6';
                    }
                });
                
                dayCell.addEventListener('mouseleave', () => {
                    if (isStart || isEnd) {
                        dayCell.style.background = mainColor;
                    } else if (isSelected) {
                        dayCell.style.background = rangeBgColor;
                    } else if (isToday) {
                        dayCell.style.background = `${mainColor}20`;
                    } else {
                        dayCell.style.background = 'transparent';
                    }
                });
            }
            
            grid.appendChild(dayCell);
        }
    }
    
    /**
     * å¤„ç†æ—¥æœŸç‚¹å‡»
     */
    handleDateClick(date) {
        if (!this.dateRangeFilter) {
            // å¼€å§‹é€‰æ‹©æ—¥æœŸåŒºé—´ï¼Œé»˜è®¤ä½œä¸ºç»“æŸæ—¥æœŸï¼ˆæ”¯æŒç­›é€‰ç»“æŸæ—¥æœŸä¹‹å‰ï¼‰
            this.dateRangeFilter = {
                startDate: null,
                endDate: date
            };
        } else if (!this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
            // å¦‚æœåªæœ‰ç»“æŸæ—¥æœŸï¼Œç°åœ¨é€‰æ‹©å¼€å§‹æ—¥æœŸ
            if (date.getTime() > this.dateRangeFilter.endDate.getTime()) {
                // å¦‚æœé€‰æ‹©çš„æ—¥æœŸæ™šäºç»“æŸæ—¥æœŸï¼Œäº¤æ¢å®ƒä»¬
                this.dateRangeFilter = {
                    startDate: this.dateRangeFilter.endDate,
                    endDate: date
                };
            } else {
                this.dateRangeFilter.startDate = date;
            }
        } else if (this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
            // å¦‚æœåªæœ‰å¼€å§‹æ—¥æœŸï¼Œç°åœ¨é€‰æ‹©ç»“æŸæ—¥æœŸ
            if (date.getTime() < this.dateRangeFilter.startDate.getTime()) {
                // å¦‚æœé€‰æ‹©çš„æ—¥æœŸæ—©äºå¼€å§‹æ—¥æœŸï¼Œäº¤æ¢å®ƒä»¬
                this.dateRangeFilter = {
                    startDate: date,
                    endDate: this.dateRangeFilter.startDate
                };
            } else {
                this.dateRangeFilter.endDate = date;
            }
        } else {
            // é‡æ–°å¼€å§‹é€‰æ‹©ï¼Œé»˜è®¤ä½œä¸ºç»“æŸæ—¥æœŸ
            this.dateRangeFilter = {
                startDate: null,
                endDate: date
            };
        }
        
        // æ›´æ–°æ—¥å†æ˜¾ç¤º
        this.updateCalendarDays(this.calendarDaysGrid, this.calendarMonth);
        this.updateDateRangeDisplay(this.dateRangeDisplay);
        
        // åº”ç”¨æ—¥æœŸè¿‡æ»¤
        this.applyDateFilter();
    }
    
    /**
     * å¯¼èˆªåˆ°ä¸Šä¸€å¤©æˆ–ä¸‹ä¸€å¤©
     * @param {number} direction - æ–¹å‘ï¼š-1 è¡¨ç¤ºä¸Šä¸€å¤©ï¼Œ1 è¡¨ç¤ºä¸‹ä¸€å¤©
     */
    navigateDay(direction) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let baseDate;
        
        if (this.dateRangeFilter) {
            // å¦‚æœæœ‰æ—¥æœŸç­›é€‰ï¼Œä¼˜å…ˆä½¿ç”¨ç»“æŸæ—¥æœŸï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å¼€å§‹æ—¥æœŸ
            if (this.dateRangeFilter.endDate) {
                baseDate = new Date(this.dateRangeFilter.endDate);
            } else if (this.dateRangeFilter.startDate) {
                baseDate = new Date(this.dateRangeFilter.startDate);
            } else {
                baseDate = new Date(today);
            }
        } else {
            // å¦‚æœæ²¡æœ‰æ—¥æœŸç­›é€‰ï¼Œä½¿ç”¨ä»Šå¤©
            baseDate = new Date(today);
        }
        
        baseDate.setHours(0, 0, 0, 0);
        
        // è®¡ç®—æ–°æ—¥æœŸ
        const newDate = new Date(baseDate);
        newDate.setDate(newDate.getDate() + direction);
        newDate.setHours(0, 0, 0, 0);
        
        // æ›´æ–°æ—¥æœŸç­›é€‰
        // å¦‚æœä¹‹å‰æœ‰æ—¥æœŸåŒºé—´ï¼Œä¿æŒåŒºé—´ç»“æ„ä½†ç§»åŠ¨æ—¥æœŸ
        if (this.dateRangeFilter && this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
            // å¦‚æœæœ‰å®Œæ•´çš„æ—¥æœŸåŒºé—´ï¼Œè®¡ç®—åŒºé—´é•¿åº¦å¹¶ä¿æŒ
            const rangeLength = Math.abs(this.dateRangeFilter.endDate.getTime() - this.dateRangeFilter.startDate.getTime());
            const daysDiff = Math.floor(rangeLength / (1000 * 60 * 60 * 24));
            
            if (this.dateRangeFilter.endDate.getTime() >= this.dateRangeFilter.startDate.getTime()) {
                // æ­£å¸¸åŒºé—´ï¼šç»“æŸæ—¥æœŸ >= å¼€å§‹æ—¥æœŸ
                this.dateRangeFilter = {
                    startDate: new Date(newDate.getTime() - daysDiff * 24 * 60 * 60 * 1000),
                    endDate: newDate
                };
            } else {
                // åå‘åŒºé—´ï¼šç»“æŸæ—¥æœŸ < å¼€å§‹æ—¥æœŸ
                this.dateRangeFilter = {
                    startDate: newDate,
                    endDate: new Date(newDate.getTime() + daysDiff * 24 * 60 * 60 * 1000)
                };
            }
        } else if (this.dateRangeFilter && this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
            // åªæœ‰å¼€å§‹æ—¥æœŸï¼Œç§»åŠ¨å¼€å§‹æ—¥æœŸ
            this.dateRangeFilter = {
                startDate: newDate,
                endDate: null
            };
        } else {
            // åªæœ‰ç»“æŸæ—¥æœŸæˆ–æ²¡æœ‰æ—¥æœŸç­›é€‰ï¼Œè®¾ç½®ä¸ºå•æ—¥ç­›é€‰ï¼ˆç»“æŸæ—¥æœŸä¹‹å‰ï¼‰
            this.dateRangeFilter = {
                startDate: null,
                endDate: newDate
            };
        }
        
        // æ›´æ–°æ—¥å†æœˆä»½ä»¥æ˜¾ç¤ºæ–°æ—¥æœŸ
        const newMonth = new Date(newDate.getFullYear(), newDate.getMonth(), 1);
        if (!this.calendarMonth || 
            this.calendarMonth.getFullYear() !== newMonth.getFullYear() || 
            this.calendarMonth.getMonth() !== newMonth.getMonth()) {
            this.calendarMonth = newMonth;
            if (this.calendarMonthTitle) {
                this.updateMonthTitle(this.calendarMonthTitle, newMonth);
            }
        }
    }
    
    /**
     * åˆ¤æ–­æ—¥æœŸæ˜¯å¦åœ¨åŒºé—´å†…
     */
    isDateInRange(date, startDate, endDate) {
        const dateTime = date.getTime();
        
        if (startDate && endDate) {
            // æœ‰å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼šåˆ¤æ–­æ˜¯å¦åœ¨åŒºé—´å†…
            const startTime = startDate.getTime();
            const endTime = endDate.getTime();
            return dateTime >= startTime && dateTime <= endTime;
        } else if (startDate && !endDate) {
            // åªæœ‰å¼€å§‹æ—¥æœŸï¼šåˆ¤æ–­æ˜¯å¦ç­‰äºå¼€å§‹æ—¥æœŸ
            const startTime = startDate.getTime();
            return dateTime === startTime;
        } else if (!startDate && endDate) {
            // åªæœ‰ç»“æŸæ—¥æœŸï¼šåˆ¤æ–­æ˜¯å¦åœ¨ç»“æŸæ—¥æœŸä¹‹å‰
            const endTime = endDate.getTime();
            return dateTime < endTime;
        }
        
        return false;
    }
    
    /**
     * æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
     */
    formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    /**
     * æ›´æ–°æ—¥æœŸåŒºé—´æ˜¾ç¤º
     */
    updateDateRangeDisplay(element) {
        if (!element) return;
        
        if (this.dateRangeFilter) {
            if (this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // æœ‰å¼€å§‹å’Œç»“æŸæ—¥æœŸ
                const startStr = this.formatDate(this.dateRangeFilter.startDate);
                const endStr = this.formatDate(this.dateRangeFilter.endDate);
                element.textContent = `${startStr} ~ ${endStr}`;
            } else if (this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
                // åªæœ‰å¼€å§‹æ—¥æœŸ
                const startStr = this.formatDate(this.dateRangeFilter.startDate);
                element.textContent = `${startStr} ~ é€‰æ‹©ç»“æŸæ—¥æœŸ`;
            } else if (!this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // åªæœ‰ç»“æŸæ—¥æœŸï¼ˆç­›é€‰ç»“æŸæ—¥æœŸä¹‹å‰ï¼‰
                const endStr = this.formatDate(this.dateRangeFilter.endDate);
                element.textContent = `~ ${endStr}ï¼ˆä¹‹å‰ï¼‰`;
            }
            // æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®
            if (this.clearDateBtn) {
                this.clearDateBtn.style.display = 'flex';
            }
        } else {
            element.textContent = '';
            // éšè—æ¸…é™¤æŒ‰é’®
            if (this.clearDateBtn) {
                this.clearDateBtn.style.display = 'none';
            }
        }
    }
    
    /**
     * åº”ç”¨æ—¥æœŸè¿‡æ»¤
     */
    applyDateFilter() {
        // æ ¹æ®å½“å‰æ¨¡å¼å†³å®šæ›´æ–°å“ªä¸ªåˆ—è¡¨
        if (this.newsListVisible) {
            this.updateNewsSidebar();
        } else if (this.ossFileListVisible) {
            this.updateOssFileSidebar();
        } else if (this.apiRequestListVisible) {
            this.updateApiRequestSidebar();
        } else {
            this.updateSessionSidebar();
        }
    }
    
    /**
     * åŠ è½½æ—¥å†æŠ˜å çŠ¶æ€
     */
    loadCalendarCollapsed() {
        try {
            const saved = localStorage.getItem('petCalendarCollapsed');
            if (saved !== null) {
                this.calendarCollapsed = saved === 'true';
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å€¼ï¼Œé»˜è®¤æŠ˜å 
                this.calendarCollapsed = true;
            }
        } catch (error) {
            console.warn('åŠ è½½æ—¥å†æŠ˜å çŠ¶æ€å¤±è´¥:', error);
            // å‡ºé”™æ—¶ä¹Ÿé»˜è®¤æŠ˜å 
            this.calendarCollapsed = true;
        }
    }
    
    /**
     * ä¿å­˜æ—¥å†æŠ˜å çŠ¶æ€
     */
    saveCalendarCollapsed() {
        try {
            localStorage.setItem('petCalendarCollapsed', String(this.calendarCollapsed));
        } catch (error) {
            console.warn('ä¿å­˜æ—¥å†æŠ˜å çŠ¶æ€å¤±è´¥:', error);
        }
    }

    async createOssTagFilter() {
        if (!this.sessionSidebar) return;
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        let ossTagFilterContainer = this.sessionSidebar.querySelector('.oss-tag-filter-container');
        if (ossTagFilterContainer) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œç¡®ä¿é¢„è§ˆå¼€å…³æŒ‰é’®å­˜åœ¨å¹¶æ›´æ–°çŠ¶æ€
            let previewToggleBtn = ossTagFilterContainer.querySelector('.oss-image-preview-toggle');
            if (!previewToggleBtn) {
                // å¦‚æœé¢„è§ˆå¼€å…³æŒ‰é’®ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                const filterActions = ossTagFilterContainer.querySelector('.oss-tag-filter-actions') || 
                                     ossTagFilterContainer.querySelector('div[style*="display: flex"]');
                if (filterActions) {
                    previewToggleBtn = document.createElement('button');
                    previewToggleBtn.className = 'oss-image-preview-toggle';
                    previewToggleBtn.title = this.ossImagePreviewEnabled ? 'å…³é—­æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ';
                    previewToggleBtn.innerHTML = 'ğŸ–¼ï¸';
                    previewToggleBtn.style.cssText = `
                        font-size: 14px !important;
                        color: ${this.ossImagePreviewEnabled ? '#667eea' : '#9ca3af'} !important;
                        background: none !important;
                        border: none !important;
                        cursor: pointer !important;
                        padding: 2px 4px !important;
                        border-radius: 3px !important;
                        transition: all 0.2s ease !important;
                        line-height: 1 !important;
                        opacity: ${this.ossImagePreviewEnabled ? '1' : '0.6'} !important;
                    `;
                    previewToggleBtn.addEventListener('click', () => {
                        this.ossImagePreviewEnabled = !this.ossImagePreviewEnabled;
                    previewToggleBtn.style.color = this.ossImagePreviewEnabled ? '#4CAF50' : '#9ca3af';
                    previewToggleBtn.style.opacity = this.ossImagePreviewEnabled ? '1' : '0.6';
                    previewToggleBtn.title = this.ossImagePreviewEnabled ? 'å…³é—­æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ';
                        this.saveOssImagePreviewState();
                        
                        // æ‰¹é‡è®¾ç½®æ‰€æœ‰æ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€
                        if (this.ossFileManager) {
                            const allFiles = this.ossFileManager.getAllFiles();
                            allFiles.forEach(file => {
                                this.setFilePreviewEnabled(file.name, this.ossImagePreviewEnabled);
                            });
                        }
                        
                        // æ›´æ–°æ‰€æœ‰æ–‡ä»¶é¡¹çš„é¢„è§ˆå¼€å…³æŒ‰é’®çŠ¶æ€
                        const allFilePreviewBtns = this.sessionSidebar.querySelectorAll('.oss-file-preview-toggle');
                        allFilePreviewBtns.forEach(btn => {
                            const fileName = btn.dataset.fileName;
                            if (fileName) {
                                const filePreviewEnabled = this.getFilePreviewEnabled(fileName);
                                btn.style.color = filePreviewEnabled ? '#4CAF50' : '#9ca3af';
                                btn.style.opacity = filePreviewEnabled ? '1' : '0.6';
                                btn.title = filePreviewEnabled ? 'å…³é—­æ­¤æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ­¤æ–‡ä»¶é¢„è§ˆ';
                            }
                        });
                        
                        // é‡æ–°æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ä»¥åº”ç”¨é¢„è§ˆå¼€å…³çŠ¶æ€
                        this.updateOssFileSidebar();
                    });
                    const reverseFilterBtn = filterActions.querySelector('.oss-tag-filter-reverse');
                    if (reverseFilterBtn) {
                        filterActions.insertBefore(previewToggleBtn, reverseFilterBtn);
                    } else {
                        filterActions.appendChild(previewToggleBtn);
                    }
                }
            } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°çŠ¶æ€
                    previewToggleBtn.style.color = this.ossImagePreviewEnabled ? '#4CAF50' : '#9ca3af';
                    previewToggleBtn.style.opacity = this.ossImagePreviewEnabled ? '1' : '0.6';
                    previewToggleBtn.title = this.ossImagePreviewEnabled ? 'å…³é—­æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ';
            }
            return;
        }
        
        // åˆ›å»ºOSSæ ‡ç­¾ç­›é€‰å™¨å®¹å™¨
        ossTagFilterContainer = document.createElement('div');
        ossTagFilterContainer.className = 'oss-tag-filter-container';
        ossTagFilterContainer.style.cssText = `
            padding: 8px 12px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #ffffff !important;
        `;

        // è¿‡æ»¤å™¨æ ‡é¢˜è¡Œï¼ˆåŒ…å«æœç´¢è¾“å…¥æ¡†å’Œæ“ä½œæŒ‰é’®ï¼‰
        const filterHeader = document.createElement('div');
        filterHeader.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 8px !important;
            margin-bottom: 6px !important;
        `;

        // å³ä¾§æ“ä½œåŒºï¼ˆå›¾ç‰‡é¢„è§ˆå¼€å…³ + åå‘è¿‡æ»¤å¼€å…³ + æ— æ ‡ç­¾ç­›é€‰ + å±•å¼€/æŠ˜å  + æ¸…é™¤æŒ‰é’®ï¼‰
        const filterActions = document.createElement('div');
        filterActions.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
        `;

        // å›¾ç‰‡é¢„è§ˆå¼€å…³
        const previewToggleBtn = document.createElement('button');
        previewToggleBtn.className = 'oss-image-preview-toggle';
        previewToggleBtn.title = this.ossImagePreviewEnabled ? 'å…³é—­æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ';
        previewToggleBtn.innerHTML = this.ossImagePreviewEnabled ? 'ğŸ–¼ï¸' : 'ğŸ–¼ï¸';
        previewToggleBtn.style.cssText = `
            font-size: 14px !important;
            color: ${this.ossImagePreviewEnabled ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.ossImagePreviewEnabled ? '1' : '0.6'} !important;
        `;
        previewToggleBtn.addEventListener('click', () => {
            this.ossImagePreviewEnabled = !this.ossImagePreviewEnabled;
            previewToggleBtn.style.color = this.ossImagePreviewEnabled ? '#4CAF50' : '#9ca3af';
            previewToggleBtn.style.opacity = this.ossImagePreviewEnabled ? '1' : '0.6';
            previewToggleBtn.title = this.ossImagePreviewEnabled ? 'å…³é—­æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ';
            this.saveOssImagePreviewState();
            
            // æ‰¹é‡è®¾ç½®æ‰€æœ‰æ–‡ä»¶çš„é¢„è§ˆå¼€å…³çŠ¶æ€
            if (this.ossFileManager) {
                const allFiles = this.ossFileManager.getAllFiles();
                allFiles.forEach(file => {
                    this.setFilePreviewEnabled(file.name, this.ossImagePreviewEnabled);
                });
            }
            
            // æ›´æ–°æ‰€æœ‰æ–‡ä»¶é¡¹çš„é¢„è§ˆå¼€å…³æŒ‰é’®çŠ¶æ€å’Œé¢„è§ˆå¤´åƒ
            const allFilePreviewBtns = this.sessionSidebar.querySelectorAll('.oss-file-preview-toggle');
            allFilePreviewBtns.forEach(btn => {
                const fileName = btn.dataset.fileName;
                if (fileName) {
                    const filePreviewEnabled = this.getFilePreviewEnabled(fileName);
                    btn.style.color = filePreviewEnabled ? '#4CAF50' : '#9ca3af';
                    btn.style.opacity = filePreviewEnabled ? '1' : '0.6';
                    btn.title = filePreviewEnabled ? 'å…³é—­æ­¤æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ­¤æ–‡ä»¶é¢„è§ˆ';
                }
            });
            
            // é‡æ–°æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ä»¥åº”ç”¨é¢„è§ˆå¼€å…³çŠ¶æ€
            this.updateOssFileSidebar();
        });

        // åå‘è¿‡æ»¤å¼€å…³
        const reverseFilterBtn = document.createElement('button');
        reverseFilterBtn.className = 'oss-tag-filter-reverse';
        reverseFilterBtn.title = 'åå‘è¿‡æ»¤';
        reverseFilterBtn.innerHTML = 'â‡„';
        reverseFilterBtn.style.cssText = `
            font-size: 12px !important;
            color: ${this.ossTagFilterReverse ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.ossTagFilterReverse ? '1' : '0.6'} !important;
        `;
        reverseFilterBtn.addEventListener('mouseenter', () => {
            reverseFilterBtn.style.opacity = '1';
            reverseFilterBtn.style.background = '#f3f4f6';
        });
        reverseFilterBtn.addEventListener('mouseleave', () => {
            if (!this.ossTagFilterReverse) {
                reverseFilterBtn.style.opacity = '0.6';
            }
            reverseFilterBtn.style.background = 'none';
        });
        reverseFilterBtn.addEventListener('click', () => {
            this.ossTagFilterReverse = !this.ossTagFilterReverse;
            reverseFilterBtn.style.color = this.ossTagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.ossTagFilterReverse ? '1' : '0.6';
            this.updateOssTagFilterUI();
            this.updateOssFileSidebar();
        });

        // æ— æ ‡ç­¾ç­›é€‰å¼€å…³ï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨å›¾æ ‡ï¼‰
        const noTagsFilterBtn = document.createElement('button');
        noTagsFilterBtn.className = 'oss-tag-filter-no-tags';
        noTagsFilterBtn.title = 'ç­›é€‰æ— æ ‡ç­¾';
        noTagsFilterBtn.innerHTML = 'âˆ…';
        noTagsFilterBtn.style.cssText = `
            font-size: 12px !important;
            color: ${this.ossTagFilterNoTags ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.ossTagFilterNoTags ? '1' : '0.6'} !important;
        `;
        noTagsFilterBtn.addEventListener('mouseenter', () => {
            noTagsFilterBtn.style.opacity = '1';
            noTagsFilterBtn.style.background = '#f3f4f6';
        });
        noTagsFilterBtn.addEventListener('mouseleave', () => {
            if (!this.ossTagFilterNoTags) {
                noTagsFilterBtn.style.opacity = '0.6';
            }
            noTagsFilterBtn.style.background = 'none';
        });
        noTagsFilterBtn.addEventListener('click', () => {
            this.ossTagFilterNoTags = !this.ossTagFilterNoTags;
            noTagsFilterBtn.style.color = this.ossTagFilterNoTags ? '#667eea' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.ossTagFilterNoTags ? '1' : '0.6';
            this.updateOssTagFilterUI();
            this.updateOssFileSidebar();
        });

        // å±•å¼€/æ”¶èµ·æŒ‰é’®ï¼ˆç±»ä¼¼ç­›é€‰æ— æ ‡ç­¾æŒ‰é’®çš„æ ·å¼ï¼‰
        const expandToggleBtn = document.createElement('button');
        expandToggleBtn.className = 'oss-tag-filter-expand-btn';
        expandToggleBtn.title = 'å±•å¼€æ ‡ç­¾';
        expandToggleBtn.innerHTML = 'â–¼';
        expandToggleBtn.style.cssText = `
            font-size: 10px !important;
            color: #9ca3af !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: 0.6 !important;
            display: none !important;
        `;
        expandToggleBtn.addEventListener('mouseenter', () => {
            expandToggleBtn.style.opacity = '1';
            expandToggleBtn.style.background = '#f3f4f6';
        });
        expandToggleBtn.addEventListener('mouseleave', () => {
            expandToggleBtn.style.opacity = '0.6';
            expandToggleBtn.style.background = 'none';
        });
        expandToggleBtn.addEventListener('click', () => {
            this.ossTagFilterExpanded = !this.ossTagFilterExpanded;
            this.updateOssTagFilterUI();
        });

        // æ¸…é™¤æŒ‰é’®
        const clearFilterBtn = document.createElement('button');
        clearFilterBtn.className = 'oss-tag-filter-clear';
        clearFilterBtn.textContent = 'Ã—';
        clearFilterBtn.title = 'æ¸…é™¤ç­›é€‰';
        clearFilterBtn.style.cssText = `
            font-size: 16px !important;
            color: #9ca3af !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 0 !important;
            width: 18px !important;
            height: 18px !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            opacity: 0.6 !important;
        `;
        clearFilterBtn.addEventListener('mouseenter', () => {
            const hasSelectedTags = this.selectedOssFilterTags && this.selectedOssFilterTags.length > 0;
            const hasSearchKeyword = this.ossTagFilterSearchKeyword && this.ossTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.ossTagFilterNoTags || hasSearchKeyword;
            if (hasActiveFilter) {
                clearFilterBtn.style.color = '#ef4444';
                clearFilterBtn.style.opacity = '1';
                clearFilterBtn.style.background = '#fee2e2';
            } else {
                clearFilterBtn.style.opacity = '0.4';
            }
        });
        clearFilterBtn.addEventListener('mouseleave', () => {
            const hasSelectedTags = this.selectedOssFilterTags && this.selectedOssFilterTags.length > 0;
            const hasSearchKeyword = this.ossTagFilterSearchKeyword && this.ossTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.ossTagFilterNoTags || hasSearchKeyword;
            clearFilterBtn.style.color = '#9ca3af';
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.background = 'none';
        });
        clearFilterBtn.addEventListener('click', () => {
            const hasSelectedTags = this.selectedOssFilterTags && this.selectedOssFilterTags.length > 0;
            const hasSearchKeyword = this.ossTagFilterSearchKeyword && this.ossTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.ossTagFilterNoTags || hasSearchKeyword;
            
            // å¦‚æœæœ‰é€‰ä¸­çš„æ ‡ç­¾ã€å¯ç”¨äº†æ— æ ‡ç­¾ç­›é€‰æˆ–æœ‰æœç´¢å…³é”®è¯ï¼Œåˆ™æ¸…é™¤ç­›é€‰
            if (hasActiveFilter) {
                // æ¸…é™¤é€‰ä¸­çš„æ ‡ç­¾
                this.selectedOssFilterTags = [];
                // é‡ç½®æ— æ ‡ç­¾ç­›é€‰çŠ¶æ€
                this.ossTagFilterNoTags = false;
                // æ¸…é™¤æœç´¢å…³é”®è¯
                this.ossTagFilterSearchKeyword = '';
                // æ›´æ–°æœç´¢è¾“å…¥æ¡†çš„å€¼å’Œæ¸…é™¤æŒ‰é’®çŠ¶æ€
                const tagSearchInput = this.sessionSidebar.querySelector('.oss-tag-filter-search');
                const tagSearchClearBtn = this.sessionSidebar.querySelector('.oss-tag-filter-search-clear');
                if (tagSearchInput) {
                    tagSearchInput.value = '';
                }
                if (tagSearchClearBtn) {
                    tagSearchClearBtn.style.display = 'none';
                }
                const tagSearchIcon = this.sessionSidebar.querySelector('.oss-tag-filter-search-container span');
                if (tagSearchIcon && tagSearchIcon.textContent === 'ğŸ”') {
                    tagSearchIcon.style.opacity = '0.5';
                }
                
                // æ›´æ–°UI
                this.updateOssTagFilterUI();
                // å¼ºåˆ¶åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ï¼ˆæ¸…é™¤ç­›é€‰åé‡æ–°åŠ è½½æ‰€æœ‰æ–‡ä»¶ï¼‰
                this.updateOssFileSidebar(true);
            }
        });

        filterActions.appendChild(previewToggleBtn);
        filterActions.appendChild(reverseFilterBtn);
        filterActions.appendChild(noTagsFilterBtn);
        filterActions.appendChild(expandToggleBtn);
        filterActions.appendChild(clearFilterBtn);

        // åˆ›å»ºæ ‡ç­¾æœç´¢è¾“å…¥æ¡†å®¹å™¨ï¼ˆå¸¦å›¾æ ‡å’Œæ¸…é™¤æŒ‰é’®ï¼‰
        const tagSearchContainer = document.createElement('div');
        tagSearchContainer.className = 'oss-tag-filter-search-container';
        tagSearchContainer.style.cssText = `
            position: relative !important;
            flex: 1 !important;
            display: flex !important;
            align-items: center !important;
        `;

        // æœç´¢å›¾æ ‡
        const tagSearchIcon = document.createElement('span');
        tagSearchIcon.textContent = 'ğŸ”';
        tagSearchIcon.style.cssText = `
            position: absolute !important;
            left: 8px !important;
            font-size: 12px !important;
            pointer-events: none !important;
            z-index: 1 !important;
            opacity: 0.5 !important;
            transition: opacity 0.2s ease !important;
        `;

        // æ ‡ç­¾æœç´¢è¾“å…¥æ¡†
        const tagSearchInput = document.createElement('input');
        tagSearchInput.className = 'oss-tag-filter-search';
        tagSearchInput.type = 'text';
        tagSearchInput.placeholder = 'æœç´¢æ ‡ç­¾...';
        tagSearchInput.value = this.ossTagFilterSearchKeyword || '';
        tagSearchInput.style.cssText = `
            width: 100% !important;
            font-weight: 400 !important;
            font-size: 12px !important;
            color: #374151 !important;
            padding: 4px 24px 4px 24px !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 6px !important;
            background: #ffffff !important;
            outline: none !important;
            transition: all 0.2s ease !important;
            box-sizing: border-box !important;
            height: 24px !important;
        `;

        // æ·»åŠ å ä½ç¬¦æ ·å¼
        if (!document.getElementById('oss-tag-search-placeholder-style')) {
            const style = document.createElement('style');
            style.id = 'oss-tag-search-placeholder-style';
            style.textContent = `
                .oss-tag-filter-search::placeholder {
                    color: #9ca3af !important;
                    opacity: 1 !important;
                }
                .oss-tag-filter-search:focus::placeholder {
                    color: #d1d5db !important;
                }
            `;
            document.head.appendChild(style);
        }

        // æ¸…é™¤æŒ‰é’®ï¼ˆä½äºè¾“å…¥æ¡†å³ä¾§ï¼‰
        const tagSearchClearBtn = document.createElement('button');
        tagSearchClearBtn.innerHTML = 'âœ•';
        tagSearchClearBtn.type = 'button';
        tagSearchClearBtn.className = 'oss-tag-filter-search-clear';
        tagSearchClearBtn.style.cssText = `
            position: absolute !important;
            right: 4px !important;
            width: 16px !important;
            height: 16px !important;
            border: none !important;
            background: #e5e7eb !important;
            color: #6b7280 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            padding: 0 !important;
            transition: all 0.2s ease !important;
            z-index: 2 !important;
            line-height: 1 !important;
        `;

        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        const updateTagSearchClearButton = () => {
            if (tagSearchInput.value.trim() !== '') {
                tagSearchClearBtn.style.display = 'flex';
                tagSearchIcon.style.opacity = '0.3';
            } else {
                tagSearchClearBtn.style.display = 'none';
                tagSearchIcon.style.opacity = '0.5';
            }
        };

        // åˆå§‹çŠ¶æ€
        updateTagSearchClearButton();

        // æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        tagSearchClearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            tagSearchInput.value = '';
            this.ossTagFilterSearchKeyword = '';
            updateTagSearchClearButton();
            this.updateOssTagFilterUI();
            tagSearchInput.focus();
        });

        // æ¸…é™¤æŒ‰é’®æ‚¬åœæ•ˆæœ
        tagSearchClearBtn.addEventListener('mouseenter', () => {
            tagSearchClearBtn.style.background = '#d1d5db';
            tagSearchClearBtn.style.transform = 'scale(1.15)';
        });
        tagSearchClearBtn.addEventListener('mouseleave', () => {
            tagSearchClearBtn.style.background = '#e5e7eb';
            tagSearchClearBtn.style.transform = 'scale(1)';
        });

        // è¾“å…¥æ¡†èšç„¦å’Œå¤±ç„¦æ ·å¼
        const mainColor = PET_CONFIG?.theme?.primaryColor || '#6366f1';
        tagSearchInput.addEventListener('focus', () => {
            tagSearchInput.style.borderColor = mainColor;
            tagSearchInput.style.boxShadow = `0 0 0 2px ${mainColor}22`;
            tagSearchIcon.style.opacity = '0.7';
        });
        tagSearchInput.addEventListener('blur', () => {
            tagSearchInput.style.borderColor = '#e5e7eb';
            tagSearchInput.style.boxShadow = 'none';
            tagSearchIcon.style.opacity = tagSearchInput.value.trim() !== '' ? '0.3' : '0.5';
        });

        // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶è¿‡æ»¤æ ‡ç­¾ï¼ˆæ·»åŠ é˜²æŠ–ï¼‰
        let tagSearchDebounceTimer = null;
        tagSearchInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            this.ossTagFilterSearchKeyword = value;
            updateTagSearchClearButton();
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (tagSearchDebounceTimer) {
                clearTimeout(tagSearchDebounceTimer);
            }
            
            // é˜²æŠ–å¤„ç†ï¼š300msåæ‰§è¡Œè¿‡æ»¤
            tagSearchDebounceTimer = setTimeout(() => {
                this.updateOssTagFilterUI();
            }, 300);
        });

        // é˜»æ­¢è¾“å…¥æ¡†äº‹ä»¶å†’æ³¡
        tagSearchInput.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // é”®ç›˜å¿«æ·é”®ï¼šESCæ¸…é™¤è¾“å…¥
        tagSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && tagSearchInput.value.trim() !== '') {
                tagSearchInput.value = '';
                this.ossTagFilterSearchKeyword = '';
                updateTagSearchClearButton();
                this.updateOssTagFilterUI();
                e.stopPropagation();
            }
        });

        // ç»„è£…æœç´¢å®¹å™¨
        tagSearchContainer.appendChild(tagSearchIcon);
        tagSearchContainer.appendChild(tagSearchInput);
        tagSearchContainer.appendChild(tagSearchClearBtn);

        // å°†æœç´¢å®¹å™¨å’Œæ“ä½œæŒ‰é’®æ·»åŠ åˆ°æ ‡é¢˜è¡Œ
        filterHeader.appendChild(tagSearchContainer);
        filterHeader.appendChild(filterActions);

        // æ ‡ç­¾åˆ—è¡¨å®¹å™¨
        const tagFilterList = document.createElement('div');
        tagFilterList.className = 'oss-tag-filter-list';
        tagFilterList.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 4px !important;
        `;

        ossTagFilterContainer.appendChild(filterHeader);
        ossTagFilterContainer.appendChild(tagFilterList);

        // æ’å…¥åˆ°ä¾§è¾¹æ é¡¶éƒ¨ï¼ˆåœ¨æ–‡ä»¶åˆ—è¡¨ä¹‹å‰ï¼‰
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        if (ossFileList) {
            this.sessionSidebar.insertBefore(ossTagFilterContainer, ossFileList);
        } else {
            this.sessionSidebar.appendChild(ossTagFilterContainer);
        }
        
        // åˆå§‹åŒ–æ ‡ç­¾åˆ—è¡¨
        await this.updateOssTagFilterUI();
    }

    // æ›´æ–°OSSæ ‡ç­¾ç­›é€‰å™¨UI
    async updateOssTagFilterUI() {
        if (!this.sessionSidebar) return;
        
        // æ›´æ–°å›¾ç‰‡é¢„è§ˆå¼€å…³æŒ‰é’®çŠ¶æ€
        const previewToggleBtn = this.sessionSidebar.querySelector('.oss-image-preview-toggle');
        if (previewToggleBtn) {
            previewToggleBtn.style.color = this.ossImagePreviewEnabled ? '#4CAF50' : '#9ca3af';
            previewToggleBtn.style.opacity = this.ossImagePreviewEnabled ? '1' : '0.6';
            previewToggleBtn.title = this.ossImagePreviewEnabled ? 'å…³é—­æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ';
        }
        
        // æ›´æ–°åå‘è¿‡æ»¤æŒ‰é’®çŠ¶æ€
        const reverseFilterBtn = this.sessionSidebar.querySelector('.oss-tag-filter-reverse');
        if (reverseFilterBtn) {
            reverseFilterBtn.style.color = this.ossTagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.ossTagFilterReverse ? '1' : '0.6';
        }
        
        // æ›´æ–°æ— æ ‡ç­¾ç­›é€‰æŒ‰é’®çŠ¶æ€
        const noTagsFilterBtn = this.sessionSidebar.querySelector('.oss-tag-filter-no-tags');
        if (noTagsFilterBtn) {
            noTagsFilterBtn.style.color = this.ossTagFilterNoTags ? '#4CAF50' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.ossTagFilterNoTags ? '1' : '0.6';
        }
        
        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ï¼ˆå¦‚æœæœ‰é€‰ä¸­çš„æ ‡ç­¾ã€å¯ç”¨äº†æ— æ ‡ç­¾ç­›é€‰æˆ–æœ‰æœç´¢å…³é”®è¯ï¼Œåˆ™æ˜¾ç¤ºä¸ºå¯ç”¨çŠ¶æ€ï¼‰
        const clearFilterBtn = this.sessionSidebar.querySelector('.oss-tag-filter-clear');
        if (clearFilterBtn) {
            const hasSelectedTags = this.selectedOssFilterTags && this.selectedOssFilterTags.length > 0;
            const hasSearchKeyword = this.ossTagFilterSearchKeyword && this.ossTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.ossTagFilterNoTags || hasSearchKeyword;
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.cursor = hasActiveFilter ? 'pointer' : 'default';
            clearFilterBtn.style.pointerEvents = hasActiveFilter ? 'auto' : 'none';
        }
        
        const tagFilterList = this.sessionSidebar.querySelector('.oss-tag-filter-list');
        if (!tagFilterList) return;
        
        // æ¸…ç©ºç°æœ‰æ ‡ç­¾
        tagFilterList.innerHTML = '';
        
        // è·å–æ‰€æœ‰æ ‡ç­¾ï¼ˆä½¿ç”¨getAllOssTagsæ–¹æ³•ï¼ŒåŒ…å«æ’åºé€»è¾‘ï¼‰
        const allTags = this.getAllOssTags();
        
        // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤æ ‡ç­¾
        let filteredTags = allTags;
        const searchKeyword = (this.ossTagFilterSearchKeyword || '').trim().toLowerCase();
        if (searchKeyword) {
            filteredTags = allTags.filter(tag => 
                tag.toLowerCase().includes(searchKeyword)
            );
        }
        
        if (filteredTags.length === 0) {
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ ‡ç­¾ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const expandToggleBtn = this.sessionSidebar.querySelector('.oss-tag-filter-expand-btn');
            if (expandToggleBtn) {
                expandToggleBtn.style.display = 'none';
            }
            // æ˜¾ç¤º"æ— åŒ¹é…æ ‡ç­¾"æç¤º
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = searchKeyword ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ ‡ç­¾' : 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                padding: 8px !important;
                text-align: center !important;
                color: #9ca3af !important;
                font-size: 11px !important;
            `;
            tagFilterList.appendChild(emptyMsg);
            return;
        }
        
        // ç¡®å®šè¦æ˜¾ç¤ºçš„æ ‡ç­¾ï¼ˆæ ¹æ®æŠ˜å çŠ¶æ€ï¼‰
        // ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾å§‹ç»ˆæ˜¾ç¤º
        const selectedTags = this.selectedOssFilterTags || [];
        let visibleTags;
        let hasMoreTags;
        
        if (this.ossTagFilterExpanded || searchKeyword) {
            // å±•å¼€çŠ¶æ€æˆ–æœ‰æœç´¢å…³é”®è¯æ—¶ï¼šæ˜¾ç¤ºæ‰€æœ‰è¿‡æ»¤åçš„æ ‡ç­¾
            visibleTags = filteredTags;
            hasMoreTags = false;
        } else {
            // æŠ˜å çŠ¶æ€ï¼šæ˜¾ç¤ºå‰Nä¸ªæ ‡ç­¾ï¼Œä½†ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾ä¹Ÿåœ¨å…¶ä¸­
            const defaultVisible = filteredTags.slice(0, this.ossTagFilterVisibleCount);
            const selectedNotInDefault = selectedTags.filter(tag => !defaultVisible.includes(tag));
            
            // ä¿æŒfilteredTagsçš„åŸå§‹é¡ºåºï¼Œä½†ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾ä¹Ÿåœ¨å¯è§åˆ—è¡¨ä¸­
            const visibleSet = new Set([...defaultVisible, ...selectedNotInDefault]);
            visibleTags = filteredTags.filter(tag => visibleSet.has(tag));
            hasMoreTags = filteredTags.length > visibleTags.length;
        }
        
        // æ›´æ–°å±•å¼€/æŠ˜å æŒ‰é’®ï¼ˆæœ‰æœç´¢å…³é”®è¯æ—¶éšè—ï¼‰
        const expandToggleBtn = this.sessionSidebar.querySelector('.oss-tag-filter-expand-btn');
        if (expandToggleBtn) {
            if (searchKeyword) {
                // æœ‰æœç´¢å…³é”®è¯æ—¶éšè—å±•å¼€/æŠ˜å æŒ‰é’®
                expandToggleBtn.style.display = 'none';
            } else if (hasMoreTags || this.ossTagFilterExpanded) {
                expandToggleBtn.style.display = 'block';
                if (this.ossTagFilterExpanded) {
                    expandToggleBtn.innerHTML = 'â–²';
                    expandToggleBtn.title = 'æ”¶èµ·æ ‡ç­¾';
                } else {
                    expandToggleBtn.innerHTML = 'â–¼';
                    expandToggleBtn.title = 'å±•å¼€æ ‡ç­¾';
                }
            } else {
                expandToggleBtn.style.display = 'none';
            }
        }
        
        // è®¡ç®—æ¯ä¸ªæ ‡ç­¾å¯¹åº”çš„OSSæ–‡ä»¶æ•°é‡
        const tagCounts = {};
        if (this.ossFileManager) {
            const allFiles = this.ossFileManager.getAllFiles();
            allFiles.forEach(file => {
                if (file.tags && Array.isArray(file.tags)) {
                    file.tags.forEach(t => {
                        if (t && t.trim()) {
                            const normalizedTag = t.trim();
                            tagCounts[normalizedTag] = (tagCounts[normalizedTag] || 0) + 1;
                        }
                    });
                }
            });
        }
        
        // åˆ›å»ºæ ‡ç­¾æŒ‰é’®
        visibleTags.forEach(tag => {
            const tagBtn = document.createElement('button');
            tagBtn.className = 'oss-tag-filter-item';
            const count = tagCounts[tag] || 0;
            tagBtn.textContent = `${tag} (${count})`;
            const isSelected = this.selectedOssFilterTags && this.selectedOssFilterTags.includes(tag);
            
            tagBtn.style.cssText = `
                padding: 3px 8px !important;
                border-radius: 10px !important;
                border: 1px solid ${isSelected ? '#4CAF50' : '#e5e7eb'} !important;
                background: ${isSelected ? '#4CAF50' : '#f9fafb'} !important;
                color: ${isSelected ? 'white' : '#6b7280'} !important;
                font-size: 10px !important;
                font-weight: ${isSelected ? '500' : '400'} !important;
                cursor: pointer !important;
                transition: all 0.15s ease !important;
                white-space: nowrap !important;
                line-height: 1.4 !important;
            `;
            
            tagBtn.addEventListener('mouseenter', () => {
                if (!isSelected) {
                    tagBtn.style.borderColor = '#4CAF50';
                    tagBtn.style.background = '#f0fdf4';
                    tagBtn.style.color = '#4CAF50';
                } else {
                    tagBtn.style.opacity = '0.9';
                }
            });
            tagBtn.addEventListener('mouseleave', () => {
                if (!isSelected) {
                    tagBtn.style.borderColor = '#e5e7eb';
                    tagBtn.style.background = '#f9fafb';
                    tagBtn.style.color = '#6b7280';
                } else {
                    tagBtn.style.opacity = '1';
                }
            });
            tagBtn.addEventListener('click', () => {
                if (!this.selectedOssFilterTags) {
                    this.selectedOssFilterTags = [];
                }
                
                const index = this.selectedOssFilterTags.indexOf(tag);
                if (index > -1) {
                    // å–æ¶ˆé€‰ä¸­
                    this.selectedOssFilterTags.splice(index, 1);
                } else {
                    // é€‰ä¸­
                    this.selectedOssFilterTags.push(tag);
                }
                
                // æ›´æ–°æ‰€æœ‰æ ‡ç­¾æŒ‰é’®ï¼ˆç¡®ä¿çŠ¶æ€ä¸€è‡´ï¼‰
                this.updateOssTagFilterUI();
                // æ›´æ–°æ–‡ä»¶åˆ—è¡¨ï¼ˆåº”ç”¨è¿‡æ»¤ï¼‰
                this.updateOssFileSidebar();
            });
            
            tagFilterList.appendChild(tagBtn);
        });
    }

    // ç¡®ä¿OSSæ ‡ç­¾ç®¡ç†UIå­˜åœ¨
    ensureOssTagManagerUi() {
        if (!this.chatWindow) return;
        if (this.chatWindow.querySelector('#pet-oss-tag-manager')) return;

        const modal = document.createElement('div');
        modal.id = 'pet-oss-tag-manager';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: ${PET_CONFIG.ui.zIndex.modal + 1} !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆä»…å…³é—­ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼‰
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeOssTagManagerOnly();
            }
        });

        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 24px !important;
            width: 90% !important;
            max-width: 800px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        `;

        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ç®¡ç†æ ‡ç­¾';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'oss-tag-manager-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.title = 'å…³é—­ï¼ˆESCï¼‰';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });

        header.appendChild(title);
        header.appendChild(closeBtn);

        // è¾“å…¥åŒºåŸŸ
        const inputGroup = document.createElement('div');
        inputGroup.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
        `;

        const tagInput = document.createElement('input');
        tagInput.className = 'oss-tag-manager-input';
        tagInput.type = 'text';
        tagInput.placeholder = 'è¾“å…¥æ ‡ç­¾åç§°ï¼ŒæŒ‰å›è½¦æ·»åŠ ';
        tagInput.style.cssText = `
            flex: 1 !important;
            padding: 10px 12px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
        `;
        
        // è¾“å…¥æ³•ç»„åˆçŠ¶æ€è·Ÿè¸ªï¼ˆç”¨äºå¤„ç†ä¸­æ–‡è¾“å…¥ï¼‰
        tagInput._isComposing = false;
        tagInput.addEventListener('compositionstart', () => {
            tagInput._isComposing = true;
        });
        tagInput.addEventListener('compositionend', () => {
            tagInput._isComposing = false;
        });
        
        tagInput.addEventListener('focus', () => {
            tagInput.style.borderColor = '#4CAF50';
        });
        tagInput.addEventListener('blur', () => {
            tagInput.style.borderColor = '#e0e0e0';
        });

        const addBtn = document.createElement('button');
        addBtn.textContent = 'æ·»åŠ ';
        addBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.background = '#45a049';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.background = '#4CAF50';
        });
        addBtn.addEventListener('click', () => {
            const objectName = modal.dataset.objectName;
            if (objectName) {
                this.addOssTagFromInput(objectName);
            }
        });

        inputGroup.appendChild(tagInput);
        inputGroup.appendChild(addBtn);

        // æ ‡ç­¾åˆ—è¡¨
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'oss-tag-manager-tags';
        tagsContainer.style.cssText = `
            min-height: 100px !important;
            max-height: 300px !important;
            overflow-y: auto !important;
            margin-bottom: 20px !important;
            padding: 12px !important;
            background: #f8f9fa !important;
            border-radius: 6px !important;
        `;

        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 10px !important;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'oss-tag-manager-cancel';
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.title = 'å…³é—­';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #f0f0f0 !important;
            color: #333 !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: background 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#e0e0e0';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = '#f0f0f0';
        });
        cancelBtn.addEventListener('click', () => this.closeOssTagManagerOnly());

        const saveBtn = document.createElement('button');
        saveBtn.className = 'oss-tag-manager-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#1976D2';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#2196F3';
        });

        footer.appendChild(cancelBtn);
        footer.appendChild(saveBtn);

        panel.appendChild(header);
        panel.appendChild(inputGroup);
        panel.appendChild(tagsContainer);
        panel.appendChild(footer);
        modal.appendChild(panel);
        this.chatWindow.appendChild(modal);
    }

    // åŠ è½½æ ‡ç­¾åˆ°OSSæ ‡ç­¾ç®¡ç†å™¨
    loadOssTagsIntoManager(objectName, tags) {
        const modal = this.chatWindow?.querySelector('#pet-oss-tag-manager');
        if (!modal) return;

        const tagsContainer = modal.querySelector('.oss-tag-manager-tags');
        if (!tagsContainer) return;

        tagsContainer.innerHTML = '';

        if (!tags || tags.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #999 !important;
                padding: 20px !important;
                font-size: 14px !important;
            `;
            tagsContainer.appendChild(emptyMsg);
            return;
        }

        tags.forEach((tag, index) => {
            const tagItem = document.createElement('div');
            tagItem.style.cssText = `
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                background: #4CAF50 !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 20px !important;
                margin: 4px !important;
                font-size: 13px !important;
            `;

            const tagText = document.createElement('span');
            tagText.textContent = tag;

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = 'âœ•';
            removeBtn.style.cssText = `
                background: rgba(255, 255, 255, 0.3) !important;
                border: none !important;
                color: white !important;
                width: 18px !important;
                height: 18px !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                font-size: 12px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 0 !important;
                transition: background 0.2s ease !important;
            `;
            removeBtn.addEventListener('mouseenter', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.5)';
            });
            removeBtn.addEventListener('mouseleave', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            });
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const objectName = modal.dataset.objectName;
                if (objectName) {
                    this.removeOssTag(objectName, index);
                }
            });

            tagItem.appendChild(tagText);
            tagItem.appendChild(removeBtn);
            tagsContainer.appendChild(tagItem);
        });
    }

    // æ‰“å¼€OSSæ–‡ä»¶æ ‡ç­¾ç¼–è¾‘å™¨
    /**
     * ä¸‹è½½ OSS æ–‡ä»¶
     * @param {string} objectName - æ–‡ä»¶å¯¹è±¡å
     */
    async downloadOssFile(objectName) {
        try {
            // æ˜¾ç¤ºä¸‹è½½ä¸­æç¤º
            this.showNotification('æ­£åœ¨ä¸‹è½½æ–‡ä»¶...', 'info');
            
            // ä»æ–‡ä»¶åˆ—è¡¨ä¸­è·å–æ–‡ä»¶å¯¹è±¡
            let file = null;
            if (this.ossFileManager) {
                const files = this.ossFileManager.getAllFiles();
                file = files.find(f => f.name === objectName);
            }
            
            // è·å–æ–‡ä»¶ URL
            let fileUrl = null;
            if (file && file.url) {
                fileUrl = file.url;
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶å¯¹è±¡æˆ–æ²¡æœ‰ URLï¼Œå°è¯•ä½¿ç”¨ objectName ä½œä¸º URL
                console.warn('æœªæ‰¾åˆ°æ–‡ä»¶å¯¹è±¡æˆ–æ–‡ä»¶ç¼ºå°‘ URLï¼Œä½¿ç”¨ objectName:', objectName);
                fileUrl = objectName;
            }
            
            if (!fileUrl) {
                this.showNotification('æ–‡ä»¶ URL ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // ç¡®å®šæ–‡ä»¶å
            const fileName = file?.name || objectName.split('/').pop() || 'download';
            const downloadFilename = fileName.split('/').pop() || 'download';
            
            // ç›´æ¥åˆ›å»ºä¸‹è½½é“¾æ¥ï¼Œé¿å… CORS é—®é¢˜
            // æ–¹æ³•1: å°è¯•ä½¿ç”¨ download å±æ€§ï¼ˆå¯¹äºåŒåŸŸæˆ–è®¾ç½®äº† CORS çš„æ–‡ä»¶å¯èƒ½æœ‰æ•ˆï¼‰
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = downloadFilename;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.style.display = 'none';
            
            // æ·»åŠ åˆ° DOM å¹¶è§¦å‘ç‚¹å‡»
            document.body.appendChild(link);
            link.click();
            
            // å»¶è¿Ÿæ¸…ç†ï¼Œç¡®ä¿ä¸‹è½½å·²å¼€å§‹
            setTimeout(() => {
                document.body.removeChild(link);
            }, 100);
            
            // å¦‚æœ download å±æ€§ä¸ç”Ÿæ•ˆï¼ˆè·¨åŸŸæƒ…å†µï¼‰ï¼Œå°è¯•åœ¨æ–°çª—å£æ‰“å¼€
            // è¿™ä¼šè®©æµè§ˆå™¨å¤„ç†ä¸‹è½½ï¼Œè™½ç„¶å¯èƒ½ä¸æ˜¯ç›´æ¥ä¸‹è½½è€Œæ˜¯æ‰“å¼€
            // ä½†è‡³å°‘å¯ä»¥è®©ç”¨æˆ·è®¿é—®æ–‡ä»¶
            
            this.showNotification('æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹', 'success');
            console.log('æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹:', downloadFilename, fileUrl);
        } catch (error) {
            console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
            // å¦‚æœç›´æ¥ä¸‹è½½å¤±è´¥ï¼Œå°è¯•åœ¨æ–°çª—å£æ‰“å¼€ URL
            try {
                const file = this.ossFileManager?.getAllFiles().find(f => f.name === objectName);
                const fileUrl = file?.url || objectName;
                if (fileUrl) {
                    window.open(fileUrl, '_blank');
                    this.showNotification('å·²åœ¨æ–°çª—å£æ‰“å¼€æ–‡ä»¶', 'info');
                } else {
                    this.showNotification('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (fallbackError) {
                console.error('å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆä¹Ÿå¤±è´¥:', fallbackError);
                this.showNotification('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }
    }
    
    async openOssFileTagEditor(objectName, currentTags = []) {
        if (!this.ossApi || !this.ossApi.isEnabled()) {
            this.showNotification('OSS APIæœªå¯ç”¨', 'error');
            return;
        }

        // ç¡®ä¿UIå­˜åœ¨
        this.ensureOssTagManagerUi();
        const modal = this.chatWindow?.querySelector('#pet-oss-tag-manager');
        if (!modal) {
            console.error('OSSæ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }

        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
        modal.dataset.objectName = objectName;
        
        // éšè—æŠ˜å æŒ‰é’®ï¼ˆé¿å…åœ¨å¼¹æ¡†ä¸­æ˜¾ç¤ºä¸¤ä¸ªæŠ˜å æŒ‰é’®ï¼‰
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';

        // åŠ è½½å½“å‰æ ‡ç­¾ï¼ˆä»åç«¯è·å–æœ€æ–°æ ‡ç­¾ï¼‰
        try {
            const latestTags = await this.ossApi.getFileTags(objectName);
            this.loadOssTagsIntoManager(objectName, latestTags);
            // ä¿å­˜åˆ°modalçš„ä¸´æ—¶æ•°æ®ä¸­
            modal._currentTags = [...latestTags]; // ä½¿ç”¨å‰¯æœ¬ï¼Œé¿å…å¼•ç”¨é—®é¢˜
            modal._originalTags = [...latestTags]; // ä¿å­˜åŸå§‹æ ‡ç­¾ï¼Œç”¨äºå–æ¶ˆæ—¶æ¢å¤
        } catch (error) {
            console.warn('è·å–æ–‡ä»¶æ ‡ç­¾å¤±è´¥ï¼Œä½¿ç”¨ä¼ å…¥çš„æ ‡ç­¾:', error);
            const tags = currentTags || [];
            this.loadOssTagsIntoManager(objectName, tags);
            modal._currentTags = [...tags]; // ä½¿ç”¨å‰¯æœ¬ï¼Œé¿å…å¼•ç”¨é—®é¢˜
            modal._originalTags = [...tags]; // ä¿å­˜åŸå§‹æ ‡ç­¾ï¼Œç”¨äºå–æ¶ˆæ—¶æ¢å¤
        }

        // æ·»åŠ å…³é—­äº‹ä»¶ï¼ˆä»…å…³é—­ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼‰
        const closeBtn = modal.querySelector('.oss-tag-manager-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeOssTagManagerOnly();
        }
        
        // æ·»åŠ å–æ¶ˆäº‹ä»¶ï¼ˆä»…å…³é—­ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼‰
        const cancelBtn = modal.querySelector('.oss-tag-manager-cancel');
        if (cancelBtn) {
            cancelBtn.onclick = () => this.closeOssTagManagerOnly();
        }

        // æ·»åŠ ä¿å­˜äº‹ä»¶
        const saveBtn = modal.querySelector('.oss-tag-manager-save');
        if (saveBtn) {
            saveBtn.onclick = () => this.saveOssTags(objectName);
        }

        // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶ï¼ˆå…¼å®¹ä¸­æ–‡è¾“å…¥æ³•ï¼‰
        const tagInput = modal.querySelector('.oss-tag-manager-input');
        if (tagInput) {
            // ç¡®ä¿è¾“å…¥æ³•ç»„åˆçŠ¶æ€å·²åˆå§‹åŒ–
            if (tagInput._isComposing === undefined) {
                tagInput._isComposing = false;
                tagInput.addEventListener('compositionstart', () => {
                    tagInput._isComposing = true;
                });
                tagInput.addEventListener('compositionend', () => {
                    tagInput._isComposing = false;
                });
            }
            
            // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†
            const existingHandler = tagInput._enterKeyHandler;
            if (existingHandler) {
                tagInput.removeEventListener('keydown', existingHandler);
            }
            
            const enterKeyHandler = (e) => {
                // å¦‚æœåœ¨è¾“å…¥æ³•ç»„åˆè¿‡ç¨‹ä¸­ï¼Œå¿½ç•¥å›è½¦é”®
                if (tagInput._isComposing) {
                    return;
                }
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addOssTagFromInput(objectName);
                }
            };
            
            tagInput._enterKeyHandler = enterKeyHandler;
            tagInput.addEventListener('keydown', enterKeyHandler);
            
            tagInput.focus();
        }

        // ESC é”®å…³é—­ï¼ˆä»…å…³é—­ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼‰
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeOssTagManagerOnly();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    // ä»è¾“å…¥æ¡†æ·»åŠ OSSæ ‡ç­¾
    addOssTagFromInput(objectName) {
        const modal = this.chatWindow?.querySelector('#pet-oss-tag-manager');
        if (!modal) return;

        const tagInput = modal.querySelector('.oss-tag-manager-input');
        if (!tagInput) return;

        const tagName = tagInput.value.trim();
        if (!tagName) return;

        // è·å–å½“å‰æ ‡ç­¾åˆ—è¡¨
        if (!modal._currentTags) {
            modal._currentTags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (modal._currentTags.includes(tagName)) {
            tagInput.value = '';
            tagInput.focus();
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        modal._currentTags.push(tagName);
        tagInput.value = '';
        tagInput.focus();

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadOssTagsIntoManager(objectName, modal._currentTags);
    }

    // åˆ é™¤OSSæ ‡ç­¾
    removeOssTag(objectName, index) {
        const modal = this.chatWindow?.querySelector('#pet-oss-tag-manager');
        if (!modal || !modal._currentTags) return;

        modal._currentTags.splice(index, 1);
        this.loadOssTagsIntoManager(objectName, modal._currentTags);
    }

    // ä¿å­˜OSSæ ‡ç­¾
    async saveOssTags(objectName) {
        const modal = this.chatWindow?.querySelector('#pet-oss-tag-manager');
        if (!modal || !modal._currentTags) {
            console.warn('æ— æ³•ä¿å­˜æ ‡ç­¾ï¼šæ•°æ®ä¸å­˜åœ¨');
            return;
        }

        try {
            // ä¿å­˜æ–‡ä»¶æ ‡ç­¾åˆ°åç«¯
            await this.ossApi.setFileTags(objectName, modal._currentTags);
            
            // æ‰¾åˆ°æ‰€æœ‰ä¸è¯¥æ–‡ä»¶å…³è”çš„ä¼šè¯å¹¶æ›´æ–°æ ‡ç­¾
            const matchedSessionIds = this._findSessionsByOssFile(objectName);
            const updatedSessionIds = [];
            
            for (const sessionId of matchedSessionIds) {
                const session = this.sessions[sessionId];
                if (session) {
                    // æ›´æ–°ä¼šè¯çš„æ ‡ç­¾
                    session.tags = [...modal._currentTags];
                    
                    // æ›´æ–° OSS æ–‡ä»¶ä¿¡æ¯ä¸­çš„æ ‡ç­¾
                    if (session._ossFileInfo) {
                        session._ossFileInfo.tags = [...modal._currentTags];
                    }
                    
                    // æ›´æ–°ä¼šè¯æ—¶é—´æˆ³
                    session.updatedAt = Date.now();
                    
                    updatedSessionIds.push(sessionId);
                    console.log('å·²æ›´æ–°å…³è”ä¼šè¯çš„æ ‡ç­¾:', sessionId, { tags: modal._currentTags });
                }
            }
            
            // ä¿å­˜æ‰€æœ‰æ›´æ–°çš„ä¼šè¯
            if (updatedSessionIds.length > 0) {
                // ä¿å­˜åˆ°æœ¬åœ°
                await this.saveAllSessions(false, false);
                
                // åŒæ­¥åˆ°åç«¯ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
                for (const sessionId of updatedSessionIds) {
                    this.syncSessionToBackend(sessionId, false).catch(err => {
                        console.warn('åŒæ­¥ä¼šè¯åˆ°åç«¯å¤±è´¥:', sessionId, err);
                    });
                }
                
                // å¦‚æœå½“å‰ä¼šè¯æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œæ›´æ–°UIæ˜¾ç¤º
                if (updatedSessionIds.includes(this.currentSessionId)) {
                    // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
                    await this.updateSessionSidebar();
                }
            }
            
            this.showNotification('æ ‡ç­¾ä¿å­˜æˆåŠŸ', 'success');
            
            // æ›´æ–°åŸå§‹æ ‡ç­¾ä¸ºå½“å‰æ ‡ç­¾ï¼Œé¿å…å…³é—­æ—¶é‡å¤ä¿å­˜
            modal._originalTags = [...modal._currentTags];
            
            // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å’Œæ ‡ç­¾ç­›é€‰å™¨
            await this.updateOssFileSidebar(true);
            await this.updateOssTagFilterUI();
            
            // å…³é—­å¼¹çª—ï¼ˆä¸ä¿å­˜ï¼Œå› ä¸ºå·²ç»ä¿å­˜è¿‡äº†ï¼‰
            this.closeOssTagManager(false);
        } catch (error) {
            console.error('ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
            this.showNotification('ä¿å­˜æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
        }
    }

    // å…³é—­OSSæ ‡ç­¾ç®¡ç†å™¨ï¼ˆä»…å…³é—­ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼‰
    closeOssTagManagerOnly() {
        const modal = this.chatWindow?.querySelector('#pet-oss-tag-manager');
        if (!modal) return;

        // å…³é—­å¼¹çª—
        modal.style.display = 'none';
        
        // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
        if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
        
        const tagInput = modal.querySelector('.oss-tag-manager-input');
        if (tagInput) {
            tagInput.value = '';
        }
        
        // æ¸…ç†æ•°æ®
        delete modal._currentTags;
        delete modal._originalTags;
    }

    // å…³é—­OSSæ ‡ç­¾ç®¡ç†å™¨
    // @param {boolean} saveChanges - æ˜¯å¦ä¿å­˜æ›´æ”¹ï¼Œtrue=ä¿å­˜ï¼Œfalse=å–æ¶ˆï¼ˆæ¢å¤åŸå§‹æ ‡ç­¾ï¼‰
    async closeOssTagManager(saveChanges = true) {
        const modal = this.chatWindow?.querySelector('#pet-oss-tag-manager');
        if (!modal) return;

        const objectName = modal.dataset.objectName;
        
        if (saveChanges) {
            // ä¿å­˜æ›´æ”¹ï¼ˆä»…åœ¨æ ‡ç­¾æœ‰å˜åŒ–æ—¶ä¿å­˜ï¼‰
            if (objectName && modal._currentTags) {
                // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦æœ‰å˜åŒ–
                const hasChanges = this._hasTagChanges(modal._currentTags, modal._originalTags);
                
                if (hasChanges) {
                    try {
                        // ä¿å­˜æ–‡ä»¶æ ‡ç­¾åˆ°åç«¯
                        await this.ossApi.setFileTags(objectName, modal._currentTags);
                        
                        // æ‰¾åˆ°æ‰€æœ‰ä¸è¯¥æ–‡ä»¶å…³è”çš„ä¼šè¯å¹¶æ›´æ–°æ ‡ç­¾
                        const matchedSessionIds = this._findSessionsByOssFile(objectName);
                        const updatedSessionIds = [];
                        
                        for (const sessionId of matchedSessionIds) {
                            const session = this.sessions[sessionId];
                            if (session) {
                                // æ›´æ–°ä¼šè¯çš„æ ‡ç­¾
                                session.tags = [...modal._currentTags];
                                
                                // æ›´æ–° OSS æ–‡ä»¶ä¿¡æ¯ä¸­çš„æ ‡ç­¾
                                if (session._ossFileInfo) {
                                    session._ossFileInfo.tags = [...modal._currentTags];
                                }
                                
                                // æ›´æ–°ä¼šè¯æ—¶é—´æˆ³
                                session.updatedAt = Date.now();
                                
                                updatedSessionIds.push(sessionId);
                                console.log('å·²æ›´æ–°å…³è”ä¼šè¯çš„æ ‡ç­¾:', sessionId, { tags: modal._currentTags });
                            }
                        }
                        
                        // ä¿å­˜æ‰€æœ‰æ›´æ–°çš„ä¼šè¯
                        if (updatedSessionIds.length > 0) {
                            // ä¿å­˜åˆ°æœ¬åœ°
                            await this.saveAllSessions(false, false);
                            
                            // åŒæ­¥åˆ°åç«¯ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
                            for (const sessionId of updatedSessionIds) {
                                this.syncSessionToBackend(sessionId, false).catch(err => {
                                    console.warn('åŒæ­¥ä¼šè¯åˆ°åç«¯å¤±è´¥:', sessionId, err);
                                });
                            }
                            
                            // å¦‚æœå½“å‰ä¼šè¯æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œæ›´æ–°UIæ˜¾ç¤º
                            if (updatedSessionIds.includes(this.currentSessionId)) {
                                // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
                                await this.updateSessionSidebar();
                            }
                        }
                        
                        this.showNotification('æ ‡ç­¾å·²ä¿å­˜', 'success');
                        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å’Œæ ‡ç­¾ç­›é€‰å™¨
                        await this.updateOssFileSidebar(true);
                        await this.updateOssTagFilterUI();
                    } catch (error) {
                        console.error('ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
                        this.showNotification('ä¿å­˜æ ‡ç­¾å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                } else {
                    // æ ‡ç­¾æ²¡æœ‰å˜åŒ–ï¼Œä¸éœ€è¦ä¿å­˜
                    console.log('æ ‡ç­¾æœªå˜åŒ–ï¼Œæ— éœ€ä¿å­˜');
                }
            }
        } else {
            // å–æ¶ˆæ›´æ”¹ï¼Œæ¢å¤åŸå§‹æ ‡ç­¾
            if (objectName && modal._originalTags !== undefined) {
                // æ¢å¤åŸå§‹æ ‡ç­¾ï¼ˆå¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œé‡æ–°åŠ è½½åŸå§‹æ ‡ç­¾ï¼‰
                // ç”±äºå·²ç»å–æ¶ˆäº†ï¼Œä¸éœ€è¦åšä»»ä½•æ“ä½œï¼Œåªæ˜¯å…³é—­å¼¹çª—
                console.log('å·²å–æ¶ˆæ ‡ç­¾æ›´æ”¹');
            }
        }

        // å…³é—­å¼¹çª—
        modal.style.display = 'none';
        
        // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
        if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
        
        const tagInput = modal.querySelector('.oss-tag-manager-input');
        if (tagInput) {
            tagInput.value = '';
        }
        
        // æ¸…ç†æ•°æ®
        delete modal._currentTags;
        delete modal._originalTags;
    }
    
    // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦æœ‰å˜åŒ–
    _hasTagChanges(currentTags, originalTags) {
        if (!currentTags && !originalTags) return false;
        if (!currentTags || !originalTags) return true;
        
        // æ¯”è¾ƒæ•°ç»„é•¿åº¦
        if (currentTags.length !== originalTags.length) return true;
        
        // æ’åºåæ¯”è¾ƒå†…å®¹
        const currentSorted = [...currentTags].sort().join(',');
        const originalSorted = [...originalTags].sort().join(',');
        
        return currentSorted !== originalSorted;
    }

    // ===== å¸¸è§é—®é¢˜ç®¡ç†åŠŸèƒ½ =====
    
    // ç¡®ä¿å¸¸è§é—®é¢˜ç®¡ç†å™¨UIå­˜åœ¨
    ensureFaqManagerUi() {
        if (!this.chatWindow) return;
        if (this.chatWindow.querySelector('#pet-faq-manager')) return;

        const modal = document.createElement('div');
        modal.id = 'pet-faq-manager';
        modal.style.cssText = `
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.4) !important;
            backdrop-filter: blur(2px) !important;
            display: none !important;
            align-items: flex-start !important;
            justify-content: center !important;
            padding-top: 60px !important;
            z-index: ${PET_CONFIG.ui.zIndex.modal} !important;
            opacity: 0 !important;
            transition: opacity 0.2s ease !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeFaqManagerOnly();
            }
        });

        const panel = document.createElement('div');
        panel.className = 'faq-manager-panel';
        panel.style.cssText = `
            background: white !important;
            border-radius: 16px !important;
            padding: 0 !important;
            width: 1165px !important;
            height: 720px !important;
            overflow: hidden !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            display: flex !important;
            flex-direction: column !important;
            transform: scale(0.95) !important;
            transition: transform 0.2s ease !important;
        `;

        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 20px 24px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%) !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ğŸ’¡ å¸¸è§é—®é¢˜';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #1e293b !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        `;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'faq-manager-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.title = 'å…³é—­ï¼ˆESCï¼‰';
        closeBtn.style.cssText = `
            background: rgba(0, 0, 0, 0.05) !important;
            border: none !important;
            font-size: 20px !important;
            cursor: pointer !important;
            color: #64748b !important;
            padding: 0 !important;
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(0, 0, 0, 0.1)';
            closeBtn.style.color = '#1e293b';
            closeBtn.style.transform = 'rotate(90deg)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(0, 0, 0, 0.05)';
            closeBtn.style.color = '#64748b';
            closeBtn.style.transform = 'rotate(0deg)';
        });

        header.appendChild(title);
        header.appendChild(closeBtn);

        // æœç´¢å’Œè¿‡æ»¤åŒºåŸŸ
        const searchFilterGroup = document.createElement('div');
        searchFilterGroup.style.cssText = `
            display: flex !important;
            flex-direction: column !important;
            gap: 12px !important;
            padding: 20px 24px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #fafbfc !important;
        `;

        // æœç´¢è¾“å…¥æ¡†
        const searchContainer = document.createElement('div');
        searchContainer.style.cssText = `
            position: relative !important;
            display: flex !important;
            align-items: center !important;
        `;

        const searchIcon = document.createElement('span');
        searchIcon.textContent = 'ğŸ”';
        searchIcon.style.cssText = `
            position: absolute !important;
            left: 12px !important;
            font-size: 14px !important;
            pointer-events: none !important;
            z-index: 1 !important;
            opacity: 0.5 !important;
        `;

        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'faq-search-input';
        searchInput.placeholder = 'æœç´¢å¸¸è§é—®é¢˜...';
        searchInput.style.cssText = `
            width: 100% !important;
            padding: 10px 32px 10px 36px !important;
            border: 2px solid #e2e8f0 !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: all 0.2s ease !important;
            background: white !important;
            color: #1e293b !important;
            box-sizing: border-box !important;
        `;

        const mainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
        searchInput.addEventListener('focus', () => {
            searchInput.style.borderColor = mainColor;
            searchInput.style.boxShadow = `0 0 0 3px ${mainColor}20`;
            searchIcon.style.opacity = '0.7';
        });
        searchInput.addEventListener('blur', () => {
            searchInput.style.borderColor = '#e2e8f0';
            searchInput.style.boxShadow = 'none';
            searchIcon.style.opacity = '0.5';
        });

        // æ¸…é™¤æœç´¢æŒ‰é’®
        const clearSearchBtn = document.createElement('button');
        clearSearchBtn.innerHTML = 'âœ•';
        clearSearchBtn.type = 'button';
        clearSearchBtn.style.cssText = `
            position: absolute !important;
            right: 8px !important;
            width: 20px !important;
            height: 20px !important;
            border: none !important;
            background: #e5e7eb !important;
            color: #6b7280 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            padding: 0 !important;
            transition: all 0.2s ease !important;
            z-index: 2 !important;
            line-height: 1 !important;
        `;

        const updateClearSearchBtn = () => {
            if (searchInput.value.trim() !== '') {
                clearSearchBtn.style.display = 'flex';
            } else {
                clearSearchBtn.style.display = 'none';
            }
        };

        clearSearchBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            searchInput.value = '';
            updateClearSearchBtn();
            this.faqSearchFilter = '';
            this.loadFaqsIntoManager();
            searchInput.focus();
        });

        clearSearchBtn.addEventListener('mouseenter', () => {
            clearSearchBtn.style.background = '#d1d5db';
            clearSearchBtn.style.transform = 'scale(1.1)';
        });
        clearSearchBtn.addEventListener('mouseleave', () => {
            clearSearchBtn.style.background = '#e5e7eb';
            clearSearchBtn.style.transform = 'scale(1)';
        });

        // æœç´¢è¾“å…¥äº‹ä»¶ï¼ˆé˜²æŠ–ï¼‰
        let searchDebounceTimer = null;
        searchInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            this.faqSearchFilter = value;
            updateClearSearchBtn();
            
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            searchDebounceTimer = setTimeout(() => {
                this.loadFaqsIntoManager();
            }, 300);
        });

        searchContainer.appendChild(searchIcon);
        searchContainer.appendChild(searchInput);
        searchContainer.appendChild(clearSearchBtn);

        // æ ‡ç­¾è¿‡æ»¤åŒºåŸŸ
        const tagFilterContainer = document.createElement('div');
        tagFilterContainer.className = 'faq-tag-filter-container';
        tagFilterContainer.style.cssText = `
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
        `;

        const tagFilterHeader = document.createElement('div');
        tagFilterHeader.style.cssText = `
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 8px !important;
        `;

        const tagFilterTitle = document.createElement('span');
        tagFilterTitle.textContent = 'ğŸ·ï¸ æ ‡ç­¾è¿‡æ»¤';
        tagFilterTitle.style.cssText = `
            font-size: 12px !important;
            color: #64748b !important;
            font-weight: 500 !important;
        `;

        const tagFilterActions = document.createElement('div');
        tagFilterActions.style.cssText = `
            display: flex !important;
            gap: 6px !important;
            align-items: center !important;
        `;

        // åå‘è¿‡æ»¤æŒ‰é’®
        const reverseFilterBtn = document.createElement('button');
        reverseFilterBtn.innerHTML = 'ğŸ”„';
        reverseFilterBtn.title = 'åå‘è¿‡æ»¤';
        reverseFilterBtn.style.cssText = `
            width: 24px !important;
            height: 24px !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 4px !important;
            background: white !important;
            cursor: pointer !important;
            font-size: 12px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            padding: 0 !important;
        `;

        // æ— æ ‡ç­¾è¿‡æ»¤æŒ‰é’®
        const noTagsFilterBtn = document.createElement('button');
        noTagsFilterBtn.innerHTML = 'ğŸ“­';
        noTagsFilterBtn.title = 'æ˜¾ç¤ºæ— æ ‡ç­¾é—®é¢˜';
        noTagsFilterBtn.style.cssText = `
            width: 24px !important;
            height: 24px !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 4px !important;
            background: white !important;
            cursor: pointer !important;
            font-size: 12px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            padding: 0 !important;
        `;

        // æ¸…é™¤è¿‡æ»¤æŒ‰é’®
        const clearFilterBtn = document.createElement('button');
        clearFilterBtn.innerHTML = 'âœ•';
        clearFilterBtn.title = 'æ¸…é™¤è¿‡æ»¤';
        clearFilterBtn.style.cssText = `
            width: 24px !important;
            height: 24px !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 4px !important;
            background: white !important;
            cursor: pointer !important;
            font-size: 12px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            padding: 0 !important;
        `;

        // åˆå§‹åŒ–è¿‡æ»¤çŠ¶æ€
        if (!this.faqSelectedFilterTags) {
            this.faqSelectedFilterTags = [];
        }
        if (this.faqTagFilterReverse === undefined) {
            this.faqTagFilterReverse = false;
        }
        if (this.faqTagFilterNoTags === undefined) {
            this.faqTagFilterNoTags = false;
        }

        const updateTagFilterButtons = () => {
            reverseFilterBtn.style.color = this.faqTagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.faqTagFilterReverse ? '1' : '0.6';
            noTagsFilterBtn.style.color = this.faqTagFilterNoTags ? '#4CAF50' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.faqTagFilterNoTags ? '1' : '0.6';
            const hasActiveFilter = (this.faqSelectedFilterTags && this.faqSelectedFilterTags.length > 0) || this.faqTagFilterNoTags;
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.cursor = hasActiveFilter ? 'pointer' : 'default';
        };

        reverseFilterBtn.addEventListener('click', () => {
            this.faqTagFilterReverse = !this.faqTagFilterReverse;
            updateTagFilterButtons();
            this.loadFaqsIntoManager();
        });

        noTagsFilterBtn.addEventListener('click', () => {
            this.faqTagFilterNoTags = !this.faqTagFilterNoTags;
            updateTagFilterButtons();
            this.loadFaqsIntoManager();
        });

        clearFilterBtn.addEventListener('click', () => {
            this.faqSelectedFilterTags = [];
            this.faqTagFilterReverse = false;
            this.faqTagFilterNoTags = false;
            updateTagFilterButtons();
            this.updateFaqTagFilterUI();
            this.loadFaqsIntoManager();
        });

        tagFilterActions.appendChild(reverseFilterBtn);
        tagFilterActions.appendChild(noTagsFilterBtn);
        tagFilterActions.appendChild(clearFilterBtn);

        tagFilterHeader.appendChild(tagFilterTitle);
        tagFilterHeader.appendChild(tagFilterActions);

        // æ ‡ç­¾åˆ—è¡¨
        const tagFilterList = document.createElement('div');
        tagFilterList.className = 'faq-tag-filter-list';
        tagFilterList.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 6px !important;
            max-height: 80px !important;
            overflow-y: auto !important;
        `;

        tagFilterContainer.appendChild(tagFilterHeader);
        tagFilterContainer.appendChild(tagFilterList);

        // å­˜å‚¨å¼•ç”¨ä»¥ä¾¿åç»­æ›´æ–°
        modal._tagFilterList = tagFilterList;
        modal._updateTagFilterButtons = updateTagFilterButtons;

        searchFilterGroup.appendChild(searchContainer);
        searchFilterGroup.appendChild(tagFilterContainer);

        // è¾“å…¥åŒºåŸŸ
        const inputGroup = document.createElement('div');
        inputGroup.style.cssText = `
            display: flex !important;
            gap: 10px !important;
            padding: 20px 24px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #fafbfc !important;
        `;

        const faqInput = document.createElement('textarea');
        faqInput.className = 'faq-manager-input';
        faqInput.placeholder = 'è¾“å…¥é—®é¢˜å†…å®¹ï¼ŒæŒ‰ Ctrl+Enter æˆ– Shift+Enter æ·»åŠ ';
        faqInput.style.cssText = `
            flex: 1 !important;
            padding: 12px 16px !important;
            border: 2px solid #e2e8f0 !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: all 0.2s ease !important;
            resize: vertical !important;
            min-height: 70px !important;
            max-height: 150px !important;
            font-family: inherit !important;
            background: white !important;
            color: #1e293b !important;
            line-height: 1.5 !important;
        `;
        
        // è¾“å…¥æ³•ç»„åˆçŠ¶æ€è·Ÿè¸ªï¼ˆç”¨äºå¤„ç†ä¸­æ–‡è¾“å…¥ï¼‰
        faqInput._isComposing = false;
        faqInput.addEventListener('compositionstart', () => {
            faqInput._isComposing = true;
        });
        faqInput.addEventListener('compositionend', () => {
            faqInput._isComposing = false;
        });
        
        faqInput.addEventListener('focus', () => {
            faqInput.style.borderColor = mainColor;
            faqInput.style.boxShadow = `0 0 0 3px ${mainColor}20`;
        });
        faqInput.addEventListener('blur', () => {
            faqInput.style.borderColor = '#e2e8f0';
            faqInput.style.boxShadow = 'none';
        });

        inputGroup.appendChild(faqInput);

        // å¸¸è§é—®é¢˜åˆ—è¡¨
        const faqsContainer = document.createElement('div');
        faqsContainer.className = 'faq-manager-faqs';
        faqsContainer.style.cssText = `
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 16px 24px !important;
            background: white !important;
            min-height: 0 !important;
        `;
        
        // è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            #pet-faq-manager .faq-manager-faqs::-webkit-scrollbar {
                width: 6px;
            }
            #pet-faq-manager .faq-manager-faqs::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 3px;
            }
            #pet-faq-manager .faq-manager-faqs::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            #pet-faq-manager .faq-manager-faqs::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
        `;
        document.head.appendChild(style);

        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 10px !important;
            padding: 16px 24px !important;
            border-top: 1px solid #e5e7eb !important;
            background: #fafbfc !important;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'faq-manager-cancel';
        cancelBtn.textContent = 'å…³é—­';
        cancelBtn.title = 'å…³é—­';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            background: white !important;
            color: #64748b !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f1f5f9';
            cancelBtn.style.borderColor = '#cbd5e1';
            cancelBtn.style.color = '#475569';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'white';
            cancelBtn.style.borderColor = '#e2e8f0';
            cancelBtn.style.color = '#64748b';
        });
        cancelBtn.addEventListener('click', () => this.closeFaqManagerOnly());

        footer.appendChild(cancelBtn);

        panel.appendChild(header);
        panel.appendChild(searchFilterGroup);
        panel.appendChild(inputGroup);
        panel.appendChild(faqsContainer);
        panel.appendChild(footer);
        modal.appendChild(panel);
        this.chatWindow.appendChild(modal);
    }

    // æ‰“å¼€å¸¸è§é—®é¢˜ç®¡ç†å™¨
    async openFaqManager() {
        // ç¡®ä¿UIå­˜åœ¨
        this.ensureFaqManagerUi();
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal) {
            console.error('å¸¸è§é—®é¢˜ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }

        // ç¡®ä¿ chatWindow æœ‰æ­£ç¡®çš„å®šä½ä¸Šä¸‹æ–‡ï¼ˆç”¨äº absolute å®šä½çš„å¼¹æ¡†ï¼‰
        if (this.chatWindow) {
            const currentPosition = window.getComputedStyle(this.chatWindow).position;
            if (currentPosition !== 'relative' && currentPosition !== 'absolute' && currentPosition !== 'fixed') {
                this.chatWindow.style.position = 'relative';
            }
        }

        // è®¡ç®—å¹¶è®¾ç½®å¼¹æ¡†å¤§å°ï¼ˆè‡ªé€‚åº”èŠå¤©å¼¹æ¡†ï¼‰
        const updatePanelSize = () => {
            const panel = modal.querySelector('.faq-manager-panel');
            if (!panel || !this.chatWindow) return;
            
            const chatRect = this.chatWindow.getBoundingClientRect();
            const maxWidth = Math.min(700, chatRect.width * 0.85);
            const maxHeight = Math.min(chatRect.height * 0.85, window.innerHeight * 0.85);
            
            panel.style.maxWidth = `${maxWidth}px`;
            panel.style.maxHeight = `${maxHeight}px`;
        };
        
        updatePanelSize();
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–å’ŒèŠå¤©å¼¹æ¡†å¤§å°å˜åŒ–
        const resizeHandler = () => updatePanelSize();
        window.addEventListener('resize', resizeHandler);
        modal._resizeHandler = resizeHandler;
        
        // ä½¿ç”¨ ResizeObserver ç›‘å¬èŠå¤©å¼¹æ¡†å¤§å°å˜åŒ–
        if (this.chatWindow && window.ResizeObserver) {
            const resizeObserver = new ResizeObserver(() => {
                updatePanelSize();
            });
            resizeObserver.observe(this.chatWindow);
            modal._resizeObserver = resizeObserver;
        }

        // æ˜¾ç¤ºå¼¹çª—ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.style.opacity = '1';
            const panel = modal.querySelector('.faq-manager-panel');
            if (panel) {
                panel.style.transform = 'scale(1)';
            }
        });
        
        // éšè—æŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';

        // åˆå§‹åŒ–æœç´¢æ¡†
        const searchInput = modal.querySelector('.faq-search-input');
        if (searchInput) {
            searchInput.value = this.faqSearchFilter || '';
            const clearSearchBtn = searchInput.parentElement.querySelector('button[type="button"]');
            if (clearSearchBtn && searchInput.value.trim() !== '') {
                clearSearchBtn.style.display = 'flex';
            }
        }

        // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
        this.updateFaqTagFilterUI();

        // åŠ è½½å¸¸è§é—®é¢˜
        await this.loadFaqsIntoManager();

        // æ·»åŠ å…³é—­äº‹ä»¶
        const closeBtn = modal.querySelector('.faq-manager-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeFaqManagerOnly();
        }
        
        // æ·»åŠ å–æ¶ˆäº‹ä»¶
        const cancelBtn = modal.querySelector('.faq-manager-cancel');
        if (cancelBtn) {
            cancelBtn.onclick = () => this.closeFaqManagerOnly();
        }

        // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶ï¼ˆå…¼å®¹ä¸­æ–‡è¾“å…¥æ³•ï¼‰
        const faqInput = modal.querySelector('.faq-manager-input');
        if (faqInput) {
            // ç¡®ä¿è¾“å…¥æ³•ç»„åˆçŠ¶æ€å·²åˆå§‹åŒ–
            if (faqInput._isComposing === undefined) {
                faqInput._isComposing = false;
                faqInput.addEventListener('compositionstart', () => {
                    faqInput._isComposing = true;
                });
                faqInput.addEventListener('compositionend', () => {
                    faqInput._isComposing = false;
                });
            }
            
            // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†ï¼ˆCtrl+Enter æˆ– Shift+Enter æ·»åŠ ï¼ŒEnter æ¢è¡Œï¼‰
            const existingHandler = faqInput._enterKeyHandler;
            if (existingHandler) {
                faqInput.removeEventListener('keydown', existingHandler);
            }
            
            const enterKeyHandler = (e) => {
                // å¦‚æœåœ¨è¾“å…¥æ³•ç»„åˆè¿‡ç¨‹ä¸­ï¼Œå¿½ç•¥å›è½¦é”®
                if (faqInput._isComposing) {
                    return;
                }
                
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey || e.shiftKey)) {
                    e.preventDefault();
                    this.addFaqFromInput();
                }
            };
            
            faqInput._enterKeyHandler = enterKeyHandler;
            faqInput.addEventListener('keydown', enterKeyHandler);
            
            faqInput.focus();
        }

        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeFaqManagerOnly();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    // å…³é—­å¸¸è§é—®é¢˜ç®¡ç†å™¨ï¼ˆä»…å…³é—­ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼‰
    closeFaqManagerOnly() {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal) return;

        // ç§»é™¤çª—å£å¤§å°ç›‘å¬
        if (modal._resizeHandler) {
            window.removeEventListener('resize', modal._resizeHandler);
            delete modal._resizeHandler;
        }
        
        // ç§»é™¤ ResizeObserver
        if (modal._resizeObserver) {
            modal._resizeObserver.disconnect();
            delete modal._resizeObserver;
        }

        // å…³é—­åŠ¨ç”»
        modal.style.opacity = '0';
        const panel = modal.querySelector('.faq-manager-panel');
        if (panel) {
            panel.style.transform = 'scale(0.95)';
        }
        
        // å»¶è¿Ÿéšè—å¼¹çª—
        setTimeout(() => {
            modal.style.display = 'none';
        }, 200);
        
        // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
        if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
        
        const faqInput = modal.querySelector('.faq-manager-input');
        if (faqInput) {
            faqInput.value = '';
        }
    }

    // è·å–æ‰€æœ‰å¸¸è§é—®é¢˜çš„æ ‡ç­¾
    getAllFaqTags() {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal || !modal._currentFaqs) return [];
        
        const allTags = new Set();
        modal._currentFaqs.forEach(faq => {
            if (faq.tags && Array.isArray(faq.tags)) {
                faq.tags.forEach(tag => {
                    const trimmedTag = tag ? tag.trim() : '';
                    if (trimmedTag) {
                        allTags.add(trimmedTag);
                    }
                });
            }
        });
        
        return Array.from(allTags).sort();
    }

    // æ›´æ–°å¸¸è§é—®é¢˜æ ‡ç­¾è¿‡æ»¤å™¨UI
    updateFaqTagFilterUI() {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal) return;
        
        const tagFilterList = modal._tagFilterList;
        if (!tagFilterList) return;
        
        // æ¸…ç©ºç°æœ‰æ ‡ç­¾
        tagFilterList.innerHTML = '';
        
        // è·å–æ‰€æœ‰æ ‡ç­¾
        const allTags = this.getAllFaqTags();
        
        if (allTags.length === 0) {
            return;
        }
        
        // åˆå§‹åŒ–è¿‡æ»¤çŠ¶æ€
        if (!this.faqSelectedFilterTags) {
            this.faqSelectedFilterTags = [];
        }
        
        // è®¡ç®—æ¯ä¸ªæ ‡ç­¾å¯¹åº”çš„FAQæ•°é‡ï¼ˆä»å½“å‰å¼¹æ¡†ä¸­çš„å¸¸è§é—®é¢˜åˆ—è¡¨è·å–ï¼‰
        const tagCounts = {};
        if (modal._currentFaqs && Array.isArray(modal._currentFaqs)) {
            modal._currentFaqs.forEach(faq => {
                if (faq.tags && Array.isArray(faq.tags)) {
                    faq.tags.forEach(t => {
                        if (t && t.trim()) {
                            const normalizedTag = t.trim();
                            tagCounts[normalizedTag] = (tagCounts[normalizedTag] || 0) + 1;
                        }
                    });
                }
            });
        }
        
        // åˆ›å»ºæ ‡ç­¾æŒ‰é’®
        allTags.forEach(tag => {
            const tagBtn = document.createElement('button');
            tagBtn.className = 'faq-tag-filter-item';
            const count = tagCounts[tag] || 0;
            tagBtn.textContent = `${tag} (${count})`;
            const isSelected = this.faqSelectedFilterTags && this.faqSelectedFilterTags.includes(tag);
            
            tagBtn.style.cssText = `
                padding: 3px 8px !important;
                border-radius: 10px !important;
                border: 1px solid ${isSelected ? '#4CAF50' : '#e5e7eb'} !important;
                background: ${isSelected ? '#4CAF50' : '#f9fafb'} !important;
                color: ${isSelected ? 'white' : '#6b7280'} !important;
                font-size: 10px !important;
                font-weight: ${isSelected ? '500' : '400'} !important;
                cursor: pointer !important;
                transition: all 0.15s ease !important;
                white-space: nowrap !important;
                line-height: 1.4 !important;
            `;
            
            tagBtn.addEventListener('mouseenter', () => {
                if (!isSelected) {
                    tagBtn.style.borderColor = '#4CAF50';
                    tagBtn.style.background = '#f0fdf4';
                    tagBtn.style.color = '#4CAF50';
                } else {
                    tagBtn.style.opacity = '0.9';
                }
            });
            tagBtn.addEventListener('mouseleave', () => {
                if (!isSelected) {
                    tagBtn.style.borderColor = '#e5e7eb';
                    tagBtn.style.background = '#f9fafb';
                    tagBtn.style.color = '#6b7280';
                } else {
                    tagBtn.style.opacity = '1';
                }
            });
            tagBtn.addEventListener('click', () => {
                if (!this.faqSelectedFilterTags) {
                    this.faqSelectedFilterTags = [];
                }
                
                const index = this.faqSelectedFilterTags.indexOf(tag);
                if (index > -1) {
                    // å–æ¶ˆé€‰ä¸­
                    this.faqSelectedFilterTags.splice(index, 1);
                } else {
                    // é€‰ä¸­
                    this.faqSelectedFilterTags.push(tag);
                }
                
                // æ›´æ–°æ‰€æœ‰æ ‡ç­¾æŒ‰é’®ï¼ˆç¡®ä¿çŠ¶æ€ä¸€è‡´ï¼‰
                this.updateFaqTagFilterUI();
                // æ›´æ–°å¸¸è§é—®é¢˜åˆ—è¡¨ï¼ˆåº”ç”¨è¿‡æ»¤ï¼‰
                this.loadFaqsIntoManager();
            });
            
            tagFilterList.appendChild(tagBtn);
        });
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (modal._updateTagFilterButtons) {
            modal._updateTagFilterButtons();
        }
    }

    // åŠ è½½å¸¸è§é—®é¢˜åˆ°ç®¡ç†å™¨
    async loadFaqsIntoManager() {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal) return;

        const faqsContainer = modal.querySelector('.faq-manager-faqs');
        if (!faqsContainer) return;

        // ä»APIåŠ è½½å¸¸è§é—®é¢˜
        let faqs = [];
        try {
            if (this.faqApi && this.faqApi.isEnabled()) {
                faqs = await this.faqApi.getFaqs();
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä»æœ¬åœ°å­˜å‚¨åŠ è½½
                const result = await chrome.storage.local.get(['petFaqs']);
                faqs = result.petFaqs || [];
            }
        } catch (error) {
            console.error('åŠ è½½å¸¸è§é—®é¢˜å¤±è´¥:', error);
            // å¦‚æœAPIå¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä½œä¸ºé™çº§æ–¹æ¡ˆ
            try {
                const result = await chrome.storage.local.get(['petFaqs']);
                faqs = result.petFaqs || [];
            } catch (localError) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¸¸è§é—®é¢˜ä¹Ÿå¤±è´¥:', localError);
                faqs = [];
            }
        }

        // ç¡®ä¿æ¯ä¸ªå¸¸è§é—®é¢˜éƒ½æœ‰tagså­—æ®µå’Œorderå­—æ®µ
        faqs = faqs.map((faq, index) => {
            if (!faq.tags || !Array.isArray(faq.tags)) {
                faq.tags = [];
            }
            // å¦‚æœæ²¡æœ‰orderå­—æ®µï¼Œä½¿ç”¨ç´¢å¼•ä½œä¸ºåˆå§‹orderå€¼
            if (faq.order === undefined || faq.order === null) {
                faq.order = index;
            }
            return faq;
        });

        // æŒ‰orderå­—æ®µæ’åºï¼ˆorderå€¼è¶Šå°è¶Šé å‰ï¼‰
        faqs.sort((a, b) => {
            const orderA = a.order !== undefined && a.order !== null ? a.order : 999999;
            const orderB = b.order !== undefined && b.order !== null ? b.order : 999999;
            return orderA - orderB;
        });

        // ä¿å­˜åˆ°modalçš„ä¸´æ—¶æ•°æ®ä¸­
        modal._currentFaqs = faqs.map(faq => ({ ...faq })); // ä½¿ç”¨å‰¯æœ¬ï¼Œé¿å…å¼•ç”¨é—®é¢˜

        // åº”ç”¨æœç´¢è¿‡æ»¤
        let filteredFaqs = [...modal._currentFaqs];
        if (this.faqSearchFilter && this.faqSearchFilter.trim() !== '') {
            const searchKeyword = this.faqSearchFilter.trim().toLowerCase();
            filteredFaqs = filteredFaqs.filter(faq => {
                const faqText = (faq.text || '').toLowerCase();
                const faqTags = (faq.tags || []).join(' ').toLowerCase();
                return faqText.includes(searchKeyword) || faqTags.includes(searchKeyword);
            });
        }

        // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰
        if (this.faqTagFilterNoTags) {
            filteredFaqs = filteredFaqs.filter(faq => {
                const faqTags = faq.tags || [];
                const hasTags = faqTags.length > 0 && faqTags.some(tag => tag && tag.trim().length > 0);
                return !hasTags; // åªæ˜¾ç¤ºæ²¡æœ‰æ ‡ç­¾çš„é—®é¢˜
            });
        }

        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤
        if (this.faqSelectedFilterTags && this.faqSelectedFilterTags.length > 0) {
            filteredFaqs = filteredFaqs.filter(faq => {
                const faqTags = (faq.tags || []).map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const normalizedSelectedTags = this.faqSelectedFilterTags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const hasSelectedTags = normalizedSelectedTags.some(selectedTag => 
                    faqTags.includes(selectedTag)
                );
                
                if (this.faqTagFilterReverse) {
                    // åå‘è¿‡æ»¤ï¼šæ’é™¤åŒ…å«é€‰ä¸­æ ‡ç­¾çš„é—®é¢˜
                    return !hasSelectedTags;
                } else {
                    // æ­£å‘è¿‡æ»¤ï¼šåªæ˜¾ç¤ºåŒ…å«é€‰ä¸­æ ‡ç­¾çš„é—®é¢˜
                    return hasSelectedTags;
                }
            });
        }

        faqsContainer.innerHTML = '';

        if (!filteredFaqs || filteredFaqs.length === 0) {
            const emptyMsg = document.createElement('div');
            if (modal._currentFaqs.length === 0) {
                emptyMsg.innerHTML = 'ğŸ’¡<br>æš‚æ— å¸¸è§é—®é¢˜<br><span style="font-size: 12px; color: #94a3b8;">ä½¿ç”¨ Ctrl+Enter æˆ– Shift+Enter æ·»åŠ </span>';
            } else {
                emptyMsg.innerHTML = 'ğŸ”<br>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¸¸è§é—®é¢˜<br><span style="font-size: 12px; color: #94a3b8;">å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–æ ‡ç­¾è¿‡æ»¤</span>';
            }
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #64748b !important;
                padding: 60px 20px !important;
                font-size: 14px !important;
                line-height: 1.8 !important;
            `;
            faqsContainer.appendChild(emptyMsg);
            return;
        }

        const mainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);

        // ä½¿ç”¨åŸå§‹ç´¢å¼•ï¼ˆç”¨äºç¼–è¾‘ã€åˆ é™¤å’Œæ’åºï¼‰
        filteredFaqs.forEach((faq, filteredIndex) => {
            // ä½¿ç”¨æ–‡æœ¬åŒ¹é…æ‰¾åˆ°åŸå§‹ç´¢å¼•
            let originalIndex = modal._currentFaqs.findIndex(f => {
                // ä¼˜å…ˆä½¿ç”¨keyåŒ¹é…ï¼Œå¦‚æœæ²¡æœ‰keyåˆ™ä½¿ç”¨textåŒ¹é…
                if (f.key && faq.key) {
                    return f.key === faq.key;
                }
                return f.text === faq.text;
            });
            
            // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…é¡¹ï¼Œè·³è¿‡è¯¥é¡¹
            if (originalIndex < 0) {
                console.warn('æ— æ³•æ‰¾åˆ°å¸¸è§é—®é¢˜çš„åŸå§‹ç´¢å¼•:', faq.text);
                return; // åœ¨forEachä¸­ä½¿ç”¨returnä¼šè·³è¿‡å½“å‰è¿­ä»£
            }
            
            const index = originalIndex;
            
            // å¸¸è§é—®é¢˜é¡¹å®¹å™¨ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„å¸ƒå±€ç»“æ„ï¼‰
            const faqItem = document.createElement('div');
            faqItem.className = 'faq-item';
            faqItem.style.cssText = `
                padding: 12px !important;
                margin-bottom: 8px !important;
                background: #ffffff !important;
                border: 1px solid #e5e7eb !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
                position: relative !important;
            `;
            
            // æ‚¬åœæ•ˆæœï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨ï¼‰
            faqItem.addEventListener('mouseenter', () => {
                faqItem.style.background = '#f9fafb !important';
                faqItem.style.borderColor = '#d1d5db !important';
                faqItem.style.transform = 'translateY(-1px)';
                faqItem.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1) !important';
            });
            faqItem.addEventListener('mouseleave', () => {
                faqItem.style.background = '#ffffff !important';
                faqItem.style.borderColor = '#e5e7eb !important';
                faqItem.style.transform = 'translateY(0)';
                faqItem.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05) !important';
            });

            // å¸¸è§é—®é¢˜ä¿¡æ¯å®¹å™¨ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„session-infoç»“æ„ï¼‰
            const faqInfo = document.createElement('div');
            faqInfo.className = 'faq-info';
            faqInfo.style.cssText = `
                margin-bottom: 8px !important;
            `;

            // åˆ›å»ºæ ‡é¢˜è¡Œå®¹å™¨ï¼ˆåªåŒ…å«æ ‡é¢˜ï¼Œä¸åŒ…å«æŒ‰é’®ï¼‰
            const titleRow = document.createElement('div');
            titleRow.style.cssText = `
                display: flex !important;
                align-items: center !important;
                width: 100% !important;
                margin-bottom: 6px !important;
            `;

            // æ ‡é¢˜
            const titleDiv = document.createElement('div');
            titleDiv.className = 'faq-title';
            titleDiv.textContent = faq.text;
            titleDiv.style.cssText = `
                font-size: 14px !important;
                font-weight: 600 !important;
                color: #111827 !important;
                line-height: 1.4 !important;
                flex: 1 !important;
                min-width: 0 !important;
            `;
            titleRow.appendChild(titleDiv);

            faqInfo.appendChild(titleRow);

            // æ ‡ç­¾åŒºåŸŸï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„æ ‡ç­¾æ ·å¼ï¼‰
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'faq-tags';
            tagsContainer.style.cssText = `
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 4px !important;
                margin-bottom: 8px !important;
            `;
            // å¦‚æœæœ‰æ ‡ç­¾ï¼Œæ˜¾ç¤ºæ ‡ç­¾
            const tags = faq.tags || [];
            if (tags.length > 0) {
                // è§„èŒƒåŒ–æ ‡ç­¾ï¼ˆtrimå¤„ç†ï¼‰
                const normalizedTags = tags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                
                normalizedTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'faq-tag-item';
                    tagElement.textContent = tag;
                    // æ ¹æ®æ ‡ç­¾å†…å®¹ç”Ÿæˆé¢œè‰²ï¼ˆä½¿ç”¨å“ˆå¸Œå‡½æ•°ç¡®ä¿ç›¸åŒæ ‡ç­¾é¢œè‰²ä¸€è‡´ï¼‰
                    const tagColor = this.getTagColor(tag);
                    tagElement.style.cssText = `
                        display: inline-block !important;
                        padding: 3px 10px !important;
                        background: ${tagColor.background} !important;
                        color: ${tagColor.text} !important;
                        border-radius: 12px !important;
                        font-size: 11px !important;
                        font-weight: 500 !important;
                        border: 1px solid ${tagColor.border} !important;
                        transition: all 0.2s ease !important;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
                    `;
                    // æ·»åŠ æ‚¬åœæ•ˆæœ
                    tagElement.addEventListener('mouseenter', () => {
                        tagElement.style.transform = 'translateY(-1px)';
                        tagElement.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                    });
                    tagElement.addEventListener('mouseleave', () => {
                        tagElement.style.transform = 'translateY(0)';
                        tagElement.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                    });
                    tagsContainer.appendChild(tagElement);
                });
            }
            faqInfo.appendChild(tagsContainer);

            // åº•éƒ¨ä¿¡æ¯ï¼ˆæ“ä½œæŒ‰é’®ï¼Œå³å¯¹é½ï¼‰
            const footer = document.createElement('div');
            footer.style.cssText = `
                display: flex !important;
                justify-content: flex-end !important;
                align-items: center !important;
                font-size: 11px !important;
                color: #9ca3af !important;
                margin-top: 8px !important;
            `;

            // æ“ä½œæŒ‰é’®å®¹å™¨ï¼ˆå³å¯¹é½ï¼‰
            const footerButtonContainer = document.createElement('div');
            footerButtonContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 6px !important;
                opacity: 0.7 !important;
                transition: opacity 0.2s ease !important;
            `;

            // ä¸Šç§»æŒ‰é’®
            const moveUpBtn = document.createElement('button');
            moveUpBtn.className = 'faq-move-up-btn';
            moveUpBtn.innerHTML = 'â†‘';
            moveUpBtn.title = 'ä¸Šç§»';
            moveUpBtn.style.cssText = `
                background: rgba(100, 116, 139, 0.1) !important;
                border: 1px solid rgba(100, 116, 139, 0.2) !important;
                cursor: pointer !important;
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 4px !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                color: #64748b !important;
                min-width: 28px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªï¼Œç¦ç”¨ä¸Šç§»æŒ‰é’®
            const isFirst = index === 0;
            if (isFirst) {
                moveUpBtn.disabled = true;
                moveUpBtn.style.opacity = '0.4';
                moveUpBtn.style.cursor = 'not-allowed';
            }
            moveUpBtn.addEventListener('mouseenter', () => {
                if (!moveUpBtn.disabled) {
                    moveUpBtn.style.background = 'rgba(100, 116, 139, 0.2)';
                    moveUpBtn.style.borderColor = 'rgba(100, 116, 139, 0.4)';
                }
            });
            moveUpBtn.addEventListener('mouseleave', () => {
                if (!moveUpBtn.disabled) {
                    moveUpBtn.style.background = 'rgba(100, 116, 139, 0.1)';
                    moveUpBtn.style.borderColor = 'rgba(100, 116, 139, 0.2)';
                }
            });
            moveUpBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!moveUpBtn.disabled) {
                    console.log('ä¸Šç§»å¸¸è§é—®é¢˜ï¼Œç´¢å¼•:', index, 'é—®é¢˜:', faq.text);
                    await this.moveFaqUp(index);
                }
            });

            // ä¸‹ç§»æŒ‰é’®
            const moveDownBtn = document.createElement('button');
            moveDownBtn.className = 'faq-move-down-btn';
            moveDownBtn.innerHTML = 'â†“';
            moveDownBtn.title = 'ä¸‹ç§»';
            moveDownBtn.style.cssText = `
                background: rgba(100, 116, 139, 0.1) !important;
                border: 1px solid rgba(100, 116, 139, 0.2) !important;
                cursor: pointer !important;
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 4px !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                color: #64748b !important;
                min-width: 28px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            // å¦‚æœæ˜¯æœ€åä¸€ä¸ªï¼Œç¦ç”¨ä¸‹ç§»æŒ‰é’®
            const isLast = index === modal._currentFaqs.length - 1;
            if (isLast) {
                moveDownBtn.disabled = true;
                moveDownBtn.style.opacity = '0.4';
                moveDownBtn.style.cursor = 'not-allowed';
            }
            moveDownBtn.addEventListener('mouseenter', () => {
                if (!moveDownBtn.disabled) {
                    moveDownBtn.style.background = 'rgba(100, 116, 139, 0.2)';
                    moveDownBtn.style.borderColor = 'rgba(100, 116, 139, 0.4)';
                }
            });
            moveDownBtn.addEventListener('mouseleave', () => {
                if (!moveDownBtn.disabled) {
                    moveDownBtn.style.background = 'rgba(100, 116, 139, 0.1)';
                    moveDownBtn.style.borderColor = 'rgba(100, 116, 139, 0.2)';
                }
            });
            moveDownBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!moveDownBtn.disabled) {
                    console.log('ä¸‹ç§»å¸¸è§é—®é¢˜ï¼Œç´¢å¼•:', index, 'é—®é¢˜:', faq.text);
                    await this.moveFaqDown(index);
                }
            });

            // ä½¿ç”¨æŒ‰é’®ï¼ˆç‚¹å‡»è¿½åŠ åˆ°è¾“å…¥æ¡†ï¼‰
            const useBtn = document.createElement('button');
            useBtn.textContent = 'ä½¿ç”¨';
            useBtn.title = 'è¿½åŠ åˆ°è¾“å…¥æ¡†';
            useBtn.style.cssText = `
                padding: 4px 12px !important;
                border-radius: 4px !important;
                background: ${mainColor} !important;
                color: white !important;
                border: none !important;
                cursor: pointer !important;
                font-size: 11px !important;
                font-weight: 500 !important;
                transition: all 0.2s ease !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            useBtn.addEventListener('mouseenter', () => {
                useBtn.style.opacity = '0.9';
                useBtn.style.transform = 'translateY(-1px)';
            });
            useBtn.addEventListener('mouseleave', () => {
                useBtn.style.opacity = '1';
                useBtn.style.transform = 'translateY(0)';
            });
            useBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.useFaq(faq.text);
            });

            // æ ‡ç­¾ç®¡ç†æŒ‰é’®
            const tagManageBtn = document.createElement('button');
            tagManageBtn.className = 'faq-tag-btn';
            tagManageBtn.innerHTML = 'ğŸ·ï¸';
            tagManageBtn.title = 'ç®¡ç†æ ‡ç­¾';
            tagManageBtn.style.cssText = `
                background: rgba(100, 116, 139, 0.1) !important;
                border: 1px solid rgba(100, 116, 139, 0.2) !important;
                cursor: pointer !important;
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 4px !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                min-width: 28px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            tagManageBtn.addEventListener('mouseenter', () => {
                tagManageBtn.style.background = 'rgba(100, 116, 139, 0.2)';
                tagManageBtn.style.borderColor = 'rgba(100, 116, 139, 0.4)';
            });
            tagManageBtn.addEventListener('mouseleave', () => {
                tagManageBtn.style.background = 'rgba(100, 116, 139, 0.1)';
                tagManageBtn.style.borderColor = 'rgba(100, 116, 139, 0.2)';
            });
            tagManageBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.openFaqTagManager(index);
            });

            // å¤åˆ¶æŒ‰é’®
            const copyBtn = document.createElement('button');
            copyBtn.className = 'faq-copy-btn';
            copyBtn.innerHTML = 'ğŸ“‹';
            copyBtn.title = 'å¤åˆ¶';
            copyBtn.style.cssText = `
                background: rgba(100, 116, 139, 0.1) !important;
                border: 1px solid rgba(100, 116, 139, 0.2) !important;
                cursor: pointer !important;
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 4px !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                min-width: 28px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            copyBtn.addEventListener('mouseenter', () => {
                copyBtn.style.background = 'rgba(100, 116, 139, 0.2)';
                copyBtn.style.borderColor = 'rgba(100, 116, 139, 0.4)';
            });
            copyBtn.addEventListener('mouseleave', () => {
                copyBtn.style.background = 'rgba(100, 116, 139, 0.1)';
                copyBtn.style.borderColor = 'rgba(100, 116, 139, 0.2)';
            });
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.copyFaq(faq.text, copyBtn);
            });

            // ç¼–è¾‘æŒ‰é’®
            const editBtn = document.createElement('button');
            editBtn.className = 'faq-edit-btn';
            editBtn.innerHTML = 'âœï¸';
            editBtn.title = 'ç¼–è¾‘';
            editBtn.style.cssText = `
                background: rgba(100, 116, 139, 0.1) !important;
                border: 1px solid rgba(100, 116, 139, 0.2) !important;
                cursor: pointer !important;
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 4px !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                min-width: 28px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            editBtn.addEventListener('mouseenter', () => {
                editBtn.style.background = 'rgba(100, 116, 139, 0.2)';
                editBtn.style.borderColor = 'rgba(100, 116, 139, 0.4)';
            });
            editBtn.addEventListener('mouseleave', () => {
                editBtn.style.background = 'rgba(100, 116, 139, 0.1)';
                editBtn.style.borderColor = 'rgba(100, 116, 139, 0.2)';
            });
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.editFaq(index);
            });

            // åˆ é™¤æŒ‰é’®
            const removeBtn = document.createElement('button');
            removeBtn.className = 'faq-delete-btn';
            removeBtn.innerHTML = 'âœ•';
            removeBtn.title = 'åˆ é™¤';
            removeBtn.style.cssText = `
                background: rgba(220, 38, 38, 0.1) !important;
                border: 1px solid rgba(220, 38, 38, 0.2) !important;
                cursor: pointer !important;
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 4px !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                color: #dc2626 !important;
                min-width: 28px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            removeBtn.addEventListener('mouseenter', () => {
                removeBtn.style.background = 'rgba(220, 38, 38, 0.2)';
                removeBtn.style.borderColor = 'rgba(220, 38, 38, 0.4)';
            });
            removeBtn.addEventListener('mouseleave', () => {
                removeBtn.style.background = 'rgba(220, 38, 38, 0.1)';
                removeBtn.style.borderColor = 'rgba(220, 38, 38, 0.2)';
            });
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.removeFaq(index);
            });

            footerButtonContainer.appendChild(moveUpBtn);
            footerButtonContainer.appendChild(moveDownBtn);
            footerButtonContainer.appendChild(useBtn);
            footerButtonContainer.appendChild(tagManageBtn);
            footerButtonContainer.appendChild(copyBtn);
            footerButtonContainer.appendChild(editBtn);
            footerButtonContainer.appendChild(removeBtn);

            footer.appendChild(footerButtonContainer);

            // æ‚¬åœæ—¶æ˜¾ç¤ºæŒ‰é’®
            faqItem.addEventListener('mouseenter', () => {
                footerButtonContainer.style.opacity = '1';
            });
            faqItem.addEventListener('mouseleave', () => {
                footerButtonContainer.style.opacity = '0.7';
            });

            faqInfo.appendChild(footer);

            faqItem.appendChild(faqInfo);

            faqsContainer.appendChild(faqItem);
        });
    }

    // ä»è¾“å…¥æ¡†æ·»åŠ å¸¸è§é—®é¢˜
    async addFaqFromInput() {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal) return;

        const faqInput = modal.querySelector('.faq-manager-input');
        if (!faqInput) return;

        const text = faqInput.value.trim();
        if (!text) {
            this.showNotification('è¯·è¾“å…¥é—®é¢˜å†…å®¹', 'warning');
            return;
        }

        // è·å–å½“å‰å¸¸è§é—®é¢˜åˆ—è¡¨
        if (!modal._currentFaqs) {
            modal._currentFaqs = [];
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå†…å®¹
        const exists = modal._currentFaqs.some(faq => faq.text === text);
        if (exists) {
            this.showNotification('è¯¥é—®é¢˜å·²å­˜åœ¨', 'warning');
            return;
        }

        try {
            // è®¡ç®—æ–°é¡¹çš„orderå€¼ï¼ˆä½¿ç”¨å½“å‰åˆ—è¡¨çš„æœ€å¤§orderå€¼+1ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åˆ—è¡¨é•¿åº¦ï¼‰
            let maxOrder = -1;
            if (modal._currentFaqs && modal._currentFaqs.length > 0) {
                modal._currentFaqs.forEach(faq => {
                    const order = faq.order !== undefined && faq.order !== null ? faq.order : -1;
                    if (order > maxOrder) {
                        maxOrder = order;
                    }
                });
            }
            const newOrder = maxOrder + 1;
            
            // ä½¿ç”¨APIåˆ›å»ºå¸¸è§é—®é¢˜
            if (this.faqApi && this.faqApi.isEnabled()) {
                const newFaq = await this.faqApi.createFaq({ text, tags: [], order: newOrder });
                // å¦‚æœAPIè¿”å›çš„FAQæ²¡æœ‰orderå­—æ®µï¼Œæ‰‹åŠ¨è®¾ç½®
                if (newFaq && (newFaq.order === undefined || newFaq.order === null)) {
                    newFaq.order = newOrder;
                }
                // æ¸…é™¤GETè¯·æ±‚ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡åŠ è½½è·å–æœ€æ–°æ•°æ®
                if (this.faqApi.clearGetCache) {
                    this.faqApi.clearGetCache();
                }
                // ç«‹å³å°†æ–°æ·»åŠ çš„å¸¸è§é—®é¢˜æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼ˆä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼‰
                if (newFaq && !modal._currentFaqs.some(faq => faq.text === newFaq.text)) {
                    modal._currentFaqs.push(newFaq);
                }
                // é‡æ–°åŠ è½½æ˜¾ç¤ºï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                await this.loadFaqsIntoManager();
                // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
                this.updateFaqTagFilterUI();
                this.showNotification('å¸¸è§é—®é¢˜å·²æ·»åŠ ', 'success');
            } else {
                // é™çº§æ–¹æ¡ˆï¼šæ·»åŠ åˆ°åˆ—è¡¨å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const newFaq = { text, tags: [], order: newOrder };
                modal._currentFaqs.push(newFaq);
                await this.saveFaqs(modal._currentFaqs);
                // é‡æ–°åŠ è½½æ˜¾ç¤º
                await this.loadFaqsIntoManager();
                // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
                this.updateFaqTagFilterUI();
                this.showNotification('å¸¸è§é—®é¢˜å·²æ·»åŠ ', 'success');
            }
        } catch (error) {
            console.error('æ·»åŠ å¸¸è§é—®é¢˜å¤±è´¥:', error);
            this.showNotification('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            return;
        }
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        faqInput.value = '';
        faqInput.focus();
    }

    // æ‰“å¼€å¸¸è§é—®é¢˜æ ‡ç­¾ç®¡ç†å™¨ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„æ ‡ç­¾ç®¡ç†åŠŸèƒ½ï¼‰
    openFaqTagManager(faqIndex) {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal || !modal._currentFaqs) return;

        const faq = modal._currentFaqs[faqIndex];
        if (!faq) return;

        const currentTags = faq.tags || [];

        // åˆ›å»ºæ ‡ç­¾ç®¡ç†å¼¹çª—
        this.ensureFaqTagManagerUi();
        const tagModal = this.chatWindow?.querySelector('#pet-faq-tag-manager');
        if (!tagModal) {
            console.error('å¸¸è§é—®é¢˜æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }

        // æ˜¾ç¤ºå¼¹çª—
        tagModal.style.display = 'flex';
        tagModal.dataset.faqIndex = faqIndex;

        // éšè—æŠ˜å æŒ‰é’®ï¼ˆé¿å…åœ¨å¼¹æ¡†ä¸­æ˜¾ç¤ºä¸¤ä¸ªæŠ˜å æŒ‰é’®ï¼‰
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';

        // åŠ è½½å½“å‰æ ‡ç­¾
        this.loadFaqTagsIntoManager(faqIndex, currentTags);

        // æ·»åŠ å…³é—­äº‹ä»¶
        const closeBtn = tagModal.querySelector('.faq-tag-manager-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeFaqTagManager();
        }

        // æ·»åŠ ä¿å­˜äº‹ä»¶
        const saveBtn = tagModal.querySelector('.faq-tag-manager-save');
        if (saveBtn) {
            saveBtn.onclick = () => this.saveFaqTags(faqIndex);
        }

        // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶ï¼ˆå…¼å®¹ä¸­æ–‡è¾“å…¥æ³•ï¼‰
        const tagInput = tagModal.querySelector('.faq-tag-manager-input');
        if (tagInput) {
            // ç¡®ä¿è¾“å…¥æ³•ç»„åˆçŠ¶æ€å·²åˆå§‹åŒ–ï¼ˆå¦‚æœè¾“å…¥æ¡†æ˜¯æ–°åˆ›å»ºçš„ï¼‰
            if (tagInput._isComposing === undefined) {
                tagInput._isComposing = false;
                tagInput.addEventListener('compositionstart', () => {
                    tagInput._isComposing = true;
                });
                tagInput.addEventListener('compositionend', () => {
                    tagInput._isComposing = false;
                });
            }
            
            // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†ï¼ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®šï¼‰
            const existingHandler = tagInput._enterKeyHandler;
            if (existingHandler) {
                tagInput.removeEventListener('keydown', existingHandler);
            }
            
            const enterKeyHandler = (e) => {
                // å¦‚æœåœ¨è¾“å…¥æ³•ç»„åˆè¿‡ç¨‹ä¸­ï¼Œå¿½ç•¥å›è½¦é”®
                if (tagInput._isComposing) {
                    return;
                }
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addFaqTagFromInput(faqIndex);
                }
            };
            
            tagInput._enterKeyHandler = enterKeyHandler;
            tagInput.addEventListener('keydown', enterKeyHandler);
            
            tagInput.focus();
        }

        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeFaqTagManager();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        tagModal._escHandler = escHandler;
    }

    // ç¡®ä¿å¸¸è§é—®é¢˜æ ‡ç­¾ç®¡ç†å™¨UIå­˜åœ¨ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„æ ‡ç­¾ç®¡ç†åŠŸèƒ½ï¼‰
    ensureFaqTagManagerUi() {
        if (!this.chatWindow) return;
        if (this.chatWindow.querySelector('#pet-faq-tag-manager')) return;

        const modal = document.createElement('div');
        modal.id = 'pet-faq-tag-manager';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: ${PET_CONFIG.ui.zIndex.modal + 1} !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeFaqTagManager();
            }
        });

        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 24px !important;
            width: 90% !important;
            max-width: 800px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        `;

        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ç®¡ç†æ ‡ç­¾';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'faq-tag-manager-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });

        header.appendChild(title);
        header.appendChild(closeBtn);

        // è¾“å…¥åŒºåŸŸ
        const inputGroup = document.createElement('div');
        inputGroup.className = 'faq-tag-manager-input-group';
        inputGroup.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
        `;

        const tagInput = document.createElement('input');
        tagInput.className = 'faq-tag-manager-input';
        tagInput.type = 'text';
        tagInput.placeholder = 'è¾“å…¥æ ‡ç­¾åç§°ï¼ŒæŒ‰å›è½¦æ·»åŠ ';
        tagInput.style.cssText = `
            flex: 1 !important;
            padding: 10px 12px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
        `;
        
        // è¾“å…¥æ³•ç»„åˆçŠ¶æ€è·Ÿè¸ªï¼ˆç”¨äºå¤„ç†ä¸­æ–‡è¾“å…¥ï¼‰
        tagInput._isComposing = false;
        tagInput.addEventListener('compositionstart', () => {
            tagInput._isComposing = true;
        });
        tagInput.addEventListener('compositionend', () => {
            tagInput._isComposing = false;
        });
        
        tagInput.addEventListener('focus', () => {
            tagInput.style.borderColor = '#4CAF50';
        });
        tagInput.addEventListener('blur', () => {
            tagInput.style.borderColor = '#e0e0e0';
        });

        const addBtn = document.createElement('button');
        addBtn.textContent = 'æ·»åŠ ';
        addBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.background = '#45a049';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.background = '#4CAF50';
        });
        addBtn.addEventListener('click', () => {
            const faqIndex = modal.dataset.faqIndex;
            if (faqIndex !== undefined) {
                this.addFaqTagFromInput(parseInt(faqIndex));
            }
        });

        // æ™ºèƒ½ç”Ÿæˆæ ‡ç­¾æŒ‰é’®
        const smartGenerateBtn = document.createElement('button');
        smartGenerateBtn.className = 'faq-tag-manager-smart-generate';
        smartGenerateBtn.textContent = 'âœ¨ æ™ºèƒ½ç”Ÿæˆ';
        smartGenerateBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #9C27B0 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        smartGenerateBtn.addEventListener('mouseenter', () => {
            if (!smartGenerateBtn.disabled) {
                smartGenerateBtn.style.background = '#7B1FA2';
            }
        });
        smartGenerateBtn.addEventListener('mouseleave', () => {
            if (!smartGenerateBtn.disabled) {
                smartGenerateBtn.style.background = '#9C27B0';
            }
        });
        smartGenerateBtn.addEventListener('click', () => {
            const faqIndex = modal.dataset.faqIndex;
            if (faqIndex !== undefined) {
                this.generateFaqSmartTags(parseInt(faqIndex), smartGenerateBtn);
            }
        });

        inputGroup.appendChild(tagInput);
        inputGroup.appendChild(addBtn);
        inputGroup.appendChild(smartGenerateBtn);

        // å¿«æ·æ ‡ç­¾æŒ‰é’®å®¹å™¨
        const quickTagsContainer = document.createElement('div');
        quickTagsContainer.className = 'faq-tag-manager-quick-tags';
        quickTagsContainer.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
        `;

        // å¿«æ·æ ‡ç­¾åˆ—è¡¨
        const quickTags = ['å·¥å…·', 'å¼€æºé¡¹ç›®', 'å®¶åº­', 'å·¥ä½œ', 'å¨±ä¹', 'æ–‡æ¡£', 'ç½‘æ–‡', 'æ—¥è®°'];
        
        quickTags.forEach(tagName => {
            const quickTagBtn = document.createElement('button');
            quickTagBtn.textContent = tagName;
            quickTagBtn.className = 'faq-tag-manager-quick-tag-btn';
            quickTagBtn.dataset.tagName = tagName;
            quickTagBtn.style.cssText = `
                padding: 6px 12px !important;
                background: #f0f0f0 !important;
                color: #333 !important;
                border: 1px solid #d0d0d0 !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 13px !important;
                transition: all 0.2s ease !important;
            `;
            quickTagBtn.addEventListener('mouseenter', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ”¹å˜æ ·å¼
                if (quickTagBtn.style.background === 'rgb(76, 175, 80)') {
                    return;
                }
                quickTagBtn.style.background = '#e0e0e0';
                quickTagBtn.style.borderColor = '#4CAF50';
            });
            quickTagBtn.addEventListener('mouseleave', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ”¹å˜æ ·å¼
                if (quickTagBtn.style.background === 'rgb(76, 175, 80)') {
                    return;
                }
                quickTagBtn.style.background = '#f0f0f0';
                quickTagBtn.style.borderColor = '#d0d0d0';
            });
            quickTagBtn.addEventListener('click', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ‰§è¡Œæ“ä½œ
                if (quickTagBtn.style.cursor === 'not-allowed') {
                    return;
                }
                const faqIndex = modal.dataset.faqIndex;
                if (faqIndex !== undefined) {
                    this.addFaqQuickTag(parseInt(faqIndex), tagName);
                }
            });
            quickTagsContainer.appendChild(quickTagBtn);
        });

        // æ ‡ç­¾åˆ—è¡¨
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'faq-tag-manager-tags';
        tagsContainer.style.cssText = `
            min-height: 100px !important;
            max-height: 300px !important;
            overflow-y: auto !important;
            margin-bottom: 20px !important;
            padding: 12px !important;
            background: #f8f9fa !important;
            border-radius: 6px !important;
        `;

        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 10px !important;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #f0f0f0 !important;
            color: #333 !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: background 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#e0e0e0';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = '#f0f0f0';
        });
        cancelBtn.addEventListener('click', () => this.closeFaqTagManager());

        const saveBtn = document.createElement('button');
        saveBtn.className = 'faq-tag-manager-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#1976D2';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#2196F3';
        });

        footer.appendChild(cancelBtn);
        footer.appendChild(saveBtn);

        panel.appendChild(header);
        panel.appendChild(inputGroup);
        panel.appendChild(quickTagsContainer);
        panel.appendChild(tagsContainer);
        panel.appendChild(footer);
        modal.appendChild(panel);
        this.chatWindow.appendChild(modal);
    }

    // åŠ è½½å¸¸è§é—®é¢˜æ ‡ç­¾åˆ°ç®¡ç†å™¨ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„æ ‡ç­¾æ˜¾ç¤ºæ ·å¼ï¼‰
    loadFaqTagsIntoManager(faqIndex, tags) {
        const tagModal = this.chatWindow?.querySelector('#pet-faq-tag-manager');
        if (!tagModal) return;

        const tagsContainer = tagModal.querySelector('.faq-tag-manager-tags');
        if (!tagsContainer) return;

        tagsContainer.innerHTML = '';

        // ä¿å­˜å½“å‰æ ‡ç­¾åˆ°modal
        tagModal._currentTags = tags ? [...tags] : [];

        if (!tags || tags.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #999 !important;
                padding: 20px !important;
                font-size: 14px !important;
            `;
            tagsContainer.appendChild(emptyMsg);
            return;
        }

        tags.forEach((tag, index) => {
            if (!tag || !tag.trim()) return;

            const tagItem = document.createElement('div');
            tagItem.style.cssText = `
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                background: #4CAF50 !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 20px !important;
                margin: 4px !important;
                font-size: 13px !important;
            `;

            const tagText = document.createElement('span');
            tagText.textContent = tag.trim();

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = 'âœ•';
            removeBtn.style.cssText = `
                background: rgba(255, 255, 255, 0.3) !important;
                border: none !important;
                color: white !important;
                width: 18px !important;
                height: 18px !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                font-size: 12px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 0 !important;
                transition: background 0.2s ease !important;
            `;
            removeBtn.addEventListener('mouseenter', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.5)';
            });
            removeBtn.addEventListener('mouseleave', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            });
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const faqIndex = tagModal.dataset.faqIndex;
                if (faqIndex !== undefined) {
                    this.removeFaqTag(parseInt(faqIndex), index);
                }
            });

            tagItem.appendChild(tagText);
            tagItem.appendChild(removeBtn);
            tagsContainer.appendChild(tagItem);
        });

        // æ›´æ–°å¿«æ·æ ‡ç­¾æŒ‰é’®çŠ¶æ€
        const quickTagButtons = tagModal.querySelectorAll('.faq-tag-manager-quick-tag-btn');
        quickTagButtons.forEach(btn => {
            const tagName = btn.dataset.tagName;
            const isAdded = tags && tags.includes(tagName);
            if (isAdded) {
                btn.style.background = '#4CAF50';
                btn.style.color = 'white';
                btn.style.borderColor = '#4CAF50';
                btn.style.opacity = '0.7';
                btn.style.cursor = 'not-allowed';
            } else {
                btn.style.background = '#f0f0f0';
                btn.style.color = '#333';
                btn.style.borderColor = '#d0d0d0';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    }

    // ä»è¾“å…¥æ¡†æ·»åŠ å¸¸è§é—®é¢˜æ ‡ç­¾
    addFaqTagFromInput(faqIndex) {
        const tagModal = this.chatWindow?.querySelector('#pet-faq-tag-manager');
        if (!tagModal) return;

        const tagInput = tagModal.querySelector('.faq-tag-manager-input');
        if (!tagInput) return;

        const tagName = tagInput.value.trim();
        if (!tagName) return;

        if (!tagModal._currentTags) {
            tagModal._currentTags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (tagModal._currentTags.includes(tagName)) {
            tagInput.value = '';
            tagInput.focus();
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        tagModal._currentTags.push(tagName);
        tagInput.value = '';
        tagInput.focus();

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadFaqTagsIntoManager(faqIndex, tagModal._currentTags);
    }

    // æ·»åŠ å¿«æ·æ ‡ç­¾
    addFaqQuickTag(faqIndex, tagName) {
        const tagModal = this.chatWindow?.querySelector('#pet-faq-tag-manager');
        if (!tagModal) return;

        if (!tagModal._currentTags) {
            tagModal._currentTags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (tagModal._currentTags.includes(tagName)) {
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        tagModal._currentTags.push(tagName);

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadFaqTagsIntoManager(faqIndex, tagModal._currentTags);
    }

    // åˆ é™¤æ ‡ç­¾
    removeFaqTag(faqIndex, index) {
        const tagModal = this.chatWindow?.querySelector('#pet-faq-tag-manager');
        if (!tagModal || !tagModal._currentTags) return;

        tagModal._currentTags.splice(index, 1);
        this.loadFaqTagsIntoManager(faqIndex, tagModal._currentTags);
    }

    // ä¿å­˜å¸¸è§é—®é¢˜æ ‡ç­¾
    async saveFaqTags(faqIndex) {
        const tagModal = this.chatWindow?.querySelector('#pet-faq-tag-manager');
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!tagModal || !modal || !modal._currentFaqs) return;

        const faq = modal._currentFaqs[faqIndex];
        if (!faq) return;

        // æ›´æ–°æ ‡ç­¾ï¼ˆè¿‡æ»¤ç©ºæ ‡ç­¾å¹¶å»é™¤é¦–å°¾ç©ºæ ¼ï¼‰
        const newTags = (tagModal._currentTags || [])
            .map(tag => tag ? tag.trim() : '')
            .filter(tag => tag.length > 0);
        // å»é‡
        faq.tags = [...new Set(newTags)];

        try {
            // ä½¿ç”¨APIä¿å­˜å¸¸è§é—®é¢˜æ ‡ç­¾
            if (this.faqApi && this.faqApi.isEnabled()) {
                // ä½¿ç”¨åˆ—è¡¨å¯¹åº”çš„keyæ¥æ›´æ–°ï¼Œkeyä¼šåœ¨payloadä¸­ä¼ é€’
                await this.faqApi.updateFaq(faq.key || faq.text, {
                    text: faq.text,
                    tags: faq.tags
                });
                
                // æ¸…é™¤GETè¯·æ±‚ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡åŠ è½½è·å–æœ€æ–°æ•°æ®
                if (this.faqApi.clearGetCache) {
                    this.faqApi.clearGetCache();
                }
                // ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®ï¼ˆä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼‰
                const targetFaq = modal._currentFaqs.find(f => f.text === faq.text);
                if (targetFaq) {
                    targetFaq.tags = faq.tags;
                }
                // é‡æ–°åŠ è½½æ˜¾ç¤ºï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                await this.loadFaqsIntoManager();
                // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
                this.updateFaqTagFilterUI();
                // å…³é—­æ ‡ç­¾ç®¡ç†å™¨
                this.closeFaqTagManager();
                this.showNotification('æ ‡ç­¾å·²ä¿å­˜', 'success');
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                await this.saveFaqs(modal._currentFaqs);
                // é‡æ–°åŠ è½½æ˜¾ç¤º
                await this.loadFaqsIntoManager();
                // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
                this.updateFaqTagFilterUI();
                // å…³é—­æ ‡ç­¾ç®¡ç†å™¨
                this.closeFaqTagManager();
                this.showNotification('æ ‡ç­¾å·²ä¿å­˜', 'success');
            }
        } catch (error) {
            console.error('ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
            this.showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    // æ™ºèƒ½ç”Ÿæˆå¸¸è§é—®é¢˜æ ‡ç­¾ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„æ™ºèƒ½ç”ŸæˆåŠŸèƒ½ï¼‰
    async generateFaqSmartTags(faqIndex, buttonElement) {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal || !modal._currentFaqs) {
            console.warn('å¸¸è§é—®é¢˜ç®¡ç†å™¨æœªæ‰¾åˆ°ï¼Œæ— æ³•ç”Ÿæˆæ ‡ç­¾');
            return;
        }

        const faq = modal._currentFaqs[faqIndex];
        if (!faq) {
            console.warn('å¸¸è§é—®é¢˜ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæ ‡ç­¾:', faqIndex);
            return;
        }

        const tagModal = this.chatWindow?.querySelector('#pet-faq-tag-manager');
        
        if (!tagModal) {
            console.error('å¸¸è§é—®é¢˜æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }

        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.style.background = '#ccc';
            buttonElement.style.cursor = 'not-allowed';
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // æ„å»ºç³»ç»Ÿæç¤ºè¯
                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ ‡ç­¾ç”ŸæˆåŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·æä¾›çš„å¸¸è§é—®é¢˜å†…å®¹ï¼Œç”Ÿæˆåˆé€‚çš„æ ‡ç­¾ã€‚

æ ‡ç­¾è¦æ±‚ï¼š
1. æ ‡ç­¾åº”è¯¥ç®€æ´æ˜äº†ï¼Œæ¯ä¸ªæ ‡ç­¾2-6ä¸ªæ±‰å­—æˆ–3-12ä¸ªè‹±æ–‡å­—ç¬¦
2. æ ‡ç­¾åº”è¯¥å‡†ç¡®åæ˜ é—®é¢˜çš„æ ¸å¿ƒä¸»é¢˜
3. ç”Ÿæˆ3-8ä¸ªæ ‡ç­¾
4. æ ‡ç­¾ä¹‹é—´ç”¨é€—å·åˆ†éš”
5. åªè¿”å›æ ‡ç­¾ï¼Œä¸è¦è¿”å›å…¶ä»–è¯´æ˜æ–‡å­—
6. å¦‚æœå·²æœ‰æ ‡ç­¾ï¼Œé¿å…ç”Ÿæˆé‡å¤çš„æ ‡ç­¾

è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼šæŠ€æœ¯,ç¼–ç¨‹,å‰ç«¯å¼€å‘,JavaScript`;

                // æ„å»ºç”¨æˆ·æç¤ºè¯
                let userPrompt = `å¸¸è§é—®é¢˜å†…å®¹ï¼š\n${faq.text || ''}`;

                const currentTags = tagModal._currentTags || [];
                if (currentTags.length > 0) {
                    userPrompt += `\n\nå·²æœ‰æ ‡ç­¾ï¼š${currentTags.join(', ')}\nè¯·é¿å…ç”Ÿæˆé‡å¤çš„æ ‡ç­¾ã€‚`;
                }

                userPrompt += `\n\nè¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ç”Ÿæˆåˆé€‚çš„æ ‡ç­¾ã€‚`;

                // æ„å»º payload
                const payload = this.buildPromptPayload(
                    systemPrompt,
                    userPrompt,
                    this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
                );

                // è°ƒç”¨ prompt æ¥å£
                const response = await fetch(PET_CONFIG.api.promptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                // å…ˆè¯»å–å“åº”æ–‡æœ¬ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæµå¼å“åº”ï¼ˆSSEæ ¼å¼ï¼‰
                const responseText = await response.text();
                let result;
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                if (responseText.includes('data: ')) {
                    // å¤„ç†SSEæµå¼å“åº”
                    const lines = responseText.split('\n');
                    let accumulatedData = '';
                    let lastValidData = null;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr === '[DONE]' || dataStr === '') {
                                    continue;
                                }
                                
                                // å°è¯•è§£æJSON
                                const chunk = JSON.parse(dataStr);
                                
                                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                if (chunk.done === true) {
                                    break;
                                }
                                
                                // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                                if (chunk.data) {
                                    accumulatedData += chunk.data;
                                } else if (chunk.content) {
                                    accumulatedData += chunk.content;
                                } else if (chunk.message && chunk.message.content) {
                                    // Ollamaæ ¼å¼
                                    accumulatedData += chunk.message.content;
                                } else if (typeof chunk === 'string') {
                                    accumulatedData += chunk;
                                }
                                
                                // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                                lastValidData = chunk;
                            } catch (e) {
                                // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr && dataStr !== '[DONE]') {
                                    accumulatedData += dataStr;
                                }
                            }
                        }
                    }
                    
                    // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                    if (accumulatedData || lastValidData) {
                        if (lastValidData && lastValidData.status) {
                            // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                            result = {
                                ...lastValidData,
                                data: accumulatedData || lastValidData.data || '',
                                content: accumulatedData || lastValidData.content || ''
                            };
                        } else {
                            // å¦åˆ™åˆ›å»ºæ–°çš„ç»“æœå¯¹è±¡
                            result = {
                                data: accumulatedData,
                                content: accumulatedData
                            };
                        }
                    } else {
                        // å¦‚æœæ— æ³•è§£æSSEæ ¼å¼ï¼Œå°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”
                        try {
                            result = JSON.parse(responseText);
                        } catch (e) {
                            throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                        }
                    }
                } else {
                    // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾SSEæ ¼å¼çš„æ•°æ®
                        const sseMatch = responseText.match(/data:\s*({.+?})/s);
                        if (sseMatch) {
                            result = JSON.parse(sseMatch[1]);
                        } else {
                            throw new Error(`æ— æ³•è§£æå“åº”: ${responseText.substring(0, 100)}`);
                        }
                    }
                }
                
                // è§£æè¿”å›çš„æ ‡ç­¾
                let generatedTags = [];
                // é€‚é…å“åº”æ ¼å¼: {status, msg, data, pagination} æˆ– {content} æˆ– {response}
                let content = '';
                if (result.data) {
                    content = result.data;
                } else if (result.content) {
                    content = result.content;
                } else if (result.response) {
                    content = result.response;
                }
                
                if (content) {
                    const trimmedContent = content.trim();
                    
                    // å°è¯•è§£æ JSON æ ¼å¼
                    try {
                        const parsed = JSON.parse(trimmedContent);
                        if (Array.isArray(parsed)) {
                            generatedTags = parsed;
                        } else if (typeof parsed === 'object' && parsed.tags) {
                            generatedTags = Array.isArray(parsed.tags) ? parsed.tags : [];
                        }
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯ JSONï¼Œå°è¯•æŒ‰é€—å·åˆ†å‰²
                        generatedTags = trimmedContent.split(/[,ï¼Œã€]/).map(tag => tag.trim()).filter(tag => tag.length > 0);
                    }
                }

                if (generatedTags.length === 0) {
                    throw new Error('æœªèƒ½ç”Ÿæˆæœ‰æ•ˆæ ‡ç­¾ï¼Œè¯·é‡è¯•');
                }

                // ç¡®ä¿æ ‡ç­¾æ•°ç»„å­˜åœ¨
                if (!tagModal._currentTags) {
                    tagModal._currentTags = [];
                }

                // æ·»åŠ æ–°æ ‡ç­¾ï¼ˆæ’é™¤å·²å­˜åœ¨çš„æ ‡ç­¾ï¼‰
                let addedCount = 0;
                generatedTags.forEach(tag => {
                    const trimmedTag = tag.trim();
                    if (trimmedTag && !tagModal._currentTags.includes(trimmedTag)) {
                        tagModal._currentTags.push(trimmedTag);
                        addedCount++;
                    }
                });

                if (addedCount > 0) {
                    // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
                    this.loadFaqTagsIntoManager(faqIndex, tagModal._currentTags);
                    console.log(`æˆåŠŸç”Ÿæˆå¹¶æ·»åŠ  ${addedCount} ä¸ªæ ‡ç­¾:`, generatedTags.filter(tag => tagModal._currentTags.includes(tag.trim())));
                } else {
                    console.log('ç”Ÿæˆçš„æ ‡ç­¾éƒ½å·²å­˜åœ¨ï¼Œæœªæ·»åŠ æ–°æ ‡ç­¾');
                }

            } catch (error) {
                console.error('æ™ºèƒ½ç”Ÿæˆæ ‡ç­¾å¤±è´¥:', error);
                
                // ä½¿ç”¨éé˜»å¡çš„é”™è¯¯æç¤ºï¼Œé¿å…é˜»å¡å¼¹æ¡†äº¤äº’
                const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                const errorText = errorMessage.includes('Failed to fetch') 
                    ? 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•' 
                    : `ç”Ÿæˆæ ‡ç­¾å¤±è´¥ï¼š${errorMessage}`;
                
                // åœ¨å¼¹æ¡†å†…æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯ä½¿ç”¨ alertï¼ˆalert ä¼šé˜»å¡ï¼‰
                if (tagModal) {
                    // ç§»é™¤å·²å­˜åœ¨çš„é”™è¯¯æç¤º
                    const existingError = tagModal.querySelector('.faq-tag-error-message');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'faq-tag-error-message';
                    errorDiv.textContent = errorText;
                    errorDiv.style.cssText = `
                        padding: 10px 15px !important;
                        margin: 10px 0 !important;
                        background: #ffebee !important;
                        color: #c62828 !important;
                        border: 1px solid #ef5350 !important;
                        border-radius: 6px !important;
                        font-size: 13px !important;
                        animation: fadeIn 0.3s ease !important;
                    `;
                    
                    // æ’å…¥åˆ°è¾“å…¥ç»„ä¸‹æ–¹
                    const inputGroup = tagModal.querySelector('.faq-tag-manager-input-group');
                    if (inputGroup && inputGroup.parentNode) {
                        // æ’å…¥åˆ°è¾“å…¥ç»„å’Œæ ‡ç­¾å®¹å™¨ä¹‹é—´
                        const tagsContainer = tagModal.querySelector('.faq-tag-manager-tags');
                        if (tagsContainer && tagsContainer.parentNode) {
                            tagsContainer.parentNode.insertBefore(errorDiv, tagsContainer);
                        } else {
                            inputGroup.parentNode.insertBefore(errorDiv, inputGroup.nextSibling);
                        }
                        
                        // 3ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯æç¤º
                        setTimeout(() => {
                            if (errorDiv.parentNode) {
                                errorDiv.style.opacity = '0';
                                errorDiv.style.transition = 'opacity 0.3s ease';
                                setTimeout(() => {
                                    if (errorDiv.parentNode) {
                                        errorDiv.remove();
                                    }
                                }, 300);
                            }
                        }, 3000);
                    }
                } else {
                    // å¦‚æœå¼¹æ¡†ä¸å­˜åœ¨ï¼Œä½¿ç”¨ alert ä½œä¸ºåå¤‡æ–¹æ¡ˆ
                    alert(errorText);
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.style.background = '#9C27B0';
                    buttonElement.style.cursor = 'pointer';
                    buttonElement.textContent = 'âœ¨ æ™ºèƒ½ç”Ÿæˆ';
                }
                
                // ç¡®ä¿å¼¹æ¡†æœ¬èº«æ²¡æœ‰è¢«ç¦ç”¨ï¼ˆé˜²æ­¢å…¶ä»–æŒ‰é’®å¤±æ•ˆï¼‰
                if (tagModal) {
                    tagModal.style.pointerEvents = 'auto';
                    // ç¡®ä¿æ‰€æœ‰æŒ‰é’®éƒ½æ˜¯å¯ç”¨çš„
                    const allButtons = tagModal.querySelectorAll('button');
                    allButtons.forEach(btn => {
                        if (btn !== buttonElement) {
                            btn.disabled = false;
                            btn.style.pointerEvents = 'auto';
                            btn.style.cursor = 'pointer';
                        }
                    });
                }
            }
        }
    }

    // å…³é—­å¸¸è§é—®é¢˜æ ‡ç­¾ç®¡ç†å™¨ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼Œå‚è€ƒä¼šè¯åˆ—è¡¨çš„å®ç°ï¼‰
    async closeFaqTagManager() {
        const tagModal = this.chatWindow?.querySelector('#pet-faq-tag-manager');
        if (tagModal) {
            const faqIndex = tagModal.dataset.faqIndex;
            // å…³é—­å‰è‡ªåŠ¨ä¿å­˜
            if (faqIndex !== undefined) {
                try {
                    const modal = this.chatWindow?.querySelector('#pet-faq-manager');
                    if (modal && modal._currentFaqs) {
                        const faq = modal._currentFaqs[parseInt(faqIndex)];
                        if (faq && tagModal._currentTags) {
                            // è§„èŒƒåŒ–æ ‡ç­¾ï¼ˆtrimå¤„ç†ï¼Œå»é‡ï¼Œè¿‡æ»¤ç©ºæ ‡ç­¾ï¼‰
                            const normalizedTags = tagModal._currentTags
                                .map(tag => tag ? tag.trim() : '')
                                .filter(tag => tag.length > 0);
                            // å»é‡
                            faq.tags = [...new Set(normalizedTags)];
                            
                            // ä¿å­˜åˆ°åç«¯
                            try {
                                // ä½¿ç”¨APIä¿å­˜å¸¸è§é—®é¢˜æ ‡ç­¾
                                if (this.faqApi && this.faqApi.isEnabled()) {
                                    // ä½¿ç”¨åˆ—è¡¨å¯¹åº”çš„keyæ¥æ›´æ–°ï¼Œkeyä¼šåœ¨payloadä¸­ä¼ é€’
                                    await this.faqApi.updateFaq(faq.key || faq.text, {
                                        text: faq.text,
                                        tags: faq.tags
                                    });
                                    
                                    // æ¸…é™¤GETè¯·æ±‚ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡åŠ è½½è·å–æœ€æ–°æ•°æ®
                                    if (this.faqApi.clearGetCache) {
                                        this.faqApi.clearGetCache();
                                    }
                                    // ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®ï¼ˆä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼‰
                                    const targetFaq = modal._currentFaqs.find(f => f.text === faq.text);
                                    if (targetFaq) {
                                        targetFaq.tags = faq.tags;
                                    }
                                    // é‡æ–°åŠ è½½æ˜¾ç¤ºï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                                    await this.loadFaqsIntoManager();
                                    // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
                                    this.updateFaqTagFilterUI();
                                } else {
                                    // é™çº§æ–¹æ¡ˆï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                                    await this.saveFaqs(modal._currentFaqs);
                                    // é‡æ–°åŠ è½½æ˜¾ç¤º
                                    await this.loadFaqsIntoManager();
                                    // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
                                    this.updateFaqTagFilterUI();
                                }
                            } catch (error) {
                                console.error('è‡ªåŠ¨ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
                            }
                        }
                    }
                } catch (error) {
                    console.error('è‡ªåŠ¨ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
                }
            }
            
            // ç§»é™¤ESCç›‘å¬å™¨
            if (tagModal._escHandler) {
                document.removeEventListener('keydown', tagModal._escHandler);
                delete tagModal._escHandler;
            }
            
            // æ¢å¤æŠ˜å æŒ‰é’®æ˜¾ç¤º
            const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
            const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
            if (sidebarToggleBtn) sidebarToggleBtn.style.display = '';
            if (inputToggleBtn) inputToggleBtn.style.display = '';
            
            tagModal.style.display = 'none';
            const tagInput = tagModal.querySelector('.faq-tag-manager-input');
            if (tagInput) {
                tagInput.value = '';
            }
        }
    }

    // åˆ é™¤å¸¸è§é—®é¢˜
    async removeFaq(index) {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal || !modal._currentFaqs) return;

        const faq = modal._currentFaqs[index];
        if (!faq) return;

        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸¸è§é—®é¢˜å—ï¼Ÿ')) {
            return;
        }

        try {
            // ä½¿ç”¨APIåˆ é™¤å¸¸è§é—®é¢˜
            if (this.faqApi && this.faqApi.isEnabled()) {
                // ä½¿ç”¨åˆ—è¡¨å¯¹åº”çš„keyæ¥åˆ é™¤
                await this.faqApi.deleteFaq(faq.key);
                // æ¸…é™¤GETè¯·æ±‚ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡åŠ è½½è·å–æœ€æ–°æ•°æ®
                if (this.faqApi.clearGetCache) {
                    this.faqApi.clearGetCache();
                }
                // ç«‹å³ä»åˆ—è¡¨ä¸­åˆ é™¤ï¼ˆä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼‰
                modal._currentFaqs.splice(index, 1);
                // é‡æ–°åŠ è½½æ˜¾ç¤ºï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                await this.loadFaqsIntoManager();
                // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
                this.updateFaqTagFilterUI();
                this.showNotification('å¸¸è§é—®é¢˜å·²åˆ é™¤', 'success');
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä»åˆ—è¡¨ä¸­åˆ é™¤å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                modal._currentFaqs.splice(index, 1);
                await this.saveFaqs(modal._currentFaqs);
                // é‡æ–°åŠ è½½æ˜¾ç¤º
                await this.loadFaqsIntoManager();
                // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
                this.updateFaqTagFilterUI();
                this.showNotification('å¸¸è§é—®é¢˜å·²åˆ é™¤', 'success');
            }
        } catch (error) {
            console.error('åˆ é™¤å¸¸è§é—®é¢˜å¤±è´¥:', error);
            this.showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    // ç¼–è¾‘å¸¸è§é—®é¢˜
    editFaq(index) {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal || !modal._currentFaqs || !this.chatWindow) return;

        const faq = modal._currentFaqs[index];
        if (!faq) return;

        const existingText = faq.text;
        const mainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
        const MAX_LENGTH = 500; // æœ€å¤§å­—ç¬¦æ•°é™åˆ¶

        // ç¡®ä¿ chatWindow æœ‰æ­£ç¡®çš„å®šä½ä¸Šä¸‹æ–‡
        const currentPosition = window.getComputedStyle(this.chatWindow).position;
        if (currentPosition !== 'relative' && currentPosition !== 'absolute' && currentPosition !== 'fixed') {
            this.chatWindow.style.position = 'relative';
        }

        // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡† - æ·»åŠ åˆ° chatWindow å†…
        const editModal = document.createElement('div');
        editModal.className = 'pet-faq-edit-modal';
        editModal.style.cssText = `
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(4px) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: ${PET_CONFIG.ui.zIndex.modal + 1} !important;
            opacity: 0 !important;
            transition: opacity 0.2s ease !important;
        `;

        // è®¡ç®—å¹¶è®¾ç½®å¯¹è¯æ¡†å¤§å°ï¼ˆè‡ªé€‚åº”èŠå¤©å¼¹æ¡†ï¼‰
        const updateDialogSize = () => {
            if (!this.chatWindow) return;
            const chatRect = this.chatWindow.getBoundingClientRect();
            const maxWidth = Math.min(560, chatRect.width * 0.85);
            const maxHeight = Math.min(chatRect.height * 0.85, window.innerHeight * 0.85);
            dialog.style.maxWidth = `${maxWidth}px`;
            dialog.style.maxHeight = `${maxHeight}px`;
        };

        const dialog = document.createElement('div');
        dialog.className = 'pet-faq-edit-dialog';
        dialog.style.cssText = `
            background: white !important;
            border-radius: 16px !important;
            padding: 0 !important;
            width: 90% !important;
            max-width: 560px !important;
            max-height: 85% !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            transform: scale(0.95) !important;
            transition: transform 0.2s ease !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        `;
        
        // åˆå§‹åŒ–å¤§å°
        updateDialogSize();
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        const resizeHandler = () => updateDialogSize();
        window.addEventListener('resize', resizeHandler);
        editModal._resizeHandler = resizeHandler;

        // æ ‡é¢˜æ 
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 20px 24px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%) !important;
        `;

        const dialogTitle = document.createElement('div');
        dialogTitle.textContent = 'âœï¸ ç¼–è¾‘å¸¸è§é—®é¢˜';
        dialogTitle.style.cssText = `
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #1e293b !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        `;

        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.title = 'å…³é—­ï¼ˆESCï¼‰';
        closeBtn.style.cssText = `
            background: rgba(0, 0, 0, 0.05) !important;
            border: none !important;
            font-size: 20px !important;
            cursor: pointer !important;
            color: #64748b !important;
            padding: 0 !important;
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(0, 0, 0, 0.1)';
            closeBtn.style.color = '#1e293b';
            closeBtn.style.transform = 'rotate(90deg)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(0, 0, 0, 0.05)';
            closeBtn.style.color = '#64748b';
            closeBtn.style.transform = 'rotate(0deg)';
        });

        header.appendChild(dialogTitle);
        header.appendChild(closeBtn);

        // å†…å®¹åŒºåŸŸ - å¯æ»šåŠ¨
        const content = document.createElement('div');
        content.style.cssText = `
            padding: 24px !important;
            overflow-y: auto !important;
            flex: 1 !important;
            min-height: 0 !important;
        `;

        // æ–‡æœ¬è¾“å…¥åŒºåŸŸ
        const textareaWrapper = document.createElement('div');
        textareaWrapper.style.cssText = `
            position: relative !important;
            margin-bottom: 12px !important;
        `;

        const textarea = document.createElement('textarea');
        textarea.value = existingText;
        textarea.placeholder = 'è¾“å…¥é—®é¢˜å†…å®¹...';
        textarea.maxLength = MAX_LENGTH;
        textarea.style.cssText = `
            width: 100% !important;
            min-height: 120px !important;
            max-height: 200px !important;
            padding: 12px !important;
            border: 2px solid #e2e8f0 !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            color: #1e293b !important;
            resize: vertical !important;
            font-family: inherit !important;
            outline: none !important;
            transition: all 0.2s ease !important;
            box-sizing: border-box !important;
        `;

        // å­—ç¬¦è®¡æ•°
        const charCount = document.createElement('div');
        charCount.className = 'pet-faq-edit-char-count';
        const updateCharCount = () => {
            const length = textarea.value.length;
            charCount.textContent = `${length}/${MAX_LENGTH}`;
            charCount.style.color = length > MAX_LENGTH * 0.9 ? '#ef4444' : '#94a3b8';
        };
        updateCharCount();
        charCount.style.cssText = `
            position: absolute !important;
            bottom: 8px !important;
            right: 12px !important;
            font-size: 12px !important;
            color: #94a3b8 !important;
            background: rgba(255, 255, 255, 0.9) !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
            pointer-events: none !important;
        `;

        textarea.addEventListener('input', updateCharCount);
        textarea.addEventListener('focus', () => {
            textarea.style.borderColor = mainColor;
            textarea.style.boxShadow = `0 0 0 3px ${mainColor}20`;
        });
        textarea.addEventListener('blur', () => {
            textarea.style.borderColor = '#e2e8f0';
            textarea.style.boxShadow = 'none';
        });

        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        const adjustTextareaHeight = () => {
            textarea.style.height = 'auto';
            const maxHeight = 200; // ä¸ CSS ä¸­çš„ max-height ä¿æŒä¸€è‡´
            textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
        };
        adjustTextareaHeight();
        textarea.addEventListener('input', adjustTextareaHeight);

        textareaWrapper.appendChild(textarea);
        textareaWrapper.appendChild(charCount);

        // æç¤ºä¿¡æ¯
        const hint = document.createElement('div');
        hint.style.cssText = `
            font-size: 12px !important;
            color: #64748b !important;
            margin-bottom: 20px !important;
            line-height: 1.5 !important;
        `;
        hint.innerHTML = 'ğŸ’¡ æç¤ºï¼šæŒ‰ <kbd style="padding: 2px 6px; background: #f1f5f9; border-radius: 4px; font-size: 11px;">Ctrl+Enter</kbd> æˆ– <kbd style="padding: 2px 6px; background: #f1f5f9; border-radius: 4px; font-size: 11px;">Cmd+Enter</kbd> ä¿å­˜ï¼Œ<kbd style="padding: 2px 6px; background: #f1f5f9; border-radius: 4px; font-size: 11px;">ESC</kbd> å–æ¶ˆ';

        content.appendChild(textareaWrapper);
        content.appendChild(hint);

        // æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼
        const scrollbarStyleId = 'pet-faq-edit-scrollbar-style';
        editModal._scrollbarStyleId = scrollbarStyleId; // å­˜å‚¨åˆ° editModal ä¸Šä»¥ä¾¿åç»­è®¿é—®
        let scrollbarStyle = document.getElementById(scrollbarStyleId);
        if (!scrollbarStyle) {
            scrollbarStyle = document.createElement('style');
            scrollbarStyle.id = scrollbarStyleId;
            scrollbarStyle.textContent = `
                .pet-faq-edit-dialog .pet-faq-edit-content::-webkit-scrollbar {
                    width: 6px;
                }
                .pet-faq-edit-dialog .pet-faq-edit-content::-webkit-scrollbar-track {
                    background: #f1f5f9;
                    border-radius: 3px;
                }
                .pet-faq-edit-dialog .pet-faq-edit-content::-webkit-scrollbar-thumb {
                    background: #cbd5e1;
                    border-radius: 3px;
                }
                .pet-faq-edit-dialog .pet-faq-edit-content::-webkit-scrollbar-thumb:hover {
                    background: #94a3b8;
                }
            `;
            document.head.appendChild(scrollbarStyle);
        }
        
        // ä¸ºå†…å®¹åŒºåŸŸæ·»åŠ ç±»åä»¥ä¾¿æ ·å¼é€‰æ‹©å™¨åŒ¹é…
        content.className = 'pet-faq-edit-content';

        // æŒ‰é’®ç»„
        const buttonGroup = document.createElement('div');
        buttonGroup.style.cssText = `
            display: flex !important;
            gap: 12px !important;
            justify-content: flex-end !important;
            padding: 16px 24px !important;
            border-top: 1px solid #e5e7eb !important;
            background: #f8fafc !important;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.className = 'pet-faq-edit-cancel';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            border-radius: 8px !important;
            background: white !important;
            color: #64748b !important;
            border: 1px solid #e2e8f0 !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
        `;

        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f1f5f9';
            cancelBtn.style.borderColor = '#cbd5e1';
        });

        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'white';
            cancelBtn.style.borderColor = '#e2e8f0';
        });

        // æ™ºèƒ½ä¼˜åŒ–æŒ‰é’®
        const optimizeBtn = document.createElement('button');
        optimizeBtn.textContent = 'âœ¨ æ™ºèƒ½ä¼˜åŒ–';
        optimizeBtn.className = 'pet-faq-edit-optimize';
        optimizeBtn.style.cssText = `
            padding: 10px 20px !important;
            border-radius: 8px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3) !important;
            position: relative !important;
        `;

        optimizeBtn.addEventListener('mouseenter', () => {
            if (!optimizeBtn.disabled) {
                optimizeBtn.style.opacity = '0.9';
                optimizeBtn.style.transform = 'translateY(-1px)';
                optimizeBtn.style.boxShadow = '0 4px 8px rgba(102, 126, 234, 0.4)';
            }
        });

        optimizeBtn.addEventListener('mouseleave', () => {
            if (!optimizeBtn.disabled) {
                optimizeBtn.style.opacity = '1';
                optimizeBtn.style.transform = 'translateY(0)';
                optimizeBtn.style.boxShadow = '0 2px 4px rgba(102, 126, 234, 0.3)';
            }
        });

        // æ™ºèƒ½ä¼˜åŒ–åŠŸèƒ½
        const handleOptimize = async () => {
            const originalText = textarea.value.trim();
            
            if (!originalText) {
                this.showNotification('è¯·å…ˆè¾“å…¥é—®é¢˜å†…å®¹', 'warning');
                textarea.focus();
                return;
            }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            optimizeBtn.disabled = true;
            const originalTextContent = optimizeBtn.textContent;
            optimizeBtn.textContent = 'â³ ä¼˜åŒ–ä¸­...';
            optimizeBtn.style.opacity = '0.7';
            optimizeBtn.style.cursor = 'not-allowed';

            try {
                // æ„å»ºä¼˜åŒ–æç¤ºè¯
                const systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æœ¬ä¼˜åŒ–åŠ©æ‰‹ï¼Œæ“…é•¿ä¼˜åŒ–å’Œæ”¹å†™é—®é¢˜æ–‡æœ¬ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°ã€ç®€æ´ã€ä¸“ä¸šã€‚';
                const userPrompt = `è¯·ä¼˜åŒ–ä»¥ä¸‹é—®é¢˜æ–‡æœ¬ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°ã€ç®€æ´ã€ä¸“ä¸šã€‚åªè¿”å›ä¼˜åŒ–åçš„æ–‡æœ¬ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæˆ–è¯´æ˜ï¼š

${originalText}`;

                // æ„å»ºè¯·æ±‚payload
                const payload = this.buildPromptPayload(
                    systemPrompt,
                    userPrompt,
                    this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
                );

                // è°ƒç”¨API
                const response = await fetch(PET_CONFIG.api.promptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // å…ˆè¯»å–å“åº”æ–‡æœ¬ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæµå¼å“åº”ï¼ˆSSEæ ¼å¼ï¼‰
                const responseText = await response.text();
                let result;
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                if (responseText.includes('data: ')) {
                    // å¤„ç†SSEæµå¼å“åº”
                    const lines = responseText.split('\n');
                    let accumulatedData = '';
                    let lastValidData = null;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr === '[DONE]' || dataStr === '') {
                                    continue;
                                }
                                
                                // å°è¯•è§£æJSON
                                const chunk = JSON.parse(dataStr);
                                
                                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                if (chunk.done === true) {
                                    break;
                                }
                                
                                // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                                if (chunk.data) {
                                    accumulatedData += chunk.data;
                                } else if (chunk.content) {
                                    accumulatedData += chunk.content;
                                } else if (chunk.message && chunk.message.content) {
                                    // Ollamaæ ¼å¼
                                    accumulatedData += chunk.message.content;
                                } else if (typeof chunk === 'string') {
                                    accumulatedData += chunk;
                                }
                                
                                // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                                lastValidData = chunk;
                            } catch (e) {
                                // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr && dataStr !== '[DONE]') {
                                    accumulatedData += dataStr;
                                }
                            }
                        }
                    }
                    
                    // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                    if (accumulatedData || lastValidData) {
                        if (lastValidData && lastValidData.status) {
                            // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                            result = {
                                ...lastValidData,
                                data: accumulatedData || lastValidData.data || '',
                                content: accumulatedData || lastValidData.content || ''
                            };
                        } else {
                            // å¦åˆ™åˆ›å»ºæ–°çš„ç»“æœå¯¹è±¡
                            result = {
                                data: accumulatedData,
                                content: accumulatedData
                            };
                        }
                    } else {
                        throw new Error('SSEå“åº”ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®');
                    }
                } else {
                    // éSSEæ ¼å¼ï¼Œå°è¯•è§£æä¸ºJSON
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬
                        result = {
                            data: responseText,
                            content: responseText
                        };
                    }
                }
                
                // å¤„ç†å“åº”æ ¼å¼
                let optimizedText = '';
                if (result.status === 200 && result.data) {
                    optimizedText = result.data.trim();
                } else if (result.data) {
                    optimizedText = result.data.trim();
                } else if (result.content) {
                    optimizedText = result.content.trim();
                } else if (result.message) {
                    optimizedText = result.message.trim();
                } else if (typeof result === 'string') {
                    optimizedText = result.trim();
                } else {
                    throw new Error('æ— æ³•è§£æAPIå“åº”');
                }

                // å¦‚æœä¼˜åŒ–åçš„æ–‡æœ¬ä¸ºç©ºæˆ–ä¸åŸæ–‡ç›¸åŒï¼Œæç¤ºç”¨æˆ·
                if (!optimizedText || optimizedText === originalText) {
                    this.showNotification('æ–‡æœ¬å·²ç»æ˜¯æœ€ä¼˜çŠ¶æ€ï¼Œæ— éœ€ä¼˜åŒ–', 'info');
                } else {
                    // æ›´æ–°æ–‡æœ¬æ¡†å†…å®¹
                    textarea.value = optimizedText;
                    // è§¦å‘inputäº‹ä»¶ä»¥æ›´æ–°å­—ç¬¦è®¡æ•°å’Œé«˜åº¦
                    textarea.dispatchEvent(new Event('input'));
                    // é€‰ä¸­ä¼˜åŒ–åçš„æ–‡æœ¬ï¼Œæ–¹ä¾¿ç”¨æˆ·æŸ¥çœ‹
                    textarea.focus();
                    textarea.select();
                    this.showNotification('æ–‡æœ¬ä¼˜åŒ–å®Œæˆ', 'success');
                }
            } catch (error) {
                console.error('æ™ºèƒ½ä¼˜åŒ–å¤±è´¥:', error);
                this.showNotification('ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                optimizeBtn.disabled = false;
                optimizeBtn.textContent = originalTextContent;
                optimizeBtn.style.opacity = '1';
                optimizeBtn.style.cursor = 'pointer';
            }
        };

        optimizeBtn.addEventListener('click', handleOptimize);

        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'ä¿å­˜';
        confirmBtn.className = 'pet-faq-edit-confirm';
        confirmBtn.style.cssText = `
            padding: 10px 20px !important;
            border-radius: 8px !important;
            background: ${mainColor} !important;
            color: white !important;
            border: none !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        `;

        confirmBtn.addEventListener('mouseenter', () => {
            confirmBtn.style.opacity = '0.9';
            confirmBtn.style.transform = 'translateY(-1px)';
            confirmBtn.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
        });

        confirmBtn.addEventListener('mouseleave', () => {
            confirmBtn.style.opacity = '1';
            confirmBtn.style.transform = 'translateY(0)';
            confirmBtn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
        });

        // å…³é—­æ–¹æ³•
        const closeEditModal = () => {
            editModal.style.opacity = '0';
            dialog.style.transform = 'scale(0.95)';
            setTimeout(() => {
                if (editModal.parentNode) {
                    editModal.parentNode.removeChild(editModal);
                }
                document.removeEventListener('keydown', keyHandler);
                // æ¸…ç† resize ç›‘å¬å™¨
                if (editModal._resizeHandler) {
                    window.removeEventListener('resize', editModal._resizeHandler);
                }
                // æ¸…ç†æ ·å¼å…ƒç´ ï¼ˆå¦‚æœæ²¡æœ‰å…¶ä»–ç¼–è¾‘å¼¹æ¡†åœ¨ä½¿ç”¨ï¼‰
                const otherEditModals = this.chatWindow?.querySelectorAll('.pet-faq-edit-modal');
                if (!otherEditModals || otherEditModals.length === 0) {
                    const styleEl = document.getElementById(editModal._scrollbarStyleId || 'pet-faq-edit-scrollbar-style');
                    if (styleEl) {
                        styleEl.remove();
                    }
                }
            }, 200);
        };

        // ä¿å­˜é€»è¾‘
        const handleSave = async () => {
            const text = textarea.value.trim();
            
            if (!text) {
                this.showNotification('è¯·è¾“å…¥é—®é¢˜å†…å®¹', 'warning');
                textarea.focus();
                return;
            }

            if (text === existingText) {
                closeEditModal();
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå†…å®¹ï¼ˆæ’é™¤å½“å‰ç¼–è¾‘çš„é¡¹ï¼‰
            const exists = modal._currentFaqs.some((faq, i) => i !== index && faq.text === text);
            if (exists) {
                this.showNotification('è¯¥é—®é¢˜å·²å­˜åœ¨', 'warning');
                textarea.focus();
                textarea.select();
                return;
            }

            try {
                const faq = modal._currentFaqs[index];
                
                // ä½¿ç”¨APIæ›´æ–°å¸¸è§é—®é¢˜
                if (this.faqApi && this.faqApi.isEnabled()) {
                    // ä½¿ç”¨åˆ—è¡¨å¯¹åº”çš„keyæ¥æ›´æ–°ï¼Œkeyä¼šåœ¨payloadä¸­ä¼ é€’
                    await this.faqApi.updateFaq(faq.key || faq.text, {
                        text: text,
                        tags: faq.tags || []
                    });
                    // æ¸…é™¤GETè¯·æ±‚ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡åŠ è½½è·å–æœ€æ–°æ•°æ®
                    if (this.faqApi.clearGetCache) {
                        this.faqApi.clearGetCache();
                    }
                    // ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®ï¼ˆä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼‰
                    modal._currentFaqs[index].text = text;
                    // é‡æ–°åŠ è½½æ˜¾ç¤ºï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                    await this.loadFaqsIntoManager();
                    closeEditModal();
                    this.showNotification('å¸¸è§é—®é¢˜å·²æ›´æ–°', 'success');
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šæ›´æ–°æœ¬åœ°æ•°æ®å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    modal._currentFaqs[index].text = text;
                    await this.saveFaqs(modal._currentFaqs);
                    // é‡æ–°åŠ è½½æ˜¾ç¤º
                    await this.loadFaqsIntoManager();
                    closeEditModal();
                    this.showNotification('å¸¸è§é—®é¢˜å·²æ›´æ–°', 'success');
                }
            } catch (error) {
                console.error('ä¿å­˜å¸¸è§é—®é¢˜å¤±è´¥:', error);
                this.showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        };

        confirmBtn.addEventListener('click', handleSave);
        cancelBtn.addEventListener('click', closeEditModal);
        closeBtn.addEventListener('click', closeEditModal);

        buttonGroup.appendChild(cancelBtn);
        buttonGroup.appendChild(optimizeBtn);
        buttonGroup.appendChild(confirmBtn);

        dialog.appendChild(header);
        dialog.appendChild(content);
        dialog.appendChild(buttonGroup);

        editModal.appendChild(dialog);

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                closeEditModal();
            }
        });

        // é”®ç›˜äº‹ä»¶å¤„ç†
        let isComposing = false;
        textarea.addEventListener('compositionstart', () => {
            isComposing = true;
        });
        textarea.addEventListener('compositionend', () => {
            isComposing = false;
        });

        const keyHandler = (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                closeEditModal();
            } else if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !isComposing) {
                e.preventDefault();
                handleSave();
            }
        };
        document.addEventListener('keydown', keyHandler);

        // æ·»åŠ åˆ° chatWindow å¹¶æ˜¾ç¤ºåŠ¨ç”»
        this.chatWindow.appendChild(editModal);
        requestAnimationFrame(() => {
            editModal.style.opacity = '1';
            dialog.style.transform = 'scale(1)';
        });

        // èšç„¦å¹¶é€‰ä¸­æ–‡æœ¬
        setTimeout(() => {
            textarea.focus();
            textarea.select();
        }, 100);
    }

    // ä½¿ç”¨å¸¸è§é—®é¢˜ï¼ˆè¿½åŠ åˆ°è¾“å…¥æ¡†ï¼‰
    useFaq(text) {
        const messageInput = this.chatWindow?.querySelector('.chat-message-input');
        if (!messageInput) return;

        const currentValue = messageInput.value.trim();
        if (currentValue) {
            messageInput.value = currentValue + '\n' + text;
        } else {
            messageInput.value = text;
        }
        messageInput.focus();
        
        // è§¦å‘inputäº‹ä»¶ä»¥æ›´æ–°è¾“å…¥æ¡†é«˜åº¦
        messageInput.dispatchEvent(new Event('input'));
        
        // å…³é—­ç®¡ç†å™¨
        this.closeFaqManagerOnly();
        
        this.showNotification('å·²è¿½åŠ åˆ°è¾“å…¥æ¡†', 'success');
    }

    // å¤åˆ¶å¸¸è§é—®é¢˜æ–‡æœ¬åˆ°å‰ªè´´æ¿
    async copyFaq(text, buttonElement) {
        if (!text) {
            this.showNotification('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'warning');
            return;
        }

        try {
            // ä¼˜å…ˆä½¿ç”¨ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå·²å¤åˆ¶
                if (buttonElement) {
                    const originalHTML = buttonElement.innerHTML;
                    buttonElement.innerHTML = 'âœ“';
                    buttonElement.title = 'å·²å¤åˆ¶';
                    setTimeout(() => {
                        buttonElement.innerHTML = originalHTML;
                        buttonElement.title = 'å¤åˆ¶';
                    }, 2000);
                }
                
                this.showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå·²å¤åˆ¶
                        if (buttonElement) {
                            const originalHTML = buttonElement.innerHTML;
                            buttonElement.innerHTML = 'âœ“';
                            buttonElement.title = 'å·²å¤åˆ¶';
                            setTimeout(() => {
                                buttonElement.innerHTML = originalHTML;
                                buttonElement.title = 'å¤åˆ¶';
                            }, 2000);
                        }
                        
                        this.showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    } else {
                        throw new Error('å¤åˆ¶å‘½ä»¤æ‰§è¡Œå¤±è´¥');
                    }
                } catch (err) {
                    document.body.removeChild(textArea);
                    throw err;
                }
            }
        } catch (error) {
            console.error('å¤åˆ¶å¤±è´¥:', error);
            this.showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    // ä¸Šç§»å¸¸è§é—®é¢˜
    async moveFaqUp(index) {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal || !modal._currentFaqs) {
            console.warn('å¸¸è§é—®é¢˜ç®¡ç†å™¨æœªæ‰¾åˆ°æˆ–æ•°æ®ä¸ºç©º');
            return;
        }

        if (index <= 0) {
            return; // å·²ç»æ˜¯ç¬¬ä¸€ä¸ªï¼Œæ— æ³•ä¸Šç§»
        }

        const faqs = modal._currentFaqs;
        if (!Array.isArray(faqs) || faqs.length === 0) {
            console.warn('å¸¸è§é—®é¢˜åˆ—è¡¨ä¸ºç©º');
            return;
        }

        if (index >= faqs.length) {
            console.warn('ç´¢å¼•è¶…å‡ºèŒƒå›´:', index, faqs.length);
            return;
        }

        // äº¤æ¢ä½ç½®
        const temp = faqs[index];
        faqs[index] = faqs[index - 1];
        faqs[index - 1] = temp;

        // æ›´æ–°orderå­—æ®µï¼šäº¤æ¢ä¸¤ä¸ªé¡¹çš„orderå€¼
        const tempOrder = faqs[index].order !== undefined && faqs[index].order !== null ? faqs[index].order : index;
        const prevOrder = faqs[index - 1].order !== undefined && faqs[index - 1].order !== null ? faqs[index - 1].order : index - 1;
        faqs[index].order = prevOrder;
        faqs[index - 1].order = tempOrder;

        try {
            // ä½¿ç”¨APIæ‰¹é‡æ›´æ–°æ’åº
            if (this.faqApi && this.faqApi.isEnabled()) {
                // è·å–éœ€è¦æ›´æ–°çš„ä¸¤ä¸ªé¡¹çš„key
                const currentKey = faqs[index].key || faqs[index].text;
                const prevKey = faqs[index - 1].key || faqs[index - 1].text;
                
                if (currentKey && prevKey) {
                    console.log('æ›´æ–°æ’åº:', { currentKey, currentOrder: faqs[index].order, prevKey, prevOrder: faqs[index - 1].order });
                    await this.faqApi.batchUpdateOrder([
                        { key: currentKey, order: faqs[index].order },
                        { key: prevKey, order: faqs[index - 1].order }
                    ]);
                } else {
                    // å¦‚æœæ²¡æœ‰keyï¼Œä½¿ç”¨æ‰¹é‡ä¿å­˜æ•´ä¸ªåˆ—è¡¨
                    console.log('ä¿å­˜æ’åºåçš„å¸¸è§é—®é¢˜åˆ—è¡¨:', faqs.length);
                    await this.faqApi.saveFaqs(faqs);
                }
                
                // æ¸…é™¤GETè¯·æ±‚ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡åŠ è½½è·å–æœ€æ–°æ•°æ®
                if (this.faqApi.clearGetCache) {
                    this.faqApi.clearGetCache();
                }
                // æ›´æ–°æœ¬åœ°æ•°æ®ï¼Œé¿å…é‡æ–°åŠ è½½æ—¶ä¸¢å¤±æ’åº
                modal._currentFaqs = faqs.map(faq => ({ ...faq }));
                // é‡æ–°åŠ è½½æ˜¾ç¤ºï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                await this.loadFaqsIntoManager();
                this.showNotification('é¡ºåºå·²æ›´æ–°', 'success');
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                await this.saveFaqs(faqs);
                // æ›´æ–°æœ¬åœ°æ•°æ®
                modal._currentFaqs = faqs.map(faq => ({ ...faq }));
                // é‡æ–°åŠ è½½æ˜¾ç¤º
                await this.loadFaqsIntoManager();
                this.showNotification('é¡ºåºå·²æ›´æ–°', 'success');
            }
        } catch (error) {
            console.error('ä¿å­˜é¡ºåºå¤±è´¥:', error);
            this.showNotification('ä¿å­˜é¡ºåºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            // æ¢å¤åŸé¡ºåº
            const tempRestore = faqs[index];
            faqs[index] = faqs[index - 1];
            faqs[index - 1] = tempRestore;
            // æ¢å¤orderå€¼
            faqs[index].order = tempOrder;
            faqs[index - 1].order = prevOrder;
            await this.loadFaqsIntoManager();
        }
    }

    // ä¸‹ç§»å¸¸è§é—®é¢˜
    async moveFaqDown(index) {
        const modal = this.chatWindow?.querySelector('#pet-faq-manager');
        if (!modal || !modal._currentFaqs) {
            console.warn('å¸¸è§é—®é¢˜ç®¡ç†å™¨æœªæ‰¾åˆ°æˆ–æ•°æ®ä¸ºç©º');
            return;
        }

        const faqs = modal._currentFaqs;
        if (!Array.isArray(faqs) || faqs.length === 0) {
            console.warn('å¸¸è§é—®é¢˜åˆ—è¡¨ä¸ºç©º');
            return;
        }

        if (index >= faqs.length - 1) {
            return; // å·²ç»æ˜¯æœ€åä¸€ä¸ªï¼Œæ— æ³•ä¸‹ç§»
        }

        // äº¤æ¢ä½ç½®
        const temp = faqs[index];
        faqs[index] = faqs[index + 1];
        faqs[index + 1] = temp;

        // æ›´æ–°orderå­—æ®µï¼šäº¤æ¢ä¸¤ä¸ªé¡¹çš„orderå€¼
        const tempOrder = faqs[index].order !== undefined && faqs[index].order !== null ? faqs[index].order : index;
        const nextOrder = faqs[index + 1].order !== undefined && faqs[index + 1].order !== null ? faqs[index + 1].order : index + 1;
        faqs[index].order = nextOrder;
        faqs[index + 1].order = tempOrder;

        try {
            // ä½¿ç”¨APIæ‰¹é‡æ›´æ–°æ’åº
            if (this.faqApi && this.faqApi.isEnabled()) {
                // è·å–éœ€è¦æ›´æ–°çš„ä¸¤ä¸ªé¡¹çš„key
                const currentKey = faqs[index].key || faqs[index].text;
                const nextKey = faqs[index + 1].key || faqs[index + 1].text;
                
                if (currentKey && nextKey) {
                    console.log('æ›´æ–°æ’åº:', { currentKey, currentOrder: faqs[index].order, nextKey, nextOrder: faqs[index + 1].order });
                    await this.faqApi.batchUpdateOrder([
                        { key: currentKey, order: faqs[index].order },
                        { key: nextKey, order: faqs[index + 1].order }
                    ]);
                } else {
                    // å¦‚æœæ²¡æœ‰keyï¼Œä½¿ç”¨æ‰¹é‡ä¿å­˜æ•´ä¸ªåˆ—è¡¨
                    console.log('ä¿å­˜æ’åºåçš„å¸¸è§é—®é¢˜åˆ—è¡¨:', faqs.length);
                    await this.faqApi.saveFaqs(faqs);
                }
                
                // æ¸…é™¤GETè¯·æ±‚ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡åŠ è½½è·å–æœ€æ–°æ•°æ®
                if (this.faqApi.clearGetCache) {
                    this.faqApi.clearGetCache();
                }
                // æ›´æ–°æœ¬åœ°æ•°æ®ï¼Œé¿å…é‡æ–°åŠ è½½æ—¶ä¸¢å¤±æ’åº
                modal._currentFaqs = faqs.map(faq => ({ ...faq }));
                // é‡æ–°åŠ è½½æ˜¾ç¤ºï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                await this.loadFaqsIntoManager();
                this.showNotification('é¡ºåºå·²æ›´æ–°', 'success');
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                await this.saveFaqs(faqs);
                // æ›´æ–°æœ¬åœ°æ•°æ®
                modal._currentFaqs = faqs.map(faq => ({ ...faq }));
                // é‡æ–°åŠ è½½æ˜¾ç¤º
                await this.loadFaqsIntoManager();
                this.showNotification('é¡ºåºå·²æ›´æ–°', 'success');
            }
        } catch (error) {
            console.error('ä¿å­˜é¡ºåºå¤±è´¥:', error);
            this.showNotification('ä¿å­˜é¡ºåºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            // æ¢å¤åŸé¡ºåº
            const tempRestore = faqs[index];
            faqs[index] = faqs[index + 1];
            faqs[index + 1] = tempRestore;
            // æ¢å¤orderå€¼
            faqs[index].order = tempOrder;
            faqs[index + 1].order = nextOrder;
            await this.loadFaqsIntoManager();
        }
    }

    // ä¿å­˜å¸¸è§é—®é¢˜åˆ°å­˜å‚¨ï¼ˆé™çº§æ–¹æ¡ˆï¼Œç”¨äºAPIä¸å¯ç”¨æ—¶ï¼‰
    async saveFaqs(faqs) {
        try {
            await chrome.storage.local.set({ petFaqs: faqs });
        } catch (error) {
            console.error('ä¿å­˜å¸¸è§é—®é¢˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
            this.showNotification('ä¿å­˜å¸¸è§é—®é¢˜å¤±è´¥', 'error');
        }
    }
    
    // æŸ¥æ‰¾ä¸OSSæ–‡ä»¶å…³è”çš„æ‰€æœ‰ä¼šè¯
    // @param {string} objectName - æ–‡ä»¶å¯¹è±¡å
    // @returns {Array<string>} å…³è”çš„ä¼šè¯IDæ•°ç»„
    _findSessionsByOssFile(objectName) {
        if (!objectName) {
            return [];
        }
        
        const matchedSessionIds = [];
        
        // è·å–æ–‡ä»¶å¯¹è±¡ï¼ˆç”¨äºåŒ¹é…ï¼‰
        let fileObject = null;
        let fileUrl = null;
        if (this.ossFileManager) {
            const allFiles = this.ossFileManager.getAllFiles();
            fileObject = allFiles.find(file => file.name === objectName);
            if (fileObject) {
                fileUrl = fileObject.url;
            }
        }
        
        // éå†æ‰€æœ‰ä¼šè¯ï¼Œæ‰¾åˆ°å…³è”çš„ä¼šè¯
        for (const sessionId in this.sessions) {
            const session = this.sessions[sessionId];
            if (session && session._isOssFileSession && session._ossFileInfo) {
                // ä¼˜å…ˆä½¿ç”¨ URL åŒ¹é…ï¼ˆæœ€å¯é ï¼‰
                let isMatch = false;
                if (fileUrl && session._ossFileInfo.url) {
                    isMatch = session._ossFileInfo.url === fileUrl;
                } else {
                    // å¦‚æœ URL ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶ååŒ¹é…
                    const sessionUrl = session._ossFileInfo.url || '';
                    const sessionName = session._ossFileInfo.name || '';
                    // æ£€æŸ¥ URL æ˜¯å¦åŒ…å«æ–‡ä»¶åï¼Œæˆ–è€…åŸå§‹åç§°æ˜¯å¦åŒ¹é…
                    isMatch = sessionUrl.includes(objectName) || 
                             (sessionName === objectName) ||
                             (fileObject && sessionUrl === fileObject.url);
                }
                
                if (isMatch) {
                    matchedSessionIds.push(sessionId);
                }
            }
        }
        
        return matchedSessionIds;
    }

    // ä¸Šä¼ æ–‡ä»¶åˆ°OSS
    async uploadFileToOss() {
        if (!this.ossApi || !this.ossApi.isEnabled()) {
            this.showNotification('OSS APIæœªå¯ç”¨', 'error');
            return;
        }

        // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = true; // æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ 
        fileInput.style.display = 'none';

        fileInput.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (!files || files.length === 0) {
                // ç”¨æˆ·å–æ¶ˆé€‰æ‹©
                if (fileInput.parentNode) {
                    fileInput.parentNode.removeChild(fileInput);
                }
                return;
            }

            try {
                // è·å–å½“å‰ç›®å½•
                const directory = this.currentOssDirectory || '';

                // æ˜¾ç¤ºä¸Šä¼ ä¸­æç¤º
                if (files.length === 1) {
                    this.showNotification('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 'info');
                } else {
                    this.showNotification(`æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`, 'info');
                }

                let successCount = 0;
                let failCount = 0;
                const errors = [];

                // é€ä¸ªä¸Šä¼ æ–‡ä»¶
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        // ä¸Šä¼ æ–‡ä»¶
                        const result = await this.ossApi.uploadFile(file, directory);

                        if (result && result.code === 200) {
                            successCount++;
                        } else {
                            failCount++;
                            errors.push(`${file.name}: ${result?.message || 'ä¸Šä¼ å¤±è´¥'}`);
                        }
                    } catch (error) {
                        console.error(`ä¸Šä¼ æ–‡ä»¶ ${file.name} å¤±è´¥:`, error);
                        failCount++;
                        errors.push(`${file.name}: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                }

                // æ˜¾ç¤ºä¸Šä¼ ç»“æœ
                if (successCount > 0 && failCount === 0) {
                    // å…¨éƒ¨æˆåŠŸ
                    if (files.length === 1) {
                        this.showNotification('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
                    } else {
                        this.showNotification(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡ä»¶`, 'success');
                    }
                } else if (successCount > 0 && failCount > 0) {
                    // éƒ¨åˆ†æˆåŠŸ
                    this.showNotification(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡ä»¶ï¼Œ${failCount} ä¸ªå¤±è´¥`, 'error');
                    console.warn('ä¸Šä¼ å¤±è´¥çš„æ–‡ä»¶:', errors);
                } else {
                    // å…¨éƒ¨å¤±è´¥
                    this.showNotification(`ä¸Šä¼ å¤±è´¥: ${errors[0] || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    if (errors.length > 1) {
                        console.error('æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', errors);
                    }
                }
                
                // å¦‚æœæœ‰æˆåŠŸä¸Šä¼ çš„æ–‡ä»¶ï¼Œåˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                if (successCount > 0) {
                    if (this.ossFileManager) {
                        await this.ossFileManager.refreshFiles(true);
                    }
                    await this.updateOssFileSidebar(true);
                }
            } catch (error) {
                console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                this.showNotification('ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            } finally {
                // æ¸…ç†æ–‡ä»¶é€‰æ‹©å™¨
                fileInput.value = '';
                if (fileInput.parentNode) {
                    fileInput.parentNode.removeChild(fileInput);
                }
            }
        });

        // æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ç‚¹å‡»
        document.body.appendChild(fileInput);
        fileInput.click();
    }

    async updateSessionSidebar(forceRefresh = false, skipBackendRefresh = false) {
        if (!this.sessionSidebar) {
            console.log('ä¼šè¯ä¾§è¾¹æ æœªåˆ›å»ºï¼Œè·³è¿‡æ›´æ–°');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥
        const wasOssFileListVisible = this.ossFileListVisible;
        const wasNewsListVisible = this.newsListVisible;
        
        // ç¡®ä¿è§†å›¾æ¨¡å¼çŠ¶æ€æ­£ç¡®
        this.ossFileListVisible = false;
        this.newsListVisible = false;
        this.apiRequestListVisible = false;
        
        // å¦‚æœè§†å›¾çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥ï¼‰ï¼Œæ¸…ç©ºèŠå¤©æ¶ˆæ¯
        if ((wasOssFileListVisible || wasNewsListVisible)) {
            this.clearChatMessages();
        }
        
        // éšè—OSSæ–‡ä»¶åˆ—è¡¨å’ŒOSSæ ‡ç­¾ç­›é€‰å™¨
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        if (ossFileList) {
            ossFileList.style.display = 'none';
        }
        
        // éšè—æ–°é—»åˆ—è¡¨å’Œæ–°é—»æ ‡ç­¾è¿‡æ»¤å™¨
        const newsList = this.sessionSidebar.querySelector('.news-list');
        if (newsList) {
            newsList.style.display = 'none';
        }
        const newsTagFilterContainer = this.sessionSidebar.querySelector('.news-tag-filter-container');
        if (newsTagFilterContainer) {
            newsTagFilterContainer.style.display = 'none';
        }
        const ossTagFilterContainer = this.sessionSidebar.querySelector('.oss-tag-filter-container');
        if (ossTagFilterContainer) {
            ossTagFilterContainer.style.display = 'none';
        }
        
        // éšè—æ¥å£è¯·æ±‚åˆ—è¡¨
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        if (apiRequestList) {
            apiRequestList.style.display = 'none';
        }
        
        // éšè—è¯·æ±‚æ¥å£æ ‡ç­¾è¿‡æ»¤å™¨ï¼ˆåªåœ¨è¯·æ±‚æ¥å£è§†å›¾ä¸­æ˜¾ç¤ºï¼‰
        const apiRequestTagFilterContainer = this.sessionSidebar.querySelector('.api-request-tag-filter-container');
        if (apiRequestTagFilterContainer) {
            apiRequestTagFilterContainer.style.display = 'none';
        }
        
        // æ˜¾ç¤ºä¼šè¯åˆ—è¡¨ç›¸å…³å…ƒç´ 
        const tagFilterContainer = this.sessionSidebar.querySelector('.tag-filter-container');
        const batchToolbar = this.sessionSidebar.querySelector('#batch-toolbar');
        const scrollableContent = this.sessionSidebar.querySelector('.session-sidebar-scrollable-content');
        if (tagFilterContainer) {
            tagFilterContainer.style.display = 'block';
        }
        if (batchToolbar && this.batchMode) {
            batchToolbar.style.display = 'flex';
        }
        if (scrollableContent) {
            scrollableContent.style.display = 'flex';
        }
        
        // æ›´æ–°æœç´¢æ¡†å ä½ç¬¦
        const searchInput = this.sessionSidebar.querySelector('#session-search-input');
        if (searchInput) {
            searchInput.placeholder = 'æœç´¢ä¼šè¯...';
        }
        
        // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UI
        this.updateTagFilterUI();
        
        // æ›´æ–°è§†å›¾åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        this.applyViewMode();
        
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        if (!sessionList) {
            console.log('ä¼šè¯åˆ—è¡¨å®¹å™¨æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ›´æ–°');
            return;
        }
        sessionList.style.display = 'block';
        
        // ä¼˜å…ˆä½¿ç”¨æ¥å£æ•°æ®ï¼Œç¡®ä¿åˆ—è¡¨ä¸åç«¯ä¸€è‡´
        let allSessions = [];
        
        // ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼Œä¸å†è°ƒç”¨åç«¯æ¥å£ï¼ˆé™¤äº†ç¬¬ä¸€æ¬¡é¡µé¢åŠ è½½ï¼‰
        // ç¬¬ä¸€æ¬¡é¡µé¢åŠ è½½æ—¶çš„è°ƒç”¨å·²åœ¨ loadSessionsFromBackend ä¸­å¤„ç†
        allSessions = this._getSessionsFromLocal();
        
        // æ’é™¤OSSæ–‡ä»¶ä¼šè¯
        allSessions = allSessions.filter(session => {
            return !session._isOssFileSession;
        });
        
        // æ’é™¤ä¸æ–‡ä»¶åˆ—è¡¨ä¸­å…·æœ‰ç›¸åŒurlçš„ä¼šè¯
        if (this.ossFileManager) {
            const files = this.ossFileManager.getAllFiles();
            const fileUrls = new Set(files.map(file => file.url).filter(url => url));
            allSessions = allSessions.filter(session => {
                const sessionUrl = session.url;
                return !sessionUrl || !fileUrls.has(sessionUrl);
            });
        }
        
        // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰
        if (this.tagFilterNoTags) {
            allSessions = allSessions.filter(session => {
                const sessionTags = session.tags || [];
                const hasTags = sessionTags.length > 0 && sessionTags.some(tag => tag && tag.trim().length > 0);
                return !hasTags; // åªæ˜¾ç¤ºæ²¡æœ‰æ ‡ç­¾çš„ä¼šè¯
            });
        }
        
        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤
        if (this.selectedFilterTags && this.selectedFilterTags.length > 0) {
            allSessions = allSessions.filter(session => {
                const sessionTags = (session.tags || []).map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const normalizedSelectedTags = this.selectedFilterTags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const hasSelectedTags = normalizedSelectedTags.some(selectedTag => 
                    sessionTags.includes(selectedTag)
                );
                
                if (this.tagFilterReverse) {
                    // åå‘è¿‡æ»¤ï¼šæ’é™¤åŒ…å«é€‰ä¸­æ ‡ç­¾çš„ä¼šè¯
                    return !hasSelectedTags;
                } else {
                    // æ­£å‘è¿‡æ»¤ï¼šåªæ˜¾ç¤ºåŒ…å«é€‰ä¸­æ ‡ç­¾çš„ä¼šè¯
                    return hasSelectedTags;
                }
            });
        }
        
        // åº”ç”¨æ ‡é¢˜å’Œç½‘å€æ¨¡ç³ŠåŒ¹é…è¿‡æ»¤
        if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
            const filterKeyword = this.sessionTitleFilter.trim().toLowerCase();
            allSessions = allSessions.filter(session => {
                const sessionTitle = this._getSessionDisplayTitle(session);
                const sessionUrl = (session.url || '').toLowerCase();
                // æ¨¡ç³ŠåŒ¹é…ï¼šæ ‡é¢˜æˆ–ç½‘å€åŒ…å«å…³é”®è¯ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                return sessionTitle.toLowerCase().includes(filterKeyword) || 
                       sessionUrl.includes(filterKeyword);
            });
        }
        
        // åº”ç”¨æ—¥æœŸåŒºé—´è¿‡æ»¤
        if (this.dateRangeFilter) {
            if (this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // æœ‰å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼šç­›é€‰åŒºé—´å†…çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const endDate = this.dateRangeFilter.endDate;
                const startTime = startDate.getTime();
                const endTime = endDate.getTime() + 24 * 60 * 60 * 1000 - 1; // åŒ…å«ç»“æŸæ—¥æœŸçš„æ•´å¤©
                
                allSessions = allSessions.filter(session => {
                    const sessionTime = session.createdAt || session.updatedAt || 0;
                    return sessionTime >= startTime && sessionTime <= endTime;
                });
            } else if (this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
                // åªæœ‰å¼€å§‹æ—¥æœŸï¼šç­›é€‰å¼€å§‹æ—¥æœŸå½“å¤©çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const startTime = startDate.getTime();
                const endTime = startTime + 24 * 60 * 60 * 1000 - 1; // åŒ…å«å¼€å§‹æ—¥æœŸçš„æ•´å¤©
                
                allSessions = allSessions.filter(session => {
                    const sessionTime = session.createdAt || session.updatedAt || 0;
                    return sessionTime >= startTime && sessionTime <= endTime;
                });
            } else if (!this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // åªæœ‰ç»“æŸæ—¥æœŸï¼šç­›é€‰ç»“æŸæ—¥æœŸä¹‹å‰çš„è®°å½•
                const endDate = this.dateRangeFilter.endDate;
                const endTime = endDate.getTime(); // ä¸åŒ…å«ç»“æŸæ—¥æœŸå½“å¤©
                
                allSessions = allSessions.filter(session => {
                    const sessionTime = session.createdAt || session.updatedAt || 0;
                    return sessionTime < endTime;
                });
            }
        }
        
        // æ¸…ç©ºåˆ—è¡¨
        sessionList.innerHTML = '';
        
        console.log('å½“å‰ä¼šè¯æ•°é‡:', allSessions.length);
        
        if (allSessions.length === 0) {
            // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const emptyMsg = document.createElement('div');
            emptyMsg.style.cssText = `
                padding: 20px !important;
                text-align: center !important;
                color: #9ca3af !important;
                font-size: 12px !important;
            `;
            emptyMsg.textContent = 'æš‚æ— ä¼šè¯';
            sessionList.appendChild(emptyMsg);
            return;
        }
        
        // æŒ‰æ–‡ä»¶åæ’åºä¼šè¯ï¼ˆä½¿ç”¨æ˜¾ç¤ºæ ‡é¢˜è¿›è¡Œæ’åºï¼‰
        const sortedSessions = allSessions.sort((a, b) => {
            const aTitle = this._getSessionDisplayTitle(a) || '';
            const bTitle = this._getSessionDisplayTitle(b) || '';
            
            // æŒ‰æ–‡ä»¶åï¼ˆæ ‡é¢˜ï¼‰æ’åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            const titleCompare = aTitle.localeCompare(bTitle, 'zh-CN', { numeric: true, sensitivity: 'base' });
            if (titleCompare !== 0) {
                return titleCompare;
            }
            
            // å¦‚æœæ–‡ä»¶åç›¸åŒï¼ŒæŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°æ›´æ–°çš„åœ¨å‰ï¼‰
            const aUpdated = a.updatedAt || a.createdAt || 0;
            const bUpdated = b.updatedAt || b.createdAt || 0;
            if (aUpdated !== bUpdated) {
                return bUpdated - aUpdated;
            }
            
            // å¦‚æœæ›´æ–°æ—¶é—´ä¹Ÿç›¸åŒï¼ŒæŒ‰ä¼šè¯IDæ’åºï¼ˆç¡®ä¿å®Œå…¨ç¨³å®šï¼‰
            const aId = a.id || '';
            const bId = b.id || '';
            return aId.localeCompare(bId);
        });
        
        // åˆ›å»ºä¼šè¯åˆ—è¡¨é¡¹
        for (let index = 0; index < sortedSessions.length; index++) {
            const session = sortedSessions[index];
            if (!session || !session.id) continue;
            
            const sessionItem = document.createElement('div');
            sessionItem.className = 'session-item';
            sessionItem.dataset.sessionId = session.id;
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»ï¼šæ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦æ˜¯è¯¥ä¼šè¯
            let isActive = false;
            if (session.id === this.currentSessionId) {
                isActive = true;
                sessionItem.classList.add('active');
            }
            
            // æ‰¹é‡æ¨¡å¼ä¸‹æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»
            if (this.batchMode && this.selectedSessionIds.has(session.id)) {
                sessionItem.classList.add('selected');
            }
            
            // è®¾ç½®ä¼šè¯é¡¹çš„åŸºç¡€æ ·å¼ï¼ˆå‚è€ƒæ–°é—»åˆ—è¡¨ï¼‰
            sessionItem.style.cssText = `
                padding: 12px !important;
                margin-bottom: 8px !important;
                background: ${isActive ? '#eff6ff' : '#ffffff'} !important;
                border: 1px solid ${isActive ? '#3b82f6' : '#e5e7eb'} !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                box-shadow: ${isActive ? '0 2px 4px rgba(59, 130, 246, 0.2)' : '0 1px 2px rgba(0, 0, 0, 0.05)'} !important;
                position: relative !important;
            `;
            
            // åˆ›å»ºå¤é€‰æ¡†ï¼ˆä»…åœ¨æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'session-checkbox';
            checkbox.dataset.sessionId = session.id;
            checkbox.checked = this.selectedSessionIds.has(session.id);
            checkbox.style.cssText = `
                width: 16px !important;
                height: 16px !important;
                cursor: pointer !important;
                margin-right: 8px !important;
                flex-shrink: 0 !important;
                display: ${this.batchMode ? 'block' : 'none'} !important;
            `;
            
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                const sessionId = e.target.dataset.sessionId;
                if (e.target.checked) {
                    this.selectedSessionIds.add(sessionId);
                    sessionItem.classList.add('selected');
                } else {
                    this.selectedSessionIds.delete(sessionId);
                    sessionItem.classList.remove('selected');
                }
                this.updateBatchToolbar();
            });
            
            // é˜»æ­¢å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶å†’æ³¡
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // è·å–å®Œæ•´æ ‡é¢˜å’Œæ˜¾ç¤ºæ ‡é¢˜ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„è¾…åŠ©å‡½æ•°ï¼‰
            const fullTitle = this._getSessionDisplayTitle(session);
            
            // ä¼šè¯ä¿¡æ¯å®¹å™¨ï¼ˆå‚è€ƒæ–°é—»åˆ—è¡¨çš„ç»“æ„ï¼‰
            const sessionInfo = document.createElement('div');
            sessionInfo.className = 'session-info';
            sessionInfo.style.cssText = `
                margin-bottom: ${this.batchMode ? '0' : '8px'} !important;
            `;
            
            // åˆ›å»ºä¼šè¯é¡¹å†…éƒ¨å®¹å™¨ï¼ˆåŒ…å«å¤é€‰æ¡†å’Œå†…å®¹ï¼‰
            const itemInner = document.createElement('div');
            itemInner.style.cssText = `
                display: flex !important;
                align-items: flex-start !important;
                width: 100% !important;
                gap: 8px !important;
            `;
            
            // æ·»åŠ å¤é€‰æ¡†
            itemInner.appendChild(checkbox);
            
            // åˆ›å»ºå†…å®¹åŒ…è£…å™¨
            const contentWrapper = document.createElement('div');
            contentWrapper.style.cssText = `
                flex: 1 !important;
                min-width: 0 !important;
            `;
            
            // åˆ›å»ºæ ‡é¢˜è¡Œå®¹å™¨ï¼ˆæ ‡é¢˜å’ŒæŒ‰é’®åœ¨åŒä¸€è¡Œï¼‰
            const titleRow = document.createElement('div');
            titleRow.style.cssText = `
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 8px !important;
                width: 100% !important;
                margin-bottom: 6px !important;
            `;
            
            // æ ‡é¢˜
            const titleDiv = document.createElement('div');
            titleDiv.className = 'session-title';
            titleDiv.textContent = fullTitle;
            titleDiv.style.cssText = `
                font-size: 14px !important;
                font-weight: 600 !important;
                color: #111827 !important;
                line-height: 1.4 !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
                overflow: hidden !important;
                flex: 1 !important;
                min-width: 0 !important;
            `;
            titleRow.appendChild(titleDiv);
            
            // æ‰€æœ‰ä¼šè¯éƒ½æ˜¾ç¤ºç¼–è¾‘æ ‡é¢˜æŒ‰é’®
            const shouldShowEditBtn = session && session.id;
            let editBtn = null;
            
            if (shouldShowEditBtn) {
                editBtn = document.createElement('button');
                editBtn.className = 'session-edit-btn';
                editBtn.innerHTML = 'âœï¸';
                editBtn.title = 'ç¼–è¾‘æ ‡é¢˜';
                editBtn.style.cssText = `
                    background: none !important;
                    border: none !important;
                    cursor: pointer !important;
                    padding: 2px 4px !important;
                    font-size: 12px !important;
                    opacity: 0.6 !important;
                    transition: opacity 0.2s ease !important;
                    line-height: 1 !important;
                    flex-shrink: 0 !important;
                `;
                
                // æŒ‰é’®æ‚¬åœæ—¶å¢åŠ ä¸é€æ˜åº¦
                editBtn.addEventListener('mouseenter', () => {
                    editBtn.style.opacity = '1';
                });
                editBtn.addEventListener('mouseleave', () => {
                    editBtn.style.opacity = '0.6';
                });
                
                // é˜»æ­¢ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° sessionItem
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.editSessionTitle(session.id);
                });
            }
            
            // åˆ›å»ºæ ‡ç­¾ç®¡ç†æŒ‰é’®
            const tagBtn = document.createElement('button');
            tagBtn.className = 'session-tag-btn';
            tagBtn.innerHTML = 'ğŸ·ï¸';
            tagBtn.title = 'ç®¡ç†æ ‡ç­¾';
            tagBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 2px 4px !important;
                font-size: 12px !important;
                opacity: 0.6 !important;
                transition: opacity 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
            `;
            
            // æŒ‰é’®æ‚¬åœæ—¶å¢åŠ ä¸é€æ˜åº¦
            tagBtn.addEventListener('mouseenter', () => {
                tagBtn.style.opacity = '1';
            });
            tagBtn.addEventListener('mouseleave', () => {
                tagBtn.style.opacity = '0.6';
            });
            
            // é˜»æ­¢æ ‡ç­¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° sessionItem
            tagBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.openTagManager(session.id);
            });
            
            // åˆ›å»ºå‰¯æœ¬æŒ‰é’®
            const duplicateBtn = document.createElement('button');
            duplicateBtn.className = 'session-duplicate-btn';
            duplicateBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            `;
            duplicateBtn.title = 'åˆ›å»ºå‰¯æœ¬';
            duplicateBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 4px !important;
                opacity: 0.6 !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: inherit !important;
                border-radius: 4px !important;
            `;
            
            // æŒ‰é’®æ‚¬åœæ—¶å¢åŠ ä¸é€æ˜åº¦å’ŒèƒŒæ™¯è‰²
            duplicateBtn.addEventListener('mouseenter', () => {
                duplicateBtn.style.opacity = '1';
                duplicateBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
            });
            duplicateBtn.addEventListener('mouseleave', () => {
                duplicateBtn.style.opacity = '0.6';
                duplicateBtn.style.background = 'none !important';
            });
            
            // é˜»æ­¢å‰¯æœ¬æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° sessionItem
            duplicateBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                await this.duplicateSession(session.id);
            });
            
            // åˆ›å»ºé¡µé¢ä¸Šä¸‹æ–‡æŒ‰é’®
            const contextBtn = document.createElement('button');
            contextBtn.className = 'session-context-btn';
            contextBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            `;
            contextBtn.title = 'é¡µé¢ä¸Šä¸‹æ–‡';
            contextBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 4px !important;
                opacity: 0.6 !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: inherit !important;
                border-radius: 4px !important;
            `;
            
            // æŒ‰é’®æ‚¬åœæ—¶å¢åŠ ä¸é€æ˜åº¦å’ŒèƒŒæ™¯è‰²
            contextBtn.addEventListener('mouseenter', () => {
                contextBtn.style.opacity = '1';
                contextBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
            });
            contextBtn.addEventListener('mouseleave', () => {
                contextBtn.style.opacity = '0.6';
                contextBtn.style.background = 'none !important';
            });
            
            // é˜»æ­¢é¡µé¢ä¸Šä¸‹æ–‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° sessionItem
            contextBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                // å…ˆæ¿€æ´»è¯¥ä¼šè¯
                if (session.id !== this.currentSessionId) {
                    await this.activateSession(session.id);
                }
                // ç¡®ä¿èŠå¤©çª—å£å·²æ‰“å¼€
                if (!this.chatWindow || !this.isChatOpen) {
                    await this.openChatWindow();
                }
                // æ‰“å¼€é¡µé¢ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨
                this.openContextEditor();
            });
            
            // åˆ›å»ºæ‰“å¼€URLæŒ‰é’®ï¼ˆå¦‚æœURLä»¥https://å¼€å¤´ï¼‰
            let openUrlBtn = null;
            if (session.url && session.url.startsWith('https://')) {
                openUrlBtn = document.createElement('button');
                openUrlBtn.className = 'session-open-url-btn';
                openUrlBtn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                `;
                openUrlBtn.title = 'åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€';
                openUrlBtn.style.cssText = `
                    background: none !important;
                    border: none !important;
                    cursor: pointer !important;
                    padding: 4px !important;
                    opacity: 0.6 !important;
                    transition: all 0.2s ease !important;
                    line-height: 1 !important;
                    flex-shrink: 0 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    color: inherit !important;
                    border-radius: 4px !important;
                `;
                
                // æŒ‰é’®æ‚¬åœæ—¶å¢åŠ ä¸é€æ˜åº¦å’ŒèƒŒæ™¯è‰²
                openUrlBtn.addEventListener('mouseenter', () => {
                    openUrlBtn.style.opacity = '1';
                    openUrlBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
                });
                openUrlBtn.addEventListener('mouseleave', () => {
                    openUrlBtn.style.opacity = '0.6';
                    openUrlBtn.style.background = 'none !important';
                });
                
                // é˜»æ­¢æ‰“å¼€URLæŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° sessionItem
                openUrlBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        // é€šè¿‡ background script åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€URL
                        const response = await chrome.runtime.sendMessage({
                            action: 'openLinkInNewTab',
                            url: session.url
                        });
                        if (response && response.success) {
                            console.log('URLå·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€:', session.url);
                        } else {
                            console.error('æ‰“å¼€URLå¤±è´¥:', response?.error || 'æœªçŸ¥é”™è¯¯');
                        }
                    } catch (error) {
                        console.error('æ‰“å¼€URLæ—¶å‡ºé”™:', error);
                        // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ window.open
                        window.open(session.url, '_blank');
                    }
                });
            }
            
            // åˆ›å»ºæŒ‰é’®å®¹å™¨ï¼ˆåœ¨æ ‡é¢˜è¡Œä¸­ï¼Œä½†é»˜è®¤éšè—ï¼Œæ‚¬åœæ—¶æ˜¾ç¤ºï¼‰
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 2px !important;
                opacity: 0 !important;
                transition: opacity 0.2s ease !important;
                flex-shrink: 0 !important;
            `;
            // åªæœ‰ç¼–è¾‘æŒ‰é’®å­˜åœ¨æ—¶æ‰æ·»åŠ 
            if (editBtn) {
                buttonContainer.appendChild(editBtn);
            }
            buttonContainer.appendChild(tagBtn);
            buttonContainer.appendChild(duplicateBtn);
            buttonContainer.appendChild(contextBtn);
            
            // å°†æ ‡é¢˜å’ŒæŒ‰é’®å®¹å™¨æ·»åŠ åˆ°æ ‡é¢˜è¡Œ
            titleRow.appendChild(buttonContainer);
            
            // æ‚¬åœæ•ˆæœï¼ˆå‚è€ƒæ–°é—»åˆ—è¡¨ï¼‰
            sessionItem.addEventListener('mouseenter', () => {
                if (!isActive) {
                    sessionItem.style.background = '#f9fafb !important';
                    sessionItem.style.borderColor = '#d1d5db !important';
                    sessionItem.style.transform = 'translateY(-1px)';
                    sessionItem.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1) !important';
                }
                buttonContainer.style.opacity = '1';
                footerButtonContainer.style.opacity = '1';
            });
            
            sessionItem.addEventListener('mouseleave', () => {
                if (!isActive) {
                    sessionItem.style.background = '#ffffff !important';
                    sessionItem.style.borderColor = '#e5e7eb !important';
                    sessionItem.style.transform = 'translateY(0)';
                    sessionItem.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05) !important';
                }
                buttonContainer.style.opacity = '0';
                footerButtonContainer.style.opacity = '0.6';
            });
            
            sessionInfo.appendChild(titleRow);
            
            // æè¿°ï¼ˆå¦‚æœæœ‰pageDescriptionï¼‰
            if (session.pageDescription && session.pageDescription.trim()) {
                const description = document.createElement('div');
                description.style.cssText = `
                    font-size: 12px !important;
                    color: #6b7280 !important;
                    margin-bottom: 8px !important;
                    line-height: 1.5 !important;
                    display: -webkit-box !important;
                    -webkit-line-clamp: 2 !important;
                    -webkit-box-orient: vertical !important;
                    overflow: hidden !important;
                `;
                description.textContent = session.pageDescription.trim();
                sessionInfo.appendChild(description);
            }
            
            // æ ‡ç­¾åŒºåŸŸï¼ˆå‚è€ƒæ–°é—»åˆ—è¡¨çš„æ ‡ç­¾æ ·å¼ï¼‰
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'session-tags';
            tagsContainer.style.cssText = `
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 4px !important;
                margin-bottom: 8px !important;
            `;
            // å¦‚æœæœ‰æ ‡ç­¾ï¼Œæ˜¾ç¤ºæ ‡ç­¾
            const tags = session.tags || [];
            if (tags.length > 0) {
                // è§„èŒƒåŒ–æ ‡ç­¾ï¼ˆtrimå¤„ç†ï¼Œä¸getAllTagsä¿æŒä¸€è‡´ï¼‰
                const normalizedTags = tags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                
                normalizedTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'session-tag-item';
                    tagElement.textContent = tag;
                    // æ ¹æ®æ ‡ç­¾å†…å®¹ç”Ÿæˆé¢œè‰²ï¼ˆä½¿ç”¨å“ˆå¸Œå‡½æ•°ç¡®ä¿ç›¸åŒæ ‡ç­¾é¢œè‰²ä¸€è‡´ï¼‰
                    const tagColor = this.getTagColor(tag);
                    tagElement.style.cssText = `
                        display: inline-block !important;
                        padding: 3px 10px !important;
                        background: ${tagColor.background} !important;
                        color: ${tagColor.text} !important;
                        border-radius: 12px !important;
                        font-size: 11px !important;
                        font-weight: 500 !important;
                        border: 1px solid ${tagColor.border} !important;
                        transition: all 0.2s ease !important;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
                    `;
                    // æ·»åŠ æ‚¬åœæ•ˆæœ
                    tagElement.addEventListener('mouseenter', () => {
                        tagElement.style.transform = 'translateY(-1px)';
                        tagElement.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                    });
                    tagElement.addEventListener('mouseleave', () => {
                        tagElement.style.transform = 'translateY(0)';
                        tagElement.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                    });
                    tagsContainer.appendChild(tagElement);
                });
            }
            sessionInfo.appendChild(tagsContainer);
            
            // åº•éƒ¨ä¿¡æ¯ï¼ˆæ—¶é—´å’Œæ“ä½œæŒ‰é’®ï¼‰
            const footer = document.createElement('div');
            footer.style.cssText = `
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                font-size: 11px !important;
                color: #9ca3af !important;
                margin-top: 8px !important;
            `;
            
            const time = document.createElement('span');
            const sessionTime = session.updatedAt || session.createdAt || 0;
            if (sessionTime) {
                const date = new Date(sessionTime);
                const now = new Date();
                const diff = now - date;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor(diff / (1000 * 60));
                
                if (days > 0) {
                    time.textContent = `${days}å¤©å‰`;
                } else if (hours > 0) {
                    time.textContent = `${hours}å°æ—¶å‰`;
                } else if (minutes > 0) {
                    time.textContent = `${minutes}åˆ†é’Ÿå‰`;
                } else {
                    time.textContent = 'åˆšåˆš';
                }
            } else {
                time.textContent = '';
            }
            footer.appendChild(time);
            
            // æ“ä½œæŒ‰é’®å®¹å™¨ï¼ˆç§»åŠ¨åˆ°footerä¸­ï¼‰
            const footerButtonContainer = document.createElement('div');
            footerButtonContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 4px !important;
                opacity: 0.6 !important;
                transition: opacity 0.2s ease !important;
            `;
            
            // ç¼–è¾‘æŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (editBtn) {
                footerButtonContainer.appendChild(editBtn);
            }
            
            // æ ‡ç­¾ç®¡ç†æŒ‰é’®
            footerButtonContainer.appendChild(tagBtn);
            
            // å‰¯æœ¬æŒ‰é’®
            footerButtonContainer.appendChild(duplicateBtn);
            
            // é¡µé¢ä¸Šä¸‹æ–‡æŒ‰é’®
            footerButtonContainer.appendChild(contextBtn);
            
            // æ‰“å¼€æ–°tabæŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (openUrlBtn) {
                footerButtonContainer.appendChild(openUrlBtn);
            }
            
            footer.appendChild(footerButtonContainer);
            
            sessionInfo.appendChild(footer);
            
            contentWrapper.appendChild(sessionInfo);
            itemInner.appendChild(contentWrapper);
            sessionItem.appendChild(itemInner);
            
            // é•¿æŒ‰åˆ é™¤ç›¸å…³å˜é‡
            let longPressTimer = null;
            let longPressProgressTimer = null;
            let longPressThreshold = 800; // é•¿æŒ‰æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
            let isLongPressing = false;
            let hasMoved = false;
            let startX = 0;
            let startY = 0;
            let longPressStartTime = 0;
            const moveThreshold = 10; // ç§»åŠ¨é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼åˆ™å–æ¶ˆé•¿æŒ‰
            
            // åˆ›å»ºé•¿æŒ‰è¿›åº¦æŒ‡ç¤ºå™¨
            const progressBar = document.createElement('div');
            progressBar.className = 'long-press-progress';
            progressBar.style.cssText = `
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                height: 3px !important;
                background: rgba(244, 67, 54, 0.8) !important;
                width: 0% !important;
                border-radius: 0 0 8px 8px !important;
                transition: width 0.05s linear !important;
                z-index: 10 !important;
            `;
            sessionItem.appendChild(progressBar);
            
            // åˆ›å»ºé•¿æŒ‰æç¤ºæ–‡æœ¬
            const hintText = document.createElement('div');
            hintText.className = 'long-press-hint';
            hintText.textContent = 'ç»§ç»­æŒ‰ä½ä»¥åˆ é™¤';
            hintText.style.cssText = `
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) scale(0) !important;
                background: rgba(244, 67, 54, 0.95) !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 6px !important;
                font-size: 12px !important;
                white-space: nowrap !important;
                pointer-events: none !important;
                z-index: 20 !important;
                opacity: 0 !important;
                transition: all 0.2s ease !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            `;
            sessionItem.appendChild(hintText);
            
            // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
            const clearLongPress = () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                if (longPressProgressTimer) {
                    clearInterval(longPressProgressTimer);
                    longPressProgressTimer = null;
                }
                if (isLongPressing) {
                    sessionItem.classList.remove('long-pressing', 'long-press-start', 
                        'long-press-stage-1', 'long-press-stage-2', 'long-press-stage-3');
                    isLongPressing = false;
                } else {
                    // å³ä½¿æ²¡æœ‰å®Œæˆé•¿æŒ‰ï¼Œä¹Ÿè¦æ¸…é™¤å¼€å§‹çŠ¶æ€å’Œé˜¶æ®µçŠ¶æ€
                    sessionItem.classList.remove('long-press-start', 
                        'long-press-stage-1', 'long-press-stage-2', 'long-press-stage-3');
                }
                hasMoved = false;
                progressBar.style.width = '0%';
                hintText.style.opacity = '0';
                hintText.style.transform = 'translate(-50%, -50%) scale(0)';
                longPressStartTime = 0;
            };
            
            // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
            const triggerHapticFeedback = () => {
                if ('vibrate' in navigator) {
                    navigator.vibrate(50); // çŸ­éœ‡åŠ¨
                }
            };
            
            // å¼€å§‹é•¿æŒ‰æ£€æµ‹
            const startLongPress = (e) => {
                // å¦‚æœæ­£åœ¨åˆ‡æ¢ä¼šè¯ï¼Œå¿½ç•¥
                if (this.isSwitchingSession) {
                    return;
                }
                
                hasMoved = false;
                startX = e.touches ? e.touches[0].clientX : e.clientX;
                startY = e.touches ? e.touches[0].clientY : e.clientY;
                longPressStartTime = Date.now();
                
                // æ·»åŠ å¼€å§‹é•¿æŒ‰çš„è§†è§‰åé¦ˆ
                sessionItem.classList.add('long-press-start');
                
                // æ˜¾ç¤ºæç¤ºæ–‡æœ¬ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…ç«‹å³æ˜¾ç¤ºï¼‰
                setTimeout(() => {
                    if (longPressStartTime && !hasMoved) {
                        hintText.style.opacity = '1';
                        hintText.style.transform = 'translate(-50%, -50%) scale(1)';
                    }
                }, 200);
                
                // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
                let lastStage = 0;
                const progressInterval = 50; // æ¯50msæ›´æ–°ä¸€æ¬¡
                longPressProgressTimer = setInterval(() => {
                    if (hasMoved || !longPressStartTime) {
                        clearInterval(longPressProgressTimer);
                        return;
                    }
                    
                    const elapsed = Date.now() - longPressStartTime;
                    const progress = Math.min((elapsed / longPressThreshold) * 100, 100);
                    progressBar.style.width = progress + '%';
                    
                    // åœ¨ä¸åŒé˜¶æ®µæ·»åŠ åé¦ˆï¼ˆç¡®ä¿æ¯ä¸ªé˜¶æ®µåªè§¦å‘ä¸€æ¬¡ï¼‰
                    if (progress >= 30 && progress < 35 && lastStage < 1) {
                        sessionItem.classList.add('long-press-stage-1');
                        lastStage = 1;
                    } else if (progress >= 60 && progress < 65 && lastStage < 2) {
                        sessionItem.classList.remove('long-press-stage-1');
                        sessionItem.classList.add('long-press-stage-2');
                        lastStage = 2;
                        triggerHapticFeedback(); // ä¸­æœŸéœ‡åŠ¨
                    } else if (progress >= 90 && progress < 95 && lastStage < 3) {
                        sessionItem.classList.remove('long-press-stage-2');
                        sessionItem.classList.add('long-press-stage-3');
                        lastStage = 3;
                        triggerHapticFeedback(); // æ¥è¿‘å®Œæˆæ—¶çš„éœ‡åŠ¨
                    }
                    
                    if (progress >= 100) {
                        clearInterval(longPressProgressTimer);
                    }
                }, progressInterval);
                
                longPressTimer = setTimeout(async () => {
                    if (!hasMoved) {
                        isLongPressing = true;
                        sessionItem.classList.add('long-pressing');
                        triggerHapticFeedback(); // è§¦å‘åˆ é™¤å‰çš„éœ‡åŠ¨
                        
                        // è·å–ä¼šè¯æ ‡é¢˜ç”¨äºæç¤º
                        const sessionTitle = session?.pageTitle || session.id || 'æœªå‘½åä¼šè¯';
                        
                        // ç¡®è®¤åˆ é™¤
                        const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤ä¼šè¯"${sessionTitle}"å—ï¼Ÿ`);
                        if (!confirmDelete) {
                            // ç”¨æˆ·å–æ¶ˆåˆ é™¤ï¼Œæ¸…é™¤é•¿æŒ‰çŠ¶æ€
                            clearLongPress();
                            return;
                        }
                        
                        // è§¦å‘åˆ é™¤ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œåˆ é™¤å®Œæˆåæ¸…é™¤çŠ¶æ€ï¼‰
                        try {
                            await this.deleteSession(session.id, true); // ä¼ å…¥ true è·³è¿‡ç¡®è®¤å¼¹æ¡†
                        } catch (error) {
                            console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
                        } finally {
                            // æ¸…é™¤é•¿æŒ‰çŠ¶æ€
                            clearLongPress();
                        }
                    }
                }, longPressThreshold);
            };
            
            // ç»“æŸé•¿æŒ‰æ£€æµ‹
            const endLongPress = () => {
                clearLongPress();
            };
            
            // ç§»åŠ¨æ£€æµ‹ï¼ˆå–æ¶ˆé•¿æŒ‰ï¼‰
            const handleMove = (e) => {
                const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                const currentY = e.touches ? e.touches[0].clientY : e.clientY;
                const deltaX = Math.abs(currentX - startX);
                const deltaY = Math.abs(currentY - startY);
                
                if (deltaX > moveThreshold || deltaY > moveThreshold) {
                    hasMoved = true;
                    clearLongPress();
                }
            };
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            sessionItem.addEventListener('touchstart', (e) => {
                startLongPress(e);
            }, { passive: true });
            
            sessionItem.addEventListener('touchmove', (e) => {
                handleMove(e);
            }, { passive: true });
            
            sessionItem.addEventListener('touchend', () => {
                endLongPress();
            }, { passive: true });
            
            sessionItem.addEventListener('touchcancel', () => {
                endLongPress();
            }, { passive: true });
            
            // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢è®¾å¤‡ï¼‰
            sessionItem.addEventListener('mousedown', (e) => {
                startLongPress(e);
            });
            
            sessionItem.addEventListener('mousemove', (e) => {
                if (longPressTimer) {
                    handleMove(e);
                }
            });
            
            sessionItem.addEventListener('mouseup', () => {
                endLongPress();
            });
            
            sessionItem.addEventListener('mouseleave', () => {
                endLongPress();
            });
            
            // ç‚¹å‡»ä¼šè¯é¡¹åˆ‡æ¢åˆ°è¯¥ä¼šè¯
            sessionItem.addEventListener('click', async (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†ï¼Œä¸æ‰§è¡Œåˆ‡æ¢æ“ä½œ
                if (e.target.type === 'checkbox' || e.target.closest('.session-checkbox')) {
                    return;
                }
                
                // å¦‚æœæ­£åœ¨é•¿æŒ‰ï¼Œä¸æ‰§è¡Œç‚¹å‡»
                if (isLongPressing || hasMoved) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                // å¦‚æœæ­£åœ¨åˆ‡æ¢ï¼Œå¿½ç•¥ç‚¹å‡»
                if (this.isSwitchingSession) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                // æ‰¹é‡æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                if (this.batchMode) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                    return;
                }
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰ä¼šè¯ï¼ŒæŸ¥æ‰¾å¹¶åˆ‡æ¢åˆ° URL ä¸º https://effiy.cn/ çš„ä¼šè¯
                if (session.id === this.currentSessionId) {
                    // æ·»åŠ ç‚¹å‡»åé¦ˆ
                    sessionItem.classList.add('clicked');
                    
                    // æŸ¥æ‰¾ URL ä¸º https://effiy.cn/ çš„ä¼šè¯
                    const targetUrl = 'https://effiy.cn/';
                    const targetSession = this.findSessionByUrl(targetUrl);
                    
                    if (targetSession && targetSession.id) {
                        // æ‰¾åˆ°ç›®æ ‡ä¼šè¯ï¼Œåˆ‡æ¢åˆ°è¯¥ä¼šè¯
                        sessionItem.style.pointerEvents = 'none';
                        try {
                            await this.switchSession(targetSession.id);
                        } catch (error) {
                            console.error('åˆ‡æ¢ä¼šè¯å¤±è´¥:', error);
                            sessionItem.classList.remove('switching', 'clicked');
                        } finally {
                            setTimeout(() => {
                                sessionItem.style.pointerEvents = '';
                                sessionItem.classList.remove('clicked');
                            }, 300);
                        }
                    } else {
                        // æœªæ‰¾åˆ°ç›®æ ‡ä¼šè¯ï¼Œåªæ·»åŠ è§†è§‰åé¦ˆ
                        setTimeout(() => {
                            sessionItem.classList.remove('clicked');
                        }, 150);
                    }
                    return;
                }
                
                // ç«‹å³æ·»åŠ ç‚¹å‡»åé¦ˆ
                sessionItem.classList.add('clicked');
                
                // é˜²æ­¢é‡å¤ç‚¹å‡»ï¼šå¿«é€Ÿç¦ç”¨
                sessionItem.style.pointerEvents = 'none';
                
                try {
                    // åˆ‡æ¢ä¼šè¯
                    await this.switchSession(session.id);
                } catch (error) {
                    console.error('åˆ‡æ¢ä¼šè¯å¤±è´¥:', error);
                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    sessionItem.classList.remove('switching', 'clicked');
                } finally {
                    // æ¢å¤äº¤äº’ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…è¿‡å¿«é‡å¤ç‚¹å‡»ï¼‰
                    setTimeout(() => {
                        sessionItem.style.pointerEvents = '';
                        sessionItem.classList.remove('clicked');
                    }, 300);
                }
            });
            
            sessionList.appendChild(sessionItem);
        }
        
        console.log('ä¼šè¯ä¾§è¾¹æ å·²æ›´æ–°ï¼Œæ˜¾ç¤º', sortedSessions.length, 'ä¸ªä¼šè¯');
    }
    
    /**
     * ç”ŸæˆOSSå›¾ç‰‡å¤„ç†URL
     * å‚è€ƒï¼šhttps://help.aliyun.com/zh/oss/user-guide/overview-17/
     * @param {string} originalUrl - åŸå§‹å›¾ç‰‡URL
     * @param {Object} options - å¤„ç†é€‰é¡¹
     * @param {number} options.width - ç›®æ ‡å®½åº¦ï¼ˆåƒç´ ï¼‰
     * @param {number} options.height - ç›®æ ‡é«˜åº¦ï¼ˆåƒç´ ï¼‰
     * @param {number} options.quality - å›¾ç‰‡è´¨é‡ï¼ˆ1-100ï¼Œé»˜è®¤80ï¼‰
     * @param {string} options.format - è¾“å‡ºæ ¼å¼ï¼ˆwebp, jpg, pngç­‰ï¼Œé»˜è®¤ä¸è½¬æ¢ï¼‰
     * @param {boolean} options.keepAspectRatio - æ˜¯å¦ä¿æŒå®½é«˜æ¯”ï¼ˆé»˜è®¤trueï¼‰
     * @returns {string} å¤„ç†åçš„å›¾ç‰‡URL
     */
    generateOssImageProcessUrl(originalUrl, options = {}) {
        if (!originalUrl) {
            return originalUrl;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯OSS URLï¼ˆæ”¯æŒå¤šç§OSS URLæ ¼å¼ï¼‰
        // æ ¼å¼1: https://bucket-name.oss-cn-hangzhou.aliyuncs.com/path
        // æ ¼å¼2: https://oss-cn-hangzhou.aliyuncs.com/bucket-name/path
        // æ ¼å¼3: è‡ªå®šä¹‰åŸŸåä½†åŒ…å«.oss.æ ‡è¯†
        const isOssUrl = /oss[-a-z0-9]*\.aliyuncs\.com/i.test(originalUrl) || 
                        /\.oss\./i.test(originalUrl) ||
                        /aliyuncs\.com/i.test(originalUrl);
        
        if (!isOssUrl) {
            // ä¸æ˜¯OSS URLï¼Œç›´æ¥è¿”å›åŸURL
            return originalUrl;
        }
        
        const {
            width,
            height,
            quality = 80,
            format = null,
            keepAspectRatio = true
        } = options;
        
        // æ„å»ºå›¾ç‰‡å¤„ç†å‚æ•°
        const params = [];
        
        // ç¼©æ”¾å‚æ•°
        if (width || height) {
            let resizeParam = 'resize';
            if (width && height) {
                if (keepAspectRatio) {
                    // ä¿æŒå®½é«˜æ¯”ï¼Œä½¿ç”¨m_lfitæ¨¡å¼
                    resizeParam += `,m_lfit,w_${width},h_${height}`;
                } else {
                    // ä¸ä¿æŒå®½é«˜æ¯”ï¼Œå›ºå®šå°ºå¯¸
                    resizeParam += `,w_${width},h_${height}`;
                }
            } else if (width) {
                resizeParam += `,w_${width}`;
            } else if (height) {
                resizeParam += `,h_${height}`;
            }
            params.push(resizeParam);
        }
        
        // è´¨é‡å‚æ•°ï¼ˆä»…å¯¹JPGå’ŒWebPæœ‰æ•ˆï¼‰
        if (quality && quality < 100) {
            params.push(`quality,q_${quality}`);
        }
        
        // æ ¼å¼è½¬æ¢
        if (format && ['webp', 'jpg', 'jpeg', 'png'].includes(format.toLowerCase())) {
            params.push(`format,${format.toLowerCase()}`);
        }
        
        // å¦‚æœæ²¡æœ‰å¤„ç†å‚æ•°ï¼Œè¿”å›åŸURL
        if (params.length === 0) {
            return originalUrl;
        }
        
        // æ„å»ºå®Œæ•´çš„å¤„ç†URL
        const processParam = `x-oss-process=image/${params.join('/')}`;
        const separator = originalUrl.includes('?') ? '&' : '?';
        return `${originalUrl}${separator}${processParam}`;
    }
    
    // æ›´æ–°OSSæ–‡ä»¶åˆ—è¡¨ä¾§è¾¹æ 
    async updateOssFileSidebar(forceRefresh = false) {
        if (!this.sessionSidebar) {
            console.log('ä¾§è¾¹æ æœªåˆ›å»ºï¼Œè·³è¿‡æ›´æ–°');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥
        const wasOssFileListVisible = this.ossFileListVisible;
        const wasNewsListVisible = this.newsListVisible;
        
        // ç¡®ä¿è§†å›¾æ¨¡å¼çŠ¶æ€æ­£ç¡®
        this.ossFileListVisible = true;
        this.newsListVisible = false;
        this.apiRequestListVisible = false;
        
        // å¦‚æœè§†å›¾çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥ï¼‰ï¼Œæ¸…ç©ºèŠå¤©æ¶ˆæ¯
        if (!wasOssFileListVisible) {
            this.clearChatMessages();
        }
        
        // éšè—ä¼šè¯åˆ—è¡¨ç›¸å…³å…ƒç´ 
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        const tagFilterContainer = this.sessionSidebar.querySelector('.tag-filter-container');
        const batchToolbar = this.sessionSidebar.querySelector('#batch-toolbar');
        const scrollableContent = this.sessionSidebar.querySelector('.session-sidebar-scrollable-content');
        const newsList = this.sessionSidebar.querySelector('.news-list');
        
        if (sessionList) {
            sessionList.style.display = 'none';
        }
        if (tagFilterContainer) {
            tagFilterContainer.style.display = 'none';
        }
        if (scrollableContent) {
            scrollableContent.style.display = 'none';
        }
        if (newsList) {
            newsList.style.display = 'none';
        }
        const newsTagFilterContainer = this.sessionSidebar.querySelector('.news-tag-filter-container');
        if (newsTagFilterContainer) {
            newsTagFilterContainer.style.display = 'none';
        }
        
        // éšè—æ¥å£è¯·æ±‚åˆ—è¡¨
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        if (apiRequestList) {
            apiRequestList.style.display = 'none';
        }
        
        // éšè—è¯·æ±‚æ¥å£æ ‡ç­¾è¿‡æ»¤å™¨ï¼ˆåªåœ¨è¯·æ±‚æ¥å£è§†å›¾ä¸­æ˜¾ç¤ºï¼‰
        const apiRequestTagFilterContainer = this.sessionSidebar.querySelector('.api-request-tag-filter-container');
        if (apiRequestTagFilterContainer) {
            apiRequestTagFilterContainer.style.display = 'none';
        }
        
        // æ‰¹é‡å·¥å…·æ åœ¨æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤º
        if (batchToolbar && this.batchMode) {
            batchToolbar.style.display = 'flex';
        } else if (batchToolbar) {
            batchToolbar.style.display = 'none';
        }
        
        // æ˜¾ç¤ºOSSæ ‡ç­¾ç­›é€‰å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const ossTagFilterContainer = this.sessionSidebar.querySelector('.oss-tag-filter-container');
        if (ossTagFilterContainer) {
            ossTagFilterContainer.style.display = 'block';
        } else {
            // åˆ›å»ºOSSæ ‡ç­¾ç­›é€‰å™¨
            await this.createOssTagFilter();
        }
        
        // è·å–æˆ–åˆ›å»ºOSSæ–‡ä»¶åˆ—è¡¨å®¹å™¨
        let ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        if (!ossFileList) {
            ossFileList = document.createElement('div');
            ossFileList.className = 'oss-file-list';
            ossFileList.style.cssText = `
                flex: 1 !important;
                overflow-y: auto !important;
                padding: 8px 8px 220px 8px !important;
                scroll-padding-bottom: 20px !important;
                box-sizing: border-box !important;
            `;
            this.sessionSidebar.appendChild(ossFileList);
        }
        // ç¡®ä¿æ»šåŠ¨æ¡éšè—æ ·å¼å·²åº”ç”¨ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰åˆ›å»ºï¼‰
        if (!document.getElementById('hide-scrollbar-style')) {
            const hideScrollbarStyle = document.createElement('style');
            hideScrollbarStyle.id = 'hide-scrollbar-style';
            hideScrollbarStyle.textContent = `
                .session-sidebar-scrollable-content::-webkit-scrollbar,
                .oss-file-list::-webkit-scrollbar,
                .news-list::-webkit-scrollbar,
                .api-request-list::-webkit-scrollbar {
                    display: none !important;
                    width: 0 !important;
                    height: 0 !important;
                }
                .session-sidebar-scrollable-content,
                .oss-file-list,
                .news-list,
                .api-request-list {
                    -ms-overflow-style: none !important;
                    scrollbar-width: none !important;
                }
            `;
            document.head.appendChild(hideScrollbarStyle);
        }
        ossFileList.style.display = 'block';
        
        // æ›´æ–°æœç´¢æ¡†å ä½ç¬¦
        const searchInput = this.sessionSidebar.querySelector('#session-search-input');
        if (searchInput) {
            searchInput.placeholder = 'æœç´¢æ–‡ä»¶...';
        }
        
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒæ ‡ç­¾ç­›é€‰ï¼‰
        // ä¼˜åŒ–ï¼šé»˜è®¤ä¸è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡åˆ‡æ¢æ–‡ä»¶è§†å›¾æ—¶æ‰è¯·æ±‚
        try {
            if (this.ossFileManager && this.ossApi) {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ‡æ¢æ–‡ä»¶è§†å›¾ï¼Œæˆ–è€…å¼ºåˆ¶åˆ·æ–°ï¼Œåˆ™è¯·æ±‚æ–‡ä»¶åˆ—è¡¨
                if (!this.hasRequestedFiles || forceRefresh) {
                    const filterTags = this.selectedOssFilterTags && this.selectedOssFilterTags.length > 0 
                        ? this.selectedOssFilterTags 
                        : null;
                    await this.ossFileManager.loadBackendFiles(forceRefresh, filterTags);
                    this.hasRequestedFiles = true; // æ ‡è®°å·²è¯·æ±‚è¿‡
                }
            }
        } catch (error) {
            console.warn('åŠ è½½OSSæ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        }
        
        let files = this.ossFileManager ? this.ossFileManager.getAllFiles() : [];
        
        // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤æ–‡ä»¶ï¼ˆæœç´¢æ–‡ä»¶åï¼‰
        if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
            const filterKeyword = this.sessionTitleFilter.trim().toLowerCase();
            files = files.filter(file => {
                const fileName = (file.name || '').toLowerCase();
                return fileName.includes(filterKeyword);
            });
        }
        
        // åº”ç”¨æ—¥æœŸåŒºé—´è¿‡æ»¤
        if (this.dateRangeFilter) {
            if (this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // æœ‰å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼šç­›é€‰åŒºé—´å†…çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const endDate = this.dateRangeFilter.endDate;
                const startTime = startDate.getTime();
                const endTime = endDate.getTime() + 24 * 60 * 60 * 1000 - 1; // åŒ…å«ç»“æŸæ—¥æœŸçš„æ•´å¤©
                
                files = files.filter(file => {
                    const fileTime = file.last_modified || file.created_at || 0;
                    return fileTime >= startTime && fileTime <= endTime;
                });
            } else if (this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
                // åªæœ‰å¼€å§‹æ—¥æœŸï¼šç­›é€‰å¼€å§‹æ—¥æœŸå½“å¤©çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const startTime = startDate.getTime();
                const endTime = startTime + 24 * 60 * 60 * 1000 - 1; // åŒ…å«å¼€å§‹æ—¥æœŸçš„æ•´å¤©
                
                files = files.filter(file => {
                    const fileTime = file.last_modified || file.created_at || 0;
                    return fileTime >= startTime && fileTime <= endTime;
                });
            } else if (!this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // åªæœ‰ç»“æŸæ—¥æœŸï¼šç­›é€‰ç»“æŸæ—¥æœŸä¹‹å‰çš„è®°å½•
                const endDate = this.dateRangeFilter.endDate;
                const endTime = endDate.getTime(); // ä¸åŒ…å«ç»“æŸæ—¥æœŸå½“å¤©
                
                files = files.filter(file => {
                    const fileTime = file.last_modified || file.created_at || 0;
                    return fileTime < endTime;
                });
            }
        }
        
        // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰
        if (this.ossTagFilterNoTags) {
            files = files.filter(file => {
                const fileTags = file.tags || [];
                const hasTags = fileTags.length > 0 && fileTags.some(tag => tag && tag.trim().length > 0);
                return !hasTags; // åªæ˜¾ç¤ºæ²¡æœ‰æ ‡ç­¾çš„æ–‡ä»¶
            });
        }
        
        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤ï¼ˆå¦‚æœåç«¯æ²¡æœ‰ç­›é€‰ï¼Œåˆ™åœ¨å‰ç«¯ç­›é€‰ï¼‰
        if (this.selectedOssFilterTags && this.selectedOssFilterTags.length > 0) {
            files = files.filter(file => {
                const fileTags = file.tags || [];
                const hasSelectedTags = this.selectedOssFilterTags.some(selectedTag => 
                    fileTags.includes(selectedTag)
                );
                
                if (this.ossTagFilterReverse) {
                    // åå‘è¿‡æ»¤ï¼šæ’é™¤åŒ…å«é€‰ä¸­æ ‡ç­¾çš„æ–‡ä»¶
                    return !hasSelectedTags;
                } else {
                    // æ­£å‘è¿‡æ»¤ï¼šåªæ˜¾ç¤ºåŒ…å«é€‰ä¸­æ ‡ç­¾çš„æ–‡ä»¶
                    return hasSelectedTags;
                }
            });
        }
        
        // æ¸…ç©ºåˆ—è¡¨
        ossFileList.innerHTML = '';
        
        if (files.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.style.cssText = `
                padding: 20px !important;
                text-align: center !important;
                color: #9ca3af !important;
                font-size: 12px !important;
            `;
            emptyMsg.textContent = this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '' ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶' : 'æš‚æ— æ–‡ä»¶';
            ossFileList.appendChild(emptyMsg);
            return;
        }
        
        // æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        const sortedFiles = files.sort((a, b) => {
            const aTime = a.last_modified || 0;
            const bTime = b.last_modified || 0;
            return bTime - aTime;
        });
        
        // åˆ›å»ºæ–‡ä»¶åˆ—è¡¨é¡¹
        for (const file of sortedFiles) {
            const fileItem = document.createElement('div');
            fileItem.className = 'oss-file-item';
            fileItem.dataset.fileName = file.name;
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»ï¼šæ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦æ˜¯è¯¥OSSæ–‡ä»¶çš„ä¼šè¯
            // å¦‚æœå½“å‰ä¼šè¯æ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œä¸”æ–‡ä»¶URLå¯¹åº”çš„ä¼šè¯IDä¸å½“å‰ä¼šè¯IDåŒ¹é…ï¼Œåˆ™è®¾ç½®ä¸ºactive
            let isActive = false;
            if (this.currentSessionId) {
                const currentSession = this.sessions[this.currentSessionId];
                if (currentSession && currentSession._isOssFileSession && currentSession._ossFileInfo) {
                    // å½“å‰ä¼šè¯æ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œæ£€æŸ¥æ–‡ä»¶URLæ˜¯å¦åŒ¹é…
                    if (currentSession._ossFileInfo.url === file.url) {
                        isActive = true;
                        fileItem.classList.add('active');
                        this.currentFile = file.name; // åŒæ­¥æ›´æ–°currentFile
                    }
                } else if (file.name === this.currentFile) {
                    // å…¼å®¹æ—§é€»è¾‘ï¼šå¦‚æœcurrentFileå·²è®¾ç½®ï¼Œä¹Ÿè®¾ç½®ä¸ºactive
                    isActive = true;
                    fileItem.classList.add('active');
                }
            } else if (file.name === this.currentFile) {
                // å…¼å®¹æ—§é€»è¾‘ï¼šå¦‚æœcurrentFileå·²è®¾ç½®ï¼Œä¹Ÿè®¾ç½®ä¸ºactive
                isActive = true;
                fileItem.classList.add('active');
            }
            
            // æ‰¹é‡æ¨¡å¼ä¸‹æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»
            if (this.batchMode && this.selectedFileNames.has(file.name)) {
                fileItem.classList.add('selected');
            }
            
            // è®¾ç½®åŸºç¡€æ ·å¼ï¼ŒactiveçŠ¶æ€ä½¿ç”¨ä¸åŒçš„èƒŒæ™¯è‰²å’Œè¾¹æ¡†
            fileItem.style.cssText = `
                padding: 12px !important;
                margin-bottom: 6px !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
                background: ${isActive ? '#e0e7ff' : '#f9fafb'} !important;
                border: 1px solid ${isActive ? '#6366f1' : 'transparent'} !important;
                display: flex !important;
                align-items: flex-start !important;
                gap: 8px !important;
                position: relative !important;
                user-select: none !important;
            `;
            
            // åˆ›å»ºå¤é€‰æ¡†ï¼ˆä»…åœ¨æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'oss-file-checkbox';
            checkbox.dataset.fileName = file.name;
            checkbox.checked = this.selectedFileNames.has(file.name);
            checkbox.style.cssText = `
                width: 16px !important;
                height: 16px !important;
                cursor: pointer !important;
                margin-right: 8px !important;
                flex-shrink: 0 !important;
                display: ${this.batchMode ? 'block' : 'none'} !important;
            `;
            
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                const fileName = e.target.dataset.fileName;
                if (e.target.checked) {
                    this.selectedFileNames.add(fileName);
                    fileItem.classList.add('selected');
                } else {
                    this.selectedFileNames.delete(fileName);
                    fileItem.classList.remove('selected');
                }
                this.updateBatchToolbar();
            });
            
            // é˜»æ­¢å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶å†’æ³¡
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // åˆ›å»ºé¢„è§ˆå¤´åƒï¼ˆåœ¨æ–‡ä»¶é¡¹æœ€å·¦è¾¹ï¼‰
            const previewAvatar = document.createElement('div');
            previewAvatar.className = 'oss-file-preview-avatar';
            previewAvatar.style.cssText = `
                width: 48px !important;
                height: 48px !important;
                border-radius: 10px !important;
                flex-shrink: 0 !important;
                margin-right: 10px !important;
                cursor: pointer !important;
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                overflow: hidden !important;
                position: relative !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                border: 2px solid transparent !important;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
            `;
            
            // åˆ¤æ–­æ–‡ä»¶ç±»å‹å¹¶è®¾ç½®é¢„è§ˆå¤´åƒ
            const fileName = file.name || '';
            const ext = fileName.toLowerCase().substring(fileName.lastIndexOf('.'));
            const isImage = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'].includes(ext);
            
            // å¦‚æœæ˜¯å›¾ç‰‡ä¸”è¯¥æ–‡ä»¶çš„é¢„è§ˆå¼€å…³å·²å¼€å¯ï¼Œå°è¯•åŠ è½½é¢„è§ˆå›¾
            const filePreviewEnabled = this.getFilePreviewEnabled(file.name);
            if (isImage && file.url && filePreviewEnabled) {
                // æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
                const loadingIndicator = document.createElement('div');
                loadingIndicator.style.cssText = `
                    position: absolute !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    width: 16px !important;
                    height: 16px !important;
                    border: 2px solid #d1d5db !important;
                    border-top-color: #6366f1 !important;
                    border-radius: 50% !important;
                    animation: spin 0.6s linear infinite !important;
                `;
                
                // æ·»åŠ æ—‹è½¬åŠ¨ç”»
                if (!document.getElementById('preview-avatar-spin-style')) {
                    const style = document.createElement('style');
                    style.id = 'preview-avatar-spin-style';
                    style.textContent = `
                        @keyframes spin {
                            to { transform: translate(-50%, -50%) rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                previewAvatar.appendChild(loadingIndicator);
                
                const img = document.createElement('img');
                img.style.cssText = `
                    width: 100% !important;
                    height: 100% !important;
                    object-fit: cover !important;
                    opacity: 0 !important;
                    transition: opacity 0.3s ease !important;
                `;
                img.alt = fileName;
                
                // å›¾ç‰‡åŠ è½½æˆåŠŸ
                img.onload = () => {
                    loadingIndicator.style.display = 'none';
                    img.style.opacity = '1';
                };
                
                // å›¾ç‰‡åŠ è½½å¤±è´¥
                img.onerror = () => {
                    loadingIndicator.style.display = 'none';
                    previewAvatar.innerHTML = 'ğŸ–¼ï¸';
                    previewAvatar.style.fontSize = '20px';
                    previewAvatar.style.background = '#f3f4f6';
                };
                
                // ä½¿ç”¨OSSå›¾ç‰‡å¤„ç†ç”Ÿæˆæè‡´ä¼˜åŒ–çš„ç¼©ç•¥å›¾ï¼ˆ48x48ï¼Œè´¨é‡40ï¼ŒWebPæ ¼å¼ï¼‰
                // æè‡´èŠ‚çœæµé‡ï¼šå°ºå¯¸åŒ¹é…æ˜¾ç¤ºå¤§å°ï¼Œä½è´¨é‡ï¼ŒWebPæ ¼å¼å‹ç¼©
                const thumbnailUrl = this.generateOssImageProcessUrl(file.url, {
                    width: 48,
                    height: 48,
                    quality: 40,
                    format: 'webp',
                    keepAspectRatio: true
                });
                
                // ä½¿ç”¨æ‡’åŠ è½½ï¼šåªåœ¨å›¾ç‰‡è¿›å…¥è§†å£æ—¶åŠ è½½ï¼ˆæè‡´èŠ‚çœæµé‡ï¼‰
                if ('IntersectionObserver' in window) {
                    // æ”¯æŒ Intersection Observerï¼Œä½¿ç”¨æ‡’åŠ è½½
                    const imageObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                // å›¾ç‰‡è¿›å…¥è§†å£ï¼Œå¼€å§‹åŠ è½½
                                img.src = thumbnailUrl;
                                observer.unobserve(entry.target);
                            }
                        });
                    }, {
                        rootMargin: '50px' // æå‰50pxå¼€å§‹åŠ è½½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
                    });
                    
                    // å…ˆä¸è®¾ç½®srcï¼Œç­‰è¿›å…¥è§†å£å†åŠ è½½
                    imageObserver.observe(previewAvatar);
                } else {
                    // ä¸æ”¯æŒ Intersection Observerï¼Œç›´æ¥åŠ è½½ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
                    img.src = thumbnailUrl;
                }
                
                previewAvatar.appendChild(img);
            } else {
                // éå›¾ç‰‡æ–‡ä»¶ï¼Œæˆ–å›¾ç‰‡ä½†é¢„è§ˆå¼€å…³å…³é—­ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                const iconMap = {
                    '.jpg': 'ğŸ–¼ï¸',
                    '.jpeg': 'ğŸ–¼ï¸',
                    '.png': 'ğŸ–¼ï¸',
                    '.gif': 'ğŸ–¼ï¸',
                    '.webp': 'ğŸ–¼ï¸',
                    '.bmp': 'ğŸ–¼ï¸',
                    '.pdf': 'ğŸ“„',
                    '.doc': 'ğŸ“',
                    '.docx': 'ğŸ“',
                    '.zip': 'ğŸ“¦',
                    '.rar': 'ğŸ“¦',
                    '.7z': 'ğŸ“¦',
                };
                previewAvatar.innerHTML = iconMap[ext] || 'ğŸ“„';
                previewAvatar.style.fontSize = '20px';
            }
            
            // é¢„è§ˆå¤´åƒæ‚¬åœæ•ˆæœ
            previewAvatar.addEventListener('mouseenter', () => {
                previewAvatar.style.transform = 'scale(1.08)';
                previewAvatar.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                previewAvatar.style.borderColor = '#6366f1';
            });
            previewAvatar.addEventListener('mouseleave', () => {
                previewAvatar.style.transform = 'scale(1)';
                previewAvatar.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                previewAvatar.style.borderColor = 'transparent';
            });
            
            // ç‚¹å‡»é¢„è§ˆå¤´åƒï¼Œé¢„è§ˆæ–‡ä»¶URLå†…å®¹
            previewAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                if (file.url) {
                    // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œåˆ›å»ºé¢„è§ˆå¼¹çª—ï¼ˆä¼ é€’æ–‡ä»¶å¯¹è±¡åç”¨äºä¸‹è½½ï¼‰
                    if (isImage) {
                        this.showImagePreview(file.url, file.name);
                    } else {
                        // éå›¾ç‰‡æ–‡ä»¶ï¼Œç›´æ¥åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
                        window.open(file.url, '_blank');
                    }
                }
            });
            
            // æ–‡ä»¶å›¾æ ‡ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä½†ä¸å†ä½¿ç”¨ï¼‰
            const fileIcon = document.createElement('span');
            fileIcon.style.cssText = `
                font-size: 20px !important;
                flex-shrink: 0 !important;
                display: none !important;
            `;
            
            // åˆ¤æ–­æ–‡ä»¶ç±»å‹å¹¶è®¾ç½®å›¾æ ‡
            if (isImage) {
                fileIcon.textContent = 'ğŸ–¼ï¸';
            } else if (['.pdf'].includes(ext)) {
                fileIcon.textContent = 'ğŸ“„';
            } else if (['.doc', '.docx'].includes(ext)) {
                fileIcon.textContent = 'ğŸ“';
            } else if (['.zip', '.rar', '.7z'].includes(ext)) {
                fileIcon.textContent = 'ğŸ“¦';
            } else {
                fileIcon.textContent = 'ğŸ“„';
            }
            
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentWrapper = document.createElement('div');
            contentWrapper.style.cssText = `
                flex: 1 !important;
                min-width: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            `;
            
            // åˆ›å»ºæ–‡ä»¶é¡¹å†…éƒ¨å®¹å™¨ï¼ˆåŒ…å«é¢„è§ˆå¤´åƒã€å¤é€‰æ¡†å’Œå†…å®¹ï¼‰
            const itemInner = document.createElement('div');
            itemInner.style.cssText = `
                display: flex !important;
                align-items: flex-start !important;
                width: 100% !important;
            `;
            
            // æ·»åŠ é¢„è§ˆå¤´åƒï¼ˆåœ¨æœ€å·¦è¾¹ï¼‰
            itemInner.appendChild(previewAvatar);
            
            // æ·»åŠ å¤é€‰æ¡†
            itemInner.appendChild(checkbox);
            
            // åˆ›å»ºå†…å®¹åŒ…è£…å™¨ï¼ˆåŒ…å«æ–‡ä»¶åå’Œæ ‡ç­¾ï¼‰
            const contentInner = document.createElement('div');
            contentInner.style.cssText = `
                flex: 1 !important;
                min-width: 0 !important;
            `;
            
            // åˆ›å»ºæ–‡ä»¶åè¡Œå®¹å™¨ï¼ˆæ–‡ä»¶åå’ŒæŒ‰é’®åœ¨åŒä¸€è¡Œï¼‰
            const titleRow = document.createElement('div');
            titleRow.style.cssText = `
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 8px !important;
                width: 100% !important;
            `;
            
            // æ–‡ä»¶å
            const fileNameDiv = document.createElement('div');
            fileNameDiv.className = 'oss-file-name';
            
            // è·å–è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
            const customTitle = this.getOssFileTitle(file.name);
            const displayName = customTitle || fileName;
            
            // æ ¹æ®ä¾§è¾¹æ å®½åº¦åŠ¨æ€è®¡ç®—æ–‡ä»¶åæœ€å¤§æ˜¾ç¤ºé•¿åº¦
            const availableWidth = Math.max(100, this.sidebarWidth - 60);
            const maxChars = Math.floor(availableWidth / 7);
            const fileNameMaxLength = Math.max(15, Math.min(50, maxChars));
            
            const displayFileName = displayName.length > fileNameMaxLength 
                ? displayName.substring(0, fileNameMaxLength) + '...' 
                : displayName;
            
            fileNameDiv.textContent = displayFileName;
            if (displayName.length > fileNameMaxLength) {
                fileNameDiv.setAttribute('title', displayName);
            }
            fileNameDiv.style.cssText = `
                font-size: 13px !important;
                font-weight: 500 !important;
                color: #374151 !important;
                margin-bottom: 0 !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
                flex: 1 !important;
                min-width: 0 !important;
            `;
            
            // æ ‡ç­¾ç®¡ç†æŒ‰é’®
            const tagBtn = document.createElement('button');
            tagBtn.className = 'oss-file-tag-btn';
            tagBtn.innerHTML = 'ğŸ·ï¸';
            tagBtn.title = 'ç®¡ç†æ ‡ç­¾';
            tagBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 2px 4px !important;
                font-size: 12px !important;
                opacity: 0.6 !important;
                transition: opacity 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
            `;
            
            // æŒ‰é’®æ‚¬åœæ—¶å¢åŠ ä¸é€æ˜åº¦
            tagBtn.addEventListener('mouseenter', () => {
                tagBtn.style.opacity = '1';
            });
            tagBtn.addEventListener('mouseleave', () => {
                tagBtn.style.opacity = '0.6';
            });
            
            // é˜»æ­¢æ ‡ç­¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° fileItem
            tagBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.openOssFileTagEditor(file.name, file.tags || []);
            });
            
            // ç¼–è¾‘æ ‡é¢˜æŒ‰é’®
            const editBtn = document.createElement('button');
            editBtn.className = 'oss-file-edit-btn';
            editBtn.innerHTML = 'âœï¸';
            editBtn.title = 'ç¼–è¾‘æ–‡ä»¶ä¿¡æ¯';
            editBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 2px 4px !important;
                font-size: 12px !important;
                opacity: 0.6 !important;
                transition: opacity 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
            `;
            
            // æŒ‰é’®æ‚¬åœæ—¶å¢åŠ ä¸é€æ˜åº¦
            editBtn.addEventListener('mouseenter', () => {
                editBtn.style.opacity = '1';
            });
            editBtn.addEventListener('mouseleave', () => {
                editBtn.style.opacity = '0.6';
            });
            
            // é˜»æ­¢ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° fileItem
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.editOssFileTitle(file.name);
            });
            
            // é¢„è§ˆå›¾ç‰‡å¼€å…³æŒ‰é’®ï¼ˆä¸æ ‡ç­¾æ¨¡å—ä¿æŒä¸€è‡´ï¼Œä½†åªæ§åˆ¶å½“å‰æ–‡ä»¶ï¼‰
            const previewToggleBtn = document.createElement('button');
            previewToggleBtn.className = 'oss-file-preview-toggle';
            previewToggleBtn.dataset.fileName = file.name; // å­˜å‚¨æ–‡ä»¶åä»¥ä¾¿è¯†åˆ«
            previewToggleBtn.innerHTML = 'ğŸ–¼ï¸';
            const currentFilePreviewEnabled = this.getFilePreviewEnabled(file.name);
            previewToggleBtn.title = currentFilePreviewEnabled ? 'å…³é—­æ­¤æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ­¤æ–‡ä»¶é¢„è§ˆ';
            previewToggleBtn.style.cssText = `
                font-size: 14px !important;
                color: ${currentFilePreviewEnabled ? '#667eea' : '#9ca3af'} !important;
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 2px 4px !important;
                border-radius: 3px !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                opacity: ${currentFilePreviewEnabled ? '1' : '0.6'} !important;
                flex-shrink: 0 !important;
            `;
            
            // æŒ‰é’®æ‚¬åœæ•ˆæœ
            previewToggleBtn.addEventListener('mouseenter', () => {
                previewToggleBtn.style.opacity = '1';
            });
            previewToggleBtn.addEventListener('mouseleave', () => {
                const currentFilePreviewEnabled = this.getFilePreviewEnabled(file.name);
                previewToggleBtn.style.opacity = currentFilePreviewEnabled ? '1' : '0.6';
            });
            
            // é˜»æ­¢é¢„è§ˆå¼€å…³æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° fileItem
            previewToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const currentFilePreviewEnabled = this.getFilePreviewEnabled(file.name);
                const newState = !currentFilePreviewEnabled;
                this.setFilePreviewEnabled(file.name, newState);
                
                // æ›´æ–°å½“å‰æŒ‰é’®çŠ¶æ€
                previewToggleBtn.style.color = newState ? '#4CAF50' : '#9ca3af';
                previewToggleBtn.style.opacity = newState ? '1' : '0.6';
                previewToggleBtn.title = newState ? 'å…³é—­æ­¤æ–‡ä»¶é¢„è§ˆ' : 'å¼€å¯æ­¤æ–‡ä»¶é¢„è§ˆ';
                
                // åªæ›´æ–°å½“å‰æ–‡ä»¶çš„é¢„è§ˆå¤´åƒï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
                const previewAvatar = fileItem.querySelector('.oss-file-preview-avatar');
                if (previewAvatar && isImage && file.url) {
                    if (newState) {
                        // å¼€å¯é¢„è§ˆï¼šåŠ è½½é¢„è§ˆå›¾
                        previewAvatar.innerHTML = '';
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.style.cssText = `
                            position: absolute !important;
                            top: 50% !important;
                            left: 50% !important;
                            transform: translate(-50%, -50%) !important;
                            width: 16px !important;
                            height: 16px !important;
                            border: 2px solid #d1d5db !important;
                            border-top-color: #6366f1 !important;
                            border-radius: 50% !important;
                            animation: spin 0.6s linear infinite !important;
                        `;
                        previewAvatar.appendChild(loadingIndicator);
                        
                        const img = document.createElement('img');
                        img.style.cssText = `
                            width: 100% !important;
                            height: 100% !important;
                            object-fit: cover !important;
                            opacity: 0 !important;
                            transition: opacity 0.3s ease !important;
                        `;
                        img.alt = file.name;
                        
                        img.onload = () => {
                            loadingIndicator.style.display = 'none';
                            img.style.opacity = '1';
                        };
                        
                        img.onerror = () => {
                            loadingIndicator.style.display = 'none';
                            previewAvatar.innerHTML = 'ğŸ–¼ï¸';
                            previewAvatar.style.fontSize = '20px';
                            previewAvatar.style.background = '#f3f4f6';
                        };
                        
                        const thumbnailUrl = this.generateOssImageProcessUrl(file.url, {
                            width: 48,
                            height: 48,
                            quality: 40,
                            format: 'webp',
                            keepAspectRatio: true
                        });
                        
                        if ('IntersectionObserver' in window) {
                            const imageObserver = new IntersectionObserver((entries, observer) => {
                                entries.forEach(entry => {
                                    if (entry.isIntersecting) {
                                        img.src = thumbnailUrl;
                                        observer.unobserve(entry.target);
                                    }
                                });
                            }, { rootMargin: '50px' });
                            imageObserver.observe(previewAvatar);
                        } else {
                            img.src = thumbnailUrl;
                        }
                        
                        previewAvatar.appendChild(img);
                    } else {
                        // å…³é—­é¢„è§ˆï¼šæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                        previewAvatar.innerHTML = 'ğŸ–¼ï¸';
                        previewAvatar.style.fontSize = '20px';
                        previewAvatar.style.background = 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)';
                    }
                }
            });
            
            // åˆ›å»ºæŒ‰é’®å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 2px !important;
                opacity: 0 !important;
                transition: opacity 0.2s ease !important;
                flex-shrink: 0 !important;
            `;
            buttonContainer.appendChild(previewToggleBtn);
            buttonContainer.appendChild(editBtn);
            buttonContainer.appendChild(tagBtn);
            
            // é¼ æ ‡æ‚¬åœåœ¨æ–‡ä»¶é¡¹ä¸Šæ—¶æ˜¾ç¤ºæŒ‰é’®
            fileItem.addEventListener('mouseenter', () => {
                buttonContainer.style.opacity = '1';
            });
            fileItem.addEventListener('mouseleave', () => {
                buttonContainer.style.opacity = '0';
            });
            
            // å°†æ–‡ä»¶åå’ŒæŒ‰é’®å®¹å™¨æ·»åŠ åˆ°æ ‡é¢˜è¡Œ
            titleRow.appendChild(fileNameDiv);
            titleRow.appendChild(buttonContainer);
            
            contentInner.appendChild(titleRow);
            
            // æ–‡ä»¶å…ƒä¿¡æ¯
            const fileMeta = document.createElement('div');
            fileMeta.className = 'oss-file-meta';
            fileMeta.style.cssText = `
                font-size: 11px !important;
                color: #9ca3af !important;
                margin-top: 4px !important;
                margin-bottom: 0 !important;
            `;
            const sizeText = file.size_human || `${(file.size / 1024 / 1024).toFixed(2)}MB`;
            const timeText = file.last_modified_str || 'æœªçŸ¥æ—¶é—´';
            fileMeta.textContent = `ğŸ“Š ${sizeText} | ğŸ“… ${timeText}`;
            contentInner.appendChild(fileMeta);
            
            // æ–‡ä»¶æ ‡ç­¾æ˜¾ç¤ºï¼ˆåœ¨å…ƒä¿¡æ¯ä¸‹é¢ä¸€è¡Œï¼‰
            const tags = file.tags || [];
            if (tags.length > 0) {
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'oss-file-tags';
                tagsContainer.style.cssText = `
                    display: flex !important;
                    flex-wrap: wrap !important;
                    gap: 4px !important;
                    margin-top: 4px !important;
                    margin-bottom: 0 !important;
                `;
                
                // æœ€å¤šæ˜¾ç¤º3ä¸ªæ ‡ç­¾ï¼Œè¶…å‡ºéƒ¨åˆ†æ˜¾ç¤º"+N"
                const maxVisibleTags = 3;
                const visibleTags = tags.slice(0, maxVisibleTags);
                const remainingCount = tags.length - maxVisibleTags;
                
                visibleTags.forEach((tag) => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'oss-file-tag-item';
                    tagElement.textContent = tag;
                    tagElement.style.cssText = `
                        display: inline-block !important;
                        background: #4CAF50 !important;
                        color: white !important;
                        padding: 2px 6px !important;
                        border-radius: 10px !important;
                        font-size: 11px !important;
                        line-height: 1.4 !important;
                        white-space: nowrap !important;
                        max-width: 80px !important;
                        overflow: hidden !important;
                        text-overflow: ellipsis !important;
                    `;
                    tagElement.setAttribute('title', tag);
                    tagsContainer.appendChild(tagElement);
                });
                
                if (remainingCount > 0) {
                    const moreTag = document.createElement('span');
                    moreTag.className = 'oss-file-tag-more';
                    moreTag.textContent = `+${remainingCount}`;
                    moreTag.style.cssText = `
                        display: inline-block !important;
                        background: #999 !important;
                        color: white !important;
                        padding: 2px 6px !important;
                        border-radius: 10px !important;
                        font-size: 11px !important;
                        line-height: 1.4 !important;
                    `;
                    moreTag.setAttribute('title', `è¿˜æœ‰ ${remainingCount} ä¸ªæ ‡ç­¾`);
                    tagsContainer.appendChild(moreTag);
                }
                
                contentInner.appendChild(tagsContainer);
            }
            
            contentWrapper.appendChild(contentInner);
            itemInner.appendChild(contentWrapper);
            fileItem.appendChild(itemInner);
            
            // é•¿æŒ‰åˆ é™¤ç›¸å…³å˜é‡
            let longPressTimer = null;
            let longPressProgressTimer = null;
            let longPressThreshold = 800; // é•¿æŒ‰æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
            let isLongPressing = false;
            let hasMoved = false;
            let startX = 0;
            let startY = 0;
            let longPressStartTime = 0;
            const moveThreshold = 10; // ç§»åŠ¨é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼åˆ™å–æ¶ˆé•¿æŒ‰
            
            // åˆ›å»ºé•¿æŒ‰è¿›åº¦æŒ‡ç¤ºå™¨
            const progressBar = document.createElement('div');
            progressBar.className = 'long-press-progress';
            progressBar.style.cssText = `
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                height: 3px !important;
                background: rgba(244, 67, 54, 0.8) !important;
                width: 0% !important;
                border-radius: 0 0 8px 8px !important;
                transition: width 0.05s linear !important;
                z-index: 10 !important;
            `;
            fileItem.appendChild(progressBar);
            
            // åˆ›å»ºé•¿æŒ‰æç¤ºæ–‡æœ¬
            const hintText = document.createElement('div');
            hintText.className = 'long-press-hint';
            hintText.textContent = 'ç»§ç»­æŒ‰ä½ä»¥åˆ é™¤';
            hintText.style.cssText = `
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) scale(0) !important;
                background: rgba(244, 67, 54, 0.95) !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 6px !important;
                font-size: 12px !important;
                white-space: nowrap !important;
                pointer-events: none !important;
                z-index: 20 !important;
                opacity: 0 !important;
                transition: all 0.2s ease !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            `;
            fileItem.appendChild(hintText);
            
            // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
            const clearLongPress = () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                if (longPressProgressTimer) {
                    clearInterval(longPressProgressTimer);
                    longPressProgressTimer = null;
                }
                if (isLongPressing) {
                    fileItem.classList.remove('long-pressing', 'long-press-start', 
                        'long-press-stage-1', 'long-press-stage-2', 'long-press-stage-3');
                    isLongPressing = false;
                } else {
                    // å³ä½¿æ²¡æœ‰å®Œæˆé•¿æŒ‰ï¼Œä¹Ÿè¦æ¸…é™¤å¼€å§‹çŠ¶æ€å’Œé˜¶æ®µçŠ¶æ€
                    fileItem.classList.remove('long-press-start', 
                        'long-press-stage-1', 'long-press-stage-2', 'long-press-stage-3');
                }
                hasMoved = false;
                progressBar.style.width = '0%';
                hintText.style.opacity = '0';
                hintText.style.transform = 'translate(-50%, -50%) scale(0)';
                longPressStartTime = 0;
            };
            
            // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
            const triggerHapticFeedback = () => {
                if ('vibrate' in navigator) {
                    navigator.vibrate(50); // çŸ­éœ‡åŠ¨
                }
            };
            
            // å¼€å§‹é•¿æŒ‰æ£€æµ‹
            const startLongPress = (e) => {
                hasMoved = false;
                startX = e.touches ? e.touches[0].clientX : e.clientX;
                startY = e.touches ? e.touches[0].clientY : e.clientY;
                longPressStartTime = Date.now();
                
                // æ·»åŠ å¼€å§‹é•¿æŒ‰çš„è§†è§‰åé¦ˆ
                fileItem.classList.add('long-press-start');
                
                // æ˜¾ç¤ºæç¤ºæ–‡æœ¬ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…ç«‹å³æ˜¾ç¤ºï¼‰
                setTimeout(() => {
                    if (longPressStartTime && !hasMoved) {
                        hintText.style.opacity = '1';
                        hintText.style.transform = 'translate(-50%, -50%) scale(1)';
                    }
                }, 200);
                
                // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
                let lastStage = 0;
                const progressInterval = 50; // æ¯50msæ›´æ–°ä¸€æ¬¡
                longPressProgressTimer = setInterval(() => {
                    if (hasMoved || !longPressStartTime) {
                        clearInterval(longPressProgressTimer);
                        return;
                    }
                    
                    const elapsed = Date.now() - longPressStartTime;
                    const progress = Math.min((elapsed / longPressThreshold) * 100, 100);
                    progressBar.style.width = progress + '%';
                    
                    // åœ¨ä¸åŒé˜¶æ®µæ·»åŠ åé¦ˆï¼ˆç¡®ä¿æ¯ä¸ªé˜¶æ®µåªè§¦å‘ä¸€æ¬¡ï¼‰
                    if (progress >= 30 && progress < 35 && lastStage < 1) {
                        fileItem.classList.add('long-press-stage-1');
                        lastStage = 1;
                    } else if (progress >= 60 && progress < 65 && lastStage < 2) {
                        fileItem.classList.remove('long-press-stage-1');
                        fileItem.classList.add('long-press-stage-2');
                        lastStage = 2;
                        triggerHapticFeedback(); // ä¸­æœŸéœ‡åŠ¨
                    } else if (progress >= 90 && progress < 95 && lastStage < 3) {
                        fileItem.classList.remove('long-press-stage-2');
                        fileItem.classList.add('long-press-stage-3');
                        lastStage = 3;
                        triggerHapticFeedback(); // æ¥è¿‘å®Œæˆæ—¶çš„éœ‡åŠ¨
                    }
                    
                    if (progress >= 100) {
                        clearInterval(longPressProgressTimer);
                    }
                }, progressInterval);
                
                longPressTimer = setTimeout(async () => {
                    if (!hasMoved) {
                        isLongPressing = true;
                        fileItem.classList.add('long-pressing');
                        triggerHapticFeedback(); // è§¦å‘åˆ é™¤å‰çš„éœ‡åŠ¨
                        
                        // è§¦å‘åˆ é™¤ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œåˆ é™¤å®Œæˆåæ¸…é™¤çŠ¶æ€ï¼‰
                        try {
                            if (this.ossFileManager) {
                                // è·å–æ–‡ä»¶åç”¨äºæç¤º
                                const fileName = file.name || 'æœªå‘½åæ–‡ä»¶';
                                
                                // ç¡®è®¤åˆ é™¤
                                const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶"${fileName}"å—ï¼Ÿ`);
                                if (!confirmDelete) {
                                    // ç”¨æˆ·å–æ¶ˆåˆ é™¤ï¼Œæ¸…é™¤é•¿æŒ‰çŠ¶æ€
                                    clearLongPress();
                                    return;
                                }
                                
                                await this.ossFileManager.deleteFile(file.name);
                                this.showNotification('æ–‡ä»¶å·²åˆ é™¤', 'success');
                                // åˆ·æ–°åˆ—è¡¨
                                await this.updateOssFileSidebar(true);
                            }
                        } catch (error) {
                            console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                            this.showNotification('åˆ é™¤æ–‡ä»¶å¤±è´¥', 'error');
                        } finally {
                            // æ¸…é™¤é•¿æŒ‰çŠ¶æ€
                            clearLongPress();
                        }
                    }
                }, longPressThreshold);
            };
            
            // ç»“æŸé•¿æŒ‰æ£€æµ‹
            const endLongPress = () => {
                clearLongPress();
            };
            
            // ç§»åŠ¨æ£€æµ‹ï¼ˆå–æ¶ˆé•¿æŒ‰ï¼‰
            const handleMove = (e) => {
                const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                const currentY = e.touches ? e.touches[0].clientY : e.clientY;
                const deltaX = Math.abs(currentX - startX);
                const deltaY = Math.abs(currentY - startY);
                
                if (deltaX > moveThreshold || deltaY > moveThreshold) {
                    hasMoved = true;
                    clearLongPress();
                }
            };
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            fileItem.addEventListener('touchstart', (e) => {
                startLongPress(e);
            }, { passive: true });
            
            fileItem.addEventListener('touchmove', (e) => {
                handleMove(e);
            }, { passive: true });
            
            fileItem.addEventListener('touchend', () => {
                endLongPress();
            }, { passive: true });
            
            fileItem.addEventListener('touchcancel', () => {
                endLongPress();
            }, { passive: true });
            
            // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢è®¾å¤‡ï¼‰
            fileItem.addEventListener('mousedown', (e) => {
                startLongPress(e);
            });
            
            fileItem.addEventListener('mousemove', (e) => {
                if (longPressTimer) {
                    handleMove(e);
                }
            });
            
            fileItem.addEventListener('mouseup', () => {
                endLongPress();
            });
            
            fileItem.addEventListener('mouseleave', () => {
                endLongPress();
            });
            
            // ç‚¹å‡»æ–‡ä»¶é¡¹é€‰æ‹©æ–‡ä»¶æˆ–åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            fileItem.addEventListener('click', async (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†ï¼Œä¸æ‰§è¡Œåˆ‡æ¢æ“ä½œ
                if (e.target.type === 'checkbox' || e.target.closest('.oss-file-checkbox')) {
                    return;
                }
                
                // å¦‚æœæ­£åœ¨é•¿æŒ‰ï¼Œä¸æ‰§è¡Œç‚¹å‡»
                if (isLongPressing || hasMoved) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                // å¦‚æœæ­£åœ¨åˆ‡æ¢ï¼Œå¿½ç•¥ç‚¹å‡»
                if (fileItem.classList.contains('switching')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                // æ‰¹é‡æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                if (this.batchMode) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                    return;
                }
                
                // æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦æ˜¯è¯¥OSSæ–‡ä»¶çš„ä¼šè¯
                // ç¡®ä¿æ–‡ä»¶æœ‰urlå­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨name
                const fileUrl = file.url || file.name || '';
                if (!fileUrl) {
                    console.error('æ–‡ä»¶å¯¹è±¡ç¼ºå°‘urlå’Œnameå­—æ®µ');
                    return;
                }
                const fileSessionId = await this.generateSessionId(fileUrl);
                const isCurrentFileSession = this.currentSessionId === fileSessionId;
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ–‡ä»¶çš„ä¼šè¯ï¼Œä¸æ‰§è¡Œæ“ä½œï¼ˆä½†ä»æ·»åŠ è§†è§‰åé¦ˆï¼‰
                if (isCurrentFileSession) {
                    // æ·»åŠ è½»å¾®åé¦ˆæç¤ºè¿™æ˜¯å½“å‰æ–‡ä»¶
                    fileItem.classList.add('clicked');
                    setTimeout(() => {
                        fileItem.classList.remove('clicked');
                    }, 150);
                    return;
                }
                
                // ç«‹å³æ·»åŠ ç‚¹å‡»åé¦ˆ
                fileItem.classList.add('clicked');
                
                // é˜²æ­¢é‡å¤ç‚¹å‡»ï¼šå¿«é€Ÿç¦ç”¨
                fileItem.style.pointerEvents = 'none';
                
                try {
                    // æ›´æ–°æ‰€æœ‰æ–‡ä»¶é¡¹çš„activeçŠ¶æ€
                    const allFileItems = ossFileList.querySelectorAll('.oss-file-item');
                    allFileItems.forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // æ·»åŠ åˆ‡æ¢çŠ¶æ€
                    fileItem.classList.add('switching');
                    
                    // è°ƒç”¨handleOssFileClickå¤„ç†OSSæ–‡ä»¶ç‚¹å‡»ï¼Œåˆ›å»ºä¼šè¯å¹¶æ‰“å¼€èŠå¤©çª—å£
                    await this.handleOssFileClick(file);
                    
                    // è®¾ç½®å½“å‰æ–‡ä»¶
                    this.currentFile = file.name;
                    
                    // æ›´æ–°å½“å‰æ–‡ä»¶é¡¹çš„activeçŠ¶æ€
                    const allFileItemsAfter = ossFileList.querySelectorAll('.oss-file-item');
                    allFileItemsAfter.forEach(item => {
                        if (item.dataset.fileName === file.name) {
                            item.classList.add('active');
                            // æ›´æ–°æ ·å¼ä»¥æ˜¾ç¤ºé«˜äº®
                            item.style.background = '#e0e7ff';
                            item.style.border = '1px solid #6366f1';
                        } else {
                            // ç¡®ä¿å…¶ä»–æ–‡ä»¶é¡¹ä¸æ˜¯activeçŠ¶æ€
                            item.classList.remove('active');
                            item.style.background = '#f9fafb';
                            item.style.border = '1px solid transparent';
                        }
                    });
                } catch (error) {
                    console.error('å¤„ç†OSSæ–‡ä»¶ç‚¹å‡»å¤±è´¥:', error);
                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    fileItem.classList.remove('switching', 'clicked');
                } finally {
                    // æ¢å¤äº¤äº’ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…è¿‡å¿«é‡å¤ç‚¹å‡»ï¼‰
                    setTimeout(() => {
                        fileItem.style.pointerEvents = '';
                        fileItem.classList.remove('clicked', 'switching');
                    }, 300);
                }
            });
            
            ossFileList.appendChild(fileItem);
        }
        
        console.log('OSSæ–‡ä»¶åˆ—è¡¨å·²æ›´æ–°ï¼Œæ˜¾ç¤º', sortedFiles.length, 'ä¸ªæ–‡ä»¶');
        
        // æ›´æ–°è§†å›¾åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        this.applyViewMode();
    }
    
    // æ›´æ–°æ–°é—»æ ‡ç­¾è¿‡æ»¤å™¨UI
    updateNewsTagFilterUI() {
        if (!this.sessionSidebar) return;
        
        // æ›´æ–°åå‘è¿‡æ»¤æŒ‰é’®çŠ¶æ€
        const reverseFilterBtn = this.sessionSidebar.querySelector('.news-tag-filter-reverse');
        if (reverseFilterBtn) {
            reverseFilterBtn.style.color = this.newsTagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.newsTagFilterReverse ? '1' : '0.6';
        }
        
        // æ›´æ–°æ— æ ‡ç­¾ç­›é€‰æŒ‰é’®çŠ¶æ€
        const noTagsFilterBtn = this.sessionSidebar.querySelector('.news-tag-filter-no-tags');
        if (noTagsFilterBtn) {
            noTagsFilterBtn.style.color = this.newsTagFilterNoTags ? '#4CAF50' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.newsTagFilterNoTags ? '1' : '0.6';
        }
        
        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        const clearFilterBtn = this.sessionSidebar.querySelector('.news-tag-filter-clear');
        if (clearFilterBtn) {
            const hasSelectedTags = this.selectedNewsFilterTags && this.selectedNewsFilterTags.length > 0;
            const hasSearchKeyword = this.newsTagFilterSearchKeyword && this.newsTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.newsTagFilterNoTags || hasSearchKeyword;
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.cursor = hasActiveFilter ? 'pointer' : 'default';
        }
        
        const tagFilterList = this.sessionSidebar.querySelector('.news-tag-filter-list');
        if (!tagFilterList) return;
        
        // æ¸…ç©ºç°æœ‰æ ‡ç­¾
        tagFilterList.innerHTML = '';
        
        // è·å–æ‰€æœ‰æ ‡ç­¾
        const allTags = this.getAllNewsTags();
        
        // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤æ ‡ç­¾
        let filteredTags = allTags;
        const searchKeyword = (this.newsTagFilterSearchKeyword || '').trim().toLowerCase();
        if (searchKeyword) {
            filteredTags = allTags.filter(tag => 
                tag.toLowerCase().includes(searchKeyword)
            );
        }
        
        if (filteredTags.length === 0) {
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ ‡ç­¾ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const expandToggleBtn = this.sessionSidebar.querySelector('.news-tag-filter-expand-btn');
            if (expandToggleBtn) {
                expandToggleBtn.style.display = 'none';
            }
            // æ˜¾ç¤º"æ— åŒ¹é…æ ‡ç­¾"æç¤º
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = searchKeyword ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ ‡ç­¾' : 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                padding: 8px !important;
                text-align: center !important;
                color: #9ca3af !important;
                font-size: 11px !important;
            `;
            tagFilterList.appendChild(emptyMsg);
            return;
        }
        
        // ç¡®å®šè¦æ˜¾ç¤ºçš„æ ‡ç­¾ï¼ˆæ ¹æ®æŠ˜å çŠ¶æ€ï¼‰
        // ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾å§‹ç»ˆæ˜¾ç¤º
        const selectedTags = this.selectedNewsFilterTags || [];
        let visibleTags;
        let hasMoreTags;
        
        if (this.newsTagFilterExpanded || searchKeyword) {
            // å±•å¼€çŠ¶æ€æˆ–æœ‰æœç´¢å…³é”®è¯æ—¶ï¼šæ˜¾ç¤ºæ‰€æœ‰è¿‡æ»¤åçš„æ ‡ç­¾
            visibleTags = filteredTags;
            hasMoreTags = false;
        } else {
            // æŠ˜å çŠ¶æ€ï¼šæ˜¾ç¤ºå‰Nä¸ªæ ‡ç­¾ï¼Œä½†ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾ä¹Ÿåœ¨å…¶ä¸­
            const defaultVisible = filteredTags.slice(0, this.newsTagFilterVisibleCount);
            const selectedNotInDefault = selectedTags.filter(tag => !defaultVisible.includes(tag));
            
            // ä¿æŒfilteredTagsçš„åŸå§‹é¡ºåºï¼Œä½†ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾ä¹Ÿåœ¨å¯è§åˆ—è¡¨ä¸­
            const visibleSet = new Set([...defaultVisible, ...selectedNotInDefault]);
            visibleTags = filteredTags.filter(tag => visibleSet.has(tag));
            hasMoreTags = filteredTags.length > visibleTags.length;
        }
        
        // æ›´æ–°å±•å¼€/æŠ˜å æŒ‰é’®ï¼ˆæœ‰æœç´¢å…³é”®è¯æ—¶éšè—ï¼‰
        const expandToggleBtn = this.sessionSidebar.querySelector('.news-tag-filter-expand-btn');
        if (expandToggleBtn) {
            if (searchKeyword) {
                // æœ‰æœç´¢å…³é”®è¯æ—¶éšè—å±•å¼€/æŠ˜å æŒ‰é’®
                expandToggleBtn.style.display = 'none';
            } else if (hasMoreTags || this.newsTagFilterExpanded) {
                expandToggleBtn.style.display = 'block';
                if (this.newsTagFilterExpanded) {
                    expandToggleBtn.innerHTML = 'â–²';
                    expandToggleBtn.title = 'æ”¶èµ·æ ‡ç­¾';
                } else {
                    expandToggleBtn.innerHTML = 'â–¼';
                    expandToggleBtn.title = 'å±•å¼€æ ‡ç­¾';
                }
            } else {
                expandToggleBtn.style.display = 'none';
            }
        }
        
        // è®¡ç®—æ¯ä¸ªæ ‡ç­¾å¯¹åº”çš„æ–°é—»æ•°é‡
        const tagCounts = {};
        if (this.newsManager) {
            const allNews = this.newsManager.getAllNews();
            allNews.forEach(news => {
                if (news.tags && Array.isArray(news.tags)) {
                    news.tags.forEach(t => {
                        if (t && t.trim()) {
                            const normalizedTag = t.trim();
                            tagCounts[normalizedTag] = (tagCounts[normalizedTag] || 0) + 1;
                        }
                    });
                }
            });
        }
        
        // åˆ›å»ºæ ‡ç­¾æŒ‰é’®
        visibleTags.forEach(tag => {
            const tagBtn = document.createElement('button');
            tagBtn.className = 'news-tag-filter-item';
            const count = tagCounts[tag] || 0;
            tagBtn.textContent = `${tag} (${count})`;
            const isSelected = this.selectedNewsFilterTags && this.selectedNewsFilterTags.includes(tag);
            
            tagBtn.style.cssText = `
                padding: 3px 8px !important;
                border-radius: 10px !important;
                border: 1px solid ${isSelected ? '#4CAF50' : '#e5e7eb'} !important;
                background: ${isSelected ? '#4CAF50' : '#f9fafb'} !important;
                color: ${isSelected ? 'white' : '#6b7280'} !important;
                font-size: 10px !important;
                font-weight: ${isSelected ? '500' : '400'} !important;
                cursor: pointer !important;
                transition: all 0.15s ease !important;
                white-space: nowrap !important;
                line-height: 1.4 !important;
            `;
            
            tagBtn.addEventListener('mouseenter', () => {
                if (!isSelected) {
                    tagBtn.style.borderColor = '#4CAF50';
                    tagBtn.style.background = '#f0fdf4';
                    tagBtn.style.color = '#4CAF50';
                } else {
                    tagBtn.style.opacity = '0.9';
                }
            });
            tagBtn.addEventListener('mouseleave', () => {
                if (!isSelected) {
                    tagBtn.style.borderColor = '#e5e7eb';
                    tagBtn.style.background = '#f9fafb';
                    tagBtn.style.color = '#6b7280';
                } else {
                    tagBtn.style.opacity = '1';
                }
            });
            tagBtn.addEventListener('click', () => {
                if (!this.selectedNewsFilterTags) {
                    this.selectedNewsFilterTags = [];
                }
                
                const index = this.selectedNewsFilterTags.indexOf(tag);
                if (index > -1) {
                    // å–æ¶ˆé€‰ä¸­
                    this.selectedNewsFilterTags.splice(index, 1);
                } else {
                    // é€‰ä¸­
                    this.selectedNewsFilterTags.push(tag);
                }
                
                // æ›´æ–°æ‰€æœ‰æ ‡ç­¾æŒ‰é’®ï¼ˆç¡®ä¿çŠ¶æ€ä¸€è‡´ï¼‰
                this.updateNewsTagFilterUI();
                // æ›´æ–°æ–°é—»åˆ—è¡¨ï¼ˆåº”ç”¨è¿‡æ»¤ï¼‰
                this.updateNewsSidebar();
            });
            
            tagFilterList.appendChild(tagBtn);
        });
    }

    // åˆ›å»ºæ–°é—»æ ‡ç­¾ç­›é€‰å™¨
    createNewsTagFilter() {
        if (!this.sessionSidebar) return;
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        let newsTagFilterContainer = this.sessionSidebar.querySelector('.news-tag-filter-container');
        if (newsTagFilterContainer) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œåªæ›´æ–°UI
            this.updateNewsTagFilterUI();
            return;
        }
        
        const mainColor = PET_CONFIG?.theme?.primaryColor || '#6366f1';
        
        // åˆ›å»ºæ ‡ç­¾è¿‡æ»¤å™¨å®¹å™¨
        newsTagFilterContainer = document.createElement('div');
        newsTagFilterContainer.className = 'news-tag-filter-container';
        newsTagFilterContainer.style.cssText = `
            padding: 8px 12px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #ffffff !important;
            overflow: visible !important;
            flex-shrink: 0 !important;
        `;

        // è¿‡æ»¤å™¨æ ‡é¢˜è¡Œï¼ˆåŒ…å«æœç´¢è¾“å…¥æ¡†å’Œæ“ä½œæŒ‰é’®ï¼‰
        const filterHeader = document.createElement('div');
        filterHeader.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 8px !important;
            margin-bottom: 6px !important;
        `;

        // å³ä¾§æ“ä½œåŒºï¼ˆåå‘è¿‡æ»¤å¼€å…³ + æ¸…é™¤æŒ‰é’®ï¼‰
        const filterActions = document.createElement('div');
        filterActions.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
        `;

        // åå‘è¿‡æ»¤å¼€å…³
        const reverseFilterBtn = document.createElement('button');
        reverseFilterBtn.className = 'news-tag-filter-reverse';
        reverseFilterBtn.title = 'åå‘è¿‡æ»¤';
        reverseFilterBtn.innerHTML = 'â‡„';
        reverseFilterBtn.style.cssText = `
            font-size: 12px !important;
            color: ${this.newsTagFilterReverse ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.newsTagFilterReverse ? '1' : '0.6'} !important;
        `;
        reverseFilterBtn.addEventListener('mouseenter', () => {
            reverseFilterBtn.style.opacity = '1';
            reverseFilterBtn.style.background = '#f3f4f6';
        });
        reverseFilterBtn.addEventListener('mouseleave', () => {
            if (!this.newsTagFilterReverse) {
                reverseFilterBtn.style.opacity = '0.6';
            }
            reverseFilterBtn.style.background = 'none';
        });
        reverseFilterBtn.addEventListener('click', () => {
            this.newsTagFilterReverse = !this.newsTagFilterReverse;
            reverseFilterBtn.style.color = this.newsTagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.newsTagFilterReverse ? '1' : '0.6';
            this.updateNewsSidebar();
        });

        // æ— æ ‡ç­¾ç­›é€‰å¼€å…³
        const noTagsFilterBtn = document.createElement('button');
        noTagsFilterBtn.className = 'news-tag-filter-no-tags';
        noTagsFilterBtn.title = 'ç­›é€‰æ— æ ‡ç­¾';
        noTagsFilterBtn.innerHTML = 'âˆ…';
        noTagsFilterBtn.style.cssText = `
            font-size: 12px !important;
            color: ${this.newsTagFilterNoTags ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.newsTagFilterNoTags ? '1' : '0.6'} !important;
        `;
        noTagsFilterBtn.addEventListener('mouseenter', () => {
            noTagsFilterBtn.style.opacity = '1';
            noTagsFilterBtn.style.background = '#f3f4f6';
        });
        noTagsFilterBtn.addEventListener('mouseleave', () => {
            if (!this.newsTagFilterNoTags) {
                noTagsFilterBtn.style.opacity = '0.6';
            }
            noTagsFilterBtn.style.background = 'none';
        });
        noTagsFilterBtn.addEventListener('click', () => {
            this.newsTagFilterNoTags = !this.newsTagFilterNoTags;
            noTagsFilterBtn.style.color = this.newsTagFilterNoTags ? '#4CAF50' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.newsTagFilterNoTags ? '1' : '0.6';
            this.updateNewsTagFilterUI();
            this.updateNewsSidebar();
        });

        // å±•å¼€/æ”¶èµ·æŒ‰é’®
        const expandToggleBtn = document.createElement('button');
        expandToggleBtn.className = 'news-tag-filter-expand-btn';
        expandToggleBtn.title = 'å±•å¼€æ ‡ç­¾';
        expandToggleBtn.innerHTML = 'â–¼';
        expandToggleBtn.style.cssText = `
            font-size: 10px !important;
            color: #9ca3af !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: 0.6 !important;
            display: none !important;
        `;
        expandToggleBtn.addEventListener('mouseenter', () => {
            expandToggleBtn.style.opacity = '1';
            expandToggleBtn.style.background = '#f3f4f6';
        });
        expandToggleBtn.addEventListener('mouseleave', () => {
            expandToggleBtn.style.opacity = '0.6';
            expandToggleBtn.style.background = 'none';
        });
        expandToggleBtn.addEventListener('click', () => {
            this.newsTagFilterExpanded = !this.newsTagFilterExpanded;
            this.updateNewsTagFilterUI();
        });

        // æ¸…é™¤æŒ‰é’®
        const clearFilterBtn = document.createElement('button');
        clearFilterBtn.className = 'news-tag-filter-clear';
        clearFilterBtn.textContent = 'Ã—';
        clearFilterBtn.title = 'æ¸…é™¤ç­›é€‰';
        clearFilterBtn.style.cssText = `
            font-size: 16px !important;
            color: #9ca3af !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 0 !important;
            width: 18px !important;
            height: 18px !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            opacity: 0.6 !important;
        `;
        clearFilterBtn.addEventListener('mouseenter', () => {
            const hasSelectedTags = this.selectedNewsFilterTags && this.selectedNewsFilterTags.length > 0;
            const hasSearchKeyword = this.newsTagFilterSearchKeyword && this.newsTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.newsTagFilterNoTags || hasSearchKeyword;
            if (hasActiveFilter) {
                clearFilterBtn.style.color = '#ef4444';
                clearFilterBtn.style.opacity = '1';
                clearFilterBtn.style.background = '#fee2e2';
            } else {
                clearFilterBtn.style.opacity = '0.4';
            }
        });
        clearFilterBtn.addEventListener('mouseleave', () => {
            const hasSelectedTags = this.selectedNewsFilterTags && this.selectedNewsFilterTags.length > 0;
            const hasSearchKeyword = this.newsTagFilterSearchKeyword && this.newsTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.newsTagFilterNoTags || hasSearchKeyword;
            clearFilterBtn.style.color = '#9ca3af';
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.background = 'none';
        });
        clearFilterBtn.addEventListener('click', () => {
            const hasSelectedTags = this.selectedNewsFilterTags && this.selectedNewsFilterTags.length > 0;
            const hasSearchKeyword = this.newsTagFilterSearchKeyword && this.newsTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.newsTagFilterNoTags || hasSearchKeyword;
            if (hasActiveFilter) {
                this.selectedNewsFilterTags = [];
                this.newsTagFilterNoTags = false;
                this.newsTagFilterSearchKeyword = '';
                // æ›´æ–°æœç´¢è¾“å…¥æ¡†çš„å€¼å’Œæ¸…é™¤æŒ‰é’®çŠ¶æ€
                const tagSearchInput = this.sessionSidebar.querySelector('.news-tag-filter-search');
                const tagSearchClearBtn = this.sessionSidebar.querySelector('.news-tag-filter-search-clear');
                if (tagSearchInput) {
                    tagSearchInput.value = '';
                }
                if (tagSearchClearBtn) {
                    tagSearchClearBtn.style.display = 'none';
                }
                const tagSearchIcon = this.sessionSidebar.querySelector('.news-tag-filter-search-container span');
                if (tagSearchIcon && tagSearchIcon.textContent === 'ğŸ”') {
                    tagSearchIcon.style.opacity = '0.5';
                }
                this.updateNewsTagFilterUI();
                this.updateNewsSidebar();
            }
        });

        // RSSæºç®¡ç†æŒ‰é’®
        const rssSourceManageBtn = document.createElement('button');
        rssSourceManageBtn.className = 'rss-source-manage-btn';
        rssSourceManageBtn.title = 'RSSæºç®¡ç†';
        rssSourceManageBtn.innerHTML = 'ğŸ“¡';
        rssSourceManageBtn.style.cssText = `
            font-size: 14px !important;
            color: ${mainColor} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: 0.8 !important;
        `;
        rssSourceManageBtn.addEventListener('mouseenter', () => {
            rssSourceManageBtn.style.opacity = '1';
            rssSourceManageBtn.style.background = '#f3f4f6';
        });
        rssSourceManageBtn.addEventListener('mouseleave', () => {
            rssSourceManageBtn.style.opacity = '0.8';
            rssSourceManageBtn.style.background = 'none';
        });
        rssSourceManageBtn.addEventListener('click', () => {
            this.showRssSourceManager();
        });

        filterActions.appendChild(reverseFilterBtn);
        filterActions.appendChild(noTagsFilterBtn);
        filterActions.appendChild(expandToggleBtn);
        filterActions.appendChild(clearFilterBtn);
        filterActions.appendChild(rssSourceManageBtn);

        // åˆ›å»ºæ ‡ç­¾æœç´¢è¾“å…¥æ¡†å®¹å™¨
        const tagSearchContainer = document.createElement('div');
        tagSearchContainer.className = 'news-tag-filter-search-container';
        tagSearchContainer.style.cssText = `
            position: relative !important;
            flex: 1 !important;
            display: flex !important;
            align-items: center !important;
        `;

        // æœç´¢å›¾æ ‡
        const tagSearchIcon = document.createElement('span');
        tagSearchIcon.textContent = 'ğŸ”';
        tagSearchIcon.style.cssText = `
            position: absolute !important;
            left: 8px !important;
            font-size: 12px !important;
            pointer-events: none !important;
            z-index: 1 !important;
            opacity: 0.5 !important;
            transition: opacity 0.2s ease !important;
        `;

        // æ ‡ç­¾æœç´¢è¾“å…¥æ¡†
        const tagSearchInput = document.createElement('input');
        tagSearchInput.className = 'news-tag-filter-search';
        tagSearchInput.type = 'text';
        tagSearchInput.placeholder = 'æœç´¢æ ‡ç­¾...';
        tagSearchInput.value = this.newsTagFilterSearchKeyword || '';
        tagSearchInput.style.cssText = `
            width: 100% !important;
            font-weight: 400 !important;
            font-size: 12px !important;
            color: #374151 !important;
            padding: 4px 24px 4px 24px !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 6px !important;
            background: #ffffff !important;
            outline: none !important;
            transition: all 0.2s ease !important;
            box-sizing: border-box !important;
            height: 24px !important;
        `;

        // æ·»åŠ å ä½ç¬¦æ ·å¼
        if (!document.getElementById('news-tag-search-placeholder-style')) {
            const style = document.createElement('style');
            style.id = 'news-tag-search-placeholder-style';
            style.textContent = `
                .news-tag-filter-search::placeholder {
                    color: #9ca3af !important;
                    opacity: 1 !important;
                }
                .news-tag-filter-search:focus::placeholder {
                    color: #d1d5db !important;
                }
            `;
            document.head.appendChild(style);
        }

        // æ¸…é™¤æŒ‰é’®ï¼ˆä½äºè¾“å…¥æ¡†å³ä¾§ï¼‰
        const tagSearchClearBtn = document.createElement('button');
        tagSearchClearBtn.innerHTML = 'âœ•';
        tagSearchClearBtn.type = 'button';
        tagSearchClearBtn.className = 'news-tag-filter-search-clear';
        tagSearchClearBtn.style.cssText = `
            position: absolute !important;
            right: 4px !important;
            width: 16px !important;
            height: 16px !important;
            border: none !important;
            background: #e5e7eb !important;
            color: #6b7280 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            padding: 0 !important;
            transition: all 0.2s ease !important;
            z-index: 2 !important;
            line-height: 1 !important;
        `;

        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        const updateTagSearchClearButton = () => {
            if (tagSearchInput.value.trim() !== '') {
                tagSearchClearBtn.style.display = 'flex';
                tagSearchIcon.style.opacity = '0.3';
            } else {
                tagSearchClearBtn.style.display = 'none';
                tagSearchIcon.style.opacity = '0.5';
            }
        };

        // åˆå§‹çŠ¶æ€
        updateTagSearchClearButton();

        // æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        tagSearchClearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            tagSearchInput.value = '';
            this.newsTagFilterSearchKeyword = '';
            updateTagSearchClearButton();
            this.updateNewsTagFilterUI();
            tagSearchInput.focus();
        });

        // æ¸…é™¤æŒ‰é’®æ‚¬åœæ•ˆæœ
        tagSearchClearBtn.addEventListener('mouseenter', () => {
            tagSearchClearBtn.style.background = '#d1d5db';
            tagSearchClearBtn.style.transform = 'scale(1.15)';
        });
        tagSearchClearBtn.addEventListener('mouseleave', () => {
            tagSearchClearBtn.style.background = '#e5e7eb';
            tagSearchClearBtn.style.transform = 'scale(1)';
        });

        // è¾“å…¥æ¡†èšç„¦å’Œå¤±ç„¦æ ·å¼
        tagSearchInput.addEventListener('focus', () => {
            tagSearchInput.style.borderColor = mainColor;
            tagSearchInput.style.boxShadow = `0 0 0 2px ${mainColor}22`;
            tagSearchIcon.style.opacity = '0.7';
        });
        tagSearchInput.addEventListener('blur', () => {
            tagSearchInput.style.borderColor = '#e5e7eb';
            tagSearchInput.style.boxShadow = 'none';
            tagSearchIcon.style.opacity = tagSearchInput.value.trim() !== '' ? '0.3' : '0.5';
        });

        // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶è¿‡æ»¤æ ‡ç­¾ï¼ˆæ·»åŠ é˜²æŠ–ï¼‰
        let tagSearchDebounceTimer = null;
        tagSearchInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            this.newsTagFilterSearchKeyword = value;
            updateTagSearchClearButton();
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (tagSearchDebounceTimer) {
                clearTimeout(tagSearchDebounceTimer);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼ˆé˜²æŠ–ï¼‰
            tagSearchDebounceTimer = setTimeout(() => {
                this.updateNewsTagFilterUI();
            }, 200);
        });

        tagSearchContainer.appendChild(tagSearchIcon);
        tagSearchContainer.appendChild(tagSearchInput);
        tagSearchContainer.appendChild(tagSearchClearBtn);

        filterHeader.appendChild(tagSearchContainer);
        filterHeader.appendChild(filterActions);

        // æ ‡ç­¾åˆ—è¡¨å®¹å™¨
        const tagFilterList = document.createElement('div');
        tagFilterList.className = 'news-tag-filter-list';
        tagFilterList.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 4px !important;
            position: relative !important;
        `;

        newsTagFilterContainer.appendChild(filterHeader);
        newsTagFilterContainer.appendChild(tagFilterList);

        // æ’å…¥åˆ°ä¾§è¾¹æ é¡¶éƒ¨ï¼ˆåœ¨æ–°é—»åˆ—è¡¨ä¹‹å‰ï¼‰
        const newsList = this.sessionSidebar.querySelector('.news-list');
        if (newsList) {
            this.sessionSidebar.insertBefore(newsTagFilterContainer, newsList);
        } else {
            this.sessionSidebar.appendChild(newsTagFilterContainer);
        }

        // åˆå§‹åŒ–æ ‡ç­¾åˆ—è¡¨
        this.updateNewsTagFilterUI();
    }

    // æ›´æ–°è¯·æ±‚æ¥å£æ ‡ç­¾è¿‡æ»¤å™¨UI
    updateApiRequestTagFilterUI() {
        if (!this.sessionSidebar) return;
        
        // ç¡®ä¿ apiRequestManager å·²åˆå§‹åŒ–
        if (!this.apiRequestManager) {
            // å¦‚æœ apiRequestManager æœªåˆå§‹åŒ–ï¼Œæ¸…ç©ºæ ‡ç­¾åˆ—è¡¨å¹¶æ˜¾ç¤ºæç¤º
            const tagFilterList = this.sessionSidebar.querySelector('.api-request-tag-filter-list');
            if (tagFilterList) {
                tagFilterList.innerHTML = '';
                const emptyMsg = document.createElement('div');
                emptyMsg.textContent = 'æ­£åœ¨åŠ è½½...';
                emptyMsg.style.cssText = `
                    padding: 8px !important;
                    text-align: center !important;
                    color: #9ca3af !important;
                    font-size: 11px !important;
                `;
                tagFilterList.appendChild(emptyMsg);
            }
            return;
        }
        
        // æ›´æ–°åå‘è¿‡æ»¤æŒ‰é’®çŠ¶æ€
        const reverseFilterBtn = this.sessionSidebar.querySelector('.api-request-tag-filter-reverse');
        if (reverseFilterBtn) {
            reverseFilterBtn.style.color = this.apiRequestTagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.apiRequestTagFilterReverse ? '1' : '0.6';
        }
        
        // æ›´æ–°æ— æ ‡ç­¾ç­›é€‰æŒ‰é’®çŠ¶æ€
        const noTagsFilterBtn = this.sessionSidebar.querySelector('.api-request-tag-filter-no-tags');
        if (noTagsFilterBtn) {
            noTagsFilterBtn.style.color = this.apiRequestTagFilterNoTags ? '#4CAF50' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.apiRequestTagFilterNoTags ? '1' : '0.6';
        }
        
        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        const clearFilterBtn = this.sessionSidebar.querySelector('.api-request-tag-filter-clear');
        if (clearFilterBtn) {
            const hasSelectedTags = this.selectedApiRequestFilterTags && this.selectedApiRequestFilterTags.length > 0;
            const hasSearchKeyword = this.apiRequestTagFilterSearchKeyword && this.apiRequestTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.apiRequestTagFilterNoTags || hasSearchKeyword;
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.cursor = hasActiveFilter ? 'pointer' : 'default';
        }
        
        const tagFilterList = this.sessionSidebar.querySelector('.api-request-tag-filter-list');
        if (!tagFilterList) return;
        
        // æ¸…ç©ºç°æœ‰æ ‡ç­¾
        tagFilterList.innerHTML = '';
        
        // è·å–æ‰€æœ‰æ ‡ç­¾ï¼ˆä½¿ç”¨æ‰€æœ‰è¯·æ±‚ï¼Œç¡®ä¿æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„æ ‡ç­¾ï¼‰
        // æ ‡ç­¾åˆ—è¡¨åº”è¯¥æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„æ ‡ç­¾ï¼Œä½†æ•°é‡ä¼šåŸºäºè¿‡æ»¤åçš„è¯·æ±‚è®¡ç®—
        const allTags = this.getAllApiRequestTags(false);
        
        // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤æ ‡ç­¾
        let filteredTags = allTags;
        const searchKeyword = (this.apiRequestTagFilterSearchKeyword || '').trim().toLowerCase();
        if (searchKeyword) {
            filteredTags = allTags.filter(tag => 
                tag.toLowerCase().includes(searchKeyword)
            );
        }
        
        if (filteredTags.length === 0) {
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ ‡ç­¾ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const expandToggleBtn = this.sessionSidebar.querySelector('.api-request-tag-filter-expand-btn');
            if (expandToggleBtn) {
                expandToggleBtn.style.display = 'none';
            }
            // æ˜¾ç¤º"æ— åŒ¹é…æ ‡ç­¾"æç¤º
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = searchKeyword ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ ‡ç­¾' : 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                padding: 8px !important;
                text-align: center !important;
                color: #9ca3af !important;
                font-size: 11px !important;
            `;
            tagFilterList.appendChild(emptyMsg);
            return;
        }
        
        // ç¡®å®šè¦æ˜¾ç¤ºçš„æ ‡ç­¾ï¼ˆæ ¹æ®æŠ˜å çŠ¶æ€ï¼‰
        // ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾å§‹ç»ˆæ˜¾ç¤º
        const selectedTags = this.selectedApiRequestFilterTags || [];
        let visibleTags;
        let hasMoreTags;
        
        if (this.apiRequestTagFilterExpanded || searchKeyword) {
            // å±•å¼€çŠ¶æ€æˆ–æœ‰æœç´¢å…³é”®è¯æ—¶ï¼šæ˜¾ç¤ºæ‰€æœ‰è¿‡æ»¤åçš„æ ‡ç­¾
            visibleTags = filteredTags;
            hasMoreTags = false;
        } else {
            // æŠ˜å çŠ¶æ€ï¼šæ˜¾ç¤ºå‰Nä¸ªæ ‡ç­¾ï¼Œä½†ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾ä¹Ÿåœ¨å…¶ä¸­
            const defaultVisible = filteredTags.slice(0, this.apiRequestTagFilterVisibleCount);
            const selectedNotInDefault = selectedTags.filter(tag => !defaultVisible.includes(tag));
            
            // ä¿æŒfilteredTagsçš„åŸå§‹é¡ºåºï¼Œä½†ç¡®ä¿é€‰ä¸­çš„æ ‡ç­¾ä¹Ÿåœ¨å¯è§åˆ—è¡¨ä¸­
            const visibleSet = new Set([...defaultVisible, ...selectedNotInDefault]);
            visibleTags = filteredTags.filter(tag => visibleSet.has(tag));
            hasMoreTags = filteredTags.length > visibleTags.length;
        }
        
        // æ›´æ–°å±•å¼€/æŠ˜å æŒ‰é’®ï¼ˆæœ‰æœç´¢å…³é”®è¯æ—¶éšè—ï¼‰
        const expandToggleBtn = this.sessionSidebar.querySelector('.api-request-tag-filter-expand-btn');
        if (expandToggleBtn) {
            if (searchKeyword) {
                // æœ‰æœç´¢å…³é”®è¯æ—¶éšè—å±•å¼€/æŠ˜å æŒ‰é’®
                expandToggleBtn.style.display = 'none';
            } else if (hasMoreTags || this.apiRequestTagFilterExpanded) {
                expandToggleBtn.style.display = 'block';
                if (this.apiRequestTagFilterExpanded) {
                    expandToggleBtn.innerHTML = 'â–²';
                    expandToggleBtn.title = 'æ”¶èµ·æ ‡ç­¾';
                } else {
                    expandToggleBtn.innerHTML = 'â–¼';
                    expandToggleBtn.title = 'å±•å¼€æ ‡ç­¾';
                }
            } else {
                expandToggleBtn.style.display = 'none';
            }
        }
        
        // è®¡ç®—æ¯ä¸ªæ ‡ç­¾å¯¹åº”çš„è¯·æ±‚æ•°é‡
        // æ ‡ç­¾ç»Ÿè®¡åº”è¯¥åŸºäºè¿‡æ»¤åçš„è¯·æ±‚åˆ—è¡¨ï¼ˆåº”ç”¨æœç´¢å…³é”®è¯ã€æ— æ ‡ç­¾ç­›é€‰ã€CSS/JSè¿‡æ»¤ã€å»é‡ï¼‰
        // ä½†ä¸åº”ç”¨æ ‡ç­¾è¿‡æ»¤æœ¬èº«ï¼Œè¿™æ ·æ ‡ç­¾æ•°é‡èƒ½åæ˜ å½“å‰åˆ—è¡¨ä¸­çš„å®é™…æ•°é‡
        const tagCounts = {};
        let requestsForStats = [];
        
        if (this.apiRequestManager) {
            // è·å–æ‰€æœ‰è¯·æ±‚
            requestsForStats = this.apiRequestManager.getAllRequests();
            
            // ç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½æœ‰åŸŸåæ ‡ç­¾ï¼ˆä¸ºæ—§è¯·æ±‚è‡ªåŠ¨æ·»åŠ ï¼‰
            requestsForStats.forEach(req => {
                if (req.url) {
                    if (!req.tags || !Array.isArray(req.tags) || req.tags.length === 0) {
                        const domain = this.apiRequestManager._extractDomain(req.url);
                        if (domain) {
                            req.tags = [domain];
                        }
                    } else {
                        const domain = this.apiRequestManager._extractDomain(req.url);
                        if (domain && !req.tags.includes(domain)) {
                            req.tags.push(domain);
                        }
                    }
                }
            });
            
            // åº”ç”¨æœç´¢å…³é”®è¯è¿‡æ»¤
            if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
                const filterKeyword = this.sessionTitleFilter.trim().toLowerCase();
                requestsForStats = requestsForStats.filter(req => {
                    const url = (req.url || '').toLowerCase();
                    const method = (req.method || '').toLowerCase();
                    const status = String(req.status || '');
                    return url.includes(filterKeyword) || 
                           method.includes(filterKeyword) ||
                           status.includes(filterKeyword);
                });
            }
            
            // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (this.apiRequestTagFilterNoTags) {
                requestsForStats = requestsForStats.filter(req => {
                    const requestTags = req.tags || [];
                    const hasTags = requestTags.length > 0 && requestTags.some(tag => tag && tag.trim().length > 0);
                    return !hasTags; // åªç»Ÿè®¡æ²¡æœ‰æ ‡ç­¾çš„è¯·æ±‚
                });
            }
            
            // è¿‡æ»¤æ‰ CSS å’Œ JS è¯·æ±‚ï¼ˆä¸ _getFilteredApiRequests ä¿æŒä¸€è‡´ï¼‰
            requestsForStats = requestsForStats.filter(req => {
                const url = req.url || '';
                const contentType = req.responseHeaders?.['content-type'] || 
                                  req.responseHeaders?.['Content-Type'] || '';
                
                // æ£€æŸ¥ URL æ˜¯å¦ä»¥ .css æˆ– .js ç»“å°¾
                if (/\.(css|js)$/i.test(url)) {
                    return false;
                }
                
                // æ£€æŸ¥ Content-Type æ˜¯å¦æ˜¯ CSS æˆ– JavaScript
                if (contentType) {
                    if (/^text\/css/i.test(contentType) || 
                        /^(text|application)\/(javascript|ecmascript|x-javascript)/i.test(contentType)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // å»é‡ï¼šå»æ‰URLé‡å¤çš„è¯·æ±‚ï¼Œä¿ç•™æ—¶é—´æˆ³æœ€æ–°çš„ï¼ˆä¸ _getFilteredApiRequests ä¿æŒä¸€è‡´ï¼‰
            const urlMap = new Map();
            requestsForStats.forEach(req => {
                const url = req.url || '';
                if (!url) return;
                
                const existingReq = urlMap.get(url);
                if (!existingReq) {
                    urlMap.set(url, req);
                } else {
                    // ä¿ç•™æ—¶é—´æˆ³æœ€æ–°çš„
                    const existingTimestamp = existingReq.timestamp || 0;
                    const currentTimestamp = req.timestamp || 0;
                    if (currentTimestamp > existingTimestamp) {
                        urlMap.set(url, req);
                    }
                }
            });
            requestsForStats = Array.from(urlMap.values());
        }
        
        // è®¡ç®—æ¯ä¸ªæ ‡ç­¾åœ¨è¿‡æ»¤åè¯·æ±‚åˆ—è¡¨ä¸­çš„æ•°é‡
        requestsForStats.forEach(req => {
            if (req.tags && Array.isArray(req.tags)) {
                req.tags.forEach(t => {
                    if (t && t.trim()) {
                        const normalizedTag = t.trim();
                        tagCounts[normalizedTag] = (tagCounts[normalizedTag] || 0) + 1;
                    }
                });
            }
        });
        
        // åˆ›å»ºæ ‡ç­¾æŒ‰é’®
        visibleTags.forEach(tag => {
            const tagBtn = document.createElement('button');
            tagBtn.className = 'api-request-tag-filter-item';
            const count = tagCounts[tag] || 0;
            tagBtn.textContent = `${tag} (${count})`;
            const isSelected = this.selectedApiRequestFilterTags && this.selectedApiRequestFilterTags.includes(tag);
            
            tagBtn.style.cssText = `
                padding: 3px 8px !important;
                border-radius: 10px !important;
                border: 1px solid ${isSelected ? '#4CAF50' : '#e5e7eb'} !important;
                background: ${isSelected ? '#4CAF50' : '#f9fafb'} !important;
                color: ${isSelected ? 'white' : '#6b7280'} !important;
                font-size: 10px !important;
                font-weight: ${isSelected ? '500' : '400'} !important;
                cursor: pointer !important;
                transition: all 0.15s ease !important;
                white-space: nowrap !important;
                line-height: 1.4 !important;
            `;
            
            tagBtn.addEventListener('mouseenter', () => {
                if (!isSelected) {
                    tagBtn.style.borderColor = '#4CAF50';
                    tagBtn.style.background = '#f0fdf4';
                    tagBtn.style.color = '#4CAF50';
                } else {
                    tagBtn.style.opacity = '0.9';
                }
            });
            tagBtn.addEventListener('mouseleave', () => {
                if (!isSelected) {
                    tagBtn.style.borderColor = '#e5e7eb';
                    tagBtn.style.background = '#f9fafb';
                    tagBtn.style.color = '#6b7280';
                } else {
                    tagBtn.style.opacity = '1';
                }
            });
            tagBtn.addEventListener('click', () => {
                if (!this.selectedApiRequestFilterTags) {
                    this.selectedApiRequestFilterTags = [];
                }
                
                const index = this.selectedApiRequestFilterTags.indexOf(tag);
                if (index > -1) {
                    // å–æ¶ˆé€‰ä¸­
                    this.selectedApiRequestFilterTags.splice(index, 1);
                } else {
                    // é€‰ä¸­
                    this.selectedApiRequestFilterTags.push(tag);
                }
                
                // æ›´æ–°æ‰€æœ‰æ ‡ç­¾æŒ‰é’®ï¼ˆç¡®ä¿çŠ¶æ€ä¸€è‡´ï¼‰
                this.updateApiRequestTagFilterUI();
                // æ›´æ–°è¯·æ±‚æ¥å£åˆ—è¡¨ï¼ˆåº”ç”¨è¿‡æ»¤ï¼‰
                this.updateApiRequestSidebar();
            });
            
            tagFilterList.appendChild(tagBtn);
        });
    }

    // åˆ›å»ºè¯·æ±‚æ¥å£æ ‡ç­¾ç­›é€‰å™¨
    createApiRequestTagFilter() {
        if (!this.sessionSidebar) return;
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        let apiRequestTagFilterContainer = this.sessionSidebar.querySelector('.api-request-tag-filter-container');
        if (apiRequestTagFilterContainer) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œåªæ›´æ–°UI
            this.updateApiRequestTagFilterUI();
            return;
        }
        
        const mainColor = PET_CONFIG?.theme?.primaryColor || '#6366f1';
        
        // åˆ›å»ºæ ‡ç­¾è¿‡æ»¤å™¨å®¹å™¨
        apiRequestTagFilterContainer = document.createElement('div');
        apiRequestTagFilterContainer.className = 'api-request-tag-filter-container';
        apiRequestTagFilterContainer.style.cssText = `
            padding: 8px 12px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #ffffff !important;
            overflow: visible !important;
            flex-shrink: 0 !important;
        `;

        // è¿‡æ»¤å™¨æ ‡é¢˜è¡Œï¼ˆåŒ…å«æœç´¢è¾“å…¥æ¡†å’Œæ“ä½œæŒ‰é’®ï¼‰
        const filterHeader = document.createElement('div');
        filterHeader.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 8px !important;
            margin-bottom: 6px !important;
        `;

        // å³ä¾§æ“ä½œåŒºï¼ˆåå‘è¿‡æ»¤å¼€å…³ + æ¸…é™¤æŒ‰é’®ï¼‰
        const filterActions = document.createElement('div');
        filterActions.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
        `;

        // åå‘è¿‡æ»¤å¼€å…³
        const reverseFilterBtn = document.createElement('button');
        reverseFilterBtn.className = 'api-request-tag-filter-reverse';
        reverseFilterBtn.title = 'åå‘è¿‡æ»¤';
        reverseFilterBtn.innerHTML = 'â‡„';
        reverseFilterBtn.style.cssText = `
            font-size: 12px !important;
            color: ${this.apiRequestTagFilterReverse ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.apiRequestTagFilterReverse ? '1' : '0.6'} !important;
        `;
        reverseFilterBtn.addEventListener('mouseenter', () => {
            reverseFilterBtn.style.opacity = '1';
            reverseFilterBtn.style.background = '#f3f4f6';
        });
        reverseFilterBtn.addEventListener('mouseleave', () => {
            if (!this.apiRequestTagFilterReverse) {
                reverseFilterBtn.style.opacity = '0.6';
            }
            reverseFilterBtn.style.background = 'none';
        });
        reverseFilterBtn.addEventListener('click', () => {
            this.apiRequestTagFilterReverse = !this.apiRequestTagFilterReverse;
            reverseFilterBtn.style.color = this.apiRequestTagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.apiRequestTagFilterReverse ? '1' : '0.6';
            this.updateApiRequestSidebar();
        });

        // æ— æ ‡ç­¾ç­›é€‰å¼€å…³
        const noTagsFilterBtn = document.createElement('button');
        noTagsFilterBtn.className = 'api-request-tag-filter-no-tags';
        noTagsFilterBtn.title = 'ç­›é€‰æ— æ ‡ç­¾';
        noTagsFilterBtn.innerHTML = 'âˆ…';
        noTagsFilterBtn.style.cssText = `
            font-size: 12px !important;
            color: ${this.apiRequestTagFilterNoTags ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.apiRequestTagFilterNoTags ? '1' : '0.6'} !important;
        `;
        noTagsFilterBtn.addEventListener('mouseenter', () => {
            noTagsFilterBtn.style.opacity = '1';
            noTagsFilterBtn.style.background = '#f3f4f6';
        });
        noTagsFilterBtn.addEventListener('mouseleave', () => {
            if (!this.apiRequestTagFilterNoTags) {
                noTagsFilterBtn.style.opacity = '0.6';
            }
            noTagsFilterBtn.style.background = 'none';
        });
        noTagsFilterBtn.addEventListener('click', () => {
            this.apiRequestTagFilterNoTags = !this.apiRequestTagFilterNoTags;
            noTagsFilterBtn.style.color = this.apiRequestTagFilterNoTags ? '#4CAF50' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.apiRequestTagFilterNoTags ? '1' : '0.6';
            this.updateApiRequestTagFilterUI();
            this.updateApiRequestSidebar();
        });

        // å±•å¼€/æ”¶èµ·æŒ‰é’®
        const expandToggleBtn = document.createElement('button');
        expandToggleBtn.className = 'api-request-tag-filter-expand-btn';
        expandToggleBtn.title = 'å±•å¼€æ ‡ç­¾';
        expandToggleBtn.innerHTML = 'â–¼';
        expandToggleBtn.style.cssText = `
            font-size: 10px !important;
            color: #9ca3af !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: 0.6 !important;
            display: none !important;
        `;
        expandToggleBtn.addEventListener('mouseenter', () => {
            expandToggleBtn.style.opacity = '1';
            expandToggleBtn.style.background = '#f3f4f6';
        });
        expandToggleBtn.addEventListener('mouseleave', () => {
            expandToggleBtn.style.opacity = '0.6';
            expandToggleBtn.style.background = 'none';
        });
        expandToggleBtn.addEventListener('click', () => {
            this.apiRequestTagFilterExpanded = !this.apiRequestTagFilterExpanded;
            this.updateApiRequestTagFilterUI();
        });

        // æ¸…é™¤æŒ‰é’®
        const clearFilterBtn = document.createElement('button');
        clearFilterBtn.className = 'api-request-tag-filter-clear';
        clearFilterBtn.textContent = 'Ã—';
        clearFilterBtn.title = 'æ¸…é™¤ç­›é€‰';
        clearFilterBtn.style.cssText = `
            font-size: 16px !important;
            color: #9ca3af !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 0 !important;
            width: 18px !important;
            height: 18px !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            opacity: 0.6 !important;
        `;
        clearFilterBtn.addEventListener('mouseenter', () => {
            const hasSelectedTags = this.selectedApiRequestFilterTags && this.selectedApiRequestFilterTags.length > 0;
            const hasSearchKeyword = this.apiRequestTagFilterSearchKeyword && this.apiRequestTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.apiRequestTagFilterNoTags || hasSearchKeyword;
            if (hasActiveFilter) {
                clearFilterBtn.style.color = '#ef4444';
                clearFilterBtn.style.opacity = '1';
                clearFilterBtn.style.background = '#fee2e2';
            } else {
                clearFilterBtn.style.opacity = '0.4';
            }
        });
        clearFilterBtn.addEventListener('mouseleave', () => {
            const hasSelectedTags = this.selectedApiRequestFilterTags && this.selectedApiRequestFilterTags.length > 0;
            const hasSearchKeyword = this.apiRequestTagFilterSearchKeyword && this.apiRequestTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.apiRequestTagFilterNoTags || hasSearchKeyword;
            clearFilterBtn.style.color = '#9ca3af';
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.background = 'none';
        });
        clearFilterBtn.addEventListener('click', () => {
            const hasSelectedTags = this.selectedApiRequestFilterTags && this.selectedApiRequestFilterTags.length > 0;
            const hasSearchKeyword = this.apiRequestTagFilterSearchKeyword && this.apiRequestTagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.apiRequestTagFilterNoTags || hasSearchKeyword;
            if (hasActiveFilter) {
                this.selectedApiRequestFilterTags = [];
                this.apiRequestTagFilterNoTags = false;
                this.apiRequestTagFilterSearchKeyword = '';
                // æ›´æ–°æœç´¢è¾“å…¥æ¡†çš„å€¼å’Œæ¸…é™¤æŒ‰é’®çŠ¶æ€
                const tagSearchInput = this.sessionSidebar.querySelector('.api-request-tag-filter-search');
                const tagSearchClearBtn = this.sessionSidebar.querySelector('.api-request-tag-filter-search-clear');
                if (tagSearchInput) {
                    tagSearchInput.value = '';
                }
                if (tagSearchClearBtn) {
                    tagSearchClearBtn.style.display = 'none';
                }
                const tagSearchIcon = this.sessionSidebar.querySelector('.api-request-tag-filter-search-container span');
                if (tagSearchIcon && tagSearchIcon.textContent === 'ğŸ”') {
                    tagSearchIcon.style.opacity = '0.5';
                }
                this.updateApiRequestTagFilterUI();
                this.updateApiRequestSidebar();
            }
        });

        filterActions.appendChild(reverseFilterBtn);
        filterActions.appendChild(noTagsFilterBtn);
        filterActions.appendChild(expandToggleBtn);
        filterActions.appendChild(clearFilterBtn);

        // åˆ›å»ºæ ‡ç­¾æœç´¢è¾“å…¥æ¡†å®¹å™¨
        const tagSearchContainer = document.createElement('div');
        tagSearchContainer.className = 'api-request-tag-filter-search-container';
        tagSearchContainer.style.cssText = `
            position: relative !important;
            flex: 1 !important;
            display: flex !important;
            align-items: center !important;
        `;

        // æœç´¢å›¾æ ‡
        const tagSearchIcon = document.createElement('span');
        tagSearchIcon.textContent = 'ğŸ”';
        tagSearchIcon.style.cssText = `
            position: absolute !important;
            left: 8px !important;
            font-size: 12px !important;
            pointer-events: none !important;
            z-index: 1 !important;
            opacity: 0.5 !important;
            transition: opacity 0.2s ease !important;
        `;

        // æ ‡ç­¾æœç´¢è¾“å…¥æ¡†
        const tagSearchInput = document.createElement('input');
        tagSearchInput.className = 'api-request-tag-filter-search';
        tagSearchInput.type = 'text';
        tagSearchInput.placeholder = 'æœç´¢æ ‡ç­¾...';
        tagSearchInput.value = this.apiRequestTagFilterSearchKeyword || '';
        tagSearchInput.style.cssText = `
            width: 100% !important;
            font-weight: 400 !important;
            font-size: 12px !important;
            color: #374151 !important;
            padding: 4px 24px 4px 24px !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 6px !important;
            background: #ffffff !important;
            outline: none !important;
            transition: all 0.2s ease !important;
            box-sizing: border-box !important;
            height: 24px !important;
        `;

        // æ·»åŠ å ä½ç¬¦æ ·å¼
        if (!document.getElementById('api-request-tag-search-placeholder-style')) {
            const style = document.createElement('style');
            style.id = 'api-request-tag-search-placeholder-style';
            style.textContent = `
                .api-request-tag-filter-search::placeholder {
                    color: #9ca3af !important;
                    opacity: 1 !important;
                }
                .api-request-tag-filter-search:focus::placeholder {
                    color: #d1d5db !important;
                }
            `;
            document.head.appendChild(style);
        }

        // æ¸…é™¤æŒ‰é’®ï¼ˆä½äºè¾“å…¥æ¡†å³ä¾§ï¼‰
        const tagSearchClearBtn = document.createElement('button');
        tagSearchClearBtn.innerHTML = 'âœ•';
        tagSearchClearBtn.type = 'button';
        tagSearchClearBtn.className = 'api-request-tag-filter-search-clear';
        tagSearchClearBtn.style.cssText = `
            position: absolute !important;
            right: 4px !important;
            width: 16px !important;
            height: 16px !important;
            border: none !important;
            background: #e5e7eb !important;
            color: #6b7280 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            padding: 0 !important;
            transition: all 0.2s ease !important;
            z-index: 2 !important;
            line-height: 1 !important;
        `;

        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        const updateTagSearchClearButton = () => {
            if (tagSearchInput.value.trim() !== '') {
                tagSearchClearBtn.style.display = 'flex';
                tagSearchIcon.style.opacity = '0.3';
            } else {
                tagSearchClearBtn.style.display = 'none';
                tagSearchIcon.style.opacity = '0.5';
            }
        };

        // åˆå§‹çŠ¶æ€
        updateTagSearchClearButton();

        // æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        tagSearchClearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            tagSearchInput.value = '';
            this.apiRequestTagFilterSearchKeyword = '';
            updateTagSearchClearButton();
            this.updateApiRequestTagFilterUI();
            tagSearchInput.focus();
        });

        // æ¸…é™¤æŒ‰é’®æ‚¬åœæ•ˆæœ
        tagSearchClearBtn.addEventListener('mouseenter', () => {
            tagSearchClearBtn.style.background = '#d1d5db';
            tagSearchClearBtn.style.transform = 'scale(1.15)';
        });
        tagSearchClearBtn.addEventListener('mouseleave', () => {
            tagSearchClearBtn.style.background = '#e5e7eb';
            tagSearchClearBtn.style.transform = 'scale(1)';
        });

        // è¾“å…¥æ¡†èšç„¦å’Œå¤±ç„¦æ ·å¼
        tagSearchInput.addEventListener('focus', () => {
            tagSearchInput.style.borderColor = mainColor;
            tagSearchInput.style.boxShadow = `0 0 0 2px ${mainColor}22`;
            tagSearchIcon.style.opacity = '0.7';
        });
        tagSearchInput.addEventListener('blur', () => {
            tagSearchInput.style.borderColor = '#e5e7eb';
            tagSearchInput.style.boxShadow = 'none';
            tagSearchIcon.style.opacity = tagSearchInput.value.trim() !== '' ? '0.3' : '0.5';
        });

        // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶è¿‡æ»¤æ ‡ç­¾ï¼ˆæ·»åŠ é˜²æŠ–ï¼‰
        let tagSearchDebounceTimer = null;
        tagSearchInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            this.apiRequestTagFilterSearchKeyword = value;
            updateTagSearchClearButton();
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (tagSearchDebounceTimer) {
                clearTimeout(tagSearchDebounceTimer);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼ˆé˜²æŠ–ï¼‰
            tagSearchDebounceTimer = setTimeout(() => {
                this.updateApiRequestTagFilterUI();
            }, 200);
        });

        tagSearchContainer.appendChild(tagSearchIcon);
        tagSearchContainer.appendChild(tagSearchInput);
        tagSearchContainer.appendChild(tagSearchClearBtn);

        filterHeader.appendChild(tagSearchContainer);
        filterHeader.appendChild(filterActions);

        // æ ‡ç­¾åˆ—è¡¨å®¹å™¨
        const tagFilterList = document.createElement('div');
        tagFilterList.className = 'api-request-tag-filter-list';
        tagFilterList.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 4px !important;
            position: relative !important;
        `;

        apiRequestTagFilterContainer.appendChild(filterHeader);
        apiRequestTagFilterContainer.appendChild(tagFilterList);

        // æ’å…¥åˆ°ä¾§è¾¹æ é¡¶éƒ¨ï¼ˆåœ¨è¯·æ±‚æ¥å£åˆ—è¡¨ä¹‹å‰ï¼‰
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        if (apiRequestList) {
            this.sessionSidebar.insertBefore(apiRequestTagFilterContainer, apiRequestList);
        } else {
            this.sessionSidebar.appendChild(apiRequestTagFilterContainer);
        }

        // åˆå§‹åŒ–æ ‡ç­¾åˆ—è¡¨
        this.updateApiRequestTagFilterUI();
    }

    // æ›´æ–°æ–°é—»åˆ—è¡¨ä¾§è¾¹æ 
    async updateNewsSidebar(forceRefresh = false) {
        if (!this.sessionSidebar) {
            console.log('ä¾§è¾¹æ æœªåˆ›å»ºï¼Œè·³è¿‡æ›´æ–°');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥
        const wasOssFileListVisible = this.ossFileListVisible;
        const wasNewsListVisible = this.newsListVisible;
        
        // ç¡®ä¿è§†å›¾æ¨¡å¼çŠ¶æ€æ­£ç¡®
        this.newsListVisible = true;
        this.ossFileListVisible = false;
        this.apiRequestListVisible = false;
        
        // å¦‚æœè§†å›¾çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥ï¼‰ï¼Œæ¸…ç©ºèŠå¤©æ¶ˆæ¯
        if (!wasNewsListVisible) {
            this.clearChatMessages();
        }
        
        // éšè—ä¼šè¯åˆ—è¡¨ç›¸å…³å…ƒç´ 
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        const tagFilterContainer = this.sessionSidebar.querySelector('.tag-filter-container');
        const batchToolbar = this.sessionSidebar.querySelector('#batch-toolbar');
        const scrollableContent = this.sessionSidebar.querySelector('.session-sidebar-scrollable-content');
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        const ossTagFilterContainer = this.sessionSidebar.querySelector('.oss-tag-filter-container');
        
        if (sessionList) {
            sessionList.style.display = 'none';
        }
        if (tagFilterContainer) {
            tagFilterContainer.style.display = 'none';
        }
        if (scrollableContent) {
            scrollableContent.style.display = 'none';
        }
        if (ossFileList) {
            ossFileList.style.display = 'none';
        }
        if (ossTagFilterContainer) {
            ossTagFilterContainer.style.display = 'none';
        }
        
        // éšè—æ¥å£è¯·æ±‚åˆ—è¡¨
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        if (apiRequestList) {
            apiRequestList.style.display = 'none';
        }
        
        // éšè—è¯·æ±‚æ¥å£æ ‡ç­¾è¿‡æ»¤å™¨ï¼ˆåªåœ¨è¯·æ±‚æ¥å£è§†å›¾ä¸­æ˜¾ç¤ºï¼‰
        const apiRequestTagFilterContainer = this.sessionSidebar.querySelector('.api-request-tag-filter-container');
        if (apiRequestTagFilterContainer) {
            apiRequestTagFilterContainer.style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ–°é—»æ ‡ç­¾è¿‡æ»¤å™¨
        let newsTagFilterContainer = this.sessionSidebar.querySelector('.news-tag-filter-container');
        if (newsTagFilterContainer) {
            newsTagFilterContainer.style.display = 'block';
        }
        // æ‰¹é‡å·¥å…·æ åœ¨æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤º
        if (batchToolbar && this.batchMode) {
            batchToolbar.style.display = 'flex';
        } else if (batchToolbar) {
            batchToolbar.style.display = 'none';
        }
        
        // è·å–æˆ–åˆ›å»ºæ–°é—»åˆ—è¡¨å®¹å™¨
        let newsList = this.sessionSidebar.querySelector('.news-list');
        if (!newsList) {
            newsList = document.createElement('div');
            newsList.className = 'news-list';
            newsList.style.cssText = `
                flex: 1 !important;
                overflow-y: auto !important;
                padding: 8px 8px 220px 8px !important;
                scroll-padding-bottom: 20px !important;
                box-sizing: border-box !important;
            `;
            this.sessionSidebar.appendChild(newsList);
        }
        newsList.style.display = 'block';
        
        // æ›´æ–°æœç´¢æ¡†å ä½ç¬¦
        const searchInput = this.sessionSidebar.querySelector('#session-search-input');
        if (searchInput) {
            searchInput.placeholder = 'æœç´¢æ–°é—»...';
        }
        
        // åˆ›å»ºæˆ–æ›´æ–°æ–°é—»æ ‡ç­¾è¿‡æ»¤å™¨
        this.createNewsTagFilter();
        
        // æ˜¾ç¤ºæ–°é—»æ ‡ç­¾è¿‡æ»¤å™¨ï¼ˆé‡æ–°æŸ¥è¯¢ï¼Œå› ä¸º createNewsTagFilter å¯èƒ½é‡æ–°åˆ›å»ºäº†å®¹å™¨ï¼‰
        newsTagFilterContainer = this.sessionSidebar.querySelector('.news-tag-filter-container');
        if (newsTagFilterContainer) {
            newsTagFilterContainer.style.display = 'block';
        }
        
        // åŠ è½½æ–°é—»åˆ—è¡¨
        // ä¼˜åŒ–ï¼šé»˜è®¤ä¸è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡åˆ‡æ¢æ–°é—»è§†å›¾æ—¶æ‰è¯·æ±‚
        // å¦‚æœæœ‰æ—¥æœŸç­›é€‰ï¼Œåˆ™æ ¹æ®æ—¥æœŸåŒºé—´è°ƒç”¨APIæŸ¥è¯¢
        try {
            if (this.newsManager) {
                let isoDate = null;
                let shouldLoadNews = false;
                let currentDateRange = null;
                
                // å¦‚æœæœ‰æ—¥æœŸç­›é€‰ï¼Œæ ¹æ®æ—¥æœŸç­›é€‰å™¨æ„å»ºæ—¥æœŸåŒºé—´å‚æ•°
                if (this.dateRangeFilter) {
                    if (this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                        // æœ‰å¼€å§‹å’Œç»“æŸæ—¥æœŸ
                        const startStr = this.formatDateForNews(this.dateRangeFilter.startDate);
                        const endStr = this.formatDateForNews(this.dateRangeFilter.endDate);
                        isoDate = `${startStr},${endStr}`;
                        currentDateRange = isoDate;
                    } else if (this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
                        // åªæœ‰å¼€å§‹æ—¥æœŸï¼Œä½¿ç”¨å¼€å§‹æ—¥æœŸä½œä¸ºç»“æŸæ—¥æœŸ
                        const startStr = this.formatDateForNews(this.dateRangeFilter.startDate);
                        isoDate = `${startStr},${startStr}`;
                        currentDateRange = isoDate;
                    } else if (!this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                        // åªæœ‰ç»“æŸæ—¥æœŸï¼Œä½¿ç”¨ç»“æŸæ—¥æœŸä½œä¸ºå¼€å§‹å’Œç»“æŸæ—¥æœŸ
                        const endStr = this.formatDateForNews(this.dateRangeFilter.endDate);
                        isoDate = `${endStr},${endStr}`;
                        currentDateRange = isoDate;
                    }
                    // å¦‚æœæ—¥æœŸåŒºé—´æ”¹å˜äº†ï¼Œéœ€è¦é‡æ–°åŠ è½½
                    if (currentDateRange && currentDateRange !== this.lastNewsDateRange) {
                        shouldLoadNews = true;
                    }
                } else {
                    // æ²¡æœ‰æ—¥æœŸç­›é€‰æ—¶ï¼Œä½¿ç”¨ä»Šå¤©çš„æ—¥æœŸ
                    const today = new Date();
                    const dateStr = this.formatDateForNews(today);
                    isoDate = `${dateStr},${dateStr}`;
                    currentDateRange = isoDate;
                    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ‡æ¢æ–°é—»è§†å›¾ï¼Œæˆ–è€…å¼ºåˆ¶åˆ·æ–°ï¼Œæˆ–è€…æ—¥æœŸåŒºé—´æ”¹å˜äº†ï¼Œåˆ™è¯·æ±‚æ–°é—»
                    if (!this.hasRequestedNews || forceRefresh || currentDateRange !== this.lastNewsDateRange) {
                        shouldLoadNews = true;
                    }
                }
                
                // å¦‚æœéœ€è¦åŠ è½½æ–°é—»ï¼Œåˆ™è°ƒç”¨API
                if (shouldLoadNews) {
                    await this.newsManager.loadNews(true, isoDate); // å¼ºåˆ¶åˆ·æ–°
                    this.lastNewsDateRange = currentDateRange; // è®°å½•æœ¬æ¬¡åŠ è½½çš„æ—¥æœŸåŒºé—´
                    if (!this.dateRangeFilter) {
                        // åªæœ‰åœ¨æ²¡æœ‰æ—¥æœŸç­›é€‰æ—¶æ‰æ ‡è®°å·²è¯·æ±‚è¿‡ï¼ˆé¿å…æ—¥æœŸç­›é€‰æ—¶å½±å“åç»­åŠ è½½ï¼‰
                        this.hasRequestedNews = true;
                    }
                    // æ–°é—»åŠ è½½å®Œæˆåï¼Œæ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨UIä»¥æ˜¾ç¤ºæ­£ç¡®çš„æ•°é‡
                    this.updateNewsTagFilterUI();
                }
            }
        } catch (error) {
            console.warn('åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥:', error);
        }
        
        let news = this.newsManager ? this.newsManager.getAllNews() : [];
        
        // ç¡®ä¿æ ‡ç­¾è¿‡æ»¤å™¨UIå·²æ›´æ–°ï¼ˆå³ä½¿æ²¡æœ‰åŠ è½½æ–°é—»ï¼Œä¹Ÿè¦æ›´æ–°ä¸€æ¬¡ä»¥ç¡®ä¿æ•°é‡æ­£ç¡®ï¼‰
        this.updateNewsTagFilterUI();
        
        // è°ƒè¯•ï¼šè¾“å‡ºè·å–åˆ°çš„æ–°é—»æ•°æ®
        console.log('ä»newsManagerè·å–åˆ°çš„æ–°é—»æ•°é‡:', news.length);
        if (news.length > 0) {
            console.log('ç¬¬ä¸€æ¡æ–°é—»ç¤ºä¾‹:', news[0]);
            // è°ƒè¯•ï¼šè¾“å‡ºç¬¬ä¸€æ¡æ–°é—»çš„æ‰€æœ‰æ—¶é—´ç›¸å…³å­—æ®µ
            const firstNews = news[0];
            const parsedTime = this.getNewsTime(firstNews);
            console.log('ç¬¬ä¸€æ¡æ–°é—»çš„æ—¶é—´å­—æ®µ:', {
                published: firstNews.published,
                pubDate: firstNews.pubDate,
                publishedAt: firstNews.publishedAt,
                date: firstNews.date,
                created_at: firstNews.created_at,
                createdAt: firstNews.createdAt,
                publishDate: firstNews.publishDate,
                pub_date: firstNews.pub_date,
                publish_date: firstNews.publish_date,
                allKeys: Object.keys(firstNews),
                parsedTime: parsedTime,
                formattedTime: parsedTime > 0 ? this.formatNewsTime(parsedTime) : 'æ— æ—¶é—´'
            });
        }
        
        // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤æ–°é—»ï¼ˆæœ¬åœ°è¿‡æ»¤ï¼‰
        if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
            const filterKeyword = this.sessionTitleFilter.trim().toLowerCase();
            news = news.filter(item => {
                const title = (item.title || '').toLowerCase();
                const description = (item.description || '').toLowerCase();
                const content = (item.content || '').toLowerCase();
                return title.includes(filterKeyword) || 
                       description.includes(filterKeyword) || 
                       content.includes(filterKeyword);
            });
        }
        
        // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰
        if (this.newsTagFilterNoTags) {
            news = news.filter(item => {
                const itemTags = item.tags || [];
                const hasTags = itemTags.length > 0 && itemTags.some(tag => tag && tag.trim().length > 0);
                return !hasTags; // åªæ˜¾ç¤ºæ²¡æœ‰æ ‡ç­¾çš„æ–°é—»
            });
        }
        
        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤
        if (this.selectedNewsFilterTags && this.selectedNewsFilterTags.length > 0) {
            news = news.filter(item => {
                const itemTags = (item.tags || []).map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const normalizedSelectedTags = this.selectedNewsFilterTags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const hasSelectedTags = normalizedSelectedTags.some(selectedTag => 
                    itemTags.includes(selectedTag)
                );
                
                if (this.newsTagFilterReverse) {
                    // åå‘è¿‡æ»¤ï¼šæ’é™¤åŒ…å«é€‰ä¸­æ ‡ç­¾çš„æ–°é—»
                    return !hasSelectedTags;
                } else {
                    // æ­£å‘è¿‡æ»¤ï¼šåªæ˜¾ç¤ºåŒ…å«é€‰ä¸­æ ‡ç­¾çš„æ–°é—»
                    return hasSelectedTags;
                }
            });
        }
        
        // æ³¨æ„ï¼šæ—¥æœŸåŒºé—´è¿‡æ»¤å·²é€šè¿‡APIè°ƒç”¨å®ç°ï¼Œä¸å†éœ€è¦æœ¬åœ°è¿‡æ»¤
        
        // æ¸…ç©ºåˆ—è¡¨
        newsList.innerHTML = '';
        
        if (news.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.style.cssText = `
                padding: 20px !important;
                text-align: center !important;
                color: #9ca3af !important;
                font-size: 12px !important;
            `;
            emptyMsg.textContent = this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '' ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ–°é—»' : 'æš‚æ— æ–°é—»';
            newsList.appendChild(emptyMsg);
            return;
        }
        
        // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        const sortedNews = news.sort((a, b) => {
            const aTime = this.getNewsTime(a);
            const bTime = this.getNewsTime(b);
            return bTime - aTime;
        });
        
        // ä¿å­˜å½“å‰æ–°é—»åˆ—è¡¨ï¼ˆç”¨äºé•¿æŒ‰åˆ é™¤ç­‰åŠŸèƒ½ï¼‰
        if (!window.currentNews) {
            window.currentNews = [];
        }
        window.currentNews = sortedNews;
        
        // åˆ›å»ºæ–°é—»åˆ—è¡¨é¡¹
        for (let index = 0; index < sortedNews.length; index++) {
            const item = sortedNews[index];
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';
            newsItem.setAttribute('data-news-index', index);
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»ï¼šæ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦æ˜¯è¯¥æ–°é—»çš„ä¼šè¯
            let isActive = false;
            if (this.currentSessionId) {
                const currentSession = this.sessions[this.currentSessionId];
                if (currentSession && currentSession._isNewsSession && currentSession._newsInfo) {
                    // å½“å‰ä¼šè¯æ˜¯æ–°é—»ä¼šè¯ï¼Œæ£€æŸ¥æ–°é—»é“¾æ¥æ˜¯å¦åŒ¹é…
                    if (currentSession._newsInfo.link === item.link) {
                        isActive = true;
                        newsItem.classList.add('active');
                    }
                }
            }
            
            // æ‰¹é‡æ¨¡å¼ä¸‹æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»
            const newsId = item.link || item.id || index.toString(); // ä½¿ç”¨linkä½œä¸ºå”¯ä¸€æ ‡è¯†
            if (this.batchMode && this.selectedNewsIds.has(newsId)) {
                newsItem.classList.add('selected');
            }
            
            newsItem.style.cssText = `
                padding: 12px !important;
                margin-bottom: 8px !important;
                background: ${isActive ? '#eff6ff' : '#ffffff'} !important;
                border: 1px solid ${isActive ? '#3b82f6' : '#e5e7eb'} !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                box-shadow: ${isActive ? '0 2px 4px rgba(59, 130, 246, 0.2)' : '0 1px 2px rgba(0, 0, 0, 0.05)'} !important;
                position: relative !important;
            `;
            
            // åˆ›å»ºå¤é€‰æ¡†ï¼ˆä»…åœ¨æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'news-checkbox';
            checkbox.dataset.newsId = newsId;
            checkbox.checked = this.selectedNewsIds.has(newsId);
            checkbox.style.cssText = `
                width: 16px !important;
                height: 16px !important;
                cursor: pointer !important;
                margin-right: 8px !important;
                flex-shrink: 0 !important;
                display: ${this.batchMode ? 'block' : 'none'} !important;
            `;
            
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                const newsId = e.target.dataset.newsId;
                if (e.target.checked) {
                    this.selectedNewsIds.add(newsId);
                    newsItem.classList.add('selected');
                } else {
                    this.selectedNewsIds.delete(newsId);
                    newsItem.classList.remove('selected');
                }
                this.updateBatchToolbar();
            });
            
            // é˜»æ­¢å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶å†’æ³¡
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // æ–°é—»ä¿¡æ¯å®¹å™¨
            const newsInfo = document.createElement('div');
            newsInfo.className = 'news-info';
            newsInfo.style.cssText = `
                margin-bottom: ${this.batchMode ? '0' : '8px'} !important;
            `;
            
            // åˆ›å»ºæ–°é—»é¡¹å†…éƒ¨å®¹å™¨ï¼ˆåŒ…å«å¤é€‰æ¡†å’Œå†…å®¹ï¼‰
            const itemInner = document.createElement('div');
            itemInner.style.cssText = `
                display: flex !important;
                align-items: flex-start !important;
                width: 100% !important;
                gap: 8px !important;
            `;
            
            // æ·»åŠ å¤é€‰æ¡†
            itemInner.appendChild(checkbox);
            
            // åˆ›å»ºå†…å®¹åŒ…è£…å™¨
            const contentWrapper = document.createElement('div');
            contentWrapper.style.cssText = `
                flex: 1 !important;
                min-width: 0 !important;
            `;
            
            // åˆ›å»ºæ ‡é¢˜è¡Œå®¹å™¨ï¼ˆæ ‡é¢˜å’ŒæŒ‰é’®åœ¨åŒä¸€è¡Œï¼‰
            const titleRow = document.createElement('div');
            titleRow.style.cssText = `
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 8px !important;
                width: 100% !important;
                margin-bottom: 6px !important;
            `;
            
            // æ ‡é¢˜
            const title = document.createElement('div');
            title.style.cssText = `
                font-size: 14px !important;
                font-weight: 600 !important;
                color: #111827 !important;
                line-height: 1.4 !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
                overflow: hidden !important;
                flex: 1 !important;
                min-width: 0 !important;
            `;
            title.textContent = item.title || 'æ— æ ‡é¢˜';
            titleRow.appendChild(title);
            
            contentWrapper.appendChild(titleRow);
            
            // æè¿°
            if (item.description || item.content) {
                const description = document.createElement('div');
                description.style.cssText = `
                    font-size: 12px !important;
                    color: #6b7280 !important;
                    margin-bottom: 8px !important;
                    line-height: 1.5 !important;
                    display: -webkit-box !important;
                    -webkit-line-clamp: 2 !important;
                    -webkit-box-orient: vertical !important;
                    overflow: hidden !important;
                `;
                description.textContent = item.description || item.content || '';
                contentWrapper.appendChild(description);
            }
            
            // æ ‡ç­¾åŒºåŸŸï¼ˆé¢„ç•™ï¼Œåç»­å¯ä»¥æ·»åŠ æ ‡ç­¾åŠŸèƒ½ï¼‰
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'news-tags';
            tagsContainer.style.cssText = `
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 4px !important;
                margin-bottom: 8px !important;
            `;
            // å¦‚æœæœ‰æ ‡ç­¾ï¼Œæ˜¾ç¤ºæ ‡ç­¾
            if (item.tags && Array.isArray(item.tags) && item.tags.length > 0) {
                item.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'news-tag';
                    tagElement.textContent = tag;
                    // æ ¹æ®æ ‡ç­¾å†…å®¹ç”Ÿæˆé¢œè‰²ï¼ˆä½¿ç”¨å“ˆå¸Œå‡½æ•°ç¡®ä¿ç›¸åŒæ ‡ç­¾é¢œè‰²ä¸€è‡´ï¼‰
                    const tagColor = this.getTagColor(tag);
                    tagElement.style.cssText = `
                        display: inline-block !important;
                        padding: 3px 10px !important;
                        background: ${tagColor.background} !important;
                        color: ${tagColor.text} !important;
                        border-radius: 12px !important;
                        font-size: 11px !important;
                        font-weight: 500 !important;
                        border: 1px solid ${tagColor.border} !important;
                        transition: all 0.2s ease !important;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
                    `;
                    // æ·»åŠ æ‚¬åœæ•ˆæœ
                    tagElement.addEventListener('mouseenter', () => {
                        tagElement.style.transform = 'translateY(-1px)';
                        tagElement.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                    });
                    tagElement.addEventListener('mouseleave', () => {
                        tagElement.style.transform = 'translateY(0)';
                        tagElement.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                    });
                    tagsContainer.appendChild(tagElement);
                });
            }
            contentWrapper.appendChild(tagsContainer);
            
            // åº•éƒ¨ä¿¡æ¯ï¼ˆæ—¶é—´å’Œæ¥æºï¼‰
            const footer = document.createElement('div');
            footer.style.cssText = `
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                font-size: 11px !important;
                color: #9ca3af !important;
                margin-top: 8px !important;
            `;
            
            const time = document.createElement('span');
            const newsTime = this.getNewsTime(item);
            // å³ä½¿ newsTime ä¸º 0 ä¹Ÿå°è¯•æ ¼å¼åŒ–ï¼ˆformatNewsTime ä¼šå¤„ç†æ— æ•ˆæ—¶é—´æˆ³ï¼‰
            time.textContent = this.formatNewsTime(newsTime);
            footer.appendChild(time);
            
            // æ“ä½œæŒ‰é’®å®¹å™¨ï¼ˆç§»åŠ¨åˆ°footerä¸­ï¼‰
            const footerButtonContainer = document.createElement('div');
            footerButtonContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 4px !important;
            `;
            
            // ç¼–è¾‘æŒ‰é’®
            const editBtn = document.createElement('button');
            editBtn.className = 'news-edit-btn';
            editBtn.innerHTML = 'âœï¸';
            editBtn.title = 'ç¼–è¾‘æ–°é—»ä¿¡æ¯';
            editBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 2px 4px !important;
                font-size: 12px !important;
                opacity: 0.6 !important;
                transition: opacity 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
            `;
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.handleNewsEditButtonClick(item, index);
            });
            editBtn.addEventListener('mouseenter', () => {
                editBtn.style.opacity = '1';
            });
            editBtn.addEventListener('mouseleave', () => {
                editBtn.style.opacity = '0.6';
            });
            footerButtonContainer.appendChild(editBtn);
            
            // æ ‡ç­¾ç®¡ç†æŒ‰é’®
            const tagBtn = document.createElement('button');
            tagBtn.className = 'news-tag-btn';
            tagBtn.innerHTML = 'ğŸ·ï¸';
            tagBtn.title = 'ç®¡ç†æ ‡ç­¾';
            tagBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 2px 4px !important;
                font-size: 12px !important;
                opacity: 0.6 !important;
                transition: opacity 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
            `;
            tagBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.handleNewsTagButtonClick(item, index);
            });
            tagBtn.addEventListener('mouseenter', () => {
                tagBtn.style.opacity = '1';
            });
            tagBtn.addEventListener('mouseleave', () => {
                tagBtn.style.opacity = '0.6';
            });
            footerButtonContainer.appendChild(tagBtn);
            
            // è·³è½¬æŒ‰é’®ï¼ˆåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥ï¼‰
            if (item.link) {
                const linkBtn = document.createElement('button');
                linkBtn.className = 'news-link-btn';
                linkBtn.innerHTML = 'ğŸ”—';
                linkBtn.title = 'åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥';
                linkBtn.style.cssText = `
                    background: none !important;
                    border: none !important;
                    cursor: pointer !important;
                    padding: 2px 4px !important;
                    font-size: 12px !important;
                    opacity: 0.6 !important;
                    transition: opacity 0.2s ease !important;
                    line-height: 1 !important;
                    flex-shrink: 0 !important;
                `;
                linkBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€é“¾æ¥
                        await chrome.runtime.sendMessage({
                            action: 'openLinkInNewTab',
                            url: item.link
                        });
                    } catch (error) {
                        console.error('æ‰“å¼€é“¾æ¥å¤±è´¥:', error);
                        // å¦‚æœæ¶ˆæ¯å‘é€å¤±è´¥ï¼ˆä¾‹å¦‚æ‰©å±•ä¸Šä¸‹æ–‡å¤±æ•ˆï¼‰ï¼Œä½¿ç”¨ window.open ä½œä¸ºé™çº§æ–¹æ¡ˆ
                        if (item.link) {
                            try {
                                window.open(item.link, '_blank');
                            } catch (openError) {
                                console.error('ä½¿ç”¨window.openæ‰“å¼€é“¾æ¥å¤±è´¥:', openError);
                            }
                        }
                    }
                });
                linkBtn.addEventListener('mouseenter', () => {
                    linkBtn.style.opacity = '1';
                });
                linkBtn.addEventListener('mouseleave', () => {
                    linkBtn.style.opacity = '0.6';
                });
                footerButtonContainer.appendChild(linkBtn);
            }
            
            // ä¸Šä¸‹æ–‡æŒ‰é’®ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨ä¸­çš„ä¸Šä¸‹æ–‡æŒ‰é’®ï¼‰
            const contextBtn = document.createElement('button');
            contextBtn.className = 'news-context-btn';
            contextBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            `;
            contextBtn.title = 'é¡µé¢ä¸Šä¸‹æ–‡';
            contextBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 4px !important;
                opacity: 0.6 !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: inherit !important;
                border-radius: 4px !important;
            `;
            contextBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                // å…ˆæ¿€æ´»æˆ–åˆ›å»ºè¯¥æ–°é—»çš„ä¼šè¯
                await this.handleNewsClick(item);
                // ç¡®ä¿èŠå¤©çª—å£å·²æ‰“å¼€
                if (!this.chatWindow || !this.isChatOpen) {
                    await this.openChatWindow();
                }
                // æ‰“å¼€é¡µé¢ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨
                this.openContextEditor();
            });
            contextBtn.addEventListener('mouseenter', () => {
                contextBtn.style.opacity = '1';
                contextBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
            });
            contextBtn.addEventListener('mouseleave', () => {
                contextBtn.style.opacity = '0.6';
                contextBtn.style.background = 'none !important';
            });
            footerButtonContainer.appendChild(contextBtn);
            
            footer.appendChild(footerButtonContainer);
            contentWrapper.appendChild(footer);
            
            itemInner.appendChild(contentWrapper);
            newsInfo.appendChild(itemInner);
            newsItem.appendChild(newsInfo);
            
            // é•¿æŒ‰åˆ é™¤ç›¸å…³å˜é‡
            let longPressTimer = null;
            let longPressProgressTimer = null;
            let longPressThreshold = 800; // é•¿æŒ‰æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
            let isLongPressing = false;
            let hasMoved = false;
            let startX = 0;
            let startY = 0;
            let longPressStartTime = 0;
            const moveThreshold = 10; // ç§»åŠ¨é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼åˆ™å–æ¶ˆé•¿æŒ‰
            
            // åˆ›å»ºé•¿æŒ‰è¿›åº¦æŒ‡ç¤ºå™¨
            const progressBar = document.createElement('div');
            progressBar.className = 'long-press-progress';
            progressBar.style.cssText = `
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                height: 3px !important;
                background: rgba(244, 67, 54, 0.8) !important;
                width: 0% !important;
                border-radius: 0 0 8px 8px !important;
                transition: width 0.05s linear !important;
                z-index: 10 !important;
            `;
            newsItem.appendChild(progressBar);
            
            // åˆ›å»ºé•¿æŒ‰æç¤ºæ–‡æœ¬
            const hintText = document.createElement('div');
            hintText.className = 'long-press-hint';
            hintText.textContent = 'ç»§ç»­æŒ‰ä½ä»¥åˆ é™¤';
            hintText.style.cssText = `
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) scale(0) !important;
                background: rgba(244, 67, 54, 0.95) !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 6px !important;
                font-size: 12px !important;
                white-space: nowrap !important;
                pointer-events: none !important;
                z-index: 20 !important;
                opacity: 0 !important;
                transition: all 0.2s ease !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            `;
            newsItem.appendChild(hintText);
            
            // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
            const clearLongPress = () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                if (longPressProgressTimer) {
                    clearInterval(longPressProgressTimer);
                    longPressProgressTimer = null;
                }
                if (isLongPressing) {
                    newsItem.classList.remove('long-pressing', 'long-press-start', 
                        'long-press-stage-1', 'long-press-stage-2', 'long-press-stage-3');
                    isLongPressing = false;
                } else {
                    newsItem.classList.remove('long-press-start', 
                        'long-press-stage-1', 'long-press-stage-2', 'long-press-stage-3');
                }
                hasMoved = false;
                progressBar.style.width = '0%';
                hintText.style.opacity = '0';
                hintText.style.transform = 'translate(-50%, -50%) scale(0)';
                longPressStartTime = 0;
            };
            
            // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
            const triggerHapticFeedback = () => {
                if ('vibrate' in navigator) {
                    navigator.vibrate(50); // çŸ­éœ‡åŠ¨
                }
            };
            
            // å¼€å§‹é•¿æŒ‰æ£€æµ‹
            const startLongPress = (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘é•¿æŒ‰
                if (e.target.closest('button')) {
                    return;
                }
                
                hasMoved = false;
                startX = e.touches ? e.touches[0].clientX : e.clientX;
                startY = e.touches ? e.touches[0].clientY : e.clientY;
                longPressStartTime = Date.now();
                
                // æ·»åŠ å¼€å§‹é•¿æŒ‰çš„è§†è§‰åé¦ˆ
                newsItem.classList.add('long-press-start');
                
                // æ˜¾ç¤ºæç¤ºæ–‡æœ¬ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…ç«‹å³æ˜¾ç¤ºï¼‰
                setTimeout(() => {
                    if (longPressStartTime && !hasMoved) {
                        hintText.style.opacity = '1';
                        hintText.style.transform = 'translate(-50%, -50%) scale(1)';
                    }
                }, 200);
                
                // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
                let lastStage = 0;
                const progressInterval = 50; // æ¯50msæ›´æ–°ä¸€æ¬¡
                longPressProgressTimer = setInterval(() => {
                    if (hasMoved || !longPressStartTime) {
                        clearInterval(longPressProgressTimer);
                        return;
                    }
                    
                    const elapsed = Date.now() - longPressStartTime;
                    const progress = Math.min((elapsed / longPressThreshold) * 100, 100);
                    progressBar.style.width = progress + '%';
                    
                    // åœ¨ä¸åŒé˜¶æ®µæ·»åŠ åé¦ˆï¼ˆç¡®ä¿æ¯ä¸ªé˜¶æ®µåªè§¦å‘ä¸€æ¬¡ï¼‰
                    if (progress >= 30 && progress < 35 && lastStage < 1) {
                        newsItem.classList.add('long-press-stage-1');
                        lastStage = 1;
                    } else if (progress >= 60 && progress < 65 && lastStage < 2) {
                        newsItem.classList.remove('long-press-stage-1');
                        newsItem.classList.add('long-press-stage-2');
                        lastStage = 2;
                        triggerHapticFeedback(); // ä¸­æœŸéœ‡åŠ¨
                    } else if (progress >= 90 && progress < 95 && lastStage < 3) {
                        newsItem.classList.remove('long-press-stage-2');
                        newsItem.classList.add('long-press-stage-3');
                        lastStage = 3;
                        triggerHapticFeedback(); // æ¥è¿‘å®Œæˆæ—¶çš„éœ‡åŠ¨
                    }
                    
                    if (progress >= 100) {
                        clearInterval(longPressProgressTimer);
                    }
                }, progressInterval);
                
                longPressTimer = setTimeout(async () => {
                    if (!hasMoved) {
                        isLongPressing = true;
                        newsItem.classList.add('long-pressing');
                        triggerHapticFeedback(); // è§¦å‘åˆ é™¤å‰çš„éœ‡åŠ¨
                        
                        // è·å–æ–°é—»æ ‡é¢˜ç”¨äºæç¤º
                        const newsTitle = item?.title || item?.link || 'æœªå‘½åæ–°é—»';
                        
                        // ç¡®è®¤åˆ é™¤
                        const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤æ–°é—»"${newsTitle}"å—ï¼Ÿ`);
                        if (!confirmDelete) {
                            // ç”¨æˆ·å–æ¶ˆåˆ é™¤ï¼Œæ¸…é™¤é•¿æŒ‰çŠ¶æ€
                            clearLongPress();
                            return;
                        }
                        
                        // è§¦å‘åˆ é™¤ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œåˆ é™¤å®Œæˆåæ¸…é™¤çŠ¶æ€ï¼‰
                        try {
                            await this.deleteNewsItem(item, index, true); // ä¼ å…¥ true è·³è¿‡ç¡®è®¤å¼¹æ¡†
                        } catch (error) {
                            console.error('åˆ é™¤æ–°é—»å¤±è´¥:', error);
                            this.showNotification('åˆ é™¤æ–°é—»å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        } finally {
                            // æ¸…é™¤é•¿æŒ‰çŠ¶æ€
                            clearLongPress();
                        }
                    }
                }, longPressThreshold);
            };
            
            // ç»“æŸé•¿æŒ‰æ£€æµ‹
            const endLongPress = () => {
                clearLongPress();
            };
            
            // ç§»åŠ¨æ£€æµ‹ï¼ˆå–æ¶ˆé•¿æŒ‰ï¼‰
            const handleMove = (e) => {
                const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                const currentY = e.touches ? e.touches[0].clientY : e.clientY;
                const deltaX = Math.abs(currentX - startX);
                const deltaY = Math.abs(currentY - startY);
                
                if (deltaX > moveThreshold || deltaY > moveThreshold) {
                    hasMoved = true;
                    clearLongPress();
                }
            };
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            newsItem.addEventListener('touchstart', (e) => {
                if (!e.target.closest('button')) {
                    startLongPress(e);
                }
            }, { passive: true });
            
            newsItem.addEventListener('touchmove', (e) => {
                handleMove(e);
            }, { passive: true });
            
            newsItem.addEventListener('touchend', () => {
                endLongPress();
            }, { passive: true });
            
            newsItem.addEventListener('touchcancel', () => {
                endLongPress();
            }, { passive: true });
            
            // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢è®¾å¤‡ï¼‰
            newsItem.addEventListener('mousedown', (e) => {
                if (!e.target.closest('button')) {
                    startLongPress(e);
                }
            });
            
            newsItem.addEventListener('mousemove', (e) => {
                if (longPressTimer) {
                    handleMove(e);
                }
            });
            
            newsItem.addEventListener('mouseup', () => {
                endLongPress();
            });
            
            newsItem.addEventListener('mouseleave', () => {
                endLongPress();
            });
            
            // ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆé˜²æ­¢é•¿æŒ‰è¿‡ç¨‹ä¸­è§¦å‘å…¶ä»–æ“ä½œï¼‰
            newsItem.addEventListener('click', (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†ï¼Œä¸æ‰§è¡Œåˆ‡æ¢æ“ä½œ
                if (e.target.type === 'checkbox' || e.target.closest('.news-checkbox')) {
                    return;
                }
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–æ ‡ç­¾åŒºåŸŸï¼Œä¸é˜»æ­¢
                if (e.target.closest('button') || e.target.closest('.news-tags')) {
                    return;
                }
                
                // å¦‚æœæ­£åœ¨é•¿æŒ‰æˆ–å·²ç§»åŠ¨ï¼Œé˜»æ­¢ç‚¹å‡»
                if (isLongPressing || hasMoved) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                // æ‰¹é‡æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                if (this.batchMode) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                    return;
                }
                
                // å¤„ç†æ–°é—»ç‚¹å‡»ï¼Œåˆ›å»ºä¼šè¯å¹¶æ‰“å¼€èŠå¤©çª—å£
                this.handleNewsClick(item);
            });
            
            // æ‚¬åœæ•ˆæœ
            newsItem.addEventListener('mouseenter', () => {
                newsItem.style.background = '#f9fafb !important';
                newsItem.style.borderColor = '#d1d5db !important';
                newsItem.style.transform = 'translateY(-1px)';
                newsItem.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1) !important';
            });
            
            newsItem.addEventListener('mouseleave', () => {
                newsItem.style.background = '#ffffff !important';
                newsItem.style.borderColor = '#e5e7eb !important';
                newsItem.style.transform = 'translateY(0)';
                newsItem.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05) !important';
            });
            
            newsList.appendChild(newsItem);
        }
        
        console.log('æ–°é—»åˆ—è¡¨å·²æ›´æ–°ï¼Œæ˜¾ç¤º', sortedNews.length, 'æ¡æ–°é—»');
        
        // æ›´æ–°è§†å›¾åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        this.applyViewMode();
    }
    
    // æ›´æ–°æ¥å£è¯·æ±‚åˆ—è¡¨ä¾§è¾¹æ 
    /**
     * è·å–è¿‡æ»¤åçš„æ¥å£è¯·æ±‚åˆ—è¡¨ï¼ˆç»Ÿä¸€è¿‡æ»¤é€»è¾‘ï¼‰
     * @returns {Array} è¿‡æ»¤åçš„è¯·æ±‚åˆ—è¡¨
     */
    /**
     * è·å–è¯·æ±‚çš„å”¯ä¸€æ ‡è¯†ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
     * @param {Object} req - è¯·æ±‚å¯¹è±¡
     * @returns {string|null} å”¯ä¸€æ ‡è¯†ï¼ˆkey å­—æ®µï¼‰
     */
    _getRequestKey(req) {
        if (!req) return null;
        // åªè¿”å›"å¯æŒä¹…åŒ–"çš„å”¯ä¸€æ ‡è¯†ï¼ˆæ¥è‡ªåç«¯/APIçš„æ•°æ®ï¼‰
        // è§„åˆ™ï¼šä¼˜å…ˆä½¿ç”¨ req.keyï¼Œå…¶æ¬¡ _id / idï¼ˆå¹¶åŒæ­¥å†™å› req.key ä»¥ä¾¿åç»­ä¸€è‡´ä½¿ç”¨ï¼‰
        // ç¡®ä¿è¿”å›çš„ key æ˜¯æœ‰æ•ˆçš„éç©ºå­—ç¬¦ä¸²
        if (req.key && typeof req.key === 'string' && req.key.trim() !== '') {
            return req.key;
        }
        if (req._id && typeof req._id === 'string' && req._id.trim() !== '') {
            req.key = req._id;
            return req.key;
        }
        if (req.id && typeof req.id === 'string' && req.id.trim() !== '') {
            req.key = req.id;
            return req.key;
        }
        // éAPIæ•°æ®ï¼ˆæœ¬åœ°æ‹¦æˆª/ä¸´æ—¶æ•°æ®ï¼‰ä¸ç”Ÿæˆ keyï¼Œé¿å…é‡æ¸²æŸ“å key å˜åŒ–å¯¼è‡´"é€‰ä¸­ä¸¢å¤±/é”™ä½"
        return null;
    }
    
    /**
     * ç¡®ä¿è¯·æ±‚æœ‰ key å­—æ®µï¼ˆå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆä¸€ä¸ªï¼‰
     * @param {Object} req - è¯·æ±‚å¯¹è±¡
     * @returns {string|null} key å€¼
     */
    _ensureRequestKey(req) {
        if (!req) return null;
        // ä»…ä¸ºåç«¯/APIæ•°æ®è¡¥é½ keyï¼›ä¸ä¸ºæœ¬åœ°/ä¸´æ—¶æ•°æ®ç”Ÿæˆ keyï¼ˆé¿å… key ä¸ç¨³å®šï¼‰
        // å¦‚æœå·²æœ‰ keyï¼Œç›´æ¥è¿”å›ï¼ˆç¡®ä¿æ˜¯æœ‰æ•ˆçš„éç©ºå­—ç¬¦ä¸²ï¼‰
        if (req.key && typeof req.key === 'string' && req.key.trim() !== '') {
            return req.key;
        }
        // å¦‚æœæœ‰ _idï¼Œä½¿ç”¨ _id ä½œä¸º keyï¼ˆç¡®ä¿æ˜¯æœ‰æ•ˆçš„éç©ºå­—ç¬¦ä¸²ï¼‰
        if (req._id && typeof req._id === 'string' && req._id.trim() !== '') {
            req.key = req._id;
            return req.key;
        }
        // å¦‚æœæœ‰ idï¼Œä½¿ç”¨ id ä½œä¸º keyï¼ˆç¡®ä¿æ˜¯æœ‰æ•ˆçš„éç©ºå­—ç¬¦ä¸²ï¼‰
        if (req.id && typeof req.id === 'string' && req.id.trim() !== '') {
            req.key = req.id;
            return req.key;
        }
        return null;
    }
    
    _getFilteredApiRequests() {
        if (!this.apiRequestManager) {
            return [];
        }
        
        // è·å–æ‰€æœ‰è¯·æ±‚
        let requests = this.apiRequestManager.getAllRequests();
        
        // å°è¯•ä¸ºAPIæ•°æ®è¡¥é½ keyï¼ˆä¸ä¼šä¸ºæœ¬åœ°/ä¸´æ—¶æ•°æ®ç”Ÿæˆ keyï¼‰
        requests.forEach(req => this._ensureRequestKey(req));
        
        // ç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½æœ‰åŸŸåæ ‡ç­¾ï¼ˆä¸ºæ—§è¯·æ±‚è‡ªåŠ¨æ·»åŠ ï¼‰
        requests.forEach(req => {
            if (req.url) {
                // å¦‚æœè¯·æ±‚è¿˜æ²¡æœ‰tagså­—æ®µï¼Œæˆ–è€…tagsä¸ºç©ºï¼Œåˆ™æ·»åŠ åŸŸåæ ‡ç­¾
                if (!req.tags || !Array.isArray(req.tags) || req.tags.length === 0) {
                    const domain = this.apiRequestManager._extractDomain(req.url);
                    if (domain) {
                        req.tags = [domain];
                    }
                } else {
                    // å¦‚æœå·²æœ‰æ ‡ç­¾ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«åŸŸåæ ‡ç­¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ 
                    const domain = this.apiRequestManager._extractDomain(req.url);
                    if (domain && !req.tags.includes(domain)) {
                        req.tags.push(domain);
                    }
                }
            }
        });
        
        // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤è¯·æ±‚ï¼ˆæœ¬åœ°è¿‡æ»¤ï¼‰
        if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
            const filterKeyword = this.sessionTitleFilter.trim().toLowerCase();
            requests = requests.filter(req => {
                const url = (req.url || '').toLowerCase();
                const method = (req.method || '').toLowerCase();
                const status = String(req.status || '');
                return url.includes(filterKeyword) || 
                       method.includes(filterKeyword) ||
                       status.includes(filterKeyword);
            });
        }
        
        // åº”ç”¨æ—¥æœŸç­›é€‰
        if (this.dateRangeFilter) {
            if (this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // æœ‰å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼šç­›é€‰åŒºé—´å†…çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const endDate = this.dateRangeFilter.endDate;
                const startTime = startDate.getTime();
                const endTime = endDate.getTime() + 24 * 60 * 60 * 1000 - 1; // åŒ…å«ç»“æŸæ—¥æœŸçš„æ•´å¤©
                
                requests = requests.filter(req => {
                    const requestTime = req.timestamp || req.createdAt || req.updatedAt || 0;
                    return requestTime >= startTime && requestTime <= endTime;
                });
            } else if (this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
                // åªæœ‰å¼€å§‹æ—¥æœŸï¼šç­›é€‰å¼€å§‹æ—¥æœŸå½“å¤©çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const startTime = startDate.getTime();
                const endTime = startTime + 24 * 60 * 60 * 1000 - 1; // åŒ…å«å¼€å§‹æ—¥æœŸçš„æ•´å¤©
                
                requests = requests.filter(req => {
                    const requestTime = req.timestamp || req.createdAt || req.updatedAt || 0;
                    return requestTime >= startTime && requestTime <= endTime;
                });
            } else if (!this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // åªæœ‰ç»“æŸæ—¥æœŸï¼šç­›é€‰ç»“æŸæ—¥æœŸä¹‹å‰çš„è®°å½•
                const endDate = this.dateRangeFilter.endDate;
                const endTime = endDate.getTime(); // ä¸åŒ…å«ç»“æŸæ—¥æœŸå½“å¤©
                
                requests = requests.filter(req => {
                    const requestTime = req.timestamp || req.createdAt || req.updatedAt || 0;
                    return requestTime < endTime;
                });
            }
        }
        
        // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰
        if (this.apiRequestTagFilterNoTags) {
            requests = requests.filter(req => {
                const requestTags = req.tags || [];
                const hasTags = requestTags.length > 0 && requestTags.some(tag => tag && tag.trim().length > 0);
                return !hasTags; // åªæ˜¾ç¤ºæ²¡æœ‰æ ‡ç­¾çš„è¯·æ±‚
            });
        }
        
        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤
        if (this.selectedApiRequestFilterTags && this.selectedApiRequestFilterTags.length > 0) {
            requests = requests.filter(req => {
                const requestTags = (req.tags || []).map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const normalizedSelectedTags = this.selectedApiRequestFilterTags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const hasSelectedTags = normalizedSelectedTags.some(selectedTag => 
                    requestTags.includes(selectedTag)
                );
                
                if (this.apiRequestTagFilterReverse) {
                    // åå‘è¿‡æ»¤ï¼šæ’é™¤åŒ…å«é€‰ä¸­æ ‡ç­¾çš„è¯·æ±‚
                    return !hasSelectedTags;
                } else {
                    // æ­£å‘è¿‡æ»¤ï¼šåªæ˜¾ç¤ºåŒ…å«é€‰ä¸­æ ‡ç­¾çš„è¯·æ±‚
                    return hasSelectedTags;
                }
            });
        }
        
        // åªä¿ç•™ä»APIè·å–çš„æ•°æ®ï¼ˆæ‹¥æœ‰å¯æŒä¹…åŒ– key æˆ– source=apiï¼‰ï¼Œè¿‡æ»¤æ‰æœ¬åœ°æ‹¦æˆª/ä¸´æ—¶æ•°æ®
        requests = requests.filter(req => {
            const key = this._getRequestKey(req);
            return !!(key || req.source === 'api');
        });
        
        // åˆ†ç¦»APIæ•°æ®ï¼ˆsource=api æˆ–æœ‰å¯æŒä¹…åŒ– keyï¼‰å’Œæœ¬åœ°æ•°æ®ï¼ˆæ²¡æœ‰ keyï¼‰
        const apiRequests = []; // æ¥è‡ªAPIçš„æ•°æ®
        const localRequests = []; // æœ¬åœ°æ‹¦æˆªçš„æ•°æ®
        
        requests.forEach(req => {
            const key = this._getRequestKey(req);
            const isApi = req && req.source === 'api' || !!key;
            if (isApi) {
                // source=api æˆ–æœ‰keyï¼Œè¯´æ˜æ¥è‡ªAPI
                apiRequests.push(req);
            } else {
                // æ²¡æœ‰keyï¼Œè¯´æ˜æ˜¯æœ¬åœ°æ‹¦æˆªçš„æ•°æ®
                localRequests.push(req);
            }
        });
        
        // å¯¹APIæ•°æ®è¿›è¡Œå»é‡ï¼ˆä½¿ç”¨ key ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
        const apiUniqueMap = new Map();
        apiRequests.forEach(req => {
            // ç¡®ä¿è¯·æ±‚æœ‰ key å­—æ®µ
            const uniqueKey = this._ensureRequestKey(req);
            if (uniqueKey) {
                // ä½¿ç”¨ key ä½œä¸ºå”¯ä¸€æ ‡è¯†
                const existingReq = apiUniqueMap.get(uniqueKey);
                if (!existingReq) {
                    apiUniqueMap.set(uniqueKey, req);
                } else {
                    // å¦‚æœå·²å­˜åœ¨ï¼Œæ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä¿ç•™æœ€æ–°çš„
                    const existingTimestamp = existingReq.timestamp || 0;
                    const currentTimestamp = req.timestamp || 0;
                    if (currentTimestamp > existingTimestamp) {
                        apiUniqueMap.set(uniqueKey, req);
                    }
                }
            } else {
                // å¦‚æœæ— æ³•ç”Ÿæˆ keyï¼Œä½¿ç”¨URL+methodä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼ˆä½†ä¿ç•™è¿™äº›æ•°æ®ï¼‰
                const url = req.url || '';
                const method = req.method || 'GET';
                const urlMethodKey = `api_${method}:${url}`;
                
                if (url) {
                    // åªæœ‰å½“URLå­˜åœ¨æ—¶æ‰è¿›è¡Œå»é‡
                    const existingReq = apiUniqueMap.get(urlMethodKey);
                    if (!existingReq) {
                        apiUniqueMap.set(urlMethodKey, req);
                    } else {
                        // å¦‚æœå·²å­˜åœ¨ï¼Œæ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä¿ç•™æœ€æ–°çš„
                        const existingTimestamp = existingReq.timestamp || 0;
                        const currentTimestamp = req.timestamp || 0;
                        if (currentTimestamp > existingTimestamp) {
                            apiUniqueMap.set(urlMethodKey, req);
                        }
                    }
                } else {
                    // URLä¹Ÿä¸ºç©ºï¼Œä½†è¿™æ˜¯APIæ•°æ®ï¼Œä»ç„¶ä¿ç•™ï¼ˆä½¿ç”¨ç´¢å¼•ä½œä¸ºkeyï¼‰
                    const fallbackKey = `api_no_id_${apiUniqueMap.size}`;
                    apiUniqueMap.set(fallbackKey, req);
                }
            }
        });
        
        // å¯¹æœ¬åœ°æ•°æ®è¿›è¡Œå»é‡ï¼ˆä½¿ç”¨URL+methodä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
        const localUniqueMap = new Map();
        localRequests.forEach(req => {
            const url = req.url || '';
            const method = req.method || 'GET';
            const urlMethodKey = `${method}:${url}`;
            
            if (!url) {
                // å¦‚æœURLä¹Ÿä¸ºç©ºï¼Œè·³è¿‡è¯¥è¯·æ±‚ï¼ˆæ— æ•ˆè¯·æ±‚ï¼‰
                return;
            }
            
            const existingReq = localUniqueMap.get(urlMethodKey);
            if (!existingReq) {
                localUniqueMap.set(urlMethodKey, req);
            } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œæ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä¿ç•™æœ€æ–°çš„
                const existingTimestamp = existingReq.timestamp || 0;
                const currentTimestamp = req.timestamp || 0;
                if (currentTimestamp > existingTimestamp) {
                    localUniqueMap.set(urlMethodKey, req);
                }
            }
        });
        
        // åªè¿”å›APIæ•°æ®ï¼ˆå·²ç¦ç”¨æœ¬åœ°è¯·æ±‚æ‹¦æˆªï¼Œä¸å†è¿”å›æœ¬åœ°æ•°æ®ï¼‰
        const apiData = Array.from(apiUniqueMap.values());
        return apiData;
    }

    async updateApiRequestSidebar(forceRefresh = false) {
        if (!this.sessionSidebar) {
            console.log('ä¾§è¾¹æ æœªåˆ›å»ºï¼Œè·³è¿‡æ›´æ–°');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥
        const wasOssFileListVisible = this.ossFileListVisible;
        const wasNewsListVisible = this.newsListVisible;
        const wasApiRequestListVisible = this.apiRequestListVisible;
        
        // ç¡®ä¿è§†å›¾æ¨¡å¼çŠ¶æ€æ­£ç¡®
        this.apiRequestListVisible = true;
        this.ossFileListVisible = false;
        this.newsListVisible = false;
        
        // å¦‚æœè§†å›¾çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥ï¼‰ï¼Œæ¸…ç©ºèŠå¤©æ¶ˆæ¯
        if (!wasApiRequestListVisible) {
            this.clearChatMessages();
        }
        
        // éšè—ä¼šè¯åˆ—è¡¨ç›¸å…³å…ƒç´ 
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        const tagFilterContainer = this.sessionSidebar.querySelector('.tag-filter-container');
        const batchToolbar = this.sessionSidebar.querySelector('#batch-toolbar');
        const scrollableContent = this.sessionSidebar.querySelector('.session-sidebar-scrollable-content');
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        const ossTagFilterContainer = this.sessionSidebar.querySelector('.oss-tag-filter-container');
        const newsList = this.sessionSidebar.querySelector('.news-list');
        const newsTagFilterContainer = this.sessionSidebar.querySelector('.news-tag-filter-container');
        
        if (sessionList) {
            sessionList.style.display = 'none';
        }
        if (tagFilterContainer) {
            tagFilterContainer.style.display = 'none';
        }
        if (scrollableContent) {
            scrollableContent.style.display = 'none';
        }
        if (ossFileList) {
            ossFileList.style.display = 'none';
        }
        if (ossTagFilterContainer) {
            ossTagFilterContainer.style.display = 'none';
        }
        if (newsList) {
            newsList.style.display = 'none';
        }
        if (newsTagFilterContainer) {
            newsTagFilterContainer.style.display = 'none';
        }
        
        // æ˜¾ç¤ºè¯·æ±‚æ¥å£æ ‡ç­¾è¿‡æ»¤å™¨
        let apiRequestTagFilterContainer = this.sessionSidebar.querySelector('.api-request-tag-filter-container');
        if (apiRequestTagFilterContainer) {
            apiRequestTagFilterContainer.style.display = 'block';
        }
        
        // æ‰¹é‡å·¥å…·æ åœ¨æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤º
        if (batchToolbar && this.batchMode) {
            batchToolbar.style.display = 'flex';
        } else if (batchToolbar) {
            batchToolbar.style.display = 'none';
        }
        
        // è·å–æˆ–åˆ›å»ºæ¥å£è¯·æ±‚åˆ—è¡¨å®¹å™¨
        let apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        if (!apiRequestList) {
            apiRequestList = document.createElement('div');
            apiRequestList.className = 'api-request-list';
            apiRequestList.style.cssText = `
                flex: 1 !important;
                overflow-y: auto !important;
                padding: 8px 8px 220px 8px !important;
                scroll-padding-bottom: 20px !important;
                box-sizing: border-box !important;
            `;
            this.sessionSidebar.appendChild(apiRequestList);
        }
        apiRequestList.style.display = 'block';
        
        // æ›´æ–°æœç´¢æ¡†å ä½ç¬¦
        const searchInput = this.sessionSidebar.querySelector('#session-search-input');
        if (searchInput) {
            searchInput.placeholder = 'æœç´¢æ¥å£è¯·æ±‚...';
        }
        
        // åˆ‡æ¢è¯·æ±‚æ¥å£è§†å›¾æ—¶ï¼Œè°ƒç”¨APIè·å–è¯·æ±‚æ¥å£åˆ—è¡¨
        // åªåœ¨å¼ºåˆ¶åˆ·æ–°æˆ–ä»å…¶ä»–è§†å›¾åˆ‡æ¢è¿‡æ¥æ—¶æ‰è°ƒç”¨APIï¼Œæœç´¢è¾“å…¥æ—¶ä¸è°ƒç”¨
        // æ³¨æ„ï¼šæ¸…ç©ºæœç´¢æ¡†æ—¶ï¼ŒwasApiRequestListVisibleä¸ºtrueï¼Œä¸ä¼šé‡æ–°è°ƒç”¨APIï¼Œè¿™æ˜¯æ­£ç¡®çš„
        const shouldCallApi = forceRefresh || !wasApiRequestListVisible;
        
        // åªä»APIè·å–è¯·æ±‚æ¥å£åˆ—è¡¨ï¼Œä¸å†ä» storage åŒæ­¥æœ¬åœ°è¯·æ±‚
        if (shouldCallApi && this.apiRequestApi && this.apiRequestApi.isEnabled()) {
            try {
                console.log('æ­£åœ¨ä»APIè·å–è¯·æ±‚æ¥å£åˆ—è¡¨...');
                const apiRequests = await this.apiRequestApi.getApiRequests();
                console.log('ä»APIè·å–åˆ°è¯·æ±‚æ¥å£æ•°é‡:', apiRequests.length);
                
                // å°†APIè¿”å›çš„æ•°æ®åˆå¹¶åˆ°è¯·æ±‚åˆ—è¡¨ä¸­ï¼ˆåªä¿ç•™APIæ•°æ®ï¼Œç§»é™¤æœ¬åœ°æ‹¦æˆªçš„æ•°æ®ï¼‰
                if (apiRequests && apiRequests.length > 0 && this.apiRequestManager) {
                    // æ¸…ç©ºç°æœ‰è¯·æ±‚åˆ—è¡¨ï¼Œåªä¿ç•™APIæ•°æ®
                    this.apiRequestManager.requests = [];
                    this.apiRequestManager.localRequests = [];
                    
                    // æ”¶é›†æ‰€æœ‰APIè¿”å›çš„æ•°æ®
                    const allApiRequests = [];
                    
                    // å°†APIæ•°æ®è½¬æ¢ä¸ºè¯·æ±‚æ¥å£æ ¼å¼
                    apiRequests.forEach(apiRequest => {
                        // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®ï¼Œå­—æ®µåä¸æœ¬åœ°æ‹¦æˆªçš„æ•°æ®æ ¼å¼ä¿æŒä¸€è‡´
                        // ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¯èƒ½çš„å­—æ®µåå˜ä½“
                        // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                        const requestUrl = apiRequest.requestUrl || apiRequest.url || apiRequest.endpoint || '';
                        const requestData = {
                            ...apiRequest, // å…ˆä¿ç•™æ‰€æœ‰åŸå§‹å­—æ®µ
                            url: requestUrl,
                            requestUrl: requestUrl, // ç¡®ä¿requestUrlå­—æ®µå­˜åœ¨
                            method: apiRequest.method || 'GET',
                            status: apiRequest.status || 200,
                            statusText: apiRequest.statusText || '',
                            timestamp: apiRequest.timestamp || apiRequest.createdAt || apiRequest.updatedAt || Date.now(),
                            duration: apiRequest.duration || 0,
                            pageUrl: apiRequest.pageUrl || window.location.href,
                            tags: apiRequest.tags || [],
                            // ç»Ÿä¸€å­—æ®µåï¼šä½¿ç”¨ä¸æœ¬åœ°æ‹¦æˆªæ•°æ®ç›¸åŒçš„å­—æ®µå
                            // è¯·æ±‚å¤´ï¼šä¼˜å…ˆä½¿ç”¨ headersï¼Œå…¶æ¬¡ requestHeaders
                            headers: apiRequest.headers || apiRequest.requestHeaders || {},
                            // è¯·æ±‚ä½“ï¼šç»Ÿä¸€ä½¿ç”¨ body å­—æ®µ
                            body: apiRequest.body || apiRequest.requestBody || null,
                            // å“åº”å¤´ï¼šç»Ÿä¸€ä½¿ç”¨ responseHeaders
                            responseHeaders: apiRequest.responseHeaders || {},
                            // å“åº”ä½“ï¼šç»Ÿä¸€ä½¿ç”¨ responseTextï¼ˆç”¨äºæ˜¾ç¤ºï¼‰ï¼ŒresponseBodyï¼ˆç”¨äºè§£æï¼‰
                            responseBody: apiRequest.responseBody || (apiRequest.responseText ? (typeof apiRequest.responseText === 'string' ? null : apiRequest.responseText) : null),
                            responseText: apiRequest.responseText || 
                                         (apiRequest.responseBody ? (typeof apiRequest.responseBody === 'string' ? apiRequest.responseBody : JSON.stringify(apiRequest.responseBody, null, 2)) : '') ||
                                         apiRequest.response || '',
                            curl: apiRequest.curl || '',
                            type: apiRequest.type || 'api',
                            source: 'api', // æ ‡è®°ä¸ºAPIæ•°æ®
                            _id: apiRequest._id || apiRequest.id,
                            // ä¼˜å…ˆä½¿ç”¨ keyï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ _id ä½œä¸º key
                            key: apiRequest.key || apiRequest._id || apiRequest.id
                        };
                        
                        // ç¡®ä¿ responseText æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                        if (requestData.responseText && typeof requestData.responseText !== 'string') {
                            try {
                                requestData.responseText = JSON.stringify(requestData.responseText, null, 2);
                            } catch (e) {
                                requestData.responseText = String(requestData.responseText);
                            }
                        }
                        
                        // ç¡®ä¿ responseBody æ˜¯å¯¹è±¡æ ¼å¼ï¼ˆå¦‚æœå­˜åœ¨ä¸”æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æï¼‰
                        if (requestData.responseBody && typeof requestData.responseBody === 'string') {
                            try {
                                requestData.responseBody = JSON.parse(requestData.responseBody);
                            } catch (e) {
                                // å¦‚æœè§£æå¤±è´¥ï¼Œä¿æŒå­—ç¬¦ä¸²æ ¼å¼
                            }
                        }
                        
                        // ç¡®ä¿ body æ ¼å¼æ­£ç¡®ï¼ˆå¦‚æœæ˜¯å¯¹è±¡ï¼Œä¿ç•™å¯¹è±¡æ ¼å¼ï¼‰
                        if (requestData.body && typeof requestData.body === 'string') {
                            try {
                                // å°è¯•è§£æä¸ºå¯¹è±¡ï¼Œå¦‚æœå¤±è´¥åˆ™ä¿æŒå­—ç¬¦ä¸²
                                const parsed = JSON.parse(requestData.body);
                                if (typeof parsed === 'object') {
                                    requestData.body = parsed;
                                }
                            } catch (e) {
                                // ä¿æŒå­—ç¬¦ä¸²æ ¼å¼
                            }
                        }
                        
                        // è°ƒè¯•æ—¥å¿—ï¼šè®°å½•APIæ•°æ®è½¬æ¢
                        if (!requestData.url) {
                            console.log('APIæ•°æ®URLä¸ºç©ºï¼Œä½†ä¿ç•™è¯¥è¯·æ±‚ï¼ˆæœ‰ keyï¼‰:', {
                                _id: requestData._id,
                                key: requestData.key,
                                method: requestData.method
                            });
                        }
                        
                        // ç›´æ¥æ·»åŠ åˆ°APIæ•°æ®æ•°ç»„ï¼ˆå·²æ¸…ç©ºåˆ—è¡¨ï¼Œæ— éœ€å»é‡ï¼‰
                        allApiRequests.push(requestData);
                    });
                    
                    // å°†æ‰€æœ‰APIæ•°æ®æ·»åŠ åˆ°åˆ—è¡¨ï¼ˆå·²æ¸…ç©ºï¼Œç›´æ¥æ·»åŠ ï¼‰
                    if (allApiRequests.length > 0) {
                        this.apiRequestManager.requests = allApiRequests;
                        console.log('APIæ•°æ®å·²åŠ è½½åˆ°è¯·æ±‚åˆ—è¡¨ï¼ŒAPIè¯·æ±‚æ•°:', allApiRequests.length);
                        console.log('APIæ•°æ®ç¤ºä¾‹ï¼ˆå‰3ä¸ªï¼‰:', allApiRequests.slice(0, 3).map(req => ({
                            url: req.url,
                            method: req.method,
                            _id: req._id,
                            key: req.key,
                            hasUrl: !!req.url
                        })));
                        
                        // é‡å»ºç´¢å¼•ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                        if (this.apiRequestManager._rebuildIndex) {
                            this.apiRequestManager._rebuildIndex();
                        }
                    } else {
                        console.warn('APIæ•°æ®è½¬æ¢åä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼');
                    }
                    
                    console.log('APIæ•°æ®å·²åŠ è½½åˆ°è¯·æ±‚åˆ—è¡¨ï¼Œæ€»è¯·æ±‚æ•°:', this.apiRequestManager.requests.length);
                }
            } catch (error) {
                console.warn('ä»APIè·å–è¯·æ±‚æ¥å£åˆ—è¡¨å¤±è´¥:', error.message);
                // APIè°ƒç”¨å¤±è´¥æ—¶ï¼Œæ¸…ç©ºè¯·æ±‚åˆ—è¡¨ï¼ˆä¸å†ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰
                if (this.apiRequestManager) {
                    this.apiRequestManager.requests = [];
                    this.apiRequestManager.localRequests = [];
                }
            }
        }
        
        // åˆ›å»ºæˆ–æ›´æ–°è¯·æ±‚æ¥å£æ ‡ç­¾è¿‡æ»¤å™¨ï¼ˆåœ¨æ•°æ®åŒæ­¥ä¹‹åï¼‰
        this.createApiRequestTagFilter();
        
        // æ˜¾ç¤ºè¯·æ±‚æ¥å£æ ‡ç­¾è¿‡æ»¤å™¨ï¼ˆé‡æ–°æŸ¥è¯¢ï¼Œå› ä¸º createApiRequestTagFilter å¯èƒ½é‡æ–°åˆ›å»ºäº†å®¹å™¨ï¼‰
        apiRequestTagFilterContainer = this.sessionSidebar.querySelector('.api-request-tag-filter-container');
        if (apiRequestTagFilterContainer) {
            apiRequestTagFilterContainer.style.display = 'block';
        }
        
        // ç¡®ä¿æ ‡ç­¾ç»Ÿè®¡æ­£ç¡®æ˜¾ç¤ºï¼ˆåœ¨æ•°æ®åŒæ­¥åå†æ¬¡æ›´æ–°UIï¼‰
        this.updateApiRequestTagFilterUI();
        
        // ä½¿ç”¨ç»Ÿä¸€çš„è¿‡æ»¤æ–¹æ³•è·å–è¯·æ±‚åˆ—è¡¨
        let requests = this._getFilteredApiRequests();

        // åˆ·æ–°/åˆ é™¤/é‡æ–°æ‹‰å–åï¼Œæ¸…ç†ä¸å­˜åœ¨çš„é€‰ä¸­é¡¹ï¼Œé¿å…â€œé€‰ä¸­æ•°é‡ä¸å¯¹ / é€‰ä¸­å¤±æ•ˆâ€
        if (this.selectedApiRequestIds && this.selectedApiRequestIds.size > 0) {
            const allKeys = new Set(
                (this.apiRequestManager?.requests || [])
                    .map(r => this._getRequestKey(r))
                    .filter(Boolean)
            );
            let changed = false;
            for (const key of Array.from(this.selectedApiRequestIds)) {
                if (!allKeys.has(key)) {
                    this.selectedApiRequestIds.delete(key);
                    changed = true;
                }
            }
            if (changed && this.batchMode) {
                this.updateBatchToolbar();
            }
        }
        
        // è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        if (this.apiRequestManager) {
            console.log('æ¥å£è¯·æ±‚è®°å½•æ•°é‡:', requests.length);
            console.log('å½“å‰é¡µé¢URL:', window.location.href);
            console.log('æ€»è¯·æ±‚æ•°:', this.apiRequestManager.requests.length);
            console.log('æœ¬åœ°è¯·æ±‚æ•°:', this.apiRequestManager.localRequests.length);
            
            if (requests.length === 0) {
                console.warn('æ²¡æœ‰æ¥å£è¯·æ±‚è®°å½•');
                console.log('enableRecording:', this.apiRequestManager.enableRecording);
                console.log('filterExtensionRequests:', this.apiRequestManager.filterExtensionRequests);
            } else {
                console.log('æˆåŠŸè·å–æ¥å£è¯·æ±‚è®°å½•ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚:', {
                    url: requests[0]?.url,
                    method: requests[0]?.method,
                    status: requests[0]?.status,
                    pageUrl: requests[0]?.pageUrl,
                    tags: requests[0]?.tags
                });
            }
        } else {
            console.warn('æ¥å£è¯·æ±‚ç®¡ç†å™¨æœªåˆå§‹åŒ–');
        }
        
        // æ¸…ç©ºåˆ—è¡¨
        const children = Array.from(apiRequestList.children);
        children.forEach(child => {
            child.remove();
        });
        
        if (requests.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.style.cssText = `
                padding: 20px !important;
                text-align: center !important;
                color: #9ca3af !important;
                font-size: 12px !important;
            `;
            emptyMsg.textContent = this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '' ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æ¥å£è¯·æ±‚' : 'æš‚æ— æ¥å£è¯·æ±‚è®°å½•';
            apiRequestList.appendChild(emptyMsg);
            return;
        }
        
        // æ’åºï¼šAPIè¿”å›çš„æ•°æ®ï¼ˆæœ‰ keyï¼‰ä¼˜å…ˆæ˜¾ç¤ºåœ¨æœ€å‰é¢ï¼Œç„¶åæŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        const sortedRequests = requests.sort((a, b) => {
            // æ£€æŸ¥æ˜¯å¦æ˜¯APIè¿”å›çš„æ•°æ®ï¼ˆæœ‰ key å­—æ®µï¼‰
            const aIsApiData = !!this._getRequestKey(a);
            const bIsApiData = !!this._getRequestKey(b);
            
            // å¦‚æœä¸€ä¸ªæ˜¯APIæ•°æ®ï¼Œå¦ä¸€ä¸ªä¸æ˜¯ï¼ŒAPIæ•°æ®æ’åœ¨å‰é¢
            if (aIsApiData && !bIsApiData) {
                return -1;
            }
            if (!aIsApiData && bIsApiData) {
                return 1;
            }
            
            // å¦‚æœéƒ½æ˜¯APIæ•°æ®æˆ–éƒ½ä¸æ˜¯APIæ•°æ®ï¼ŒæŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            return (b.timestamp || 0) - (a.timestamp || 0);
        });
        
        // åˆ›å»ºæ¥å£è¯·æ±‚åˆ—è¡¨é¡¹
        // ç”¨äºè·Ÿè¸ªå·²ä½¿ç”¨çš„ requestKeyï¼Œç¡®ä¿æ¯ä¸ªå¤é€‰æ¡†éƒ½æœ‰å”¯ä¸€çš„ key
        const usedRequestKeys = new Set();
        
        for (let index = 0; index < sortedRequests.length; index++) {
            const req = sortedRequests[index];
            // ç¡®ä¿è¯·æ±‚æœ‰ key å­—æ®µ
            this._ensureRequestKey(req);
            
            const requestItem = document.createElement('div');
            requestItem.className = 'api-request-item';
            requestItem.setAttribute('data-request-index', index);
            
            // è·å–è¯·æ±‚æ¥å£çš„å”¯ä¸€æ ‡è¯†ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
            let requestKey = this._getRequestKey(req);
            
            // å¦‚æœ requestKey å·²å­˜åœ¨ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ keyï¼ˆæ·»åŠ ç´¢å¼•åç¼€ï¼‰
            if (requestKey && usedRequestKeys.has(requestKey)) {
                console.warn('å‘ç°é‡å¤çš„ requestKeyï¼Œç”Ÿæˆå”¯ä¸€ key:', requestKey, 'ç´¢å¼•:', index);
                requestKey = `${requestKey}_${index}_${Date.now()}`;
                req.key = requestKey; // æ›´æ–° req.key ä»¥ä¾¿åç»­ä½¿ç”¨
            }
            
            if (requestKey) {
                usedRequestKeys.add(requestKey);
            }
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»ï¼šæ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦æ˜¯è¯¥æ¥å£è¯·æ±‚çš„ä¼šè¯
            let isActive = false;
            if (this.currentSessionId) {
                const currentSession = this.sessions[this.currentSessionId];
                if (currentSession && currentSession._isApiRequestSession && currentSession._apiRequestInfo) {
                    // å½“å‰ä¼šè¯æ˜¯æ¥å£è¯·æ±‚ä¼šè¯ï¼Œæ£€æŸ¥æ¥å£è¯·æ±‚URLå’Œæ–¹æ³•æ˜¯å¦åŒ¹é…
                    // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                    const sessionRequestUrl = currentSession._apiRequestInfo.requestUrl || currentSession._apiRequestInfo.url || '';
                    const sessionPageUrl = currentSession._apiRequestInfo.pageUrl || '';
                    const reqUrl = req.requestUrl || req.url || '';
                    const reqPageUrl = req.pageUrl || '';

                    // æ–°å»ºæ¥å£ï¼ˆblank-requestï¼‰ä¼˜å…ˆæŒ‰ pageUrl åŒ¹é…ï¼Œé¿å…åŒ URL/æ–¹æ³•æ—¶é«˜äº®é”™ä½
                    const isBlankApiRequest = (typeof reqPageUrl === 'string' && reqPageUrl.startsWith('blank-request:')) ||
                                              (typeof sessionPageUrl === 'string' && sessionPageUrl.startsWith('blank-request:'));
                    const isMatch = isBlankApiRequest
                        ? (sessionPageUrl === reqPageUrl && currentSession._apiRequestInfo.method === req.method)
                        : (sessionRequestUrl === reqUrl && currentSession._apiRequestInfo.method === req.method);

                    if (isMatch) {
                        isActive = true;
                        requestItem.classList.add('active');
                    }
                }
            }
            
            // æ‰¹é‡æ¨¡å¼ä¸‹æ·»åŠ é€‰ä¸­çŠ¶æ€ç±»ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
            if (this.batchMode && requestKey && this.selectedApiRequestIds.has(requestKey)) {
                requestItem.classList.add('selected');
            }
            
            // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
            const isSuccess = req.status >= 200 && req.status < 300;
            const isError = req.status >= 400 || req.status === 0;
            const statusColor = isSuccess ? '#4CAF50' : isError ? '#f44336' : '#FF9800';
            
            // æ‰¹é‡æ¨¡å¼ä¸‹é€‰ä¸­çŠ¶æ€çš„èƒŒæ™¯è‰²ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
            const isSelected = this.batchMode && requestKey && this.selectedApiRequestIds.has(requestKey);
            const backgroundColor = isSelected ? '#eff6ff' : (isActive ? '#eff6ff' : '#ffffff');
            const borderColor = isSelected ? '#3b82f6' : (isActive ? '#3b82f6' : '#e5e7eb');
            
            requestItem.style.cssText = `
                padding: 16px 18px !important;
                margin-bottom: 12px !important;
                background: ${backgroundColor} !important;
                border: 1px solid ${borderColor} !important;
                border-left: 4px solid ${isActive ? '#3b82f6' : statusColor} !important;
                border-radius: 12px !important;
                cursor: pointer !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                box-shadow: ${isActive ? '0 2px 4px rgba(59, 130, 246, 0.2)' : '0 2px 4px rgba(0, 0, 0, 0.06)'} !important;
                position: relative !important;
            `;
            
            // åˆ›å»ºå¤é€‰æ¡†ï¼ˆä»…åœ¨æ‰¹é‡æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼Œä¸”ä»…å¯¹APIæ•°æ®æœ‰æ•ˆï¼‰
            let checkbox = null;
            const isApiData = !!requestKey;
            if (this.batchMode && isApiData && requestKey) {
                checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'api-request-checkbox';
                // ç¡®ä¿ requestKey æ˜¯æœ‰æ•ˆçš„éç©ºå­—ç¬¦ä¸²
                const validRequestKey = (typeof requestKey === 'string' && requestKey.trim() !== '') ? requestKey : null;
                if (!validRequestKey) {
                    console.warn('è¯·æ±‚æ¥å£ç¼ºå°‘æœ‰æ•ˆçš„ keyï¼Œè·³è¿‡åˆ›å»ºå¤é€‰æ¡†:', req);
                    checkbox = null;
                } else {
                    checkbox.dataset.requestKey = validRequestKey; // ä½¿ç”¨ data-request-key å­˜å‚¨ key å­—æ®µ
                    checkbox.checked = this.selectedApiRequestIds.has(validRequestKey);
                    checkbox.style.cssText = `
                        width: 16px !important;
                        height: 16px !important;
                        cursor: pointer !important;
                        margin-right: 12px !important;
                        flex-shrink: 0 !important;
                        display: block !important;
                    `;
                    
                    // ä½¿ç”¨é—­åŒ…ä¿å­˜å½“å‰é¡¹çš„ requestKey å’Œ requestItemï¼Œé¿å…äº‹ä»¶å¤„ç†ä¸­çš„å˜é‡å¼•ç”¨é—®é¢˜
                    const currentRequestKey = validRequestKey;
                    const currentRequestItem = requestItem;
                    const currentIsActive = isActive;
                    
                    checkbox.addEventListener('change', (e) => {
                        e.stopPropagation();
                        const reqKey = currentRequestKey; // ä½¿ç”¨é—­åŒ…ä¸­çš„ keyï¼Œè€Œä¸æ˜¯ä» dataset è¯»å–
                        
                        // åŒé‡éªŒè¯ï¼šç¡®ä¿ reqKey æœ‰æ•ˆ
                        if (!reqKey || typeof reqKey !== 'string' || reqKey.trim() === '') {
                            console.warn('å¤é€‰æ¡†ç¼ºå°‘æœ‰æ•ˆçš„ requestKey:', reqKey);
                            // æ¢å¤å¤é€‰æ¡†çŠ¶æ€
                            e.target.checked = !e.target.checked;
                            return;
                        }
                        
                        // åªæ›´æ–°å½“å‰å¤é€‰æ¡†å’Œå¯¹åº”çš„åˆ—è¡¨é¡¹ï¼Œä¸å½±å“å…¶ä»–å¤é€‰æ¡†
                        const wasChecked = e.target.checked;
                        if (wasChecked) {
                            this.selectedApiRequestIds.add(reqKey);
                            currentRequestItem.classList.add('selected');
                            currentRequestItem.style.background = '#eff6ff';
                            currentRequestItem.style.borderColor = '#3b82f6';
                        } else {
                            this.selectedApiRequestIds.delete(reqKey);
                            currentRequestItem.classList.remove('selected');
                            currentRequestItem.style.background = currentIsActive ? '#eff6ff' : '#ffffff';
                            currentRequestItem.style.borderColor = currentIsActive ? '#3b82f6' : '#e5e7eb';
                        }
                        
                        // æ›´æ–°å·¥å…·æ ï¼Œä½†ä¸æ›´æ–°å…¶ä»–å¤é€‰æ¡†çŠ¶æ€
                        this.updateBatchToolbar();
                    });
                    
                    // é˜»æ­¢å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶å†’æ³¡
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }
            }
            
            // è¯·æ±‚ä¿¡æ¯å®¹å™¨
            const requestInfo = document.createElement('div');
            requestInfo.className = 'api-request-info';
            requestInfo.style.cssText = `
                margin-bottom: 0 !important;
            `;
            
            // åˆ›å»ºå†…éƒ¨å®¹å™¨ï¼ˆåŒ…å«å¤é€‰æ¡†å’Œå†…å®¹ï¼‰
            const itemInner = document.createElement('div');
            itemInner.style.cssText = `
                display: flex !important;
                align-items: flex-start !important;
                width: 100% !important;
                gap: 12px !important;
            `;
            
            // æ·»åŠ å¤é€‰æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (checkbox) {
                itemInner.appendChild(checkbox);
            }
            
            // åˆ›å»ºå†…å®¹åŒ…è£…å™¨
            const contentWrapper = document.createElement('div');
            contentWrapper.style.cssText = `
                flex: 1 !important;
                min-width: 0 !important;
            `;
            
            // åˆ›å»ºæ ‡é¢˜è¡Œå®¹å™¨ï¼ˆæ–¹æ³•å’ŒURLåœ¨åŒä¸€è¡Œï¼‰
            const titleRow = document.createElement('div');
            titleRow.style.cssText = `
                display: flex !important;
                align-items: flex-start !important;
                justify-content: space-between !important;
                gap: 12px !important;
                width: 100% !important;
                margin-bottom: 12px !important;
            `;
            
            // å·¦ä¾§å®¹å™¨ï¼ˆæ–¹æ³•æ ‡ç­¾å’ŒURLï¼‰
            const leftContainer = document.createElement('div');
            leftContainer.style.cssText = `
                display: flex !important;
                align-items: flex-start !important;
                gap: 12px !important;
                flex: 1 !important;
                min-width: 0 !important;
            `;
            
            // æŠ˜å /å±•å¼€æŒ‰é’®
            const expandBtn = document.createElement('button');
            expandBtn.className = 'api-request-expand-btn';
            expandBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            `;
            expandBtn.title = 'å±•å¼€è¯¦æƒ…';
            expandBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 4px !important;
                opacity: 0.6 !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: inherit !important;
                border-radius: 4px !important;
                margin-top: 2px !important;
            `;
            expandBtn.addEventListener('mouseenter', () => {
                expandBtn.style.opacity = '1';
                expandBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
            });
            expandBtn.addEventListener('mouseleave', () => {
                expandBtn.style.opacity = '0.6';
                expandBtn.style.background = 'none !important';
            });
            
            // æ–¹æ³•æ ‡ç­¾
            const methodTag = document.createElement('span');
            methodTag.textContent = req.method || 'GET';
            methodTag.style.cssText = `
                font-size: 11px !important;
                font-weight: 700 !important;
                color: ${statusColor} !important;
                background: ${statusColor}15 !important;
                padding: 5px 10px !important;
                border-radius: 8px !important;
                flex-shrink: 0 !important;
                letter-spacing: 0.5px !important;
                border: 1px solid ${statusColor}30 !important;
                line-height: 1.4 !important;
                margin-top: 2px !important;
            `;
            
            leftContainer.appendChild(methodTag);
            
            // URLå®¹å™¨
            const urlContainer = document.createElement('div');
            urlContainer.style.cssText = `
                flex: 1 !important;
                min-width: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 4px !important;
            `;
            
            // æ ‡é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
            if (req.title && req.title.trim()) {
                const title = document.createElement('div');
                title.style.cssText = `
                    font-size: 14px !important;
                    font-weight: 600 !important;
                    color: #111827 !important;
                    line-height: 1.5 !important;
                    display: -webkit-box !important;
                    -webkit-line-clamp: 1 !important;
                    -webkit-box-orient: vertical !important;
                    overflow: hidden !important;
                    word-break: break-word !important;
                    text-overflow: ellipsis !important;
                `;
                title.textContent = req.title.trim();
                urlContainer.appendChild(title);
            }
            
            // URL
            const url = document.createElement('div');
            url.style.cssText = `
                font-size: 13px !important;
                font-weight: 500 !important;
                color: #1f2937 !important;
                line-height: 1.6 !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
                overflow: hidden !important;
                word-break: break-all !important;
                text-overflow: ellipsis !important;
            `;
            url.textContent = req.url || 'æœªçŸ¥URL';
            
            urlContainer.appendChild(url);
            
            // æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
            if (req.description && req.description.trim()) {
                const description = document.createElement('div');
                description.style.cssText = `
                    font-size: 12px !important;
                    font-weight: 400 !important;
                    color: #6b7280 !important;
                    line-height: 1.5 !important;
                    display: -webkit-box !important;
                    -webkit-line-clamp: 2 !important;
                    -webkit-box-orient: vertical !important;
                    overflow: hidden !important;
                    word-break: break-word !important;
                    text-overflow: ellipsis !important;
                    margin-top: 2px !important;
                `;
                description.textContent = req.description.trim();
                urlContainer.appendChild(description);
            }
            leftContainer.appendChild(urlContainer);
            titleRow.appendChild(leftContainer);
            titleRow.appendChild(expandBtn);
            contentWrapper.appendChild(titleRow);
            
            // å“åº”çŠ¶æ€å’Œå“åº”æ—¶é—´è¡Œï¼ˆåŒä¸€è¡Œï¼Œå·¦å³å¯¹é½ï¼‰
            const statusRow = document.createElement('div');
            statusRow.style.cssText = `
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                font-size: 11px !important;
                color: #6b7280 !important;
                margin-top: 0 !important;
                padding-top: 12px !important;
                border-top: 1px solid #f3f4f6 !important;
            `;
            
            // å·¦ä¾§çŠ¶æ€ä¿¡æ¯å®¹å™¨ï¼ˆå“åº”çŠ¶æ€å’Œå“åº”æ—¶é—´ï¼‰
            const statusInfoContainer = document.createElement('div');
            statusInfoContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                flex: 1 !important;
            `;
            
            // çŠ¶æ€ä¿¡æ¯ï¼ˆå¸¦å›¾æ ‡æ ·å¼ï¼‰
            const statusInfo = document.createElement('span');
            statusInfo.textContent = `${req.status || 0} ${req.statusText || ''}`;
            statusInfo.style.cssText = `
                color: ${statusColor} !important;
                font-weight: 600 !important;
                font-size: 11px !important;
                display: inline-flex !important;
                align-items: center !important;
                gap: 4px !important;
            `;
            
            // æ·»åŠ çŠ¶æ€æŒ‡ç¤ºç‚¹
            const statusDot = document.createElement('span');
            statusDot.style.cssText = `
                width: 6px !important;
                height: 6px !important;
                border-radius: 50% !important;
                background: ${statusColor} !important;
                display: inline-block !important;
            `;
            statusInfo.insertBefore(statusDot, statusInfo.firstChild);
            
            statusInfoContainer.appendChild(statusInfo);
            
            // æŒç»­æ—¶é—´ï¼ˆå’ŒçŠ¶æ€åœ¨åŒä¸€è¡Œï¼Œå³å¯¹é½ï¼‰
            if (req.duration !== undefined && req.duration !== null) {
                const duration = document.createElement('span');
                duration.textContent = `${req.duration}ms`;
                duration.style.cssText = `
                    color: #6b7280 !important;
                    font-size: 11px !important;
                    font-weight: 500 !important;
                    background: #f3f4f6 !important;
                    padding: 2px 8px !important;
                    border-radius: 4px !important;
                    margin-left: auto !important;
                `;
                statusInfoContainer.appendChild(duration);
            }
            
            // åº•éƒ¨ä¿¡æ¯è¡Œï¼ˆæ—¶é—´å’Œæ“ä½œæŒ‰é’®ï¼‰
            const footerRow = document.createElement('div');
            footerRow.style.cssText = `
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                font-size: 11px !important;
                color: #9ca3af !important;
                margin-top: 8px !important;
            `;
            
            // æ—¶é—´ï¼ˆupdatedTimeï¼‰
            const time = document.createElement('span');
            const timeValue = req.updatedAt || req.updated_at || req.timestamp || 0;
            if (timeValue) {
                const date = new Date(timeValue);
                const now = new Date();
                const diff = now - date;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor(diff / (1000 * 60));
                const seconds = Math.floor(diff / 1000);
                
                if (days > 0) {
                    time.textContent = `${days}å¤©å‰`;
                } else if (hours > 0) {
                    time.textContent = `${hours}å°æ—¶å‰`;
                } else if (minutes > 0) {
                    time.textContent = `${minutes}åˆ†é’Ÿå‰`;
                } else if (seconds > 0) {
                    time.textContent = `${seconds}ç§’å‰`;
                } else {
                    time.textContent = 'åˆšåˆš';
                }
            } else {
                time.textContent = '';
            }
            footerRow.appendChild(time);
            
            // æ“ä½œæŒ‰é’®å®¹å™¨ï¼ˆå’Œæ—¶é—´åŒä¸€è¡Œï¼‰
            const footerButtonContainer = document.createElement('div');
            footerButtonContainer.className = 'api-request-actions';
            footerButtonContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 4px !important;
                opacity: 0.6 !important;
                transition: opacity 0.2s ease !important;
            `;
            
            // ç¼–è¾‘è¯·æ±‚æŒ‰é’®ï¼ˆåªåœ¨å·²ä¿å­˜çš„è¯·æ±‚ä¸Šæ˜¾ç¤ºï¼Œå‚è€ƒä¼šè¯åˆ—è¡¨çš„å®ç°ï¼‰
            if (isApiData) {
                const editBtn = document.createElement('button');
                editBtn.className = 'api-request-edit-btn';
                editBtn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                `;
                editBtn.title = 'ç¼–è¾‘è¯·æ±‚';
                editBtn.style.cssText = `
                    background: none !important;
                    border: none !important;
                    cursor: pointer !important;
                    padding: 4px !important;
                    opacity: 0.6 !important;
                    transition: all 0.2s ease !important;
                    line-height: 1 !important;
                    flex-shrink: 0 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    color: inherit !important;
                    border-radius: 4px !important;
                `;
                editBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await this.editApiRequest(req);
                });
                editBtn.addEventListener('mouseenter', () => {
                    editBtn.style.opacity = '1';
                    editBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
                });
                editBtn.addEventListener('mouseleave', () => {
                    editBtn.style.opacity = '0.6';
                    editBtn.style.background = 'none !important';
                });
                footerButtonContainer.appendChild(editBtn);
            }
            
            // æ ‡ç­¾ç®¡ç†æŒ‰é’®ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„å®ç°ï¼‰
            const tagBtn = document.createElement('button');
            tagBtn.className = 'api-request-tag-btn';
            tagBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
            `;
            tagBtn.title = 'ç®¡ç†æ ‡ç­¾';
            tagBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 4px !important;
                opacity: 0.6 !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: inherit !important;
                border-radius: 4px !important;
            `;
            tagBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                await this.openApiRequestTagManager(req);
            });
            tagBtn.addEventListener('mouseenter', () => {
                tagBtn.style.opacity = '1';
                tagBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
            });
            tagBtn.addEventListener('mouseleave', () => {
                tagBtn.style.opacity = '0.6';
                tagBtn.style.background = 'none !important';
            });
            footerButtonContainer.appendChild(tagBtn);
            
            // å‘é€è¯·æ±‚æŒ‰é’®
            const sendBtn = document.createElement('button');
            sendBtn.className = 'api-request-send-btn';
            sendBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            `;
            sendBtn.title = 'å‘é€è¯·æ±‚';
            sendBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 4px !important;
                opacity: 0.6 !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: inherit !important;
                border-radius: 4px !important;
            `;
            sendBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                await this.sendApiRequestFromItem(req);
            });
            sendBtn.addEventListener('mouseenter', () => {
                sendBtn.style.opacity = '1';
                sendBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
            });
            sendBtn.addEventListener('mouseleave', () => {
                sendBtn.style.opacity = '0.6';
                sendBtn.style.background = 'none !important';
            });
            footerButtonContainer.appendChild(sendBtn);
            
            // é¡µé¢ä¸Šä¸‹æ–‡æŒ‰é’®ï¼ˆå‚è€ƒä¼šè¯åˆ—è¡¨çš„å®ç°ï¼Œæ”¾åœ¨æœ€åï¼‰
            const contextBtn = document.createElement('button');
            contextBtn.className = 'api-request-context-btn';
            contextBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            `;
            contextBtn.title = 'é¡µé¢ä¸Šä¸‹æ–‡';
            contextBtn.style.cssText = `
                background: none !important;
                border: none !important;
                cursor: pointer !important;
                padding: 4px !important;
                opacity: 0.6 !important;
                transition: all 0.2s ease !important;
                line-height: 1 !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: inherit !important;
                border-radius: 4px !important;
            `;
            
            // æŒ‰é’®æ‚¬åœæ—¶å¢åŠ ä¸é€æ˜åº¦å’ŒèƒŒæ™¯è‰²
            contextBtn.addEventListener('mouseenter', () => {
                contextBtn.style.opacity = '1';
                contextBtn.style.background = 'rgba(255, 255, 255, 0.1) !important';
            });
            contextBtn.addEventListener('mouseleave', () => {
                contextBtn.style.opacity = '0.6';
                contextBtn.style.background = 'none !important';
            });
            
            // é˜»æ­¢é¡µé¢ä¸Šä¸‹æ–‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° requestItem
            contextBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                // å…ˆæ¿€æ´»æˆ–åˆ›å»ºè¯¥æ¥å£è¯·æ±‚çš„ä¼šè¯
                await this.handleApiRequestClick(req);
                // ç¡®ä¿èŠå¤©çª—å£å·²æ‰“å¼€
                if (!this.chatWindow || !this.isChatOpen) {
                    await this.openChatWindow();
                }
                // æ‰“å¼€é¡µé¢ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨
                this.openContextEditor();
            });
            footerButtonContainer.appendChild(contextBtn);
            
            // å°†æ“ä½œæŒ‰é’®æ·»åŠ åˆ°footerRow
            footerRow.appendChild(footerButtonContainer);
            
            // å°†statusInfoContaineræ·»åŠ åˆ°statusRow
            statusRow.appendChild(statusInfoContainer);
            
            // å°†statusRowå’ŒfooterRowæ·»åŠ åˆ°contentWrapper
            contentWrapper.appendChild(statusRow);
            contentWrapper.appendChild(footerRow);
            
            // æ ‡ç­¾åŒºåŸŸ
            if (req.tags && Array.isArray(req.tags) && req.tags.length > 0) {
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'api-request-tags';
                tagsContainer.style.cssText = `
                    display: flex !important;
                    flex-wrap: wrap !important;
                    gap: 8px !important;
                    margin-top: 12px !important;
                    padding-top: 12px !important;
                    border-top: 1px solid #f3f4f6 !important;
                `;
                
                req.tags.forEach(tag => {
                    if (tag && tag.trim()) {
                        const tagElement = document.createElement('span');
                        tagElement.className = 'api-request-tag';
                        tagElement.textContent = tag;
                        // æ ¹æ®æ ‡ç­¾å†…å®¹ç”Ÿæˆé¢œè‰²ï¼ˆä½¿ç”¨å“ˆå¸Œå‡½æ•°ç¡®ä¿ç›¸åŒæ ‡ç­¾é¢œè‰²ä¸€è‡´ï¼‰
                        const tagColor = this.getTagColor(tag);
                        tagElement.style.cssText = `
                            display: inline-block !important;
                            padding: 4px 10px !important;
                            background: ${tagColor.background} !important;
                            color: ${tagColor.text} !important;
                            border-radius: 14px !important;
                            font-size: 10px !important;
                            font-weight: 500 !important;
                            border: 1px solid ${tagColor.border} !important;
                            transition: all 0.2s ease !important;
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
                        `;
                        // æ·»åŠ æ‚¬åœæ•ˆæœ
                        tagElement.addEventListener('mouseenter', () => {
                            tagElement.style.transform = 'translateY(-2px)';
                            tagElement.style.boxShadow = '0 3px 6px rgba(0, 0, 0, 0.12)';
                        });
                        tagElement.addEventListener('mouseleave', () => {
                            tagElement.style.transform = 'translateY(0)';
                            tagElement.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                        });
                        tagsContainer.appendChild(tagElement);
                    }
                });
                
                contentWrapper.appendChild(tagsContainer);
            }
            
            // å°†contentWrapperæ·»åŠ åˆ°itemInner
            itemInner.appendChild(contentWrapper);
            
            // å°†itemInneræ·»åŠ åˆ°requestInfo
            requestInfo.appendChild(itemInner);
            
            requestItem.appendChild(requestInfo);
            
            // ç‚¹å‡»å±•å¼€è¯¦æƒ…
            let isExpanded = false;
            const detailPanel = document.createElement('div');
            detailPanel.className = 'api-request-detail';
            detailPanel.style.cssText = `
                display: none !important;
                margin-top: 12px !important;
                padding-top: 12px !important;
                border-top: 1px solid #e5e7eb !important;
                font-size: 11px !important;
            `;
            
            // æŠ˜å /å±•å¼€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            expandBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                isExpanded = !isExpanded;
                if (isExpanded) {
                    detailPanel.style.display = 'block';
                    expandBtn.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    `;
                    expandBtn.title = 'æ”¶èµ·è¯¦æƒ…';
                    requestItem.style.background = '#f9fafb';
                    requestItem.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.12)';
                } else {
                    detailPanel.style.display = 'none';
                    expandBtn.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    `;
                    expandBtn.title = 'å±•å¼€è¯¦æƒ…';
                    requestItem.style.background = backgroundColor;
                    requestItem.style.boxShadow = isActive ? '0 2px 4px rgba(59, 130, 246, 0.2)' : '0 2px 4px rgba(0, 0, 0, 0.06)';
                }
            });
            
            // åˆ›å»ºè¯¦æƒ…å†…å®¹
            const createDetailSection = (title, content, isCode = false, showCopyButton = false) => {
                const section = document.createElement('div');
                section.style.cssText = `
                    margin-bottom: 14px !important;
                `;
                
                const titleContainer = document.createElement('div');
                titleContainer.style.cssText = `
                    display: flex !important;
                    align-items: center !important;
                    justify-content: space-between !important;
                    margin-bottom: 6px !important;
                `;
                
                const sectionTitle = document.createElement('div');
                sectionTitle.textContent = title;
                sectionTitle.style.cssText = `
                    font-weight: 600 !important;
                    color: #1f2937 !important;
                    font-size: 12px !important;
                `;
                
                titleContainer.appendChild(sectionTitle);
                
                // å¦‚æœéœ€è¦æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
                if (showCopyButton) {
                    const copyButton = document.createElement('button');
                    copyButton.textContent = 'å¤åˆ¶';
                    copyButton.style.cssText = `
                        background: #3b82f6 !important;
                        color: white !important;
                        border: none !important;
                        padding: 5px 14px !important;
                        border-radius: 6px !important;
                        font-size: 11px !important;
                        cursor: pointer !important;
                        font-weight: 500 !important;
                        transition: all 0.2s ease !important;
                    `;
                    
                    // æ‚¬åœæ•ˆæœ
                    copyButton.addEventListener('mouseenter', () => {
                        copyButton.style.background = '#2563eb !important';
                        copyButton.style.transform = 'translateY(-1px)';
                        copyButton.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.3)';
                    });
                    copyButton.addEventListener('mouseleave', () => {
                        copyButton.style.background = '#3b82f6 !important';
                        copyButton.style.transform = 'translateY(0)';
                        copyButton.style.boxShadow = 'none';
                    });
                    
                    // ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
                    copyButton.addEventListener('click', async (e) => {
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¯·æ±‚é¡¹çš„å±•å¼€/æ”¶èµ·
                        
                        const textToCopy = typeof content === 'object' 
                            ? JSON.stringify(content, null, 2) 
                            : (content || '');
                        
                        try {
                            await navigator.clipboard.writeText(textToCopy);
                            // å¤åˆ¶æˆåŠŸï¼Œæ›´æ–°æŒ‰é’®æ–‡æœ¬
                            const originalText = copyButton.textContent;
                            copyButton.textContent = 'å·²å¤åˆ¶';
                            copyButton.style.background = '#10b981 !important';
                            
                            // 1ç§’åæ¢å¤
                            setTimeout(() => {
                                copyButton.textContent = originalText;
                                copyButton.style.background = '#3b82f6 !important';
                            }, 1000);
                        } catch (err) {
                            // å¦‚æœ clipboard API ä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                            const textArea = document.createElement('textarea');
                            textArea.value = textToCopy;
                            textArea.style.position = 'fixed';
                            textArea.style.opacity = '0';
                            document.body.appendChild(textArea);
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                const originalText = copyButton.textContent;
                                copyButton.textContent = 'å·²å¤åˆ¶';
                                copyButton.style.background = '#10b981 !important';
                                setTimeout(() => {
                                    copyButton.textContent = originalText;
                                    copyButton.style.background = '#3b82f6 !important';
                                }, 1000);
                            } catch (err) {
                                copyButton.textContent = 'å¤åˆ¶å¤±è´¥';
                                copyButton.style.background = '#ef4444 !important';
                                setTimeout(() => {
                                    copyButton.textContent = 'å¤åˆ¶';
                                    copyButton.style.background = '#3b82f6 !important';
                                }, 1000);
                            }
                            document.body.removeChild(textArea);
                        }
                    });
                    
                    titleContainer.appendChild(copyButton);
                }
                
                const sectionContent = document.createElement('div');
                if (isCode) {
                    sectionContent.style.cssText = `
                        background: #f9fafb !important;
                        padding: 10px 12px !important;
                        border-radius: 6px !important;
                        font-family: 'Monaco', 'Menlo', 'Consolas', monospace !important;
                        font-size: 11px !important;
                        color: #111827 !important;
                        overflow-x: auto !important;
                        white-space: pre-wrap !important;
                        word-break: break-all !important;
                        border: 1px solid #e5e7eb !important;
                        line-height: 1.6 !important;
                    `;
                } else {
                    sectionContent.style.cssText = `
                        color: #6b7280 !important;
                        line-height: 1.6 !important;
                        font-size: 11px !important;
                    `;
                }
                
                if (typeof content === 'object') {
                    sectionContent.textContent = JSON.stringify(content, null, 2);
                } else {
                    sectionContent.textContent = content || '';
                }
                
                section.appendChild(titleContainer);
                section.appendChild(sectionContent);
                return section;
            };
            
            // æ·»åŠ è¯¦æƒ…å†…å®¹
            // ç»Ÿä¸€å¤„ç†å­—æ®µåï¼Œç¡®ä¿APIæ•°æ®å’Œæœ¬åœ°æ•°æ®éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º
            const requestUrl = req.url || '';
            const requestMethod = req.method || 'GET';
            const headers = req.headers || req.requestHeaders || {};
            const body = req.body || req.requestBody || null;
            const responseHeaders = req.responseHeaders || {};
            const responseText = req.responseText || 
                               (req.responseBody ? (typeof req.responseBody === 'string' ? req.responseBody : JSON.stringify(req.responseBody, null, 2)) : '') ||
                               req.response || '';
            
            // ç”Ÿæˆcurlå‘½ä»¤ï¼ˆå¦‚æœæ²¡æœ‰åˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰
            let curl = req.curl || '';
            if (!curl && requestUrl) {
                curl = this.generateCurlCommand(req);
            }
            
            // æŒ‰é¡ºåºæ˜¾ç¤ºï¼šRequest URLã€Request Methodã€Request Headersã€Curl
            if (requestUrl) {
                detailPanel.appendChild(createDetailSection('Request URL', requestUrl, true, true));
            }
            if (requestMethod) {
                detailPanel.appendChild(createDetailSection('Request Method', requestMethod, false));
            }
            if (headers && Object.keys(headers).length > 0) {
                detailPanel.appendChild(createDetailSection('Request Headers', headers, true, true));
            }
            if (body) {
                // å¦‚æœbodyæ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²æ˜¾ç¤º
                const bodyContent = typeof body === 'object' ? JSON.stringify(body, null, 2) : body;
                detailPanel.appendChild(createDetailSection('Request Body', bodyContent, true, true));
            }
            if (curl) {
                detailPanel.appendChild(createDetailSection('Curl', curl, true, true));
            }
            if (responseHeaders && Object.keys(responseHeaders).length > 0) {
                detailPanel.appendChild(createDetailSection('Response Headers', responseHeaders, true, true));
            }
            if (responseText) {
                detailPanel.appendChild(createDetailSection('Response Body', responseText, true, true));
            }
            
            requestItem.appendChild(detailPanel);
            
            // é•¿æŒ‰åˆ é™¤ç›¸å…³å˜é‡ï¼ˆæå‡åˆ°å¤–éƒ¨ä½œç”¨åŸŸï¼Œä»¥ä¾¿ç‚¹å‡»äº‹ä»¶ä¹Ÿèƒ½è®¿é—®ï¼‰
            let longPressTimer = null;
            let longPressProgressTimer = null;
            let longPressThreshold = 800; // é•¿æŒ‰æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
            let isLongPressing = false;
            let hasMoved = false;
            let startX = 0;
            let startY = 0;
            let longPressStartTime = 0;
            const moveThreshold = 10; // ç§»åŠ¨é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼åˆ™å–æ¶ˆé•¿æŒ‰
            
            // ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆå‚è€ƒæ–°é—»åˆ—è¡¨çš„å®ç°ï¼‰
            requestItem.addEventListener('click', (e) => {
                // å¦‚æœæ­£åœ¨é•¿æŒ‰ï¼Œä¸æ‰§è¡Œç‚¹å‡»
                if (isApiData && (isLongPressing || hasMoved)) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ã€å¤é€‰æ¡†æˆ–è¯¦æƒ…é¢æ¿å†…çš„å†…å®¹ï¼Œä¸è§¦å‘åˆ›å»ºä¼šè¯
                if (e.target.closest('button') || e.target.closest('.api-request-tags') || e.target.closest('.api-request-checkbox') || e.target.type === 'checkbox' || detailPanel.contains(e.target)) {
                    return;
                }

                // æ‰¹é‡æ¨¡å¼ï¼šç‚¹å‡»åˆ—è¡¨é¡¹ç”¨äºåˆ‡æ¢é€‰ä¸­çŠ¶æ€ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰ï¼Œä¸åˆ›å»ºä¼šè¯
                if (this.batchMode) {
                    // ä»…å¯¹æœ‰ key çš„ API æ•°æ®å…è®¸æ‰¹é‡é€‰ä¸­
                    if (!isApiData || !requestKey) {
                        return;
                    }

                    const willSelect = !this.selectedApiRequestIds.has(requestKey);
                    if (willSelect) {
                        this.selectedApiRequestIds.add(requestKey);
                        requestItem.classList.add('selected');
                        requestItem.style.background = '#eff6ff';
                        requestItem.style.borderColor = '#3b82f6';
                    } else {
                        this.selectedApiRequestIds.delete(requestKey);
                        requestItem.classList.remove('selected');
                        requestItem.style.background = isActive ? '#eff6ff' : '#ffffff';
                        requestItem.style.borderColor = isActive ? '#3b82f6' : '#e5e7eb';
                    }

                    // åŒæ­¥å¤é€‰æ¡†çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (checkbox) {
                        checkbox.checked = willSelect;
                    }

                    this.updateBatchToolbar();
                    return;
                }
                
                // å¤„ç†æ¥å£ç‚¹å‡»ï¼Œåˆ›å»ºä¼šè¯å¹¶æ‰“å¼€èŠå¤©çª—å£ï¼ˆå‚è€ƒæ–°é—»åˆ—è¡¨ï¼‰
                this.handleApiRequestClick(req);
            });
            
            // æ‚¬åœæ•ˆæœï¼ˆä¸ä¼šè¯åˆ—è¡¨ä¿æŒä¸€è‡´ï¼‰
            let isHoveringItem = false;
            let isHoveringButtons = false;
            
            requestItem.addEventListener('mouseenter', () => {
                isHoveringItem = true;
                if (!isExpanded) {
                    requestItem.style.background = '#f9fafb !important';
                    requestItem.style.borderColor = '#d1d5db !important';
                    requestItem.style.transform = 'translateY(-1px)';
                    requestItem.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1) !important';
                }
                // æ˜¾ç¤ºæ“ä½œæŒ‰é’®å’Œå±•å¼€æŒ‰é’®
                footerButtonContainer.style.opacity = '1';
                expandBtn.style.opacity = '1';
            });
            requestItem.addEventListener('mouseleave', () => {
                isHoveringItem = false;
                if (!isExpanded) {
                    requestItem.style.background = backgroundColor + ' !important';
                    requestItem.style.borderColor = borderColor + ' !important';
                    requestItem.style.transform = 'translateY(0)';
                    requestItem.style.boxShadow = (isActive ? '0 2px 4px rgba(59, 130, 246, 0.2)' : '0 2px 4px rgba(0, 0, 0, 0.06)') + ' !important';
                }
                // å¦‚æœé¼ æ ‡ä¸åœ¨æŒ‰é’®å®¹å™¨ä¸Šï¼Œéšè—æ“ä½œæŒ‰é’®ï¼ˆä¸ä¼šè¯åˆ—è¡¨ä¸€è‡´ï¼Œopacityä¸º0.6ï¼‰
                if (!isHoveringButtons) {
                    footerButtonContainer.style.opacity = '0.6';
                    expandBtn.style.opacity = '0.6';
                }
            });
            
            // ç¡®ä¿æŒ‰é’®å®¹å™¨åœ¨æ‚¬åœæ—¶ä¿æŒå¯è§
            footerButtonContainer.addEventListener('mouseenter', () => {
                isHoveringButtons = true;
                footerButtonContainer.style.opacity = '1';
            });
            
            footerButtonContainer.addEventListener('mouseleave', () => {
                isHoveringButtons = false;
                // å¦‚æœé¼ æ ‡ç¦»å¼€æŒ‰é’®å®¹å™¨ä¸”ä¸åœ¨requestItemä¸Šï¼Œéšè—æŒ‰é’®
                if (!isHoveringItem) {
                    footerButtonContainer.style.opacity = '0.6';
                }
            });
            
            // é•¿æŒ‰åˆ é™¤åŠŸèƒ½ï¼ˆä»…å¯¹APIæ•°æ®æœ‰æ•ˆï¼‰
            if (isApiData) {
                
                // åˆ›å»ºé•¿æŒ‰è¿›åº¦æŒ‡ç¤ºå™¨
                const progressBar = document.createElement('div');
                progressBar.className = 'long-press-progress';
                progressBar.style.cssText = `
                    position: absolute !important;
                    bottom: 0 !important;
                    left: 0 !important;
                    height: 3px !important;
                    background: rgba(244, 67, 54, 0.8) !important;
                    width: 0% !important;
                    border-radius: 0 0 8px 8px !important;
                    transition: width 0.05s linear !important;
                    z-index: 10 !important;
                `;
                requestItem.appendChild(progressBar);
                
                // åˆ›å»ºé•¿æŒ‰æç¤ºæ–‡æœ¬
                const hintText = document.createElement('div');
                hintText.className = 'long-press-hint';
                hintText.textContent = 'ç»§ç»­æŒ‰ä½ä»¥åˆ é™¤';
                hintText.style.cssText = `
                    position: absolute !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) scale(0) !important;
                    background: rgba(244, 67, 54, 0.95) !important;
                    color: white !important;
                    padding: 6px 12px !important;
                    border-radius: 6px !important;
                    font-size: 12px !important;
                    white-space: nowrap !important;
                    pointer-events: none !important;
                    z-index: 20 !important;
                    opacity: 0 !important;
                    transition: all 0.2s ease !important;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
                `;
                requestItem.appendChild(hintText);
                
                // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
                const clearLongPress = () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    if (longPressProgressTimer) {
                        clearInterval(longPressProgressTimer);
                        longPressProgressTimer = null;
                    }
                    if (isLongPressing) {
                        requestItem.classList.remove('long-pressing', 'long-press-start', 
                            'long-press-stage-1', 'long-press-stage-2', 'long-press-stage-3');
                        isLongPressing = false;
                    } else {
                        // å³ä½¿æ²¡æœ‰å®Œæˆé•¿æŒ‰ï¼Œä¹Ÿè¦æ¸…é™¤å¼€å§‹çŠ¶æ€å’Œé˜¶æ®µçŠ¶æ€
                        requestItem.classList.remove('long-press-start', 
                            'long-press-stage-1', 'long-press-stage-2', 'long-press-stage-3');
                    }
                    hasMoved = false;
                    progressBar.style.width = '0%';
                    hintText.style.opacity = '0';
                    hintText.style.transform = 'translate(-50%, -50%) scale(0)';
                    longPressStartTime = 0;
                };
                
                // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                const triggerHapticFeedback = () => {
                    if ('vibrate' in navigator) {
                        navigator.vibrate(50); // çŸ­éœ‡åŠ¨
                    }
                };
                
                // å¼€å§‹é•¿æŒ‰æ£€æµ‹
                const startLongPress = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–é“¾æ¥ï¼Œä¸è§¦å‘é•¿æŒ‰
                    if (e.target.closest('button') || e.target.closest('a')) {
                        return;
                    }
                    
                    hasMoved = false;
                    startX = e.touches ? e.touches[0].clientX : e.clientX;
                    startY = e.touches ? e.touches[0].clientY : e.clientY;
                    longPressStartTime = Date.now();
                    
                    // æ·»åŠ å¼€å§‹é•¿æŒ‰çš„è§†è§‰åé¦ˆ
                    requestItem.classList.add('long-press-start');
                    
                    // æ˜¾ç¤ºæç¤ºæ–‡æœ¬ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…ç«‹å³æ˜¾ç¤ºï¼‰
                    setTimeout(() => {
                        if (longPressStartTime && !hasMoved) {
                            hintText.style.opacity = '1';
                            hintText.style.transform = 'translate(-50%, -50%) scale(1)';
                        }
                    }, 200);
                    
                    // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
                    let lastStage = 0;
                    const progressInterval = 50; // æ¯50msæ›´æ–°ä¸€æ¬¡
                    longPressProgressTimer = setInterval(() => {
                        if (hasMoved || !longPressStartTime) {
                            clearInterval(longPressProgressTimer);
                            return;
                        }
                        
                        const elapsed = Date.now() - longPressStartTime;
                        const progress = Math.min((elapsed / longPressThreshold) * 100, 100);
                        progressBar.style.width = progress + '%';
                        
                        // åœ¨ä¸åŒé˜¶æ®µæ·»åŠ åé¦ˆï¼ˆç¡®ä¿æ¯ä¸ªé˜¶æ®µåªè§¦å‘ä¸€æ¬¡ï¼‰
                        if (progress >= 30 && progress < 35 && lastStage < 1) {
                            requestItem.classList.add('long-press-stage-1');
                            lastStage = 1;
                        } else if (progress >= 60 && progress < 65 && lastStage < 2) {
                            requestItem.classList.remove('long-press-stage-1');
                            requestItem.classList.add('long-press-stage-2');
                            lastStage = 2;
                            triggerHapticFeedback(); // ä¸­æœŸéœ‡åŠ¨
                        } else if (progress >= 90 && progress < 95 && lastStage < 3) {
                            requestItem.classList.remove('long-press-stage-2');
                            requestItem.classList.add('long-press-stage-3');
                            lastStage = 3;
                            triggerHapticFeedback(); // æ¥è¿‘å®Œæˆæ—¶çš„éœ‡åŠ¨
                        }
                        
                        if (progress >= 100) {
                            clearInterval(longPressProgressTimer);
                        }
                    }, progressInterval);
                    
                    longPressTimer = setTimeout(async () => {
                        if (!hasMoved) {
                            isLongPressing = true;
                            requestItem.classList.add('long-pressing');
                            triggerHapticFeedback(); // è§¦å‘åˆ é™¤å‰çš„éœ‡åŠ¨
                            
                            // è·å–è¯·æ±‚ä¿¡æ¯ç”¨äºæç¤º
                            const requestUrl = req.url || 'æœªçŸ¥URL';
                            const requestMethod = req.method || 'GET';
                            
                            // ç¡®è®¤åˆ é™¤
                            const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤è¯·æ±‚æ¥å£"${requestMethod} ${requestUrl}"å—ï¼Ÿ`);
                            if (!confirmDelete) {
                                // ç”¨æˆ·å–æ¶ˆåˆ é™¤ï¼Œæ¸…é™¤é•¿æŒ‰çŠ¶æ€
                                clearLongPress();
                                return;
                            }
                            
                            // è§¦å‘åˆ é™¤ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œåˆ é™¤å®Œæˆåæ¸…é™¤çŠ¶æ€ï¼‰
                            try {
                                await this.handleApiRequestDelete(req);
                            } catch (error) {
                                console.error('åˆ é™¤è¯·æ±‚æ¥å£å¤±è´¥:', error);
                            } finally {
                                // æ¸…é™¤é•¿æŒ‰çŠ¶æ€
                                clearLongPress();
                            }
                        }
                    }, longPressThreshold);
                };
                
                // ç»“æŸé•¿æŒ‰æ£€æµ‹
                const endLongPress = () => {
                    clearLongPress();
                };
                
                // ç§»åŠ¨æ£€æµ‹ï¼ˆå–æ¶ˆé•¿æŒ‰ï¼‰
                const handleMove = (e) => {
                    const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                    const currentY = e.touches ? e.touches[0].clientY : e.clientY;
                    const deltaX = Math.abs(currentX - startX);
                    const deltaY = Math.abs(currentY - startY);
                    
                    if (deltaX > moveThreshold || deltaY > moveThreshold) {
                        hasMoved = true;
                        clearLongPress();
                    }
                };
                
                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
                requestItem.addEventListener('touchstart', (e) => {
                    startLongPress(e);
                }, { passive: true });
                
                requestItem.addEventListener('touchmove', (e) => {
                    handleMove(e);
                }, { passive: true });
                
                requestItem.addEventListener('touchend', () => {
                    endLongPress();
                }, { passive: true });
                
                requestItem.addEventListener('touchcancel', () => {
                    endLongPress();
                }, { passive: true });
                
                // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢è®¾å¤‡ï¼‰
                requestItem.addEventListener('mousedown', (e) => {
                    startLongPress(e);
                });
                
                requestItem.addEventListener('mousemove', (e) => {
                    if (longPressTimer) {
                        handleMove(e);
                    }
                });
                
                requestItem.addEventListener('mouseup', () => {
                    endLongPress();
                });
                
                requestItem.addEventListener('mouseleave', () => {
                    endLongPress();
                });
            }
            
            
            apiRequestList.appendChild(requestItem);
        }
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DDï¼ˆç”¨äºæ–°é—»APIï¼‰
    formatDateForNews(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // è·å–æ–°é—»æ—¶é—´æˆ³
    getNewsTime(item) {
        if (!item) {
            return 0;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨åœ°è§£ææ—¥æœŸ
        const parseDate = (dateValue, fieldName) => {
            if (!dateValue) return null;
            
            // å¦‚æœå·²ç»æ˜¯æ—¶é—´æˆ³ï¼ˆæ•°å­—ï¼‰
            if (typeof dateValue === 'number') {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ—¶é—´æˆ³ï¼ˆæ¯«ç§’æˆ–ç§’ï¼‰
                if (dateValue > 0) {
                    // å¦‚æœæ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆå°äº 1970-01-01 çš„æ¯«ç§’æ•°ï¼‰ï¼Œè½¬æ¢ä¸ºæ¯«ç§’
                    if (dateValue < 10000000000) {
                        return dateValue * 1000;
                    }
                    return dateValue;
                }
                return null;
            }
            
            // å¦‚æœæ˜¯ Date å¯¹è±¡
            if (dateValue instanceof Date) {
                const timestamp = dateValue.getTime();
                return isNaN(timestamp) ? null : timestamp;
            }
            
            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
            if (typeof dateValue === 'string') {
                // å»é™¤å‰åç©ºæ ¼
                const trimmedValue = dateValue.trim();
                if (!trimmedValue) return null;
                
                // é¦–å…ˆå°è¯•æ ‡å‡† Date è§£æ
                let date = new Date(trimmedValue);
                let timestamp = date.getTime();
                
                // å¦‚æœæ ‡å‡†è§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                if (isNaN(timestamp) || timestamp <= 0) {
                    // å°è¯•å¤šç§æ—¥æœŸæ ¼å¼
                    const formats = [
                        trimmedValue, // åŸå§‹å€¼
                        trimmedValue.replace(/(\d{4})-(\d{2})-(\d{2})/, '$1/$2/$3'), // YYYY-MM-DD -> YYYY/MM/DD
                        trimmedValue.replace(/(\d{4})(\d{2})(\d{2})/, '$1/$2/$3'), // YYYYMMDD -> YYYY/MM/DD
                        trimmedValue.replace(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})/, '$1/$2/$3 $4:$5:$6'), // YYYY-MM-DD HH:mm:ss
                        trimmedValue.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/, '$1/$2/$3 $4:$5:$6'), // YYYYMMDDHHmmss
                    ];
                    
                    for (const format of formats) {
                        if (format === trimmedValue) continue; // è·³è¿‡å·²å°è¯•çš„åŸå§‹å€¼
                        date = new Date(format);
                        timestamp = date.getTime();
                        if (!isNaN(timestamp) && timestamp > 0) {
                            break;
                        }
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦è§£ææˆåŠŸï¼ˆæ— æ•ˆæ—¥æœŸä¼šè¿”å› NaNï¼‰
                if (!isNaN(timestamp) && timestamp > 0) {
                    return timestamp;
                } else {
                    // è°ƒè¯•ï¼šè¾“å‡ºæ— æ³•è§£æçš„æ—¥æœŸ
                    console.warn(`æ— æ³•è§£ææ—¥æœŸå­—æ®µ ${fieldName}:`, dateValue, 'ç±»å‹:', typeof dateValue);
                }
            }
            
            return null;
        };
        
        // æŒ‰ä¼˜å…ˆçº§å°è¯•å„ä¸ªå­—æ®µï¼Œä¼˜å…ˆä½¿ç”¨ published
        const timeFields = ['published', 'pubDate', 'publishedAt', 'date', 'created_at', 'createdAt', 'publishDate', 'pub_date', 'publish_date'];
        
        for (const field of timeFields) {
            if (item[field] !== undefined && item[field] !== null) {
                const timestamp = parseDate(item[field], field);
                if (timestamp !== null && timestamp > 0) {
                    // åªåœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºï¼ˆå¯ä»¥é€šè¿‡æ§åˆ¶å°æŸ¥çœ‹ï¼‰
                    if (window.DEBUG_NEWS_TIME) {
                        console.log(`æˆåŠŸè§£ææ—¶é—´å­—æ®µ ${field}:`, item[field], '->', timestamp, '->', new Date(timestamp).toLocaleString('zh-CN'));
                    }
                    return timestamp;
                }
            }
        }
        
        // è°ƒè¯•ï¼šå¦‚æœæ‰€æœ‰å­—æ®µéƒ½æ‰¾ä¸åˆ°ï¼Œè¾“å‡ºæ–°é—»é¡¹çš„æ‰€æœ‰é”®ä»¥ä¾¿è°ƒè¯•ï¼ˆåªè¾“å‡ºä¸€æ¬¡ï¼‰
        if (!this._timeFieldWarningShown) {
            console.warn('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ—¶é—´å­—æ®µï¼Œæ–°é—»é¡¹å¯ç”¨å­—æ®µ:', Object.keys(item), 'ç¤ºä¾‹æ•°æ®:', item);
            this._timeFieldWarningShown = true;
        }
        
        return 0;
    }
    
    // å¤„ç†æ–°é—»ç‚¹å‡»ï¼Œåˆ›å»ºä¼šè¯å¹¶æ‰“å¼€èŠå¤©çª—å£ï¼ˆç±»ä¼¼OSSæ–‡ä»¶ï¼‰
    async handleNewsClick(newsItem) {
        try {
            if (!newsItem) {
                console.warn('æ–°é—»é¡¹æ— æ•ˆ');
                return;
            }
            
            // ç”Ÿæˆä¼šè¯IDï¼ˆåŸºäºæ–°é—»é“¾æ¥æˆ–æ ‡é¢˜ï¼‰
            const newsId = newsItem.link || newsItem.title || `news_${Date.now()}`;
            const sessionId = await this.generateSessionId(newsId);
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–°é—»çš„ä¼šè¯
            let matchedSessionId = null;
            for (const [sid, session] of Object.entries(this.sessions)) {
                if (session._isNewsSession && session._newsInfo && 
                    session._newsInfo.link === newsItem.link) {
                    matchedSessionId = sid;
                    break;
                }
            }
            
            // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ä¼šè¯ï¼Œç›´æ¥æ¿€æ´»
            if (matchedSessionId) {
                // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ–°é—»åˆ—è¡¨
                const newsList = this.sessionSidebar?.querySelector('.news-list');
                const isNewsListVisible = newsList && newsList.style.display !== 'none';
                
                // æ¿€æ´»ä¼šè¯
                await this.activateSession(matchedSessionId, {
                    saveCurrent: false,
                    updateConsistency: false,
                    updateUI: true,
                    syncToBackend: false,
                    skipBackendFetch: false,
                    keepNewsListView: isNewsListVisible
                });
                
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ–°é—»åˆ—è¡¨ï¼Œæ›´æ–°æ–°é—»åˆ—è¡¨çš„activeçŠ¶æ€
                if (isNewsListVisible) {
                    await this.updateNewsSidebar(false);
                }
                
                console.log('æ–°é—»ä¼šè¯å·²æ¿€æ´»ï¼ˆä½¿ç”¨åŒ¹é…çš„ä¼šè¯ï¼‰:', matchedSessionId);
                return;
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯ï¼Œåˆ›å»ºæ–°ä¼šè¯
            let session = this.sessions[sessionId];
            
            if (!session) {
                // åˆ›å»ºæ–°ä¼šè¯
                session = this.createSessionObject(sessionId, {
                    url: newsItem.link || '',
                    title: newsItem.title || 'æ–°é—»',
                    pageTitle: newsItem.title || 'æ–°é—»',
                    pageDescription: newsItem.description || newsItem.content || '',
                    pageContent: newsItem.content || newsItem.description || ''
                });
                this.sessions[sessionId] = session;
                
                // æ ‡è®°ä¸ºæ–°é—»ä¼šè¯
                session._isNewsSession = true;
                session._newsInfo = {
                    title: newsItem.title || '',
                    link: newsItem.link || '',
                    description: newsItem.description || '',
                    content: newsItem.content || '',
                    pubDate: newsItem.pubDate || newsItem.publishedAt || null,
                    tags: newsItem.tags || []
                };
                
                // ä¿å­˜ä¼šè¯åˆ°æœ¬åœ°
                await this.saveAllSessions(false, false);
            } else {
                // æ›´æ–°ç°æœ‰ä¼šè¯çš„æ–°é—»ä¿¡æ¯
                session._isNewsSession = true;
                session._newsInfo = {
                    title: newsItem.title || '',
                    link: newsItem.link || '',
                    description: newsItem.description || '',
                    content: newsItem.content || '',
                    pubDate: newsItem.pubDate || newsItem.publishedAt || null,
                    tags: newsItem.tags || []
                };
                session.pageTitle = newsItem.title || 'æ–°é—»';
                session.pageDescription = newsItem.description || newsItem.content || '';
                session.pageContent = newsItem.content || newsItem.description || '';
            }
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºæ–°é—»åˆ—è¡¨
            const newsList = this.sessionSidebar?.querySelector('.news-list');
            const isNewsListVisible = newsList && newsList.style.display !== 'none';
            
            // æ¿€æ´»ä¼šè¯
            await this.activateSession(sessionId, {
                saveCurrent: false,
                updateConsistency: false,
                updateUI: true,
                syncToBackend: false,
                skipBackendFetch: true,
                keepNewsListView: isNewsListVisible
            });
            
            // ç¡®ä¿ä¼šè¯ä¿¡æ¯å·²æ›´æ–°ï¼ˆåœ¨æ¿€æ´»ä¼šè¯åï¼‰
            const activatedSession = this.sessions[sessionId];
            if (activatedSession) {
                activatedSession._isNewsSession = true;
                activatedSession._newsInfo = {
                    title: newsItem.title || '',
                    link: newsItem.link || '',
                    description: newsItem.description || '',
                    content: newsItem.content || '',
                    pubDate: newsItem.pubDate || newsItem.publishedAt || null,
                    tags: newsItem.tags || []
                };
                activatedSession.pageTitle = newsItem.title || 'æ–°é—»';
                activatedSession.pageDescription = newsItem.description || newsItem.content || '';
                activatedSession.pageContent = newsItem.content || newsItem.description || '';
            }
            
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ–°é—»åˆ—è¡¨ï¼Œæ›´æ–°æ–°é—»åˆ—è¡¨çš„activeçŠ¶æ€
            if (isNewsListVisible) {
                await this.updateNewsSidebar(false);
            }
            
            console.log('æ–°é—»ä¼šè¯å·²åˆ›å»ºå¹¶æ¿€æ´»:', sessionId);
        } catch (error) {
            console.error('å¤„ç†æ–°é—»ç‚¹å‡»å¤±è´¥:', error);
            this.showNotification('æ‰“å¼€æ–°é—»ä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }
    
    // å¤„ç†è¯·æ±‚æ¥å£ç‚¹å‡»ï¼Œåˆ›å»ºä¼šè¯å¹¶æ‰“å¼€èŠå¤©çª—å£ï¼ˆç±»ä¼¼æ–°é—»åˆ—è¡¨ï¼‰
    async handleApiRequestClick(apiRequest) {
        try {
            if (!apiRequest) {
                console.warn('è¯·æ±‚æ¥å£é¡¹æ— æ•ˆ');
                return;
            }
            
            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
            const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
            // å¯¹äºâ€œæ–°å»ºè¯·æ±‚æ¥å£â€ï¼ˆpageUrl ä¸º blank-request:xxxï¼‰ï¼Œç”¨ pageUrl ä½œä¸ºä¼šè¯å”¯ä¸€æ ‡è¯†ï¼Œé¿å…ä¸åŒURLçš„å…¶ä»–æ¥å£ä¼šè¯å†²çª
            const pageUrl = apiRequest.pageUrl || '';
            const isBlankApiRequest = typeof pageUrl === 'string' && pageUrl.startsWith('blank-request:');
            const sessionIdentity = isBlankApiRequest ? pageUrl : requestUrl;
            // ç”Ÿæˆä¼šè¯IDï¼ˆåŸºäºè¯·æ±‚URLå’Œæ–¹æ³•ï¼‰
            const requestId = `${apiRequest.method || 'GET'}:${sessionIdentity}`;
            const sessionId = await this.generateSessionId(requestId);
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè¯·æ±‚æ¥å£çš„ä¼šè¯
            let matchedSessionId = null;
            for (const [sid, session] of Object.entries(this.sessions)) {
                if (session._isApiRequestSession && session._apiRequestInfo) {
                    // æ–°å»ºæ¥å£ï¼ˆblank-requestï¼‰æŒ‰ pageUrl åŒ¹é…ï¼›å…¶ä»–æŒ‰ requestUrl åŒ¹é…
                    const sessionPageUrl = session._apiRequestInfo.pageUrl || '';
                    const sessionRequestUrl = session._apiRequestInfo.requestUrl || session._apiRequestInfo.url || '';
                    const isMatch = isBlankApiRequest
                        ? (sessionPageUrl === pageUrl && session._apiRequestInfo.method === apiRequest.method)
                        : (sessionRequestUrl === requestUrl && session._apiRequestInfo.method === apiRequest.method);
                    if (isMatch) {
                        matchedSessionId = sid;
                        break;
                    }
                }
            }
            
            // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ä¼šè¯ï¼Œç›´æ¥æ¿€æ´»
            if (matchedSessionId) {
                // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè¯·æ±‚æ¥å£åˆ—è¡¨
                const isApiRequestListVisible = this.apiRequestListVisible;
                
                // æ¿€æ´»ä¼šè¯
                await this.activateSession(matchedSessionId, {
                    saveCurrent: false,
                    updateConsistency: false,
                    updateUI: true,
                    syncToBackend: false,
                    skipBackendFetch: false,
                    keepApiRequestListView: isApiRequestListVisible // å¦‚æœå½“å‰æ˜¾ç¤ºè¯·æ±‚æ¥å£åˆ—è¡¨ï¼Œä¿æŒè¯¥è§†å›¾
                });

                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¯·æ±‚æ¥å£åˆ—è¡¨ï¼Œåˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–° active é«˜äº®ï¼ˆå¯¹é½æ–°é—»åˆ—è¡¨çš„è¡Œä¸ºï¼‰
                if (isApiRequestListVisible) {
                    await this.updateApiRequestSidebar(false);
                }
                
                console.log('è¯·æ±‚æ¥å£ä¼šè¯å·²æ¿€æ´»ï¼ˆä½¿ç”¨åŒ¹é…çš„ä¼šè¯ï¼‰:', matchedSessionId);
                return;
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯ï¼Œåˆ›å»ºæ–°ä¼šè¯
            let session = this.sessions[sessionId];
            
            // æ„å»ºé¡µé¢å†…å®¹ï¼ˆåŒ…å«è¯·æ±‚è¯¦æƒ…ï¼‰
            // å¦‚æœä¼šè¯å·²å­˜åœ¨ä¸”å·²æœ‰pageContentï¼Œä¿ç•™åŸæœ‰å†…å®¹ï¼Œä¸é‡æ–°æ„å»º
            const shouldBuildPageContent = !session || !session.pageContent || session.pageContent.trim() === '';
            const pageContent = shouldBuildPageContent ? this._buildApiRequestPageContent(apiRequest) : null;
            
            if (!session) {
                // åˆ›å»ºæ–°ä¼šè¯
                // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
                session = this.createSessionObject(sessionId, {
                    url: apiRequest.pageUrl || requestUrl || '',
                    title: `${apiRequest.method || 'GET'} ${this._extractApiPath(requestUrl)}`,
                    pageTitle: `${apiRequest.method || 'GET'} ${this._extractApiPath(requestUrl)}`,
                    pageDescription: `æ¥å£è¯·æ±‚ï¼š${requestUrl}`,
                    pageContent: pageContent || ''
                });
                this.sessions[sessionId] = session;
                
                // æ ‡è®°ä¸ºè¯·æ±‚æ¥å£ä¼šè¯
                session._isApiRequestSession = true;
                session._apiRequestInfo = {
                    url: requestUrl || '',
                    requestUrl: requestUrl, // ç¡®ä¿requestUrlå­—æ®µå­˜åœ¨
                    method: apiRequest.method || 'GET',
                    status: apiRequest.status || 0,
                    statusText: apiRequest.statusText || '',
                    headers: apiRequest.headers || {},
                    body: apiRequest.body || null,
                    responseHeaders: apiRequest.responseHeaders || {},
                    responseBody: apiRequest.responseBody || null,
                    responseText: apiRequest.responseText || '',
                    duration: apiRequest.duration || 0,
                    timestamp: apiRequest.timestamp || Date.now(),
                    type: apiRequest.type || 'fetch',
                    curl: apiRequest.curl || '',
                    pageUrl: apiRequest.pageUrl || '',
                    tags: apiRequest.tags || []
                };
                
                // ä¿å­˜ä¼šè¯åˆ°æœ¬åœ°
                await this.saveAllSessions(false, false);
            } else {
                // æ›´æ–°ç°æœ‰ä¼šè¯çš„è¯·æ±‚æ¥å£ä¿¡æ¯
                // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
                session._isApiRequestSession = true;
                session._apiRequestInfo = {
                    url: requestUrl || '',
                    requestUrl: requestUrl, // ç¡®ä¿requestUrlå­—æ®µå­˜åœ¨
                    method: apiRequest.method || 'GET',
                    status: apiRequest.status || 0,
                    statusText: apiRequest.statusText || '',
                    headers: apiRequest.headers || {},
                    body: apiRequest.body || null,
                    responseHeaders: apiRequest.responseHeaders || {},
                    responseBody: apiRequest.responseBody || null,
                    responseText: apiRequest.responseText || '',
                    duration: apiRequest.duration || 0,
                    timestamp: apiRequest.timestamp || Date.now(),
                    type: apiRequest.type || 'fetch',
                    curl: apiRequest.curl || '',
                    pageUrl: apiRequest.pageUrl || '',
                    tags: apiRequest.tags || []
                };
                // ä½¿ç”¨ä¸Šé¢å·²ç»å®šä¹‰çš„ requestUrl
                session.pageTitle = `${apiRequest.method || 'GET'} ${this._extractApiPath(requestUrl)}`;
                session.pageDescription = `æ¥å£è¯·æ±‚ï¼š${requestUrl}`;
                // åªæœ‰åœ¨pageContentä¸ºç©ºæ—¶æ‰æ›´æ–°ï¼Œä¿ç•™å·²è¿½åŠ çš„å“åº”å†…å®¹
                if (shouldBuildPageContent && pageContent) {
                    session.pageContent = pageContent;
                }
            }
            
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¾ç¤ºè¯·æ±‚æ¥å£åˆ—è¡¨
            const isApiRequestListVisible = this.apiRequestListVisible;
            
            // æ¿€æ´»ä¼šè¯
            await this.activateSession(sessionId, {
                saveCurrent: false,
                updateConsistency: false,
                updateUI: true,
                syncToBackend: false,
                skipBackendFetch: true,
                keepApiRequestListView: isApiRequestListVisible // å¦‚æœå½“å‰æ˜¾ç¤ºè¯·æ±‚æ¥å£åˆ—è¡¨ï¼Œä¿æŒè¯¥è§†å›¾
            });

            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¯·æ±‚æ¥å£åˆ—è¡¨ï¼Œåˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–° active é«˜äº®ï¼ˆå¯¹é½æ–°é—»åˆ—è¡¨çš„è¡Œä¸ºï¼‰
            if (isApiRequestListVisible) {
                await this.updateApiRequestSidebar(false);
            }
            
            // ç¡®ä¿ä¼šè¯ä¿¡æ¯å·²æ›´æ–°ï¼ˆåœ¨æ¿€æ´»ä¼šè¯åï¼‰
            const activatedSession = this.sessions[sessionId];
            if (activatedSession) {
                activatedSession._isApiRequestSession = true;
                // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
                const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
                activatedSession._apiRequestInfo = {
                    url: requestUrl || '',
                    requestUrl: requestUrl, // ç¡®ä¿requestUrlå­—æ®µå­˜åœ¨
                    method: apiRequest.method || 'GET',
                    status: apiRequest.status || 0,
                    statusText: apiRequest.statusText || '',
                    headers: apiRequest.headers || {},
                    body: apiRequest.body || null,
                    responseHeaders: apiRequest.responseHeaders || {},
                    responseBody: apiRequest.responseBody || null,
                    responseText: apiRequest.responseText || '',
                    duration: apiRequest.duration || 0,
                    timestamp: apiRequest.timestamp || Date.now(),
                    type: apiRequest.type || 'fetch',
                    curl: apiRequest.curl || '',
                    pageUrl: apiRequest.pageUrl || '',
                    tags: apiRequest.tags || []
                };
                activatedSession.pageTitle = `${apiRequest.method || 'GET'} ${this._extractApiPath(requestUrl)}`;
                activatedSession.pageDescription = `æ¥å£è¯·æ±‚ï¼š${requestUrl}`;
                // åªæœ‰åœ¨pageContentä¸ºç©ºæ—¶æ‰æ›´æ–°ï¼Œä¿ç•™å·²è¿½åŠ çš„å“åº”å†…å®¹
                if (shouldBuildPageContent && pageContent) {
                    activatedSession.pageContent = pageContent;
                }
            }
            
            console.log('è¯·æ±‚æ¥å£ä¼šè¯å·²åˆ›å»ºå¹¶æ¿€æ´»:', sessionId);
        } catch (error) {
            console.error('å¤„ç†è¯·æ±‚æ¥å£ç‚¹å‡»å¤±è´¥:', error);
            this.showNotification('æ‰“å¼€è¯·æ±‚æ¥å£ä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }
    
    // å¤„ç†è¯·æ±‚æ¥å£ä¿å­˜ä¼šè¯ï¼ˆå‚è€ƒæ–°é—»åˆ—è¡¨çš„å®ç°ï¼‰
    async handleApiRequestSaveSession(apiRequest) {
        try {
            if (!apiRequest) {
                this.showNotification('è¯·æ±‚æ¥å£æ•°æ®æ— æ•ˆ', 'error');
                return false;
            }
            
            // å…ˆåˆ›å»ºæˆ–æ¿€æ´»ä¼šè¯
            await this.handleApiRequestClick(apiRequest);
            
            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
            const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
            const pageUrl = apiRequest.pageUrl || '';
            const isBlankApiRequest = typeof pageUrl === 'string' && pageUrl.startsWith('blank-request:');
            const sessionIdentity = isBlankApiRequest ? pageUrl : requestUrl;
            // è·å–ä¼šè¯ID
            const requestId = `${apiRequest.method || 'GET'}:${sessionIdentity}`;
            const sessionId = await this.generateSessionId(requestId);
            
            // ç¡®ä¿ä¼šè¯å­˜åœ¨
            let session = this.sessions[sessionId];
            if (!session) {
                // å¦‚æœä¼šè¯ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
                await this.handleApiRequestClick(apiRequest);
                session = this.sessions[sessionId];
            }
            
            if (!session) {
                this.showNotification('æ— æ³•åˆ›å»ºä¼šè¯', 'error');
                return false;
            }
            
            // ä¿å­˜ä¼šè¯åˆ°åç«¯ï¼ˆå‚è€ƒæ–°é—»/é€šç”¨ä¿å­˜é€»è¾‘ï¼šç»Ÿä¸€èµ° /session/saveï¼‰
            // è¯´æ˜ï¼šç»Ÿä¸€é€šè¿‡ syncSessionToBackend() -> sessionApi.saveSession()ï¼Œé¿å…åˆ†æ”¯é€»è¾‘å¯¼è‡´æœªèµ° /session/save
            if (this.sessionApi && PET_CONFIG?.api?.syncSessionsToBackend) {
                try {
                    // ä¼˜å…ˆä½¿ç”¨ä¼šè¯ä¸­å·²æœ‰çš„ pageContentï¼Œå¦‚æœä¸ºç©ºæ‰æ„å»ºæ–°çš„ï¼ˆæ¥å£è¯¦æƒ…ï¼‰
                    let pageContent = session.pageContent;
                    if (!pageContent || pageContent.trim() === '') {
                        pageContent = this._buildApiRequestPageContent(apiRequest);
                    }

                    // å†™å›ä¼šè¯å¯¹è±¡ï¼Œç¡®ä¿ syncSessionToBackend èƒ½æ‹¿åˆ°å®Œæ•´ä¿¡æ¯å¹¶æ­£ç¡®åŒ…å« pageContent
                    const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
                    const sessionUrl = apiRequest.pageUrl || requestUrl || '';
                    session.url = sessionUrl;
                    session.pageTitle = `${apiRequest.method || 'GET'} ${this._extractApiPath(requestUrl)}`;
                    session.pageDescription = `æ¥å£è¯·æ±‚ï¼š${requestUrl}`;
                    session.pageContent = pageContent || '';
                    session.updatedAt = Date.now();
                    session.lastAccessTime = Date.now();

                    // ç¡®ä¿æ¥å£ä¼šè¯æ ‡è®°ä¸å…ƒæ•°æ®é½å…¨
                    session._isApiRequestSession = true;
                    session._apiRequestInfo = {
                        // å…¼å®¹æ—§å­—æ®µï¼šurlï¼ŒåŒæ—¶è¡¥é½ requestUrl
                        url: requestUrl || '',
                        requestUrl: apiRequest.requestUrl || requestUrl || '',
                        method: apiRequest.method || 'GET',
                        status: apiRequest.status || 0,
                        statusText: apiRequest.statusText || '',
                        headers: apiRequest.headers || {},
                        body: apiRequest.body || null,
                        responseHeaders: apiRequest.responseHeaders || {},
                        responseBody: apiRequest.responseBody || null,
                        responseText: apiRequest.responseText || '',
                        duration: apiRequest.duration || 0,
                        timestamp: apiRequest.timestamp || Date.now(),
                        type: apiRequest.type || 'fetch',
                        curl: apiRequest.curl || '',
                        pageUrl: apiRequest.pageUrl || '',
                        tags: apiRequest.tags || []
                    };

                    // å…ˆè½æœ¬åœ°ï¼Œé¿å…åç«¯å¤±è´¥å¯¼è‡´ç”¨æˆ·å†…å®¹ä¸¢å¤±
                    await this.saveAllSessions(true, false);

                    // åŒæ­¥åˆ°åç«¯ï¼šimmediate=trueï¼ŒincludePageContent=trueï¼ˆç¡®ä¿æ¥å£è¯¦æƒ…è¢«ä¿å­˜ï¼‰
                    await this.syncSessionToBackend(sessionId, true, true);

                    console.log('è¯·æ±‚æ¥å£ä¼šè¯å·²é€šè¿‡ /session/save ä¿å­˜åˆ°åç«¯:', sessionId);
                    this.showNotification('ä¼šè¯å·²ä¿å­˜', 'success');
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜è¯·æ±‚æ¥å£ä¼šè¯åˆ°åç«¯å¤±è´¥:', error);
                    this.showNotification('ä¿å­˜ä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    return false;
                }
            }

            // å¦‚æœæ²¡æœ‰å¯ç”¨åç«¯åŒæ­¥ï¼Œåªä¿å­˜åˆ°æœ¬åœ°
            await this.saveAllSessions(true, false);
            this.showNotification('ä¼šè¯å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
            return true;
        } catch (error) {
            console.error('ä¿å­˜è¯·æ±‚æ¥å£ä¼šè¯å¤±è´¥:', error);
            this.showNotification('ä¿å­˜ä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            return false;
        }
    }

    /**
     * æ¥å£ä¼šè¯ï¼šæ¬¢è¿æ¶ˆæ¯é‡Œçš„â€œä¿å­˜ä¼šè¯â€æŒ‰é’®ç‚¹å‡»ï¼ˆé¿å…ä½¿ç”¨é€šç”¨ handleManualSaveSession è¦†ç›–æ¥å£ä¼šè¯çš„ URL/ä¸Šä¸‹æ–‡ï¼‰
     * @param {HTMLElement} button
     */
    async handleManualSaveApiRequestSession(button) {
        const session = this.currentSessionId ? this.sessions[this.currentSessionId] : null;
        const apiRequestInfo = session && session._apiRequestInfo ? session._apiRequestInfo : null;
        if (!session || !apiRequestInfo) {
            console.warn('å½“å‰ä¸æ˜¯æ¥å£ä¼šè¯æˆ–ç¼ºå°‘æ¥å£ä¿¡æ¯ï¼Œæ— æ³•ä¿å­˜');
            this._showManualSaveStatus(button, false);
            return;
        }

        const iconEl = button.querySelector('.save-btn-icon');
        const textEl = button.querySelector('.save-btn-text');
        const loaderEl = button.querySelector('.save-btn-loader');

        try {
            // loading çŠ¶æ€
            button.disabled = true;
            button.classList.add('loading');
            if (iconEl) iconEl.style.display = 'none';
            if (textEl) textEl.textContent = 'ä¿å­˜ä¸­...';
            if (loaderEl) loaderEl.style.display = 'block';

            const ok = await this.handleApiRequestSaveSession(apiRequestInfo);
            if (ok) {
                // æ ‡è®°å·²ä¿å­˜åˆ°åç«¯ï¼ˆç”¨äºéšè—æŒ‰é’®ï¼‰
                this.backendSessionIds.add(this.currentSessionId);
                await this.refreshWelcomeMessage();
            }

            this._showManualSaveStatus(button, ok);
        } catch (e) {
            console.error('æ¥å£ä¼šè¯æ‰‹åŠ¨ä¿å­˜å¤±è´¥:', e);
            this._showManualSaveStatus(button, false);
        }
    }
    
    // å¤„ç†APIè¯·æ±‚åˆ é™¤
    async handleApiRequestDelete(apiRequest) {
        try {
            if (!apiRequest) {
                this.showNotification('è¯·æ±‚æ¥å£æ•°æ®æ— æ•ˆ', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ key å­—æ®µï¼ˆåªæœ‰APIæ•°æ®æ‰èƒ½åˆ é™¤ï¼‰
            const requestKey = this._getRequestKey(apiRequest);
            if (!requestKey) {
                this.showNotification('è¯¥è¯·æ±‚æ— æ³•åˆ é™¤ï¼ˆç¼ºå°‘æ ‡è¯†ç¬¦ï¼‰', 'error');
                return;
            }
            
            // æ£€æŸ¥apiRequestApiæ˜¯å¦å¯ç”¨
            if (!this.apiRequestApi || !this.apiRequestApi.isEnabled()) {
                this.showNotification('APIç®¡ç†å™¨æœªå¯ç”¨ï¼Œæ— æ³•åˆ é™¤', 'error');
                return;
            }
            
            // å‡†å¤‡åˆ é™¤æ•°æ®ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
            const deleteData = {
                key: requestKey,
                url: apiRequest.url || apiRequest.requestUrl || ''
            };
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.showNotification('æ­£åœ¨åˆ é™¤...', 'info');
            
            // è°ƒç”¨APIåˆ é™¤
            const result = await this.apiRequestApi.deleteApiRequest(deleteData);
            
            if (result && result.success) {
                console.log('APIè¯·æ±‚å·²åˆ é™¤:', deleteData);
                
                // ä»æœ¬åœ°è¯·æ±‚åˆ—è¡¨ä¸­ç§»é™¤
                if (this.apiRequestManager) {
                    const index = this.apiRequestManager.requests.findIndex(req => {
                        // ä¼˜å…ˆä½¿ç”¨ key åŒ¹é…
                        if (deleteData.key) {
                            const reqKey = this._getRequestKey(req);
                            return reqKey === deleteData.key;
                        }
                        // å¦‚æœæ²¡æœ‰keyï¼Œä½¿ç”¨URLåŒ¹é…
                        return req.url === deleteData.url;
                    });
                    
                    if (index >= 0) {
                        this.apiRequestManager.requests.splice(index, 1);
                        // é‡å»ºç´¢å¼•
                        if (this.apiRequestManager._rebuildIndex) {
                            this.apiRequestManager._rebuildIndex();
                        }
                    }
                }
                
                // åˆ·æ–°åˆ—è¡¨
                await this.updateApiRequestSidebar(true);
                
                this.showNotification('åˆ é™¤æˆåŠŸ', 'success');
            } else {
                throw new Error(result?.message || 'åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            console.error('åˆ é™¤APIè¯·æ±‚å¤±è´¥:', error);
            this.showNotification(`åˆ é™¤å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        }
    }
    
    // æ„å»ºè¯·æ±‚æ¥å£çš„é¡µé¢å†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼‰
    _buildApiRequestPageContent(apiRequest) {
        if (!apiRequest) return '';
        
        let content = `# æ¥å£è¯·æ±‚è¯¦æƒ…\n\n`;
        
        // åŸºæœ¬ä¿¡æ¯
        content += `## åŸºæœ¬ä¿¡æ¯\n\n`;
        content += `- **æ–¹æ³•**: ${apiRequest.method || 'GET'}\n`;
        // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
        const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
        content += `- **URL**: ${requestUrl}\n`;
        content += `- **çŠ¶æ€**: ${apiRequest.status || 0} ${apiRequest.statusText || ''}\n`;
        content += `- **è€—æ—¶**: ${apiRequest.duration || 0}ms\n`;
        content += `- **æ—¶é—´**: ${new Date(apiRequest.timestamp || Date.now()).toLocaleString()}\n`;
        content += `- **ç±»å‹**: ${apiRequest.type || 'fetch'}\n\n`;
        
        // è¯·æ±‚å¤´
        if (apiRequest.headers && Object.keys(apiRequest.headers).length > 0) {
            content += `## è¯·æ±‚å¤´\n\n`;
            content += '```\n';
            for (const [key, value] of Object.entries(apiRequest.headers)) {
                content += `${key}: ${value}\n`;
            }
            content += '```\n\n';
        }
        
        // è¯·æ±‚ä½“
        if (apiRequest.body) {
            content += `## è¯·æ±‚ä½“\n\n`;
            content += '```json\n';
            if (typeof apiRequest.body === 'string') {
                try {
                    const parsed = JSON.parse(apiRequest.body);
                    content += JSON.stringify(parsed, null, 2);
                } catch (e) {
                    content += apiRequest.body;
                }
            } else {
                content += JSON.stringify(apiRequest.body, null, 2);
            }
            content += '\n```\n\n';
        }
        
        // å“åº”å¤´
        if (apiRequest.responseHeaders && Object.keys(apiRequest.responseHeaders).length > 0) {
            content += `## å“åº”å¤´\n\n`;
            content += '```\n';
            for (const [key, value] of Object.entries(apiRequest.responseHeaders)) {
                content += `${key}: ${value}\n`;
            }
            content += '```\n\n';
        }
        
        // å“åº”ä½“
        if (apiRequest.responseText || apiRequest.responseBody) {
            content += `## å“åº”ä½“\n\n`;
            content += '```json\n';
            if (apiRequest.responseBody) {
                content += JSON.stringify(apiRequest.responseBody, null, 2);
            } else if (apiRequest.responseText) {
                try {
                    const parsed = JSON.parse(apiRequest.responseText);
                    content += JSON.stringify(parsed, null, 2);
                } catch (e) {
                    content += apiRequest.responseText;
                }
            }
            content += '\n```\n\n';
        }
        
        // cURLå‘½ä»¤
        if (apiRequest.curl) {
            content += `## cURLå‘½ä»¤\n\n`;
            content += '```bash\n';
            content += apiRequest.curl;
            content += '\n```\n\n';
        }
        
        return content;
    }
    
    /**
     * ç”Ÿæˆå”¯ä¸€çš„ blank-request æ ‡è¯†ç¬¦
     * @returns {string} æ ¼å¼ä¸º blank-request:xxx çš„å”¯ä¸€å­—ç¬¦ä¸²
     */
    _generateBlankRequestId() {
        // ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2, 11);
        return `blank-request:${timestamp}_${random}`;
    }
    
    // æ–°å»ºè¯·æ±‚æ¥å£ï¼ˆç±»ä¼¼Postmanï¼‰
    async createNewApiRequest() {
        // åˆ›å»ºç©ºçš„è¯·æ±‚å¯¹è±¡
        const newRequest = {
            method: 'GET',
            url: '',
            headers: {},
            body: null,
            title: '',
            description: ''
        };
        
        // æ‰“å¼€ç¼–è¾‘å™¨ï¼ˆæ–°å»ºæ¨¡å¼ï¼‰
        this.openApiRequestEditor(newRequest, true);
    }
    
    // ç¼–è¾‘è¯·æ±‚æ¥å£ï¼ˆå‚è€ƒPostmançš„è®¾è®¡ï¼Œæ”¯æŒç¼–è¾‘æ‰€æœ‰å‚æ•°ï¼‰
    async editApiRequest(apiRequest) {
        if (!apiRequest) {
            console.warn('è¯·æ±‚æ¥å£æ•°æ®æ— æ•ˆï¼Œæ— æ³•ç¼–è¾‘:', apiRequest);
            return;
        }
        
        // æ‰“å¼€ç¼–è¾‘å™¨ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
        this.openApiRequestEditor(apiRequest, false);
    }
    
    // æ‰“å¼€å¢å¼ºçš„æ¥å£ç¼–è¾‘å™¨ï¼ˆç±»ä¼¼Postmanï¼‰
    openApiRequestEditor(apiRequest, isNew = false) {
        // ç¡®ä¿ç¼–è¾‘å™¨UIå­˜åœ¨
        this.ensureApiRequestEditorUi();
        
        const modal = document.body.querySelector('#pet-api-request-editor');
        if (!modal) {
            console.error('æ¥å£ç¼–è¾‘å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // æ˜¾ç¤ºå¯¹è¯æ¡†
        modal.style.display = 'flex';
        modal.dataset.isNew = isNew ? 'true' : 'false';
        modal.dataset.apiRequestKey = apiRequest.key || apiRequest._id || apiRequest.id || '';
        
        // å¡«å……è¡¨å•æ•°æ®
        const methodSelect = modal.querySelector('.api-editor-method-select');
        const urlInput = modal.querySelector('.api-editor-url-input');
        const titleInput = modal.querySelector('.api-editor-title-input');
        const descriptionInput = modal.querySelector('.api-editor-description-input');
        const headersContainer = modal.querySelector('.api-editor-headers-container');
        const bodyTypeSelect = modal.querySelector('.api-editor-body-type-select');
        const bodyTextarea = modal.querySelector('.api-editor-body-textarea');
        
        // å¡«å……åŸºæœ¬ä¿¡æ¯
        if (methodSelect) {
            methodSelect.value = apiRequest.method || 'GET';
        }
        if (urlInput) {
            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
            urlInput.value = apiRequest.requestUrl || apiRequest.url || '';
        }
        if (titleInput) {
            titleInput.value = apiRequest.title || '';
        }
        if (descriptionInput) {
            descriptionInput.value = apiRequest.description || '';
        }
        
        // å¡«å……Headers
        this.populateHeadersEditor(headersContainer, apiRequest.headers || {});
        
        // å¡«å……Body
        if (bodyTypeSelect && bodyTextarea) {
            const bodyType = this.detectBodyType(apiRequest.body);
            bodyTypeSelect.value = bodyType;
            this.updateBodyEditor(bodyTypeSelect, bodyTextarea, apiRequest.body);
            
            // æ›´æ–°æ ¼å¼åŒ–æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            const formatJsonBtn = modal.querySelector('.api-editor-format-json-btn');
            if (formatJsonBtn) {
                formatJsonBtn.style.display = bodyType === 'json' ? 'block' : 'none';
            }
        }
        
        // å¡«å……å“åº”ç»“æœ
        const responseTextarea = modal.querySelector('.api-editor-response-textarea');
        if (responseTextarea) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å“åº”æ•°æ®ï¼ˆéœ€è¦åŒæ—¶æ£€æŸ¥å€¼æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼‰
            const hasResponseText = apiRequest.responseText && String(apiRequest.responseText).trim().length > 0;
            const hasResponseBody = apiRequest.responseBody !== null && apiRequest.responseBody !== undefined;
            
            if (hasResponseText || hasResponseBody) {
                // ç¡®å®šå“åº”æ–‡æœ¬å†…å®¹
                let responseText = '';
                if (hasResponseText) {
                    responseText = String(apiRequest.responseText);
                    // å¦‚æœæ˜¯JSONå­—ç¬¦ä¸²ï¼Œå°è¯•æ ¼å¼åŒ–
                    if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
                        try {
                            const parsed = JSON.parse(responseText);
                            responseText = JSON.stringify(parsed, null, 2);
                        } catch (e) {
                            // è§£æå¤±è´¥ï¼Œä¿æŒåŸæ ·
                        }
                    }
                } else if (hasResponseBody) {
                    // å¦‚æœresponseBodyæ˜¯å¯¹è±¡ï¼Œæ ¼å¼åŒ–ä¸ºJSON
                    if (typeof apiRequest.responseBody === 'object') {
                        responseText = JSON.stringify(apiRequest.responseBody, null, 2);
                    } else {
                        responseText = String(apiRequest.responseBody);
                    }
                }
                
                const status = apiRequest.status || 0;
                const statusText = apiRequest.statusText || '';
                const duration = apiRequest.duration || 0;
                const responseHeaders = apiRequest.responseHeaders || {};
                
                const statusColor = status >= 200 && status < 300 ? '#10b981' : 
                                   status >= 400 ? '#ef4444' : '#f59e0b';
                
                responseTextarea.value = `çŠ¶æ€: ${status} ${statusText}\n` +
                                       `è€—æ—¶: ${duration}ms\n` +
                                       `å“åº”å¤´:\n${JSON.stringify(responseHeaders, null, 2)}\n\n` +
                                       `å“åº”ä½“:\n${responseText}`;
                responseTextarea.style.borderColor = statusColor;
            } else {
                // æ²¡æœ‰å“åº”æ•°æ®æ—¶ï¼Œæ¸…ç©ºå¹¶é‡ç½®æ ·å¼
                responseTextarea.value = '';
                responseTextarea.style.borderColor = '#d1d5db';
            }
        }
        
        // æ›´æ–°æ ‡é¢˜
        const title = modal.querySelector('.api-editor-title');
        if (title) {
            title.textContent = isNew ? 'æ–°å»ºæ¥å£è¯·æ±‚' : 'ç¼–è¾‘æ¥å£è¯·æ±‚';
        }
        
        // curl å¯¼å…¥æŒ‰é’®åœ¨æ–°å»ºå’Œç¼–è¾‘æ—¶éƒ½æ˜¾ç¤ºï¼Œæ— éœ€æ§åˆ¶æ˜¾ç¤ºçŠ¶æ€
        
        // èšç„¦åˆ°URLè¾“å…¥æ¡†
        if (urlInput) {
            setTimeout(() => {
                urlInput.focus();
                if (isNew) {
                    urlInput.select();
                }
            }, 100);
        }
        
        // ç»‘å®šäº‹ä»¶
        this.bindApiRequestEditorEvents(modal, apiRequest, isNew);
    }
    
    // æ‰“å¼€è¯·æ±‚æ¥å£ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆä¿ç•™æ—§ç‰ˆæœ¬ä»¥å…¼å®¹ï¼‰
    openApiRequestInfoEditor(apiRequest, originalTitle, originalDescription) {
        // ç¡®ä¿å¯¹è¯æ¡†UIå­˜åœ¨
        this.ensureApiRequestInfoEditorUi();
        
        const modal = document.body.querySelector('#pet-api-request-info-editor');
        if (!modal) {
            console.error('è¯·æ±‚æ¥å£ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†æœªæ‰¾åˆ°');
            return;
        }
        
        // æ˜¾ç¤ºå¯¹è¯æ¡†
        modal.style.display = 'flex';
        modal.dataset.apiRequestKey = apiRequest.key || apiRequest._id || apiRequest.id;
        // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
        const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
        modal.dataset.apiRequestUrl = requestUrl;
        
        // å¡«å……å½“å‰å€¼
        const titleInput = modal.querySelector('.api-request-editor-title-input');
        const descriptionInput = modal.querySelector('.api-request-editor-description-input');
        
        if (titleInput) {
            titleInput.value = originalTitle;
        }
        if (descriptionInput) {
            descriptionInput.value = originalDescription;
        }
        
        // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
        if (titleInput) {
            setTimeout(() => {
                titleInput.focus();
                titleInput.select();
            }, 100);
        }
        
        // æ·»åŠ å…³é—­äº‹ä»¶
        const closeBtn = modal.querySelector('.api-request-editor-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeApiRequestInfoEditor();
        }
        
        // æ·»åŠ ä¿å­˜äº‹ä»¶
        const saveBtn = modal.querySelector('.api-request-editor-save');
        if (saveBtn) {
            saveBtn.onclick = () => this.saveApiRequestInfo(apiRequest);
        }
        
        // æ·»åŠ å–æ¶ˆäº‹ä»¶
        const cancelBtn = modal.querySelector('.api-request-editor-cancel');
        if (cancelBtn) {
            cancelBtn.onclick = () => this.closeApiRequestInfoEditor();
        }
        
        // æ·»åŠ æ™ºèƒ½ç”Ÿæˆæ ‡é¢˜äº‹ä»¶
        const generateTitleBtn = modal.querySelector('.api-request-editor-generate-title');
        if (generateTitleBtn) {
            generateTitleBtn.onclick = () => this.generateApiRequestTitle(apiRequest);
        }
        
        // æ·»åŠ æ™ºèƒ½ç”Ÿæˆæè¿°äº‹ä»¶
        const generateDescriptionBtn = modal.querySelector('.api-request-editor-generate-description');
        if (generateDescriptionBtn) {
            generateDescriptionBtn.onclick = () => this.generateApiRequestDescription(apiRequest);
        }
        
        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeApiRequestInfoEditor();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // ç¡®ä¿å¢å¼ºçš„æ¥å£ç¼–è¾‘å™¨UIå­˜åœ¨ï¼ˆç±»ä¼¼Postmanï¼‰
    ensureApiRequestEditorUi() {
        if (document.body.querySelector('#pet-api-request-editor')) return;
        
        const modal = document.createElement('div');
        modal.id = 'pet-api-request-editor';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.6) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 2147483653 !important;
            padding: 20px !important;
            box-sizing: border-box !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeApiRequestEditor();
            }
        });
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            width: 100% !important;
            max-width: 900px !important;
            max-height: 90vh !important;
            display: flex !important;
            flex-direction: column !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            overflow: hidden !important;
        `;
        
        // å¤´éƒ¨
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 20px 24px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
        `;
        
        const title = document.createElement('h3');
        title.className = 'api-editor-title';
        title.textContent = 'ç¼–è¾‘æ¥å£è¯·æ±‚';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #1f2937 !important;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'api-editor-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #6b7280 !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#e5e7eb';
            closeBtn.style.color = '#1f2937';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#6b7280';
        });
        
        const headerRight = document.createElement('div');
        headerRight.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        `;
        headerRight.appendChild(closeBtn);
        
        header.appendChild(title);
        header.appendChild(headerRight);
        
        // å†…å®¹åŒºåŸŸï¼ˆå¯æ»šåŠ¨ï¼‰
        const content = document.createElement('div');
        content.style.cssText = `
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 24px !important;
        `;
        
        // åŸºæœ¬ä¿¡æ¯åŒºåŸŸ
        const basicInfoSection = document.createElement('div');
        basicInfoSection.style.cssText = `
            margin-bottom: 24px !important;
        `;
        
        // æ ‡é¢˜è¾“å…¥
        const titleGroup = this.createFormGroup('æ ‡é¢˜', 'input', 'api-editor-title-input', 'è¯·è¾“å…¥æ¥å£æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰');
        basicInfoSection.appendChild(titleGroup);
        
        // æè¿°è¾“å…¥
        const descriptionGroup = this.createFormGroup('æè¿°', 'textarea', 'api-editor-description-input', 'è¯·è¾“å…¥æ¥å£æè¿°ï¼ˆå¯é€‰ï¼‰', 3);
        basicInfoSection.appendChild(descriptionGroup);
        
        // è¯·æ±‚æ–¹æ³•é€‰æ‹©å™¨
        const methodGroup = document.createElement('div');
        methodGroup.style.cssText = `margin-bottom: 16px !important;`;
        const methodLabel = document.createElement('label');
        methodLabel.textContent = 'è¯·æ±‚æ–¹æ³•';
        methodLabel.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #374151 !important;
            margin-bottom: 8px !important;
        `;
        const methodSelect = document.createElement('select');
        methodSelect.className = 'api-editor-method-select';
        methodSelect.style.cssText = `
            width: 100% !important;
            padding: 10px 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            background: white !important;
            cursor: pointer !important;
            transition: border-color 0.2s ease !important;
        `;
        ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS'].forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = method;
            methodSelect.appendChild(option);
        });
        methodGroup.appendChild(methodLabel);
        methodGroup.appendChild(methodSelect);
        
        // URLè¾“å…¥
        const urlGroup = this.createFormGroup('è¯·æ±‚URL', 'input', 'api-editor-url-input', 'https://api.example.com/endpoint');
        const urlInput = urlGroup.querySelector('.api-editor-url-input');
        if (urlInput) {
            urlInput.style.cssText += `font-family: 'Monaco', 'Menlo', monospace !important;`;
        }
        
        // æ·»åŠ  curl å¯¼å…¥æŒ‰é’®åˆ° URL è¾“å…¥æ¡†æ—è¾¹
        const urlLabel = urlGroup.querySelector('label');
        if (urlLabel) {
            const curlImportBtn = document.createElement('button');
            curlImportBtn.className = 'api-editor-curl-import-btn';
            curlImportBtn.textContent = 'ğŸ“¥ ä» curl å¯¼å…¥';
            curlImportBtn.title = 'ä» curl å‘½ä»¤å¯¼å…¥æ¥å£è¯·æ±‚';
            curlImportBtn.style.cssText = `
                margin-left: 8px !important;
                padding: 6px 12px !important;
                border: 1px solid #d1d5db !important;
                border-radius: 6px !important;
                background: white !important;
                color: #3b82f6 !important;
                font-size: 12px !important;
                font-weight: 500 !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                display: inline-flex !important;
                align-items: center !important;
                gap: 4px !important;
            `;
            curlImportBtn.addEventListener('mouseenter', () => {
                curlImportBtn.style.background = '#eff6ff';
                curlImportBtn.style.borderColor = '#3b82f6';
            });
            curlImportBtn.addEventListener('mouseleave', () => {
                curlImportBtn.style.background = 'white';
                curlImportBtn.style.borderColor = '#d1d5db';
            });
            curlImportBtn.addEventListener('click', () => {
                this.showCurlImportDialog(modal);
            });
            
            // å°†æŒ‰é’®æ·»åŠ åˆ°æ ‡ç­¾æ—è¾¹
            urlLabel.style.cssText += `display: flex !important; align-items: center !important; justify-content: space-between !important;`;
            urlLabel.appendChild(curlImportBtn);
        }
        
        // Headersç¼–è¾‘å™¨
        const headersGroup = document.createElement('div');
        headersGroup.style.cssText = `margin-bottom: 24px !important;`;
        const headersLabel = document.createElement('label');
        headersLabel.textContent = 'è¯·æ±‚å¤´ (Headers)';
        headersLabel.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #374151 !important;
            margin-bottom: 8px !important;
        `;
        const headersContainer = document.createElement('div');
        headersContainer.className = 'api-editor-headers-container';
        headersContainer.style.cssText = `
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            background: #f9fafb !important;
        `;
        headersGroup.appendChild(headersLabel);
        headersGroup.appendChild(headersContainer);
        
        // Bodyç¼–è¾‘å™¨
        const bodyGroup = document.createElement('div');
        bodyGroup.style.cssText = `margin-bottom: 24px !important;`;
        const bodyLabelContainer = document.createElement('div');
        bodyLabelContainer.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 8px !important;
        `;
        const bodyLabel = document.createElement('label');
        bodyLabel.textContent = 'è¯·æ±‚ä½“ (Body)';
        bodyLabel.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #374151 !important;
            margin: 0 !important;
        `;
        const formatJsonBtn = document.createElement('button');
        formatJsonBtn.className = 'api-editor-format-json-btn';
        formatJsonBtn.textContent = 'æ ¼å¼åŒ– JSON';
        formatJsonBtn.style.cssText = `
            padding: 6px 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 6px !important;
            background: white !important;
            color: #374151 !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            display: none !important;
        `;
        formatJsonBtn.addEventListener('mouseenter', () => {
            formatJsonBtn.style.background = '#f3f4f6';
            formatJsonBtn.style.borderColor = '#9ca3af';
        });
        formatJsonBtn.addEventListener('mouseleave', () => {
            formatJsonBtn.style.background = 'white';
            formatJsonBtn.style.borderColor = '#d1d5db';
        });
        formatJsonBtn.addEventListener('click', () => {
            this.formatJsonBody(bodyTextarea);
        });
        bodyLabelContainer.appendChild(bodyLabel);
        bodyLabelContainer.appendChild(formatJsonBtn);
        const bodyTypeSelect = document.createElement('select');
        bodyTypeSelect.className = 'api-editor-body-type-select';
        bodyTypeSelect.style.cssText = `
            width: 100% !important;
            padding: 8px 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px 8px 0 0 !important;
            border-bottom: none !important;
            font-size: 13px !important;
            background: white !important;
            cursor: pointer !important;
            margin-bottom: 0 !important;
        `;
        ['none', 'json', 'form-data', 'x-www-form-urlencoded', 'raw'].forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type === 'none' ? 'æ— ' : 
                               type === 'json' ? 'JSON' :
                               type === 'form-data' ? 'Form Data' :
                               type === 'x-www-form-urlencoded' ? 'x-www-form-urlencoded' :
                               'Raw';
            bodyTypeSelect.appendChild(option);
        });
        const bodyTextarea = document.createElement('textarea');
        bodyTextarea.className = 'api-editor-body-textarea';
        bodyTextarea.placeholder = 'è¯·è¾“å…¥è¯·æ±‚ä½“å†…å®¹...';
        bodyTextarea.style.cssText = `
            width: 100% !important;
            min-height: 200px !important;
            padding: 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0 0 8px 8px !important;
            font-size: 13px !important;
            font-family: 'Monaco', 'Menlo', monospace !important;
            resize: vertical !important;
            box-sizing: border-box !important;
        `;
        bodyGroup.appendChild(bodyLabelContainer);
        bodyGroup.appendChild(bodyTypeSelect);
        bodyGroup.appendChild(bodyTextarea);
        
        // ç›‘å¬Bodyç±»å‹å˜åŒ–
        bodyTypeSelect.addEventListener('change', () => {
            this.updateBodyEditor(bodyTypeSelect, bodyTextarea, null);
            // æ›´æ–°æ ¼å¼åŒ–æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            formatJsonBtn.style.display = bodyTypeSelect.value === 'json' ? 'block' : 'none';
        });
        
        // åˆå§‹åŒ–æ ¼å¼åŒ–æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        formatJsonBtn.style.display = bodyTypeSelect.value === 'json' ? 'block' : 'none';
        
        // å“åº”ç»“æœæ˜¾ç¤ºåŒºåŸŸ
        const responseGroup = document.createElement('div');
        responseGroup.style.cssText = `margin-bottom: 24px !important;`;
        const responseLabel = document.createElement('label');
        responseLabel.textContent = 'å“åº”ç»“æœ (Response)';
        responseLabel.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #374151 !important;
            margin-bottom: 8px !important;
        `;
        const responseTextarea = document.createElement('textarea');
        responseTextarea.className = 'api-editor-response-textarea';
        responseTextarea.placeholder = 'ç‚¹å‡»"å‘é€è¯·æ±‚"æŒ‰é’®åï¼Œå“åº”ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
        responseTextarea.readOnly = true;
        responseTextarea.style.cssText = `
            width: 100% !important;
            min-height: 200px !important;
            padding: 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            font-family: 'Monaco', 'Menlo', monospace !important;
            resize: vertical !important;
            box-sizing: border-box !important;
            background: #f9fafb !important;
            color: #374151 !important;
        `;
        responseGroup.appendChild(responseLabel);
        responseGroup.appendChild(responseTextarea);
        
        content.appendChild(basicInfoSection);
        content.appendChild(methodGroup);
        content.appendChild(urlGroup);
        content.appendChild(headersGroup);
        content.appendChild(bodyGroup);
        content.appendChild(responseGroup);
        
        // åº•éƒ¨æŒ‰é’®åŒºåŸŸ
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 12px !important;
            padding: 20px 24px !important;
            border-top: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
        `;
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'api-editor-cancel';
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            background: white !important;
            color: #374151 !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f3f4f6';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'white';
        });
        
        const sendBtn = document.createElement('button');
        sendBtn.className = 'api-editor-send';
        sendBtn.textContent = 'ğŸš€ å‘é€è¯·æ±‚';
        sendBtn.style.cssText = `
            padding: 10px 24px !important;
            border: none !important;
            border-radius: 8px !important;
            background: #10b981 !important;
            color: white !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        sendBtn.addEventListener('mouseenter', () => {
            sendBtn.style.background = '#059669';
        });
        sendBtn.addEventListener('mouseleave', () => {
            sendBtn.style.background = '#10b981';
        });
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'api-editor-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 24px !important;
            border: none !important;
            border-radius: 8px !important;
            background: #3b82f6 !important;
            color: white !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#2563eb';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#3b82f6';
        });
        
        footer.appendChild(cancelBtn);
        footer.appendChild(sendBtn);
        footer.appendChild(saveBtn);
        
        panel.appendChild(header);
        panel.appendChild(content);
        panel.appendChild(footer);
        modal.appendChild(panel);
        document.body.appendChild(modal);
    }
    
    // åˆ›å»ºè¡¨å•ç»„ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
    createFormGroup(labelText, inputType, inputClass, placeholder, rows = 1) {
        const group = document.createElement('div');
        group.style.cssText = `margin-bottom: 16px !important;`;
        
        const label = document.createElement('label');
        label.textContent = labelText;
        label.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #374151 !important;
            margin-bottom: 8px !important;
        `;
        
        let input;
        if (inputType === 'textarea') {
            input = document.createElement('textarea');
            input.rows = rows;
        } else {
            input = document.createElement('input');
            input.type = inputType;
        }
        input.className = inputClass;
        input.placeholder = placeholder;
        input.style.cssText = `
            width: 100% !important;
            padding: 10px 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            box-sizing: border-box !important;
            transition: border-color 0.2s ease !important;
            font-family: inherit !important;
        `;
        input.addEventListener('focus', () => {
            input.style.borderColor = '#3b82f6';
        });
        input.addEventListener('blur', () => {
            input.style.borderColor = '#d1d5db';
        });
        
        group.appendChild(label);
        group.appendChild(input);
        return group;
    }
    
    // å¡«å……Headersç¼–è¾‘å™¨
    populateHeadersEditor(container, headers) {
        container.innerHTML = '';
        
        // æ·»åŠ é»˜è®¤çš„Content-Type headerï¼ˆå¦‚æœæ˜¯POST/PUTç­‰ï¼‰
        const headerRows = [];
        if (headers && Object.keys(headers).length > 0) {
            Object.entries(headers).forEach(([key, value]) => {
                headerRows.push({ key, value, enabled: true });
            });
        }
        
        // å¦‚æœæ²¡æœ‰headersï¼Œè‡³å°‘æ·»åŠ ä¸€è¡Œç©ºè¡Œ
        if (headerRows.length === 0) {
            headerRows.push({ key: '', value: '', enabled: true });
        }
        
        headerRows.forEach((row, index) => {
            const rowElement = this.createHeaderRow(row.key, row.value, row.enabled, index);
            container.appendChild(rowElement);
        });
        
        // æ·»åŠ "æ·»åŠ Header"æŒ‰é’®
        const addBtn = document.createElement('button');
        addBtn.textContent = '+ æ·»åŠ Header';
        addBtn.style.cssText = `
            width: 100% !important;
            padding: 10px !important;
            border: 1px dashed #d1d5db !important;
            border-top: none !important;
            background: white !important;
            color: #6b7280 !important;
            font-size: 13px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.background = '#f9fafb';
            addBtn.style.borderColor = '#3b82f6';
            addBtn.style.color = '#3b82f6';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.background = 'white';
            addBtn.style.borderColor = '#d1d5db';
            addBtn.style.color = '#6b7280';
        });
        addBtn.addEventListener('click', () => {
            const newRow = this.createHeaderRow('', '', true, headerRows.length);
            container.insertBefore(newRow, addBtn);
        });
        container.appendChild(addBtn);
    }
    
    // åˆ›å»ºHeaderè¡Œ
    createHeaderRow(key, value, enabled, index) {
        const row = document.createElement('div');
        row.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            padding: 8px !important;
            border-bottom: 1px solid #e5e7eb !important;
            align-items: center !important;
        `;
        
        const keyInput = document.createElement('input');
        keyInput.type = 'text';
        keyInput.placeholder = 'Headeråç§°';
        keyInput.value = key;
        keyInput.style.cssText = `
            flex: 1 !important;
            padding: 6px 8px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            font-family: 'Monaco', 'Menlo', monospace !important;
        `;
        
        const valueInput = document.createElement('input');
        valueInput.type = 'text';
        valueInput.placeholder = 'Headerå€¼';
        valueInput.value = value;
        valueInput.style.cssText = `
            flex: 2 !important;
            padding: 6px 8px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            font-family: 'Monaco', 'Menlo', monospace !important;
        `;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'âœ•';
        deleteBtn.style.cssText = `
            padding: 4px 8px !important;
            border: none !important;
            background: #ef4444 !important;
            color: white !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            transition: all 0.2s ease !important;
        `;
        deleteBtn.addEventListener('mouseenter', () => {
            deleteBtn.style.background = '#dc2626';
        });
        deleteBtn.addEventListener('mouseleave', () => {
            deleteBtn.style.background = '#ef4444';
        });
        deleteBtn.addEventListener('click', () => {
            row.remove();
        });
        
        row.appendChild(keyInput);
        row.appendChild(valueInput);
        row.appendChild(deleteBtn);
        
        return row;
    }
    
    // æ£€æµ‹Bodyç±»å‹
    detectBodyType(body) {
        if (!body) return 'none';
        if (typeof body === 'string') {
            try {
                JSON.parse(body);
                return 'json';
            } catch {
                return 'raw';
            }
        }
        if (typeof body === 'object') {
            return 'json';
        }
        return 'none';
    }
    
    // æ›´æ–°Bodyç¼–è¾‘å™¨
    updateBodyEditor(typeSelect, textarea, body) {
        const type = typeSelect.value;
        
        if (type === 'none') {
            textarea.style.display = 'none';
            textarea.value = '';
        } else {
            textarea.style.display = 'block';
            
            if (body !== null && body !== undefined) {
                if (type === 'json') {
                    if (typeof body === 'object') {
                        textarea.value = JSON.stringify(body, null, 2);
                    } else if (typeof body === 'string') {
                        try {
                            const parsed = JSON.parse(body);
                            textarea.value = JSON.stringify(parsed, null, 2);
                        } catch {
                            textarea.value = body;
                        }
                    } else {
                        textarea.value = '';
                    }
                } else {
                    textarea.value = typeof body === 'string' ? body : JSON.stringify(body);
                }
            } else {
                if (type === 'json') {
                    textarea.value = '{\n  \n}';
                } else {
                    textarea.value = '';
                }
            }
        }
    }
    
    // æ ¼å¼åŒ–JSON Body
    formatJsonBody(textarea) {
        if (!textarea) {
            return;
        }
        
        const currentValue = textarea.value.trim();
        
        if (!currentValue) {
            // å¦‚æœä¸ºç©ºï¼Œè®¾ç½®ä¸ºç©ºçš„JSONå¯¹è±¡
            textarea.value = '{\n  \n}';
            return;
        }
        
        try {
            // å°è¯•è§£æJSON
            const parsed = JSON.parse(currentValue);
            // æ ¼å¼åŒ–JSONï¼ˆä½¿ç”¨2ä¸ªç©ºæ ¼ç¼©è¿›ï¼‰
            const formatted = JSON.stringify(parsed, null, 2);
            textarea.value = formatted;
            
            // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆå¯é€‰ï¼‰
            this.showApiRequestNotification('JSONæ ¼å¼åŒ–æˆåŠŸ', 'success');
        } catch (error) {
            // JSONæ ¼å¼é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
            this.showApiRequestNotification('JSONæ ¼å¼é”™è¯¯ï¼š' + error.message, 'error');
        }
    }
    
    // æ˜¾ç¤ºAPIè¯·æ±‚ç¼–è¾‘å™¨é€šçŸ¥ï¼ˆè¾…åŠ©æ–¹æ³•ï¼‰
    showApiRequestNotification(message, type = 'success') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `api-editor-notification ${type}`;
        notification.textContent = message;
        const backgroundColor = type === 'error' ? '#f44336' : 
                               type === 'info' ? '#2196F3' : '#4CAF50';
        
        notification.style.cssText = `
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            background: ${backgroundColor} !important;
            color: white !important;
            padding: 12px 20px !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            z-index: 10001 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            animation: slideInRight 0.3s ease-out !important;
            max-width: 400px !important;
        `;
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
        if (!document.getElementById('api-editor-notification-styles')) {
            const style = document.createElement('style');
            style.id = 'api-editor-notification-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `;
            if (document.head) {
                document.head.appendChild(style);
            }
        }
        
        if (document.body) {
            document.body.appendChild(notification);
        }
        
        // 3ç§’åç§»é™¤é€šçŸ¥
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, 3000);
    }
    
    // ç»‘å®šç¼–è¾‘å™¨äº‹ä»¶
    bindApiRequestEditorEvents(modal, apiRequest, isNew) {
        const closeBtn = modal.querySelector('.api-editor-close');
        const cancelBtn = modal.querySelector('.api-editor-cancel');
        const saveBtn = modal.querySelector('.api-editor-save');
        const sendBtn = modal.querySelector('.api-editor-send');
        
        const closeHandler = () => this.closeApiRequestEditor();
        
        if (closeBtn) closeBtn.onclick = closeHandler;
        if (cancelBtn) cancelBtn.onclick = closeHandler;
        if (saveBtn) saveBtn.onclick = () => this.saveApiRequestFromEditor(apiRequest, isNew);
        if (sendBtn) sendBtn.onclick = () => this.sendApiRequestFromEditor(modal);
        
        // ESCé”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                closeHandler();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // ä»ç¼–è¾‘å™¨ä¿å­˜è¯·æ±‚
    async saveApiRequestFromEditor(originalRequest, isNew) {
        const modal = document.body.querySelector('#pet-api-request-editor');
        if (!modal) {
            console.error('æ¥å£ç¼–è¾‘å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®
        const methodSelect = modal.querySelector('.api-editor-method-select');
        const urlInput = modal.querySelector('.api-editor-url-input');
        const titleInput = modal.querySelector('.api-editor-title-input');
        const descriptionInput = modal.querySelector('.api-editor-description-input');
        const headersContainer = modal.querySelector('.api-editor-headers-container');
        const bodyTypeSelect = modal.querySelector('.api-editor-body-type-select');
        const bodyTextarea = modal.querySelector('.api-editor-body-textarea');
        
        const method = methodSelect?.value || 'GET';
        const url = urlInput?.value.trim() || '';
        const title = titleInput?.value.trim() || '';
        const description = descriptionInput?.value.trim() || '';
        
        // éªŒè¯URL
        if (!url) {
            this.showNotification('è¯·æ±‚URLä¸èƒ½ä¸ºç©º', 'error');
            return;
        }
        
        // æ”¶é›†Headers
        const headers = {};
        if (headersContainer) {
            const rows = headersContainer.querySelectorAll('div[style*="display: flex"]');
            rows.forEach(row => {
                const keyInput = row.querySelector('input[placeholder="Headeråç§°"]');
                const valueInput = row.querySelector('input[placeholder="Headerå€¼"]');
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    if (key && value) {
                        headers[key] = value;
                    }
                }
            });
        }
        
        // æ”¶é›†Body
        let body = null;
        if (bodyTypeSelect && bodyTextarea) {
            const bodyType = bodyTypeSelect.value;
            const bodyText = bodyTextarea.value.trim();
            
            if (bodyType !== 'none' && bodyText) {
                if (bodyType === 'json') {
                    try {
                        body = JSON.parse(bodyText);
                    } catch (e) {
                        this.showNotification('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯·æ±‚ä½“', 'error');
                        return;
                    }
                } else {
                    body = bodyText;
                }
            }
        }
        
        try {
            // æ£€æŸ¥apiRequestApiæ˜¯å¦å¯ç”¨
            if (!this.apiRequestApi || !this.apiRequestApi.isEnabled()) {
                this.showNotification('APIç®¡ç†å™¨æœªå¯ç”¨ï¼Œæ— æ³•ä¿å­˜', 'error');
                return;
            }
            
            // å‡†å¤‡ä¿å­˜æ•°æ®
            const apiRequestData = {
                method: method,
                headers: headers,
                body: body,
                title: title || `${method} ${this._extractApiPath(url)}`,
                description: description || `æ¥å£è¯·æ±‚ï¼š${url}`,
                tags: originalRequest.tags || [],
                timestamp: Date.now()
            };
            
            // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œä½¿ç”¨requestUrlå­—æ®µï¼Œå¹¶ç”Ÿæˆå”¯ä¸€çš„pageUrl
            if (isNew) {
                apiRequestData.requestUrl = url;
                // æ–°å»ºæ¨¡å¼ï¼šç”Ÿæˆ blank-request:xxx æ ¼å¼çš„å”¯ä¸€pageUrl
                apiRequestData.pageUrl = this._generateBlankRequestId();
                // æ·»åŠ  url å­—æ®µï¼Œå’Œ pageUrl å†…å®¹ä¿æŒä¸€è‡´
                apiRequestData.url = apiRequestData.pageUrl;
            } else {
                // ç¼–è¾‘æ¨¡å¼ï¼Œä¿ç•™urlå­—æ®µä»¥å…¼å®¹æ—§æ•°æ®
                apiRequestData.url = url;
                if (originalRequest.key || originalRequest._id || originalRequest.id) {
                    apiRequestData.key = originalRequest.key || originalRequest._id || originalRequest.id;
                    apiRequestData.type = originalRequest.type || 'api';
                    // ç¼–è¾‘æ¨¡å¼ä¿ç•™pageUrl
                    apiRequestData.pageUrl = originalRequest.pageUrl || window.location.href;
                }
            }
            
            // æ ¹æ®å½“å‰ç¼–è¾‘å™¨å†…å®¹é‡æ–°ç”Ÿæˆ curl å‘½ä»¤ï¼Œç¡®ä¿ä¸æ–¹æ³•ä¸€è‡´
            apiRequestData.curl = this.generateCurlFromEditor(modal) || '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å“åº”æ•°æ®ï¼ˆä»å‘é€è¯·æ±‚åä¿å­˜çš„ï¼‰
            if (modal._responseData) {
                // ä¼˜å…ˆä½¿ç”¨æ–°çš„å“åº”æ•°æ®
                apiRequestData.status = modal._responseData.status || 0;
                apiRequestData.statusText = modal._responseData.statusText || '';
                apiRequestData.responseHeaders = modal._responseData.responseHeaders || {};
                apiRequestData.responseBody = modal._responseData.responseBody || null;
                apiRequestData.responseText = modal._responseData.responseText || '';
                apiRequestData.duration = modal._responseData.duration || 0;
                if (modal._responseData.error) {
                    apiRequestData.error = modal._responseData.error;
                }
            } else if (!isNew && (originalRequest.key || originalRequest._id || originalRequest.id)) {
                // å¦‚æœæ²¡æœ‰æ–°çš„å“åº”æ•°æ®ï¼Œä¸”æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¿ç•™åŸæœ‰å“åº”æ•°æ®
                apiRequestData.status = originalRequest.status || 0;
                apiRequestData.statusText = originalRequest.statusText || '';
                apiRequestData.responseHeaders = originalRequest.responseHeaders || {};
                apiRequestData.responseBody = originalRequest.responseBody || null;
                apiRequestData.responseText = originalRequest.responseText || '';
                apiRequestData.duration = originalRequest.duration || 0;
            }
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.showNotification('æ­£åœ¨ä¿å­˜...', 'info');
            
            // ä¿å­˜åˆ°åç«¯
            const result = await this.apiRequestApi.saveApiRequest(apiRequestData);
            
            if (result && result.success) {
                console.log('æ¥å£è¯·æ±‚å·²ä¿å­˜:', result.data);
                
                // åˆ·æ–°åˆ—è¡¨
                await this.updateApiRequestSidebar(true);
                
                // å…³é—­ç¼–è¾‘å™¨
                this.closeApiRequestEditor();
                
                this.showNotification(isNew ? 'æ–°å»ºæˆåŠŸ' : 'ä¿å­˜æˆåŠŸ', 'success');
            } else {
                throw new Error(result?.message || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜æ¥å£è¯·æ±‚å¤±è´¥:', error);
            this.showNotification(`ä¿å­˜å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        }
    }
    
    // å…³é—­æ¥å£ç¼–è¾‘å™¨
    closeApiRequestEditor() {
        const modal = document.body.querySelector('#pet-api-request-editor');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // ä»ç¼–è¾‘å™¨å‘é€è¯·æ±‚
    async sendApiRequestFromEditor(modal) {
        if (!modal) {
            modal = document.body.querySelector('#pet-api-request-editor');
        }
        if (!modal) {
            console.error('æ¥å£ç¼–è¾‘å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®
        const methodSelect = modal.querySelector('.api-editor-method-select');
        const urlInput = modal.querySelector('.api-editor-url-input');
        const headersContainer = modal.querySelector('.api-editor-headers-container');
        const bodyTypeSelect = modal.querySelector('.api-editor-body-type-select');
        const bodyTextarea = modal.querySelector('.api-editor-body-textarea');
        const responseTextarea = modal.querySelector('.api-editor-response-textarea');
        const sendBtn = modal.querySelector('.api-editor-send');
        
        const method = methodSelect?.value || 'GET';
        const url = urlInput?.value.trim() || '';
        
        // éªŒè¯URL
        if (!url) {
            this.showNotification('è¯·æ±‚URLä¸èƒ½ä¸ºç©º', 'error');
            return;
        }
        
        // æ”¶é›†Headers
        const headers = {};
        if (headersContainer) {
            const rows = headersContainer.querySelectorAll('div[style*="display: flex"]');
            rows.forEach(row => {
                const keyInput = row.querySelector('input[placeholder="Headeråç§°"]');
                const valueInput = row.querySelector('input[placeholder="Headerå€¼"]');
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    if (key && value) {
                        headers[key] = value;
                    }
                }
            });
        }
        
        // æ”¶é›†Body
        let body = null;
        if (bodyTypeSelect && bodyTextarea) {
            const bodyType = bodyTypeSelect.value;
            const bodyText = bodyTextarea.value.trim();
            
            if (bodyType !== 'none' && bodyText) {
                if (bodyType === 'json') {
                    try {
                        body = JSON.parse(bodyText);
                    } catch (e) {
                        this.showNotification('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯·æ±‚ä½“', 'error');
                        return;
                    }
                } else if (bodyType === 'x-www-form-urlencoded') {
                    // å¤„ç†è¡¨å•æ•°æ®
                    const formData = new URLSearchParams();
                    try {
                        const pairs = bodyText.split('&');
                        pairs.forEach(pair => {
                            const [key, value] = pair.split('=').map(s => decodeURIComponent(s));
                            if (key) formData.append(key, value || '');
                        });
                        body = formData.toString();
                    } catch (e) {
                        body = bodyText;
                    }
                } else {
                    body = bodyText;
                }
            }
        }
        
        // ç¦ç”¨å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (sendBtn) {
            sendBtn.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';
            sendBtn.style.opacity = '0.6';
            sendBtn.style.cursor = 'not-allowed';
        }
        
        // æ¸…ç©ºå“åº”ç»“æœ
        if (responseTextarea) {
            responseTextarea.value = 'æ­£åœ¨å‘é€è¯·æ±‚...';
        }
        
        const startTime = Date.now();
        
        try {
            // å‡†å¤‡è¯·æ±‚é€‰é¡¹
            const requestOptions = {
                method: method,
                headers: {
                    ...headers
                }
            };
            
            // å¦‚æœæœ‰bodyï¼Œæ·»åŠ åˆ°è¯·æ±‚é€‰é¡¹
            if (body) {
                if (bodyTypeSelect && bodyTypeSelect.value === 'json') {
                    requestOptions.body = JSON.stringify(body);
                    // åªæœ‰åœ¨æ²¡æœ‰è®¾ç½® Content-Type æ—¶æ‰è®¾ç½®é»˜è®¤å€¼
                    if (!requestOptions.headers['Content-Type'] && !requestOptions.headers['content-type']) {
                        requestOptions.headers['Content-Type'] = 'application/json';
                    }
                } else if (bodyTypeSelect && bodyTypeSelect.value === 'x-www-form-urlencoded') {
                    requestOptions.headers['Content-Type'] = 'application/x-www-form-urlencoded';
                    requestOptions.body = typeof body === 'string' ? body : JSON.stringify(body);
                } else {
                    requestOptions.body = typeof body === 'string' ? body : JSON.stringify(body);
                    // åªæœ‰åœ¨æ²¡æœ‰è®¾ç½® Content-Type æ—¶æ‰è®¾ç½®é»˜è®¤å€¼
                    if (!requestOptions.headers['Content-Type'] && !requestOptions.headers['content-type']) {
                        requestOptions.headers['Content-Type'] = 'application/json';
                    }
                }
            }
            
            // å‘é€è¯·æ±‚
            const response = await fetch(url, requestOptions);
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            // è·å–å“åº”å¤´
            const responseHeaders = {};
            response.headers.forEach((value, key) => {
                responseHeaders[key] = value;
            });
            
            // è·å–å“åº”ä½“
            let responseBody = null;
            let responseText = '';
            const contentType = response.headers.get('content-type') || '';
            
            try {
                if (contentType.includes('application/json')) {
                    responseBody = await response.json();
                    responseText = JSON.stringify(responseBody, null, 2);
                } else {
                    responseText = await response.text();
                }
            } catch (e) {
                responseText = '[æ— æ³•è¯»å–å“åº”å†…å®¹]';
            }
            
            // æ›´æ–°å“åº”ç»“æœæ˜¾ç¤º
            if (responseTextarea) {
                const statusColor = response.status >= 200 && response.status < 300 ? '#10b981' : 
                                   response.status >= 400 ? '#ef4444' : '#f59e0b';
                responseTextarea.value = `çŠ¶æ€: ${response.status} ${response.statusText || ''}\n` +
                                       `è€—æ—¶: ${duration}ms\n` +
                                       `å“åº”å¤´:\n${JSON.stringify(responseHeaders, null, 2)}\n\n` +
                                       `å“åº”ä½“:\n${responseText}`;
                responseTextarea.style.borderColor = statusColor;
            }
            
            // å°†å“åº”ç»“æœä¿å­˜åˆ°è¡¨å•æ•°æ®ä¸­ï¼ˆç”¨äºåç»­ä¿å­˜ï¼‰
            modal._responseData = {
                status: response.status,
                statusText: response.statusText,
                responseHeaders: responseHeaders,
                responseBody: responseBody,
                responseText: responseText,
                duration: duration
            };
            
            // å°†è¿”å›ç»“æœå†™å…¥é¡µé¢ä¸Šä¸‹æ–‡
            await this.addApiRequestResponseToContext(url, method, response, responseBody, responseText, duration);
            
            this.showNotification(`è¯·æ±‚æˆåŠŸ: ${response.status} ${response.statusText || ''}`, 'success');
        } catch (error) {
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            // æ›´æ–°å“åº”ç»“æœæ˜¾ç¤ºï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰
            if (responseTextarea) {
                responseTextarea.value = `é”™è¯¯: ${error.message || 'è¯·æ±‚å¤±è´¥'}\n` +
                                       `è€—æ—¶: ${duration}ms`;
                responseTextarea.style.borderColor = '#ef4444';
            }
            
            // å°†é”™è¯¯ä¿¡æ¯ä¿å­˜åˆ°è¡¨å•æ•°æ®ä¸­
            modal._responseData = {
                status: 0,
                statusText: 'Network Error',
                error: error.message || 'è¯·æ±‚å¤±è´¥',
                duration: duration
            };
            
            this.showNotification(`è¯·æ±‚å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        } finally {
            // æ¢å¤å‘é€æŒ‰é’®
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.textContent = 'ğŸš€ å‘é€è¯·æ±‚';
                sendBtn.style.opacity = '1';
                sendBtn.style.cursor = 'pointer';
            }
        }
    }
    
    // ä»è¯·æ±‚åˆ—è¡¨é¡¹å‘é€è¯·æ±‚
    async sendApiRequestFromItem(apiRequest) {
        // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
        const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
        if (!apiRequest || !requestUrl) {
            this.showNotification('è¯·æ±‚URLä¸èƒ½ä¸ºç©º', 'error');
            return;
        }
        
        const method = apiRequest.method || 'GET';
        const url = requestUrl.trim();
        const headers = apiRequest.headers || {};
        const body = apiRequest.body || null;
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        this.showNotification('æ­£åœ¨å‘é€è¯·æ±‚...', 'info');
        
        const startTime = Date.now();
        
        try {
            // å‡†å¤‡è¯·æ±‚é€‰é¡¹
            const requestOptions = {
                method: method,
                headers: {
                    ...headers
                }
            };
            
            // å¦‚æœæœ‰bodyï¼Œæ·»åŠ åˆ°è¯·æ±‚é€‰é¡¹
            if (body) {
                if (typeof body === 'string') {
                    try {
                        // å°è¯•è§£æä¸ºJSON
                        const parsed = JSON.parse(body);
                        requestOptions.body = JSON.stringify(parsed);
                        // åªæœ‰åœ¨æ²¡æœ‰è®¾ç½® Content-Type æ—¶æ‰è®¾ç½®é»˜è®¤å€¼
                        if (!requestOptions.headers['Content-Type'] && !requestOptions.headers['content-type']) {
                            requestOptions.headers['Content-Type'] = 'application/json';
                        }
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
                        requestOptions.body = body;
                        // åªæœ‰åœ¨æ²¡æœ‰è®¾ç½® Content-Type æ—¶æ‰è®¾ç½®é»˜è®¤å€¼
                        if (!requestOptions.headers['Content-Type'] && !requestOptions.headers['content-type']) {
                            requestOptions.headers['Content-Type'] = 'text/plain';
                        }
                    }
                } else {
                    requestOptions.body = JSON.stringify(body);
                    // åªæœ‰åœ¨æ²¡æœ‰è®¾ç½® Content-Type æ—¶æ‰è®¾ç½®é»˜è®¤å€¼
                    if (!requestOptions.headers['Content-Type'] && !requestOptions.headers['content-type']) {
                        requestOptions.headers['Content-Type'] = 'application/json';
                    }
                }
            }
            
            // å‘é€è¯·æ±‚
            const response = await fetch(url, requestOptions);
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            // è·å–å“åº”å¤´
            const responseHeaders = {};
            response.headers.forEach((value, key) => {
                responseHeaders[key] = value;
            });
            
            // è·å–å“åº”ä½“
            let responseBody = null;
            let responseText = '';
            const contentType = response.headers.get('content-type') || '';
            
            try {
                if (contentType.includes('application/json')) {
                    responseBody = await response.json();
                    responseText = JSON.stringify(responseBody, null, 2);
                } else {
                    responseText = await response.text();
                }
            } catch (e) {
                responseText = '[æ— æ³•è¯»å–å“åº”å†…å®¹]';
            }
            
            // å°†è¿”å›ç»“æœå†™å…¥é¡µé¢ä¸Šä¸‹æ–‡
            await this.addApiRequestResponseToContext(url, method, response, responseBody, responseText, duration);
            
            const statusColor = response.status >= 200 && response.status < 300 ? '#10b981' : 
                               response.status >= 400 ? '#ef4444' : '#f59e0b';
            
            this.showNotification(`è¯·æ±‚æˆåŠŸ: ${response.status} ${response.statusText || ''} (${duration}ms)`, 'success');
        } catch (error) {
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            this.showNotification(`è¯·æ±‚å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'} (${duration}ms)`, 'error');
            console.error('å‘é€è¯·æ±‚å¤±è´¥:', error);
        }
    }
    
    // å°†æ¥å£è¯·æ±‚å“åº”ç»“æœæ·»åŠ åˆ°é¡µé¢ä¸Šä¸‹æ–‡
    async addApiRequestResponseToContext(url, method, response, responseBody, responseText, duration) {
        if (!this.currentSessionId) {
            // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ï¼Œåˆå§‹åŒ–ä¼šè¯
            try {
                await this.initSessionWithDelay();
            } catch (e) {
                console.warn('åˆå§‹åŒ–ä¼šè¯å¤±è´¥ï¼Œå°†ç›´æ¥æ·»åŠ æ¶ˆæ¯:', e);
                return;
            }
        }
        
        // è·å–å½“å‰ä¼šè¯
        const session = this.sessions[this.currentSessionId];
        if (!session) {
            console.warn('å½“å‰ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•è¿½åŠ å“åº”å†…å®¹åˆ°é¡µé¢ä¸Šä¸‹æ–‡');
            return;
        }
        
        // æ„å»ºå“åº”å†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼‰
        const statusColor = response.status >= 200 && response.status < 300 ? '#10b981' : 
                           response.status >= 400 ? '#ef4444' : '#f59e0b';
        
        let responseContent = `\n\n## æ¥å£è¯·æ±‚å“åº”\n\n`;
        responseContent += `**è¯·æ±‚æ–¹æ³•:** ${method}\n`;
        responseContent += `**è¯·æ±‚URL:** ${url}\n`;
        responseContent += `**å“åº”çŠ¶æ€:** ${response.status} ${response.statusText || ''}\n`;
        responseContent += `**å“åº”æ—¶é—´:** ${duration}ms\n\n`;
        
        if (responseText) {
            // é™åˆ¶å“åº”å†…å®¹é•¿åº¦ï¼Œé¿å…è¿‡é•¿
            const maxLength = 5000;
            const displayText = responseText.length > maxLength ? responseText.substring(0, maxLength) + '\n...[å·²æˆªæ–­]' : responseText;
            responseContent += `**å“åº”å†…å®¹:**\n\`\`\`json\n${displayText}\n\`\`\`\n`;
        }
        
        // è¿½åŠ åˆ°ä¼šè¯çš„pageContentå­—æ®µ
        try {
            // å¦‚æœpageContentä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸ºç©ºå­—ç¬¦ä¸²
            if (!session.pageContent) {
                session.pageContent = '';
            }
            
            // è¿½åŠ å“åº”å†…å®¹åˆ°pageContent
            session.pageContent += responseContent;
            
            // æ›´æ–°ä¼šè¯çš„æ›´æ–°æ—¶é—´
            session.updatedAt = Date.now();
            
            // ä¿å­˜åˆ°åç«¯ï¼ˆåŒ…å«pageContentï¼‰
            await this.syncSessionToBackend(this.currentSessionId, true, true);
            
            console.log('æ¥å£è¯·æ±‚å“åº”å·²è¿½åŠ åˆ°ä¼šè¯é¡µé¢ä¸Šä¸‹æ–‡å¹¶ä¿å­˜åˆ°åç«¯');
        } catch (e) {
            console.warn('è¿½åŠ å“åº”å†…å®¹åˆ°é¡µé¢ä¸Šä¸‹æ–‡å¤±è´¥:', e);
        }
    }
    
    // ç¡®ä¿è¯·æ±‚æ¥å£ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†UIå­˜åœ¨ï¼ˆä¿ç•™æ—§ç‰ˆæœ¬ä»¥å…¼å®¹ï¼‰
    ensureApiRequestInfoEditorUi() {
        if (document.body.querySelector('#pet-api-request-info-editor')) return;
    }
    
    // ä»ç¼–è¾‘å™¨ä¿å­˜è¯·æ±‚
    async saveApiRequestFromEditor(originalRequest, isNew) {
        const modal = document.body.querySelector('#pet-api-request-editor');
        if (!modal) {
            console.error('æ¥å£ç¼–è¾‘å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®
        const methodSelect = modal.querySelector('.api-editor-method-select');
        const urlInput = modal.querySelector('.api-editor-url-input');
        const titleInput = modal.querySelector('.api-editor-title-input');
        const descriptionInput = modal.querySelector('.api-editor-description-input');
        const headersContainer = modal.querySelector('.api-editor-headers-container');
        const bodyTypeSelect = modal.querySelector('.api-editor-body-type-select');
        const bodyTextarea = modal.querySelector('.api-editor-body-textarea');
        
        const method = methodSelect?.value || 'GET';
        const url = urlInput?.value.trim() || '';
        const title = titleInput?.value.trim() || '';
        const description = descriptionInput?.value.trim() || '';
        
        // éªŒè¯URL
        if (!url) {
            this.showNotification('è¯·æ±‚URLä¸èƒ½ä¸ºç©º', 'error');
            return;
        }
        
        // æ”¶é›†Headers
        const headers = {};
        if (headersContainer) {
            const rows = headersContainer.querySelectorAll('div[style*="display: flex"]');
            rows.forEach(row => {
                const keyInput = row.querySelector('input[placeholder="Headeråç§°"]');
                const valueInput = row.querySelector('input[placeholder="Headerå€¼"]');
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    if (key && value) {
                        headers[key] = value;
                    }
                }
            });
        }
        
        // æ”¶é›†Body
        let body = null;
        if (bodyTypeSelect && bodyTextarea) {
            const bodyType = bodyTypeSelect.value;
            const bodyText = bodyTextarea.value.trim();
            
            if (bodyType !== 'none' && bodyText) {
                if (bodyType === 'json') {
                    try {
                        body = JSON.parse(bodyText);
                    } catch (e) {
                        this.showNotification('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯·æ±‚ä½“', 'error');
                        return;
                    }
                } else {
                    body = bodyText;
                }
            }
        }
        
        try {
            // æ£€æŸ¥apiRequestApiæ˜¯å¦å¯ç”¨
            if (!this.apiRequestApi || !this.apiRequestApi.isEnabled()) {
                this.showNotification('APIç®¡ç†å™¨æœªå¯ç”¨ï¼Œæ— æ³•ä¿å­˜', 'error');
                return;
            }
            
            // å‡†å¤‡ä¿å­˜æ•°æ®
            const apiRequestData = {
                method: method,
                headers: headers,
                body: body,
                title: title || `${method} ${this._extractApiPath(url)}`,
                description: description || `æ¥å£è¯·æ±‚ï¼š${url}`,
                tags: originalRequest.tags || [],
                timestamp: Date.now()
            };
            
            // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œä½¿ç”¨requestUrlå­—æ®µï¼Œå¹¶ç”Ÿæˆå”¯ä¸€çš„pageUrl
            if (isNew) {
                apiRequestData.requestUrl = url;
                // æ–°å»ºæ¨¡å¼ï¼šç”Ÿæˆ blank-request:xxx æ ¼å¼çš„å”¯ä¸€pageUrl
                apiRequestData.pageUrl = this._generateBlankRequestId();
                // æ·»åŠ  url å­—æ®µï¼Œå’Œ pageUrl å†…å®¹ä¿æŒä¸€è‡´
                apiRequestData.url = apiRequestData.pageUrl;
            } else {
                // ç¼–è¾‘æ¨¡å¼ï¼Œä¿ç•™urlå­—æ®µä»¥å…¼å®¹æ—§æ•°æ®
                apiRequestData.url = url;
                if (originalRequest.key || originalRequest._id || originalRequest.id) {
                    apiRequestData.key = originalRequest.key || originalRequest._id || originalRequest.id;
                    apiRequestData.type = originalRequest.type || 'api';
                    // ç¼–è¾‘æ¨¡å¼ä¿ç•™pageUrl
                    apiRequestData.pageUrl = originalRequest.pageUrl || window.location.href;
                }
            }
            
            // æ ¹æ®å½“å‰ç¼–è¾‘å™¨å†…å®¹é‡æ–°ç”Ÿæˆ curl å‘½ä»¤ï¼Œç¡®ä¿ä¸æ–¹æ³•ä¸€è‡´
            apiRequestData.curl = this.generateCurlFromEditor(modal) || '';
            
            // å¦‚æœmodalä¸­æœ‰å“åº”æ•°æ®ï¼ˆé€šè¿‡å‘é€è¯·æ±‚è·å¾—ï¼‰ï¼Œä½¿ç”¨å“åº”æ•°æ®
            if (modal._responseData) {
                apiRequestData.status = modal._responseData.status || 0;
                apiRequestData.statusText = modal._responseData.statusText || '';
                apiRequestData.responseHeaders = modal._responseData.responseHeaders || {};
                apiRequestData.responseBody = modal._responseData.responseBody || null;
                apiRequestData.responseText = modal._responseData.responseText || '';
                apiRequestData.duration = modal._responseData.duration || 0;
                if (modal._responseData.error) {
                    apiRequestData.error = modal._responseData.error;
                }
            } else if (!isNew && (originalRequest.key || originalRequest._id || originalRequest.id)) {
                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ä¸”æ²¡æœ‰æ–°çš„å“åº”æ•°æ®ï¼Œä¿ç•™åŸæœ‰æ•°æ®
                apiRequestData.status = originalRequest.status || 0;
                apiRequestData.statusText = originalRequest.statusText || '';
                apiRequestData.responseHeaders = originalRequest.responseHeaders || {};
                apiRequestData.responseBody = originalRequest.responseBody || null;
                apiRequestData.responseText = originalRequest.responseText || '';
                apiRequestData.duration = originalRequest.duration || 0;
            }
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.showNotification('æ­£åœ¨ä¿å­˜...', 'info');
            
            // ä¿å­˜åˆ°åç«¯
            const result = await this.apiRequestApi.saveApiRequest(apiRequestData);
            
            if (result && result.success) {
                console.log('æ¥å£è¯·æ±‚å·²ä¿å­˜:', result.data);
                
                // åˆ·æ–°åˆ—è¡¨
                await this.updateApiRequestSidebar(true);
                
                // å…³é—­ç¼–è¾‘å™¨
                this.closeApiRequestEditor();
                
                this.showNotification(isNew ? 'æ–°å»ºæˆåŠŸ' : 'ä¿å­˜æˆåŠŸ', 'success');
            } else {
                throw new Error(result?.message || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜æ¥å£è¯·æ±‚å¤±è´¥:', error);
            this.showNotification(`ä¿å­˜å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        }
    }
    
    // å…³é—­æ¥å£ç¼–è¾‘å™¨
    closeApiRequestEditor() {
        const modal = document.body.querySelector('#pet-api-request-editor');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // æ˜¾ç¤º curl å¯¼å…¥å¯¹è¯æ¡†
    showCurlImportDialog(parentModal) {
        // ç¡®ä¿å¯¹è¯æ¡†UIå­˜åœ¨
        this.ensureCurlImportDialogUi();
        
        const dialog = document.body.querySelector('#pet-curl-import-dialog');
        if (!dialog) {
            console.error('curl å¯¼å…¥å¯¹è¯æ¡†æœªæ‰¾åˆ°');
            return;
        }
        
        // ä¿å­˜çˆ¶æ¨¡æ€æ¡†å¼•ç”¨
        dialog.dataset.parentModal = parentModal ? 'true' : 'false';
        if (parentModal) {
            dialog._parentModal = parentModal;
        }
        
        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……å½“å‰çš„ curl å‘½ä»¤
        const textarea = dialog.querySelector('textarea');
        if (textarea && parentModal) {
            const currentCurl = this.generateCurlFromEditor(parentModal);
            if (currentCurl) {
                // å°† \\\n è½¬æ¢ä¸ºçœŸæ­£çš„æ¢è¡Œç¬¦ï¼Œä»¥ä¾¿åœ¨ textarea ä¸­æ­£ç¡®æ˜¾ç¤º
                textarea.value = currentCurl.replace(/\\\n/g, '\n');
            } else {
                textarea.value = '';
            }
        } else if (textarea) {
            textarea.value = '';
        }
        
        // æ˜¾ç¤ºå¯¹è¯æ¡†
        dialog.style.display = 'flex';
        
        // èšç„¦åˆ°è¾“å…¥æ¡†
        if (textarea) {
            setTimeout(() => {
                textarea.focus();
                if (textarea.value) {
                    textarea.select();
                }
            }, 100);
        }
    }
    
    // ç¡®ä¿ curl å¯¼å…¥å¯¹è¯æ¡†UIå­˜åœ¨
    ensureCurlImportDialogUi() {
        if (document.body.querySelector('#pet-curl-import-dialog')) return;
        
        // åˆ›å»ºå¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.id = 'pet-curl-import-dialog';
        dialog.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.6) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 2147483655 !important;
            padding: 20px !important;
            box-sizing: border-box !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) {
                dialog.style.display = 'none';
            }
        });
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            width: 100% !important;
            max-width: 1000px !important;
            max-height: 85vh !important;
            display: flex !important;
            flex-direction: column !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            overflow: hidden !important;
        `;
        
        // å¤´éƒ¨
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 20px 24px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ä» curl å¯¼å…¥';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #1f2937 !important;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #6b7280 !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#e5e7eb';
            closeBtn.style.color = '#1f2937';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#6b7280';
        });
        closeBtn.addEventListener('click', () => {
            dialog.style.display = 'none';
        });
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // å†…å®¹åŒºåŸŸ
        const content = document.createElement('div');
        content.style.cssText = `
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 24px !important;
        `;
        
        // æ ‡ç­¾å’Œæç¤ºä¿¡æ¯
        const labelContainer = document.createElement('div');
        labelContainer.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 8px !important;
        `;
        
        const label = document.createElement('label');
        label.textContent = 'ç²˜è´´ curl å‘½ä»¤';
        label.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #374151 !important;
        `;
        
        const hintText = document.createElement('span');
        hintText.textContent = 'æ”¯æŒ Ctrl+V / Cmd+V å¿«é€Ÿç²˜è´´';
        hintText.style.cssText = `
            font-size: 12px !important;
            color: #6b7280 !important;
            font-weight: normal !important;
        `;
        
        labelContainer.appendChild(label);
        labelContainer.appendChild(hintText);
        
        // è¾“å…¥æ¡†å®¹å™¨
        const textareaContainer = document.createElement('div');
        textareaContainer.style.cssText = `
            position: relative !important;
            margin-bottom: 12px !important;
        `;
        
        const textarea = document.createElement('textarea');
        textarea.placeholder = 'ä¾‹å¦‚ï¼šcurl -X POST https://api.example.com/users \\\n  -H "Content-Type: application/json" \\\n  -d \'{"name": "John"}\'';
        textarea.style.cssText = `
            width: 100% !important;
            min-height: 350px !important;
            padding: 12px 40px 12px 12px !important;
            border: 2px solid #d1d5db !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace !important;
            resize: vertical !important;
            box-sizing: border-box !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
            line-height: 1.6 !important;
        `;
        
        // æ·»åŠ èšç„¦æ•ˆæœ
        textarea.addEventListener('focus', () => {
            textarea.style.borderColor = '#3b82f6';
            textarea.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
        });
        textarea.addEventListener('blur', () => {
            textarea.style.borderColor = '#d1d5db';
            textarea.style.boxShadow = 'none';
        });
        
        // æ¸…ç©ºæŒ‰é’®
        const clearBtn = document.createElement('button');
        clearBtn.innerHTML = 'âœ•';
        clearBtn.title = 'æ¸…ç©º';
        clearBtn.style.cssText = `
            position: absolute !important;
            top: 8px !important;
            right: 8px !important;
            width: 24px !important;
            height: 24px !important;
            border: none !important;
            background: #f3f4f6 !important;
            color: #6b7280 !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            opacity: 0 !important;
            pointer-events: none !important;
        `;
        clearBtn.addEventListener('mouseenter', () => {
            clearBtn.style.background = '#ef4444';
            clearBtn.style.color = 'white';
        });
        clearBtn.addEventListener('mouseleave', () => {
            clearBtn.style.background = '#f3f4f6';
            clearBtn.style.color = '#6b7280';
        });
        clearBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            textarea.value = '';
            textarea.focus();
            errorMsg.style.display = 'none';
            updateClearButtonVisibility();
        });
        
        // æ›´æ–°æ¸…ç©ºæŒ‰é’®å¯è§æ€§
        const updateClearButtonVisibility = () => {
            if (textarea.value.trim()) {
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                clearBtn.style.opacity = '0';
                clearBtn.style.pointerEvents = 'none';
            }
        };
        
        textarea.addEventListener('input', updateClearButtonVisibility);
        textarea.addEventListener('paste', () => {
            setTimeout(updateClearButtonVisibility, 10);
        });
        
        textareaContainer.appendChild(textarea);
        textareaContainer.appendChild(clearBtn);
        
        // é”™è¯¯æ¶ˆæ¯
        const errorMsg = document.createElement('div');
        errorMsg.className = 'curl-import-error';
        errorMsg.style.cssText = `
            margin-top: 12px !important;
            padding: 12px 16px !important;
            background: #fee2e2 !important;
            color: #dc2626 !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            display: none !important;
            border-left: 4px solid #dc2626 !important;
            line-height: 1.5 !important;
        `;
        
        // æˆåŠŸæ¶ˆæ¯
        const successMsg = document.createElement('div');
        successMsg.className = 'curl-import-success';
        successMsg.style.cssText = `
            margin-top: 12px !important;
            padding: 12px 16px !important;
            background: #d1fae5 !important;
            color: #065f46 !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            display: none !important;
            border-left: 4px solid #10b981 !important;
            line-height: 1.5 !important;
        `;
        
        content.appendChild(labelContainer);
        content.appendChild(textareaContainer);
        content.appendChild(errorMsg);
        content.appendChild(successMsg);
        
        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 12px !important;
            padding: 20px 24px !important;
            border-top: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
        `;
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            background: white !important;
            color: #374151 !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f3f4f6';
            cancelBtn.style.borderColor = '#9ca3af';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'white';
            cancelBtn.style.borderColor = '#d1d5db';
        });
        cancelBtn.addEventListener('click', () => {
            dialog.style.display = 'none';
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
        });
        
        const importBtn = document.createElement('button');
        importBtn.innerHTML = '<span class="import-btn-text">å¯¼å…¥</span>';
        importBtn.style.cssText = `
            padding: 10px 24px !important;
            border: none !important;
            border-radius: 8px !important;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            color: white !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3) !important;
            position: relative !important;
            min-width: 80px !important;
        `;
        importBtn.addEventListener('mouseenter', () => {
            if (!importBtn.disabled) {
                importBtn.style.background = 'linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)';
                importBtn.style.transform = 'translateY(-1px)';
                importBtn.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.4)';
            }
        });
        importBtn.addEventListener('mouseleave', () => {
            if (!importBtn.disabled) {
                importBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                importBtn.style.transform = 'translateY(0)';
                importBtn.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.3)';
            }
        });
        
        // å¯¼å…¥å¤„ç†å‡½æ•°
        const handleImport = async () => {
            const curlCommand = textarea.value.trim();
            
            // éšè—ä¹‹å‰çš„æ¶ˆæ¯
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            if (!curlCommand) {
                errorMsg.textContent = 'âŒ è¯·è¾“å…¥ curl å‘½ä»¤';
                errorMsg.style.display = 'block';
                textarea.focus();
                return;
            }
            
            // è®¾ç½®åŠ è½½çŠ¶æ€
            importBtn.disabled = true;
            importBtn.style.opacity = '0.7';
            importBtn.style.cursor = 'wait';
            importBtn.querySelector('.import-btn-text').textContent = 'å¯¼å…¥ä¸­...';
            
            try {
                // è§£æ curl å‘½ä»¤
                const parseResult = this.parseCurlCommand(curlCommand);
                
                if (!parseResult) {
                    throw new Error('æ— æ³•è¯†åˆ« curl å‘½ä»¤æ ¼å¼ï¼Œè¯·ç¡®ä¿å‘½ä»¤ä»¥ "curl" å¼€å¤´');
                }
                
                if (!parseResult.url) {
                    throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ URLï¼Œè¯·æ£€æŸ¥ curl å‘½ä»¤æ˜¯å¦åŒ…å«å®Œæ•´çš„è¯·æ±‚åœ°å€');
                }
                
                // è·å–çˆ¶æ¨¡æ€æ¡†
                const parentModal = dialog._parentModal || document.body.querySelector('#pet-api-request-editor');
                
                if (!parentModal) {
                    throw new Error('æ— æ³•æ‰¾åˆ°æ¥å£ç¼–è¾‘å™¨');
                }
                
                // å¡«å……è¡¨å•
                this.fillApiRequestEditorFromCurl(parentModal, parseResult);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                successMsg.textContent = 'âœ… curl å‘½ä»¤å·²æˆåŠŸå¯¼å…¥ï¼';
                successMsg.style.display = 'block';
                
                // å»¶è¿Ÿå…³é—­å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                setTimeout(() => {
                    dialog.style.display = 'none';
                    errorMsg.style.display = 'none';
                    successMsg.style.display = 'none';
                }, 800);
                
            } catch (error) {
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                let errorText = 'âŒ è§£æå¤±è´¥';
                if (error.message) {
                    errorText += `: ${error.message}`;
                } else if (typeof error === 'string') {
                    errorText += `: ${error}`;
                }
                errorText += '\n\næç¤ºï¼šè¯·ç¡®ä¿ curl å‘½ä»¤æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å« URL å’Œå¿…è¦çš„å‚æ•°ã€‚';
                
                errorMsg.textContent = errorText;
                errorMsg.style.display = 'block';
                
                // æ»šåŠ¨åˆ°é”™è¯¯æ¶ˆæ¯
                errorMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                importBtn.disabled = false;
                importBtn.style.opacity = '1';
                importBtn.style.cursor = 'pointer';
                importBtn.querySelector('.import-btn-text').textContent = 'å¯¼å…¥';
            }
        };
        
        importBtn.addEventListener('click', handleImport);
        
        // æ”¯æŒ Enter + Ctrl/Cmd å¿«æ·é”®å¯¼å…¥
        textarea.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                handleImport();
            }
        });
        
        footer.appendChild(cancelBtn);
        footer.appendChild(importBtn);
        
        panel.appendChild(header);
        panel.appendChild(content);
        panel.appendChild(footer);
        dialog.appendChild(panel);
        document.body.appendChild(dialog);
        
        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                dialog.style.display = 'none';
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // ç¡®ä¿è¯·æ±‚æ¥å£ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†UIå­˜åœ¨ï¼ˆä¿ç•™æ—§ç‰ˆæœ¬ä»¥å…¼å®¹ï¼‰
    ensureApiRequestInfoEditorUi() {
        if (document.body.querySelector('#pet-api-request-info-editor')) return;
        
        // åˆ›å»ºå¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.id = 'pet-api-request-info-editor';
        dialog.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.6) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 2147483654 !important;
            padding: 20px !important;
            box-sizing: border-box !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) {
                dialog.style.display = 'none';
            }
        });
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            width: 100% !important;
            max-width: 700px !important;
            max-height: 80vh !important;
            display: flex !important;
            flex-direction: column !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            overflow: hidden !important;
        `;
        
        // å¤´éƒ¨
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 20px 24px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ä» curl å¯¼å…¥';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #1f2937 !important;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #6b7280 !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#e5e7eb';
            closeBtn.style.color = '#1f2937';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#6b7280';
        });
        closeBtn.addEventListener('click', () => {
            dialog.style.display = 'none';
        });
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // å†…å®¹åŒºåŸŸ
        const content = document.createElement('div');
        content.style.cssText = `
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 24px !important;
        `;
        
        // æ ‡ç­¾å’Œæç¤ºä¿¡æ¯
        const labelContainer = document.createElement('div');
        labelContainer.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 8px !important;
        `;
        
        const label = document.createElement('label');
        label.textContent = 'ç²˜è´´ curl å‘½ä»¤';
        label.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #374151 !important;
        `;
        
        const hintText = document.createElement('span');
        hintText.textContent = 'æ”¯æŒ Ctrl+V / Cmd+V å¿«é€Ÿç²˜è´´';
        hintText.style.cssText = `
            font-size: 12px !important;
            color: #6b7280 !important;
            font-weight: normal !important;
        `;
        
        labelContainer.appendChild(label);
        labelContainer.appendChild(hintText);
        
        // è¾“å…¥æ¡†å®¹å™¨
        const textareaContainer = document.createElement('div');
        textareaContainer.style.cssText = `
            position: relative !important;
            margin-bottom: 12px !important;
        `;
        
        textarea = document.createElement('textarea');
        textarea.placeholder = 'ä¾‹å¦‚ï¼šcurl -X POST https://api.example.com/users \\\n  -H "Content-Type: application/json" \\\n  -d \'{"name": "John"}\'';
        textarea.style.cssText = `
            width: 100% !important;
            min-height: 220px !important;
            padding: 12px 40px 12px 12px !important;
            border: 2px solid #d1d5db !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace !important;
            resize: vertical !important;
            box-sizing: border-box !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
            line-height: 1.6 !important;
        `;
        
        // æ·»åŠ èšç„¦æ•ˆæœ
        textarea.addEventListener('focus', () => {
            textarea.style.borderColor = '#3b82f6';
            textarea.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
        });
        textarea.addEventListener('blur', () => {
            textarea.style.borderColor = '#d1d5db';
            textarea.style.boxShadow = 'none';
        });
        
        // æ¸…ç©ºæŒ‰é’®
        const clearBtn = document.createElement('button');
        clearBtn.innerHTML = 'âœ•';
        clearBtn.title = 'æ¸…ç©º';
        clearBtn.style.cssText = `
            position: absolute !important;
            top: 8px !important;
            right: 8px !important;
            width: 24px !important;
            height: 24px !important;
            border: none !important;
            background: #f3f4f6 !important;
            color: #6b7280 !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            opacity: 0 !important;
            pointer-events: none !important;
        `;
        clearBtn.addEventListener('mouseenter', () => {
            clearBtn.style.background = '#ef4444';
            clearBtn.style.color = 'white';
        });
        clearBtn.addEventListener('mouseleave', () => {
            clearBtn.style.background = '#f3f4f6';
            clearBtn.style.color = '#6b7280';
        });
        clearBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            textarea.value = '';
            textarea.focus();
            errorMsg.style.display = 'none';
            updateClearButtonVisibility();
        });
        
        // æ›´æ–°æ¸…ç©ºæŒ‰é’®å¯è§æ€§
        const updateClearButtonVisibility = () => {
            if (textarea.value.trim()) {
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                clearBtn.style.opacity = '0';
                clearBtn.style.pointerEvents = 'none';
            }
        };
        
        textarea.addEventListener('input', updateClearButtonVisibility);
        textarea.addEventListener('paste', () => {
            setTimeout(updateClearButtonVisibility, 10);
        });
        
        textareaContainer.appendChild(textarea);
        textareaContainer.appendChild(clearBtn);
        
        // é”™è¯¯æ¶ˆæ¯
        const errorMsg = document.createElement('div');
        errorMsg.className = 'curl-import-error';
        errorMsg.style.cssText = `
            margin-top: 12px !important;
            padding: 12px 16px !important;
            background: #fee2e2 !important;
            color: #dc2626 !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            display: none !important;
            border-left: 4px solid #dc2626 !important;
            line-height: 1.5 !important;
        `;
        
        // æˆåŠŸæ¶ˆæ¯
        const successMsg = document.createElement('div');
        successMsg.className = 'curl-import-success';
        successMsg.style.cssText = `
            margin-top: 12px !important;
            padding: 12px 16px !important;
            background: #d1fae5 !important;
            color: #065f46 !important;
            border-radius: 8px !important;
            font-size: 13px !important;
            display: none !important;
            border-left: 4px solid #10b981 !important;
            line-height: 1.5 !important;
        `;
        
        content.appendChild(labelContainer);
        content.appendChild(textareaContainer);
        content.appendChild(errorMsg);
        content.appendChild(successMsg);
        
        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……å½“å‰çš„ curl å‘½ä»¤
        if (parentModal) {
            const currentCurl = this.generateCurlFromEditor(parentModal);
            if (currentCurl) {
                // å°† \\\n è½¬æ¢ä¸ºçœŸæ­£çš„æ¢è¡Œç¬¦ï¼Œä»¥ä¾¿åœ¨ textarea ä¸­æ­£ç¡®æ˜¾ç¤º
                textarea.value = currentCurl.replace(/\\\n/g, '\n');
            }
        }
        
        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 12px !important;
            padding: 20px 24px !important;
            border-top: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
        `;
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            background: white !important;
            color: #374151 !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f3f4f6';
            cancelBtn.style.borderColor = '#9ca3af';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'white';
            cancelBtn.style.borderColor = '#d1d5db';
        });
        cancelBtn.addEventListener('click', () => {
            dialog.style.display = 'none';
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
        });
        
        const importBtn = document.createElement('button');
        importBtn.innerHTML = '<span class="import-btn-text">å¯¼å…¥</span>';
        importBtn.style.cssText = `
            padding: 10px 24px !important;
            border: none !important;
            border-radius: 8px !important;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            color: white !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3) !important;
            position: relative !important;
            min-width: 80px !important;
        `;
        importBtn.addEventListener('mouseenter', () => {
            if (!importBtn.disabled) {
                importBtn.style.background = 'linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)';
                importBtn.style.transform = 'translateY(-1px)';
                importBtn.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.4)';
            }
        });
        importBtn.addEventListener('mouseleave', () => {
            if (!importBtn.disabled) {
                importBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                importBtn.style.transform = 'translateY(0)';
                importBtn.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.3)';
            }
        });
        
        // å¯¼å…¥å¤„ç†å‡½æ•°
        const handleImport = async () => {
            const curlCommand = textarea.value.trim();
            
            // éšè—ä¹‹å‰çš„æ¶ˆæ¯
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            if (!curlCommand) {
                errorMsg.textContent = 'âŒ è¯·è¾“å…¥ curl å‘½ä»¤';
                errorMsg.style.display = 'block';
                textarea.focus();
                return;
            }
            
            // è®¾ç½®åŠ è½½çŠ¶æ€
            importBtn.disabled = true;
            importBtn.style.opacity = '0.7';
            importBtn.style.cursor = 'wait';
            importBtn.querySelector('.import-btn-text').textContent = 'å¯¼å…¥ä¸­...';
            
            try {
                // è§£æ curl å‘½ä»¤
                const parseResult = this.parseCurlCommand(curlCommand);
                
                if (!parseResult) {
                    throw new Error('æ— æ³•è¯†åˆ« curl å‘½ä»¤æ ¼å¼ï¼Œè¯·ç¡®ä¿å‘½ä»¤ä»¥ "curl" å¼€å¤´');
                }
                
                if (!parseResult.url) {
                    throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ URLï¼Œè¯·æ£€æŸ¥ curl å‘½ä»¤æ˜¯å¦åŒ…å«å®Œæ•´çš„è¯·æ±‚åœ°å€');
                }
                
                // å¡«å……è¡¨å•
                this.fillApiRequestEditorFromCurl(parentModal, parseResult);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                successMsg.textContent = 'âœ… curl å‘½ä»¤å·²æˆåŠŸå¯¼å…¥ï¼';
                successMsg.style.display = 'block';
                
                // å»¶è¿Ÿå…³é—­å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                setTimeout(() => {
                    dialog.style.display = 'none';
                    errorMsg.style.display = 'none';
                    successMsg.style.display = 'none';
                }, 800);
                
            } catch (error) {
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                let errorText = 'âŒ è§£æå¤±è´¥';
                if (error.message) {
                    errorText += `: ${error.message}`;
                } else if (typeof error === 'string') {
                    errorText += `: ${error}`;
                }
                errorText += '\n\næç¤ºï¼šè¯·ç¡®ä¿ curl å‘½ä»¤æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å« URL å’Œå¿…è¦çš„å‚æ•°ã€‚';
                
                errorMsg.textContent = errorText;
                errorMsg.style.display = 'block';
                
                // æ»šåŠ¨åˆ°é”™è¯¯æ¶ˆæ¯
                errorMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                importBtn.disabled = false;
                importBtn.style.opacity = '1';
                importBtn.style.cursor = 'pointer';
                importBtn.querySelector('.import-btn-text').textContent = 'å¯¼å…¥';
            }
        };
        
        importBtn.addEventListener('click', handleImport);
        
        // æ”¯æŒ Enter + Ctrl/Cmd å¿«æ·é”®å¯¼å…¥
        textarea.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                handleImport();
            }
        });
        
        footer.appendChild(cancelBtn);
        footer.appendChild(importBtn);
        
        panel.appendChild(header);
        panel.appendChild(content);
        panel.appendChild(footer);
        dialog.appendChild(panel);
        document.body.appendChild(dialog);
        
        // èšç„¦åˆ°è¾“å…¥æ¡†å¹¶é€‰ä¸­æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
        setTimeout(() => {
            textarea.focus();
            if (textarea.value) {
                textarea.select();
            }
        }, 100);
        
        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                dialog.style.display = 'none';
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
    }
    
    // è§£æ curl å‘½ä»¤
    parseCurlCommand(curlCommand) {
        if (!curlCommand || typeof curlCommand !== 'string') {
            throw new Error('curl å‘½ä»¤ä¸èƒ½ä¸ºç©º');
        }
        
        // è§„èŒƒåŒ– curl å‘½ä»¤ï¼šå¤„ç†å¤šè¡Œæ ¼å¼ï¼ˆåæ–œæ æ¢è¡Œï¼‰
        curlCommand = curlCommand.trim();
        
        if (!curlCommand) {
            throw new Error('curl å‘½ä»¤ä¸èƒ½ä¸ºç©º');
        }
        
        // ç§»é™¤è¡Œå°¾çš„åæ–œæ å’Œæ¢è¡Œç¬¦ï¼Œåˆå¹¶å¤šè¡Œ
        // å…ˆå¤„ç†å¸¦åæ–œæ çš„æ¢è¡Œï¼ˆæ ‡å‡† curl æ ¼å¼ï¼‰
        curlCommand = curlCommand.replace(/\\\s*\n\s*/g, ' ').replace(/\\\s*\r\n\s*/g, ' ');
        // å†å¤„ç†ä¸å¸¦åæ–œæ çš„æ¢è¡Œï¼ˆä» textarea ä¸­ç›´æ¥ç²˜è´´çš„å¤šè¡Œæ ¼å¼ï¼‰
        curlCommand = curlCommand.replace(/\n\s*/g, ' ').replace(/\r\n\s*/g, ' ');
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ curl å‘½ä»¤
        const lowerCommand = curlCommand.toLowerCase();
        if (!lowerCommand.startsWith('curl')) {
            throw new Error('å‘½ä»¤å¿…é¡»ä»¥ "curl" å¼€å¤´');
        }
        
        const result = {
            method: 'GET',
            url: '',
            headers: {},
            body: null
        };
        
        // ç§»é™¤ 'curl' å‰ç¼€
        let command = curlCommand.substring(4).trim();
        
        // è§£æå‚æ•°ï¼ˆæ”¹è¿›ç‰ˆï¼šæ›´å¥½åœ°å¤„ç†å¼•å·å’Œç©ºæ ¼ï¼‰
        const parts = [];
        let currentPart = '';
        let inQuotes = false;
        let quoteChar = null;
        
        for (let i = 0; i < command.length; i++) {
            const char = command[i];
            const prevChar = i > 0 ? command[i - 1] : null;
            
            // å¤„ç†å¼•å·ï¼ˆæ”¯æŒå•å¼•å·å’ŒåŒå¼•å·ï¼‰
            if ((char === '"' || char === "'") && prevChar !== '\\') {
                if (!inQuotes) {
                    inQuotes = true;
                    quoteChar = char;
                    currentPart += char;
                } else if (char === quoteChar) {
                    inQuotes = false;
                    quoteChar = null;
                    currentPart += char;
                } else {
                    currentPart += char;
                }
            } else if (char === ' ' && !inQuotes) {
                // ç©ºæ ¼åˆ†éš”å‚æ•°
                if (currentPart.trim()) {
                    parts.push(currentPart.trim());
                    currentPart = '';
                }
            } else {
                currentPart += char;
            }
        }
        
        // æ·»åŠ æœ€åä¸€ä¸ªéƒ¨åˆ†
        if (currentPart.trim()) {
            parts.push(currentPart.trim());
        }
        
        // è§£æå„ä¸ªéƒ¨åˆ†
        let i = 0;
        while (i < parts.length) {
            const part = parts[i];
            
            // è§£ææ–¹æ³• (-X æˆ– --request)
            if ((part === '-X' || part === '--request') && i + 1 < parts.length) {
                result.method = parts[i + 1].toUpperCase();
                i += 2;
                continue;
            }
            
            // è§£æ Header (-H æˆ– --header)
            if ((part === '-H' || part === '--header') && i + 1 < parts.length) {
                let headerStr = parts[i + 1];
                // ç§»é™¤å¼•å·
                headerStr = headerStr.replace(/^["']|["']$/g, '');
                // å¤„ç†è½¬ä¹‰å­—ç¬¦
                headerStr = headerStr.replace(/\\'/g, "'").replace(/\\"/g, '"');
                
                const colonIndex = headerStr.indexOf(':');
                if (colonIndex > 0) {
                    const key = headerStr.substring(0, colonIndex).trim();
                    const value = headerStr.substring(colonIndex + 1).trim();
                    if (key && value) {
                        result.headers[key] = value;
                    }
                }
                i += 2;
                continue;
            }
            
            // è§£æ Body (-d æˆ– --data æˆ– --data-raw æˆ– --data-binary)
            if ((part === '-d' || part === '--data' || part === '--data-raw' || part === '--data-binary' || part === '--data-ascii') && i + 1 < parts.length) {
                let bodyStr = parts[i + 1];
                // ç§»é™¤å¼•å·
                bodyStr = bodyStr.replace(/^["']|["']$/g, '');
                // å¤„ç†è½¬ä¹‰å­—ç¬¦
                bodyStr = bodyStr.replace(/\\'/g, "'").replace(/\\"/g, '"').replace(/\\n/g, '\n').replace(/\\t/g, '\t');
                
                // å°è¯•è§£æä¸º JSON
                try {
                    result.body = JSON.parse(bodyStr);
                } catch {
                    result.body = bodyStr;
                }
                i += 2;
                continue;
            }
            
            // è§£æ URL (--url)
            if (part === '--url' && i + 1 < parts.length) {
                result.url = parts[i + 1].replace(/^["']|["']$/g, '');
                i += 2;
                continue;
            }
            
            // è§£æè®¤è¯ (-u æˆ– --user)
            if ((part === '-u' || part === '--user') && i + 1 < parts.length) {
                const authStr = parts[i + 1].replace(/^["']|["']$/g, '');
                // Basic è®¤è¯ï¼šusername:password
                if (authStr.includes(':')) {
                    const [username, password] = authStr.split(':');
                    const credentials = btoa(`${username}:${password}`);
                    result.headers['Authorization'] = `Basic ${credentials}`;
                }
                i += 2;
                continue;
            }
            
            // è§£æ URLï¼ˆæ²¡æœ‰å‰ç¼€çš„å‚æ•°ï¼Œé€šå¸¸æ˜¯æœ€åä¸€ä¸ªï¼Œä¸”çœ‹èµ·æ¥åƒ URLï¼‰
            if (!part.startsWith('-') && !part.startsWith('--')) {
                const cleanPart = part.replace(/^["']|["']$/g, '');
                // æ£€æŸ¥æ˜¯å¦æ˜¯ URL
                if (cleanPart.startsWith('http://') || cleanPart.startsWith('https://')) {
                    result.url = cleanPart;
                } else if (!result.url && i === parts.length - 1) {
                    // å¦‚æœæ˜¯æœ€åä¸€ä¸ªå‚æ•°ä¸”è¿˜æ²¡æœ‰ URLï¼Œå‡è®¾å®ƒæ˜¯ URL
                    result.url = cleanPart;
                }
                i++;
                continue;
            }
            
            i++;
        }
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ° URLï¼Œå°è¯•ä»å‘½ä»¤ä¸­æå–
        if (!result.url) {
            // æŸ¥æ‰¾æœ€åä¸€ä¸ªçœ‹èµ·æ¥åƒ URL çš„éƒ¨åˆ†
            for (let j = parts.length - 1; j >= 0; j--) {
                const part = parts[j];
                const cleanPart = part.replace(/^["']|["']$/g, '');
                if (cleanPart.startsWith('http://') || cleanPart.startsWith('https://')) {
                    result.url = cleanPart;
                    break;
                }
            }
        }
        
        if (!result.url) {
            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ URLã€‚è¯·ç¡®ä¿ curl å‘½ä»¤åŒ…å«å®Œæ•´çš„è¯·æ±‚åœ°å€ï¼ˆä»¥ http:// æˆ– https:// å¼€å¤´ï¼‰');
        }
        
        // éªŒè¯ URL æ ¼å¼
        try {
            new URL(result.url);
        } catch (e) {
            throw new Error(`URL æ ¼å¼æ— æ•ˆ: ${result.url}`);
        }
        
        return result;
    }
    
    // ä» curl è§£æç»“æœå¡«å……ç¼–è¾‘å™¨
    fillApiRequestEditorFromCurl(modal, parsed) {
        const methodSelect = modal.querySelector('.api-editor-method-select');
        const urlInput = modal.querySelector('.api-editor-url-input');
        const headersContainer = modal.querySelector('.api-editor-headers-container');
        const bodyTypeSelect = modal.querySelector('.api-editor-body-type-select');
        const bodyTextarea = modal.querySelector('.api-editor-body-textarea');
        
        // å¡«å……æ–¹æ³•ï¼ˆæ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœï¼‰
        if (methodSelect && parsed.method) {
            methodSelect.style.transition = 'all 0.3s ease';
            methodSelect.value = parsed.method;
            // æ·»åŠ é«˜äº®æ•ˆæœ
            methodSelect.style.background = '#dbeafe';
            setTimeout(() => {
                methodSelect.style.background = 'white';
            }, 500);
        }
        
        // å¡«å…… URLï¼ˆæ·»åŠ é«˜äº®æ•ˆæœï¼‰
        if (urlInput && parsed.url) {
            urlInput.value = parsed.url;
            urlInput.style.transition = 'all 0.3s ease';
            urlInput.style.background = '#dbeafe';
            setTimeout(() => {
                urlInput.style.background = 'white';
            }, 500);
        }
        
        // å¡«å…… Headersï¼ˆæ·»åŠ åŠ¨ç”»æ•ˆæœï¼‰
        if (headersContainer && parsed.headers) {
            headersContainer.style.transition = 'all 0.3s ease';
            headersContainer.style.background = '#dbeafe';
            this.populateHeadersEditor(headersContainer, parsed.headers);
            setTimeout(() => {
                headersContainer.style.background = '#f9fafb';
            }, 500);
        }
        
        // å¡«å…… Bodyï¼ˆæ·»åŠ åŠ¨ç”»æ•ˆæœï¼‰
        if (bodyTypeSelect && bodyTextarea && parsed.body !== null && parsed.body !== undefined) {
            const bodyType = this.detectBodyType(parsed.body);
            bodyTypeSelect.value = bodyType;
            this.updateBodyEditor(bodyTypeSelect, bodyTextarea, parsed.body);
            
            // æ·»åŠ é«˜äº®æ•ˆæœ
            bodyTextarea.style.transition = 'all 0.3s ease';
            bodyTextarea.style.background = '#dbeafe';
            setTimeout(() => {
                bodyTextarea.style.background = 'white';
            }, 500);
        }
        
        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥ï¼ˆä½¿ç”¨æ›´å‹å¥½çš„æ¶ˆæ¯ï¼‰
        const importedFields = [];
        if (parsed.method) importedFields.push('è¯·æ±‚æ–¹æ³•');
        if (parsed.url) importedFields.push('URL');
        if (parsed.headers && Object.keys(parsed.headers).length > 0) importedFields.push('è¯·æ±‚å¤´');
        if (parsed.body !== null && parsed.body !== undefined) importedFields.push('è¯·æ±‚ä½“');
        
        const message = `curl å‘½ä»¤å·²æˆåŠŸå¯¼å…¥ï¼å·²å¡«å……ï¼š${importedFields.join('ã€')}`;
        this.showNotification(message, 'success');
    }
    
    // ä»ç¼–è¾‘å™¨ä¿å­˜è¯·æ±‚
    async saveApiRequestFromEditor(originalRequest, isNew) {
        const modal = document.body.querySelector('#pet-api-request-editor');
        if (!modal) {
            console.error('æ¥å£ç¼–è¾‘å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®
        const methodSelect = modal.querySelector('.api-editor-method-select');
        const urlInput = modal.querySelector('.api-editor-url-input');
        const titleInput = modal.querySelector('.api-editor-title-input');
        const descriptionInput = modal.querySelector('.api-editor-description-input');
        const headersContainer = modal.querySelector('.api-editor-headers-container');
        const bodyTypeSelect = modal.querySelector('.api-editor-body-type-select');
        const bodyTextarea = modal.querySelector('.api-editor-body-textarea');
        
        const method = methodSelect?.value || 'GET';
        const url = urlInput?.value.trim() || '';
        const title = titleInput?.value.trim() || '';
        const description = descriptionInput?.value.trim() || '';
        
        // éªŒè¯URL
        if (!url) {
            this.showNotification('è¯·æ±‚URLä¸èƒ½ä¸ºç©º', 'error');
            return;
        }
        
        // æ”¶é›†Headers
        const headers = {};
        if (headersContainer) {
            const rows = headersContainer.querySelectorAll('div[style*="display: flex"]');
            rows.forEach(row => {
                const keyInput = row.querySelector('input[placeholder="Headeråç§°"]');
                const valueInput = row.querySelector('input[placeholder="Headerå€¼"]');
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    if (key && value) {
                        headers[key] = value;
                    }
                }
            });
        }
        
        // æ”¶é›†Body
        let body = null;
        if (bodyTypeSelect && bodyTextarea) {
            const bodyType = bodyTypeSelect.value;
            const bodyText = bodyTextarea.value.trim();
            
            if (bodyType !== 'none' && bodyText) {
                if (bodyType === 'json') {
                    try {
                        body = JSON.parse(bodyText);
                    } catch (e) {
                        this.showNotification('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯·æ±‚ä½“', 'error');
                        return;
                    }
                } else {
                    body = bodyText;
                }
            }
        }
        
        try {
            // æ£€æŸ¥apiRequestApiæ˜¯å¦å¯ç”¨
            if (!this.apiRequestApi || !this.apiRequestApi.isEnabled()) {
                this.showNotification('APIç®¡ç†å™¨æœªå¯ç”¨ï¼Œæ— æ³•ä¿å­˜', 'error');
                return;
            }
            
            // å‡†å¤‡ä¿å­˜æ•°æ®
            const apiRequestData = {
                method: method,
                headers: headers,
                body: body,
                title: title || `${method} ${this._extractApiPath(url)}`,
                description: description || `æ¥å£è¯·æ±‚ï¼š${url}`,
                tags: originalRequest.tags || [],
                timestamp: Date.now()
            };
            
            // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œä½¿ç”¨requestUrlå­—æ®µï¼Œå¹¶ç”Ÿæˆå”¯ä¸€çš„pageUrl
            if (isNew) {
                apiRequestData.requestUrl = url;
                // æ–°å»ºæ¨¡å¼ï¼šç”Ÿæˆ blank-request:xxx æ ¼å¼çš„å”¯ä¸€pageUrl
                apiRequestData.pageUrl = this._generateBlankRequestId();
                // æ·»åŠ  url å­—æ®µï¼Œå’Œ pageUrl å†…å®¹ä¿æŒä¸€è‡´
                apiRequestData.url = apiRequestData.pageUrl;
            } else {
                // ç¼–è¾‘æ¨¡å¼ï¼Œä¿ç•™urlå­—æ®µä»¥å…¼å®¹æ—§æ•°æ®
                apiRequestData.url = url;
                if (originalRequest.key || originalRequest._id || originalRequest.id) {
                    apiRequestData.key = originalRequest.key || originalRequest._id || originalRequest.id;
                    apiRequestData.type = originalRequest.type || 'api';
                    // ç¼–è¾‘æ¨¡å¼ä¿ç•™pageUrl
                    apiRequestData.pageUrl = originalRequest.pageUrl || window.location.href;
                }
            }
            
            // æ ¹æ®å½“å‰ç¼–è¾‘å™¨å†…å®¹é‡æ–°ç”Ÿæˆ curl å‘½ä»¤ï¼Œç¡®ä¿ä¸æ–¹æ³•ä¸€è‡´
            apiRequestData.curl = this.generateCurlFromEditor(modal) || '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å“åº”æ•°æ®ï¼ˆä»å‘é€è¯·æ±‚åä¿å­˜çš„ï¼‰
            if (modal._responseData) {
                // ä¼˜å…ˆä½¿ç”¨æ–°çš„å“åº”æ•°æ®
                apiRequestData.status = modal._responseData.status || 0;
                apiRequestData.statusText = modal._responseData.statusText || '';
                apiRequestData.responseHeaders = modal._responseData.responseHeaders || {};
                apiRequestData.responseBody = modal._responseData.responseBody || null;
                apiRequestData.responseText = modal._responseData.responseText || '';
                apiRequestData.duration = modal._responseData.duration || 0;
                if (modal._responseData.error) {
                    apiRequestData.error = modal._responseData.error;
                }
            } else if (!isNew && (originalRequest.key || originalRequest._id || originalRequest.id)) {
                // å¦‚æœæ²¡æœ‰æ–°çš„å“åº”æ•°æ®ï¼Œä¸”æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¿ç•™åŸæœ‰å“åº”æ•°æ®
                apiRequestData.status = originalRequest.status || 0;
                apiRequestData.statusText = originalRequest.statusText || '';
                apiRequestData.responseHeaders = originalRequest.responseHeaders || {};
                apiRequestData.responseBody = originalRequest.responseBody || null;
                apiRequestData.responseText = originalRequest.responseText || '';
                apiRequestData.duration = originalRequest.duration || 0;
            }
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.showNotification('æ­£åœ¨ä¿å­˜...', 'info');
            
            // ä¿å­˜åˆ°åç«¯
            const result = await this.apiRequestApi.saveApiRequest(apiRequestData);
            
            if (result && result.success) {
                console.log('æ¥å£è¯·æ±‚å·²ä¿å­˜:', result.data);
                
                // åˆ·æ–°åˆ—è¡¨
                await this.updateApiRequestSidebar(true);
                
                // å…³é—­ç¼–è¾‘å™¨
                this.closeApiRequestEditor();
                
                this.showNotification(isNew ? 'æ–°å»ºæˆåŠŸ' : 'ä¿å­˜æˆåŠŸ', 'success');
            } else {
                throw new Error(result?.message || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜æ¥å£è¯·æ±‚å¤±è´¥:', error);
            this.showNotification(`ä¿å­˜å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        }
    }
    
    // å…³é—­æ¥å£ç¼–è¾‘å™¨
    closeApiRequestEditor() {
        const modal = document.body.querySelector('#pet-api-request-editor');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // ç¡®ä¿è¯·æ±‚æ¥å£ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†UIå­˜åœ¨ï¼ˆä¿ç•™æ—§ç‰ˆæœ¬ä»¥å…¼å®¹ï¼‰
    ensureApiRequestInfoEditorUi() {
        if (document.body.querySelector('#pet-api-request-info-editor')) return;
        
        const modal = document.createElement('div');
        modal.id = 'pet-api-request-info-editor';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 2147483653 !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeApiRequestInfoEditor();
            }
        });
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 32px !important;
            width: 90% !important;
            max-width: 700px !important;
            max-height: 85vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
            position: relative !important;
            z-index: 2147483654 !important;
        `;
        
        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 24px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ç¼–è¾‘è¯·æ±‚æ¥å£ä¿¡æ¯';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 20px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'api-request-editor-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // æ ‡é¢˜è¾“å…¥åŒºåŸŸ
        const titleGroup = document.createElement('div');
        titleGroup.style.cssText = `
            margin-bottom: 24px !important;
        `;
        
        const titleLabel = document.createElement('label');
        titleLabel.textContent = 'æ ‡é¢˜';
        titleLabel.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #333 !important;
            margin-bottom: 8px !important;
        `;
        
        const titleInputWrapper = document.createElement('div');
        titleInputWrapper.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            align-items: center !important;
        `;
        
        const titleInput = document.createElement('input');
        titleInput.className = 'api-request-editor-title-input';
        titleInput.type = 'text';
        titleInput.placeholder = 'è¯·è¾“å…¥æ ‡é¢˜';
        titleInput.style.cssText = `
            flex: 1 !important;
            padding: 12px !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            box-sizing: border-box !important;
            transition: border-color 0.2s ease !important;
        `;
        titleInput.addEventListener('focus', () => {
            titleInput.style.borderColor = '#4CAF50';
        });
        titleInput.addEventListener('blur', () => {
            titleInput.style.borderColor = '#ddd';
        });
        
        const generateTitleBtn = document.createElement('button');
        generateTitleBtn.className = 'api-request-editor-generate-title';
        generateTitleBtn.innerHTML = 'âœ¨ æ™ºèƒ½ç”Ÿæˆ';
        generateTitleBtn.style.cssText = `
            padding: 12px 16px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        generateTitleBtn.addEventListener('mouseenter', () => {
            generateTitleBtn.style.background = '#1976D2';
        });
        generateTitleBtn.addEventListener('mouseleave', () => {
            generateTitleBtn.style.background = '#2196F3';
        });
        
        titleInputWrapper.appendChild(titleInput);
        titleInputWrapper.appendChild(generateTitleBtn);
        
        titleGroup.appendChild(titleLabel);
        titleGroup.appendChild(titleInputWrapper);
        
        // æè¿°è¾“å…¥åŒºåŸŸ
        const descriptionGroup = document.createElement('div');
        descriptionGroup.style.cssText = `
            margin-bottom: 24px !important;
        `;
        
        const descriptionLabel = document.createElement('label');
        descriptionLabel.textContent = 'æè¿°';
        descriptionLabel.style.cssText = `
            display: block !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #333 !important;
            margin-bottom: 8px !important;
        `;
        
        const descriptionInputWrapper = document.createElement('div');
        descriptionInputWrapper.style.cssText = `
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
        `;
        
        const descriptionInput = document.createElement('textarea');
        descriptionInput.className = 'api-request-editor-description-input';
        descriptionInput.placeholder = 'è¯·è¾“å…¥æè¿°';
        descriptionInput.rows = 4;
        descriptionInput.style.cssText = `
            width: 100% !important;
            padding: 12px !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            box-sizing: border-box !important;
            resize: vertical !important;
            transition: border-color 0.2s ease !important;
            font-family: inherit !important;
        `;
        descriptionInput.addEventListener('focus', () => {
            descriptionInput.style.borderColor = '#4CAF50';
        });
        descriptionInput.addEventListener('blur', () => {
            descriptionInput.style.borderColor = '#ddd';
        });
        
        const generateDescriptionBtn = document.createElement('button');
        generateDescriptionBtn.className = 'api-request-editor-generate-description';
        generateDescriptionBtn.innerHTML = 'âœ¨ æ™ºèƒ½ç”Ÿæˆæè¿°';
        generateDescriptionBtn.style.cssText = `
            align-self: flex-end !important;
            padding: 12px 16px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        generateDescriptionBtn.addEventListener('mouseenter', () => {
            generateDescriptionBtn.style.background = '#1976D2';
        });
        generateDescriptionBtn.addEventListener('mouseleave', () => {
            generateDescriptionBtn.style.background = '#2196F3';
        });
        
        descriptionInputWrapper.appendChild(descriptionInput);
        descriptionInputWrapper.appendChild(generateDescriptionBtn);
        
        descriptionGroup.appendChild(descriptionLabel);
        descriptionGroup.appendChild(descriptionInputWrapper);
        
        // æŒ‰é’®åŒºåŸŸ
        const buttonGroup = document.createElement('div');
        buttonGroup.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 12px !important;
            margin-top: 24px !important;
        `;
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'api-request-editor-cancel';
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            background: white !important;
            color: #333 !important;
            font-size: 14px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f5f5f5';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'white';
        });
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'api-request-editor-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            border: none !important;
            border-radius: 8px !important;
            background: #4CAF50 !important;
            color: white !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#45a049';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#4CAF50';
        });
        
        buttonGroup.appendChild(cancelBtn);
        buttonGroup.appendChild(saveBtn);
        
        panel.appendChild(header);
        panel.appendChild(titleGroup);
        panel.appendChild(descriptionGroup);
        panel.appendChild(buttonGroup);
        modal.appendChild(panel);
        document.body.appendChild(modal);
    }
    
    // ä¿å­˜è¯·æ±‚æ¥å£ä¿¡æ¯
    async saveApiRequestInfo(apiRequest) {
        const modal = document.body.querySelector('#pet-api-request-info-editor');
        if (!modal) {
            console.error('è¯·æ±‚æ¥å£ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†æœªæ‰¾åˆ°');
            return;
        }
        
        const titleInput = modal.querySelector('.api-request-editor-title-input');
        const descriptionInput = modal.querySelector('.api-request-editor-description-input');
        
        if (!titleInput || !descriptionInput) {
            console.error('è¾“å…¥æ¡†æœªæ‰¾åˆ°');
            return;
        }
        
        const newTitle = titleInput.value.trim();
        const newDescription = descriptionInput.value.trim();
        
        if (!newTitle) {
            this.showNotification('æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }
        
        try {
            // æ£€æŸ¥apiRequestApiæ˜¯å¦å¯ç”¨
            if (!this.apiRequestApi || !this.apiRequestApi.isEnabled()) {
                this.showNotification('APIç®¡ç†å™¨æœªå¯ç”¨ï¼Œæ— æ³•ä¿å­˜', 'error');
                return;
            }
            
            // å‡†å¤‡æ›´æ–°æ•°æ®
            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
            const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
            const apiRequestData = {
                key: apiRequest.key || apiRequest._id || apiRequest.id,
                url: requestUrl,
                requestUrl: requestUrl, // ç¡®ä¿requestUrlå­—æ®µå­˜åœ¨
                method: apiRequest.method || 'GET',
                status: apiRequest.status || 0,
                statusText: apiRequest.statusText || '',
                headers: apiRequest.headers || {},
                body: apiRequest.body || null,
                responseHeaders: apiRequest.responseHeaders || {},
                responseBody: apiRequest.responseBody || null,
                responseText: apiRequest.responseText || '',
                duration: apiRequest.duration || 0,
                timestamp: apiRequest.timestamp || Date.now(),
                type: apiRequest.type || 'fetch',
                curl: apiRequest.curl || '',
                pageUrl: apiRequest.pageUrl || window.location.href,
                tags: apiRequest.tags || [],
                title: newTitle,
                description: newDescription
            };
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.showNotification('æ­£åœ¨ä¿å­˜...', 'info');
            
            // ä¿å­˜åˆ°åç«¯
            const result = await this.apiRequestApi.saveApiRequest(apiRequestData);
            
            if (result && result.success) {
                console.log('è¯·æ±‚æ¥å£ä¿¡æ¯å·²æ›´æ–°:', result.data);
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                if (this.apiRequestManager) {
                    const apiRequestKey = this._getRequestKey(apiRequest) || apiRequest.key || apiRequest._id || apiRequest.id;
                    const index = this.apiRequestManager.requests.findIndex(req => {
                        const reqKey = this._getRequestKey(req);
                        return reqKey === apiRequestKey;
                    });
                    
                    if (index >= 0) {
                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        this.apiRequestManager.requests[index].title = newTitle;
                        this.apiRequestManager.requests[index].description = newDescription;
                    }
                }
                
                // åˆ·æ–°åˆ—è¡¨
                await this.updateApiRequestSidebar(true);
                
                // å…³é—­å¯¹è¯æ¡†
                this.closeApiRequestInfoEditor();
                
                this.showNotification('ä¿å­˜æˆåŠŸ', 'success');
            } else {
                throw new Error(result?.message || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜è¯·æ±‚æ¥å£ä¿¡æ¯å¤±è´¥:', error);
            this.showNotification(`ä¿å­˜å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        }
    }
    
    // å…³é—­è¯·æ±‚æ¥å£ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†
    closeApiRequestInfoEditor() {
        const modal = document.body.querySelector('#pet-api-request-info-editor');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // æ™ºèƒ½ç”Ÿæˆæ¥å£è¯·æ±‚æ ‡é¢˜
    async generateApiRequestTitle(apiRequest) {
        if (!apiRequest) {
            console.warn('æ¥å£è¯·æ±‚ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæ ‡é¢˜');
            return;
        }

        const modal = document.body.querySelector('#pet-api-request-info-editor');
        if (!modal) {
            return;
        }

        const generateBtn = modal.querySelector('.api-request-editor-generate-title');
        const titleInput = modal.querySelector('.api-request-editor-title-input');
        
        if (!generateBtn || !titleInput) {
            return;
        }

        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        const originalText = generateBtn.innerHTML;
        generateBtn.disabled = true;
        generateBtn.innerHTML = 'ç”Ÿæˆä¸­...';
        generateBtn.style.opacity = '0.6';
        generateBtn.style.cursor = 'not-allowed';

        try {
            // æ„å»ºç”Ÿæˆæ ‡é¢˜çš„ prompt
            let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŠ©æ‰‹ï¼Œæ“…é•¿æ ¹æ®æ¥å£è¯·æ±‚ä¿¡æ¯ç”Ÿæˆç®€æ´ã€å‡†ç¡®çš„æ ‡é¢˜ã€‚';
            let userPrompt = 'è¯·æ ¹æ®ä»¥ä¸‹æ¥å£è¯·æ±‚ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªç®€æ´ã€å‡†ç¡®çš„æ ‡é¢˜ï¼ˆä¸è¶…è¿‡30ä¸ªå­—ï¼‰ï¼š\n\n';

            // æ·»åŠ æ¥å£è¯·æ±‚ä¿¡æ¯
            if (apiRequest.method) {
                userPrompt += `è¯·æ±‚æ–¹æ³•ï¼š${apiRequest.method}\n`;
            }
            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
            const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
            if (requestUrl) {
                userPrompt += `è¯·æ±‚URLï¼š${requestUrl}\n`;
            }
            if (apiRequest.pageUrl) {
                userPrompt += `é¡µé¢URLï¼š${apiRequest.pageUrl}\n`;
            }
            if (apiRequest.status) {
                userPrompt += `å“åº”çŠ¶æ€ï¼š${apiRequest.status} ${apiRequest.statusText || ''}\n`;
            }

            // æ·»åŠ è¯·æ±‚ä½“ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (apiRequest.body) {
                let bodyStr = '';
                if (typeof apiRequest.body === 'string') {
                    try {
                        const parsed = JSON.parse(apiRequest.body);
                        bodyStr = JSON.stringify(parsed, null, 2).substring(0, 500);
                    } catch {
                        bodyStr = apiRequest.body.substring(0, 500);
                    }
                } else {
                    bodyStr = JSON.stringify(apiRequest.body, null, 2).substring(0, 500);
                }
                if (bodyStr) {
                    userPrompt += `\nè¯·æ±‚ä½“ï¼š\n${bodyStr}\n`;
                }
            }

            // æ·»åŠ å“åº”ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (apiRequest.responseBody || apiRequest.responseText) {
                let responseStr = '';
                if (apiRequest.responseBody) {
                    if (typeof apiRequest.responseBody === 'string') {
                        try {
                            const parsed = JSON.parse(apiRequest.responseBody);
                            responseStr = JSON.stringify(parsed, null, 2).substring(0, 500);
                        } catch {
                            responseStr = apiRequest.responseBody.substring(0, 500);
                        }
                    } else {
                        responseStr = JSON.stringify(apiRequest.responseBody, null, 2).substring(0, 500);
                    }
                } else if (apiRequest.responseText) {
                    responseStr = apiRequest.responseText.substring(0, 500);
                }
                if (responseStr) {
                    userPrompt += `\nå“åº”å†…å®¹ï¼š\n${responseStr}\n`;
                }
            }

            userPrompt += '\n\nè¯·ç›´æ¥è¿”å›æ ‡é¢˜ï¼Œä¸è¦åŒ…å«å…¶ä»–è¯´æ˜æ–‡å­—ã€‚';

            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );

            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // å…ˆè·å–å“åº”æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ SSE æ ¼å¼
            const responseText = await response.text();
            let result;
            
            try {
                // æ£€æŸ¥æ˜¯å¦åŒ…å« SSE æ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                if (responseText.includes('data: ')) {
                    // å¤„ç† SSE æ ¼å¼å“åº”
                    const lines = responseText.split('\n');
                    let accumulatedData = '';
                    let lastValidData = null;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr === '[DONE]' || dataStr === '') {
                                    continue;
                                }
                                
                                // å°è¯•è§£æ JSON
                                const chunk = JSON.parse(dataStr);
                                
                                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                if (chunk.done === true) {
                                    break;
                                }
                                
                                // ç´¯ç§¯å†…å®¹
                                if (chunk.content) {
                                    accumulatedData += chunk.content;
                                    lastValidData = chunk;
                                } else if (chunk.data) {
                                    accumulatedData += (typeof chunk.data === 'string' ? chunk.data : chunk.data.content || '');
                                    lastValidData = chunk;
                                } else if (chunk.message && chunk.message.content) {
                                    accumulatedData += chunk.message.content;
                                    lastValidData = chunk;
                                }
                            } catch (e) {
                                console.warn('è§£æ SSE æ•°æ®å—å¤±è´¥:', trimmedLine, e);
                            }
                        }
                    }
                    
                    // å¦‚æœæœ‰ç´¯ç§¯çš„å†…å®¹ï¼Œä½¿ç”¨å®ƒ
                    if (accumulatedData) {
                        result = { content: accumulatedData, data: accumulatedData };
                    } else if (lastValidData) {
                        result = lastValidData;
                    } else {
                        // å°è¯•ä»æœ€åä¸€è¡Œæå– JSON
                        const sseMatch = responseText.match(/data:\s*({.+?})/s);
                        if (sseMatch) {
                            result = JSON.parse(sseMatch[1]);
                        } else {
                            throw new Error('æ— æ³•è§£æ SSE å“åº”');
                        }
                    }
                } else {
                    // æ™®é€š JSON å“åº”
                    result = JSON.parse(responseText);
                }
            } catch (parseError) {
                console.error('è§£æå“åº”å¤±è´¥:', parseError, 'å“åº”å†…å®¹:', responseText.substring(0, 200));
                throw new Error('è§£æå“åº”å¤±è´¥: ' + parseError.message);
            }
            
            // æå–ç”Ÿæˆçš„æ ‡é¢˜ï¼ˆé€‚é…ä¸åŒçš„å“åº”æ ¼å¼ï¼‰
            let generatedTitle = '';
            if (result.status === 200 && result.data) {
                // æˆåŠŸå“åº”ï¼Œæå– data å­—æ®µ
                generatedTitle = typeof result.data === 'string' ? result.data.trim() : (result.data.content || '').trim();
            } else if (result && result.content) {
                generatedTitle = result.content.trim();
            } else if (result && result.data && result.data.content) {
                generatedTitle = result.data.content.trim();
            } else if (result && result.message) {
                generatedTitle = result.message.trim();
            } else if (typeof result === 'string') {
                generatedTitle = result.trim();
            }

            // æ¸…ç†æ ‡é¢˜ï¼ˆç§»é™¤å¯èƒ½çš„å¼•å·ã€æ¢è¡Œç­‰ï¼‰
            generatedTitle = generatedTitle.replace(/^["']|["']$/g, '').replace(/\n/g, ' ').trim();
            
            // é™åˆ¶é•¿åº¦
            if (generatedTitle.length > 50) {
                generatedTitle = generatedTitle.substring(0, 50);
            }

            if (generatedTitle) {
                titleInput.value = generatedTitle;
                titleInput.focus();
            } else {
                alert('ç”Ÿæˆæ ‡é¢˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('ç”Ÿæˆæ ‡é¢˜å¤±è´¥:', error);
            alert('ç”Ÿæˆæ ‡é¢˜å¤±è´¥ï¼š' + error.message);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
            generateBtn.style.opacity = '1';
            generateBtn.style.cursor = 'pointer';
        }
    }

    // æ™ºèƒ½ç”Ÿæˆæ¥å£è¯·æ±‚æè¿°
    async generateApiRequestDescription(apiRequest) {
        if (!apiRequest) {
            console.warn('æ¥å£è¯·æ±‚ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæè¿°');
            return;
        }

        const modal = document.body.querySelector('#pet-api-request-info-editor');
        if (!modal) {
            return;
        }

        const generateBtn = modal.querySelector('.api-request-editor-generate-description');
        const descriptionInput = modal.querySelector('.api-request-editor-description-input');
        
        if (!generateBtn || !descriptionInput) {
            return;
        }

        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        const originalText = generateBtn.innerHTML;
        generateBtn.disabled = true;
        generateBtn.innerHTML = 'ç”Ÿæˆä¸­...';
        generateBtn.style.opacity = '0.6';
        generateBtn.style.cursor = 'not-allowed';

        try {
            // æ„å»ºç”Ÿæˆæè¿°çš„ prompt
            let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŠ©æ‰‹ï¼Œæ“…é•¿æ ¹æ®æ¥å£è¯·æ±‚ä¿¡æ¯ç”Ÿæˆç®€æ´ã€å‡†ç¡®çš„æè¿°ã€‚';
            let userPrompt = 'è¯·æ ¹æ®ä»¥ä¸‹æ¥å£è¯·æ±‚ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªç®€æ´ã€å‡†ç¡®çš„æè¿°ï¼ˆ50-200å­—ï¼‰ï¼š\n\n';

            // æ·»åŠ æ¥å£è¯·æ±‚ä¿¡æ¯
            if (apiRequest.method) {
                userPrompt += `è¯·æ±‚æ–¹æ³•ï¼š${apiRequest.method}\n`;
            }
            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
            const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
            if (requestUrl) {
                userPrompt += `è¯·æ±‚URLï¼š${requestUrl}\n`;
            }
            if (apiRequest.pageUrl) {
                userPrompt += `é¡µé¢URLï¼š${apiRequest.pageUrl}\n`;
            }
            if (apiRequest.status) {
                userPrompt += `å“åº”çŠ¶æ€ï¼š${apiRequest.status} ${apiRequest.statusText || ''}\n`;
            }

            // æ·»åŠ è¯·æ±‚å¤´ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (apiRequest.headers && Object.keys(apiRequest.headers).length > 0) {
                userPrompt += `\nè¯·æ±‚å¤´ï¼š\n${JSON.stringify(apiRequest.headers, null, 2).substring(0, 300)}\n`;
            }

            // æ·»åŠ è¯·æ±‚ä½“ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (apiRequest.body) {
                let bodyStr = '';
                if (typeof apiRequest.body === 'string') {
                    try {
                        const parsed = JSON.parse(apiRequest.body);
                        bodyStr = JSON.stringify(parsed, null, 2).substring(0, 800);
                    } catch {
                        bodyStr = apiRequest.body.substring(0, 800);
                    }
                } else {
                    bodyStr = JSON.stringify(apiRequest.body, null, 2).substring(0, 800);
                }
                if (bodyStr) {
                    userPrompt += `\nè¯·æ±‚ä½“ï¼š\n${bodyStr}\n`;
                }
            }

            // æ·»åŠ å“åº”ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (apiRequest.responseBody || apiRequest.responseText) {
                let responseStr = '';
                if (apiRequest.responseBody) {
                    if (typeof apiRequest.responseBody === 'string') {
                        try {
                            const parsed = JSON.parse(apiRequest.responseBody);
                            responseStr = JSON.stringify(parsed, null, 2).substring(0, 800);
                        } catch {
                            responseStr = apiRequest.responseBody.substring(0, 800);
                        }
                    } else {
                        responseStr = JSON.stringify(apiRequest.responseBody, null, 2).substring(0, 800);
                    }
                } else if (apiRequest.responseText) {
                    responseStr = apiRequest.responseText.substring(0, 800);
                }
                if (responseStr) {
                    userPrompt += `\nå“åº”å†…å®¹ï¼š\n${responseStr}\n`;
                }
            }

            userPrompt += '\n\nè¯·ç›´æ¥è¿”å›æè¿°ï¼Œä¸è¦åŒ…å«å…¶ä»–è¯´æ˜æ–‡å­—ã€‚æè¿°åº”è¯¥ç®€æ´æ˜äº†ï¼Œæ¦‚æ‹¬æ¥å£è¯·æ±‚çš„ä¸»è¦åŠŸèƒ½å’Œç”¨é€”ã€‚';

            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );

            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // å…ˆè·å–å“åº”æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ SSE æ ¼å¼
            const responseText = await response.text();
            let result;
            
            try {
                // æ£€æŸ¥æ˜¯å¦åŒ…å« SSE æ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                if (responseText.includes('data: ')) {
                    // å¤„ç† SSE æ ¼å¼å“åº”
                    const lines = responseText.split('\n');
                    let accumulatedData = '';
                    let lastValidData = null;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr === '[DONE]' || dataStr === '') {
                                    continue;
                                }
                                
                                // å°è¯•è§£æ JSON
                                const chunk = JSON.parse(dataStr);
                                
                                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                if (chunk.done === true) {
                                    break;
                                }
                                
                                // ç´¯ç§¯å†…å®¹
                                if (chunk.content) {
                                    accumulatedData += chunk.content;
                                    lastValidData = chunk;
                                } else if (chunk.data) {
                                    accumulatedData += (typeof chunk.data === 'string' ? chunk.data : chunk.data.content || '');
                                    lastValidData = chunk;
                                } else if (chunk.message && chunk.message.content) {
                                    accumulatedData += chunk.message.content;
                                    lastValidData = chunk;
                                }
                            } catch (e) {
                                console.warn('è§£æ SSE æ•°æ®å—å¤±è´¥:', trimmedLine, e);
                            }
                        }
                    }
                    
                    // å¦‚æœæœ‰ç´¯ç§¯çš„å†…å®¹ï¼Œä½¿ç”¨å®ƒ
                    if (accumulatedData) {
                        result = { content: accumulatedData, data: accumulatedData };
                    } else if (lastValidData) {
                        result = lastValidData;
                    } else {
                        // å°è¯•ä»æœ€åä¸€è¡Œæå– JSON
                        const sseMatch = responseText.match(/data:\s*({.+?})/s);
                        if (sseMatch) {
                            result = JSON.parse(sseMatch[1]);
                        } else {
                            throw new Error('æ— æ³•è§£æ SSE å“åº”');
                        }
                    }
                } else {
                    // æ™®é€š JSON å“åº”
                    result = JSON.parse(responseText);
                }
            } catch (parseError) {
                console.error('è§£æå“åº”å¤±è´¥:', parseError, 'å“åº”å†…å®¹:', responseText.substring(0, 200));
                throw new Error('è§£æå“åº”å¤±è´¥: ' + parseError.message);
            }
            
            // æå–ç”Ÿæˆçš„æè¿°ï¼ˆé€‚é…ä¸åŒçš„å“åº”æ ¼å¼ï¼‰
            let generatedDescription = '';
            if (result.status === 200 && result.data) {
                // æˆåŠŸå“åº”ï¼Œæå– data å­—æ®µ
                generatedDescription = typeof result.data === 'string' ? result.data.trim() : (result.data.content || '').trim();
            } else if (result && result.content) {
                generatedDescription = result.content.trim();
            } else if (result && result.data && result.data.content) {
                generatedDescription = result.data.content.trim();
            } else if (result && result.message) {
                generatedDescription = result.message.trim();
            } else if (typeof result === 'string') {
                generatedDescription = result.trim();
            }

            // æ¸…ç†æè¿°ï¼ˆç§»é™¤å¯èƒ½çš„å¼•å·ç­‰ï¼‰
            generatedDescription = generatedDescription.replace(/^["']|["']$/g, '').trim();
            
            // é™åˆ¶é•¿åº¦
            if (generatedDescription.length > 500) {
                generatedDescription = generatedDescription.substring(0, 500);
            }

            if (generatedDescription) {
                descriptionInput.value = generatedDescription;
                descriptionInput.focus();
            } else {
                alert('ç”Ÿæˆæè¿°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('ç”Ÿæˆæè¿°å¤±è´¥:', error);
            alert('ç”Ÿæˆæè¿°å¤±è´¥ï¼š' + error.message);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
            generateBtn.style.opacity = '1';
            generateBtn.style.cursor = 'pointer';
        }
    }
    
    // ç¡®ä¿è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å™¨UIå­˜åœ¨
    ensureApiRequestTagManagerUi() {
        // ä¼˜å…ˆåœ¨chatWindowä¸­æŸ¥æ‰¾ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åœ¨bodyä¸­æŸ¥æ‰¾
        let container = this.chatWindow || document.body;
        if (container.querySelector('#pet-api-request-tag-manager')) return;
        
        const modal = document.createElement('div');
        modal.id = 'pet-api-request-tag-manager';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 10000 !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeApiRequestTagManager();
            }
        });
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 24px !important;
            width: 90% !important;
            max-width: 800px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        `;
        
        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ç®¡ç†æ ‡ç­¾';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'api-request-tag-manager-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // è¾“å…¥åŒºåŸŸ
        const inputGroup = document.createElement('div');
        inputGroup.className = 'api-request-tag-manager-input-group';
        inputGroup.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
        `;
        
        const tagInput = document.createElement('input');
        tagInput.className = 'api-request-tag-manager-input';
        tagInput.type = 'text';
        tagInput.placeholder = 'è¾“å…¥æ ‡ç­¾åç§°ï¼ŒæŒ‰å›è½¦æ·»åŠ ';
        tagInput.style.cssText = `
            flex: 1 !important;
            padding: 10px 12px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
        `;
        
        tagInput._isComposing = false;
        tagInput.addEventListener('compositionstart', () => {
            tagInput._isComposing = true;
        });
        tagInput.addEventListener('compositionend', () => {
            tagInput._isComposing = false;
        });
        
        tagInput.addEventListener('focus', () => {
            tagInput.style.borderColor = '#4CAF50';
        });
        tagInput.addEventListener('blur', () => {
            tagInput.style.borderColor = '#e0e0e0';
        });
        
        const addBtn = document.createElement('button');
        addBtn.textContent = 'æ·»åŠ ';
        addBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.background = '#45a049';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.background = '#4CAF50';
        });
        addBtn.addEventListener('click', () => {
            const apiRequestKey = modal.dataset.apiRequestKey;
            if (apiRequestKey) {
                this.addApiRequestTagFromInput(modal);
            }
        });
        
        inputGroup.appendChild(tagInput);
        inputGroup.appendChild(addBtn);
        
        // æ ‡ç­¾åˆ—è¡¨
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'api-request-tag-manager-tags';
        tagsContainer.style.cssText = `
            min-height: 100px !important;
            max-height: 300px !important;
            overflow-y: auto !important;
            margin-bottom: 20px !important;
            padding: 12px !important;
            background: #f8f9fa !important;
            border-radius: 6px !important;
        `;
        
        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 10px !important;
        `;
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #f0f0f0 !important;
            color: #333 !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: background 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#e0e0e0';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = '#f0f0f0';
        });
        cancelBtn.addEventListener('click', () => {
            this.closeApiRequestTagManager();
        });
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'api-request-tag-manager-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#45a049';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#4CAF50';
        });
        
        footer.appendChild(cancelBtn);
        footer.appendChild(saveBtn);
        
        panel.appendChild(header);
        panel.appendChild(inputGroup);
        panel.appendChild(tagsContainer);
        panel.appendChild(footer);
        modal.appendChild(panel);
        container.appendChild(modal);
    }
    
    // åŠ è½½æ ‡ç­¾åˆ°è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å™¨
    loadApiRequestTagsIntoManager(apiRequest, tags) {
        const modal = this.chatWindow?.querySelector('#pet-api-request-tag-manager') || 
                     document.body.querySelector('#pet-api-request-tag-manager');
        if (!modal) {
            console.error('è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }
        
        const tagsContainer = modal.querySelector('.api-request-tag-manager-tags');
        if (!tagsContainer) {
            console.error('æ ‡ç­¾å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // æ¸…ç©ºç°æœ‰æ ‡ç­¾
        tagsContainer.innerHTML = '';
        
        // å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œæ˜¾ç¤ºæç¤º
        if (!tags || tags.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #999 !important;
                padding: 20px !important;
            `;
            tagsContainer.appendChild(emptyMsg);
            return;
        }
        
        // æ¸²æŸ“æ ‡ç­¾
        tags.forEach(tag => {
            if (tag && tag.trim()) {
                const tagElement = document.createElement('div');
                tagElement.className = 'api-request-tag-manager-tag-item';
                tagElement.dataset.tagName = tag;
                tagElement.style.cssText = `
                    display: inline-flex !important;
                    align-items: center !important;
                    gap: 8px !important;
                    padding: 8px 12px !important;
                    background: white !important;
                    border: 1px solid #e0e0e0 !important;
                    border-radius: 6px !important;
                    margin: 4px !important;
                    font-size: 13px !important;
                `;
                
                const tagText = document.createElement('span');
                tagText.textContent = tag;
                tagText.style.cssText = `
                    flex: 1 !important;
                `;
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = 'âœ•';
                removeBtn.style.cssText = `
                    background: none !important;
                    border: none !important;
                    cursor: pointer !important;
                    color: #999 !important;
                    font-size: 16px !important;
                    padding: 0 !important;
                    width: 20px !important;
                    height: 20px !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    border-radius: 50% !important;
                    transition: all 0.2s ease !important;
                `;
                removeBtn.addEventListener('mouseenter', () => {
                    removeBtn.style.background = '#f0f0f0';
                    removeBtn.style.color = '#f44336';
                });
                removeBtn.addEventListener('mouseleave', () => {
                    removeBtn.style.background = 'none';
                    removeBtn.style.color = '#999';
                });
                removeBtn.addEventListener('click', () => {
                    this.removeApiRequestTagFromManager(modal, tag);
                });
                
                tagElement.appendChild(tagText);
                tagElement.appendChild(removeBtn);
                tagsContainer.appendChild(tagElement);
            }
        });
    }
    
    // ä»è¾“å…¥æ¡†æ·»åŠ æ ‡ç­¾
    addApiRequestTagFromInput(modal) {
        if (!modal) {
            modal = this.chatWindow?.querySelector('#pet-api-request-tag-manager') || 
                   document.body.querySelector('#pet-api-request-tag-manager');
        }
        if (!modal) {
            console.error('è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }
        
        const tagInput = modal.querySelector('.api-request-tag-manager-input');
        if (!tagInput) {
            console.error('æ ‡ç­¾è¾“å…¥æ¡†æœªæ‰¾åˆ°');
            return;
        }
        
        const tagName = tagInput.value.trim();
        if (!tagName) {
            return;
        }
        
        // è·å–å½“å‰æ ‡ç­¾åˆ—è¡¨
        const tagsContainer = modal.querySelector('.api-request-tag-manager-tags');
        if (!tagsContainer) {
            console.error('æ ‡ç­¾å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        const existingTags = Array.from(tagsContainer.querySelectorAll('.api-request-tag-manager-tag-item'))
            .map(item => item.dataset.tagName);
        
        if (existingTags.includes(tagName)) {
            this.showNotification('æ ‡ç­¾å·²å­˜åœ¨', 'info');
            return;
        }
        
        // æ·»åŠ æ ‡ç­¾åˆ°åˆ—è¡¨
        const currentTags = existingTags.length === 0 && tagsContainer.querySelector('div')?.textContent === 'æš‚æ— æ ‡ç­¾'
            ? []
            : existingTags;
        currentTags.push(tagName);
        
        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadApiRequestTagsIntoManager({ tags: currentTags }, currentTags);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        tagInput.value = '';
        tagInput.focus();
    }
    
    // ä»ç®¡ç†å™¨ç§»é™¤æ ‡ç­¾
    removeApiRequestTagFromManager(modal, tagName) {
        if (!modal) {
            modal = this.chatWindow?.querySelector('#pet-api-request-tag-manager') || 
                   document.body.querySelector('#pet-api-request-tag-manager');
        }
        if (!modal) {
            console.error('è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }
        
        const tagsContainer = modal.querySelector('.api-request-tag-manager-tags');
        if (!tagsContainer) {
            console.error('æ ‡ç­¾å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // è·å–å½“å‰æ ‡ç­¾åˆ—è¡¨
        const currentTags = Array.from(tagsContainer.querySelectorAll('.api-request-tag-manager-tag-item'))
            .map(item => item.dataset.tagName)
            .filter(tag => tag !== tagName);
        
        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadApiRequestTagsIntoManager({ tags: currentTags }, currentTags);
    }
    
    // ä¿å­˜è¯·æ±‚æ¥å£æ ‡ç­¾
    async saveApiRequestTags(apiRequest) {
        const modal = this.chatWindow?.querySelector('#pet-api-request-tag-manager') || 
                     document.body.querySelector('#pet-api-request-tag-manager');
        if (!modal) {
            console.error('è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }
        
        const tagsContainer = modal.querySelector('.api-request-tag-manager-tags');
        if (!tagsContainer) {
            console.error('æ ‡ç­¾å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
        
        // è·å–å½“å‰æ ‡ç­¾åˆ—è¡¨
        const currentTags = Array.from(tagsContainer.querySelectorAll('.api-request-tag-manager-tag-item'))
            .map(item => item.dataset.tagName);
        
        try {
            // æ£€æŸ¥apiRequestApiæ˜¯å¦å¯ç”¨
            if (!this.apiRequestApi || !this.apiRequestApi.isEnabled()) {
                this.showNotification('APIç®¡ç†å™¨æœªå¯ç”¨ï¼Œæ— æ³•ä¿å­˜', 'error');
                return;
            }
            
            // å‡†å¤‡æ›´æ–°æ•°æ®
            // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
            const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
            const apiRequestData = {
                key: apiRequest.key || apiRequest._id || apiRequest.id,
                url: requestUrl,
                requestUrl: requestUrl, // ç¡®ä¿requestUrlå­—æ®µå­˜åœ¨
                method: apiRequest.method || 'GET',
                status: apiRequest.status || 0,
                statusText: apiRequest.statusText || '',
                headers: apiRequest.headers || {},
                body: apiRequest.body || null,
                responseHeaders: apiRequest.responseHeaders || {},
                responseBody: apiRequest.responseBody || null,
                responseText: apiRequest.responseText || '',
                duration: apiRequest.duration || 0,
                timestamp: apiRequest.timestamp || Date.now(),
                type: apiRequest.type || 'fetch',
                curl: apiRequest.curl || '',
                pageUrl: apiRequest.pageUrl || window.location.href,
                tags: currentTags,
                title: apiRequest.title || '',
                description: apiRequest.description || ''
            };
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.showNotification('æ­£åœ¨ä¿å­˜...', 'info');
            
            // ä¿å­˜åˆ°åç«¯
            const result = await this.apiRequestApi.saveApiRequest(apiRequestData);
            
            if (result && result.success) {
                console.log('è¯·æ±‚æ¥å£æ ‡ç­¾å·²æ›´æ–°:', result.data);
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                if (this.apiRequestManager) {
                    const apiRequestKey = this._getRequestKey(apiRequest) || apiRequest.key || apiRequest._id || apiRequest.id;
                    const index = this.apiRequestManager.requests.findIndex(req => {
                        const reqKey = this._getRequestKey(req);
                        return reqKey === apiRequestKey;
                    });
                    
                    if (index >= 0) {
                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        this.apiRequestManager.requests[index].tags = currentTags;
                    }
                }
                
                // åˆ·æ–°åˆ—è¡¨
                await this.updateApiRequestSidebar(true);
                
                // å…³é—­å¯¹è¯æ¡†
                this.closeApiRequestTagManager();
                
                this.showNotification('ä¿å­˜æˆåŠŸ', 'success');
            } else {
                throw new Error(result?.message || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜è¯·æ±‚æ¥å£æ ‡ç­¾å¤±è´¥:', error);
            this.showNotification(`ä¿å­˜å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        }
    }
    
    // å…³é—­è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å™¨
    closeApiRequestTagManager() {
        const modal = this.chatWindow?.querySelector('#pet-api-request-tag-manager') || 
                     document.body.querySelector('#pet-api-request-tag-manager');
        if (modal) {
            modal.style.display = 'none';
            
            // æ¢å¤æŠ˜å æŒ‰é’®æ˜¾ç¤º
            const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
            const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
            if (sidebarToggleBtn) sidebarToggleBtn.style.display = '';
            if (inputToggleBtn) inputToggleBtn.style.display = '';
        }
    }
    
    // æ‰“å¼€è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å™¨ï¼ˆå‚è€ƒä¼šè¯çš„æ ‡ç­¾ç®¡ç†åŠŸèƒ½ï¼‰
    async openApiRequestTagManager(apiRequest) {
        if (!apiRequest) {
            console.warn('è¯·æ±‚æ¥å£æ•°æ®æ— æ•ˆï¼Œæ— æ³•ç®¡ç†æ ‡ç­¾:', apiRequest);
            return;
        }
        
        const currentTags = apiRequest.tags || [];
        
        // åˆ›å»ºæ ‡ç­¾ç®¡ç†å¼¹çª—
        this.ensureApiRequestTagManagerUi();
        const modal = this.chatWindow?.querySelector('#pet-api-request-tag-manager');
        if (!modal) {
            // å¦‚æœchatWindowä¸å­˜åœ¨ï¼Œåœ¨bodyä¸Šåˆ›å»º
            const bodyModal = document.body.querySelector('#pet-api-request-tag-manager');
            if (bodyModal) {
                bodyModal.style.display = 'flex';
                bodyModal.dataset.apiRequestKey = apiRequest.key || apiRequest._id || apiRequest.id;
                bodyModal.dataset.apiRequestUrl = apiRequest.url || '';
                
                // åŠ è½½å½“å‰æ ‡ç­¾
                this.loadApiRequestTagsIntoManager(apiRequest, currentTags);
                
                // æ·»åŠ å…³é—­äº‹ä»¶
                const closeBtn = bodyModal.querySelector('.api-request-tag-manager-close');
                if (closeBtn) {
                    closeBtn.onclick = () => this.closeApiRequestTagManager();
                }
                
                // æ·»åŠ ä¿å­˜äº‹ä»¶
                const saveBtn = bodyModal.querySelector('.api-request-tag-manager-save');
                if (saveBtn) {
                    saveBtn.onclick = () => this.saveApiRequestTags(apiRequest);
                }
                
                // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶
                const tagInput = bodyModal.querySelector('.api-request-tag-manager-input');
                if (tagInput) {
                    if (tagInput._isComposing === undefined) {
                        tagInput._isComposing = false;
                        tagInput.addEventListener('compositionstart', () => {
                            tagInput._isComposing = true;
                        });
                        tagInput.addEventListener('compositionend', () => {
                            tagInput._isComposing = false;
                        });
                    }
                    
                    const existingHandler = tagInput._enterKeyHandler;
                    if (existingHandler) {
                        tagInput.removeEventListener('keydown', existingHandler);
                    }
                    
                    const enterKeyHandler = (e) => {
                        if (tagInput._isComposing) {
                            return;
                        }
                        
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.addApiRequestTagFromInput(bodyModal);
                        }
                    };
                    
                    tagInput._enterKeyHandler = enterKeyHandler;
                    tagInput.addEventListener('keydown', enterKeyHandler);
                    
                    tagInput.focus();
                }
                
                // ESC é”®å…³é—­
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.closeApiRequestTagManager();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
                
                return;
            }
            console.error('è¯·æ±‚æ¥å£æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }
        
        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
        modal.dataset.apiRequestKey = apiRequest.key || apiRequest._id || apiRequest.id;
        // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
        const requestUrl = apiRequest.requestUrl || apiRequest.url || '';
        modal.dataset.apiRequestUrl = requestUrl;
        
        // éšè—æŠ˜å æŒ‰é’®ï¼ˆé¿å…åœ¨å¼¹æ¡†ä¸­æ˜¾ç¤ºä¸¤ä¸ªæŠ˜å æŒ‰é’®ï¼‰
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';
        
        // åŠ è½½å½“å‰æ ‡ç­¾
        this.loadApiRequestTagsIntoManager(apiRequest, currentTags);
        
        // æ·»åŠ å…³é—­äº‹ä»¶
        const closeBtn = modal.querySelector('.api-request-tag-manager-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeApiRequestTagManager();
        }
        
        // æ·»åŠ ä¿å­˜äº‹ä»¶
        const saveBtn = modal.querySelector('.api-request-tag-manager-save');
        if (saveBtn) {
            saveBtn.onclick = () => this.saveApiRequestTags(apiRequest);
        }
        
        // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶ï¼ˆå…¼å®¹ä¸­æ–‡è¾“å…¥æ³•ï¼‰
        const tagInput = modal.querySelector('.api-request-tag-manager-input');
        if (tagInput) {
            // ç¡®ä¿è¾“å…¥æ³•ç»„åˆçŠ¶æ€å·²åˆå§‹åŒ–ï¼ˆå¦‚æœè¾“å…¥æ¡†æ˜¯æ–°åˆ›å»ºçš„ï¼‰
            if (tagInput._isComposing === undefined) {
                tagInput._isComposing = false;
                tagInput.addEventListener('compositionstart', () => {
                    tagInput._isComposing = true;
                });
                tagInput.addEventListener('compositionend', () => {
                    tagInput._isComposing = false;
                });
            }
            
            // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†ï¼ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®šï¼‰
            const existingHandler = tagInput._enterKeyHandler;
            if (existingHandler) {
                tagInput.removeEventListener('keydown', existingHandler);
            }
            
            const enterKeyHandler = (e) => {
                // å¦‚æœåœ¨è¾“å…¥æ³•ç»„åˆè¿‡ç¨‹ä¸­ï¼Œå¿½ç•¥å›è½¦é”®
                if (tagInput._isComposing) {
                    return;
                }
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addApiRequestTagFromInput(modal);
                }
            };
            
            tagInput._enterKeyHandler = enterKeyHandler;
            tagInput.addEventListener('keydown', enterKeyHandler);
            
            tagInput.focus();
        }
        
        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeApiRequestTagManager();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // ä»ç¼–è¾‘å™¨ç”Ÿæˆcurlå‘½ä»¤
    generateCurlFromEditor(modal) {
        if (!modal) {
            return '';
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®ï¼ˆä¸saveApiRequestFromEditoræ–¹æ³•ä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
        const methodSelect = modal.querySelector('.api-editor-method-select');
        const urlInput = modal.querySelector('.api-editor-url-input');
        const headersContainer = modal.querySelector('.api-editor-headers-container');
        const bodyTypeSelect = modal.querySelector('.api-editor-body-type-select');
        const bodyTextarea = modal.querySelector('.api-editor-body-textarea');
        
        const method = methodSelect?.value || 'GET';
        const url = urlInput?.value.trim() || '';
        
        if (!url) {
            return '';
        }
        
        // æ”¶é›†Headers
        const headers = {};
        if (headersContainer) {
            const rows = headersContainer.querySelectorAll('div[style*="display: flex"]');
            rows.forEach(row => {
                const keyInput = row.querySelector('input[placeholder="Headeråç§°"]');
                const valueInput = row.querySelector('input[placeholder="Headerå€¼"]');
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    if (key && value) {
                        headers[key] = value;
                    }
                }
            });
        }
        
        // æ”¶é›†Body
        let body = null;
        if (bodyTypeSelect && bodyTextarea) {
            const bodyType = bodyTypeSelect.value;
            const bodyText = bodyTextarea.value.trim();
            
            if (bodyType !== 'none' && bodyText) {
                if (bodyType === 'json') {
                    // JSONç±»å‹ï¼Œä¿æŒä¸ºå­—ç¬¦ä¸²æ ¼å¼ï¼ˆç”¨äºcurlï¼‰
                    body = bodyText;
                } else {
                    body = bodyText;
                }
            }
        }
        
        // ä½¿ç”¨ç°æœ‰çš„generateCurlCommandæ–¹æ³•ç”Ÿæˆcurlå‘½ä»¤
        return this.generateCurlCommand({
            url: url,
            method: method,
            headers: headers,
            body: body
        });
    }
    
    // ç”Ÿæˆcurlå‘½ä»¤
    generateCurlCommand(apiRequest) {
        if (!apiRequest) {
            return '';
        }
        
        // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
        const url = apiRequest.requestUrl || apiRequest.url || '';
        const method = (apiRequest.method || 'GET').toUpperCase();
        const headers = apiRequest.headers || apiRequest.requestHeaders || {};
        let body = apiRequest.body || apiRequest.requestBody || null;
        
        // å¤„ç†bodyæ ¼å¼
        if (body && typeof body === 'string') {
            try {
                // å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœæ˜¯æœ‰æ•ˆçš„JSONï¼Œåˆ™ä¿ç•™å­—ç¬¦ä¸²æ ¼å¼ç”¨äºcurl
                JSON.parse(body);
                // æ˜¯æœ‰æ•ˆçš„JSONå­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
            } catch (e) {
                // ä¸æ˜¯JSONï¼Œä¿æŒåŸæ ·
            }
        } else if (body && typeof body === 'object') {
            // å¯¹è±¡è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
            body = JSON.stringify(body);
        }
        
        // ç”Ÿæˆcurlå‘½ä»¤
        let curl = `curl -X ${method}`;
        
        // æ·»åŠ è¯·æ±‚å¤´
        if (headers && typeof headers === 'object') {
            Object.entries(headers).forEach(([key, value]) => {
                if (key && value !== undefined && value !== null) {
                    // è½¬ä¹‰åŒå¼•å·å’Œåæ–œæ 
                    const escapedValue = String(value).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
                    curl += ` \\\n  -H "${key}: ${escapedValue}"`;
                }
            });
        }
        
        // æ·»åŠ è¯·æ±‚ä½“ï¼ˆåªå¯¹POSTã€PUTã€PATCHç­‰æ–¹æ³•æ·»åŠ ï¼‰
        if (body && ['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
            if (typeof body === 'string') {
                // è½¬ä¹‰ï¼šå…ˆè½¬ä¹‰åæ–œæ ï¼Œå†è½¬ä¹‰å•å¼•å·ï¼ˆåœ¨å•å¼•å·å­—ç¬¦ä¸²ä¸­ï¼Œéœ€è¦ç»“æŸå•å¼•å·ã€æ·»åŠ \'ã€å†å¼€å§‹å•å¼•å·ï¼‰
                const escapedBody = body.replace(/\\/g, '\\\\').replace(/'/g, "'\\''");
                curl += ` \\\n  -d '${escapedBody}'`;
            }
        }
        
        // æ·»åŠ URLï¼ˆè½¬ä¹‰åŒå¼•å·ï¼‰
        const escapedUrl = url.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
        curl += ` \\\n  "${escapedUrl}"`;
        
        return curl;
    }
    
    // æ˜¾ç¤ºcurlå‘½ä»¤å¼¹çª—
    showCurlCommand(apiRequest) {
        if (!apiRequest) {
            console.warn('è¯·æ±‚æ¥å£æ•°æ®æ— æ•ˆï¼Œæ— æ³•æ˜¾ç¤ºcurlå‘½ä»¤:', apiRequest);
            return;
        }
        
        // ç”Ÿæˆcurlå‘½ä»¤
        const curlCommand = this.generateCurlCommand(apiRequest);
        
        // ç¡®ä¿chatWindowå­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åœ¨bodyä¸Šåˆ›å»º
        const container = this.chatWindow || document.body;
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨curlå‘½ä»¤å¼¹çª—
        let modal = container.querySelector('#pet-curl-command-viewer');
        if (!modal) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            modal = document.createElement('div');
            modal.id = 'pet-curl-command-viewer';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: rgba(0, 0, 0, 0.5) !important;
                display: none !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: ${PET_CONFIG.ui.zIndex.modal + 1} !important;
            `;
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // åˆ›å»ºé¢æ¿
            const panel = document.createElement('div');
            panel.style.cssText = `
                background: white !important;
                border-radius: 12px !important;
                padding: 28px !important;
                width: 95% !important;
                max-width: 1200px !important;
                max-height: 85vh !important;
                overflow-y: auto !important;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
            `;
            
            // æ ‡é¢˜æ 
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 20px !important;
            `;
            
            const title = document.createElement('h3');
            title.textContent = 'curl å‘½ä»¤';
            title.style.cssText = `
                margin: 0 !important;
                font-size: 18px !important;
                font-weight: 600 !important;
                color: #333 !important;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'curl-command-viewer-close';
            closeBtn.innerHTML = 'âœ•';
            closeBtn.title = 'å…³é—­ï¼ˆESCï¼‰';
            closeBtn.style.cssText = `
                background: none !important;
                border: none !important;
                font-size: 24px !important;
                cursor: pointer !important;
                color: #999 !important;
                padding: 0 !important;
                width: 30px !important;
                height: 30px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 4px !important;
                transition: all 0.2s ease !important;
            `;
            closeBtn.addEventListener('mouseenter', () => {
                closeBtn.style.background = '#f0f0f0';
                closeBtn.style.color = '#333';
            });
            closeBtn.addEventListener('mouseleave', () => {
                closeBtn.style.background = 'none';
                closeBtn.style.color = '#999';
            });
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            header.appendChild(title);
            header.appendChild(closeBtn);
            
            // curlå‘½ä»¤æ˜¾ç¤ºåŒºåŸŸ
            const curlContainer = document.createElement('div');
            curlContainer.style.cssText = `
                margin-bottom: 20px !important;
            `;
            
            const curlTextarea = document.createElement('textarea');
            curlTextarea.className = 'curl-command-textarea';
            curlTextarea.readOnly = true;
            curlTextarea.style.cssText = `
                width: 100% !important;
                min-height: 300px !important;
                padding: 16px !important;
                border: 1px solid #e5e7eb !important;
                border-radius: 8px !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace !important;
                font-size: 13px !important;
                line-height: 1.6 !important;
                color: #1f2937 !important;
                background: #f9fafb !important;
                resize: vertical !important;
                box-sizing: border-box !important;
            `;
            
            curlContainer.appendChild(curlTextarea);
            
            // åº•éƒ¨æŒ‰é’®æ 
            const footer = document.createElement('div');
            footer.style.cssText = `
                display: flex !important;
                justify-content: flex-end !important;
                gap: 12px !important;
                padding-top: 16px !important;
                border-top: 1px solid #e5e7eb !important;
            `;
            
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'å¤åˆ¶å‘½ä»¤';
            copyBtn.style.cssText = `
                padding: 10px 24px !important;
                border: none !important;
                border-radius: 8px !important;
                background: #3b82f6 !important;
                color: white !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
            `;
            copyBtn.addEventListener('mouseenter', () => {
                copyBtn.style.background = '#2563eb';
            });
            copyBtn.addEventListener('mouseleave', () => {
                copyBtn.style.background = '#3b82f6';
            });
            copyBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(curlCommand);
                    copyBtn.textContent = 'å·²å¤åˆ¶ï¼';
                    copyBtn.style.background = '#10b981';
                    setTimeout(() => {
                        copyBtn.textContent = 'å¤åˆ¶å‘½ä»¤';
                        copyBtn.style.background = '#3b82f6';
                    }, 2000);
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    // é™çº§æ–¹æ¡ˆï¼šé€‰ä¸­æ–‡æœ¬
                    curlTextarea.select();
                    document.execCommand('copy');
                    copyBtn.textContent = 'å·²å¤åˆ¶ï¼';
                    copyBtn.style.background = '#10b981';
                    setTimeout(() => {
                        copyBtn.textContent = 'å¤åˆ¶å‘½ä»¤';
                        copyBtn.style.background = '#3b82f6';
                    }, 2000);
                }
            });
            
            footer.appendChild(copyBtn);
            
            panel.appendChild(header);
            panel.appendChild(curlContainer);
            panel.appendChild(footer);
            modal.appendChild(panel);
            container.appendChild(modal);
        }
        
        // æ›´æ–°curlå‘½ä»¤å†…å®¹
        const curlTextarea = modal.querySelector('.curl-command-textarea');
        if (curlTextarea) {
            // å°† \\\n è½¬æ¢ä¸ºçœŸæ­£çš„æ¢è¡Œç¬¦ï¼Œä»¥ä¾¿åœ¨ textarea ä¸­æ­£ç¡®æ˜¾ç¤º
            curlTextarea.value = curlCommand.replace(/\\\n/g, '\n');
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'flex';
        
        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modal.style.display = 'none';
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
        // èšç„¦åˆ°textareaï¼Œæ–¹ä¾¿ç”¨æˆ·é€‰æ‹©æ–‡æœ¬
        if (curlTextarea) {
            setTimeout(() => {
                curlTextarea.focus();
                curlTextarea.select();
            }, 100);
        }
    }
    
    // æå–APIè·¯å¾„ï¼ˆä»å®Œæ•´URLä¸­æå–è·¯å¾„éƒ¨åˆ†ï¼‰
    _extractApiPath(url) {
        if (!url) return '';
        try {
            const urlObj = new URL(url);
            return urlObj.pathname + urlObj.search;
        } catch (e) {
            // å¦‚æœURLè§£æå¤±è´¥ï¼Œå°è¯•ç®€å•æå–
            const match = url.match(/\/\/[^\/]+(\/.*)/);
            return match ? match[1] : url;
        }
    }
    
    // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æ–°é—»é“¾æ¥
    openNewsLink(url) {
        try {
            if (!url) {
                this.showNotification('é“¾æ¥æ— æ•ˆ', 'error');
                return;
            }
            
            // éªŒè¯URLæ ¼å¼
            let validUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                validUrl = 'https://' + url;
            }
            
            // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€é“¾æ¥
            window.open(validUrl, '_blank');
            this.showNotification('æ­£åœ¨æ‰“å¼€é“¾æ¥...', 'success');
        } catch (error) {
            console.error('æ‰“å¼€é“¾æ¥å¤±è´¥:', error);
            this.showNotification('æ‰“å¼€é“¾æ¥å¤±è´¥', 'error');
        }
    }
    
    // å¤„ç†æ–°é—»ç¼–è¾‘æŒ‰é’®ç‚¹å‡»
    handleNewsEditButtonClick(newsItem, index) {
        this.openNewsEditModal(newsItem, index);
    }
    
    // å¤„ç†æ–°é—»æ ‡ç­¾æŒ‰é’®ç‚¹å‡»
    handleNewsTagButtonClick(newsItem, index) {
        this.openNewsTagManager(newsItem, index);
    }
    
    // æ‰“å¼€æ–°é—»ç¼–è¾‘æ¨¡æ€æ¡†
    openNewsEditModal(newsItem, index) {
        // ç¡®ä¿æ¨¡æ€æ¡†UIå­˜åœ¨
        this.ensureNewsEditModalUi();
        
        const modal = document.getElementById('pet-news-edit-modal');
        if (!modal) return;
        
        // å¡«å……å½“å‰æ–°é—»æ•°æ®
        const titleInput = modal.querySelector('#news-edit-title');
        const descriptionInput = modal.querySelector('#news-edit-description');
        const linkInput = modal.querySelector('#news-edit-link');
        const contentInput = modal.querySelector('#news-edit-content');
        
        if (titleInput) titleInput.value = newsItem.title || '';
        if (descriptionInput) descriptionInput.value = newsItem.description || '';
        if (linkInput) linkInput.value = newsItem.link || '';
        if (contentInput) contentInput.value = newsItem.content || '';
        
        // ä¿å­˜å½“å‰ç¼–è¾‘çš„æ–°é—»é¡¹
        modal.setAttribute('data-news-index', index);
        modal.setAttribute('data-news-key', newsItem.key || '');
        modal.setAttribute('data-news-link', newsItem.link || '');
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'flex';
        
        // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
        if (titleInput) {
            setTimeout(() => titleInput.focus(), 100);
        }
        
        // é”®ç›˜å¿«æ·é”®ï¼šEsc å…³é—­ï¼ŒCtrl+S / Cmd+S ä¿å­˜
        const keydownHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeNewsEditModal();
            } else if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const saveBtn = modal.querySelector('#news-edit-save-btn');
                if (saveBtn && !saveBtn.hasAttribute('data-saving')) {
                    saveBtn.click();
                }
            }
        };
        document.addEventListener('keydown', keydownHandler, { capture: true });
        modal._keydownHandler = keydownHandler;
    }
    
    // å…³é—­æ–°é—»ç¼–è¾‘æ¨¡æ€æ¡†
    closeNewsEditModal() {
        const modal = document.getElementById('pet-news-edit-modal');
        if (!modal) return;
        
        modal.style.display = 'none';
        
        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬
        if (modal._keydownHandler) {
            document.removeEventListener('keydown', modal._keydownHandler, { capture: true });
            modal._keydownHandler = null;
        }
        
        // æ¸…ç©ºæ•°æ®
        modal.removeAttribute('data-news-index');
        modal.removeAttribute('data-news-key');
        modal.removeAttribute('data-news-link');
    }
    
    // ä¼˜åŒ–æ–°é—»å­—æ®µï¼ˆæè¿°æˆ–å†…å®¹ï¼‰
    async optimizeNewsField(fieldType, inputElement) {
        if (!inputElement) return;
        
        const originalText = inputElement.value.trim();
        if (!originalText) {
            this.showNotification('è¯·å…ˆè¾“å…¥å†…å®¹', 'warning');
            return;
        }
        
        // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€åŠŸèƒ½
        if (!inputElement.hasAttribute('data-original-text')) {
            inputElement.setAttribute('data-original-text', originalText);
        }
        
        // è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€æè¿°ç­‰ï¼‰
        const modal = document.getElementById('pet-news-edit-modal');
        let title = '';
        let description = '';
        let content = '';
        
        if (modal) {
            const titleInput = modal.querySelector('#news-edit-title');
            const descriptionInput = modal.querySelector('#news-edit-description');
            const contentInput = modal.querySelector('#news-edit-content');
            
            title = titleInput ? titleInput.value.trim() : '';
            description = descriptionInput ? descriptionInput.value.trim() : '';
            content = contentInput ? contentInput.value.trim() : '';
        }
        
        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        // é€šè¿‡dataå±æ€§ç²¾ç¡®æŸ¥æ‰¾å¯¹åº”çš„ä¼˜åŒ–æŒ‰é’®
        const groupElement = inputElement.parentElement;
        const optimizeBtn = groupElement ? groupElement.querySelector(`button[data-optimize-field="${fieldType}"]`) : null;
        const originalBtnText = optimizeBtn ? optimizeBtn.textContent : '';
        if (optimizeBtn) {
            optimizeBtn.disabled = true;
            optimizeBtn.textContent = 'ä¼˜åŒ–ä¸­...';
            optimizeBtn.style.opacity = '0.6';
            optimizeBtn.style.cursor = 'not-allowed';
        }
        
        try {
            // æ„å»ºä¼˜åŒ–æç¤ºè¯ï¼ˆæ›´ä¸“ä¸šå’Œè¯¦ç»†ï¼‰
            let systemPrompt, userPrompt;
            if (fieldType === 'description') {
                systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–°é—»ç¼–è¾‘å’Œæ–‡æ¡ˆä¼˜åŒ–ä¸“å®¶ï¼Œæ“…é•¿ï¼š
1. æç‚¼æ–°é—»æ ¸å¿ƒè¦ç‚¹ï¼Œç”¨ç®€æ´æœ‰åŠ›çš„è¯­è¨€è¡¨è¾¾
2. ä¼˜åŒ–æ–‡æœ¬ç»“æ„ï¼Œä½¿å…¶é€»è¾‘æ¸…æ™°ã€å±‚æ¬¡åˆ†æ˜
3. æå‡æ–‡æœ¬å¸å¼•åŠ›ï¼Œå¢å¼ºå¯è¯»æ€§å’Œä¼ æ’­åŠ›
4. ä¿æŒå®¢è§‚ä¸­ç«‹çš„æ–°é—»è¯­è°ƒ
5. ç¡®ä¿ä¿¡æ¯å‡†ç¡®å®Œæ•´ï¼Œä¸é—æ¼å…³é”®ä¿¡æ¯

è¯·æ ¹æ®æ–°é—»æ ‡é¢˜å’Œå†…å®¹ï¼Œä¼˜åŒ–æ–°é—»æè¿°ï¼Œä½¿å…¶æ›´åŠ ç®€æ´ã€å‡†ç¡®ã€å¸å¼•äººã€‚`;
                
                // æ„å»ºåŒ…å«ä¸Šä¸‹æ–‡çš„ç”¨æˆ·æç¤ºè¯
                let contextInfo = '';
                if (title) {
                    contextInfo += `æ–°é—»æ ‡é¢˜ï¼š${title}\n\n`;
                }
                if (content && content !== originalText) {
                    contextInfo += `æ–°é—»å†…å®¹æ‘˜è¦ï¼š${content.substring(0, 500)}${content.length > 500 ? '...' : ''}\n\n`;
                }
                
                userPrompt = `${contextInfo}è¯·ä¼˜åŒ–ä»¥ä¸‹æ–°é—»æè¿°ï¼Œè¦æ±‚ï¼š
1. ä¿æŒ50-200å­—å·¦å³ï¼Œç®€æ´æœ‰åŠ›
2. çªå‡ºæ–°é—»çš„æ ¸å¿ƒè¦ç‚¹å’Œå…³é”®ä¿¡æ¯
3. è¯­è¨€æµç•…è‡ªç„¶ï¼Œæ˜“äºç†è§£
4. ä¿æŒå®¢è§‚ä¸­ç«‹çš„æ–°é—»è¯­è°ƒ
5. é¿å…å†—ä½™å’Œé‡å¤è¡¨è¾¾

åŸå§‹æè¿°ï¼š
${originalText}

è¯·ç›´æ¥è¿”å›ä¼˜åŒ–åçš„æè¿°ï¼Œä¸è¦åŒ…å«ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°ã€‚`;
                
            } else if (fieldType === 'content') {
                systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–°é—»ç¼–è¾‘å’Œå†…å®¹ä¼˜åŒ–ä¸“å®¶ï¼Œæ“…é•¿ï¼š
1. ä¼˜åŒ–æ–‡ç« ç»“æ„å’Œæ®µè½ç»„ç»‡ï¼Œä½¿é€»è¾‘æ¸…æ™°
2. æ”¹è¿›è¯­è¨€è¡¨è¾¾ï¼Œä½¿å…¶æ›´åŠ æµç•…è‡ªç„¶
3. æå‡å¯è¯»æ€§ï¼Œä½¿å†…å®¹æ˜“äºç†è§£å’Œä¼ æ’­
4. ä¿æŒåŸæ–‡çš„æ ¸å¿ƒè§‚ç‚¹å’Œä¿¡æ¯å®Œæ•´æ€§
5. ä¼˜åŒ–å¥å¼ï¼Œé¿å…å†—é•¿å’Œé‡å¤
6. ç¡®ä¿æ®µè½ä¹‹é—´çš„è¿è´¯æ€§å’Œè¿‡æ¸¡è‡ªç„¶

è¯·æ ¹æ®æ–°é—»æ ‡é¢˜å’Œæè¿°ï¼Œä¼˜åŒ–æ–°é—»å†…å®¹ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°ã€æµç•…ã€æ˜“è¯»ã€‚`;
                
                // æ„å»ºåŒ…å«ä¸Šä¸‹æ–‡çš„ç”¨æˆ·æç¤ºè¯
                let contextInfo = '';
                if (title) {
                    contextInfo += `æ–°é—»æ ‡é¢˜ï¼š${title}\n\n`;
                }
                if (description && description !== originalText) {
                    contextInfo += `æ–°é—»æè¿°ï¼š${description}\n\n`;
                }
                
                userPrompt = `${contextInfo}è¯·ä¼˜åŒ–ä»¥ä¸‹æ–°é—»å†…å®¹ï¼Œè¦æ±‚ï¼š
1. ä¿æŒåŸæ–‡çš„æ ¸å¿ƒä¿¡æ¯å’Œè§‚ç‚¹ä¸å˜
2. ä¼˜åŒ–æ®µè½ç»“æ„ï¼Œä½¿é€»è¾‘æ›´æ¸…æ™°
3. æ”¹è¿›è¯­è¨€è¡¨è¾¾ï¼Œä½¿å…¶æ›´åŠ æµç•…è‡ªç„¶
4. æå‡å¯è¯»æ€§ï¼Œä½¿å†…å®¹æ˜“äºç†è§£
5. ä¼˜åŒ–å¥å¼ï¼Œé¿å…å†—é•¿å’Œé‡å¤
6. ç¡®ä¿æ®µè½ä¹‹é—´çš„è¿è´¯æ€§

åŸå§‹å†…å®¹ï¼š
${originalText}

è¯·ç›´æ¥è¿”å›ä¼˜åŒ–åçš„å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°ã€‚`;
            } else {
                throw new Error('æœªçŸ¥çš„å­—æ®µç±»å‹');
            }
            
            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            this._showLoadingAnimation();
            
            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // å…ˆè·å–æ–‡æœ¬å“åº”ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼
            const responseText = await response.text();
            let result;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
            if (responseText.includes('data: ')) {
                // å¤„ç†SSEæµå¼å“åº”
                const lines = responseText.split('\n');
                let accumulatedData = '';
                let lastValidData = null;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ')) {
                        try {
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr === '[DONE]' || dataStr === '') {
                                continue;
                            }
                            
                            // å°è¯•è§£æJSON
                            const chunk = JSON.parse(dataStr);
                            
                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            if (chunk.done === true) {
                                break;
                            }
                            
                            // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                            if (chunk.data) {
                                accumulatedData += chunk.data;
                            } else if (chunk.content) {
                                accumulatedData += chunk.content;
                            } else if (chunk.message && chunk.message.content) {
                                // Ollamaæ ¼å¼
                                accumulatedData += chunk.message.content;
                            } else if (typeof chunk === 'string') {
                                accumulatedData += chunk;
                            }
                            
                            // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                            lastValidData = chunk;
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr && dataStr !== '[DONE]') {
                                accumulatedData += dataStr;
                            }
                        }
                    }
                }
                
                // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                if (accumulatedData || lastValidData) {
                    if (lastValidData && lastValidData.status) {
                        // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                        result = {
                            ...lastValidData,
                            data: accumulatedData || lastValidData.data || '',
                            content: accumulatedData || lastValidData.content || ''
                        };
                    } else {
                        // å¦åˆ™åˆ›å»ºæ–°çš„ç»“æœå¯¹è±¡
                        result = {
                            data: accumulatedData,
                            content: accumulatedData
                        };
                    }
                } else {
                    // å¦‚æœæ— æ³•è§£æSSEæ ¼å¼ï¼Œå°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                    }
                }
            } else {
                // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº”: ${e.message}`);
                }
            }
            
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            
            // è§£æå“åº”å†…å®¹
            let optimizedText;
            // ä¼˜å…ˆæ£€æŸ¥ status å­—æ®µï¼Œå¦‚æœå­˜åœ¨ä¸”ä¸ç­‰äº 200ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
            if (result.status !== undefined && result.status !== 200) {
                throw new Error(result.msg || result.message || 'ä¼˜åŒ–å¤±è´¥');
            }
            
            // æŒ‰ä¼˜å…ˆçº§æå–ä¼˜åŒ–åçš„æ–‡æœ¬
            if (result.data) {
                optimizedText = result.data;
            } else if (result.content) {
                optimizedText = result.content;
            } else if (result.message) {
                optimizedText = result.message;
            } else if (typeof result === 'string') {
                optimizedText = result;
            } else if (result.text) {
                optimizedText = result.text;
            } else {
                // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ä¸å­˜åœ¨ï¼Œå°è¯•ä»å¯¹è±¡ä¸­æŸ¥æ‰¾å¯èƒ½çš„æ–‡æœ¬å­—æ®µ
                const possibleFields = ['output', 'response', 'result', 'answer'];
                for (const field of possibleFields) {
                    if (result[field] && typeof result[field] === 'string') {
                        optimizedText = result[field];
                        break;
                    }
                }
                
                // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯
                if (!optimizedText) {
                    console.error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œå“åº”å¯¹è±¡:', result);
                    throw new Error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨å“åº”æ ¼å¼');
                }
            }
            
            // æ¸…ç†ä¼˜åŒ–åçš„æ–‡æœ¬ï¼ˆæ›´å½»åº•çš„æ¸…ç†ï¼‰
            optimizedText = optimizedText.trim();
            
            // ç§»é™¤å¯èƒ½çš„å¼•å·åŒ…è£¹ï¼ˆæ”¯æŒå¤šç§å¼•å·ç±»å‹ï¼‰
            const quotePairs = [
                ['"', '"'],
                ['"', '"'],
                ['"', '"'],
                ["'", "'"],
                ['`', '`'],
                ['ã€Œ', 'ã€'],
                ['ã€', 'ã€']
            ];
            
            for (const [startQuote, endQuote] of quotePairs) {
                if (optimizedText.startsWith(startQuote) && optimizedText.endsWith(endQuote)) {
                    optimizedText = optimizedText.slice(startQuote.length, -endQuote.length).trim();
                }
            }
            
            // ç§»é™¤å¸¸è§çš„AIå›å¤å‰ç¼€ï¼ˆå¦‚"ä¼˜åŒ–åçš„æè¿°ï¼š"ã€"ä¼˜åŒ–åçš„å†…å®¹ï¼š"ç­‰ï¼‰
            const prefixes = [
                /^ä¼˜åŒ–åçš„[æè¿°å†…å®¹]ï¼š?\s*/i,
                /^ä»¥ä¸‹æ˜¯ä¼˜åŒ–åçš„[æè¿°å†…å®¹]ï¼š?\s*/i,
                /^ä¼˜åŒ–ç»“æœï¼š?\s*/i,
                /^ä¼˜åŒ–åçš„æ–‡æœ¬ï¼š?\s*/i,
                /^ä¼˜åŒ–åçš„[æè¿°å†…å®¹]å¦‚ä¸‹ï¼š?\s*/i,
                /^[æè¿°å†…å®¹]ä¼˜åŒ–å¦‚ä¸‹ï¼š?\s*/i
            ];
            
            for (const prefix of prefixes) {
                optimizedText = optimizedText.replace(prefix, '').trim();
            }
            
            // å»é™¤ HTML æ ‡ç­¾å’Œ Markdown æ ¼å¼æ ‡è®°
            optimizedText = optimizedText.replace(/<[^>]*>/g, ''); // ç§»é™¤HTMLæ ‡ç­¾
            optimizedText = optimizedText.replace(/```[\s\S]*?```/g, ''); // ç§»é™¤ä»£ç å—
            optimizedText = optimizedText.replace(/`[^`]+`/g, ''); // ç§»é™¤è¡Œå†…ä»£ç 
            optimizedText = optimizedText.replace(/^\s*[-*+]\s+/gm, ''); // ç§»é™¤åˆ—è¡¨æ ‡è®°
            optimizedText = optimizedText.replace(/^\s*\d+\.\s+/gm, ''); // ç§»é™¤æœ‰åºåˆ—è¡¨æ ‡è®°
            optimizedText = optimizedText.replace(/^#{1,6}\s+/gm, ''); // ç§»é™¤æ ‡é¢˜æ ‡è®°
            optimizedText = optimizedText.replace(/\*\*([^*]+)\*\*/g, '$1'); // ç§»é™¤ç²—ä½“æ ‡è®°
            optimizedText = optimizedText.replace(/\*([^*]+)\*/g, '$1'); // ç§»é™¤æ–œä½“æ ‡è®°
            optimizedText = optimizedText.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1'); // ç§»é™¤é“¾æ¥æ ‡è®°ï¼Œä¿ç•™æ–‡æœ¬
            
            // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦
            optimizedText = optimizedText.replace(/\n{3,}/g, '\n\n'); // å¤šä¸ªæ¢è¡Œç¬¦åˆå¹¶ä¸ºä¸¤ä¸ª
            optimizedText = optimizedText.replace(/[ \t]+/g, ' '); // å¤šä¸ªç©ºæ ¼åˆå¹¶ä¸ºä¸€ä¸ª
            optimizedText = optimizedText.trim();
            
            // éªŒè¯ä¼˜åŒ–åçš„æ–‡æœ¬æ˜¯å¦æœ‰æ•ˆ
            if (!optimizedText || optimizedText.length < 5) {
                throw new Error('ä¼˜åŒ–åçš„æ–‡æœ¬è¿‡çŸ­ï¼Œå¯èƒ½ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            
            // å¦‚æœä¼˜åŒ–åçš„æ–‡æœ¬ä¸åŸæ–‡å®Œå…¨ç›¸åŒï¼Œç»™å‡ºæç¤º
            if (optimizedText === originalText) {
                this.showNotification('ä¼˜åŒ–åçš„å†…å®¹ä¸åŸæ–‡ç›¸åŒ', 'info');
            }
            
            // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
            inputElement.value = optimizedText;
            
            // ä¿å­˜ä¼˜åŒ–åçš„æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€åŠŸèƒ½
            inputElement.setAttribute('data-optimized-text', optimizedText);
            
            // è§¦å‘ input äº‹ä»¶ï¼Œç¡®ä¿å€¼è¢«æ­£ç¡®æ›´æ–°
            inputElement.dispatchEvent(new Event('input', { bubbles: true }));
            
            // æ˜¾ç¤ºæ’¤é”€æŒ‰é’®
            const undoBtn = groupElement ? groupElement.querySelector(`button[data-undo-field="${fieldType}"]`) : null;
            if (undoBtn) {
                undoBtn.style.display = 'block';
            }
            
            // æ˜¾ç¤ºä¼˜åŒ–å®Œæˆé€šçŸ¥ï¼ŒåŒ…å«å­—ç¬¦æ•°ä¿¡æ¯
            const charCount = optimizedText.length;
            const originalCharCount = originalText.length;
            const changeInfo = charCount !== originalCharCount 
                ? `ï¼ˆ${originalCharCount}å­— â†’ ${charCount}å­—ï¼‰` 
                : `ï¼ˆ${charCount}å­—ï¼‰`;
            this.showNotification(`ä¼˜åŒ–å®Œæˆ ${changeInfo}`, 'success');
        } catch (error) {
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            console.error('ä¼˜åŒ–æ–°é—»å­—æ®µå¤±è´¥:', error);
            
            // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            let errorMessage = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            if (error.message) {
                if (error.message.includes('HTTP error')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message.includes('æ— æ³•è§£æ')) {
                    errorMessage = 'æœåŠ¡å™¨å“åº”æ ¼å¼å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('è¿‡çŸ­')) {
                    errorMessage = error.message;
                } else {
                    errorMessage = error.message;
                }
            }
            
            this.showNotification(errorMessage, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (optimizeBtn) {
                optimizeBtn.disabled = false;
                optimizeBtn.textContent = originalBtnText;
                optimizeBtn.style.opacity = '1';
                optimizeBtn.style.cursor = 'pointer';
            }
        }
    }
    
    // ä¼˜åŒ–é¡µé¢ä¸Šä¸‹æ–‡å†…å®¹
    async optimizeContext() {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
        if (!textarea) return;
        
        const originalText = textarea.value.trim();
        if (!originalText) {
            this.showNotification('è¯·å…ˆè¾“å…¥å†…å®¹', 'warning');
            return;
        }
        
        // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€åŠŸèƒ½
        if (!textarea.hasAttribute('data-original-text')) {
            textarea.setAttribute('data-original-text', originalText);
        }
        
        // è·å–ä¼˜åŒ–æŒ‰é’®å’Œæ’¤é”€æŒ‰é’®
        const optimizeBtn = this.chatWindow ? this.chatWindow.querySelector('#pet-context-optimize-btn') : null;
        const undoBtn = this.chatWindow ? this.chatWindow.querySelector('#pet-context-undo-btn') : null;
        const originalBtnText = optimizeBtn ? optimizeBtn.textContent : '';
        
        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (optimizeBtn) {
            optimizeBtn.disabled = true;
            optimizeBtn.textContent = 'ä¼˜åŒ–ä¸­...';
            optimizeBtn.style.opacity = '0.6';
            optimizeBtn.style.cursor = 'not-allowed';
        }
        
        try {
            // æ„å»ºä¼˜åŒ–æç¤ºè¯
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Markdownæ–‡æ¡£ä¼˜åŒ–ä¸“å®¶ï¼Œæ“…é•¿ï¼š
1. ä¼˜åŒ–æ–‡æ¡£ç»“æ„å’Œå±‚æ¬¡ï¼Œä½¿å…¶é€»è¾‘æ¸…æ™°ã€å±‚æ¬¡åˆ†æ˜
2. æ”¹è¿›è¯­è¨€è¡¨è¾¾ï¼Œä½¿å…¶æ›´åŠ æµç•…è‡ªç„¶ã€æ˜“äºç†è§£
3. æå‡å¯è¯»æ€§ï¼Œä¼˜åŒ–æ®µè½ç»„ç»‡å’Œè¿‡æ¸¡
4. ä¿æŒåŸæ–‡çš„æ ¸å¿ƒä¿¡æ¯å’Œå®Œæ•´æ€§
5. ä¼˜åŒ–Markdownæ ¼å¼ï¼Œä½¿å…¶æ›´åŠ è§„èŒƒå’Œç¾è§‚
6. ç¡®ä¿æ–‡æ¡£ç»“æ„åˆç†ï¼Œæ ‡é¢˜å±‚çº§æ¸…æ™°

è¯·ä¼˜åŒ–Markdownæ ¼å¼çš„é¡µé¢ä¸Šä¸‹æ–‡å†…å®¹ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°ã€æµç•…ã€æ˜“è¯»ã€‚`;

            const userPrompt = `è¯·ä¼˜åŒ–ä»¥ä¸‹Markdownæ ¼å¼çš„é¡µé¢ä¸Šä¸‹æ–‡å†…å®¹ï¼Œè¦æ±‚ï¼š
1. ä¿æŒåŸæ–‡çš„æ ¸å¿ƒä¿¡æ¯å’Œå®Œæ•´æ€§
2. ä¼˜åŒ–æ–‡æ¡£ç»“æ„ï¼Œä½¿é€»è¾‘æ›´æ¸…æ™°ã€å±‚æ¬¡æ›´åˆ†æ˜
3. æ”¹è¿›è¯­è¨€è¡¨è¾¾ï¼Œä½¿å…¶æ›´åŠ æµç•…è‡ªç„¶
4. æå‡å¯è¯»æ€§ï¼Œä¼˜åŒ–æ®µè½ç»„ç»‡å’Œè¿‡æ¸¡
5. ä¼˜åŒ–Markdownæ ¼å¼ï¼Œä½¿å…¶æ›´åŠ è§„èŒƒå’Œç¾è§‚
6. ç¡®ä¿æ ‡é¢˜å±‚çº§æ¸…æ™°ï¼Œæ®µè½ä¹‹é—´è¿‡æ¸¡è‡ªç„¶
7. ä¿æŒMarkdownæ ¼å¼çš„æœ‰æ•ˆæ€§

åŸå§‹å†…å®¹ï¼š
${originalText}

è¯·ç›´æ¥è¿”å›ä¼˜åŒ–åçš„Markdownå†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°ã€‚`;
            
            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            this._showLoadingAnimation();
            
            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // å…ˆè·å–æ–‡æœ¬å“åº”ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼
            const responseText = await response.text();
            let result;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
            if (responseText.includes('data: ')) {
                // å¤„ç†SSEæµå¼å“åº”
                const lines = responseText.split('\n');
                let accumulatedData = '';
                let lastValidData = null;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ')) {
                        try {
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr === '[DONE]' || dataStr === '') {
                                continue;
                            }
                            
                            // å°è¯•è§£æJSON
                            const chunk = JSON.parse(dataStr);
                            
                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            if (chunk.done === true) {
                                break;
                            }
                            
                            // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                            if (chunk.data) {
                                accumulatedData += chunk.data;
                            } else if (chunk.content) {
                                accumulatedData += chunk.content;
                            } else if (chunk.message && chunk.message.content) {
                                // Ollamaæ ¼å¼
                                accumulatedData += chunk.message.content;
                            } else if (typeof chunk === 'string') {
                                accumulatedData += chunk;
                            }
                            
                            // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                            lastValidData = chunk;
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr && dataStr !== '[DONE]') {
                                accumulatedData += dataStr;
                            }
                        }
                    }
                }
                
                // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                if (accumulatedData || lastValidData) {
                    if (lastValidData && lastValidData.status) {
                        // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                        result = {
                            ...lastValidData,
                            data: accumulatedData || lastValidData.data || '',
                            content: accumulatedData || lastValidData.content || ''
                        };
                    } else {
                        result = {
                            data: accumulatedData,
                            content: accumulatedData
                        };
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ç´¯ç§¯æ•°æ®ï¼Œå°è¯•è§£æä¸ºJSON
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                    }
                }
            } else {
                // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº”: ${e.message}`);
                }
            }
            
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            
            // è§£æå“åº”å†…å®¹
            let optimizedText;
            // ä¼˜å…ˆæ£€æŸ¥ status å­—æ®µï¼Œå¦‚æœå­˜åœ¨ä¸”ä¸ç­‰äº 200ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
            if (result.status !== undefined && result.status !== 200) {
                throw new Error(result.msg || result.message || 'ä¼˜åŒ–å¤±è´¥');
            }
            
            // æŒ‰ä¼˜å…ˆçº§æå–ä¼˜åŒ–åçš„æ–‡æœ¬
            if (result.data) {
                optimizedText = result.data;
            } else if (result.content) {
                optimizedText = result.content;
            } else if (result.message) {
                optimizedText = result.message;
            } else if (typeof result === 'string') {
                optimizedText = result;
            } else if (result.text) {
                optimizedText = result.text;
            } else {
                // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ä¸å­˜åœ¨ï¼Œå°è¯•ä»å¯¹è±¡ä¸­æŸ¥æ‰¾å¯èƒ½çš„æ–‡æœ¬å­—æ®µ
                const possibleFields = ['output', 'response', 'result', 'answer'];
                for (const field of possibleFields) {
                    if (result[field] && typeof result[field] === 'string') {
                        optimizedText = result[field];
                        break;
                    }
                }
                
                // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯
                if (!optimizedText) {
                    console.error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œå“åº”å¯¹è±¡:', result);
                    throw new Error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨å“åº”æ ¼å¼');
                }
            }
            
            // æ¸…ç†ä¼˜åŒ–åçš„æ–‡æœ¬ï¼ˆæ›´å½»åº•çš„æ¸…ç†ï¼‰
            optimizedText = optimizedText.trim();
            
            // ç§»é™¤å¯èƒ½çš„å¼•å·åŒ…è£¹ï¼ˆæ”¯æŒå¤šç§å¼•å·ç±»å‹ï¼‰
            const quotePairs = [
                ['"', '"'],
                ['"', '"'],
                ['"', '"'],
                ["'", "'"],
                ['`', '`'],
                ['ã€Œ', 'ã€'],
                ['ã€', 'ã€']
            ];
            
            for (const [startQuote, endQuote] of quotePairs) {
                if (optimizedText.startsWith(startQuote) && optimizedText.endsWith(endQuote)) {
                    optimizedText = optimizedText.slice(startQuote.length, -endQuote.length).trim();
                }
            }
            
            // ç§»é™¤å¸¸è§çš„AIå›å¤å‰ç¼€ï¼ˆå¦‚"ä¼˜åŒ–åçš„å†…å®¹ï¼š"ç­‰ï¼‰
            const prefixes = [
                /^ä¼˜åŒ–åçš„[å†…å®¹ä¸Šä¸‹æ–‡]ï¼š?\s*/i,
                /^ä»¥ä¸‹æ˜¯ä¼˜åŒ–åçš„[å†…å®¹ä¸Šä¸‹æ–‡]ï¼š?\s*/i,
                /^ä¼˜åŒ–ç»“æœï¼š?\s*/i,
                /^ä¼˜åŒ–åçš„æ–‡æœ¬ï¼š?\s*/i,
                /^ä¼˜åŒ–åçš„[å†…å®¹ä¸Šä¸‹æ–‡]å¦‚ä¸‹ï¼š?\s*/i,
                /^[å†…å®¹ä¸Šä¸‹æ–‡]ä¼˜åŒ–å¦‚ä¸‹ï¼š?\s*/i
            ];
            
            for (const prefix of prefixes) {
                optimizedText = optimizedText.replace(prefix, '').trim();
            }
            
            // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦ï¼ˆä½†ä¿ç•™Markdownæ ¼å¼ï¼‰
            optimizedText = optimizedText.replace(/\n{4,}/g, '\n\n\n'); // å¤šä¸ªæ¢è¡Œç¬¦åˆå¹¶ä¸ºä¸‰ä¸ªï¼ˆä¿ç•™Markdownæ®µè½é—´è·ï¼‰
            optimizedText = optimizedText.replace(/[ \t]+/g, ' '); // å¤šä¸ªç©ºæ ¼åˆå¹¶ä¸ºä¸€ä¸ªï¼ˆä½†ä¿ç•™ä»£ç å—ä¸­çš„ç©ºæ ¼ï¼‰
            optimizedText = optimizedText.trim();
            
            // éªŒè¯ä¼˜åŒ–åçš„æ–‡æœ¬æ˜¯å¦æœ‰æ•ˆ
            if (!optimizedText || optimizedText.length < 10) {
                throw new Error('ä¼˜åŒ–åçš„æ–‡æœ¬è¿‡çŸ­ï¼Œå¯èƒ½ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            
            // å¦‚æœä¼˜åŒ–åçš„æ–‡æœ¬ä¸åŸæ–‡å®Œå…¨ç›¸åŒï¼Œç»™å‡ºæç¤º
            if (optimizedText === originalText) {
                this.showNotification('ä¼˜åŒ–åçš„å†…å®¹ä¸åŸæ–‡ç›¸åŒ', 'info');
            }
            
            // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
            textarea.value = optimizedText;
            
            // ä¿å­˜ä¼˜åŒ–åçš„æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€åŠŸèƒ½
            textarea.setAttribute('data-optimized-text', optimizedText);
            
            // è§¦å‘ input äº‹ä»¶ï¼Œç¡®ä¿å€¼è¢«æ­£ç¡®æ›´æ–°å¹¶æ›´æ–°é¢„è§ˆ
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            
            // æ˜¾ç¤ºæ’¤é”€æŒ‰é’®
            if (undoBtn) {
                undoBtn.style.display = 'block';
            }
            
            // æ˜¾ç¤ºä¼˜åŒ–å®Œæˆé€šçŸ¥ï¼ŒåŒ…å«å­—ç¬¦æ•°ä¿¡æ¯
            const charCount = optimizedText.length;
            const originalCharCount = originalText.length;
            const changeInfo = charCount !== originalCharCount 
                ? `ï¼ˆ${originalCharCount}å­— â†’ ${charCount}å­—ï¼‰` 
                : `ï¼ˆ${charCount}å­—ï¼‰`;
            this.showNotification(`ä¼˜åŒ–å®Œæˆ ${changeInfo}`, 'success');
        } catch (error) {
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            console.error('ä¼˜åŒ–ä¸Šä¸‹æ–‡å¤±è´¥:', error);
            
            // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            let errorMessage = 'ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            if (error.message) {
                if (error.message.includes('HTTP error')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message.includes('æ— æ³•è§£æ')) {
                    errorMessage = 'æœåŠ¡å™¨å“åº”æ ¼å¼å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('è¿‡çŸ­')) {
                    errorMessage = error.message;
                } else {
                    errorMessage = error.message;
                }
            }
            
            this.showNotification(errorMessage, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (optimizeBtn) {
                optimizeBtn.disabled = false;
                optimizeBtn.textContent = originalBtnText;
                optimizeBtn.style.opacity = '1';
                optimizeBtn.style.cursor = 'pointer';
            }
        }
    }

    /**
     * ç¿»è¯‘ä¸Šä¸‹æ–‡å†…å®¹
     * @param {string} targetLang - ç›®æ ‡è¯­è¨€ 'zh' æˆ– 'en'
     */
    async translateContext(targetLang) {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
        if (!textarea) return;
        
        const originalText = textarea.value.trim();
        if (!originalText) {
            this.showNotification('è¯·å…ˆè¾“å…¥å†…å®¹', 'warning');
            return;
        }
        
        // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€åŠŸèƒ½
        if (!textarea.hasAttribute('data-original-text')) {
            textarea.setAttribute('data-original-text', originalText);
        }
        
        // è·å–ç¿»è¯‘æŒ‰é’®
        const translateZhBtn = this.chatWindow ? this.chatWindow.querySelector('#pet-context-translate-zh-btn') : null;
        const translateEnBtn = this.chatWindow ? this.chatWindow.querySelector('#pet-context-translate-en-btn') : null;
        const targetBtn = targetLang === 'zh' ? translateZhBtn : translateEnBtn;
        const originalBtnText = targetBtn ? targetBtn.textContent : '';
        
        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (translateZhBtn) {
            translateZhBtn.disabled = true;
            translateZhBtn.setAttribute('data-translating', 'true');
            if (targetLang === 'zh') {
                translateZhBtn.textContent = 'ç¿»è¯‘ä¸­...';
            }
            translateZhBtn.style.opacity = '0.6';
            translateZhBtn.style.cursor = 'not-allowed';
        }
        if (translateEnBtn) {
            translateEnBtn.disabled = true;
            translateEnBtn.setAttribute('data-translating', 'true');
            if (targetLang === 'en') {
                translateEnBtn.textContent = 'ç¿»è¯‘ä¸­...';
            }
            translateEnBtn.style.opacity = '0.6';
            translateEnBtn.style.cursor = 'not-allowed';
        }
        
        try {
            // æ„å»ºç¿»è¯‘æç¤ºè¯
            const targetLanguage = targetLang === 'zh' ? 'ä¸­æ–‡' : 'è‹±æ–‡';
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘ä¸“å®¶ï¼Œæ“…é•¿å°†å„ç§è¯­è¨€çš„å†…å®¹å‡†ç¡®ã€æµç•…åœ°ç¿»è¯‘æˆ${targetLanguage}ã€‚è¯·ä¿æŒåŸæ–‡çš„æ ¼å¼ã€ç»“æ„å’Œè¯­ä¹‰ï¼Œç¡®ä¿ç¿»è¯‘å‡†ç¡®ã€è‡ªç„¶ã€æµç•…ã€‚`;
            
            const userPrompt = `è¯·å°†ä»¥ä¸‹å†…å®¹ç¿»è¯‘æˆ${targetLanguage}ï¼Œè¦æ±‚ï¼š
1. ä¿æŒåŸæ–‡çš„æ ¼å¼å’Œç»“æ„ï¼ˆåŒ…æ‹¬Markdownæ ¼å¼ï¼‰
2. ç¿»è¯‘å‡†ç¡®ã€è‡ªç„¶ã€æµç•…
3. ä¿æŒä¸“ä¸šæœ¯è¯­çš„å‡†ç¡®æ€§
4. ä¸è¦æ·»åŠ ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°
5. ç›´æ¥è¿”å›ç¿»è¯‘åçš„å†…å®¹

åŸæ–‡å†…å®¹ï¼š
${originalText}

è¯·ç›´æ¥è¿”å›ç¿»è¯‘åçš„${targetLanguage}å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°ã€‚`;
            
            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            this._showLoadingAnimation();
            
            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // å…ˆè·å–æ–‡æœ¬å“åº”ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼
            const responseText = await response.text();
            let result;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
            if (responseText.includes('data: ')) {
                // å¤„ç†SSEæµå¼å“åº”
                const lines = responseText.split('\n');
                let accumulatedData = '';
                let lastValidData = null;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ')) {
                        try {
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr === '[DONE]' || dataStr === '') {
                                continue;
                            }
                            
                            // å°è¯•è§£æJSON
                            const chunk = JSON.parse(dataStr);
                            
                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            if (chunk.done === true) {
                                break;
                            }
                            
                            // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                            if (chunk.data) {
                                accumulatedData += chunk.data;
                            } else if (chunk.content) {
                                accumulatedData += chunk.content;
                            } else if (chunk.message && chunk.message.content) {
                                // Ollamaæ ¼å¼
                                accumulatedData += chunk.message.content;
                            } else if (typeof chunk === 'string') {
                                accumulatedData += chunk;
                            }
                            
                            // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                            lastValidData = chunk;
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr && dataStr !== '[DONE]') {
                                accumulatedData += dataStr;
                            }
                        }
                    }
                }
                
                // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                if (accumulatedData || lastValidData) {
                    if (lastValidData && lastValidData.status) {
                        // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                        result = {
                            ...lastValidData,
                            data: accumulatedData || lastValidData.data || '',
                            content: accumulatedData || lastValidData.content || ''
                        };
                    } else {
                        result = {
                            data: accumulatedData,
                            content: accumulatedData
                        };
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ç´¯ç§¯æ•°æ®ï¼Œå°è¯•è§£æä¸ºJSON
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                    }
                }
            } else {
                // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº”: ${e.message}`);
                }
            }
            
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            
            // è§£æå“åº”å†…å®¹
            let translatedText;
            // ä¼˜å…ˆæ£€æŸ¥ status å­—æ®µï¼Œå¦‚æœå­˜åœ¨ä¸”ä¸ç­‰äº 200ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
            if (result.status !== undefined && result.status !== 200) {
                throw new Error(result.msg || result.message || 'ç¿»è¯‘å¤±è´¥');
            }
            
            // æŒ‰ä¼˜å…ˆçº§æå–ç¿»è¯‘åçš„æ–‡æœ¬
            if (result.data) {
                translatedText = result.data;
            } else if (result.content) {
                translatedText = result.content;
            } else if (result.message) {
                translatedText = result.message;
            } else if (typeof result === 'string') {
                translatedText = result;
            } else if (result.text) {
                translatedText = result.text;
            } else {
                // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ä¸å­˜åœ¨ï¼Œå°è¯•ä»å¯¹è±¡ä¸­æŸ¥æ‰¾å¯èƒ½çš„æ–‡æœ¬å­—æ®µ
                const possibleFields = ['output', 'response', 'result', 'answer'];
                for (const field of possibleFields) {
                    if (result[field] && typeof result[field] === 'string') {
                        translatedText = result[field];
                        break;
                    }
                }
                
                // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯
                if (!translatedText) {
                    console.error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œå“åº”å¯¹è±¡:', result);
                    throw new Error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨å“åº”æ ¼å¼');
                }
            }
            
            // æ¸…ç†ç¿»è¯‘åçš„æ–‡æœ¬ï¼ˆæ›´å½»åº•çš„æ¸…ç†ï¼‰
            translatedText = translatedText.trim();
            
            // ç§»é™¤å¯èƒ½çš„å¼•å·åŒ…è£¹ï¼ˆæ”¯æŒå¤šç§å¼•å·ç±»å‹ï¼‰
            const quotePairs = [
                ['"', '"'],
                ['"', '"'],
                ['"', '"'],
                ["'", "'"],
                ['`', '`'],
                ['ã€Œ', 'ã€'],
                ['ã€', 'ã€']
            ];
            
            for (const [startQuote, endQuote] of quotePairs) {
                if (translatedText.startsWith(startQuote) && translatedText.endsWith(endQuote)) {
                    translatedText = translatedText.slice(startQuote.length, -endQuote.length).trim();
                }
            }
            
            // ç§»é™¤å¸¸è§çš„AIå›å¤å‰ç¼€
            const prefixes = [
                /^ç¿»è¯‘åçš„[å†…å®¹ä¸Šä¸‹æ–‡]ï¼š?\s*/i,
                /^ä»¥ä¸‹æ˜¯ç¿»è¯‘åçš„[å†…å®¹ä¸Šä¸‹æ–‡]ï¼š?\s*/i,
                /^ç¿»è¯‘ç»“æœï¼š?\s*/i,
                /^ç¿»è¯‘åçš„æ–‡æœ¬ï¼š?\s*/i,
                /^ç¿»è¯‘åçš„[å†…å®¹ä¸Šä¸‹æ–‡]å¦‚ä¸‹ï¼š?\s*/i,
                /^[å†…å®¹ä¸Šä¸‹æ–‡]ç¿»è¯‘å¦‚ä¸‹ï¼š?\s*/i,
                /^ä»¥ä¸‹æ˜¯ç¿»è¯‘æˆ[ä¸­æ–‡è‹±æ–‡]çš„[å†…å®¹ä¸Šä¸‹æ–‡]ï¼š?\s*/i
            ];
            
            for (const prefix of prefixes) {
                translatedText = translatedText.replace(prefix, '').trim();
            }
            
            // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦ï¼ˆä½†ä¿ç•™Markdownæ ¼å¼ï¼‰
            translatedText = translatedText.replace(/\n{4,}/g, '\n\n\n');
            translatedText = translatedText.replace(/[ \t]+/g, ' ');
            translatedText = translatedText.trim();
            
            // éªŒè¯ç¿»è¯‘åçš„æ–‡æœ¬æ˜¯å¦æœ‰æ•ˆ
            if (!translatedText || translatedText.length < 10) {
                throw new Error('ç¿»è¯‘åçš„æ–‡æœ¬è¿‡çŸ­ï¼Œå¯èƒ½ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            
            // å¦‚æœç¿»è¯‘åçš„æ–‡æœ¬ä¸åŸæ–‡å®Œå…¨ç›¸åŒï¼Œç»™å‡ºæç¤º
            if (translatedText === originalText) {
                this.showNotification('ç¿»è¯‘åçš„å†…å®¹ä¸åŸæ–‡ç›¸åŒï¼Œå¯èƒ½å·²ç»æ˜¯ç›®æ ‡è¯­è¨€', 'info');
            }
            
            // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
            textarea.value = translatedText;
            
            // ä¿å­˜ç¿»è¯‘åçš„æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€åŠŸèƒ½
            textarea.setAttribute('data-translated-text', translatedText);
            
            // è§¦å‘ input äº‹ä»¶ï¼Œç¡®ä¿å€¼è¢«æ­£ç¡®æ›´æ–°å¹¶æ›´æ–°é¢„è§ˆ
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            
            // æ˜¾ç¤ºç¿»è¯‘å®Œæˆé€šçŸ¥ï¼ŒåŒ…å«å­—ç¬¦æ•°ä¿¡æ¯
            const charCount = translatedText.length;
            const originalCharCount = originalText.length;
            const changeInfo = charCount !== originalCharCount 
                ? `ï¼ˆ${originalCharCount}å­— â†’ ${charCount}å­—ï¼‰` 
                : `ï¼ˆ${charCount}å­—ï¼‰`;
            this.showNotification(`ç¿»è¯‘å®Œæˆ ${changeInfo}`, 'success');
        } catch (error) {
            // éšè—åŠ è½½åŠ¨ç”»
            this._showLoadingAnimation();
            console.error('ç¿»è¯‘ä¸Šä¸‹æ–‡å¤±è´¥:', error);
            
            // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            let errorMessage = 'ç¿»è¯‘å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            if (error.message) {
                if (error.message.includes('HTTP error')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message.includes('æ— æ³•è§£æ')) {
                    errorMessage = 'æœåŠ¡å™¨å“åº”æ ¼å¼å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('è¿‡çŸ­')) {
                    errorMessage = error.message;
                } else {
                    errorMessage = error.message;
                }
            }
            
            this.showNotification(errorMessage, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (translateZhBtn) {
                translateZhBtn.disabled = false;
                translateZhBtn.removeAttribute('data-translating');
                translateZhBtn.textContent = 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡';
                translateZhBtn.style.opacity = '1';
                translateZhBtn.style.cursor = 'pointer';
            }
            if (translateEnBtn) {
                translateEnBtn.disabled = false;
                translateEnBtn.removeAttribute('data-translating');
                translateEnBtn.textContent = 'ğŸ‡ºğŸ‡¸ è‹±æ–‡';
                translateEnBtn.style.opacity = '1';
                translateEnBtn.style.cursor = 'pointer';
            }
        }
    }
    
    // ç¿»è¯‘æ–°é—»å­—æ®µï¼ˆæ ‡é¢˜ã€æè¿°æˆ–å†…å®¹ï¼‰
    async translateNewsField(fieldType, inputElement, targetLanguage) {
        if (!inputElement) return;
        
        const originalText = inputElement.value.trim();
        if (!originalText) {
            this.showNotification('è¯·å…ˆè¾“å…¥å†…å®¹', 'warning');
            return;
        }
        
        // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€åŠŸèƒ½
        if (!inputElement.hasAttribute('data-original-text')) {
            inputElement.setAttribute('data-original-text', originalText);
        }
        
        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const groupElement = inputElement.parentElement;
        const translateBtn = groupElement ? groupElement.querySelector(`button[data-translate-field="${fieldType}"][data-target-lang="${targetLanguage}"]`) : null;
        const originalBtnText = translateBtn ? translateBtn.textContent : '';
        if (translateBtn) {
            translateBtn.disabled = true;
            translateBtn.textContent = 'ç¿»è¯‘ä¸­...';
            translateBtn.style.opacity = '0.6';
            translateBtn.style.cursor = 'not-allowed';
        }
        
        try {
            // æ„å»ºç¿»è¯‘æç¤ºè¯
            const languageName = targetLanguage === 'zh' ? 'ä¸­æ–‡' : 'è‹±æ–‡';
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘ä¸“å®¶ï¼Œæ“…é•¿å‡†ç¡®ã€æµç•…åœ°ç¿»è¯‘æ–‡æœ¬ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„æ–‡æœ¬ç¿»è¯‘æˆ${languageName}ï¼Œè¦æ±‚ï¼š
1. ä¿æŒåŸæ–‡çš„æ„æ€å’Œè¯­æ°”ä¸å˜
2. ç¿»è¯‘è‡ªç„¶æµç•…ï¼Œç¬¦åˆ${languageName}çš„è¡¨è¾¾ä¹ æƒ¯
3. ä¿ç•™åŸæ–‡çš„æ ¼å¼å’Œç»“æ„
4. å¦‚æœæ˜¯æ–°é—»å†…å®¹ï¼Œä¿æŒæ–°é—»çš„å®¢è§‚æ€§å’Œå‡†ç¡®æ€§

è¯·ç›´æ¥è¿”å›ç¿»è¯‘åçš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°ã€‚`;
            
            const userPrompt = `è¯·å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆ${languageName}ï¼š

${originalText}

è¯·ç›´æ¥è¿”å›ç¿»è¯‘åçš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°ã€‚`;
            
            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            this._showLoadingAnimation();
            
            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // å…ˆè·å–æ–‡æœ¬å“åº”ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼
            const responseText = await response.text();
            let result;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
            if (responseText.includes('data: ')) {
                // å¤„ç†SSEæµå¼å“åº”
                const lines = responseText.split('\n');
                let accumulatedData = '';
                let lastValidData = null;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ')) {
                        try {
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr === '[DONE]' || dataStr === '') {
                                continue;
                            }
                            
                            // å°è¯•è§£æJSON
                            const chunk = JSON.parse(dataStr);
                            
                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            if (chunk.done === true) {
                                break;
                            }
                            
                            // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                            if (chunk.data) {
                                accumulatedData += chunk.data;
                            } else if (chunk.content) {
                                accumulatedData += chunk.content;
                            } else if (chunk.message && chunk.message.content) {
                                // Ollamaæ ¼å¼
                                accumulatedData += chunk.message.content;
                            } else if (typeof chunk === 'string') {
                                accumulatedData += chunk;
                            }
                            
                            // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                            lastValidData = chunk;
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr && dataStr !== '[DONE]') {
                                accumulatedData += dataStr;
                            }
                        }
                    }
                }
                
                // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                if (accumulatedData || lastValidData) {
                    if (lastValidData && lastValidData.status) {
                        // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                        result = {
                            ...lastValidData,
                            data: accumulatedData || lastValidData.data || '',
                            content: accumulatedData || lastValidData.content || ''
                        };
                    } else {
                        // å¦åˆ™åˆ›å»ºæ–°çš„ç»“æœå¯¹è±¡
                        result = {
                            data: accumulatedData,
                            content: accumulatedData
                        };
                    }
                } else {
                    // å¦‚æœæ— æ³•è§£æSSEæ ¼å¼ï¼Œå°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                    }
                }
            } else {
                // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº”: ${e.message}`);
                }
            }
            
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            
            // è§£æå“åº”å†…å®¹
            let translatedText;
            // ä¼˜å…ˆæ£€æŸ¥ status å­—æ®µï¼Œå¦‚æœå­˜åœ¨ä¸”ä¸ç­‰äº 200ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
            if (result.status !== undefined && result.status !== 200) {
                throw new Error(result.msg || result.message || 'ç¿»è¯‘å¤±è´¥');
            }
            
            // æŒ‰ä¼˜å…ˆçº§æå–ç¿»è¯‘åçš„æ–‡æœ¬
            if (result.data) {
                translatedText = result.data;
            } else if (result.content) {
                translatedText = result.content;
            } else if (result.message) {
                translatedText = result.message;
            } else if (typeof result === 'string') {
                translatedText = result;
            } else if (result.text) {
                translatedText = result.text;
            } else {
                // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ä¸å­˜åœ¨ï¼Œå°è¯•ä»å¯¹è±¡ä¸­æŸ¥æ‰¾å¯èƒ½çš„æ–‡æœ¬å­—æ®µ
                const possibleFields = ['output', 'response', 'result', 'answer'];
                for (const field of possibleFields) {
                    if (result[field] && typeof result[field] === 'string') {
                        translatedText = result[field];
                        break;
                    }
                }
                
                // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯
                if (!translatedText) {
                    console.error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œå“åº”å¯¹è±¡:', result);
                    throw new Error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨å“åº”æ ¼å¼');
                }
            }
            
            // æ¸…ç†ç¿»è¯‘åçš„æ–‡æœ¬
            translatedText = translatedText.trim();
            
            // ç§»é™¤å¯èƒ½çš„å¼•å·åŒ…è£¹ï¼ˆæ”¯æŒå¤šç§å¼•å·ç±»å‹ï¼‰
            const quotePairs = [
                ['"', '"'],
                ['"', '"'],
                ['"', '"'],
                ["'", "'"],
                ['`', '`'],
                ['ã€Œ', 'ã€'],
                ['ã€', 'ã€']
            ];
            
            for (const [startQuote, endQuote] of quotePairs) {
                if (translatedText.startsWith(startQuote) && translatedText.endsWith(endQuote)) {
                    translatedText = translatedText.slice(startQuote.length, -endQuote.length).trim();
                }
            }
            
            // ç§»é™¤å¸¸è§çš„AIå›å¤å‰ç¼€
            const prefixes = [
                /^ç¿»è¯‘åçš„[å†…å®¹æ–‡æœ¬]ï¼š?\s*/i,
                /^ä»¥ä¸‹æ˜¯ç¿»è¯‘åçš„[å†…å®¹æ–‡æœ¬]ï¼š?\s*/i,
                /^ç¿»è¯‘ç»“æœï¼š?\s*/i,
                /^ç¿»è¯‘åçš„æ–‡æœ¬ï¼š?\s*/i,
                /^ç¿»è¯‘åçš„[å†…å®¹æ–‡æœ¬]å¦‚ä¸‹ï¼š?\s*/i,
                /^[å†…å®¹æ–‡æœ¬]ç¿»è¯‘å¦‚ä¸‹ï¼š?\s*/i
            ];
            
            for (const prefix of prefixes) {
                translatedText = translatedText.replace(prefix, '').trim();
            }
            
            // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦ï¼ˆä½†ä¿ç•™æ ¼å¼ï¼‰
            translatedText = translatedText.replace(/\n{4,}/g, '\n\n\n');
            translatedText = translatedText.replace(/[ \t]+/g, ' ');
            translatedText = translatedText.trim();
            
            // éªŒè¯ç¿»è¯‘åçš„æ–‡æœ¬æ˜¯å¦æœ‰æ•ˆ
            if (!translatedText || translatedText.length < 1) {
                throw new Error('ç¿»è¯‘åçš„æ–‡æœ¬ä¸ºç©ºï¼Œå¯èƒ½ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            
            // å¦‚æœç¿»è¯‘åçš„æ–‡æœ¬ä¸åŸæ–‡å®Œå…¨ç›¸åŒï¼Œç»™å‡ºæç¤º
            if (translatedText === originalText) {
                this.showNotification('ç¿»è¯‘åçš„å†…å®¹ä¸åŸæ–‡ç›¸åŒ', 'info');
            }
            
            // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
            inputElement.value = translatedText;
            
            // ä¿å­˜ç¿»è¯‘åçš„æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€åŠŸèƒ½
            inputElement.setAttribute('data-translated-text', translatedText);
            
            // è§¦å‘ input äº‹ä»¶ï¼Œç¡®ä¿å€¼è¢«æ­£ç¡®æ›´æ–°
            inputElement.dispatchEvent(new Event('input', { bubbles: true }));
            
            // æ˜¾ç¤ºæ’¤é”€æŒ‰é’®ï¼ˆä»æ¨¡æ€æ¡†ä¸­æŸ¥æ‰¾ï¼Œæ›´å¯é ï¼‰
            const modal = document.getElementById('pet-news-edit-modal');
            const undoBtn = modal ? modal.querySelector(`button[data-undo-field="${fieldType}"]`) : null;
            if (undoBtn) {
                undoBtn.style.display = 'block';
            }
            
            // æ˜¾ç¤ºç¿»è¯‘å®Œæˆé€šçŸ¥
            this.showNotification(`ç¿»è¯‘æˆ${languageName}å®Œæˆ`, 'success');
        } catch (error) {
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            console.error('ç¿»è¯‘å¤±è´¥:', error);
            
            // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            let errorMessage = 'ç¿»è¯‘å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            if (error.message) {
                if (error.message.includes('HTTP error')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message.includes('æ— æ³•è§£æ')) {
                    errorMessage = 'æœåŠ¡å™¨å“åº”æ ¼å¼å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('ä¸ºç©º')) {
                    errorMessage = error.message;
                } else {
                    errorMessage = error.message;
                }
            }
            
            this.showNotification(errorMessage, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (translateBtn) {
                translateBtn.disabled = false;
                translateBtn.textContent = originalBtnText;
                translateBtn.style.opacity = '1';
                translateBtn.style.cursor = 'pointer';
            }
        }
    }
    
    // ç¡®ä¿æ–°é—»ç¼–è¾‘æ¨¡æ€æ¡†UIå­˜åœ¨
    ensureNewsEditModalUi() {
        if (document.getElementById('pet-news-edit-modal')) return;
        
        const modal = document.createElement('div');
        modal.id = 'pet-news-edit-modal';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.6) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: ${PET_CONFIG.ui.zIndex.modal} !important;
        `;
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            width: 90% !important;
            max-width: 900px !important;
            max-height: 90vh !important;
            background: #1f1f1f !important;
            color: #fff !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35) !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
        `;
        
        // å¤´éƒ¨
        const header = document.createElement('div');
        header.style.cssText = `
            padding: 16px 20px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            border-bottom: 1px solid rgba(255,255,255,0.08) !important;
            background: rgba(255,255,255,0.04) !important;
        `;
        const title = document.createElement('div');
        title.textContent = 'ç¼–è¾‘æ–°é—»';
        title.style.cssText = 'font-weight: 600; font-size: 16px;';
        header.appendChild(title);
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            font-size: 18px !important;
        `;
        closeBtn.addEventListener('click', () => this.closeNewsEditModal());
        header.appendChild(closeBtn);
        panel.appendChild(header);
        
        // å†…å®¹åŒºåŸŸ
        const content = document.createElement('div');
        content.style.cssText = `
            padding: 20px !important;
            overflow-y: auto !important;
            flex: 1 !important;
        `;
        
        // æ ‡é¢˜è¾“å…¥
        const titleGroup = document.createElement('div');
        titleGroup.style.cssText = 'margin-bottom: 16px;';
        const titleLabelRow = document.createElement('div');
        titleLabelRow.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;';
        const titleLabel = document.createElement('label');
        titleLabel.textContent = 'æ ‡é¢˜';
        titleLabel.style.cssText = 'font-size: 14px; color: #e5e7eb;';
        
        const titleInput = document.createElement('input');
        titleInput.id = 'news-edit-title';
        titleInput.type = 'text';
        titleInput.setAttribute('data-translate-field', 'title');
        titleInput.style.cssText = `
            width: 100% !important;
            padding: 10px 12px !important;
            background: rgba(255,255,255,0.08) !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            border-radius: 6px !important;
            color: #fff !important;
            font-size: 14px !important;
            box-sizing: border-box !important;
        `;
        
        const titleBtnGroup = document.createElement('div');
        titleBtnGroup.style.cssText = 'display: flex; gap: 6px; align-items: center;';
        
        // ç¿»è¯‘æˆä¸­æ–‡æŒ‰é’®
        const titleTranslateZhBtn = document.createElement('button');
        titleTranslateZhBtn.textContent = 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡';
        titleTranslateZhBtn.setAttribute('data-translate-field', 'title');
        titleTranslateZhBtn.setAttribute('data-target-lang', 'zh');
        titleTranslateZhBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(33, 150, 243, 0.3) !important;
            background: rgba(33, 150, 243, 0.15) !important;
            color: #2196f3 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        titleTranslateZhBtn.addEventListener('click', async () => {
            await this.translateNewsField('title', titleInput, 'zh');
        });
        titleTranslateZhBtn.addEventListener('mouseenter', () => {
            if (!titleTranslateZhBtn.disabled) {
                titleTranslateZhBtn.style.background = 'rgba(33, 150, 243, 0.25)';
            }
        });
        titleTranslateZhBtn.addEventListener('mouseleave', () => {
            if (!titleTranslateZhBtn.disabled) {
                titleTranslateZhBtn.style.background = 'rgba(33, 150, 243, 0.15)';
            }
        });
        
        // ç¿»è¯‘æˆè‹±æ–‡æŒ‰é’®
        const titleTranslateEnBtn = document.createElement('button');
        titleTranslateEnBtn.textContent = 'ğŸ‡ºğŸ‡¸ è‹±æ–‡';
        titleTranslateEnBtn.setAttribute('data-translate-field', 'title');
        titleTranslateEnBtn.setAttribute('data-target-lang', 'en');
        titleTranslateEnBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(33, 150, 243, 0.3) !important;
            background: rgba(33, 150, 243, 0.15) !important;
            color: #2196f3 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        titleTranslateEnBtn.addEventListener('click', async () => {
            await this.translateNewsField('title', titleInput, 'en');
        });
        titleTranslateEnBtn.addEventListener('mouseenter', () => {
            if (!titleTranslateEnBtn.disabled) {
                titleTranslateEnBtn.style.background = 'rgba(33, 150, 243, 0.25)';
            }
        });
        titleTranslateEnBtn.addEventListener('mouseleave', () => {
            if (!titleTranslateEnBtn.disabled) {
                titleTranslateEnBtn.style.background = 'rgba(33, 150, 243, 0.15)';
            }
        });
        
        // æ’¤é”€æŒ‰é’®
        const titleUndoBtn = document.createElement('button');
        titleUndoBtn.textContent = 'â†¶ æ’¤é”€';
        titleUndoBtn.setAttribute('data-undo-field', 'title');
        titleUndoBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(255, 152, 0, 0.3) !important;
            background: rgba(255, 152, 0, 0.15) !important;
            color: #ff9800 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            display: none !important;
            transition: all 0.2s !important;
        `;
        titleUndoBtn.addEventListener('click', () => {
            const originalText = titleInput.getAttribute('data-original-text');
            if (originalText) {
                titleInput.value = originalText;
                titleInput.dispatchEvent(new Event('input', { bubbles: true }));
                titleUndoBtn.style.display = 'none';
                this.showNotification('å·²æ’¤é”€ç¿»è¯‘', 'info');
            }
        });
        titleUndoBtn.addEventListener('mouseenter', () => {
            titleUndoBtn.style.background = 'rgba(255, 152, 0, 0.25)';
        });
        titleUndoBtn.addEventListener('mouseleave', () => {
            titleUndoBtn.style.background = 'rgba(255, 152, 0, 0.15)';
        });
        
        titleBtnGroup.appendChild(titleTranslateZhBtn);
        titleBtnGroup.appendChild(titleTranslateEnBtn);
        titleBtnGroup.appendChild(titleUndoBtn);
        titleLabelRow.appendChild(titleLabel);
        titleLabelRow.appendChild(titleBtnGroup);
        titleGroup.appendChild(titleLabelRow);
        titleGroup.appendChild(titleInput);
        content.appendChild(titleGroup);
        
        // é“¾æ¥è¾“å…¥
        const linkGroup = document.createElement('div');
        linkGroup.style.cssText = 'margin-bottom: 16px;';
        const linkLabel = document.createElement('label');
        linkLabel.textContent = 'é“¾æ¥';
        linkLabel.style.cssText = 'display: block; margin-bottom: 8px; font-size: 14px; color: #e5e7eb;';
        const linkInput = document.createElement('input');
        linkInput.id = 'news-edit-link';
        linkInput.type = 'url';
        linkInput.style.cssText = `
            width: 100% !important;
            padding: 10px 12px !important;
            background: rgba(255,255,255,0.08) !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            border-radius: 6px !important;
            color: #fff !important;
            font-size: 14px !important;
            box-sizing: border-box !important;
        `;
        linkGroup.appendChild(linkLabel);
        linkGroup.appendChild(linkInput);
        content.appendChild(linkGroup);
        
        // æè¿°è¾“å…¥
        const descriptionGroup = document.createElement('div');
        descriptionGroup.style.cssText = 'margin-bottom: 16px;';
        const descriptionLabelRow = document.createElement('div');
        descriptionLabelRow.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;';
        const descriptionLabel = document.createElement('label');
        descriptionLabel.textContent = 'æè¿°';
        descriptionLabel.style.cssText = 'font-size: 14px; color: #e5e7eb;';
        
        // å…ˆåˆ›å»ºè¾“å…¥æ¡†ï¼Œä»¥ä¾¿åœ¨æŒ‰é’®äº‹ä»¶ä¸­ä½¿ç”¨
        const descriptionInput = document.createElement('textarea');
        descriptionInput.id = 'news-edit-description';
        descriptionInput.setAttribute('data-optimize-field', 'description');
        descriptionInput.rows = 6;
        descriptionInput.style.cssText = `
            width: 100% !important;
            padding: 10px 12px !important;
            background: rgba(255,255,255,0.08) !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            border-radius: 6px !important;
            color: #fff !important;
            font-size: 14px !important;
            resize: vertical !important;
            box-sizing: border-box !important;
            font-family: inherit !important;
        `;
        
        const descriptionBtnGroup = document.createElement('div');
        descriptionBtnGroup.style.cssText = 'display: flex; gap: 6px; align-items: center;';
        const descriptionOptimizeBtn = document.createElement('button');
        descriptionOptimizeBtn.textContent = 'âœ¨ æ™ºèƒ½ä¼˜åŒ–';
        descriptionOptimizeBtn.setAttribute('data-optimize-field', 'description');
        descriptionOptimizeBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(76, 175, 80, 0.3) !important;
            background: rgba(76, 175, 80, 0.15) !important;
            color: #4caf50 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        descriptionOptimizeBtn.addEventListener('click', async () => {
            await this.optimizeNewsField('description', descriptionInput);
        });
        descriptionOptimizeBtn.addEventListener('mouseenter', () => {
            if (!descriptionOptimizeBtn.disabled) {
                descriptionOptimizeBtn.style.background = 'rgba(76, 175, 80, 0.25)';
            }
        });
        descriptionOptimizeBtn.addEventListener('mouseleave', () => {
            if (!descriptionOptimizeBtn.disabled) {
                descriptionOptimizeBtn.style.background = 'rgba(76, 175, 80, 0.15)';
            }
        });
        
        // ç¿»è¯‘æˆä¸­æ–‡æŒ‰é’®
        const descriptionTranslateZhBtn = document.createElement('button');
        descriptionTranslateZhBtn.textContent = 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡';
        descriptionTranslateZhBtn.setAttribute('data-translate-field', 'description');
        descriptionTranslateZhBtn.setAttribute('data-target-lang', 'zh');
        descriptionTranslateZhBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(33, 150, 243, 0.3) !important;
            background: rgba(33, 150, 243, 0.15) !important;
            color: #2196f3 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        descriptionTranslateZhBtn.addEventListener('click', async () => {
            await this.translateNewsField('description', descriptionInput, 'zh');
        });
        descriptionTranslateZhBtn.addEventListener('mouseenter', () => {
            if (!descriptionTranslateZhBtn.disabled) {
                descriptionTranslateZhBtn.style.background = 'rgba(33, 150, 243, 0.25)';
            }
        });
        descriptionTranslateZhBtn.addEventListener('mouseleave', () => {
            if (!descriptionTranslateZhBtn.disabled) {
                descriptionTranslateZhBtn.style.background = 'rgba(33, 150, 243, 0.15)';
            }
        });
        
        // ç¿»è¯‘æˆè‹±æ–‡æŒ‰é’®
        const descriptionTranslateEnBtn = document.createElement('button');
        descriptionTranslateEnBtn.textContent = 'ğŸ‡ºğŸ‡¸ è‹±æ–‡';
        descriptionTranslateEnBtn.setAttribute('data-translate-field', 'description');
        descriptionTranslateEnBtn.setAttribute('data-target-lang', 'en');
        descriptionTranslateEnBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(33, 150, 243, 0.3) !important;
            background: rgba(33, 150, 243, 0.15) !important;
            color: #2196f3 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        descriptionTranslateEnBtn.addEventListener('click', async () => {
            await this.translateNewsField('description', descriptionInput, 'en');
        });
        descriptionTranslateEnBtn.addEventListener('mouseenter', () => {
            if (!descriptionTranslateEnBtn.disabled) {
                descriptionTranslateEnBtn.style.background = 'rgba(33, 150, 243, 0.25)';
            }
        });
        descriptionTranslateEnBtn.addEventListener('mouseleave', () => {
            if (!descriptionTranslateEnBtn.disabled) {
                descriptionTranslateEnBtn.style.background = 'rgba(33, 150, 243, 0.15)';
            }
        });
        
        const descriptionUndoBtn = document.createElement('button');
        descriptionUndoBtn.textContent = 'â†¶ æ’¤é”€';
        descriptionUndoBtn.setAttribute('data-undo-field', 'description');
        descriptionUndoBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(255, 152, 0, 0.3) !important;
            background: rgba(255, 152, 0, 0.15) !important;
            color: #ff9800 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            display: none !important;
            transition: all 0.2s !important;
        `;
        descriptionUndoBtn.addEventListener('click', () => {
            const originalText = descriptionInput.getAttribute('data-original-text');
            if (originalText) {
                descriptionInput.value = originalText;
                descriptionInput.dispatchEvent(new Event('input', { bubbles: true }));
                descriptionUndoBtn.style.display = 'none';
                this.showNotification('å·²æ’¤é”€', 'info');
            }
        });
        descriptionUndoBtn.addEventListener('mouseenter', () => {
            descriptionUndoBtn.style.background = 'rgba(255, 152, 0, 0.25)';
        });
        descriptionUndoBtn.addEventListener('mouseleave', () => {
            descriptionUndoBtn.style.background = 'rgba(255, 152, 0, 0.15)';
        });
        descriptionBtnGroup.appendChild(descriptionOptimizeBtn);
        descriptionBtnGroup.appendChild(descriptionTranslateZhBtn);
        descriptionBtnGroup.appendChild(descriptionTranslateEnBtn);
        descriptionBtnGroup.appendChild(descriptionUndoBtn);
        descriptionLabelRow.appendChild(descriptionLabel);
        descriptionLabelRow.appendChild(descriptionBtnGroup);
        descriptionGroup.appendChild(descriptionLabelRow);
        descriptionGroup.appendChild(descriptionInput);
        content.appendChild(descriptionGroup);
        
        // å†…å®¹è¾“å…¥
        const contentGroup = document.createElement('div');
        contentGroup.style.cssText = 'margin-bottom: 16px;';
        const contentLabelRow = document.createElement('div');
        contentLabelRow.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;';
        const contentLabel = document.createElement('label');
        contentLabel.textContent = 'å†…å®¹';
        contentLabel.style.cssText = 'font-size: 14px; color: #e5e7eb;';
        
        // å…ˆåˆ›å»ºè¾“å…¥æ¡†ï¼Œä»¥ä¾¿åœ¨æŒ‰é’®äº‹ä»¶ä¸­ä½¿ç”¨
        const contentInput = document.createElement('textarea');
        contentInput.id = 'news-edit-content';
        contentInput.setAttribute('data-optimize-field', 'content');
        contentInput.rows = 6;
        contentInput.style.cssText = `
            width: 100% !important;
            padding: 10px 12px !important;
            background: rgba(255,255,255,0.08) !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            border-radius: 6px !important;
            color: #fff !important;
            font-size: 14px !important;
            resize: vertical !important;
            box-sizing: border-box !important;
            font-family: inherit !important;
        `;
        
        const contentBtnGroup = document.createElement('div');
        contentBtnGroup.style.cssText = 'display: flex; gap: 6px; align-items: center;';
        const contentOptimizeBtn = document.createElement('button');
        contentOptimizeBtn.textContent = 'âœ¨ æ™ºèƒ½ä¼˜åŒ–';
        contentOptimizeBtn.setAttribute('data-optimize-field', 'content');
        contentOptimizeBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(76, 175, 80, 0.3) !important;
            background: rgba(76, 175, 80, 0.15) !important;
            color: #4caf50 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        contentOptimizeBtn.addEventListener('click', async () => {
            await this.optimizeNewsField('content', contentInput);
        });
        contentOptimizeBtn.addEventListener('mouseenter', () => {
            if (!contentOptimizeBtn.disabled) {
                contentOptimizeBtn.style.background = 'rgba(76, 175, 80, 0.25)';
            }
        });
        contentOptimizeBtn.addEventListener('mouseleave', () => {
            if (!contentOptimizeBtn.disabled) {
                contentOptimizeBtn.style.background = 'rgba(76, 175, 80, 0.15)';
            }
        });
        
        // ç¿»è¯‘æˆä¸­æ–‡æŒ‰é’®
        const contentTranslateZhBtn = document.createElement('button');
        contentTranslateZhBtn.textContent = 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡';
        contentTranslateZhBtn.setAttribute('data-translate-field', 'content');
        contentTranslateZhBtn.setAttribute('data-target-lang', 'zh');
        contentTranslateZhBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(33, 150, 243, 0.3) !important;
            background: rgba(33, 150, 243, 0.15) !important;
            color: #2196f3 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        contentTranslateZhBtn.addEventListener('click', async () => {
            await this.translateNewsField('content', contentInput, 'zh');
        });
        contentTranslateZhBtn.addEventListener('mouseenter', () => {
            if (!contentTranslateZhBtn.disabled) {
                contentTranslateZhBtn.style.background = 'rgba(33, 150, 243, 0.25)';
            }
        });
        contentTranslateZhBtn.addEventListener('mouseleave', () => {
            if (!contentTranslateZhBtn.disabled) {
                contentTranslateZhBtn.style.background = 'rgba(33, 150, 243, 0.15)';
            }
        });
        
        // ç¿»è¯‘æˆè‹±æ–‡æŒ‰é’®
        const contentTranslateEnBtn = document.createElement('button');
        contentTranslateEnBtn.textContent = 'ğŸ‡ºğŸ‡¸ è‹±æ–‡';
        contentTranslateEnBtn.setAttribute('data-translate-field', 'content');
        contentTranslateEnBtn.setAttribute('data-target-lang', 'en');
        contentTranslateEnBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(33, 150, 243, 0.3) !important;
            background: rgba(33, 150, 243, 0.15) !important;
            color: #2196f3 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        contentTranslateEnBtn.addEventListener('click', async () => {
            await this.translateNewsField('content', contentInput, 'en');
        });
        contentTranslateEnBtn.addEventListener('mouseenter', () => {
            if (!contentTranslateEnBtn.disabled) {
                contentTranslateEnBtn.style.background = 'rgba(33, 150, 243, 0.25)';
            }
        });
        contentTranslateEnBtn.addEventListener('mouseleave', () => {
            if (!contentTranslateEnBtn.disabled) {
                contentTranslateEnBtn.style.background = 'rgba(33, 150, 243, 0.15)';
            }
        });
        
        const contentUndoBtn = document.createElement('button');
        contentUndoBtn.textContent = 'â†¶ æ’¤é”€';
        contentUndoBtn.setAttribute('data-undo-field', 'content');
        contentUndoBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(255, 152, 0, 0.3) !important;
            background: rgba(255, 152, 0, 0.15) !important;
            color: #ff9800 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            display: none !important;
            transition: all 0.2s !important;
        `;
        contentUndoBtn.addEventListener('click', () => {
            const originalText = contentInput.getAttribute('data-original-text');
            if (originalText) {
                contentInput.value = originalText;
                contentInput.dispatchEvent(new Event('input', { bubbles: true }));
                contentUndoBtn.style.display = 'none';
                this.showNotification('å·²æ’¤é”€', 'info');
            }
        });
        contentUndoBtn.addEventListener('mouseenter', () => {
            contentUndoBtn.style.background = 'rgba(255, 152, 0, 0.25)';
        });
        contentUndoBtn.addEventListener('mouseleave', () => {
            contentUndoBtn.style.background = 'rgba(255, 152, 0, 0.15)';
        });
        contentBtnGroup.appendChild(contentOptimizeBtn);
        contentBtnGroup.appendChild(contentTranslateZhBtn);
        contentBtnGroup.appendChild(contentTranslateEnBtn);
        contentBtnGroup.appendChild(contentUndoBtn);
        contentLabelRow.appendChild(contentLabel);
        contentLabelRow.appendChild(contentBtnGroup);
        contentGroup.appendChild(contentLabelRow);
        contentGroup.appendChild(contentInput);
        content.appendChild(contentGroup);
        
        panel.appendChild(content);
        
        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            padding: 16px 20px !important;
            display: flex !important;
            gap: 12px !important;
            justify-content: flex-end !important;
            border-top: 1px solid rgba(255,255,255,0.08) !important;
            background: rgba(255,255,255,0.04) !important;
        `;
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 8px 16px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            font-size: 14px !important;
        `;
        cancelBtn.addEventListener('click', () => this.closeNewsEditModal());
        footer.appendChild(cancelBtn);
        
        const saveBtn = document.createElement('button');
        saveBtn.id = 'news-edit-save-btn';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 8px 16px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(76, 175, 80, 0.3) !important;
            background: rgba(76, 175, 80, 0.3) !important;
            color: #4caf50 !important;
            cursor: pointer !important;
            font-size: 14px !important;
        `;
        saveBtn.addEventListener('click', async () => {
            if (saveBtn.hasAttribute('data-saving')) return;
            await this.saveNewsEdit();
        });
        footer.appendChild(saveBtn);
        
        panel.appendChild(footer);
        modal.appendChild(panel);
        document.body.appendChild(modal);
    }
    
    // ä¿å­˜æ–°é—»ç¼–è¾‘
    async saveNewsEdit() {
        const modal = document.getElementById('pet-news-edit-modal');
        if (!modal) return;
        
        const saveBtn = modal.querySelector('#news-edit-save-btn');
        if (!saveBtn) return;
        
        if (saveBtn.hasAttribute('data-saving')) return;
        
        saveBtn.setAttribute('data-saving', 'true');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
        saveBtn.style.opacity = '0.6';
        saveBtn.style.cursor = 'not-allowed';
        
        try {
            const titleInput = modal.querySelector('#news-edit-title');
            const descriptionInput = modal.querySelector('#news-edit-description');
            const linkInput = modal.querySelector('#news-edit-link');
            const contentInput = modal.querySelector('#news-edit-content');
            
            const title = titleInput ? titleInput.value.trim() : '';
            const description = descriptionInput ? descriptionInput.value.trim() : '';
            const link = linkInput ? linkInput.value.trim() : '';
            const content = contentInput ? contentInput.value.trim() : '';
            
            if (!title) {
                this.showNotification('æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            const newsKey = modal.getAttribute('data-news-key');
            const newsLink = modal.getAttribute('data-news-link');
            const index = parseInt(modal.getAttribute('data-news-index'));
            
            // è·å–åŸå§‹æ–°é—»æ•°æ®
            let originalNews = null;
            if (window.currentNews && Array.isArray(window.currentNews) && index >= 0) {
                originalNews = window.currentNews[index];
            }
            
            // æ„å»ºæ›´æ–°æ•°æ®
            const updateData = {
                key: newsKey || originalNews?.key,
                title: title,
                description: description,
                link: link,
                content: content
            };
            
            // è°ƒç”¨åç«¯APIä¿å­˜æ–°é—»
            const apiUrl = this.newsManager?.apiUrl || 'https://api.effiy.cn/mongodb/';
            const cname = this.newsManager?.cname || 'rss';
            
            let response, result;
            
            if (updateData.key) {
                // å¦‚æœæœ‰keyï¼Œè°ƒç”¨PUTæ¥å£æ›´æ–°ç°æœ‰æ–°é—»
                response = await fetch(`${apiUrl}?cname=${cname}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
            } else {
                // å¦‚æœæ²¡æœ‰keyï¼Œè°ƒç”¨POSTæ¥å£åˆ›å»ºæ–°æ–°é—»
                // ä»updateDataä¸­ç§»é™¤keyå­—æ®µï¼ˆå¦‚æœå­˜åœ¨ä½†ä¸ºç©ºï¼‰
                const createData = {...updateData};
                delete createData.key;
                
                response = await fetch(`${apiUrl}?cname=${cname}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(createData)
                });
            }
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            result = await response.json();
            if (result.code === 200) {
                // å¦‚æœæ˜¯åˆ›å»ºæ–°æ–°é—»ï¼Œæ›´æ–°key
                if (!updateData.key && result.data && result.data.key) {
                    updateData.key = result.data.key;
                }
                
                // æ›´æ–°æœ¬åœ°æ–°é—»æ•°æ®
                if (originalNews) {
                    Object.assign(originalNews, updateData);
                }
                
                // æ›´æ–°æ–°é—»ç®¡ç†å™¨ä¸­çš„æ•°æ®
                if (this.newsManager) {
                    const allNews = this.newsManager.getAllNews();
                    const newsIndex = allNews.findIndex(n => 
                        (n.key && n.key === updateData.key) || 
                        (n.link && n.link === newsLink)
                    );
                    if (newsIndex >= 0) {
                        Object.assign(allNews[newsIndex], updateData);
                    }
                }
                
                // é‡æ–°æ¸²æŸ“æ–°é—»åˆ—è¡¨
                await this.updateNewsSidebar(false);
                
                this.showNotification('æ–°é—»å·²ä¿å­˜', 'success');
                this.closeNewsEditModal();
            } else {
                throw new Error(result.msg || result.message || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜æ–°é—»å¤±è´¥:', error);
            this.showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        } finally {
            saveBtn.removeAttribute('data-saving');
            saveBtn.textContent = originalText;
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
        }
    }
    
    // æ‰“å¼€æ–°é—»æ ‡ç­¾ç®¡ç†æ¨¡æ€æ¡†
    // æ‰“å¼€æ–°é—»æ ‡ç­¾ç®¡ç†å™¨ï¼ˆä½¿ç”¨ä¸ä¼šè¯æ ‡ç­¾ç®¡ç†ç›¸åŒçš„UIï¼‰
    openNewsTagManager(newsItem, index) {
        if (!newsItem) {
            console.warn('æ–°é—»é¡¹ä¸å­˜åœ¨ï¼Œæ— æ³•ç®¡ç†æ ‡ç­¾');
            return;
        }

        // ç¡®ä¿èŠå¤©çª—å£å·²æ‰“å¼€
        if (!this.chatWindow || !this.isChatOpen) {
            // å¦‚æœèŠå¤©çª—å£æœªæ‰“å¼€ï¼Œå…ˆæ‰“å¼€å®ƒ
            this.openChatWindow().then(() => {
                this._doOpenNewsTagManager(newsItem, index);
            });
        } else {
            this._doOpenNewsTagManager(newsItem, index);
        }
    }

    _doOpenNewsTagManager(newsItem, index) {
        const currentTags = newsItem.tags || [];

        // åˆ›å»ºæ ‡ç­¾ç®¡ç†å¼¹çª—
        this.ensureNewsTagManagerUi();
        const modal = this.chatWindow?.querySelector('#pet-news-tag-manager');
        if (!modal) {
            console.error('æ–°é—»æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }

        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
        modal.dataset.newsIndex = index;
        modal.dataset.newsKey = newsItem.key || '';
        modal.dataset.newsLink = newsItem.link || '';
        
        // éšè—æŠ˜å æŒ‰é’®ï¼ˆé¿å…åœ¨å¼¹æ¡†ä¸­æ˜¾ç¤ºä¸¤ä¸ªæŠ˜å æŒ‰é’®ï¼‰
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';

        // åŠ è½½å½“å‰æ ‡ç­¾
        this.loadNewsTagsIntoManager(newsItem, index, currentTags);

        // æ·»åŠ å…³é—­äº‹ä»¶
        const closeBtn = modal.querySelector('.news-tag-manager-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeNewsTagManager();
        }

        // æ·»åŠ ä¿å­˜äº‹ä»¶
        const saveBtn = modal.querySelector('.news-tag-manager-save');
        if (saveBtn) {
            saveBtn.onclick = () => this.saveNewsTags(newsItem, index);
        }

        // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶ï¼ˆå…¼å®¹ä¸­æ–‡è¾“å…¥æ³•ï¼‰
        const tagInput = modal.querySelector('.news-tag-manager-input');
        if (tagInput) {
            // ç¡®ä¿è¾“å…¥æ³•ç»„åˆçŠ¶æ€å·²åˆå§‹åŒ–ï¼ˆå¦‚æœè¾“å…¥æ¡†æ˜¯æ–°åˆ›å»ºçš„ï¼‰
            if (tagInput._isComposing === undefined) {
                tagInput._isComposing = false;
                tagInput.addEventListener('compositionstart', () => {
                    tagInput._isComposing = true;
                });
                tagInput.addEventListener('compositionend', () => {
                    tagInput._isComposing = false;
                });
            }
            
            // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†ï¼ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®šï¼‰
            const existingHandler = tagInput._enterKeyHandler;
            if (existingHandler) {
                tagInput.removeEventListener('keydown', existingHandler);
            }
            
            const enterKeyHandler = (e) => {
                // å¦‚æœåœ¨è¾“å…¥æ³•ç»„åˆè¿‡ç¨‹ä¸­ï¼Œå¿½ç•¥å›è½¦é”®
                if (tagInput._isComposing) {
                    return;
                }
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addNewsTagFromInput(newsItem, index);
                }
            };
            
            tagInput._enterKeyHandler = enterKeyHandler;
            tagInput.addEventListener('keydown', enterKeyHandler);
            
            tagInput.focus();
        }

        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeNewsTagManager();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    openNewsTagModal(newsItem, index) {
        // ç¡®ä¿æ¨¡æ€æ¡†UIå­˜åœ¨
        this.ensureNewsTagModalUi();
        
        const modal = document.getElementById('pet-news-tag-modal');
        if (!modal) return;
        
        // è·å–å½“å‰æ ‡ç­¾
        const currentTags = newsItem.tags || [];
        
        // æ˜¾ç¤ºå½“å‰æ ‡ç­¾
        const tagInputList = modal.querySelector('#news-tag-input-list');
        if (tagInputList) {
            this.updateNewsTagInputList(tagInputList, currentTags);
        }
        
        // ä¿å­˜å½“å‰ç¼–è¾‘çš„æ–°é—»é¡¹
        modal.setAttribute('data-news-index', index);
        modal.setAttribute('data-news-key', newsItem.key || '');
        modal.setAttribute('data-news-link', newsItem.link || '');
        modal._currentTags = [...currentTags]; // ä¿å­˜æ ‡ç­¾å‰¯æœ¬
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'flex';
        
        // èšç„¦åˆ°æ ‡ç­¾è¾“å…¥æ¡†
        const tagInput = modal.querySelector('#news-tag-input');
        if (tagInput) {
            setTimeout(() => tagInput.focus(), 100);
        }
        
        // é”®ç›˜å¿«æ·é”®ï¼šEsc å…³é—­ï¼ŒEnter æ·»åŠ æ ‡ç­¾
        const keydownHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeNewsTagModal();
            } else if (e.key === 'Enter' && e.target.id === 'news-tag-input') {
                e.preventDefault();
                this.addNewsTag();
            }
        };
        document.addEventListener('keydown', keydownHandler, { capture: true });
        modal._keydownHandler = keydownHandler;
    }
    
    // å…³é—­æ–°é—»æ ‡ç­¾ç®¡ç†æ¨¡æ€æ¡†
    closeNewsTagModal() {
        const modal = document.getElementById('pet-news-tag-modal');
        if (!modal) return;
        
        modal.style.display = 'none';
        
        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬
        if (modal._keydownHandler) {
            document.removeEventListener('keydown', modal._keydownHandler, { capture: true });
            modal._keydownHandler = null;
        }
        
        // æ¸…ç©ºæ•°æ®
        modal.removeAttribute('data-news-index');
        modal.removeAttribute('data-news-key');
        modal.removeAttribute('data-news-link');
        modal._currentTags = [];
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        const tagInput = modal.querySelector('#news-tag-input');
        if (tagInput) tagInput.value = '';
    }
    
    // ç¡®ä¿æ–°é—»æ ‡ç­¾ç®¡ç†å™¨UIå­˜åœ¨ï¼ˆä½¿ç”¨ä¸ä¼šè¯æ ‡ç­¾ç®¡ç†ç›¸åŒçš„UIï¼‰
    ensureNewsTagManagerUi() {
        if (!this.chatWindow) return;
        if (this.chatWindow.querySelector('#pet-news-tag-manager')) return;

        const modal = document.createElement('div');
        modal.id = 'pet-news-tag-manager';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 10000 !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeNewsTagManager();
            }
        });

        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 24px !important;
            width: 90% !important;
            max-width: 800px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        `;

        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ç®¡ç†æ ‡ç­¾';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'news-tag-manager-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });

        header.appendChild(title);
        header.appendChild(closeBtn);

        // è¾“å…¥åŒºåŸŸ
        const inputGroup = document.createElement('div');
        inputGroup.className = 'news-tag-manager-input-group';
        inputGroup.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
        `;

        const tagInput = document.createElement('input');
        tagInput.className = 'news-tag-manager-input';
        tagInput.type = 'text';
        tagInput.placeholder = 'è¾“å…¥æ ‡ç­¾åç§°ï¼ŒæŒ‰å›è½¦æ·»åŠ ';
        tagInput.style.cssText = `
            flex: 1 !important;
            padding: 10px 12px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
        `;
        
        // è¾“å…¥æ³•ç»„åˆçŠ¶æ€è·Ÿè¸ªï¼ˆç”¨äºå¤„ç†ä¸­æ–‡è¾“å…¥ï¼‰
        tagInput._isComposing = false;
        tagInput.addEventListener('compositionstart', () => {
            tagInput._isComposing = true;
        });
        tagInput.addEventListener('compositionend', () => {
            tagInput._isComposing = false;
        });
        
        tagInput.addEventListener('focus', () => {
            tagInput.style.borderColor = '#4CAF50';
        });
        tagInput.addEventListener('blur', () => {
            tagInput.style.borderColor = '#e0e0e0';
        });

        const addBtn = document.createElement('button');
        addBtn.textContent = 'æ·»åŠ ';
        addBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.background = '#45a049';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.background = '#4CAF50';
        });
        addBtn.addEventListener('click', () => {
            const newsIndex = modal.dataset.newsIndex;
            const newsKey = modal.dataset.newsKey;
            const newsLink = modal.dataset.newsLink;
            if (newsIndex !== undefined) {
                // è·å–æ–°é—»é¡¹
                let newsItem = null;
                if (window.currentNews && Array.isArray(window.currentNews) && parseInt(newsIndex) >= 0) {
                    newsItem = window.currentNews[parseInt(newsIndex)];
                }
                if (newsItem) {
                    this.addNewsTagFromInput(newsItem, parseInt(newsIndex));
                }
            }
        });

        // æ™ºèƒ½ç”Ÿæˆæ ‡ç­¾æŒ‰é’®ï¼ˆæ–°é—»æ ‡ç­¾ç®¡ç†ä¹Ÿæ”¯æŒæ™ºèƒ½ç”Ÿæˆï¼‰
        const smartGenerateBtn = document.createElement('button');
        smartGenerateBtn.className = 'news-tag-manager-smart-generate';
        smartGenerateBtn.textContent = 'âœ¨ æ™ºèƒ½ç”Ÿæˆ';
        smartGenerateBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #9C27B0 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        smartGenerateBtn.addEventListener('mouseenter', () => {
            if (!smartGenerateBtn.disabled) {
                smartGenerateBtn.style.background = '#7B1FA2';
            }
        });
        smartGenerateBtn.addEventListener('mouseleave', () => {
            if (!smartGenerateBtn.disabled) {
                smartGenerateBtn.style.background = '#9C27B0';
            }
        });
        smartGenerateBtn.addEventListener('click', () => {
            const newsIndex = modal.dataset.newsIndex;
            if (newsIndex !== undefined) {
                let newsItem = null;
                if (window.currentNews && Array.isArray(window.currentNews) && parseInt(newsIndex) >= 0) {
                    newsItem = window.currentNews[parseInt(newsIndex)];
                }
                if (newsItem) {
                    this.generateNewsSmartTags(newsItem, parseInt(newsIndex), smartGenerateBtn);
                }
            }
        });

        inputGroup.appendChild(tagInput);
        inputGroup.appendChild(addBtn);
        inputGroup.appendChild(smartGenerateBtn);

        // å¿«æ·æ ‡ç­¾æŒ‰é’®å®¹å™¨
        const quickTagsContainer = document.createElement('div');
        quickTagsContainer.className = 'news-tag-manager-quick-tags';
        quickTagsContainer.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
        `;

        // å¿«æ·æ ‡ç­¾åˆ—è¡¨ï¼ˆä¸ä¼šè¯æ ‡ç­¾ç®¡ç†ä¿æŒä¸€è‡´ï¼‰
        const quickTags = ['å·¥å…·', 'å¼€æºé¡¹ç›®', 'å®¶åº­', 'å·¥ä½œ', 'å¨±ä¹', 'æ–‡æ¡£', 'ç½‘æ–‡', 'æ—¥è®°'];
        
        quickTags.forEach(tagName => {
            const quickTagBtn = document.createElement('button');
            quickTagBtn.textContent = tagName;
            quickTagBtn.className = 'news-tag-manager-quick-tag-btn';
            quickTagBtn.dataset.tagName = tagName;
            quickTagBtn.style.cssText = `
                padding: 6px 12px !important;
                background: #f0f0f0 !important;
                color: #333 !important;
                border: 1px solid #d0d0d0 !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 13px !important;
                transition: all 0.2s ease !important;
            `;
            quickTagBtn.addEventListener('mouseenter', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ”¹å˜æ ·å¼
                if (quickTagBtn.style.background === 'rgb(76, 175, 80)') {
                    return;
                }
                quickTagBtn.style.background = '#e0e0e0';
                quickTagBtn.style.borderColor = '#4CAF50';
            });
            quickTagBtn.addEventListener('mouseleave', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ”¹å˜æ ·å¼
                if (quickTagBtn.style.background === 'rgb(76, 175, 80)') {
                    return;
                }
                quickTagBtn.style.background = '#f0f0f0';
                quickTagBtn.style.borderColor = '#d0d0d0';
            });
            quickTagBtn.addEventListener('click', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ‰§è¡Œæ“ä½œ
                if (quickTagBtn.style.cursor === 'not-allowed') {
                    return;
                }
                const newsIndex = modal.dataset.newsIndex;
                if (newsIndex !== undefined) {
                    let newsItem = null;
                    if (window.currentNews && Array.isArray(window.currentNews) && parseInt(newsIndex) >= 0) {
                        newsItem = window.currentNews[parseInt(newsIndex)];
                    }
                    if (newsItem) {
                        this.addNewsQuickTag(newsItem, parseInt(newsIndex), tagName);
                    }
                }
            });
            quickTagsContainer.appendChild(quickTagBtn);
        });

        // æ ‡ç­¾åˆ—è¡¨
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'news-tag-manager-tags';
        tagsContainer.style.cssText = `
            min-height: 100px !important;
            max-height: 300px !important;
            overflow-y: auto !important;
            margin-bottom: 20px !important;
            padding: 12px !important;
            background: #f8f9fa !important;
            border-radius: 6px !important;
        `;

        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 10px !important;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #f0f0f0 !important;
            color: #333 !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: background 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#e0e0e0';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = '#f0f0f0';
        });
        cancelBtn.addEventListener('click', () => this.closeNewsTagManager());

        const saveBtn = document.createElement('button');
        saveBtn.className = 'news-tag-manager-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#1976D2';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#2196F3';
        });

        footer.appendChild(cancelBtn);
        footer.appendChild(saveBtn);

        panel.appendChild(header);
        panel.appendChild(inputGroup);
        panel.appendChild(quickTagsContainer);
        panel.appendChild(tagsContainer);
        panel.appendChild(footer);
        modal.appendChild(panel);
        this.chatWindow.appendChild(modal);
    }

    // ç¡®ä¿æ–°é—»æ ‡ç­¾ç®¡ç†æ¨¡æ€æ¡†UIå­˜åœ¨
    ensureNewsTagModalUi() {
        if (document.getElementById('pet-news-tag-modal')) return;
        
        const modal = document.createElement('div');
        modal.id = 'pet-news-tag-modal';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.6) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: ${PET_CONFIG.ui.zIndex.modal} !important;
        `;
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            width: 90% !important;
            max-width: 500px !important;
            background: #1f1f1f !important;
            color: #fff !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35) !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
        `;
        
        // å¤´éƒ¨
        const header = document.createElement('div');
        header.style.cssText = `
            padding: 16px 20px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            border-bottom: 1px solid rgba(255,255,255,0.08) !important;
            background: rgba(255,255,255,0.04) !important;
        `;
        const title = document.createElement('div');
        title.textContent = 'ç®¡ç†æ ‡ç­¾';
        title.style.cssText = 'font-weight: 600; font-size: 16px;';
        header.appendChild(title);
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            font-size: 18px !important;
        `;
        closeBtn.addEventListener('click', () => this.closeNewsTagModal());
        header.appendChild(closeBtn);
        panel.appendChild(header);
        
        // å†…å®¹åŒºåŸŸ
        const content = document.createElement('div');
        content.style.cssText = `
            padding: 20px !important;
        `;
        
        // æ ‡ç­¾è¾“å…¥åŒºåŸŸ
        const tagInputGroup = document.createElement('div');
        tagInputGroup.style.cssText = 'margin-bottom: 16px;';
        const tagInputLabel = document.createElement('label');
        tagInputLabel.textContent = 'æ·»åŠ æ ‡ç­¾ï¼ˆæŒ‰Enteræ·»åŠ ï¼‰';
        tagInputLabel.style.cssText = 'display: block; margin-bottom: 8px; font-size: 14px; color: #e5e7eb;';
        const tagInputContainer = document.createElement('div');
        tagInputContainer.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            align-items: center !important;
            flex-wrap: wrap !important;
            padding: 10px 12px !important;
            background: rgba(255,255,255,0.08) !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            border-radius: 6px !important;
            min-height: 44px !important;
        `;
        
        // æ ‡ç­¾åˆ—è¡¨å®¹å™¨
        const tagInputList = document.createElement('div');
        tagInputList.id = 'news-tag-input-list';
        tagInputList.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 6px !important;
            flex: 1 !important;
        `;
        tagInputContainer.appendChild(tagInputList);
        
        // æ ‡ç­¾è¾“å…¥æ¡†
        const tagInput = document.createElement('input');
        tagInput.id = 'news-tag-input';
        tagInput.type = 'text';
        tagInput.placeholder = 'è¾“å…¥æ ‡ç­¾...';
        tagInput.style.cssText = `
            flex: 1 !important;
            min-width: 100px !important;
            background: transparent !important;
            border: none !important;
            color: #fff !important;
            font-size: 14px !important;
            outline: none !important;
        `;
        tagInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.addNewsTag();
            } else if (e.key === 'Backspace' && !tagInput.value && modal._currentTags && modal._currentTags.length > 0) {
                // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼ŒæŒ‰é€€æ ¼é”®åˆ é™¤æœ€åä¸€ä¸ªæ ‡ç­¾
                this.removeNewsTag(modal._currentTags[modal._currentTags.length - 1]);
            }
        });
        tagInputContainer.appendChild(tagInput);
        
        tagInputGroup.appendChild(tagInputLabel);
        tagInputGroup.appendChild(tagInputContainer);
        content.appendChild(tagInputGroup);
        
        panel.appendChild(content);
        
        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            padding: 16px 20px !important;
            display: flex !important;
            gap: 12px !important;
            justify-content: flex-end !important;
            border-top: 1px solid rgba(255,255,255,0.08) !important;
            background: rgba(255,255,255,0.04) !important;
        `;
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 8px 16px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            font-size: 14px !important;
        `;
        cancelBtn.addEventListener('click', () => this.closeNewsTagModal());
        footer.appendChild(cancelBtn);
        
        const saveBtn = document.createElement('button');
        saveBtn.id = 'news-tag-save-btn';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 8px 16px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(76, 175, 80, 0.3) !important;
            background: rgba(76, 175, 80, 0.3) !important;
            color: #4caf50 !important;
            cursor: pointer !important;
            font-size: 14px !important;
        `;
        saveBtn.addEventListener('click', async () => {
            if (saveBtn.hasAttribute('data-saving')) return;
            await this.saveNewsTags();
        });
        footer.appendChild(saveBtn);
        
        panel.appendChild(footer);
        modal.appendChild(panel);
        document.body.appendChild(modal);
    }
    
    // åŠ è½½æ–°é—»æ ‡ç­¾åˆ°ç®¡ç†å™¨
    loadNewsTagsIntoManager(newsItem, index, tags) {
        const modal = this.chatWindow?.querySelector('#pet-news-tag-manager');
        if (!modal) return;

        const tagsContainer = modal.querySelector('.news-tag-manager-tags');
        if (!tagsContainer) return;

        tagsContainer.innerHTML = '';

        if (!tags || tags.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #999 !important;
                padding: 20px !important;
                font-size: 14px !important;
            `;
            tagsContainer.appendChild(emptyMsg);
            return;
        }

        tags.forEach((tag, tagIndex) => {
            const tagItem = document.createElement('div');
            tagItem.style.cssText = `
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                background: #4CAF50 !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 20px !important;
                margin: 4px !important;
                font-size: 13px !important;
            `;

            const tagText = document.createElement('span');
            tagText.textContent = tag;

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = 'âœ•';
            removeBtn.style.cssText = `
                background: rgba(255, 255, 255, 0.3) !important;
                border: none !important;
                color: white !important;
                width: 18px !important;
                height: 18px !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                font-size: 12px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 0 !important;
                transition: background 0.2s ease !important;
            `;
            removeBtn.addEventListener('mouseenter', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.5)';
            });
            removeBtn.addEventListener('mouseleave', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            });
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // ä» modal çš„ dataset ä¸­è·å–æœ€æ–°çš„ newsItem å’Œ indexï¼Œé¿å…é—­åŒ…ä¸­çš„å€¼è¿‡æ—¶
                const modal = this.chatWindow?.querySelector('#pet-news-tag-manager');
                if (!modal) return;
                
                const newsIndex = modal.dataset.newsIndex;
                if (newsIndex === undefined) return;
                
                // ä» window.currentNews è·å–æœ€æ–°çš„æ–°é—»é¡¹
                let currentNewsItem = null;
                if (window.currentNews && Array.isArray(window.currentNews) && parseInt(newsIndex) >= 0) {
                    currentNewsItem = window.currentNews[parseInt(newsIndex)];
                }
                
                if (!currentNewsItem) return;
                
                // ä½¿ç”¨æ ‡ç­¾å€¼åˆ é™¤ï¼Œé¿å…ç´¢å¼•é”™ä½é—®é¢˜
                this.removeNewsTagByValue(currentNewsItem, parseInt(newsIndex), tag);
            });

            tagItem.appendChild(tagText);
            tagItem.appendChild(removeBtn);
            tagsContainer.appendChild(tagItem);
        });

        // æ›´æ–°å¿«æ·æ ‡ç­¾æŒ‰é’®çŠ¶æ€
        const quickTagButtons = modal.querySelectorAll('.news-tag-manager-quick-tag-btn');
        quickTagButtons.forEach(btn => {
            const tagName = btn.dataset.tagName;
            const isAdded = tags && tags.includes(tagName);
            if (isAdded) {
                btn.style.background = '#4CAF50';
                btn.style.color = 'white';
                btn.style.borderColor = '#4CAF50';
                btn.style.opacity = '0.7';
                btn.style.cursor = 'not-allowed';
            } else {
                btn.style.background = '#f0f0f0';
                btn.style.color = '#333';
                btn.style.borderColor = '#d0d0d0';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    }

    // ä»è¾“å…¥æ¡†æ·»åŠ æ–°é—»æ ‡ç­¾
    addNewsTagFromInput(newsItem, index) {
        const modal = this.chatWindow?.querySelector('#pet-news-tag-manager');
        if (!modal) return;

        const tagInput = modal.querySelector('.news-tag-manager-input');
        if (!tagInput) return;

        const tagName = tagInput.value.trim();
        if (!tagName) return;

        // è·å–å½“å‰æ ‡ç­¾
        if (!newsItem.tags) {
            newsItem.tags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (newsItem.tags.includes(tagName)) {
            tagInput.value = '';
            tagInput.focus();
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        newsItem.tags.push(tagName);
        tagInput.value = '';
        tagInput.focus();

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadNewsTagsIntoManager(newsItem, index, newsItem.tags);
    }

    // æ·»åŠ æ–°é—»å¿«æ·æ ‡ç­¾
    addNewsQuickTag(newsItem, index, tagName) {
        const modal = this.chatWindow?.querySelector('#pet-news-tag-manager');
        if (!modal) return;

        if (!newsItem.tags) {
            newsItem.tags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (newsItem.tags.includes(tagName)) {
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        newsItem.tags.push(tagName);

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadNewsTagsIntoManager(newsItem, index, newsItem.tags);
    }

    // åˆ é™¤æ–°é—»æ ‡ç­¾ï¼ˆæ ¹æ®ç´¢å¼•ï¼‰
    removeNewsTag(newsItem, index, tagIndex) {
        if (!newsItem.tags) return;

        newsItem.tags.splice(tagIndex, 1);
        this.loadNewsTagsIntoManager(newsItem, index, newsItem.tags);
    }
    
    // åˆ é™¤æ–°é—»æ ‡ç­¾ï¼ˆæ ¹æ®æ ‡ç­¾å€¼ï¼Œæ›´å¯é ï¼‰
    removeNewsTagByValue(newsItem, index, tagValue) {
        if (!newsItem || !newsItem.tags) return;

        const tagIndex = newsItem.tags.indexOf(tagValue);
        if (tagIndex >= 0) {
            newsItem.tags.splice(tagIndex, 1);
            this.loadNewsTagsIntoManager(newsItem, index, newsItem.tags);
        }
    }

    // æ™ºèƒ½ç”Ÿæˆæ–°é—»æ ‡ç­¾
    async generateNewsSmartTags(newsItem, index, buttonElement) {
        if (!newsItem) {
            console.warn('æ–°é—»é¡¹ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæ ‡ç­¾');
            return;
        }

        const modal = this.chatWindow?.querySelector('#pet-news-tag-manager');
        
        if (!modal) {
            console.error('æ–°é—»æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }

        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.style.background = '#ccc';
            buttonElement.style.cursor = 'not-allowed';
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // æ”¶é›†æ–°é—»ä¿¡æ¯
                const newsTitle = newsItem.title || 'å½“å‰æ–°é—»';
                const newsDescription = newsItem.description || '';
                const newsContent = newsItem.content || '';
                
                // æ„å»ºæç¤ºè¯
                const prompt = `è¯·æ ¹æ®ä»¥ä¸‹æ–°é—»ä¿¡æ¯ï¼Œç”Ÿæˆ3-5ä¸ªåˆé€‚çš„æ ‡ç­¾ï¼ˆç”¨ä¸­æ–‡ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¸è¦åŒ…å«"æ ‡ç­¾"ã€"åˆ†ç±»"ç­‰è¯ï¼‰ï¼š
æ ‡é¢˜ï¼š${newsTitle}
æè¿°ï¼š${newsDescription}
å†…å®¹ï¼š${newsContent.substring(0, 500)}`;

                // ä½¿ç”¨ç®€å•çš„å…³é”®è¯æå–ï¼ˆæ™ºèƒ½ç”ŸæˆåŠŸèƒ½å¯ä»¥åç»­æ‰©å±•ï¼‰
                const keywords = this.extractKeywordsFromNews(newsItem);
                if (keywords.length > 0) {
                    if (!newsItem.tags) {
                        newsItem.tags = [];
                    }
                    keywords.forEach(tag => {
                        if (!newsItem.tags.includes(tag)) {
                            newsItem.tags.push(tag);
                        }
                    });
                    this.loadNewsTagsIntoManager(newsItem, index, newsItem.tags);
                    this.showNotification('å·²æ·»åŠ å…³é”®è¯æ ‡ç­¾', 'success');
                } else {
                    this.showNotification('æ— æ³•æå–å…³é”®è¯', 'info');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæ ‡ç­¾å¤±è´¥:', error);
                this.showNotification('ç”Ÿæˆæ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            } finally {
                buttonElement.disabled = false;
                buttonElement.style.background = '#9C27B0';
                buttonElement.style.cursor = 'pointer';
                buttonElement.textContent = originalText;
            }
        }
    }

    // ä»æ–°é—»ä¸­æå–å…³é”®è¯ï¼ˆç®€å•å®ç°ï¼‰
    extractKeywordsFromNews(newsItem) {
        const text = `${newsItem.title || ''} ${newsItem.description || ''} ${newsItem.content || ''}`;
        // ç®€å•çš„å…³é”®è¯æå–é€»è¾‘ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›ï¼‰
        const keywords = [];
        const commonTags = ['æŠ€æœ¯', 'æ–°é—»', 'ç§‘æŠ€', 'äº’è”ç½‘', 'å•†ä¸š', 'å¨±ä¹', 'ä½“è‚²', 'æ”¿æ²»', 'ç¤¾ä¼š', 'æ–‡åŒ–'];
        commonTags.forEach(tag => {
            if (text.includes(tag)) {
                keywords.push(tag);
            }
        });
        return keywords.slice(0, 3); // æœ€å¤šè¿”å›3ä¸ªå…³é”®è¯
    }

    // æ›´æ–°æ ‡ç­¾è¾“å…¥åˆ—è¡¨æ˜¾ç¤º
    updateNewsTagInputList(container, tags) {
        if (!container) return;
        container.innerHTML = '';
        
        tags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'news-tag-item';
            tagElement.style.cssText = `
                display: inline-flex !important;
                align-items: center !important;
                gap: 6px !important;
                padding: 4px 10px !important;
                background: rgba(76, 175, 80, 0.2) !important;
                border: 1px solid rgba(76, 175, 80, 0.3) !important;
                border-radius: 12px !important;
                font-size: 12px !important;
                color: #4caf50 !important;
            `;
            tagElement.textContent = tag;
            
            const removeBtn = document.createElement('span');
            removeBtn.textContent = 'Ã—';
            removeBtn.style.cssText = `
                cursor: pointer !important;
                font-size: 16px !important;
                line-height: 1 !important;
                margin-left: 4px !important;
                opacity: 0.7 !important;
            `;
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.removeNewsTag(tag);
            });
            tagElement.appendChild(removeBtn);
            
            container.appendChild(tagElement);
        });
    }
    
    // æ·»åŠ æ–°é—»æ ‡ç­¾
    addNewsTag() {
        const modal = document.getElementById('pet-news-tag-modal');
        if (!modal) return;
        
        const tagInput = modal.querySelector('#news-tag-input');
        if (!tagInput) return;
        
        const tagText = tagInput.value.trim();
        if (!tagText) return;
        
        if (!modal._currentTags) {
            modal._currentTags = [];
        }
        
        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (modal._currentTags.includes(tagText)) {
            this.showNotification('æ ‡ç­¾å·²å­˜åœ¨', 'info');
            return;
        }
        
        // æ·»åŠ æ ‡ç­¾
        modal._currentTags.push(tagText);
        tagInput.value = '';
        
        // æ›´æ–°æ˜¾ç¤º
        const tagInputList = modal.querySelector('#news-tag-input-list');
        if (tagInputList) {
            this.updateNewsTagInputList(tagInputList, modal._currentTags);
        }
        
        // é‡æ–°èšç„¦è¾“å…¥æ¡†
        tagInput.focus();
    }
    
    // åˆ é™¤æ–°é—»æ ‡ç­¾
    removeNewsTag(tag) {
        const modal = document.getElementById('pet-news-tag-modal');
        if (!modal) return;
        
        if (!modal._currentTags) return;
        
        const index = modal._currentTags.indexOf(tag);
        if (index >= 0) {
            modal._currentTags.splice(index, 1);
            
            // æ›´æ–°æ˜¾ç¤º
            const tagInputList = modal.querySelector('#news-tag-input-list');
            if (tagInputList) {
                this.updateNewsTagInputList(tagInputList, modal._currentTags);
            }
        }
    }
    
    // ä¿å­˜æ–°é—»æ ‡ç­¾ï¼ˆæ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨æ–°çš„æ ‡ç­¾ç®¡ç†å™¨ï¼‰
    async saveNewsTags(newsItem, index) {
        if (!newsItem) {
            console.warn('æ–°é—»é¡¹ä¸å­˜åœ¨ï¼Œæ— æ³•ä¿å­˜æ ‡ç­¾');
            return;
        }

        const modal = this.chatWindow?.querySelector('#pet-news-tag-manager');
        if (!modal) return;

        const saveBtn = modal.querySelector('.news-tag-manager-save');
        if (!saveBtn) return;

        if (saveBtn.hasAttribute('data-saving')) return;

        saveBtn.setAttribute('data-saving', 'true');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
        saveBtn.style.opacity = '0.6';
        saveBtn.style.cursor = 'not-allowed';

        try {
            // è§„èŒƒåŒ–æ ‡ç­¾ï¼ˆtrimå¤„ç†ï¼Œå»é‡ï¼Œè¿‡æ»¤ç©ºæ ‡ç­¾ï¼‰
            if (newsItem.tags && Array.isArray(newsItem.tags)) {
                const normalizedTags = newsItem.tags
                    .map(tag => tag ? tag.trim() : '')
                    .filter(tag => tag.length > 0);
                // å»é‡
                newsItem.tags = [...new Set(normalizedTags)];
            }

            const tags = newsItem.tags || [];
            const newsKey = newsItem.key || modal.dataset.newsKey;
            const newsLink = newsItem.link || modal.dataset.newsLink;

            // æ„å»ºæ›´æ–°æ•°æ®
            const updateData = {
                tags: tags
            };
            
            // å¦‚æœæœ‰keyï¼Œä½¿ç”¨keyï¼›å¦åˆ™å°è¯•ä½¿ç”¨link
            if (newsKey) {
                updateData.key = newsKey;
            } else if (newsLink) {
                updateData.link = newsLink;
            }

            // è°ƒç”¨åç«¯APIä¿å­˜æ ‡ç­¾ï¼ˆæ— è®ºæ˜¯å¦æœ‰keyï¼‰
            const apiUrl = this.newsManager?.apiUrl || 'https://api.effiy.cn/mongodb/';
            const cname = this.newsManager?.cname || 'rss';

            const response = await fetch(`${apiUrl}?cname=${cname}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            if (result.code === 200) {
                // æ›´æ–°æ–°é—»ç®¡ç†å™¨ä¸­çš„æ•°æ®
                if (this.newsManager) {
                    const allNews = this.newsManager.getAllNews();
                    const newsIndex = allNews.findIndex(n => 
                        (newsKey && n.key && n.key === newsKey) || 
                        (newsLink && n.link && n.link === newsLink)
                    );
                    if (newsIndex >= 0) {
                        allNews[newsIndex].tags = tags;
                    }
                }

                // æ›´æ–°window.currentNewsä¸­çš„æ•°æ®
                if (window.currentNews && Array.isArray(window.currentNews) && index >= 0) {
                    if (window.currentNews[index]) {
                        window.currentNews[index].tags = tags;
                    }
                }

                // é‡æ–°æ¸²æŸ“æ–°é—»åˆ—è¡¨
                await this.updateNewsSidebar(false);

                this.showNotification('æ ‡ç­¾å·²ä¿å­˜', 'success');
                this.closeNewsTagManager();
            } else {
                throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
            this.showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        } finally {
            saveBtn.removeAttribute('data-saving');
            saveBtn.textContent = originalText;
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
        }
    }

    // å…³é—­æ–°é—»æ ‡ç­¾ç®¡ç†å™¨ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
    async closeNewsTagManager() {
        const modal = this.chatWindow?.querySelector('#pet-news-tag-manager');
        if (modal) {
            const newsIndex = modal.dataset.newsIndex;
            const newsKey = modal.dataset.newsKey;
            const newsLink = modal.dataset.newsLink;
            
            // å…³é—­å‰è‡ªåŠ¨ä¿å­˜
            if (newsIndex !== undefined) {
                try {
                    let newsItem = null;
                    if (window.currentNews && Array.isArray(window.currentNews) && parseInt(newsIndex) >= 0) {
                        newsItem = window.currentNews[parseInt(newsIndex)];
                    }
                    
                    if (newsItem) {
                        // è§„èŒƒåŒ–æ ‡ç­¾ï¼ˆtrimå¤„ç†ï¼Œå»é‡ï¼Œè¿‡æ»¤ç©ºæ ‡ç­¾ï¼‰
                        if (newsItem.tags && Array.isArray(newsItem.tags)) {
                            const normalizedTags = newsItem.tags
                                .map(tag => tag ? tag.trim() : '')
                                .filter(tag => tag.length > 0);
                            // å»é‡
                            newsItem.tags = [...new Set(normalizedTags)];
                        }
                        
                        // å¦‚æœæœ‰keyï¼Œä¿å­˜åˆ°åç«¯
                        if (newsItem.key) {
                            const apiUrl = this.newsManager?.apiUrl || 'https://api.effiy.cn/mongodb/';
                            const cname = this.newsManager?.cname || 'rss';
                            
                            try {
                                const response = await fetch(`${apiUrl}?cname=${cname}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        key: newsItem.key,
                                        tags: newsItem.tags || []
                                    })
                                });
                                
                                if (response.ok) {
                                    const result = await response.json();
                                    if (result.code === 200) {
                                        // æ›´æ–°æ–°é—»ç®¡ç†å™¨ä¸­çš„æ•°æ®
                                        if (this.newsManager) {
                                            const allNews = this.newsManager.getAllNews();
                                            const newsIndex = allNews.findIndex(n => 
                                                (n.key && n.key === newsItem.key) || 
                                                (n.link && n.link === newsItem.link)
                                            );
                                            if (newsIndex >= 0) {
                                                allNews[newsIndex].tags = newsItem.tags;
                                            }
                                        }
                                        
                                        await this.updateNewsSidebar(false);
                                    }
                                }
                            } catch (error) {
                                console.error('è‡ªåŠ¨ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
                            }
                        } else {
                            // æ²¡æœ‰keyï¼Œåªæ›´æ–°æœ¬åœ°
                            await this.updateNewsSidebar(false);
                        }
                    }
                } catch (error) {
                    console.error('è‡ªåŠ¨ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
                }
            }
            
            modal.style.display = 'none';
            
            // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
            const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
            const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
            if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
            if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
            
            const tagInput = modal.querySelector('.news-tag-manager-input');
            if (tagInput) {
                tagInput.value = '';
            }
        }
    }
    
    // åˆ é™¤æ–°é—»é¡¹
    async deleteNewsItem(newsItem, index, skipConfirm = false) {
        if (!newsItem) return;
        
        // è·å–æ–°é—»æ ‡é¢˜ç”¨äºæç¤º
        const newsTitle = newsItem?.title || newsItem?.link || 'æœªå‘½åæ–°é—»';
        
        // ç¡®è®¤åˆ é™¤ï¼ˆå¦‚æœæœªè·³è¿‡ç¡®è®¤ï¼‰
        if (!skipConfirm) {
            const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤æ–°é—»"${newsTitle}"å—ï¼Ÿ`);
            if (!confirmDelete) return;
        }
        
        try {
            // å¦‚æœæ–°é—»ç®¡ç†å™¨å­˜åœ¨ï¼Œå…ˆè°ƒç”¨æ¥å£åˆ é™¤
            if (this.newsManager) {
                try {
                    await this.newsManager.deleteNews(newsItem);
                } catch (error) {
                    console.error('è°ƒç”¨åˆ é™¤æ¥å£å¤±è´¥:', error);
                    throw new Error(`åˆ é™¤å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}`);
                }
            } else {
                // å¦‚æœæ²¡æœ‰æ–°é—»ç®¡ç†å™¨ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯
                throw new Error('æ–°é—»ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ é™¤');
            }
            
            // ä»æœ¬åœ°æ–°é—»åˆ—è¡¨ä¸­ç§»é™¤
            if (window.currentNews && Array.isArray(window.currentNews)) {
                window.currentNews = window.currentNews.filter((item, i) => i !== index);
            }
            
            // é‡æ–°æ¸²æŸ“æ–°é—»åˆ—è¡¨
            await this.updateNewsSidebar(false);
            
            this.showNotification('æ–°é—»å·²åˆ é™¤', 'success');
            console.log('æ–°é—»å·²åˆ é™¤:', newsItem);
        } catch (error) {
            console.error('åˆ é™¤æ–°é—»å¤±è´¥:', error);
            throw error;
        }
    }
    
    // æ ¼å¼åŒ–æ–°é—»æ—¶é—´æ˜¾ç¤º
    formatNewsTime(timestamp) {
        // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦æœ‰æ•ˆ
        if (!timestamp || timestamp <= 0 || isNaN(timestamp)) {
            return '';
        }
        
        try {
            const date = new Date(timestamp);
            
            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
            if (isNaN(date.getTime())) {
                return '';
            }
            
            const now = new Date();
            const diff = now - date;
            
            // å¦‚æœæ—¶é—´åœ¨æœªæ¥ï¼Œæ˜¾ç¤ºä¸º"åˆšåˆš"
            if (diff < 0) {
                return 'åˆšåˆš';
            }
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            const weeks = Math.floor(days / 7);
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);
            
            if (minutes < 1) {
                return 'åˆšåˆš';
            } else if (minutes < 60) {
                return `${minutes}åˆ†é’Ÿå‰`;
            } else if (hours < 24) {
                return `${hours}å°æ—¶å‰`;
            } else if (days < 7) {
                return `${days}å¤©å‰`;
            } else if (weeks < 4) {
                return `${weeks}å‘¨å‰`;
            } else if (months < 12) {
                return `${months}ä¸ªæœˆå‰`;
            } else if (years < 1) {
                // ä¸€å¹´å†…ï¼Œæ˜¾ç¤ºæœˆæ—¥
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
            } else {
                // è¶…è¿‡ä¸€å¹´ï¼Œæ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
                return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' });
            }
        } catch (error) {
            console.warn('æ ¼å¼åŒ–æ–°é—»æ—¶é—´å¤±è´¥:', error, timestamp);
            return '';
        }
    }
    
    // æ ¹æ®æ ‡ç­¾åç§°ç”Ÿæˆé¢œè‰²ï¼ˆç¡®ä¿ç›¸åŒæ ‡ç­¾é¢œè‰²ä¸€è‡´ï¼‰
    getTagColor(tagName) {
        // é¢„å®šä¹‰çš„é…è‰²æ–¹æ¡ˆï¼ˆæŸ”å’Œçš„æ¸å˜è‰²ï¼‰
        const colorPalettes = [
            // è“è‰²ç³»
            { background: 'linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)', text: '#0369a1', border: '#7dd3fc' },
            // ç»¿è‰²ç³»
            { background: 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)', text: '#166534', border: '#86efac' },
            // ç´«è‰²ç³»
            { background: 'linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%)', text: '#6b21a8', border: '#c084fc' },
            // ç²‰è‰²ç³»
            { background: 'linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%)', text: '#9f1239', border: '#f9a8d4' },
            // æ©™è‰²ç³»
            { background: 'linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%)', text: '#9a3412', border: '#fdba74' },
            // é’è‰²ç³»
            { background: 'linear-gradient(135deg, #ecfeff 0%, #cffafe 100%)', text: '#164e63', border: '#67e8f9' },
            // çº¢è‰²ç³»
            { background: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)', text: '#991b1b', border: '#fca5a5' },
            // é»„è‰²ç³»
            { background: 'linear-gradient(135deg, #fefce8 0%, #fef9c3 100%)', text: '#854d0e', border: '#fde047' },
            // é›è“è‰²ç³»
            { background: 'linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%)', text: '#3730a3', border: '#a5b4fc' },
            // ç«ç‘°è‰²ç³»
            { background: 'linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%)', text: '#9f1239', border: '#fda4af' }
        ];
        
        // ä½¿ç”¨ç®€å•çš„å“ˆå¸Œå‡½æ•°å°†æ ‡ç­¾åç§°æ˜ å°„åˆ°é¢œè‰²ç´¢å¼•
        let hash = 0;
        for (let i = 0; i < tagName.length; i++) {
            hash = ((hash << 5) - hash) + tagName.charCodeAt(i);
            hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        
        // ç¡®ä¿ç´¢å¼•ä¸ºæ­£æ•°å¹¶åœ¨èŒƒå›´å†…
        const index = Math.abs(hash) % colorPalettes.length;
        return colorPalettes[index];
    }
    
    // æ˜¾ç¤ºRSSæºç®¡ç†ç•Œé¢
    async showRssSourceManager() {
        if (!this.rssSourceManager) {
            console.warn('RSSæºç®¡ç†å™¨æœªåˆå§‹åŒ–');
            return;
        }
        
        // ç¡®ä¿RSSæºç®¡ç†UIå­˜åœ¨
        this.ensureRssSourceManagerUi();
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = document.querySelector('#pet-rss-source-manager');
        if (modal) {
            modal.style.display = 'flex';
            // åŠ è½½RSSæºåˆ—è¡¨
            await this.loadRssSourcesIntoManager();
            // æ›´æ–°å®šæ—¶å™¨çŠ¶æ€
            await this.updateSchedulerStatus();
        }
    }
    
    // ç¡®ä¿RSSæºç®¡ç†UIå­˜åœ¨
    ensureRssSourceManagerUi() {
        if (document.querySelector('#pet-rss-source-manager')) return;
        
        const mainColor = PET_CONFIG?.theme?.primaryColor || '#6366f1';
        
        const modal = document.createElement('div');
        modal.id = 'pet-rss-source-manager';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: ${PET_CONFIG?.ui?.zIndex?.modal || 2147483649} !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeRssSourceManager();
            }
        });
        
        // ESCé”®å…³é—­
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                this.closeRssSourceManager();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 24px !important;
            width: 90% !important;
            max-width: 800px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        `;
        
        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'RSSæºç®¡ç†';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'rss-source-manager-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.title = 'å…³é—­ï¼ˆESCï¼‰';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });
        closeBtn.addEventListener('click', () => this.closeRssSourceManager());
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // æ·»åŠ RSSæºè¡¨å•
        const addForm = document.createElement('div');
        addForm.className = 'rss-source-add-form';
        addForm.style.cssText = `
            margin-bottom: 20px !important;
            padding: 16px !important;
            background: #f8f9fa !important;
            border-radius: 8px !important;
        `;
        
        const formTitle = document.createElement('div');
        formTitle.textContent = 'æ·»åŠ RSSæº';
        formTitle.style.cssText = `
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #333 !important;
            margin-bottom: 12px !important;
        `;
        
        const urlInput = document.createElement('input');
        urlInput.type = 'url';
        urlInput.placeholder = 'RSSæºURLï¼ˆä¾‹å¦‚ï¼šhttps://example.com/rss.xmlï¼‰';
        urlInput.className = 'rss-source-url-input';
        urlInput.style.cssText = `
            width: 100% !important;
            padding: 10px 12px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            margin-bottom: 8px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
            box-sizing: border-box !important;
        `;
        urlInput.addEventListener('focus', () => {
            urlInput.style.borderColor = mainColor;
        });
        urlInput.addEventListener('blur', () => {
            urlInput.style.borderColor = '#e0e0e0';
        });
        
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨URLï¼‰';
        nameInput.className = 'rss-source-name-input';
        nameInput.style.cssText = `
            width: 100% !important;
            padding: 10px 12px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            margin-bottom: 8px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
            box-sizing: border-box !important;
        `;
        nameInput.addEventListener('focus', () => {
            nameInput.style.borderColor = mainColor;
        });
        nameInput.addEventListener('blur', () => {
            nameInput.style.borderColor = '#e0e0e0';
        });
        
        const addBtn = document.createElement('button');
        addBtn.textContent = 'æ·»åŠ ';
        addBtn.className = 'rss-source-add-btn';
        addBtn.style.cssText = `
            padding: 10px 20px !important;
            background: ${mainColor} !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            width: 100% !important;
        `;
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.opacity = '0.9';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.opacity = '1';
        });
        addBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            const name = nameInput.value.trim();
            
            if (!url) {
                alert('è¯·è¾“å…¥RSSæºURL');
                return;
            }
            
            try {
                await this.rssSourceManager.addSource({ url, name });
                urlInput.value = '';
                nameInput.value = '';
                await this.loadRssSourcesIntoManager();
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        });
        
        addForm.appendChild(formTitle);
        addForm.appendChild(urlInput);
        addForm.appendChild(nameInput);
        addForm.appendChild(addBtn);
        
        // å®šæ—¶å™¨é…ç½®åŒºåŸŸ
        const schedulerConfig = document.createElement('div');
        schedulerConfig.className = 'rss-scheduler-config';
        schedulerConfig.style.cssText = `
            margin-bottom: 20px !important;
            padding: 16px !important;
            background: #f0f7ff !important;
            border-radius: 8px !important;
            border: 1px solid #b3d9ff !important;
        `;
        
        const schedulerTitle = document.createElement('div');
        schedulerTitle.textContent = 'å®šæ—¶è§£æé…ç½®';
        schedulerTitle.style.cssText = `
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #333 !important;
            margin-bottom: 12px !important;
        `;
        
        const schedulerStatus = document.createElement('div');
        schedulerStatus.className = 'rss-scheduler-status';
        schedulerStatus.style.cssText = `
            font-size: 12px !important;
            color: #666 !important;
            margin-bottom: 12px !important;
        `;
        schedulerStatus.textContent = 'åŠ è½½ä¸­...';
        
        // æ¨¡å¼é€‰æ‹©
        const modeContainer = document.createElement('div');
        modeContainer.style.cssText = `
            margin-bottom: 12px !important;
            display: flex !important;
            gap: 10px !important;
            align-items: center !important;
        `;
        
        const modeLabel = document.createElement('label');
        modeLabel.textContent = 'å®šæ—¶æ¨¡å¼:';
        modeLabel.style.cssText = `
            font-size: 12px !important;
            color: #666 !important;
        `;
        
        const modeSelect = document.createElement('select');
        modeSelect.className = 'rss-scheduler-mode';
        modeSelect.style.cssText = `
            padding: 6px 8px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            outline: none !important;
            background: white !important;
            cursor: pointer !important;
        `;
        const intervalOption = document.createElement('option');
        intervalOption.value = 'interval';
        intervalOption.textContent = 'é—´éš”æ¨¡å¼';
        const cronOption = document.createElement('option');
        cronOption.value = 'cron';
        cronOption.textContent = 'Cron æ¨¡å¼ï¼ˆæ¯æ—¥/æ¯æœˆ/æ—¶/åˆ†/ç§’ï¼‰';
        modeSelect.appendChild(intervalOption);
        modeSelect.appendChild(cronOption);
        
        // é—´éš”æ¨¡å¼é…ç½®
        const intervalContainer = document.createElement('div');
        intervalContainer.className = 'rss-scheduler-interval-container';
        intervalContainer.style.cssText = `
            display: flex !important;
            gap: 10px !important;
            align-items: center !important;
            margin-bottom: 12px !important;
        `;
        
        const intervalLabel = document.createElement('label');
        intervalLabel.textContent = 'é—´éš”ï¼ˆç§’ï¼‰:';
        intervalLabel.style.cssText = `
            font-size: 12px !important;
            color: #666 !important;
        `;
        
        const intervalInput = document.createElement('input');
        intervalInput.type = 'number';
        intervalInput.min = '60';
        intervalInput.step = '60';
        intervalInput.value = '3600';
        intervalInput.className = 'rss-scheduler-interval';
        intervalInput.style.cssText = `
            width: 100px !important;
            padding: 6px 8px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
        `;
        intervalInput.addEventListener('focus', () => {
            intervalInput.style.borderColor = mainColor;
        });
        intervalInput.addEventListener('blur', () => {
            intervalInput.style.borderColor = '#e0e0e0';
        });
        
        intervalContainer.appendChild(intervalLabel);
        intervalContainer.appendChild(intervalInput);
        
        // Cron æ¨¡å¼é…ç½®
        const cronContainer = document.createElement('div');
        cronContainer.className = 'rss-scheduler-cron-container';
        cronContainer.style.cssText = `
            display: none !important;
            flex-direction: column !important;
            gap: 8px !important;
            margin-bottom: 12px !important;
        `;
        
        const createCronField = (label, field, min, max, placeholder) => {
            const fieldContainer = document.createElement('div');
            fieldContainer.style.cssText = `
                display: flex !important;
                gap: 8px !important;
                align-items: center !important;
            `;
            
            const fieldLabel = document.createElement('label');
            fieldLabel.textContent = label + ':';
            fieldLabel.style.cssText = `
                font-size: 12px !important;
                color: #666 !important;
                width: 80px !important;
            `;
            
            const fieldInput = document.createElement('input');
            fieldInput.type = 'number';
            fieldInput.min = min !== null ? min : '';
            fieldInput.max = max !== null ? max : '';
            fieldInput.placeholder = placeholder || 'ç•™ç©ºè¡¨ç¤ºä»»æ„';
            fieldInput.className = `rss-scheduler-cron-${field}`;
            fieldInput.style.cssText = `
                width: 100px !important;
                padding: 6px 8px !important;
                border: 2px solid #e0e0e0 !important;
                border-radius: 4px !important;
                font-size: 12px !important;
                outline: none !important;
                transition: border-color 0.2s ease !important;
            `;
            fieldInput.addEventListener('focus', () => {
                fieldInput.style.borderColor = mainColor;
            });
            fieldInput.addEventListener('blur', () => {
                fieldInput.style.borderColor = '#e0e0e0';
            });
            
            const clearBtn = document.createElement('button');
            clearBtn.textContent = 'æ¸…ç©º';
            clearBtn.style.cssText = `
                padding: 4px 8px !important;
                background: #f0f0f0 !important;
                color: #666 !important;
                border: none !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 11px !important;
            `;
            clearBtn.addEventListener('click', () => {
                fieldInput.value = '';
            });
            
            fieldContainer.appendChild(fieldLabel);
            fieldContainer.appendChild(fieldInput);
            fieldContainer.appendChild(clearBtn);
            
            return { container: fieldContainer, input: fieldInput };
        };
        
        const secondField = createCronField('ç§’', 'second', 0, 59, '0-59');
        const minuteField = createCronField('åˆ†', 'minute', 0, 59, '0-59');
        const hourField = createCronField('æ—¶', 'hour', 0, 23, '0-23');
        const dayField = createCronField('æ—¥', 'day', 1, 31, '1-31');
        const monthField = createCronField('æœˆ', 'month', 1, 12, '1-12');
        const dayOfWeekField = createCronField('æ˜ŸæœŸ', 'day_of_week', 0, 6, '0-6 (0=å‘¨ä¸€)');
        
        cronContainer.appendChild(secondField.container);
        cronContainer.appendChild(minuteField.container);
        cronContainer.appendChild(hourField.container);
        cronContainer.appendChild(dayField.container);
        cronContainer.appendChild(monthField.container);
        cronContainer.appendChild(dayOfWeekField.container);
        
        const cronHint = document.createElement('div');
        cronHint.textContent = 'æç¤ºï¼šç•™ç©ºçš„å­—æ®µè¡¨ç¤ºä»»æ„å€¼ã€‚ä¾‹å¦‚ï¼šåªè®¾ç½®"æ—¶"ä¸º9ï¼Œè¡¨ç¤ºæ¯å¤©9ç‚¹æ‰§è¡Œã€‚';
        cronHint.style.cssText = `
            font-size: 11px !important;
            color: #999 !important;
            margin-top: 4px !important;
        `;
        cronContainer.appendChild(cronHint);
        
        // æ¨¡å¼åˆ‡æ¢
        modeSelect.addEventListener('change', () => {
            if (modeSelect.value === 'interval') {
                intervalContainer.style.display = 'flex';
                cronContainer.style.display = 'none';
            } else {
                intervalContainer.style.display = 'none';
                cronContainer.style.display = 'flex';
            }
        });
        
        const schedulerControls = document.createElement('div');
        schedulerControls.style.cssText = `
            display: flex !important;
            gap: 10px !important;
            align-items: center !important;
            flex-wrap: wrap !important;
        `;
        
        const startBtn = document.createElement('button');
        startBtn.textContent = 'å¯åŠ¨';
        startBtn.className = 'rss-scheduler-start';
        startBtn.style.cssText = `
            padding: 6px 12px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            transition: opacity 0.2s ease !important;
        `;
        startBtn.addEventListener('mouseenter', () => {
            startBtn.style.opacity = '0.9';
        });
        startBtn.addEventListener('mouseleave', () => {
            startBtn.style.opacity = '1';
        });
        startBtn.addEventListener('click', async () => {
            try {
                const mode = modeSelect.value;
                let config = { enabled: true };
                
                if (mode === 'interval') {
                    const interval = parseInt(intervalInput.value);
                    if (interval < 60) {
                        alert('é—´éš”ä¸èƒ½å°äº 60 ç§’');
                        return;
                    }
                    config.type = 'interval';
                    config.interval = interval;
                } else {
                    config.type = 'cron';
                    const cron = {};
                    const secondVal = secondField.input.value.trim();
                    const minuteVal = minuteField.input.value.trim();
                    const hourVal = hourField.input.value.trim();
                    const dayVal = dayField.input.value.trim();
                    const monthVal = monthField.input.value.trim();
                    const dayOfWeekVal = dayOfWeekField.input.value.trim();
                    
                    if (secondVal) cron.second = parseInt(secondVal);
                    if (minuteVal) cron.minute = parseInt(minuteVal);
                    if (hourVal) cron.hour = parseInt(hourVal);
                    if (dayVal) cron.day = parseInt(dayVal);
                    if (monthVal) cron.month = parseInt(monthVal);
                    if (dayOfWeekVal) cron.day_of_week = parseInt(dayOfWeekVal);
                    
                    // è‡³å°‘éœ€è¦è®¾ç½®ä¸€ä¸ªå­—æ®µ
                    if (Object.keys(cron).length === 0) {
                        alert('è¯·è‡³å°‘è®¾ç½®ä¸€ä¸ª Cron å­—æ®µ');
                        return;
                    }
                    
                    config.cron = cron;
                }
                
                await this.rssSourceManager.configScheduler(config);
                await this.updateSchedulerStatus();
            } catch (error) {
                alert('å¯åŠ¨å¤±è´¥ï¼š' + error.message);
            }
        });
        
        const stopBtn = document.createElement('button');
        stopBtn.textContent = 'åœæ­¢';
        stopBtn.className = 'rss-scheduler-stop';
        stopBtn.style.cssText = `
            padding: 6px 12px !important;
            background: #f44336 !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            transition: opacity 0.2s ease !important;
        `;
        stopBtn.addEventListener('mouseenter', () => {
            stopBtn.style.opacity = '0.9';
        });
        stopBtn.addEventListener('mouseleave', () => {
            stopBtn.style.opacity = '1';
        });
        stopBtn.addEventListener('click', async () => {
            try {
                await this.rssSourceManager.stopScheduler();
                await this.updateSchedulerStatus();
            } catch (error) {
                alert('åœæ­¢å¤±è´¥ï¼š' + error.message);
            }
        });
        
        const parseAllBtn = document.createElement('button');
        parseAllBtn.textContent = 'ç«‹å³è§£æå…¨éƒ¨';
        parseAllBtn.className = 'rss-parse-all';
        parseAllBtn.style.cssText = `
            padding: 6px 12px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            transition: opacity 0.2s ease !important;
        `;
        parseAllBtn.addEventListener('mouseenter', () => {
            parseAllBtn.style.opacity = '0.9';
        });
        parseAllBtn.addEventListener('mouseleave', () => {
            parseAllBtn.style.opacity = '1';
        });
        parseAllBtn.addEventListener('click', async () => {
            if (confirm('ç¡®å®šè¦ç«‹å³è§£ææ‰€æœ‰å¯ç”¨çš„ RSS æºå—ï¼Ÿ')) {
                try {
                    parseAllBtn.disabled = true;
                    parseAllBtn.textContent = 'è§£æä¸­...';
                    const result = await this.rssSourceManager.parseAllEnabledSources();
                    alert(`è§£æå®Œæˆï¼æˆåŠŸ: ${result.success_count || 0} ä¸ªï¼Œå¤±è´¥: ${result.failed_count || 0} ä¸ª`);
                } catch (error) {
                    alert('è§£æå¤±è´¥ï¼š' + error.message);
                } finally {
                    parseAllBtn.disabled = false;
                    parseAllBtn.textContent = 'ç«‹å³è§£æå…¨éƒ¨';
                }
            }
        });
        
        schedulerControls.appendChild(startBtn);
        schedulerControls.appendChild(stopBtn);
        schedulerControls.appendChild(parseAllBtn);
        
        schedulerConfig.appendChild(schedulerTitle);
        schedulerConfig.appendChild(schedulerStatus);
        schedulerConfig.appendChild(modeContainer);
        modeContainer.appendChild(modeLabel);
        modeContainer.appendChild(modeSelect);
        schedulerConfig.appendChild(intervalContainer);
        schedulerConfig.appendChild(cronContainer);
        schedulerConfig.appendChild(schedulerControls);
        
        // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­æ›´æ–°
        this._rssSchedulerModeSelect = modeSelect;
        this._rssSchedulerIntervalInput = intervalInput;
        this._rssSchedulerCronFields = {
            second: secondField.input,
            minute: minuteField.input,
            hour: hourField.input,
            day: dayField.input,
            month: monthField.input,
            day_of_week: dayOfWeekField.input
        };
        
        // RSSæºåˆ—è¡¨
        const sourcesContainer = document.createElement('div');
        sourcesContainer.className = 'rss-source-list';
        sourcesContainer.style.cssText = `
            min-height: 200px !important;
            margin-bottom: 20px !important;
        `;
        
        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 10px !important;
        `;
        
        const closeFooterBtn = document.createElement('button');
        closeFooterBtn.textContent = 'å…³é—­';
        closeFooterBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #f0f0f0 !important;
            color: #333 !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: background 0.2s ease !important;
        `;
        closeFooterBtn.addEventListener('mouseenter', () => {
            closeFooterBtn.style.background = '#e0e0e0';
        });
        closeFooterBtn.addEventListener('mouseleave', () => {
            closeFooterBtn.style.background = '#f0f0f0';
        });
        closeFooterBtn.addEventListener('click', () => this.closeRssSourceManager());
        
        footer.appendChild(closeFooterBtn);
        
        panel.appendChild(header);
        panel.appendChild(addForm);
        panel.appendChild(schedulerConfig);
        panel.appendChild(sourcesContainer);
        panel.appendChild(footer);
        modal.appendChild(panel);
        document.body.appendChild(modal);
        
        // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­æ›´æ–°
        this._rssSchedulerStatus = schedulerStatus;
        this._rssSchedulerInterval = intervalInput;
        this._rssSchedulerStartBtn = startBtn;
        this._rssSchedulerStopBtn = stopBtn;
    }
    
    // æ›´æ–°å®šæ—¶å™¨çŠ¶æ€æ˜¾ç¤º
    async updateSchedulerStatus() {
        if (!this.rssSourceManager || !this._rssSchedulerStatus) return;
        
        try {
            const status = await this.rssSourceManager.getSchedulerStatus();
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            if (this._rssSchedulerStatus) {
                let statusText = '';
                if (status.enabled) {
                    if (status.type === 'cron' && status.cron) {
                        const cronParts = [];
                        if (status.cron.second !== null && status.cron.second !== undefined) {
                            cronParts.push(`ç§’:${status.cron.second}`);
                        }
                        if (status.cron.minute !== null && status.cron.minute !== undefined) {
                            cronParts.push(`åˆ†:${status.cron.minute}`);
                        }
                        if (status.cron.hour !== null && status.cron.hour !== undefined) {
                            cronParts.push(`æ—¶:${status.cron.hour}`);
                        }
                        if (status.cron.day !== null && status.cron.day !== undefined) {
                            cronParts.push(`æ—¥:${status.cron.day}`);
                        }
                        if (status.cron.month !== null && status.cron.month !== undefined) {
                            cronParts.push(`æœˆ:${status.cron.month}`);
                        }
                        if (status.cron.day_of_week !== null && status.cron.day_of_week !== undefined) {
                            cronParts.push(`æ˜ŸæœŸ:${status.cron.day_of_week}`);
                        }
                        statusText = `âœ“ å®šæ—¶å™¨è¿è¡Œä¸­ | Cron: ${cronParts.length > 0 ? cronParts.join(', ') : 'æœªé…ç½®'}`;
                    } else {
                        const intervalText = status.interval >= 3600 
                            ? `${(status.interval / 3600).toFixed(1)} å°æ—¶`
                            : status.interval >= 60
                            ? `${(status.interval / 60).toFixed(0)} åˆ†é’Ÿ`
                            : `${status.interval} ç§’`;
                        statusText = `âœ“ å®šæ—¶å™¨è¿è¡Œä¸­ | é—´éš”: ${intervalText}`;
                    }
                } else {
                    statusText = 'âœ— å®šæ—¶å™¨å·²åœæ­¢';
                }
                
                this._rssSchedulerStatus.textContent = statusText;
                this._rssSchedulerStatus.style.color = status.enabled ? '#4CAF50' : '#999';
            }
            
            // æ›´æ–°æ¨¡å¼é€‰æ‹©
            if (this._rssSchedulerModeSelect) {
                this._rssSchedulerModeSelect.value = status.type || 'interval';
                // è§¦å‘æ¨¡å¼åˆ‡æ¢
                this._rssSchedulerModeSelect.dispatchEvent(new Event('change'));
            }
            
            // æ›´æ–°é—´éš”è¾“å…¥
            if (this._rssSchedulerIntervalInput) {
                this._rssSchedulerIntervalInput.value = status.interval || 3600;
            }
            
            // æ›´æ–° Cron å­—æ®µ
            if (this._rssSchedulerCronFields && status.cron) {
                if (status.cron.second !== null && status.cron.second !== undefined) {
                    this._rssSchedulerCronFields.second.value = status.cron.second;
                } else {
                    this._rssSchedulerCronFields.second.value = '';
                }
                if (status.cron.minute !== null && status.cron.minute !== undefined) {
                    this._rssSchedulerCronFields.minute.value = status.cron.minute;
                } else {
                    this._rssSchedulerCronFields.minute.value = '';
                }
                if (status.cron.hour !== null && status.cron.hour !== undefined) {
                    this._rssSchedulerCronFields.hour.value = status.cron.hour;
                } else {
                    this._rssSchedulerCronFields.hour.value = '';
                }
                if (status.cron.day !== null && status.cron.day !== undefined) {
                    this._rssSchedulerCronFields.day.value = status.cron.day;
                } else {
                    this._rssSchedulerCronFields.day.value = '';
                }
                if (status.cron.month !== null && status.cron.month !== undefined) {
                    this._rssSchedulerCronFields.month.value = status.cron.month;
                } else {
                    this._rssSchedulerCronFields.month.value = '';
                }
                if (status.cron.day_of_week !== null && status.cron.day_of_week !== undefined) {
                    this._rssSchedulerCronFields.day_of_week.value = status.cron.day_of_week;
                } else {
                    this._rssSchedulerCronFields.day_of_week.value = '';
                }
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const startBtn = document.querySelector('.rss-scheduler-start');
            const stopBtn = document.querySelector('.rss-scheduler-stop');
            
            if (startBtn) {
                startBtn.disabled = status.enabled;
                startBtn.style.opacity = status.enabled ? '0.5' : '1';
            }
            
            if (stopBtn) {
                stopBtn.disabled = !status.enabled;
                stopBtn.style.opacity = !status.enabled ? '0.5' : '1';
            }
        } catch (error) {
            console.warn('æ›´æ–°å®šæ—¶å™¨çŠ¶æ€å¤±è´¥:', error);
            if (this._rssSchedulerStatus) {
                this._rssSchedulerStatus.textContent = 'è·å–çŠ¶æ€å¤±è´¥';
                this._rssSchedulerStatus.style.color = '#f44336';
            }
        }
    }
    
    // åŠ è½½RSSæºåˆ—è¡¨åˆ°ç®¡ç†å™¨
    async loadRssSourcesIntoManager() {
        const modal = document.querySelector('#pet-rss-source-manager');
        if (!modal) return;
        
        const sourcesContainer = modal.querySelector('.rss-source-list');
        if (!sourcesContainer) return;
        
        sourcesContainer.innerHTML = '';
        
        if (!this.rssSourceManager) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'RSSæºç®¡ç†å™¨æœªåˆå§‹åŒ–';
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #999 !important;
                padding: 20px !important;
                font-size: 14px !important;
            `;
            sourcesContainer.appendChild(emptyMsg);
            return;
        }
        
        // ä»APIåˆ·æ–°æ•°æ®
        await this.rssSourceManager.loadSources(true);
        
        const sources = this.rssSourceManager.getAllSources();
        
        if (sources.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'æš‚æ— RSSæºï¼Œè¯·æ·»åŠ ';
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #999 !important;
                padding: 20px !important;
                font-size: 14px !important;
            `;
            sourcesContainer.appendChild(emptyMsg);
            return;
        }
        
        const mainColor = PET_CONFIG?.theme?.primaryColor || '#6366f1';
        
        sources.forEach(source => {
            const sourceItem = document.createElement('div');
            sourceItem.className = 'rss-source-item';
            sourceItem.style.cssText = `
                padding: 12px !important;
                margin-bottom: 8px !important;
                background: #ffffff !important;
                border: 1px solid #e5e7eb !important;
                border-radius: 8px !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                transition: all 0.2s ease !important;
            `;
            
            const sourceInfo = document.createElement('div');
            sourceInfo.style.cssText = `
                flex: 1 !important;
                min-width: 0 !important;
            `;
            
            const sourceName = document.createElement('div');
            sourceName.textContent = source.name || source.url;
            sourceName.style.cssText = `
                font-size: 14px !important;
                font-weight: 600 !important;
                color: #333 !important;
                margin-bottom: 4px !important;
                word-break: break-all !important;
            `;
            
            const sourceUrl = document.createElement('div');
            sourceUrl.textContent = source.url;
            sourceUrl.style.cssText = `
                font-size: 12px !important;
                color: #6b7280 !important;
                word-break: break-all !important;
            `;
            
            const sourceStatus = document.createElement('div');
            sourceStatus.textContent = source.enabled !== false ? 'âœ“ å¯ç”¨' : 'âœ— ç¦ç”¨';
            sourceStatus.style.cssText = `
                font-size: 12px !important;
                color: ${source.enabled !== false ? '#4CAF50' : '#9ca3af'} !important;
                margin-top: 4px !important;
            `;
            
            sourceInfo.appendChild(sourceName);
            sourceInfo.appendChild(sourceUrl);
            sourceInfo.appendChild(sourceStatus);
            
            const sourceActions = document.createElement('div');
            sourceActions.style.cssText = `
                display: flex !important;
                gap: 8px !important;
                flex-shrink: 0 !important;
            `;
            
            // å¯ç”¨/ç¦ç”¨æŒ‰é’®
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = source.enabled !== false ? 'ç¦ç”¨' : 'å¯ç”¨';
            toggleBtn.style.cssText = `
                padding: 6px 12px !important;
                background: ${source.enabled !== false ? '#f0f0f0' : mainColor} !important;
                color: ${source.enabled !== false ? '#333' : 'white'} !important;
                border: none !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 12px !important;
                transition: all 0.2s ease !important;
            `;
            toggleBtn.addEventListener('click', async () => {
                try {
                    // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                    toggleBtn.disabled = true;
                    const originalText = toggleBtn.textContent;
                    toggleBtn.textContent = 'å¤„ç†ä¸­...';
                    
                    // ä½¿ç”¨æ­£ç¡®çš„æ ‡è¯†ç¬¦ï¼šä¼˜å…ˆä½¿ç”¨idï¼Œç„¶åæ˜¯_idï¼Œæœ€åæ˜¯keyæˆ–url
                    const sourceId = source.id || source._id || source.key || source.url;
                    if (!sourceId) {
                        throw new Error('æ— æ³•ç¡®å®šRSSæºçš„æ ‡è¯†ç¬¦');
                    }
                    
                    await this.rssSourceManager.toggleSourceEnabled(sourceId);
                    await this.loadRssSourcesIntoManager();
                } catch (error) {
                    alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    toggleBtn.disabled = false;
                    toggleBtn.textContent = source.enabled !== false ? 'ç¦ç”¨' : 'å¯ç”¨';
                }
            });
            
            // æ‰‹åŠ¨è§£ææŒ‰é’®
            const parseBtn = document.createElement('button');
            parseBtn.textContent = 'æ‰‹åŠ¨è§£æ';
            parseBtn.style.cssText = `
                padding: 6px 12px !important;
                background: #2196F3 !important;
                color: white !important;
                border: none !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 12px !important;
                transition: all 0.2s ease !important;
            `;
            parseBtn.addEventListener('mouseenter', () => {
                parseBtn.style.opacity = '0.9';
            });
            parseBtn.addEventListener('mouseleave', () => {
                parseBtn.style.opacity = '1';
            });
            parseBtn.addEventListener('click', async () => {
                if (confirm('ç¡®å®šè¦æ‰‹åŠ¨è§£æè¿™ä¸ªRSSæºå—ï¼Ÿè§£æåçš„æ•°æ®å°†å­˜å…¥æ•°æ®åº“ã€‚')) {
                    try {
                        parseBtn.disabled = true;
                        parseBtn.textContent = 'è§£æä¸­...';
                        await this.parseRssSource(source.url, source.name || source.url);
                        alert('RSSæºè§£ææˆåŠŸï¼');
                    } catch (error) {
                        alert('è§£æå¤±è´¥ï¼š' + error.message);
                    } finally {
                        parseBtn.disabled = false;
                        parseBtn.textContent = 'æ‰‹åŠ¨è§£æ';
                    }
                }
            });
            
            // åˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.style.cssText = `
                padding: 6px 12px !important;
                background: #f44336 !important;
                color: white !important;
                border: none !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 12px !important;
                transition: all 0.2s ease !important;
            `;
            deleteBtn.addEventListener('mouseenter', () => {
                deleteBtn.style.opacity = '0.9';
            });
            deleteBtn.addEventListener('mouseleave', () => {
                deleteBtn.style.opacity = '1';
            });
            deleteBtn.addEventListener('click', async () => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªRSSæºå—ï¼Ÿ')) {
                    try {
                        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                        deleteBtn.disabled = true;
                        deleteBtn.textContent = 'åˆ é™¤ä¸­...';
                        deleteBtn.style.opacity = '0.6';
                        deleteBtn.style.cursor = 'not-allowed';
                        
                        // ä½¿ç”¨æ­£ç¡®çš„æ ‡è¯†ç¬¦ï¼šä¼˜å…ˆä½¿ç”¨idï¼Œç„¶åæ˜¯_idï¼Œæœ€åæ˜¯keyæˆ–url
                        const sourceId = source.id || source._id || source.key || source.url;
                        if (!sourceId) {
                            throw new Error('æ— æ³•ç¡®å®šRSSæºçš„æ ‡è¯†ç¬¦');
                        }
                        
                        await this.rssSourceManager.deleteSource(sourceId);
                        // åˆ é™¤æˆåŠŸåé‡æ–°åŠ è½½åˆ—è¡¨
                        await this.loadRssSourcesIntoManager();
                    } catch (error) {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = 'åˆ é™¤';
                        deleteBtn.style.opacity = '1';
                        deleteBtn.style.cursor = 'pointer';
                    }
                }
            });
            
            sourceActions.appendChild(toggleBtn);
            sourceActions.appendChild(parseBtn);
            sourceActions.appendChild(deleteBtn);
            
            sourceItem.appendChild(sourceInfo);
            sourceItem.appendChild(sourceActions);
            sourcesContainer.appendChild(sourceItem);
        });
    }
    
    // å…³é—­RSSæºç®¡ç†å™¨
    closeRssSourceManager() {
        const modal = document.querySelector('#pet-rss-source-manager');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // æ‰‹åŠ¨è§£æRSSæº
    async parseRssSource(url, name) {
        try {
            const apiUrl = PET_CONFIG?.api?.yiaiBaseUrl || 'https://api.effiy.cn';
            const parseUrl = `${apiUrl}/rss/parse`;
            
            const response = await fetch(parseUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: url,
                    name: name
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const result = await response.json();
            
            if (result.code !== 200 && result.status !== 200) {
                throw new Error(result.msg || result.message || 'è§£æå¤±è´¥');
            }
            
            console.log('RSSæºè§£ææˆåŠŸ:', result);
            return result;
        } catch (error) {
            console.error('è§£æRSSæºå¤±è´¥:', error);
            throw error;
        }
    }
    
    // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€ï¼ˆåˆ‡æ¢è§†å›¾æ—¶è°ƒç”¨ï¼‰
    clearAllSelections() {
        // æ¸…é™¤å½“å‰é€‰ä¸­çš„ä¼šè¯
        this.currentSessionId = null;
        
        // æ¸…é™¤å½“å‰é€‰ä¸­çš„æ–‡ä»¶
        this.currentFile = null;
        
        // æ¸…é™¤æ‰¹é‡é€‰ä¸­çš„çŠ¶æ€
        if (this.selectedSessionIds) {
            this.selectedSessionIds.clear();
        }
        if (this.selectedFileNames) {
            this.selectedFileNames.clear();
        }
        if (this.selectedApiRequestIds) {
            this.selectedApiRequestIds.clear();
        }
        if (this.selectedNewsIds) {
            this.selectedNewsIds.clear();
        }
        
        // æ¸…é™¤æ‰€æœ‰ active ç±»çš„å…ƒç´ 
        if (this.sessionSidebar) {
            // æ¸…é™¤ä¼šè¯é¡¹çš„ active çŠ¶æ€
            const activeSessionItems = this.sessionSidebar.querySelectorAll('.session-item.active');
            activeSessionItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // æ¸…é™¤æ–‡ä»¶é¡¹çš„ active çŠ¶æ€
            const activeFileItems = this.sessionSidebar.querySelectorAll('.oss-file-item.active');
            activeFileItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // æ¸…é™¤æ–°é—»é¡¹çš„ active çŠ¶æ€
            const activeNewsItems = this.sessionSidebar.querySelectorAll('.news-item.active');
            activeNewsItems.forEach(item => {
                item.classList.remove('active');
            });
        }
        
        console.log('å·²æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€');
    }
    
    // æ¸…ç©ºèŠå¤©ä¼šè¯å†…å®¹
    clearChatMessages() {
        if (!this.chatWindow || !this.isChatOpen) {
            return;
        }
        
        const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
        if (messagesContainer) {
            messagesContainer.innerHTML = '';
            console.log('å·²æ¸…ç©ºèŠå¤©ä¼šè¯å†…å®¹');
        }
    }
    
    // è®¾ç½®è§†å›¾æ¨¡å¼ï¼ˆä¼šè¯åˆ—è¡¨ã€OSSæ–‡ä»¶åˆ—è¡¨æˆ–æ–°é—»åˆ—è¡¨ï¼‰
    async setViewMode(mode) {
        // åˆ‡æ¢è§†å›¾å‰ï¼Œæ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
        this.clearAllSelections();
        
        // åˆ‡æ¢è§†å›¾æ—¶ï¼Œæ¸…ç©ºèŠå¤©ä¼šè¯å†…å®¹
        this.clearChatMessages();
        
        if (mode === 'oss') {
            this.ossFileListVisible = true;
            this.newsListVisible = false;
            this.apiRequestListVisible = false;
            await this.updateOssFileSidebar();
            // ç¡®ä¿è§†å›¾æ¨¡å¼çŠ¶æ€ä¸åˆ—è¡¨æ•°æ®ä¸€è‡´
            this.applyViewMode();
        } else if (mode === 'news') {
            this.ossFileListVisible = false;
            this.newsListVisible = true;
            this.apiRequestListVisible = false;
            await this.updateNewsSidebar();
            // ç¡®ä¿è§†å›¾æ¨¡å¼çŠ¶æ€ä¸åˆ—è¡¨æ•°æ®ä¸€è‡´
            this.applyViewMode();
        } else if (mode === 'api') {
            this.ossFileListVisible = false;
            this.newsListVisible = false;
            this.apiRequestListVisible = true;
            await this.updateApiRequestSidebar(true);
            // ç¡®ä¿è§†å›¾æ¨¡å¼çŠ¶æ€ä¸åˆ—è¡¨æ•°æ®ä¸€è‡´
            this.applyViewMode();
        } else {
            this.ossFileListVisible = false;
            this.newsListVisible = false;
            this.apiRequestListVisible = false;
            await this.updateSessionSidebar();
            // ç¡®ä¿è§†å›¾æ¨¡å¼çŠ¶æ€ä¸åˆ—è¡¨æ•°æ®ä¸€è‡´
            this.applyViewMode();
        }
    }
    
    // åº”ç”¨è§†å›¾æ¨¡å¼æ ·å¼ï¼ˆå‚è€ƒä¸Šä¸‹æ–‡å¼¹æ¡†çš„applyContextPreviewModeï¼‰
    applyViewMode() {
        if (!this.sessionSidebar) return;
        
        const btnSession = this.sessionSidebar.querySelector('#view-toggle-session');
        const btnOss = this.sessionSidebar.querySelector('#view-toggle-oss');
        const btnNews = this.sessionSidebar.querySelector('#view-toggle-news');
        const btnApi = this.sessionSidebar.querySelector('#view-toggle-api');
        
        if (!btnSession || !btnOss) return;
        
        // è·å–å½“å‰ä¸»é¢˜è‰²ï¼ˆç”¨äºæ¿€æ´»æ€ï¼‰
        const currentColor = this.colors[this.colorIndex];
        const currentMainColor = this.getMainColorFromGradient(currentColor);
        
        // é‡ç½®æŒ‰é’®æ ·å¼
        const resetBtn = (b) => {
            if (!b) return;
            b.style.background = 'transparent';
            b.style.color = '#6b7280';
            b.style.border = 'none';
        };
        
        // æ¿€æ´»æŒ‰é’®æ ·å¼
        const activateBtn = (b) => {
            if (!b) return;
            b.style.background = currentMainColor;
            b.style.color = '#fff';
            b.style.border = 'none';
        };
        
        // é‡ç½®æ‰€æœ‰æŒ‰é’®
        resetBtn(btnSession);
        resetBtn(btnOss);
        if (btnNews) resetBtn(btnNews);
        if (btnApi) resetBtn(btnApi);
        
        // æ¿€æ´»å½“å‰æ¨¡å¼çš„æŒ‰é’®
        if (this.apiRequestListVisible && btnApi) {
            activateBtn(btnApi);
        } else if (this.newsListVisible && btnNews) {
            activateBtn(btnNews);
        } else if (this.ossFileListVisible) {
            activateBtn(btnOss);
        } else {
            activateBtn(btnSession);
        }
    }
    
    // è¿›å…¥æ‰¹é‡é€‰æ‹©æ¨¡å¼
    enterBatchMode() {
        this.batchMode = true;
        this.selectedSessionIds.clear();
        this.selectedFileNames.clear();
        this.selectedApiRequestIds.clear();
        this.selectedNewsIds.clear();
        
        // æ˜¾ç¤ºæ‰¹é‡æ“ä½œå·¥å…·æ ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        const batchToolbar = document.getElementById('batch-toolbar');
        if (batchToolbar) {
            batchToolbar.style.display = 'flex';
            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿æ ·å¼å·²åº”ç”¨
            requestAnimationFrame(() => {
                batchToolbar.style.opacity = '1';
                batchToolbar.style.transform = 'translateY(0)';
            });
        }
        
        // æ›´æ–°æ‰¹é‡æ¨¡å¼æŒ‰é’®çŠ¶æ€
        const batchModeBtn = this.sessionSidebar.querySelector('span[title="æ‰¹é‡é€‰æ‹©"], span[title="é€€å‡ºæ‰¹é‡é€‰æ‹©æ¨¡å¼"]');
        if (batchModeBtn) {
            batchModeBtn.classList.add('batch-mode-active');
            batchModeBtn.innerHTML = 'â˜‘ï¸ é€€å‡ºæ‰¹é‡';
            batchModeBtn.title = 'é€€å‡ºæ‰¹é‡é€‰æ‹©æ¨¡å¼';
            batchModeBtn.style.background = 'linear-gradient(135deg, #10b981, #059669) !important';
            batchModeBtn.style.borderColor = '#059669 !important';
        }
        
        // æ›´æ–°ä¼šè¯åˆ—è¡¨ã€æ–‡ä»¶åˆ—è¡¨ã€è¯·æ±‚æ¥å£åˆ—è¡¨æˆ–æ–°é—»åˆ—è¡¨ï¼Œæ˜¾ç¤ºå¤é€‰æ¡†
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        const newsList = this.sessionSidebar.querySelector('.news-list');
        if (sessionList && sessionList.style.display !== 'none') {
            this.updateSessionSidebar();
        } else if (ossFileList && ossFileList.style.display !== 'none') {
            this.updateOssFileSidebar();
        } else if (apiRequestList && apiRequestList.style.display !== 'none') {
            this.updateApiRequestSidebar();
        } else if (newsList && newsList.style.display !== 'none') {
            this.updateNewsSidebar();
        }
        
        // æ›´æ–°æ‰¹é‡å·¥å…·æ çŠ¶æ€
        setTimeout(() => {
            this.updateBatchToolbar();
        }, 100);
        
        // æ˜¾ç¤ºé€šçŸ¥
        this.showNotification('å·²è¿›å…¥æ‰¹é‡é€‰æ‹©æ¨¡å¼', 'info');
    }
    
    // é€€å‡ºæ‰¹é‡é€‰æ‹©æ¨¡å¼
    exitBatchMode() {
        this.batchMode = false;
        this.selectedSessionIds.clear();
        this.selectedFileNames.clear();
        this.selectedApiRequestIds.clear();
        this.selectedNewsIds.clear();
        
        // éšè—æ‰¹é‡æ“ä½œå·¥å…·æ ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        const batchToolbar = document.getElementById('batch-toolbar');
        if (batchToolbar) {
            batchToolbar.style.opacity = '0';
            batchToolbar.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                batchToolbar.style.display = 'none';
            }, 300);
        }
        
        // æ›´æ–°æ‰¹é‡æ¨¡å¼æŒ‰é’®çŠ¶æ€
        const batchModeBtn = this.sessionSidebar.querySelector('span[title="é€€å‡ºæ‰¹é‡é€‰æ‹©æ¨¡å¼"], span[title="æ‰¹é‡é€‰æ‹©"]');
        if (batchModeBtn) {
            batchModeBtn.classList.remove('batch-mode-active');
            batchModeBtn.innerHTML = 'â˜‘ï¸ æ‰¹é‡é€‰æ‹©';
            batchModeBtn.title = 'æ‰¹é‡é€‰æ‹©';
            batchModeBtn.style.background = 'linear-gradient(135deg, #6366f1, #4f46e5) !important';
            batchModeBtn.style.borderColor = '#4f46e5 !important';
            batchModeBtn.style.transform = 'translateY(0)';
            batchModeBtn.style.boxShadow = 'none !important';
        }
        // æ›´æ–°ä¼šè¯åˆ—è¡¨ã€æ–‡ä»¶åˆ—è¡¨ã€è¯·æ±‚æ¥å£åˆ—è¡¨æˆ–æ–°é—»åˆ—è¡¨ï¼Œéšè—å¤é€‰æ¡†
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        const newsList = this.sessionSidebar.querySelector('.news-list');
        if (sessionList && sessionList.style.display !== 'none') {
            this.updateSessionSidebar();
        } else if (ossFileList && ossFileList.style.display !== 'none') {
            this.updateOssFileSidebar();
        } else if (apiRequestList && apiRequestList.style.display !== 'none') {
            this.updateApiRequestSidebar();
        } else if (newsList && newsList.style.display !== 'none') {
            this.updateNewsSidebar();
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        this.showNotification('å·²é€€å‡ºæ‰¹é‡é€‰æ‹©æ¨¡å¼', 'info');
    }
    
    // æ›´æ–°æ‰¹é‡æ“ä½œå·¥å…·æ 
    updateBatchToolbar() {
        const selectedCount = document.getElementById('selected-count');
        const batchDeleteBtn = document.getElementById('batch-delete-btn');
        const selectAllBtn = document.getElementById('select-all-btn');
        
        // åˆ¤æ–­å½“å‰æ˜¾ç¤ºçš„æ˜¯ä¼šè¯åˆ—è¡¨ã€æ–‡ä»¶åˆ—è¡¨ã€è¯·æ±‚æ¥å£åˆ—è¡¨è¿˜æ˜¯æ–°é—»åˆ—è¡¨
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        const newsList = this.sessionSidebar.querySelector('.news-list');
        const isFileListMode = ossFileList && ossFileList.style.display !== 'none';
        const isApiRequestListMode = apiRequestList && apiRequestList.style.display !== 'none';
        const isNewsListMode = newsList && newsList.style.display !== 'none';
        
        const count = isFileListMode ? this.selectedFileNames.size : 
                     isApiRequestListMode ? this.selectedApiRequestIds.size : 
                     isNewsListMode ? this.selectedNewsIds.size :
                     this.selectedSessionIds.size;
        
        if (selectedCount) {
            selectedCount.textContent = `å·²é€‰æ‹© ${count} ä¸ª`;
            
            // æ ¹æ®é€‰ä¸­æ•°é‡æ›´æ–°æ ·å¼
            if (count > 0) {
                selectedCount.style.color = '#4338ca';
                selectedCount.style.fontWeight = '600';
            } else {
                selectedCount.style.color = '#6b7280';
                selectedCount.style.fontWeight = '500';
            }
        }
        
        if (batchDeleteBtn) {
            const hasSelection = count > 0;
            batchDeleteBtn.disabled = !hasSelection;
            
            if (hasSelection) {
                batchDeleteBtn.style.opacity = '1';
                batchDeleteBtn.style.cursor = 'pointer';
            } else {
                batchDeleteBtn.style.opacity = '0.5';
                batchDeleteBtn.style.cursor = 'not-allowed';
            }
        }
        
        // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
        if (selectAllBtn) {
            let allSelected = false;
            if (isFileListMode) {
                const filteredFiles = this._getFilteredFiles();
                allSelected = filteredFiles.length > 0 && 
                             filteredFiles.every(file => this.selectedFileNames.has(file.name));
            } else if (isApiRequestListMode) {
                const filteredApiRequests = this._getFilteredApiRequests();
                // ç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½æœ‰ key å­—æ®µ
                filteredApiRequests.forEach(req => {
                    this._ensureRequestKey(req);
                });
                allSelected = filteredApiRequests.length > 0 && 
                            filteredApiRequests.every(req => {
                                const requestKey = this._getRequestKey(req);
                                return requestKey && this.selectedApiRequestIds.has(requestKey);
                            });
            } else if (isNewsListMode) {
                const filteredNews = this._getFilteredNews();
                allSelected = filteredNews.length > 0 && 
                             filteredNews.every(news => {
                                 const newsId = news.link || news.id || '';
                                 return newsId && this.selectedNewsIds.has(newsId);
                             });
            } else {
                const filteredSessions = this._getFilteredSessions();
                allSelected = filteredSessions.length > 0 && 
                             filteredSessions.every(session => this.selectedSessionIds.has(session.id));
            }
            
            if (allSelected) {
                selectAllBtn.textContent = 'å–æ¶ˆå…¨é€‰';
                selectAllBtn.style.background = '#f3f4f6';
                selectAllBtn.style.color = '#6b7280';
            } else {
                selectAllBtn.textContent = 'å…¨é€‰';
                selectAllBtn.style.background = '#ffffff';
                selectAllBtn.style.color = '#374151';
            }
        }
        
        // OSSæ–‡ä»¶è§†å›¾ä¸‹ï¼Œæ›´æ–°å¯¼å…¥ã€å¯¼å‡ºã€æ–°å»ºæŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
        if (isFileListMode) {
            this.updateOssFileBatchButtons();
        } else {
            this.hideOssFileBatchButtons();
        }
    }
    
    // è·å–è¿‡æ»¤åçš„æ–°é—»åˆ—è¡¨ï¼ˆç”¨äºæ‰¹é‡é€‰æ‹©ï¼‰
    _getFilteredNews() {
        if (!this.newsManager) {
            return [];
        }
        
        let news = this.newsManager.getAllNews();
        
        // åº”ç”¨æœç´¢è¿‡æ»¤
        if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
            const filterKeyword = this.sessionTitleFilter.trim().toLowerCase();
            news = news.filter(item => {
                const title = (item.title || '').toLowerCase();
                const description = (item.description || '').toLowerCase();
                const content = (item.content || '').toLowerCase();
                return title.includes(filterKeyword) || 
                       description.includes(filterKeyword) || 
                       content.includes(filterKeyword);
            });
        }
        
        // åº”ç”¨æ— æ ‡ç­¾ç­›é€‰
        if (this.newsTagFilterNoTags) {
            news = news.filter(item => {
                const itemTags = item.tags || [];
                const hasTags = itemTags.length > 0 && itemTags.some(tag => tag && tag.trim().length > 0);
                return !hasTags; // åªæ˜¾ç¤ºæ²¡æœ‰æ ‡ç­¾çš„æ–°é—»
            });
        }
        
        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤
        if (this.selectedNewsFilterTags && this.selectedNewsFilterTags.length > 0) {
            news = news.filter(item => {
                const itemTags = (item.tags || []).map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const normalizedSelectedTags = this.selectedNewsFilterTags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
                const hasSelectedTags = normalizedSelectedTags.some(selectedTag => 
                    itemTags.includes(selectedTag)
                );
                
                if (this.newsTagFilterReverse) {
                    // åå‘è¿‡æ»¤ï¼šæ’é™¤åŒ…å«é€‰ä¸­æ ‡ç­¾çš„æ–°é—»
                    return !hasSelectedTags;
                } else {
                    // æ­£å‘è¿‡æ»¤ï¼šåªæ˜¾ç¤ºåŒ…å«é€‰ä¸­æ ‡ç­¾çš„æ–°é—»
                    return hasSelectedTags;
                }
            });
        }
        
        // æ³¨æ„ï¼šæ—¥æœŸåŒºé—´è¿‡æ»¤å·²é€šè¿‡APIè°ƒç”¨å®ç°ï¼Œä¸å†éœ€è¦æœ¬åœ°è¿‡æ»¤
        
        return news;
    }
    
    // è·å–è¿‡æ»¤åçš„è¯·æ±‚æ¥å£åˆ—è¡¨ï¼ˆç”¨äºæ‰¹é‡é€‰æ‹©ï¼‰
    _getFilteredApiRequests() {
        if (!this.apiRequestManager) {
            return [];
        }
        
        let requests = this.apiRequestManager.getAllRequests();
        
        // åº”ç”¨æœç´¢è¿‡æ»¤
        if (this.sessionTitleFilter && this.sessionTitleFilter.trim() !== '') {
            const searchKeyword = this.sessionTitleFilter.toLowerCase().trim();
            requests = requests.filter(req => {
                const url = (req.url || '').toLowerCase();
                const method = (req.method || '').toLowerCase();
                const title = (req.title || '').toLowerCase();
                const description = (req.description || '').toLowerCase();
                return url.includes(searchKeyword) || 
                       method.includes(searchKeyword) ||
                       title.includes(searchKeyword) ||
                       description.includes(searchKeyword);
            });
        }
        
        // åº”ç”¨æ—¥æœŸç­›é€‰
        if (this.dateRangeFilter) {
            if (this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // æœ‰å¼€å§‹å’Œç»“æŸæ—¥æœŸï¼šç­›é€‰åŒºé—´å†…çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const endDate = this.dateRangeFilter.endDate;
                const startTime = startDate.getTime();
                const endTime = endDate.getTime() + 24 * 60 * 60 * 1000 - 1; // åŒ…å«ç»“æŸæ—¥æœŸçš„æ•´å¤©
                
                requests = requests.filter(req => {
                    const requestTime = req.timestamp || req.createdAt || req.updatedAt || 0;
                    return requestTime >= startTime && requestTime <= endTime;
                });
            } else if (this.dateRangeFilter.startDate && !this.dateRangeFilter.endDate) {
                // åªæœ‰å¼€å§‹æ—¥æœŸï¼šç­›é€‰å¼€å§‹æ—¥æœŸå½“å¤©çš„è®°å½•
                const startDate = this.dateRangeFilter.startDate;
                const startTime = startDate.getTime();
                const endTime = startTime + 24 * 60 * 60 * 1000 - 1; // åŒ…å«å¼€å§‹æ—¥æœŸçš„æ•´å¤©
                
                requests = requests.filter(req => {
                    const requestTime = req.timestamp || req.createdAt || req.updatedAt || 0;
                    return requestTime >= startTime && requestTime <= endTime;
                });
            } else if (!this.dateRangeFilter.startDate && this.dateRangeFilter.endDate) {
                // åªæœ‰ç»“æŸæ—¥æœŸï¼šç­›é€‰ç»“æŸæ—¥æœŸä¹‹å‰çš„è®°å½•
                const endDate = this.dateRangeFilter.endDate;
                const endTime = endDate.getTime(); // ä¸åŒ…å«ç»“æŸæ—¥æœŸå½“å¤©
                
                requests = requests.filter(req => {
                    const requestTime = req.timestamp || req.createdAt || req.updatedAt || 0;
                    return requestTime < endTime;
                });
            }
        }
        
        // åº”ç”¨æ ‡ç­¾è¿‡æ»¤
        if (this.selectedApiRequestFilterTags && this.selectedApiRequestFilterTags.length > 0) {
            const selectedTags = this.selectedApiRequestFilterTags.map(tag => tag ? tag.trim() : '').filter(tag => tag.length > 0);
            if (selectedTags.length > 0) {
                requests = requests.filter(req => {
                    const reqTags = req.tags || [];
                    if (this.apiRequestTagFilterReverse) {
                        // åå‘è¿‡æ»¤ï¼šä¸åŒ…å«ä»»ä½•é€‰ä¸­æ ‡ç­¾
                        return !selectedTags.some(tag => reqTags.includes(tag));
                    } else {
                        // æ­£å‘è¿‡æ»¤ï¼šåŒ…å«æ‰€æœ‰é€‰ä¸­æ ‡ç­¾
                        return selectedTags.every(tag => reqTags.includes(tag));
                    }
                });
            }
        }
        
        // åº”ç”¨æ— æ ‡ç­¾è¿‡æ»¤
        if (this.apiRequestTagFilterNoTags) {
            requests = requests.filter(req => {
                const reqTags = req.tags || [];
                return reqTags.length === 0;
            });
        }
        
        return requests;
    }
    
    // æ›´æ–°OSSæ–‡ä»¶è§†å›¾ä¸‹çš„æ‰¹é‡æ“ä½œæŒ‰é’®ï¼ˆç§»é™¤æ‰€æœ‰OSSä¸“ç”¨æŒ‰é’®ï¼‰
    updateOssFileBatchButtons() {
        const batchToolbar = document.getElementById('batch-toolbar');
        if (!batchToolbar) return;
        
        // ç§»é™¤å·²å­˜åœ¨çš„å¯¼å…¥ã€å¯¼å‡ºå’Œæ–°å»ºæŒ‰é’®
        const importBtn = batchToolbar.querySelector('#oss-batch-import-btn');
        const exportBtn = batchToolbar.querySelector('#oss-batch-export-btn');
        const newBtn = batchToolbar.querySelector('#oss-batch-new-btn');
        
        if (importBtn && importBtn.parentNode) {
            importBtn.parentNode.removeChild(importBtn);
        }
        if (exportBtn && exportBtn.parentNode) {
            exportBtn.parentNode.removeChild(exportBtn);
        }
        if (newBtn && newBtn.parentNode) {
            newBtn.parentNode.removeChild(newBtn);
        }
    }
    
    // éšè—OSSæ–‡ä»¶è§†å›¾ä¸‹çš„æ‰¹é‡æ“ä½œæŒ‰é’®
    hideOssFileBatchButtons() {
        const batchToolbar = document.getElementById('batch-toolbar');
        if (!batchToolbar) return;
        
        const importBtn = batchToolbar.querySelector('#oss-batch-import-btn');
        const exportBtn = batchToolbar.querySelector('#oss-batch-export-btn');
        const newBtn = batchToolbar.querySelector('#oss-batch-new-btn');
        
        // ç§»é™¤å¯¼å…¥ã€å¯¼å‡ºå’Œæ–°å»ºæŒ‰é’®
        if (importBtn && importBtn.parentNode) {
            importBtn.parentNode.removeChild(importBtn);
        }
        if (exportBtn && exportBtn.parentNode) {
            exportBtn.parentNode.removeChild(exportBtn);
        }
        if (newBtn && newBtn.parentNode) {
            newBtn.parentNode.removeChild(newBtn);
        }
    }
    
    // å¯¼å…¥OSSæ–‡ä»¶ï¼ˆä»ZIPæ–‡ä»¶å¯¼å…¥ï¼‰
    async importOssFiles() {
        if (!this.ossApi || !this.ossApi.isEnabled()) {
            this.showNotification('OSS APIæœªå¯ç”¨', 'error');
            return;
        }
        
        // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.zip';
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                if (fileInput.parentNode) {
                    fileInput.parentNode.removeChild(fileInput);
                }
                return;
            }
            
            try {
                this.showNotification('æ­£åœ¨è§£æZIPæ–‡ä»¶...', 'info');
                
                // åŠ è½½JSZipåº“
                await this._loadJSZip();
                
                // è¯»å–æ–‡ä»¶ä¸ºArrayBuffer
                const arrayBuffer = await file.arrayBuffer();
                
                // è§£æZIPæ–‡ä»¶
                const JSZipLib = window.JSZip || JSZip;
                const zip = await JSZipLib.loadAsync(arrayBuffer);
                
                // æ”¶é›†æ‰€æœ‰æ–‡ä»¶
                const filesToUpload = [];
                zip.forEach((relativePath, zipEntry) => {
                    // è·³è¿‡ç›®å½•
                    if (zipEntry.dir) return;
                    
                    // è·³è¿‡éšè—æ–‡ä»¶
                    if (relativePath.includes('._') || relativePath.startsWith('.')) return;
                    
                    filesToUpload.push({
                        path: relativePath,
                        entry: zipEntry
                    });
                });
                
                if (filesToUpload.length === 0) {
                    this.showNotification('ZIPæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å…¥çš„æ–‡ä»¶', 'error');
                    return;
                }
                
                this.showNotification(`æ­£åœ¨ä¸Šä¼  ${filesToUpload.length} ä¸ªæ–‡ä»¶...`, 'info');
                
                // ä¸Šä¼ æ–‡ä»¶
                let successCount = 0;
                let failCount = 0;
                
                for (const fileInfo of filesToUpload) {
                    try {
                        // è¯»å–æ–‡ä»¶å†…å®¹
                        const fileData = await fileInfo.entry.async('blob');
                        
                        // åˆ›å»ºFileå¯¹è±¡
                        const fileToUpload = new File([fileData], fileInfo.path.split('/').pop(), {
                            type: fileData.type || 'application/octet-stream'
                        });
                        
                        // è·å–ç›®å½•è·¯å¾„ï¼ˆå»æ‰æ–‡ä»¶åï¼‰
                        const directory = fileInfo.path.includes('/') 
                            ? fileInfo.path.substring(0, fileInfo.path.lastIndexOf('/'))
                            : '';
                        
                        // ä¸Šä¼ æ–‡ä»¶
                        await this.ossApi.uploadFile(fileToUpload, directory);
                        successCount++;
                    } catch (error) {
                        console.error(`ä¸Šä¼ æ–‡ä»¶ ${fileInfo.path} å¤±è´¥:`, error);
                        failCount++;
                    }
                }
                
                // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                if (this.ossFileManager) {
                    await this.ossFileManager.refreshFiles(true);
                }
                await this.updateOssFileSidebar(true);
                
                // æ˜¾ç¤ºç»“æœ
                if (failCount === 0) {
                    this.showNotification(`æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªæ–‡ä»¶`, 'success');
                } else {
                    this.showNotification(`å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, 'error');
                }
            } catch (error) {
                console.error('å¯¼å…¥OSSæ–‡ä»¶å¤±è´¥:', error);
                this.showNotification('å¯¼å…¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            } finally {
                fileInput.value = '';
                if (fileInput.parentNode) {
                    fileInput.parentNode.removeChild(fileInput);
                }
            }
        });
        
        // æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ç‚¹å‡»
        document.body.appendChild(fileInput);
        fileInput.click();
    }
    
    // å¯¼å‡ºé€‰ä¸­çš„OSSæ–‡ä»¶
    async exportOssFiles() {
        if (this.selectedFileNames.size === 0) {
            this.showNotification('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„æ–‡ä»¶', 'error');
            return;
        }
        
        if (!this.ossApi || !this.ossApi.isEnabled()) {
            this.showNotification('OSS APIæœªå¯ç”¨', 'error');
            return;
        }
        
        try {
            this.showNotification('æ­£åœ¨å‡†å¤‡å¯¼å‡º...', 'info');
            
            // åŠ è½½JSZipåº“
            await this._loadJSZip();
            
            const JSZipLib = window.JSZip || JSZip;
            const zip = new JSZipLib();
            
            const fileNames = Array.from(this.selectedFileNames);
            
            // è·å–æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ ‡ç­¾ï¼‰
            const allFiles = this.ossFileManager ? this.ossFileManager.getAllFiles() : [];
            const fileMap = new Map();
            allFiles.forEach(file => {
                if (file.name) {
                    fileMap.set(file.name, file);
                }
            });
            
            // æ¸…ç†è·¯å¾„ä¸­çš„éæ³•å­—ç¬¦
            const sanitizePath = (path) => {
                return path.replace(/[<>:"|?*\x00-\x1f]/g, '_').trim();
            };
            
            // ç”¨äºè·Ÿè¸ªå·²ä½¿ç”¨çš„æ–‡ä»¶è·¯å¾„ï¼Œé¿å…æ–‡ä»¶åå†²çª
            const usedPaths = new Map();
            
            let successCount = 0;
            let failCount = 0;
            
            // ä¸‹è½½å¹¶æ·»åŠ åˆ°ZIP
            for (const fileName of fileNames) {
                try {
                    // è·å–æ–‡ä»¶ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ ‡ç­¾ï¼‰
                    let fileInfo = fileMap.get(fileName);
                    
                    // å¦‚æœæ–‡ä»¶ä¿¡æ¯ä¸­æ²¡æœ‰æ ‡ç­¾ï¼Œå°è¯•ä»åç«¯APIè·å–
                    if (!fileInfo || !fileInfo.tags || !Array.isArray(fileInfo.tags) || fileInfo.tags.length === 0) {
                        try {
                            const fileTags = await this.ossApi.getFileTags(fileName);
                            if (fileTags && Array.isArray(fileTags) && fileTags.length > 0) {
                                if (!fileInfo) {
                                    fileInfo = { name: fileName, tags: fileTags };
                                } else {
                                    fileInfo.tags = fileTags;
                                }
                            }
                        } catch (error) {
                            console.warn(`è·å–æ–‡ä»¶ ${fileName} çš„æ ‡ç­¾å¤±è´¥:`, error);
                        }
                    }
                    
                    // è·å–æ ‡ç­¾æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰æ ‡ç­¾åˆ™ä½¿ç”¨"æœªåˆ†ç±»"ï¼ˆå‚è€ƒä¼šè¯å¯¼å‡ºåŠŸèƒ½ï¼‰
                    const tags = fileInfo && fileInfo.tags && Array.isArray(fileInfo.tags) && fileInfo.tags.length > 0
                        ? fileInfo.tags
                        : ['æœªåˆ†ç±»'];
                    
                    // è·å–æ–‡ä»¶ä¸‹è½½URL
                    const downloadUrl = await this.ossApi.getDownloadUrl(fileName, 3600);
                    
                    if (!downloadUrl) {
                        throw new Error('æ— æ³•è·å–æ–‡ä»¶ä¸‹è½½URL');
                    }
                    
                    // ä¸‹è½½æ–‡ä»¶
                    const response = await fetch(downloadUrl);
                    if (!response.ok) {
                        throw new Error(`ä¸‹è½½å¤±è´¥: ${response.status}`);
                    }
                    
                    const blob = await response.blob();
                    
                    // æ ¹æ®æ ‡ç­¾æ„å»ºç›®å½•è·¯å¾„ï¼ˆå‚è€ƒä¼šè¯å¯¼å‡ºåŠŸèƒ½ï¼‰
                    // æŒ‰æ ‡ç­¾é¡ºåºå»ºç«‹ç›®å½•å±‚æ¬¡ï¼Œæ¯ä¸ªæ ‡ç­¾ä½œä¸ºä¸€å±‚ç›®å½•
                    let filePath = '';
                    tags.forEach(tag => {
                        const sanitizedTag = sanitizePath(tag);
                        filePath += sanitizedTag + '/';
                    });
                    
                    // è·å–æ–‡ä»¶åï¼ˆå»æ‰è·¯å¾„ï¼Œåªä¿ç•™æ–‡ä»¶åï¼‰
                    const baseFileName = sanitizePath(fileName.split('/').pop() || fileName);
                    let finalFileName = baseFileName;
                    let fullPath = filePath + finalFileName;
                    
                    // å¤„ç†æ–‡ä»¶åå†²çªï¼šå¦‚æœè·¯å¾„å·²å­˜åœ¨ï¼Œæ·»åŠ åºå·
                    if (usedPaths.has(fullPath)) {
                        const nameWithoutExt = baseFileName.substring(0, baseFileName.lastIndexOf('.')) || baseFileName;
                        const ext = baseFileName.substring(baseFileName.lastIndexOf('.')) || '';
                        let counter = 1;
                        do {
                            finalFileName = nameWithoutExt + '_' + counter + ext;
                            fullPath = filePath + finalFileName;
                            counter++;
                        } while (usedPaths.has(fullPath));
                    }
                    
                    // è®°å½•å·²ä½¿ç”¨çš„è·¯å¾„
                    usedPaths.set(fullPath, true);
                    
                    // æ·»åŠ åˆ°ZIPï¼ˆä½¿ç”¨å¸¦æ ‡ç­¾ç›®å½•çš„è·¯å¾„ï¼‰
                    zip.file(fullPath, blob);
                    successCount++;
                } catch (error) {
                    console.error(`å¯¼å‡ºæ–‡ä»¶ ${fileName} å¤±è´¥:`, error);
                    failCount++;
                }
            }
            
            if (successCount === 0) {
                this.showNotification('æ²¡æœ‰æˆåŠŸå¯¼å‡ºä»»ä½•æ–‡ä»¶', 'error');
                return;
            }
            
            // ç”ŸæˆZIPæ–‡ä»¶
            this.showNotification('æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...', 'info');
            const zipBlob = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });
            
            // è§¦å‘ä¸‹è½½
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `OSSæ–‡ä»¶å¯¼å‡º_${new Date().toISOString().slice(0, 10)}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // æ˜¾ç¤ºç»“æœ
            if (failCount === 0) {
                this.showNotification(`æˆåŠŸå¯¼å‡º ${successCount} ä¸ªæ–‡ä»¶`, 'success');
            } else {
                this.showNotification(`å¯¼å‡ºå®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, 'error');
            }
        } catch (error) {
            console.error('å¯¼å‡ºOSSæ–‡ä»¶å¤±è´¥:', error);
            this.showNotification('å¯¼å‡ºå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    }
    
    // åˆ‡æ¢å…¨é€‰/å–æ¶ˆå…¨é€‰
    toggleSelectAll() {
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        const newsList = this.sessionSidebar.querySelector('.news-list');
        const isFileListMode = ossFileList && ossFileList.style.display !== 'none';
        const isApiRequestListMode = apiRequestList && apiRequestList.style.display !== 'none';
        const isNewsListMode = newsList && newsList.style.display !== 'none';
        
        if (isFileListMode) {
            // æ–‡ä»¶åˆ—è¡¨æ¨¡å¼
            const filteredFiles = this._getFilteredFiles();
            const allSelected = filteredFiles.length > 0 && 
                               filteredFiles.every(file => this.selectedFileNames.has(file.name));
            
            if (allSelected) {
                // å–æ¶ˆå…¨é€‰ï¼šåªå–æ¶ˆå½“å‰æ˜¾ç¤ºçš„æ–‡ä»¶
                filteredFiles.forEach(file => {
                    this.selectedFileNames.delete(file.name);
                });
            } else {
                // å…¨é€‰ï¼šé€‰ä¸­æ‰€æœ‰å½“å‰æ˜¾ç¤ºçš„æ–‡ä»¶
                filteredFiles.forEach(file => {
                    this.selectedFileNames.add(file.name);
                });
            }
            
            // æ›´æ–°æ‰€æœ‰å¤é€‰æ¡†çŠ¶æ€
            const checkboxes = document.querySelectorAll('.oss-file-checkbox');
            checkboxes.forEach(checkbox => {
                const fileName = checkbox.dataset.fileName;
                checkbox.checked = this.selectedFileNames.has(fileName);
                
                // æ›´æ–°æ–‡ä»¶é¡¹çš„é€‰ä¸­çŠ¶æ€ç±»
                const fileItem = checkbox.closest('.oss-file-item');
                if (fileItem) {
                    if (this.selectedFileNames.has(fileName)) {
                        fileItem.classList.add('selected');
                    } else {
                        fileItem.classList.remove('selected');
                    }
                }
            });
            } else if (isApiRequestListMode) {
                // è¯·æ±‚æ¥å£åˆ—è¡¨æ¨¡å¼
                const filteredApiRequests = this._getFilteredApiRequests();
                // ç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½æœ‰ key å­—æ®µ
                filteredApiRequests.forEach(req => {
                    this._ensureRequestKey(req);
                });
                
                const allSelected = filteredApiRequests.length > 0 && 
                              filteredApiRequests.every(req => {
                                  const requestKey = this._getRequestKey(req);
                                  return requestKey && this.selectedApiRequestIds.has(requestKey);
                              });
                
                if (allSelected) {
                    // å–æ¶ˆå…¨é€‰ï¼šåªå–æ¶ˆå½“å‰æ˜¾ç¤ºçš„è¯·æ±‚æ¥å£
                    filteredApiRequests.forEach(req => {
                        const requestKey = this._getRequestKey(req);
                        if (requestKey) {
                            this.selectedApiRequestIds.delete(requestKey);
                        }
                    });
                } else {
                    // å…¨é€‰ï¼šé€‰ä¸­æ‰€æœ‰å½“å‰æ˜¾ç¤ºçš„è¯·æ±‚æ¥å£ï¼ˆä»…APIæ•°æ®ï¼‰
                    filteredApiRequests.forEach(req => {
                        const requestKey = this._getRequestKey(req);
                        if (requestKey) {
                            this.selectedApiRequestIds.add(requestKey);
                        }
                    });
                }
            
            // æ›´æ–°æ‰€æœ‰å¤é€‰æ¡†çŠ¶æ€ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
            const checkboxes = document.querySelectorAll('.api-request-checkbox');
            checkboxes.forEach(checkbox => {
                const requestKey = checkbox.dataset.requestKey; // ä½¿ç”¨ data-request-key
                if (!requestKey) {
                    // å…¼å®¹æ—§ä»£ç ï¼šå°è¯•ä½¿ç”¨ requestId
                    const requestId = checkbox.dataset.requestId;
                    if (requestId) {
                        checkbox.dataset.requestKey = requestId; // è¿ç§»åˆ°æ–°çš„å±æ€§å
                        checkbox.checked = this.selectedApiRequestIds.has(requestId);
                    } else {
                        return; // è·³è¿‡æ— æ•ˆçš„å¤é€‰æ¡†
                    }
                } else {
                    checkbox.checked = this.selectedApiRequestIds.has(requestKey);
                }
                
                // æ›´æ–°è¯·æ±‚æ¥å£é¡¹çš„é€‰ä¸­çŠ¶æ€ç±»
                const requestItem = checkbox.closest('.api-request-item');
                if (requestItem) {
                    const key = requestKey || checkbox.dataset.requestId;
                    if (key && this.selectedApiRequestIds.has(key)) {
                        requestItem.classList.add('selected');
                        requestItem.style.background = '#eff6ff';
                        requestItem.style.borderColor = '#3b82f6';
                    } else {
                        requestItem.classList.remove('selected');
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ¿€æ´»çŠ¶æ€
                        const isActive = requestItem.classList.contains('active');
                        requestItem.style.background = isActive ? '#eff6ff' : '#ffffff';
                        requestItem.style.borderColor = isActive ? '#3b82f6' : '#e5e7eb';
                    }
                }
            });
        } else if (isNewsListMode) {
            // æ–°é—»åˆ—è¡¨æ¨¡å¼
            const filteredNews = this._getFilteredNews();
            const allSelected = filteredNews.length > 0 && 
                               filteredNews.every(news => {
                                   const newsId = news.link || news.id || '';
                                   return newsId && this.selectedNewsIds.has(newsId);
                               });
            
            if (allSelected) {
                // å–æ¶ˆå…¨é€‰ï¼šåªå–æ¶ˆå½“å‰æ˜¾ç¤ºçš„æ–°é—»
                filteredNews.forEach(news => {
                    const newsId = news.link || news.id || '';
                    if (newsId) {
                        this.selectedNewsIds.delete(newsId);
                    }
                });
            } else {
                // å…¨é€‰ï¼šé€‰ä¸­æ‰€æœ‰å½“å‰æ˜¾ç¤ºçš„æ–°é—»
                filteredNews.forEach(news => {
                    const newsId = news.link || news.id || '';
                    if (newsId) {
                        this.selectedNewsIds.add(newsId);
                    }
                });
            }
            
            // æ›´æ–°æ‰€æœ‰å¤é€‰æ¡†çŠ¶æ€
            const checkboxes = document.querySelectorAll('.news-checkbox');
            checkboxes.forEach(checkbox => {
                const newsId = checkbox.dataset.newsId;
                checkbox.checked = this.selectedNewsIds.has(newsId);
                
                // æ›´æ–°æ–°é—»é¡¹çš„é€‰ä¸­çŠ¶æ€ç±»
                const newsItem = checkbox.closest('.news-item');
                if (newsItem) {
                    if (this.selectedNewsIds.has(newsId)) {
                        newsItem.classList.add('selected');
                    } else {
                        newsItem.classList.remove('selected');
                    }
                }
            });
        } else {
            // ä¼šè¯åˆ—è¡¨æ¨¡å¼
            const filteredSessions = this._getFilteredSessions();
            const allSelected = filteredSessions.length > 0 && 
                               filteredSessions.every(session => this.selectedSessionIds.has(session.id));
            
            if (allSelected) {
                // å–æ¶ˆå…¨é€‰ï¼šåªå–æ¶ˆå½“å‰æ˜¾ç¤ºçš„ä¼šè¯
                filteredSessions.forEach(session => {
                    this.selectedSessionIds.delete(session.id);
                });
            } else {
                // å…¨é€‰ï¼šé€‰ä¸­æ‰€æœ‰å½“å‰æ˜¾ç¤ºçš„ä¼šè¯
                filteredSessions.forEach(session => {
                    this.selectedSessionIds.add(session.id);
                });
            }
            
            // æ›´æ–°æ‰€æœ‰å¤é€‰æ¡†çŠ¶æ€
            const checkboxes = document.querySelectorAll('.session-checkbox');
            checkboxes.forEach(checkbox => {
                const sessionId = checkbox.dataset.sessionId;
                checkbox.checked = this.selectedSessionIds.has(sessionId);
                
                // æ›´æ–°ä¼šè¯é¡¹çš„é€‰ä¸­çŠ¶æ€ç±»
                const sessionItem = checkbox.closest('.session-item');
                if (sessionItem) {
                    if (this.selectedSessionIds.has(sessionId)) {
                        sessionItem.classList.add('selected');
                    } else {
                        sessionItem.classList.remove('selected');
                    }
                }
            });
        }
        
        // æ›´æ–°æ‰¹é‡å·¥å…·æ 
        this.updateBatchToolbar();
    }
    
    // æ‰¹é‡åˆ é™¤ï¼ˆæ”¯æŒä¼šè¯ã€æ–‡ä»¶ã€è¯·æ±‚æ¥å£å’Œæ–°é—»ï¼‰
    async batchDeleteSessions() {
        const sessionList = this.sessionSidebar.querySelector('.session-list');
        const ossFileList = this.sessionSidebar.querySelector('.oss-file-list');
        const apiRequestList = this.sessionSidebar.querySelector('.api-request-list');
        const newsList = this.sessionSidebar.querySelector('.news-list');
        const isFileListMode = ossFileList && ossFileList.style.display !== 'none';
        const isApiRequestListMode = apiRequestList && apiRequestList.style.display !== 'none';
        const isNewsListMode = newsList && newsList.style.display !== 'none';
        
        if (isNewsListMode) {
            // æ‰¹é‡åˆ é™¤æ–°é—»
            if (this.selectedNewsIds.size === 0) {
                this.showNotification('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–°é—»', 'error');
                return;
            }
            
            const count = this.selectedNewsIds.size;
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} æ¡æ–°é—»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const newsIds = Array.from(this.selectedNewsIds);
            
            try {
                if (!this.newsManager) {
                    this.showNotification('æ–°é—»ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ é™¤', 'error');
                    return;
                }
                
                let successCount = 0;
                let failCount = 0;
                
                // è·å–æ‰€æœ‰æ–°é—»æ•°æ®ï¼Œç”¨äºåˆ é™¤
                const allNews = this.newsManager.getAllNews();
                
                for (const newsId of newsIds) {
                    try {
                        // æŸ¥æ‰¾å¯¹åº”çš„æ–°é—»æ•°æ®
                        const newsItem = allNews.find(news => {
                            const itemId = news.link || news.id || '';
                            return itemId === newsId;
                        });
                        
                        if (!newsItem) {
                            console.warn(`æœªæ‰¾åˆ°æ–°é—»æ•°æ®: ${newsId}`);
                            failCount++;
                            continue;
                        }
                        
                        // è°ƒç”¨åˆ é™¤æ¥å£
                        await this.newsManager.deleteNews(newsItem);
                        successCount++;
                    } catch (error) {
                        console.error(`åˆ é™¤æ–°é—»å¤±è´¥: ${newsId}`, error);
                        failCount++;
                    }
                }
                
                // é‡æ–°æ¸²æŸ“æ–°é—»åˆ—è¡¨
                await this.updateNewsSidebar(false);
                
                // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                this.selectedNewsIds.clear();
                
                // æ›´æ–°æ‰¹é‡å·¥å…·æ 
                this.updateBatchToolbar();
                
                // å¦‚æœå…¨éƒ¨åˆ é™¤æˆåŠŸï¼Œé€€å‡ºæ‰¹é‡æ¨¡å¼
                if (failCount === 0 && successCount > 0) {
                    this.exitBatchMode();
                }
                
                // æ˜¾ç¤ºç»“æœ
                if (successCount > 0) {
                    if (failCount === 0) {
                        this.showNotification(`æˆåŠŸåˆ é™¤ ${successCount} æ¡æ–°é—»`, 'success');
                    } else {
                        this.showNotification(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${failCount} æ¡`, 'error');
                    }
                } else {
                    this.showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤æ–°é—»å¤±è´¥:', error);
                this.showNotification('æ‰¹é‡åˆ é™¤æ–°é—»å¤±è´¥: ' + error.message, 'error');
            }
        } else if (isApiRequestListMode) {
            // æ‰¹é‡åˆ é™¤è¯·æ±‚æ¥å£
            if (this.selectedApiRequestIds.size === 0) {
                this.showNotification('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¯·æ±‚æ¥å£', 'error');
                return;
            }
            
            const count = this.selectedApiRequestIds.size;
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªè¯·æ±‚æ¥å£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const requestIds = Array.from(this.selectedApiRequestIds);
            
            try {
                // æ£€æŸ¥apiRequestApiæ˜¯å¦å¯ç”¨
                if (!this.apiRequestApi || !this.apiRequestApi.isEnabled()) {
                    this.showNotification('APIç®¡ç†å™¨æœªå¯ç”¨ï¼Œæ— æ³•åˆ é™¤', 'error');
                    return;
                }
                
                let successCount = 0;
                let failCount = 0;
                
                // è·å–æ‰€æœ‰è¯·æ±‚æ¥å£æ•°æ®ï¼Œç”¨äºåˆ é™¤
                const allRequests = this.apiRequestManager ? this.apiRequestManager.getAllRequests() : [];
                
                for (const requestKey of requestIds) {
                    try {
                        // æŸ¥æ‰¾å¯¹åº”çš„è¯·æ±‚æ¥å£æ•°æ®ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
                        const apiRequest = allRequests.find(req => {
                            // ç¡®ä¿è¯·æ±‚æœ‰ key å­—æ®µ
                            this._ensureRequestKey(req);
                            const reqKey = this._getRequestKey(req);
                            return reqKey === requestKey;
                        });
                        
                        if (!apiRequest) {
                            console.warn(`æœªæ‰¾åˆ°è¯·æ±‚æ¥å£æ•°æ®: ${requestKey}`);
                            failCount++;
                            continue;
                        }
                        
                        // ç¡®ä¿è¯·æ±‚æœ‰ key å­—æ®µ
                        const finalKey = this._ensureRequestKey(apiRequest);
                        if (!finalKey) {
                            console.warn(`è¯·æ±‚æ¥å£ç¼ºå°‘ key å­—æ®µ:`, apiRequest);
                            failCount++;
                            continue;
                        }
                        
                        // å‡†å¤‡åˆ é™¤æ•°æ®ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
                        const deleteData = {
                            key: finalKey,
                            url: apiRequest.url || apiRequest.requestUrl || ''
                        };
                        
                        // è°ƒç”¨APIåˆ é™¤
                        await this.apiRequestApi.deleteApiRequest(deleteData);
                        
                        // ä»æœ¬åœ°è¯·æ±‚åˆ—è¡¨ä¸­ç§»é™¤ï¼ˆä½¿ç”¨ key å­—æ®µï¼‰
                        if (this.apiRequestManager) {
                            const index = this.apiRequestManager.requests.findIndex(req => {
                                this._ensureRequestKey(req);
                                const reqKey = this._getRequestKey(req);
                                return reqKey === requestKey;
                            });
                            
                            if (index >= 0) {
                                this.apiRequestManager.requests.splice(index, 1);
                            }
                        }
                        
                        successCount++;
                    } catch (error) {
                        console.error(`åˆ é™¤è¯·æ±‚æ¥å£ ${requestKey} å¤±è´¥:`, error);
                        failCount++;
                    }
                }
                
                // é‡å»ºç´¢å¼•
                if (this.apiRequestManager && this.apiRequestManager._rebuildIndex) {
                    this.apiRequestManager._rebuildIndex();
                }
                
                // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                this.selectedApiRequestIds.clear();
                
                // é€€å‡ºæ‰¹é‡æ¨¡å¼
                this.exitBatchMode();
                
                // åˆ·æ–°è¯·æ±‚æ¥å£åˆ—è¡¨
                await this.updateApiRequestSidebar(true);
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                if (failCount === 0) {
                    this.showNotification(`å·²æˆåŠŸåˆ é™¤ ${successCount} ä¸ªè¯·æ±‚æ¥å£`, 'success');
                } else {
                    this.showNotification(`å·²åˆ é™¤ ${successCount} ä¸ªè¯·æ±‚æ¥å£ï¼Œ${failCount} ä¸ªå¤±è´¥`, 'error');
                }
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤è¯·æ±‚æ¥å£å¤±è´¥:', error);
                this.showNotification('æ‰¹é‡åˆ é™¤è¯·æ±‚æ¥å£å¤±è´¥: ' + error.message, 'error');
            }
        } else if (isFileListMode) {
            // æ‰¹é‡åˆ é™¤æ–‡ä»¶
            if (this.selectedFileNames.size === 0) {
                this.showNotification('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶', 'error');
                return;
            }
            
            const count = this.selectedFileNames.size;
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const fileNames = Array.from(this.selectedFileNames);
            
            try {
                // ä»åç«¯åˆ é™¤æ–‡ä»¶
                if (this.ossFileManager && this.ossApi) {
                    let successCount = 0;
                    let failCount = 0;
                    
                    for (const fileName of fileNames) {
                        try {
                            await this.ossFileManager.deleteFile(fileName);
                            successCount++;
                        } catch (error) {
                            console.error(`åˆ é™¤æ–‡ä»¶ ${fileName} å¤±è´¥:`, error);
                            failCount++;
                        }
                    }
                    
                    // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                    this.selectedFileNames.clear();
                    
                    // é€€å‡ºæ‰¹é‡æ¨¡å¼
                    this.exitBatchMode();
                    
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    await this.updateOssFileSidebar(true);
                    
                    // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                    if (failCount === 0) {
                        this.showNotification(`å·²æˆåŠŸåˆ é™¤ ${successCount} ä¸ªæ–‡ä»¶`, 'success');
                    } else {
                        this.showNotification(`å·²åˆ é™¤ ${successCount} ä¸ªæ–‡ä»¶ï¼Œ${failCount} ä¸ªå¤±è´¥`, 'error');
                    }
                } else {
                    this.showNotification('æ–‡ä»¶ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                }
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                this.showNotification('æ‰¹é‡åˆ é™¤æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
            }
        } else {
            // æ‰¹é‡åˆ é™¤ä¼šè¯
            if (this.selectedSessionIds.size === 0) {
                this.showNotification('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä¼šè¯', 'error');
                return;
            }
            
            const count = this.selectedSessionIds.size;
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªä¼šè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const sessionIds = Array.from(this.selectedSessionIds);
            
            try {
                // ä»æœ¬åœ°åˆ é™¤
                sessionIds.forEach(sessionId => {
                    if (this.sessions[sessionId]) {
                        delete this.sessions[sessionId];
                    }
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œæ¸…ç©ºå½“å‰ä¼šè¯ID
                    if (sessionId === this.currentSessionId) {
                        this.currentSessionId = null;
                        this.hasAutoCreatedSessionForPage = false;
                    }
                });
                
                // ä¿å­˜æœ¬åœ°æ›´æ”¹
                if (this.sessionManager) {
                    // ä½¿ç”¨ SessionManager æ‰¹é‡åˆ é™¤
                    for (const sessionId of sessionIds) {
                        await this.sessionManager.deleteSession(sessionId);
                    }
                } else {
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    await this.saveAllSessions(true);
                }
                
                // ä»åç«¯åˆ é™¤ï¼ˆå¦‚æœå¯ç”¨äº†åç«¯åŒæ­¥ï¼‰
                if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                    try {
                        await this.sessionApi.deleteSessions(sessionIds);
                        console.log('æ‰¹é‡åˆ é™¤ä¼šè¯å·²åŒæ­¥åˆ°åç«¯:', sessionIds);
                    } catch (error) {
                        console.warn('ä»åç«¯æ‰¹é‡åˆ é™¤ä¼šè¯å¤±è´¥:', error);
                        // å³ä½¿åç«¯åˆ é™¤å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºæœ¬åœ°å·²åˆ é™¤
                    }
                }
                
                // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                this.selectedSessionIds.clear();
                
                // é€€å‡ºæ‰¹é‡æ¨¡å¼
                this.exitBatchMode();
                
                // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                await this.updateSessionSidebar(true);
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                this.showNotification(`å·²æˆåŠŸåˆ é™¤ ${count} ä¸ªä¼šè¯`, 'success');
                
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤ä¼šè¯å¤±è´¥:', error);
                this.showNotification('æ‰¹é‡åˆ é™¤ä¼šè¯å¤±è´¥: ' + error.message, 'error');
            }
        }
    }

    // åˆ é™¤ä¼šè¯
    async deleteSession(sessionId, skipConfirm = false) {
        if (!sessionId || !this.sessions[sessionId]) return;
        
        // è·å–ä¼šè¯æ ‡é¢˜ç”¨äºæç¤º
        const session = this.sessions[sessionId];
        const sessionTitle = session?.pageTitle || sessionId || 'æœªå‘½åä¼šè¯';
        
        // ç¡®è®¤åˆ é™¤ï¼ˆå¦‚æœæœªè·³è¿‡ç¡®è®¤ï¼‰
        if (!skipConfirm) {
            const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤ä¼šè¯"${sessionTitle}"å—ï¼Ÿ`);
            if (!confirmDelete) return;
        }
        
        // è®°å½•æ˜¯å¦åˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯
        const isCurrentSession = sessionId === this.currentSessionId;
        
        // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
        // åˆ é™¤ä¼šè¯å‰ä¸å†è‡ªåŠ¨ä¿å­˜å½“å‰ä¼šè¯
        
        // ä»åç«¯åˆ é™¤ä¼šè¯ï¼ˆå¦‚æœå¯ç”¨äº†åç«¯åŒæ­¥ï¼‰
        if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
            try {
                // ç¡®ä¿ä½¿ç”¨ session.id ä½œä¸ºç»Ÿä¸€æ ‡è¯†
                const unifiedSessionId = session.id || sessionId;
                await this.sessionApi.deleteSession(unifiedSessionId);
                console.log('ä¼šè¯å·²ä»åç«¯åˆ é™¤:', unifiedSessionId);
            } catch (error) {
                console.warn('ä»åç«¯åˆ é™¤ä¼šè¯å¤±è´¥:', error);
                // å³ä½¿åç«¯åˆ é™¤å¤±è´¥ï¼Œä¹Ÿç»§ç»­æœ¬åœ°åˆ é™¤ï¼Œç¡®ä¿ç”¨æˆ·ç•Œé¢å“åº”
            }
        }
        
        // ä»æœ¬åœ°åˆ é™¤ä¼šè¯
        delete this.sessions[sessionId];
        // æ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ä¼šè¯åŠŸèƒ½ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜
        // åˆ é™¤æ“ä½œé€šè¿‡åç«¯APIå®ŒæˆæŒä¹…åŒ–
        
        // åˆ é™¤ä¼šè¯åï¼Œé‡æ–°ä»æ¥å£è·å–ä¼šè¯åˆ—è¡¨ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
        if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
            try {
                await this.loadSessionsFromBackend(true);
                console.log('ä¼šè¯åˆ—è¡¨å·²ä»åç«¯åˆ·æ–°');
            } catch (error) {
                console.warn('åˆ·æ–°ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯æˆ–æ¸…ç©º
        if (isCurrentSession) {
            // æŸ¥æ‰¾æœ€æ–°çš„å…¶ä»–ä¼šè¯
            const otherSessions = Object.values(this.sessions);
            
            if (otherSessions.length > 0) {
                // åˆ‡æ¢åˆ°æœ€è¿‘è®¿é—®çš„ä¼šè¯ï¼ˆä½¿ç”¨ lastAccessTimeï¼Œæ›´ç¬¦åˆ"æœ€æ–°ä½¿ç”¨"çš„æ¦‚å¿µï¼‰
                // å¦‚æœæ²¡æœ‰ lastAccessTimeï¼Œåˆ™ä½¿ç”¨ createdAt ä½œä¸ºå¤‡é€‰
                const latestSession = otherSessions.sort((a, b) => {
                    const aTime = a.lastAccessTime || a.createdAt || 0;
                    const bTime = b.lastAccessTime || b.createdAt || 0;
                    return bTime - aTime; // æœ€è¿‘è®¿é—®çš„åœ¨å‰
                })[0];
                
                await this.activateSession(latestSession.id, {
                    saveCurrent: false, // å·²ç»åœ¨å‰é¢ä¿å­˜äº†
                    updateUI: true,
                    syncToBackend: false // åˆ é™¤ä¼šè¯åçš„è‡ªåŠ¨åˆ‡æ¢ä¸è°ƒç”¨ session/save æ¥å£
                });
            } else {
                // æ²¡æœ‰å…¶ä»–ä¼šè¯ï¼Œæ¸…ç©ºå½“å‰ä¼šè¯
                this.currentSessionId = null;
                this.hasAutoCreatedSessionForPage = false;
                
                // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤º
                if (this.chatWindow && this.isChatOpen) {
                    const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = '';
                    }
                }
            }
        }
        
        // æ›´æ–°ä¾§è¾¹æ 
        await this.updateSessionUI({ updateSidebar: true });
        
        console.log('ä¼šè¯å·²åˆ é™¤:', sessionId);
    }

    // åˆ›å»ºä¼šè¯å‰¯æœ¬
    async duplicateSession(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            this.showNotification('ä¼šè¯ä¸å­˜åœ¨', 'error');
            return;
        }
        
        const sourceSession = this.sessions[sessionId];
        
        try {
            // ç”Ÿæˆæ–°çš„ä¼šè¯IDï¼ˆåŸºäºæ—¶é—´æˆ³å’Œéšæœºæ•°ï¼‰
            const newSessionId = await this.generateSessionId(`duplicate_${Date.now()}_${Math.random()}`);
            
            // ç”Ÿæˆæ–°çš„URLï¼ˆæ·»åŠ å‰¯æœ¬æ ‡è¯†ï¼‰
            const newUrl = sourceSession.url ? `${sourceSession.url}#duplicate_${Date.now()}` : '';
            
            // åˆ›å»ºä¼šè¯å‰¯æœ¬ï¼Œå¤åˆ¶æ‰€æœ‰æ•°æ®ï¼Œä½†messagesä¸ºç©ºæ•°ç»„
            const now = Date.now();
            const duplicatedSession = {
                id: newSessionId,
                url: newUrl,
                pageTitle: sourceSession.pageTitle ? `${sourceSession.pageTitle} (å‰¯æœ¬)` : 'æ–°ä¼šè¯ (å‰¯æœ¬)',
                pageDescription: sourceSession.pageDescription || '',
                pageContent: sourceSession.pageContent || '',
                messages: [], // messagesä¸ºç©ºæ•°ç»„
                tags: sourceSession.tags ? [...sourceSession.tags] : [],
                createdAt: now,
                updatedAt: now,
                lastAccessTime: now
            };
            
            // ç›´æ¥è°ƒç”¨æ¥å£ä¿å­˜å‰¯æœ¬
            if (this.sessionApi) {
                try {
                    await this.sessionApi.saveSession(duplicatedSession);
                    console.log('ä¼šè¯å‰¯æœ¬å·²ä¿å­˜åˆ°åç«¯:', newSessionId);
                    
                    // ç«‹å³å°†å‰¯æœ¬æ·»åŠ åˆ°æœ¬åœ°sessionsï¼Œç¡®ä¿å³ä½¿åç«¯åŠ è½½å¤±è´¥ä¹Ÿèƒ½æ˜¾ç¤º
                    this.sessions[newSessionId] = duplicatedSession;
                    
                    // ä¿å­˜åæ›´æ–°ä¼šè¯åˆ—è¡¨ï¼ˆä»åç«¯é‡æ–°åŠ è½½ï¼‰
                    if (PET_CONFIG.api.syncSessionsToBackend) {
                        try {
                            await this.loadSessionsFromBackend(true);
                        } catch (loadError) {
                            console.warn('ä»åç«¯åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', loadError);
                            // å³ä½¿åç«¯åŠ è½½å¤±è´¥ï¼Œä¹Ÿä¿å­˜æœ¬åœ°æ•°æ®å¹¶æ›´æ–°UI
                            await this.saveAllSessions(true, false);
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰å¯ç”¨åç«¯åŒæ­¥ï¼Œä¿å­˜æœ¬åœ°æ•°æ®
                        await this.saveAllSessions(true, false);
                    }
                    
                    // åˆ·æ–°ä¾§è¾¹æ UI
                    await this.updateSessionUI({ updateSidebar: true });
                    
                    this.showNotification('ä¼šè¯å‰¯æœ¬å·²åˆ›å»º', 'success');
                } catch (error) {
                    console.error('ä¿å­˜ä¼šè¯å‰¯æœ¬åˆ°åç«¯å¤±è´¥:', error);
                    this.showNotification('åˆ›å»ºå‰¯æœ¬å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                // å¦‚æœæ²¡æœ‰sessionApiï¼Œåªä¿å­˜åˆ°æœ¬åœ°
                this.sessions[newSessionId] = duplicatedSession;
                await this.saveAllSessions(true);
                
                // æ›´æ–°ä¾§è¾¹æ 
                await this.updateSessionUI({ updateSidebar: true });
                
                this.showNotification('ä¼šè¯å‰¯æœ¬å·²åˆ›å»º', 'success');
            }
        } catch (error) {
            console.error('åˆ›å»ºä¼šè¯å‰¯æœ¬å¤±è´¥:', error);
            this.showNotification('åˆ›å»ºå‰¯æœ¬å¤±è´¥: ' + error.message, 'error');
        }
    }

    // åŠ è½½ä¾§è¾¹æ å®½åº¦
    loadSidebarWidth() {
        try {
            chrome.storage.local.get(['sessionSidebarWidth'], (result) => {
                if (result.sessionSidebarWidth && typeof result.sessionSidebarWidth === 'number') {
                    // éªŒè¯å®½åº¦æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…
                    const width = Math.max(150, Math.min(500, result.sessionSidebarWidth));
                    this.sidebarWidth = width;
                    console.log('åŠ è½½ä¾§è¾¹æ å®½åº¦:', width);
                    
                    // å¦‚æœä¾§è¾¹æ å·²åˆ›å»ºï¼Œæ›´æ–°å…¶å®½åº¦
                    if (this.sessionSidebar) {
                        this.sessionSidebar.style.setProperty('width', `${width}px`, 'important');
                    }
                }
            });
        } catch (error) {
            console.log('åŠ è½½ä¾§è¾¹æ å®½åº¦å¤±è´¥:', error);
        }
    }

    // ä¿å­˜ä¾§è¾¹æ å®½åº¦
    saveSidebarWidth() {
        try {
            chrome.storage.local.set({ sessionSidebarWidth: this.sidebarWidth }, () => {
                console.log('ä¿å­˜ä¾§è¾¹æ å®½åº¦:', this.sidebarWidth);
            });
        } catch (error) {
            console.log('ä¿å­˜ä¾§è¾¹æ å®½åº¦å¤±è´¥:', error);
        }
    }

    // åŠ è½½ä¾§è¾¹æ æŠ˜å çŠ¶æ€
    loadSidebarCollapsed() {
        try {
            chrome.storage.local.get(['sessionSidebarCollapsed'], (result) => {
                if (result.sessionSidebarCollapsed !== undefined) {
                    this.sidebarCollapsed = result.sessionSidebarCollapsed;
                    console.log('åŠ è½½ä¾§è¾¹æ æŠ˜å çŠ¶æ€:', this.sidebarCollapsed);
                    
                    // å¦‚æœä¾§è¾¹æ å·²åˆ›å»ºï¼Œåº”ç”¨æŠ˜å çŠ¶æ€
                    if (this.sessionSidebar) {
                        this.applySidebarCollapsedState();
                    }
                }
            });
        } catch (error) {
            console.log('åŠ è½½ä¾§è¾¹æ æŠ˜å çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // ä¿å­˜ä¾§è¾¹æ æŠ˜å çŠ¶æ€
    saveSidebarCollapsed() {
        try {
            chrome.storage.local.set({ sessionSidebarCollapsed: this.sidebarCollapsed }, () => {
                console.log('ä¿å­˜ä¾§è¾¹æ æŠ˜å çŠ¶æ€:', this.sidebarCollapsed);
            });
        } catch (error) {
            console.log('ä¿å­˜ä¾§è¾¹æ æŠ˜å çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // åº”ç”¨ä¾§è¾¹æ æŠ˜å çŠ¶æ€
    applySidebarCollapsedState() {
        if (!this.sessionSidebar) return;
        
        if (this.sidebarCollapsed) {
            this.sessionSidebar.style.setProperty('display', 'none', 'important');
        } else {
            this.sessionSidebar.style.setProperty('display', 'flex', 'important');
        }
    }

    // åˆ‡æ¢ä¾§è¾¹æ æŠ˜å çŠ¶æ€
    toggleSidebar() {
        this.sidebarCollapsed = !this.sidebarCollapsed;
        this.applySidebarCollapsedState();
        this.saveSidebarCollapsed();
        
        // æ›´æ–°æŠ˜å æŒ‰é’®å›¾æ ‡å’Œä½ç½®
        const toggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        if (toggleBtn) {
            const icon = toggleBtn.querySelector('.toggle-icon');
            if (icon) {
                // æ·»åŠ æ·¡å‡ºæ•ˆæœ
                icon.style.opacity = '0.3';
                icon.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    icon.textContent = this.sidebarCollapsed ? 'â–¶' : 'â—€';
                    icon.style.opacity = '1';
                    icon.style.transform = 'scale(1)';
                }, 125);
            }
            toggleBtn.title = this.sidebarCollapsed ? 'å±•å¼€ä¾§è¾¹æ ' : 'æŠ˜å ä¾§è¾¹æ ';
            // æ›´æ–°æŒ‰é’®ä½ç½®ï¼šæŠ˜å æ—¶åœ¨å·¦ä¾§è¾¹ç¼˜ï¼Œå±•å¼€æ—¶åœ¨ä¾§è¾¹æ å³è¾¹ç¼˜
            // ä½¿ç”¨ translateX(14px) è®©æŒ‰é’®å®Œå…¨åœ¨ä¾§è¾¹æ å¤–é¢
            if (this.sidebarCollapsed) {
                toggleBtn.style.left = '0px';
            } else {
                toggleBtn.style.left = `${this.sidebarWidth}px`;
            }
            // ç¡®ä¿åŸºç¡€ transform æ ·å¼æ­£ç¡®ï¼ˆä¿ç•™scaleç”¨äºhoveræ•ˆæœï¼‰
            const currentTransform = toggleBtn.style.transform;
            const baseTransform = 'translateY(-50%) translateX(14px)';
            if (!currentTransform.includes('scale')) {
                toggleBtn.style.transform = baseTransform;
            } else {
                // å¦‚æœå½“å‰æœ‰scaleï¼Œä¿ç•™scaleå€¼
                const scaleMatch = currentTransform.match(/scale\([^)]+\)/);
                if (scaleMatch) {
                    toggleBtn.style.transform = `${baseTransform} ${scaleMatch[0]}`;
                } else {
                    toggleBtn.style.transform = baseTransform;
                }
            }
        }
    }

    // åŠ è½½è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€
    loadInputContainerCollapsed() {
        try {
            chrome.storage.local.get(['chatInputContainerCollapsed'], (result) => {
                if (result.chatInputContainerCollapsed !== undefined) {
                    this.inputContainerCollapsed = result.chatInputContainerCollapsed;
                    console.log('åŠ è½½è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€:', this.inputContainerCollapsed);
                    
                    // å¦‚æœè¾“å…¥æ¡†å®¹å™¨å·²åˆ›å»ºï¼Œåº”ç”¨æŠ˜å çŠ¶æ€
                    if (this.chatWindow) {
                        this.applyInputContainerCollapsedState();
                    }
                }
            });
        } catch (error) {
            console.log('åŠ è½½è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // ä¿å­˜è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€
    saveInputContainerCollapsed() {
        try {
            chrome.storage.local.set({ chatInputContainerCollapsed: this.inputContainerCollapsed }, () => {
                console.log('ä¿å­˜è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€:', this.inputContainerCollapsed);
            });
        } catch (error) {
            console.log('ä¿å­˜è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // åº”ç”¨è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€
    applyInputContainerCollapsedState() {
        if (!this.chatWindow) return;
        
        const inputContainer = this.chatWindow.querySelector('.chat-input-container');
        if (!inputContainer) return;
        
        if (this.inputContainerCollapsed) {
            inputContainer.style.setProperty('display', 'none', 'important');
        } else {
            inputContainer.style.setProperty('display', 'flex', 'important');
        }
        
        // æ›´æ–°æŠ˜å æŒ‰é’®ä½ç½®
        const toggleBtn = this.chatWindow.querySelector('#input-container-toggle-btn');
        if (toggleBtn) {
            setTimeout(() => {
                const inputHeight = inputContainer.offsetHeight || 160;
                if (this.inputContainerCollapsed) {
                    toggleBtn.style.bottom = '0px';
                } else {
                    toggleBtn.style.bottom = `${inputHeight}px`;
                }
            }, 50);
        }
    }

    // åˆ‡æ¢è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€
    toggleInputContainer() {
        this.inputContainerCollapsed = !this.inputContainerCollapsed;
        this.applyInputContainerCollapsedState();
        this.saveInputContainerCollapsed();
        
        // æ›´æ–°æŠ˜å æŒ‰é’®å›¾æ ‡å’Œä½ç½®
        const toggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (toggleBtn) {
            const icon = toggleBtn.querySelector('.toggle-icon');
            if (icon) {
                // æ·»åŠ æ·¡å‡ºæ•ˆæœ
                icon.style.opacity = '0.3';
                icon.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    icon.textContent = this.inputContainerCollapsed ? 'â–²' : 'â–¼';
                    icon.style.opacity = '1';
                    icon.style.transform = 'scale(1)';
                }, 125);
            }
            toggleBtn.title = this.inputContainerCollapsed ? 'å±•å¼€è¾“å…¥æ¡†' : 'æŠ˜å è¾“å…¥æ¡†';
            // æ›´æ–°æŒ‰é’®ä½ç½®ï¼šæ ¹æ®è¾“å…¥æ¡†æ˜¯å¦æŠ˜å è°ƒæ•´ä½ç½®
            const inputContainer = this.chatWindow?.querySelector('.chat-input-container');
            if (inputContainer) {
                if (this.inputContainerCollapsed) {
                    // è¾“å…¥æ¡†æŠ˜å æ—¶ï¼ŒæŒ‰é’®åœ¨åº•éƒ¨
                    toggleBtn.style.bottom = '0px';
                } else {
                    // è¾“å…¥æ¡†å±•å¼€æ—¶ï¼ŒæŒ‰é’®åœ¨è¾“å…¥æ¡†ä¸Šæ–¹
                    const inputHeight = inputContainer.offsetHeight || 160;
                    toggleBtn.style.bottom = `${inputHeight}px`;
                }
            }
            // ç¡®ä¿åŸºç¡€ transform æ ·å¼æ­£ç¡®ï¼ˆä¿ç•™scaleç”¨äºhoveræ•ˆæœï¼‰
            const currentTransform = toggleBtn.style.transform;
            const baseTransform = 'translateX(-50%) translateY(-8px)';
            if (!currentTransform.includes('scale')) {
                toggleBtn.style.transform = baseTransform;
            } else {
                // å¦‚æœå½“å‰æœ‰scaleï¼Œä¿ç•™scaleå€¼
                const scaleMatch = currentTransform.match(/scale\([^)]+\)/);
                if (scaleMatch) {
                    toggleBtn.style.transform = `${baseTransform} ${scaleMatch[0]}`;
                } else {
                    toggleBtn.style.transform = baseTransform;
                }
            }
        }
    }

    // åˆ›å»ºä¾§è¾¹æ æ‹–æ‹½è°ƒæ•´è¾¹æ¡†
    createSidebarResizer() {
        if (!this.sessionSidebar) return;

        const resizer = document.createElement('div');
        resizer.className = 'sidebar-resizer';
        resizer.style.cssText = `
            position: absolute !important;
            top: 0 !important;
            right: -4px !important;
            width: 8px !important;
            height: 100% !important;
            cursor: col-resize !important;
            z-index: 10 !important;
            background: transparent !important;
            transition: background 0.2s ease !important;
        `;

        // é¼ æ ‡æ‚¬åœæ•ˆæœ
        resizer.addEventListener('mouseenter', () => {
            if (!this.isResizingSidebar) {
                resizer.style.setProperty('background', 'rgba(59, 130, 246, 0.3)', 'important');
            }
        });

        resizer.addEventListener('mouseleave', () => {
            if (!this.isResizingSidebar) {
                resizer.style.setProperty('background', 'transparent', 'important');
            }
        });

        // æ‹–æ‹½å¼€å§‹
        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            this.isResizingSidebar = true;
            resizer.style.setProperty('background', 'rgba(59, 130, 246, 0.5)', 'important');
            resizer.style.setProperty('cursor', 'col-resize', 'important');
            
            // è®°å½•åˆå§‹ä½ç½®å’Œå®½åº¦
            const startX = e.clientX;
            const startWidth = this.sidebarWidth;
            
            // æ·»åŠ å…¨å±€æ ·å¼ï¼Œç¦ç”¨æ–‡æœ¬é€‰æ‹©
            document.body.style.userSelect = 'none';
            document.body.style.cursor = 'col-resize';
            
            // æ‹–æ‹½ä¸­
            const handleMouseMove = (e) => {
                if (!this.isResizingSidebar) return;
                
                const diffX = e.clientX - startX;
                let newWidth = startWidth + diffX;
                
                // é™åˆ¶å®½åº¦èŒƒå›´
                newWidth = Math.max(150, Math.min(500, newWidth));
                
                // æ›´æ–°å®½åº¦
                this.sidebarWidth = newWidth;
                if (this.sessionSidebar) {
                    this.sessionSidebar.style.setProperty('width', `${newWidth}px`, 'important');
                }
                
                // æ›´æ–°æŠ˜å æŒ‰é’®ä½ç½®ï¼ˆå‚è€ƒè¾“å…¥æ¡†æŠ˜å æŒ‰é’®çš„å®ç°æ–¹å¼ï¼‰
                const toggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
                if (toggleBtn && !this.sidebarCollapsed) {
                    toggleBtn.style.left = `${newWidth}px`;
                    // ç¡®ä¿ transform æ ·å¼æ­£ç¡®ï¼ŒæŒ‰é’®å®Œå…¨åœ¨å¤–é¢ï¼ˆä¿ç•™scaleç”¨äºhoveræ•ˆæœï¼‰
                    const currentTransform = toggleBtn.style.transform;
                    const baseTransform = 'translateY(-50%) translateX(14px)';
                    if (!currentTransform.includes('scale')) {
                        toggleBtn.style.transform = baseTransform;
                    } else {
                        const scaleMatch = currentTransform.match(/scale\([^)]+\)/);
                        if (scaleMatch) {
                            toggleBtn.style.transform = `${baseTransform} ${scaleMatch[0]}`;
                        } else {
                            toggleBtn.style.transform = baseTransform;
                        }
                    }
                }
            };
            
            // æ‹–æ‹½ç»“æŸ
            const handleMouseUp = () => {
                this.isResizingSidebar = false;
                resizer.style.setProperty('background', 'transparent', 'important');
                resizer.style.setProperty('cursor', 'col-resize', 'important');
                
                // æ¢å¤å…¨å±€æ ·å¼
                document.body.style.userSelect = '';
                document.body.style.cursor = '';
                
                // ä¿å­˜å®½åº¦
                this.saveSidebarWidth();
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };
            
            // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        });

        this.sessionSidebar.appendChild(resizer);
    }

    formatSessionTime(timestamp) {
        if (!timestamp) return '';
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        if (hours < 24) return `${hours}å°æ—¶å‰`;
        if (days < 7) return `${days}å¤©å‰`;
        return new Date(timestamp).toLocaleDateString('zh-CN');
    }

    // ç¼–è¾‘ä¼šè¯æ ‡é¢˜å’Œæè¿°
    async editSessionTitle(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ç¼–è¾‘æ ‡é¢˜:', sessionId);
            return;
        }

        const session = this.sessions[sessionId];
        const originalTitle = session.pageTitle || 'æœªå‘½åä¼šè¯';
        const originalDescription = session.pageDescription || '';
        
        // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
        this.openSessionInfoEditor(sessionId, originalTitle, originalDescription);
    }

    // æ‰“å¼€ä¼šè¯ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†
    openSessionInfoEditor(sessionId, originalTitle, originalDescription) {
        // ç¡®ä¿å¯¹è¯æ¡†UIå­˜åœ¨
        this.ensureSessionInfoEditorUi();
        
        const modal = document.body.querySelector('#pet-session-info-editor');
        if (!modal) {
            console.error('ä¼šè¯ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†æœªæ‰¾åˆ°');
            return;
        }

        // æ˜¾ç¤ºå¯¹è¯æ¡†
        modal.style.display = 'flex';
        modal.dataset.sessionId = sessionId;

        // å¡«å……å½“å‰å€¼
        const titleInput = modal.querySelector('.session-editor-title-input');
        const descriptionInput = modal.querySelector('.session-editor-description-input');
        const updatedAtInput = modal.querySelector('.session-editor-updatedat-input');
        
        if (titleInput) {
            titleInput.value = originalTitle;
        }
        if (descriptionInput) {
            descriptionInput.value = originalDescription;
        }
        
        // å¡«å……æ›´æ–°æ—¶é—´ï¼Œé»˜è®¤æ˜¯ä»Šå¤©
        if (updatedAtInput) {
            const session = this.sessions[sessionId];
            // ä¼˜å…ˆä½¿ç”¨ updatedAtï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰æ—¶é—´ï¼ˆä»Šå¤©ï¼‰
            let updatedAt = session.updatedAt || Date.now();
            
            // å°†æ—¶é—´æˆ³è½¬æ¢ä¸º datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm)
            const date = new Date(updatedAt);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            updatedAtInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
        if (titleInput) {
            setTimeout(() => {
                titleInput.focus();
                titleInput.select();
            }, 100);
        }

        // æ·»åŠ å…³é—­äº‹ä»¶
        const closeBtn = modal.querySelector('.session-editor-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeSessionInfoEditor();
        }

        // æ·»åŠ ä¿å­˜äº‹ä»¶
        const saveBtn = modal.querySelector('.session-editor-save');
        if (saveBtn) {
            saveBtn.onclick = () => this.saveSessionInfo(sessionId);
        }

        // æ·»åŠ å–æ¶ˆäº‹ä»¶
        const cancelBtn = modal.querySelector('.session-editor-cancel');
        if (cancelBtn) {
            cancelBtn.onclick = () => this.closeSessionInfoEditor();
        }

        // æ·»åŠ æ™ºèƒ½ç”Ÿæˆæ ‡é¢˜äº‹ä»¶
        const generateTitleBtn = modal.querySelector('.session-editor-generate-title');
        if (generateTitleBtn) {
            generateTitleBtn.onclick = () => this.generateSessionTitle(sessionId);
        }

        // æ·»åŠ æ™ºèƒ½ç”Ÿæˆæè¿°äº‹ä»¶
        const generateDescriptionBtn = modal.querySelector('.session-editor-generate-description');
        if (generateDescriptionBtn) {
            generateDescriptionBtn.onclick = () => this.generateSessionDescription(sessionId);
        }

        // æ·»åŠ æ™ºèƒ½ä¼˜åŒ–æè¿°äº‹ä»¶
        const optimizeDescriptionBtn = modal.querySelector('.session-editor-optimize-description');
        if (optimizeDescriptionBtn) {
            optimizeDescriptionBtn.onclick = () => this.optimizeSessionDescription(sessionId);
        }

        // æ·»åŠ ç¿»è¯‘æ ‡é¢˜ä¸­æ–‡äº‹ä»¶
        const translateTitleZhBtn = modal.querySelector('.session-editor-translate-title-zh');
        if (translateTitleZhBtn) {
            translateTitleZhBtn.onclick = () => this.translateSessionField('title', titleInput, 'zh');
        }

        // æ·»åŠ ç¿»è¯‘æ ‡é¢˜è‹±æ–‡äº‹ä»¶
        const translateTitleEnBtn = modal.querySelector('.session-editor-translate-title-en');
        if (translateTitleEnBtn) {
            translateTitleEnBtn.onclick = () => this.translateSessionField('title', titleInput, 'en');
        }

        // æ·»åŠ ç¿»è¯‘æè¿°ä¸­æ–‡äº‹ä»¶
        const translateDescriptionZhBtn = modal.querySelector('.session-editor-translate-description-zh');
        if (translateDescriptionZhBtn) {
            translateDescriptionZhBtn.onclick = () => this.translateSessionField('description', descriptionInput, 'zh');
        }

        // æ·»åŠ ç¿»è¯‘æè¿°è‹±æ–‡äº‹ä»¶
        const translateDescriptionEnBtn = modal.querySelector('.session-editor-translate-description-en');
        if (translateDescriptionEnBtn) {
            translateDescriptionEnBtn.onclick = () => this.translateSessionField('description', descriptionInput, 'en');
        }

        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeSessionInfoEditor();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    // ç¡®ä¿ä¼šè¯ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†UIå­˜åœ¨
    ensureSessionInfoEditorUi() {
        if (document.body.querySelector('#pet-session-info-editor')) return;

        const modal = document.createElement('div');
        modal.id = 'pet-session-info-editor';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 2147483653 !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeSessionInfoEditor();
            }
        });

        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 32px !important;
            width: 90% !important;
            max-width: 700px !important;
            max-height: 85vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
            position: relative !important;
            z-index: 2147483654 !important;
        `;

        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 24px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ç¼–è¾‘ä¼šè¯ä¿¡æ¯';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 20px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'session-editor-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });

        header.appendChild(title);
        header.appendChild(closeBtn);

        // æ ‡é¢˜è¾“å…¥åŒºåŸŸ
        const titleGroup = document.createElement('div');
        titleGroup.style.cssText = `
            margin-bottom: 24px !important;
        `;

        const titleLabel = document.createElement('label');
        titleLabel.textContent = 'ä¼šè¯æ ‡é¢˜';
        titleLabel.style.cssText = `
            display: block !important;
            margin-bottom: 10px !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
        `;

        const titleInputWrapper = document.createElement('div');
        titleInputWrapper.style.cssText = `
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
        `;

        const titleInput = document.createElement('input');
        titleInput.className = 'session-editor-title-input';
        titleInput.type = 'text';
        titleInput.placeholder = 'è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜';
        titleInput.style.cssText = `
            width: 100% !important;
            padding: 12px 14px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 15px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
            box-sizing: border-box !important;
        `;
        
        titleInput.addEventListener('focus', () => {
            titleInput.style.borderColor = '#4CAF50';
        });
        titleInput.addEventListener('blur', () => {
            titleInput.style.borderColor = '#e0e0e0';
        });

        // æŒ‰é’®å®¹å™¨
        const titleButtonContainer = document.createElement('div');
        titleButtonContainer.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            justify-content: flex-end !important;
        `;

        const generateTitleBtn = document.createElement('button');
        generateTitleBtn.className = 'session-editor-generate-title';
        generateTitleBtn.innerHTML = 'âœ¨ æ™ºèƒ½ç”Ÿæˆ';
        generateTitleBtn.style.cssText = `
            padding: 12px 16px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        generateTitleBtn.addEventListener('mouseenter', () => {
            generateTitleBtn.style.background = '#1976D2';
        });
        generateTitleBtn.addEventListener('mouseleave', () => {
            generateTitleBtn.style.background = '#2196F3';
        });

        // ç¿»è¯‘ä¸­æ–‡æŒ‰é’®
        const translateTitleZhBtn = document.createElement('button');
        translateTitleZhBtn.className = 'session-editor-translate-title-zh';
        translateTitleZhBtn.setAttribute('data-translate-field', 'title');
        translateTitleZhBtn.setAttribute('data-target-lang', 'zh');
        translateTitleZhBtn.innerHTML = 'ğŸ‡¨ğŸ‡³ ç¿»è¯‘ä¸­æ–‡';
        translateTitleZhBtn.style.cssText = `
            padding: 12px 16px !important;
            background: #FF9800 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        translateTitleZhBtn.addEventListener('mouseenter', () => {
            translateTitleZhBtn.style.background = '#F57C00';
        });
        translateTitleZhBtn.addEventListener('mouseleave', () => {
            translateTitleZhBtn.style.background = '#FF9800';
        });

        // ç¿»è¯‘è‹±æ–‡æŒ‰é’®
        const translateTitleEnBtn = document.createElement('button');
        translateTitleEnBtn.className = 'session-editor-translate-title-en';
        translateTitleEnBtn.setAttribute('data-translate-field', 'title');
        translateTitleEnBtn.setAttribute('data-target-lang', 'en');
        translateTitleEnBtn.innerHTML = 'ğŸ‡ºğŸ‡¸ ç¿»è¯‘è‹±æ–‡';
        translateTitleEnBtn.style.cssText = `
            padding: 12px 16px !important;
            background: #9C27B0 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        translateTitleEnBtn.addEventListener('mouseenter', () => {
            translateTitleEnBtn.style.background = '#7B1FA2';
        });
        translateTitleEnBtn.addEventListener('mouseleave', () => {
            translateTitleEnBtn.style.background = '#9C27B0';
        });

        titleButtonContainer.appendChild(generateTitleBtn);
        titleButtonContainer.appendChild(translateTitleZhBtn);
        titleButtonContainer.appendChild(translateTitleEnBtn);

        titleInputWrapper.appendChild(titleInput);
        titleInputWrapper.appendChild(titleButtonContainer);

        titleGroup.appendChild(titleLabel);
        titleGroup.appendChild(titleInputWrapper);

        // æè¿°è¾“å…¥åŒºåŸŸ
        const descriptionGroup = document.createElement('div');
        descriptionGroup.style.cssText = `
            margin-bottom: 24px !important;
        `;

        const descriptionLabel = document.createElement('label');
        descriptionLabel.textContent = 'ç½‘é¡µæè¿°';
        descriptionLabel.style.cssText = `
            display: block !important;
            margin-bottom: 10px !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
        `;

        const descriptionInputWrapper = document.createElement('div');
        descriptionInputWrapper.style.cssText = `
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
        `;

        const descriptionInput = document.createElement('textarea');
        descriptionInput.className = 'session-editor-description-input';
        descriptionInput.placeholder = 'è¯·è¾“å…¥ç½‘é¡µæè¿°ï¼ˆå¯é€‰ï¼‰';
        descriptionInput.rows = 6;
        descriptionInput.style.cssText = `
            width: 100% !important;
            padding: 12px 14px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
            resize: vertical !important;
            font-family: inherit !important;
            box-sizing: border-box !important;
            min-height: 120px !important;
        `;
        
        descriptionInput.addEventListener('focus', () => {
            descriptionInput.style.borderColor = '#4CAF50';
        });
        descriptionInput.addEventListener('blur', () => {
            descriptionInput.style.borderColor = '#e0e0e0';
        });

        // æŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            justify-content: flex-end !important;
        `;

        const generateDescriptionBtn = document.createElement('button');
        generateDescriptionBtn.className = 'session-editor-generate-description';
        generateDescriptionBtn.innerHTML = 'âœ¨ æ™ºèƒ½ç”Ÿæˆæè¿°';
        generateDescriptionBtn.style.cssText = `
            padding: 12px 16px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        generateDescriptionBtn.addEventListener('mouseenter', () => {
            generateDescriptionBtn.style.background = '#1976D2';
        });
        generateDescriptionBtn.addEventListener('mouseleave', () => {
            generateDescriptionBtn.style.background = '#2196F3';
        });

        const optimizeDescriptionBtn = document.createElement('button');
        optimizeDescriptionBtn.className = 'session-editor-optimize-description';
        optimizeDescriptionBtn.innerHTML = 'ğŸš€ æ™ºèƒ½ä¼˜åŒ–';
        optimizeDescriptionBtn.style.cssText = `
            padding: 12px 16px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        optimizeDescriptionBtn.addEventListener('mouseenter', () => {
            optimizeDescriptionBtn.style.background = '#45a049';
        });
        optimizeDescriptionBtn.addEventListener('mouseleave', () => {
            optimizeDescriptionBtn.style.background = '#4CAF50';
        });

        // ç¿»è¯‘ä¸­æ–‡æŒ‰é’®
        const translateDescriptionZhBtn = document.createElement('button');
        translateDescriptionZhBtn.className = 'session-editor-translate-description-zh';
        translateDescriptionZhBtn.setAttribute('data-translate-field', 'description');
        translateDescriptionZhBtn.setAttribute('data-target-lang', 'zh');
        translateDescriptionZhBtn.innerHTML = 'ğŸ‡¨ğŸ‡³ ç¿»è¯‘ä¸­æ–‡';
        translateDescriptionZhBtn.style.cssText = `
            padding: 12px 16px !important;
            background: #FF9800 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        translateDescriptionZhBtn.addEventListener('mouseenter', () => {
            translateDescriptionZhBtn.style.background = '#F57C00';
        });
        translateDescriptionZhBtn.addEventListener('mouseleave', () => {
            translateDescriptionZhBtn.style.background = '#FF9800';
        });

        // ç¿»è¯‘è‹±æ–‡æŒ‰é’®
        const translateDescriptionEnBtn = document.createElement('button');
        translateDescriptionEnBtn.className = 'session-editor-translate-description-en';
        translateDescriptionEnBtn.setAttribute('data-translate-field', 'description');
        translateDescriptionEnBtn.setAttribute('data-target-lang', 'en');
        translateDescriptionEnBtn.innerHTML = 'ğŸ‡ºğŸ‡¸ ç¿»è¯‘è‹±æ–‡';
        translateDescriptionEnBtn.style.cssText = `
            padding: 12px 16px !important;
            background: #9C27B0 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        translateDescriptionEnBtn.addEventListener('mouseenter', () => {
            translateDescriptionEnBtn.style.background = '#7B1FA2';
        });
        translateDescriptionEnBtn.addEventListener('mouseleave', () => {
            translateDescriptionEnBtn.style.background = '#9C27B0';
        });

        buttonContainer.appendChild(optimizeDescriptionBtn);
        buttonContainer.appendChild(generateDescriptionBtn);
        buttonContainer.appendChild(translateDescriptionZhBtn);
        buttonContainer.appendChild(translateDescriptionEnBtn);

        descriptionInputWrapper.appendChild(descriptionInput);
        descriptionInputWrapper.appendChild(buttonContainer);

        descriptionGroup.appendChild(descriptionLabel);
        descriptionGroup.appendChild(descriptionInputWrapper);

        // æ›´æ–°æ—¶é—´è¾“å…¥åŒºåŸŸ
        const updatedAtGroup = document.createElement('div');
        updatedAtGroup.style.cssText = `
            margin-bottom: 24px !important;
        `;

        const updatedAtLabel = document.createElement('label');
        updatedAtLabel.textContent = 'æ›´æ–°æ—¶é—´';
        updatedAtLabel.style.cssText = `
            display: block !important;
            margin-bottom: 10px !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
        `;

        const updatedAtInput = document.createElement('input');
        updatedAtInput.className = 'session-editor-updatedat-input';
        updatedAtInput.type = 'datetime-local';
        updatedAtInput.style.cssText = `
            width: 100% !important;
            padding: 12px 14px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 15px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
            box-sizing: border-box !important;
        `;
        
        updatedAtInput.addEventListener('focus', () => {
            updatedAtInput.style.borderColor = '#4CAF50';
        });
        updatedAtInput.addEventListener('blur', () => {
            updatedAtInput.style.borderColor = '#e0e0e0';
        });

        updatedAtGroup.appendChild(updatedAtLabel);
        updatedAtGroup.appendChild(updatedAtInput);

        // æŒ‰é’®åŒºåŸŸ
        const buttonGroup = document.createElement('div');
        buttonGroup.style.cssText = `
            display: flex !important;
            gap: 12px !important;
            justify-content: flex-end !important;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'session-editor-cancel';
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 12px 24px !important;
            background: #f5f5f5 !important;
            color: #333 !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#e0e0e0';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = '#f5f5f5';
        });

        const saveBtn = document.createElement('button');
        saveBtn.className = 'session-editor-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 12px 24px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#45a049';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#4CAF50';
        });

        buttonGroup.appendChild(cancelBtn);
        buttonGroup.appendChild(saveBtn);

        // ç»„è£…é¢æ¿
        panel.appendChild(header);
        panel.appendChild(titleGroup);
        panel.appendChild(descriptionGroup);
        panel.appendChild(updatedAtGroup);
        panel.appendChild(buttonGroup);

        // ç»„è£…æ¨¡æ€æ¡†
        modal.appendChild(panel);
        document.body.appendChild(modal);
    }

    // å…³é—­ä¼šè¯ä¿¡æ¯ç¼–è¾‘å¯¹è¯æ¡†
    closeSessionInfoEditor() {
        const modal = document.body.querySelector('#pet-session-info-editor');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // ä¿å­˜ä¼šè¯ä¿¡æ¯
    async saveSessionInfo(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ä¿å­˜ä¿¡æ¯:', sessionId);
            return;
        }

        const modal = document.body.querySelector('#pet-session-info-editor');
        if (!modal) {
            return;
        }

        const titleInput = modal.querySelector('.session-editor-title-input');
        const descriptionInput = modal.querySelector('.session-editor-description-input');
        const updatedAtInput = modal.querySelector('.session-editor-updatedat-input');
        
        if (!titleInput) {
            console.error('æ ‡é¢˜è¾“å…¥æ¡†æœªæ‰¾åˆ°');
            return;
        }

        const newTitle = titleInput.value.trim();
        const newDescription = descriptionInput ? descriptionInput.value.trim() : '';
        
        // è·å–æ›´æ–°çš„æ—¶é—´
        let newUpdatedAt = Date.now();
        if (updatedAtInput && updatedAtInput.value) {
            // å°† datetime-local æ ¼å¼è½¬æ¢ä¸ºæ—¶é—´æˆ³
            const dateValue = new Date(updatedAtInput.value);
            if (!isNaN(dateValue.getTime())) {
                newUpdatedAt = dateValue.getTime();
            }
        }

        // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œä¸è¿›è¡Œæ›´æ–°
        if (newTitle === '') {
            alert('ä¼šè¯æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
            titleInput.focus();
            return;
        }

        const session = this.sessions[sessionId];
        const originalTitle = session.pageTitle || 'æœªå‘½åä¼šè¯';
        const originalDescription = session.pageDescription || '';
        const originalUpdatedAt = session.updatedAt || Date.now();

        // å¦‚æœæ ‡é¢˜ã€æè¿°å’Œæ›´æ–°æ—¶é—´éƒ½æ²¡æœ‰å˜åŒ–ï¼Œä¸éœ€è¦æ›´æ–°
        if (newTitle === originalTitle && newDescription === originalDescription && newUpdatedAt === originalUpdatedAt) {
            this.closeSessionInfoEditor();
            return;
        }

        try {
            // æ›´æ–°ä¼šè¯ä¿¡æ¯
            session.pageTitle = newTitle;
            session.pageDescription = newDescription;
            session.updatedAt = newUpdatedAt;
            
            // ä¿å­˜ä¼šè¯åˆ°æœ¬åœ°
            await this.saveAllSessions(false, true);
            
            // æ›´æ–°UIæ˜¾ç¤º
            await this.updateSessionSidebar(true);
            
            // å¦‚æœè¿™æ˜¯å½“å‰ä¼šè¯ï¼ŒåŒæ—¶æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜å’Œç¬¬ä¸€æ¡æ¶ˆæ¯
            if (sessionId === this.currentSessionId) {
                this.updateChatHeaderTitle();
                // åˆ·æ–°ç¬¬ä¸€æ¡æ¬¢è¿æ¶ˆæ¯
                await this.refreshWelcomeMessage();
            }
            
            console.log('ä¼šè¯ä¿¡æ¯å·²æ›´æ–°:', { title: newTitle, description: newDescription });
            
            // å…³é—­å¯¹è¯æ¡†
            this.closeSessionInfoEditor();
        } catch (error) {
            console.error('æ›´æ–°ä¼šè¯ä¿¡æ¯å¤±è´¥:', error);
            alert('æ›´æ–°ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // è·å– OSS æ–‡ä»¶çš„è‡ªå®šä¹‰æ ‡é¢˜
    getOssFileTitle(fileName) {
        if (!fileName) return null;
        
        // ä»æœ¬åœ°å­˜å‚¨è·å–è‡ªå®šä¹‰æ ‡é¢˜
        const storageKey = 'petOssFileTitles';
        try {
            if (typeof chrome !== 'undefined' && chrome.storage) {
                // Chrome æ‰©å±•ç¯å¢ƒï¼Œä½¿ç”¨åŒæ­¥æ–¹å¼ï¼ˆè¿™é‡Œéœ€è¦å¼‚æ­¥ï¼Œä½†ä¸ºäº†ç®€åŒ–å…ˆåŒæ­¥è·å–ï¼‰
                // å®é™…åº”è¯¥ä½¿ç”¨å¼‚æ­¥æ–¹å¼ï¼Œä½†ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œå…ˆä½¿ç”¨ localStorage
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    const titles = JSON.parse(stored);
                    return titles[fileName] || null;
                }
            } else {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    const titles = JSON.parse(stored);
                    return titles[fileName] || null;
                }
            }
        } catch (error) {
            console.error('è·å–æ–‡ä»¶æ ‡é¢˜å¤±è´¥:', error);
        }
        return null;
    }
    
    // ä¿å­˜ OSS æ–‡ä»¶çš„è‡ªå®šä¹‰æ ‡é¢˜
    async saveOssFileTitle(fileName, title) {
        if (!fileName) return;
        
        const storageKey = 'petOssFileTitles';
        try {
            let titles = {};
            
            // ä»æœ¬åœ°å­˜å‚¨è¯»å–ç°æœ‰æ ‡é¢˜
            if (typeof chrome !== 'undefined' && chrome.storage) {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    titles = JSON.parse(stored);
                }
            } else {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    titles = JSON.parse(stored);
                }
            }
            
            // æ›´æ–°æ ‡é¢˜
            if (title && title.trim()) {
                titles[fileName] = title.trim();
            } else {
                // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œåˆ é™¤è¯¥æ–‡ä»¶çš„æ ‡é¢˜
                delete titles[fileName];
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            if (typeof chrome !== 'undefined' && chrome.storage) {
                localStorage.setItem(storageKey, JSON.stringify(titles));
            } else {
                localStorage.setItem(storageKey, JSON.stringify(titles));
            }
        } catch (error) {
            console.error('ä¿å­˜æ–‡ä»¶æ ‡é¢˜å¤±è´¥:', error);
        }
    }
    
    // è·å– OSS æ–‡ä»¶çš„è‡ªå®šä¹‰æè¿°
    getOssFileDescription(fileName) {
        if (!fileName) return null;
        
        // ä»æœ¬åœ°å­˜å‚¨è·å–è‡ªå®šä¹‰æè¿°
        const storageKey = 'petOssFileDescriptions';
        try {
            if (typeof chrome !== 'undefined' && chrome.storage) {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    const descriptions = JSON.parse(stored);
                    return descriptions[fileName] || null;
                }
            } else {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    const descriptions = JSON.parse(stored);
                    return descriptions[fileName] || null;
                }
            }
        } catch (error) {
            console.error('è·å–æ–‡ä»¶æè¿°å¤±è´¥:', error);
        }
        return null;
    }
    
    // ä¿å­˜ OSS æ–‡ä»¶çš„è‡ªå®šä¹‰æè¿°
    async saveOssFileDescription(fileName, description) {
        if (!fileName) return;
        
        const storageKey = 'petOssFileDescriptions';
        try {
            let descriptions = {};
            
            // ä»æœ¬åœ°å­˜å‚¨è¯»å–ç°æœ‰æè¿°
            if (typeof chrome !== 'undefined' && chrome.storage) {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    descriptions = JSON.parse(stored);
                }
            } else {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    descriptions = JSON.parse(stored);
                }
            }
            
            // æ›´æ–°æè¿°
            if (description && description.trim()) {
                descriptions[fileName] = description.trim();
            } else {
                // å¦‚æœæè¿°ä¸ºç©ºï¼Œåˆ é™¤è¯¥æ–‡ä»¶çš„æè¿°
                delete descriptions[fileName];
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            if (typeof chrome !== 'undefined' && chrome.storage) {
                localStorage.setItem(storageKey, JSON.stringify(descriptions));
            } else {
                localStorage.setItem(storageKey, JSON.stringify(descriptions));
            }
        } catch (error) {
            console.error('ä¿å­˜æ–‡ä»¶æè¿°å¤±è´¥:', error);
        }
    }
    
    // ç¼–è¾‘ OSS æ–‡ä»¶æ ‡é¢˜
    async editOssFileTitle(fileName) {
        if (!fileName) {
            console.warn('æ–‡ä»¶åæ— æ•ˆï¼Œæ— æ³•ç¼–è¾‘æ ‡é¢˜');
            return;
        }

        // è·å–å½“å‰æ ‡é¢˜å’Œæè¿°
        const currentTitle = this.getOssFileTitle(fileName) || fileName;
        const currentDescription = this.getOssFileDescription(fileName) || '';
        
        // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
        this.openOssFileTitleEditor(fileName, currentTitle, currentDescription);
    }
    
    // æ‰“å¼€ OSS æ–‡ä»¶æ ‡é¢˜ç¼–è¾‘å¯¹è¯æ¡†
    async openOssFileTitleEditor(fileName, originalTitle, originalDescription = '') {
        // ç¡®ä¿å¯¹è¯æ¡†UIå­˜åœ¨
        this.ensureOssFileTitleEditorUi();
        
        const modal = document.body.querySelector('#pet-oss-file-title-editor');
        if (!modal) {
            console.error('OSSæ–‡ä»¶æ ‡é¢˜ç¼–è¾‘å¯¹è¯æ¡†æœªæ‰¾åˆ°');
            return;
        }

        // æ˜¾ç¤ºå¯¹è¯æ¡†
        modal.style.display = 'flex';
        modal.dataset.fileName = fileName;

        // å¡«å……å½“å‰å€¼
        const titleInput = modal.querySelector('.oss-file-editor-title-input');
        const descriptionInput = modal.querySelector('.oss-file-editor-description-input');
        
        if (titleInput) {
            titleInput.value = originalTitle;
        }
        
        if (descriptionInput) {
            descriptionInput.value = originalDescription;
        }

        // åŠ è½½å½“å‰æ ‡ç­¾
        let currentTags = [];
        try {
            // å°è¯•ä»æ–‡ä»¶åˆ—è¡¨ä¸­è·å–æ ‡ç­¾
            const allFiles = this.ossFileManager?.getAllFiles() || [];
            const file = allFiles.find(f => f.name === fileName);
            if (file && file.tags && Array.isArray(file.tags)) {
                currentTags = [...file.tags];
            } else if (this.ossApi && this.ossApi.isEnabled()) {
                // å¦‚æœæ–‡ä»¶åˆ—è¡¨ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»åç«¯è·å–
                try {
                    currentTags = await this.ossApi.getFileTags(fileName);
                } catch (error) {
                    console.warn('è·å–æ–‡ä»¶æ ‡ç­¾å¤±è´¥:', error);
                    currentTags = [];
                }
            }
        } catch (error) {
            console.warn('åŠ è½½æ–‡ä»¶æ ‡ç­¾å¤±è´¥:', error);
            currentTags = [];
        }
        
        // ä¿å­˜æ ‡ç­¾åˆ°modalçš„ä¸´æ—¶æ•°æ®ä¸­
        modal._currentTags = [...currentTags];
        
        // åŠ è½½æ ‡ç­¾åˆ°ç®¡ç†å™¨
        this.loadOssFileTagsIntoManager(fileName, currentTags);

        // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
        if (titleInput) {
            setTimeout(() => {
                titleInput.focus();
                titleInput.select();
            }, 100);
        }

        // æ·»åŠ å…³é—­äº‹ä»¶
        const closeBtn = modal.querySelector('.oss-file-editor-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeOssFileTitleEditor();
        }

        // æ·»åŠ ä¿å­˜äº‹ä»¶
        const saveBtn = modal.querySelector('.oss-file-editor-save');
        if (saveBtn) {
            saveBtn.onclick = () => this.saveOssFileTitleInfo(fileName);
        }

        // æ·»åŠ å–æ¶ˆäº‹ä»¶
        const cancelBtn = modal.querySelector('.oss-file-editor-cancel');
        if (cancelBtn) {
            cancelBtn.onclick = () => this.closeOssFileTitleEditor();
        }

        // æ·»åŠ æ ‡ç­¾è¾“å…¥æ¡†å›è½¦äº‹ä»¶ï¼ˆå…¼å®¹ä¸­æ–‡è¾“å…¥æ³•ï¼‰
        const tagInput = modal.querySelector('.oss-file-editor-tag-input');
        if (tagInput) {
            // ç¡®ä¿è¾“å…¥æ³•ç»„åˆçŠ¶æ€å·²åˆå§‹åŒ–
            if (tagInput._isComposing === undefined) {
                tagInput._isComposing = false;
                tagInput.addEventListener('compositionstart', () => {
                    tagInput._isComposing = true;
                });
                tagInput.addEventListener('compositionend', () => {
                    tagInput._isComposing = false;
                });
            }
            
            // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†
            const existingHandler = tagInput._enterKeyHandler;
            if (existingHandler) {
                tagInput.removeEventListener('keydown', existingHandler);
            }
            
            const enterKeyHandler = (e) => {
                // å¦‚æœåœ¨è¾“å…¥æ³•ç»„åˆè¿‡ç¨‹ä¸­ï¼Œå¿½ç•¥å›è½¦é”®
                if (tagInput._isComposing) {
                    return;
                }
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addOssFileTagFromInput(fileName);
                }
            };
            
            tagInput._enterKeyHandler = enterKeyHandler;
            tagInput.addEventListener('keydown', enterKeyHandler);
        }

        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeOssFileTitleEditor();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // ç¡®ä¿ OSS æ–‡ä»¶æ ‡é¢˜ç¼–è¾‘å¯¹è¯æ¡†UIå­˜åœ¨
    ensureOssFileTitleEditorUi() {
        if (document.body.querySelector('#pet-oss-file-title-editor')) return;

        const modal = document.createElement('div');
        modal.id = 'pet-oss-file-title-editor';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 2147483653 !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeOssFileTitleEditor();
            }
        });

        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 32px !important;
            width: 90% !important;
            max-width: 800px !important;
            max-height: 85vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
            position: relative !important;
            z-index: 2147483654 !important;
        `;

        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 24px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ç¼–è¾‘æ–‡ä»¶ä¿¡æ¯';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 20px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'oss-file-editor-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });

        header.appendChild(title);
        header.appendChild(closeBtn);

        // æ ‡é¢˜è¾“å…¥åŒºåŸŸ
        const titleGroup = document.createElement('div');
        titleGroup.style.cssText = `
            margin-bottom: 24px !important;
        `;

        const titleLabel = document.createElement('label');
        titleLabel.textContent = 'æ–‡ä»¶æ ‡é¢˜';
        titleLabel.style.cssText = `
            display: block !important;
            margin-bottom: 10px !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
        `;

        const titleInput = document.createElement('input');
        titleInput.className = 'oss-file-editor-title-input';
        titleInput.type = 'text';
        titleInput.placeholder = 'è¯·è¾“å…¥æ–‡ä»¶æ ‡é¢˜';
        titleInput.style.cssText = `
            width: 100% !important;
            padding: 12px 14px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 15px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
            box-sizing: border-box !important;
        `;
        
        titleInput.addEventListener('focus', () => {
            titleInput.style.borderColor = '#4CAF50';
        });
        titleInput.addEventListener('blur', () => {
            titleInput.style.borderColor = '#e0e0e0';
        });
        
        // Enter é”®ä¿å­˜
        titleInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const fileName = modal.dataset.fileName;
                if (fileName) {
                    this.saveOssFileTitleInfo(fileName);
                }
            }
        });

        titleGroup.appendChild(titleLabel);
        titleGroup.appendChild(titleInput);

        // æè¿°è¾“å…¥åŒºåŸŸ
        const descriptionGroup = document.createElement('div');
        descriptionGroup.style.cssText = `
            margin-bottom: 24px !important;
        `;

        const descriptionLabel = document.createElement('label');
        descriptionLabel.textContent = 'æ–‡ä»¶æè¿°';
        descriptionLabel.style.cssText = `
            display: block !important;
            margin-bottom: 10px !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
        `;

        const descriptionInput = document.createElement('textarea');
        descriptionInput.className = 'oss-file-editor-description-input';
        descriptionInput.placeholder = 'è¯·è¾“å…¥æ–‡ä»¶æè¿°ï¼ˆå¯é€‰ï¼‰';
        descriptionInput.rows = 4;
        descriptionInput.style.cssText = `
            width: 100% !important;
            padding: 12px 14px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 15px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
            box-sizing: border-box !important;
            resize: vertical !important;
            font-family: inherit !important;
        `;
        
        descriptionInput.addEventListener('focus', () => {
            descriptionInput.style.borderColor = '#4CAF50';
        });
        descriptionInput.addEventListener('blur', () => {
            descriptionInput.style.borderColor = '#e0e0e0';
        });
        
        // Ctrl/Cmd + Enter ä¿å­˜
        descriptionInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const fileName = modal.dataset.fileName;
                if (fileName) {
                    this.saveOssFileTitleInfo(fileName);
                }
            }
        });

        descriptionGroup.appendChild(descriptionLabel);
        descriptionGroup.appendChild(descriptionInput);

        // æ ‡ç­¾ç®¡ç†åŒºåŸŸï¼ˆå‚è€ƒæ–°é—»åˆ—è¡¨çš„æ ‡ç­¾ç®¡ç†å™¨ï¼‰
        const tagGroup = document.createElement('div');
        tagGroup.style.cssText = `
            margin-bottom: 24px !important;
        `;

        const tagLabel = document.createElement('label');
        tagLabel.textContent = 'æ–‡ä»¶æ ‡ç­¾';
        tagLabel.style.cssText = `
            display: block !important;
            margin-bottom: 10px !important;
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #333 !important;
        `;

        // æ ‡ç­¾è¾“å…¥åŒºåŸŸ
        const tagInputGroup = document.createElement('div');
        tagInputGroup.className = 'oss-file-editor-tag-input-group';
        tagInputGroup.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            margin-bottom: 12px !important;
        `;

        const tagInput = document.createElement('input');
        tagInput.className = 'oss-file-editor-tag-input';
        tagInput.type = 'text';
        tagInput.placeholder = 'è¾“å…¥æ ‡ç­¾åç§°ï¼ŒæŒ‰å›è½¦æ·»åŠ ';
        tagInput.style.cssText = `
            flex: 1 !important;
            padding: 10px 12px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
        `;
        
        tagInput.addEventListener('focus', () => {
            tagInput.style.borderColor = '#4CAF50';
        });
        tagInput.addEventListener('blur', () => {
            tagInput.style.borderColor = '#e0e0e0';
        });

        const addTagBtn = document.createElement('button');
        addTagBtn.textContent = 'æ·»åŠ ';
        addTagBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        addTagBtn.addEventListener('mouseenter', () => {
            addTagBtn.style.background = '#45a049';
        });
        addTagBtn.addEventListener('mouseleave', () => {
            addTagBtn.style.background = '#4CAF50';
        });
        addTagBtn.addEventListener('click', () => {
            const fileName = modal.dataset.fileName;
            if (fileName) {
                this.addOssFileTagFromInput(fileName);
            }
        });

        // æ™ºèƒ½ç”Ÿæˆæ ‡ç­¾æŒ‰é’®
        const smartGenerateBtn = document.createElement('button');
        smartGenerateBtn.className = 'oss-file-editor-smart-generate';
        smartGenerateBtn.textContent = 'âœ¨ æ™ºèƒ½ç”Ÿæˆ';
        smartGenerateBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #9C27B0 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        smartGenerateBtn.addEventListener('mouseenter', () => {
            if (!smartGenerateBtn.disabled) {
                smartGenerateBtn.style.background = '#7B1FA2';
            }
        });
        smartGenerateBtn.addEventListener('mouseleave', () => {
            if (!smartGenerateBtn.disabled) {
                smartGenerateBtn.style.background = '#9C27B0';
            }
        });
        smartGenerateBtn.addEventListener('click', () => {
            const fileName = modal.dataset.fileName;
            if (fileName) {
                this.generateOssFileSmartTags(fileName, smartGenerateBtn);
            }
        });

        tagInputGroup.appendChild(tagInput);
        tagInputGroup.appendChild(addTagBtn);
        tagInputGroup.appendChild(smartGenerateBtn);

        // å¿«æ·æ ‡ç­¾æŒ‰é’®å®¹å™¨
        const quickTagsContainer = document.createElement('div');
        quickTagsContainer.className = 'oss-file-editor-quick-tags';
        quickTagsContainer.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 8px !important;
            margin-bottom: 12px !important;
        `;

        // å¿«æ·æ ‡ç­¾åˆ—è¡¨ï¼ˆä¸æ–°é—»åˆ—è¡¨ä¿æŒä¸€è‡´ï¼‰
        const quickTags = ['å·¥å…·', 'å¼€æºé¡¹ç›®', 'å®¶åº­', 'å·¥ä½œ', 'å¨±ä¹', 'æ–‡æ¡£', 'ç½‘æ–‡', 'æ—¥è®°'];
        
        quickTags.forEach(tagName => {
            const quickTagBtn = document.createElement('button');
            quickTagBtn.textContent = tagName;
            quickTagBtn.className = 'oss-file-editor-quick-tag-btn';
            quickTagBtn.dataset.tagName = tagName;
            quickTagBtn.style.cssText = `
                padding: 6px 12px !important;
                background: #f0f0f0 !important;
                color: #333 !important;
                border: 1px solid #d0d0d0 !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 13px !important;
                transition: all 0.2s ease !important;
            `;
            quickTagBtn.addEventListener('mouseenter', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ”¹å˜æ ·å¼
                if (quickTagBtn.style.background === 'rgb(76, 175, 80)') {
                    return;
                }
                quickTagBtn.style.background = '#e0e0e0';
                quickTagBtn.style.borderColor = '#4CAF50';
            });
            quickTagBtn.addEventListener('mouseleave', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ”¹å˜æ ·å¼
                if (quickTagBtn.style.background === 'rgb(76, 175, 80)') {
                    return;
                }
                quickTagBtn.style.background = '#f0f0f0';
                quickTagBtn.style.borderColor = '#d0d0d0';
            });
            quickTagBtn.addEventListener('click', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ‰§è¡Œæ“ä½œ
                if (quickTagBtn.style.cursor === 'not-allowed') {
                    return;
                }
                const fileName = modal.dataset.fileName;
                if (fileName) {
                    this.addOssFileQuickTag(fileName, tagName);
                }
            });
            quickTagsContainer.appendChild(quickTagBtn);
        });

        // æ ‡ç­¾åˆ—è¡¨å®¹å™¨
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'oss-file-editor-tags';
        tagsContainer.style.cssText = `
            min-height: 60px !important;
            max-height: 200px !important;
            overflow-y: auto !important;
            padding: 12px !important;
            background: #f8f9fa !important;
            border-radius: 6px !important;
        `;

        tagGroup.appendChild(tagLabel);
        tagGroup.appendChild(tagInputGroup);
        tagGroup.appendChild(quickTagsContainer);
        tagGroup.appendChild(tagsContainer);

        // æŒ‰é’®åŒºåŸŸ
        const buttonGroup = document.createElement('div');
        buttonGroup.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 12px !important;
            margin-top: 24px !important;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'oss-file-editor-cancel';
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #f5f5f5 !important;
            color: #333 !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#e0e0e0';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = '#f5f5f5';
        });

        const saveBtn = document.createElement('button');
        saveBtn.className = 'oss-file-editor-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#45a049';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#4CAF50';
        });

        buttonGroup.appendChild(cancelBtn);
        buttonGroup.appendChild(saveBtn);

        panel.appendChild(header);
        panel.appendChild(titleGroup);
        panel.appendChild(descriptionGroup);
        panel.appendChild(tagGroup);
        panel.appendChild(buttonGroup);
        modal.appendChild(panel);
        document.body.appendChild(modal);
    }
    
    // å…³é—­ OSS æ–‡ä»¶æ ‡é¢˜ç¼–è¾‘å¯¹è¯æ¡†
    closeOssFileTitleEditor() {
        const modal = document.body.querySelector('#pet-oss-file-title-editor');
        if (modal) {
            modal.style.display = 'none';
            // æ¸…ç©ºä¸´æ—¶æ ‡ç­¾æ•°æ®
            modal._currentTags = [];
        }
    }
    
    // åŠ è½½OSSæ–‡ä»¶æ ‡ç­¾åˆ°ç®¡ç†å™¨
    loadOssFileTagsIntoManager(fileName, tags) {
        const modal = document.body.querySelector('#pet-oss-file-title-editor');
        if (!modal) return;

        const tagsContainer = modal.querySelector('.oss-file-editor-tags');
        if (!tagsContainer) return;

        tagsContainer.innerHTML = '';

        if (!tags || tags.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #999 !important;
                padding: 20px !important;
                font-size: 14px !important;
            `;
            tagsContainer.appendChild(emptyMsg);
            return;
        }

        tags.forEach((tag, tagIndex) => {
            const tagItem = document.createElement('div');
            tagItem.style.cssText = `
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                background: #4CAF50 !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 20px !important;
                margin: 4px !important;
                font-size: 13px !important;
            `;

            const tagText = document.createElement('span');
            tagText.textContent = tag;

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = 'âœ•';
            removeBtn.style.cssText = `
                background: rgba(255, 255, 255, 0.3) !important;
                border: none !important;
                color: white !important;
                width: 18px !important;
                height: 18px !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                font-size: 12px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 0 !important;
                transition: background 0.2s ease !important;
            `;
            removeBtn.addEventListener('mouseenter', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.5)';
            });
            removeBtn.addEventListener('mouseleave', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            });
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.removeOssFileTagByValue(fileName, tag);
            });

            tagItem.appendChild(tagText);
            tagItem.appendChild(removeBtn);
            tagsContainer.appendChild(tagItem);
        });

        // æ›´æ–°å¿«æ·æ ‡ç­¾æŒ‰é’®çŠ¶æ€
        const quickTagButtons = modal.querySelectorAll('.oss-file-editor-quick-tag-btn');
        quickTagButtons.forEach(btn => {
            const tagName = btn.dataset.tagName;
            const isAdded = tags && tags.includes(tagName);
            if (isAdded) {
                btn.style.background = '#4CAF50';
                btn.style.color = 'white';
                btn.style.borderColor = '#4CAF50';
                btn.style.opacity = '0.7';
                btn.style.cursor = 'not-allowed';
            } else {
                btn.style.background = '#f0f0f0';
                btn.style.color = '#333';
                btn.style.borderColor = '#d0d0d0';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    }

    // ä»è¾“å…¥æ¡†æ·»åŠ OSSæ–‡ä»¶æ ‡ç­¾
    addOssFileTagFromInput(fileName) {
        const modal = document.body.querySelector('#pet-oss-file-title-editor');
        if (!modal) return;

        const tagInput = modal.querySelector('.oss-file-editor-tag-input');
        if (!tagInput) return;

        const tagName = tagInput.value.trim();
        if (!tagName) return;

        // è·å–å½“å‰æ ‡ç­¾åˆ—è¡¨
        if (!modal._currentTags) {
            modal._currentTags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (modal._currentTags.includes(tagName)) {
            tagInput.value = '';
            tagInput.focus();
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        modal._currentTags.push(tagName);
        tagInput.value = '';
        tagInput.focus();

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadOssFileTagsIntoManager(fileName, modal._currentTags);
    }

    // æ·»åŠ OSSæ–‡ä»¶å¿«æ·æ ‡ç­¾
    addOssFileQuickTag(fileName, tagName) {
        const modal = document.body.querySelector('#pet-oss-file-title-editor');
        if (!modal) return;

        if (!modal._currentTags) {
            modal._currentTags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (modal._currentTags.includes(tagName)) {
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        modal._currentTags.push(tagName);

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadOssFileTagsIntoManager(fileName, modal._currentTags);
    }

    // åˆ é™¤OSSæ–‡ä»¶æ ‡ç­¾ï¼ˆæ ¹æ®æ ‡ç­¾å€¼ï¼‰
    removeOssFileTagByValue(fileName, tagValue) {
        const modal = document.body.querySelector('#pet-oss-file-title-editor');
        if (!modal || !modal._currentTags) return;

        const tagIndex = modal._currentTags.indexOf(tagValue);
        if (tagIndex >= 0) {
            modal._currentTags.splice(tagIndex, 1);
            this.loadOssFileTagsIntoManager(fileName, modal._currentTags);
        }
    }

    // æ™ºèƒ½ç”ŸæˆOSSæ–‡ä»¶æ ‡ç­¾
    async generateOssFileSmartTags(fileName, buttonElement) {
        if (!fileName) {
            console.warn('æ–‡ä»¶åæ— æ•ˆï¼Œæ— æ³•ç”Ÿæˆæ ‡ç­¾');
            return;
        }

        const modal = document.body.querySelector('#pet-oss-file-title-editor');
        if (!modal) {
            console.error('OSSæ–‡ä»¶ç¼–è¾‘å¯¹è¯æ¡†æœªæ‰¾åˆ°');
            return;
        }

        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.style.background = '#ccc';
            buttonElement.style.cursor = 'not-allowed';
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // è·å–æ–‡ä»¶ä¿¡æ¯
                const titleInput = modal.querySelector('.oss-file-editor-title-input');
                const descriptionInput = modal.querySelector('.oss-file-editor-description-input');
                const fileTitle = titleInput ? titleInput.value.trim() : fileName;
                const fileDescription = descriptionInput ? descriptionInput.value.trim() : '';
                
                // æ„å»ºæç¤ºè¯
                const prompt = `è¯·æ ¹æ®ä»¥ä¸‹æ–‡ä»¶ä¿¡æ¯ï¼Œç”Ÿæˆ3-5ä¸ªåˆé€‚çš„æ ‡ç­¾ï¼ˆç”¨ä¸­æ–‡ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¸è¦åŒ…å«"æ ‡ç­¾"ã€"åˆ†ç±»"ç­‰è¯ï¼‰ï¼š
æ–‡ä»¶åï¼š${fileName}
æ ‡é¢˜ï¼š${fileTitle}
æè¿°ï¼š${fileDescription}`;

                // ä½¿ç”¨ç®€å•çš„å…³é”®è¯æå–ï¼ˆæ™ºèƒ½ç”ŸæˆåŠŸèƒ½å¯ä»¥åç»­æ‰©å±•ï¼‰
                const keywords = this.extractKeywordsFromOssFile(fileName, fileTitle, fileDescription);
                if (keywords.length > 0) {
                    if (!modal._currentTags) {
                        modal._currentTags = [];
                    }
                    keywords.forEach(tag => {
                        if (!modal._currentTags.includes(tag)) {
                            modal._currentTags.push(tag);
                        }
                    });
                    this.loadOssFileTagsIntoManager(fileName, modal._currentTags);
                    this.showNotification('å·²æ·»åŠ å…³é”®è¯æ ‡ç­¾', 'success');
                } else {
                    this.showNotification('æ— æ³•æå–å…³é”®è¯', 'info');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæ ‡ç­¾å¤±è´¥:', error);
                this.showNotification('ç”Ÿæˆæ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            } finally {
                buttonElement.disabled = false;
                buttonElement.style.background = '#9C27B0';
                buttonElement.style.cursor = 'pointer';
                buttonElement.textContent = originalText;
            }
        }
    }

    // ä»OSSæ–‡ä»¶ä¿¡æ¯ä¸­æå–å…³é”®è¯ï¼ˆç®€å•å®ç°ï¼‰
    extractKeywordsFromOssFile(fileName, title, description) {
        const text = `${fileName} ${title || ''} ${description || ''}`;
        // ç®€å•çš„å…³é”®è¯æå–é€»è¾‘ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›ï¼‰
        const keywords = [];
        const commonTags = ['å·¥å…·', 'å¼€æºé¡¹ç›®', 'å®¶åº­', 'å·¥ä½œ', 'å¨±ä¹', 'æ–‡æ¡£', 'ç½‘æ–‡', 'æ—¥è®°', 'æŠ€æœ¯', 'å›¾ç‰‡', 'è§†é¢‘', 'éŸ³é¢‘', 'æ•°æ®'];
        commonTags.forEach(tag => {
            if (text.includes(tag)) {
                keywords.push(tag);
            }
        });
        return keywords.slice(0, 3); // æœ€å¤šè¿”å›3ä¸ªå…³é”®è¯
    }
    
    // ä¿å­˜ OSS æ–‡ä»¶æ ‡é¢˜ä¿¡æ¯
    async saveOssFileTitleInfo(fileName) {
        if (!fileName) {
            console.warn('æ–‡ä»¶åæ— æ•ˆï¼Œæ— æ³•ä¿å­˜æ ‡é¢˜');
            return;
        }

        const modal = document.body.querySelector('#pet-oss-file-title-editor');
        if (!modal) {
            return;
        }

        const titleInput = modal.querySelector('.oss-file-editor-title-input');
        const descriptionInput = modal.querySelector('.oss-file-editor-description-input');
        
        if (!titleInput) {
            console.error('æ ‡é¢˜è¾“å…¥æ¡†æœªæ‰¾åˆ°');
            return;
        }

        const newTitle = titleInput.value.trim();
        const newDescription = descriptionInput ? descriptionInput.value.trim() : '';
        
        // è·å–æ ‡ç­¾ï¼ˆè§„èŒƒåŒ–å¤„ç†ï¼‰
        let tags = [];
        if (modal._currentTags && Array.isArray(modal._currentTags)) {
            tags = modal._currentTags
                .map(tag => tag ? tag.trim() : '')
                .filter(tag => tag.length > 0);
            // å»é‡
            tags = [...new Set(tags)];
        }
        
        // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œä½¿ç”¨åŸæ–‡ä»¶å
        const finalTitle = newTitle || fileName;

        // è·å–åŸå§‹æ–‡ä»¶åï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        const originalFileName = fileName;

        try {
            // ä¿å­˜æ ‡é¢˜åˆ°æœ¬åœ°å­˜å‚¨
            await this.saveOssFileTitle(fileName, finalTitle === originalFileName ? '' : finalTitle);
            
            // ä¿å­˜æè¿°åˆ°æœ¬åœ°å­˜å‚¨
            await this.saveOssFileDescription(fileName, newDescription);
            
            // ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°åç«¯ï¼ˆåŒ…æ‹¬æ ‡ç­¾ï¼‰
            if (this.ossApi && this.ossApi.isEnabled()) {
                try {
                    await this.ossApi.updateFileInfo(fileName, {
                        title: finalTitle === originalFileName ? '' : finalTitle,
                        description: newDescription,
                        tags: tags
                    });
                    console.log('æ–‡ä»¶ä¿¡æ¯å·²ä¿å­˜åˆ°åç«¯:', { fileName, title: finalTitle, description: newDescription, tags: tags });
                    
                    // åŒæ—¶æ›´æ–°æ–‡ä»¶åˆ—è¡¨ä¸­çš„æ ‡ç­¾
                    if (this.ossFileManager) {
                        const allFiles = this.ossFileManager.getAllFiles();
                        const fileIndex = allFiles.findIndex(f => f.name === fileName);
                        if (fileIndex >= 0) {
                            allFiles[fileIndex].tags = tags;
                        }
                    }
                } catch (error) {
                    console.warn('ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°åç«¯å¤±è´¥:', error);
                    // ä¸é˜»å¡åç»­æ“ä½œï¼Œç»§ç»­æ›´æ–°ä¼šè¯
                }
            }
            
            // æ‰¾åˆ°æ‰€æœ‰ä¸è¯¥æ–‡ä»¶å…³è”çš„ä¼šè¯å¹¶æ›´æ–°
            const matchedSessionIds = this._findSessionsByOssFile(fileName);
            const updatedSessionIds = [];
            
            for (const sessionId of matchedSessionIds) {
                const session = this.sessions[sessionId];
                if (session) {
                    // æ›´æ–°ä¼šè¯çš„æ ‡é¢˜å’Œæè¿°
                    session.pageTitle = finalTitle;
                    session.pageDescription = newDescription;
                    
                    // æ›´æ–° OSS æ–‡ä»¶ä¿¡æ¯
                    if (session._ossFileInfo) {
                        session._ossFileInfo.name = finalTitle;
                        session._ossFileInfo.description = newDescription;
                        session._ossFileInfo.tags = tags;
                    }
                    
                    // æ›´æ–°ä¼šè¯çš„æ ‡ç­¾
                    session.tags = tags;
                    
                    // æ›´æ–°ä¼šè¯æ—¶é—´æˆ³
                    session.updatedAt = Date.now();
                    
                    updatedSessionIds.push(sessionId);
                    console.log('å·²æ›´æ–°å…³è”ä¼šè¯:', sessionId, { title: finalTitle, description: newDescription });
                }
            }
            
            // ä¿å­˜æ‰€æœ‰æ›´æ–°çš„ä¼šè¯
            if (updatedSessionIds.length > 0) {
                // ä¿å­˜åˆ°æœ¬åœ°
                await this.saveAllSessions(false, false);
                
                // åŒæ­¥åˆ°åç«¯ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
                for (const sessionId of updatedSessionIds) {
                    this.syncSessionToBackend(sessionId, false).catch(err => {
                        console.warn('åŒæ­¥ä¼šè¯åˆ°åç«¯å¤±è´¥:', sessionId, err);
                    });
                }
                
                // å¦‚æœå½“å‰ä¼šè¯æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œæ›´æ–°UIæ˜¾ç¤º
                if (updatedSessionIds.includes(this.currentSessionId)) {
                    // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜
                    this.updateChatHeaderTitle();
                    
                    // é‡æ–°æ¸²æŸ“æ¬¢è¿æ¶ˆæ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const messagesContainer = this.chatWindow?.querySelector('.pet-messages') || 
                                            this.chatWindow?.querySelector('#pet-chat-messages');
                    if (messagesContainer) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ¬¢è¿æ¶ˆæ¯ï¼ˆæ”¯æŒä¸¤ç§é€‰æ‹©å™¨ï¼‰
                        const welcomeMessage = messagesContainer.querySelector('.pet-welcome-message') ||
                                              messagesContainer.querySelector('[data-welcome-message]');
                        if (welcomeMessage) {
                            // åˆ é™¤æ—§çš„æ¬¢è¿æ¶ˆæ¯
                            welcomeMessage.remove();
                            
                            // é‡æ–°åˆ›å»ºæ¬¢è¿æ¶ˆæ¯
                            const session = this.sessions[this.currentSessionId];
                            if (session && session._isOssFileSession && session._ossFileInfo) {
                                // åˆ›å»ºæ–°çš„æ¬¢è¿æ¶ˆæ¯
                                const newWelcomeMessage = await this.createOssFileWelcomeMessage(messagesContainer, session._ossFileInfo);
                                
                                // ç¡®ä¿æ¬¢è¿æ¶ˆæ¯åœ¨å¼€å¤´ï¼ˆå¦‚æœæ¶ˆæ¯å®¹å™¨ä¸­æœ‰å…¶ä»–æ¶ˆæ¯ï¼‰
                                if (newWelcomeMessage && messagesContainer.firstChild !== newWelcomeMessage) {
                                    messagesContainer.insertBefore(newWelcomeMessage, messagesContainer.firstChild);
                                }
                            }
                        }
                    }
                    
                    // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
                    await this.updateSessionSidebar();
                }
            }
            
            // æ›´æ–°UIæ˜¾ç¤º
            await this.updateOssFileSidebar(true);
            
            console.log('æ–‡ä»¶ä¿¡æ¯å·²æ›´æ–°:', { fileName, title: finalTitle, description: newDescription, tags: tags, updatedSessions: updatedSessionIds.length });
            
            // å…³é—­å¯¹è¯æ¡†
            this.closeOssFileTitleEditor();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            this.showNotification('æ–‡ä»¶ä¿¡æ¯å·²æ›´æ–°', 'success');
        } catch (error) {
            console.error('æ›´æ–°æ–‡ä»¶ä¿¡æ¯å¤±è´¥:', error);
            alert('æ›´æ–°ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // è·å–æŒ‡å®šä¼šè¯çš„ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«æ¶ˆæ¯å†å²å’Œé¡µé¢å†…å®¹ï¼‰
    getSessionContext(sessionId) {
        const context = {
            messages: [],
            pageContent: '',
            pageTitle: '',
            pageDescription: '',
            url: '',
            hasHistory: false
        };

        if (!sessionId || !this.sessions[sessionId]) {
            return context;
        }

        const session = this.sessions[sessionId];
        
        // è·å–æ¶ˆæ¯å†å²ï¼ˆæ’é™¤æ¬¢è¿æ¶ˆæ¯å’ŒæŒ‰é’®æ“ä½œç”Ÿæˆçš„æ¶ˆæ¯ï¼‰
        if (session.messages && Array.isArray(session.messages) && session.messages.length > 0) {
            context.messages = session.messages.filter(msg => {
                // åªåŒ…å«ç”¨æˆ·æ¶ˆæ¯å’Œå® ç‰©æ¶ˆæ¯ï¼Œæ’é™¤æŒ‰é’®æ“ä½œç”Ÿæˆçš„æ¶ˆæ¯
                return msg.type === 'user' || msg.type === 'pet';
            });
            context.hasHistory = context.messages.length > 0;
        }
        
        // è·å–é¡µé¢ä¿¡æ¯
        if (session.pageContent && session.pageContent.trim()) {
            context.pageContent = session.pageContent.trim();
        }
        if (session.pageTitle) {
            context.pageTitle = session.pageTitle;
        }
        if (session.pageDescription) {
            context.pageDescription = session.pageDescription;
        }
        if (session.url) {
            context.url = session.url;
        }

        return context;
    }

    // æ™ºèƒ½ç”Ÿæˆä¼šè¯æ ‡é¢˜
    async generateSessionTitle(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæ ‡é¢˜:', sessionId);
            return;
        }

        const modal = document.body.querySelector('#pet-session-info-editor');
        if (!modal) {
            return;
        }

        const generateBtn = modal.querySelector('.session-editor-generate-title');
        const titleInput = modal.querySelector('.session-editor-title-input');
        
        if (!generateBtn || !titleInput) {
            return;
        }

        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        const originalText = generateBtn.innerHTML;
        generateBtn.disabled = true;
        generateBtn.innerHTML = 'ç”Ÿæˆä¸­...';
        generateBtn.style.opacity = '0.6';
        generateBtn.style.cursor = 'not-allowed';

        try {
            // è·å–ä¼šè¯ä¸Šä¸‹æ–‡
            const context = this.getSessionContext(sessionId);
            
            // æ„å»ºç”Ÿæˆæ ‡é¢˜çš„ prompt
            let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŠ©æ‰‹ï¼Œæ“…é•¿æ ¹æ®ä¼šè¯å†…å®¹ç”Ÿæˆç®€æ´ã€å‡†ç¡®çš„æ ‡é¢˜ã€‚';
            let userPrompt = 'è¯·æ ¹æ®ä»¥ä¸‹ä¼šè¯å†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªç®€æ´ã€å‡†ç¡®çš„æ ‡é¢˜ï¼ˆä¸è¶…è¿‡20ä¸ªå­—ï¼‰ï¼š\n\n';

            // æ·»åŠ é¡µé¢ä¿¡æ¯
            if (context.pageTitle) {
                userPrompt += `é¡µé¢æ ‡é¢˜ï¼š${context.pageTitle}\n`;
            }
            if (context.url) {
                userPrompt += `é¡µé¢URLï¼š${context.url}\n`;
            }

            // æ·»åŠ æ¶ˆæ¯å†å²
            if (context.messages.length > 0) {
                userPrompt += '\nä¼šè¯å†…å®¹ï¼š\n';
                context.messages.slice(0, 10).forEach((msg, index) => {
                    const role = msg.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                    const content = msg.content.trim();
                    if (content) {
                        userPrompt += `${role}ï¼š${content.substring(0, 200)}\n`;
                    }
                });
            } else if (context.pageContent) {
                // å¦‚æœæ²¡æœ‰æ¶ˆæ¯å†å²ï¼Œä½¿ç”¨é¡µé¢å†…å®¹
                userPrompt += '\né¡µé¢å†…å®¹æ‘˜è¦ï¼š\n';
                userPrompt += context.pageContent.substring(0, 500);
            }

            userPrompt += '\n\nè¯·ç›´æ¥è¿”å›æ ‡é¢˜ï¼Œä¸è¦åŒ…å«å…¶ä»–è¯´æ˜æ–‡å­—ã€‚';

            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );

            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // å…ˆè·å–å“åº”æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ SSE æ ¼å¼
            const responseText = await response.text();
            let result;
            
            try {
                // æ£€æŸ¥æ˜¯å¦åŒ…å« SSE æ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                if (responseText.includes('data: ')) {
                    // å¤„ç† SSE æ ¼å¼å“åº”
                    const lines = responseText.split('\n');
                    let accumulatedData = '';
                    let lastValidData = null;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr === '[DONE]' || dataStr === '') {
                                    continue;
                                }
                                
                                // å°è¯•è§£æ JSON
                                const chunk = JSON.parse(dataStr);
                                
                                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                if (chunk.done === true) {
                                    break;
                                }
                                
                                // ç´¯ç§¯å†…å®¹
                                if (chunk.content) {
                                    accumulatedData += chunk.content;
                                    lastValidData = chunk;
                                } else if (chunk.data) {
                                    accumulatedData += (typeof chunk.data === 'string' ? chunk.data : chunk.data.content || '');
                                    lastValidData = chunk;
                                } else if (chunk.message && chunk.message.content) {
                                    accumulatedData += chunk.message.content;
                                    lastValidData = chunk;
                                }
                            } catch (e) {
                                console.warn('è§£æ SSE æ•°æ®å—å¤±è´¥:', trimmedLine, e);
                            }
                        }
                    }
                    
                    // å¦‚æœæœ‰ç´¯ç§¯çš„å†…å®¹ï¼Œä½¿ç”¨å®ƒ
                    if (accumulatedData) {
                        result = { content: accumulatedData, data: accumulatedData };
                    } else if (lastValidData) {
                        result = lastValidData;
                    } else {
                        // å°è¯•ä»æœ€åä¸€è¡Œæå– JSON
                        const sseMatch = responseText.match(/data:\s*({.+?})/s);
                        if (sseMatch) {
                            result = JSON.parse(sseMatch[1]);
                        } else {
                            throw new Error('æ— æ³•è§£æ SSE å“åº”');
                        }
                    }
                } else {
                    // æ™®é€š JSON å“åº”
                    result = JSON.parse(responseText);
                }
            } catch (parseError) {
                console.error('è§£æå“åº”å¤±è´¥:', parseError, 'å“åº”å†…å®¹:', responseText.substring(0, 200));
                throw new Error('è§£æå“åº”å¤±è´¥: ' + parseError.message);
            }
            
            // æå–ç”Ÿæˆçš„æ ‡é¢˜ï¼ˆé€‚é…ä¸åŒçš„å“åº”æ ¼å¼ï¼‰
            let generatedTitle = '';
            if (result.status === 200 && result.data) {
                // æˆåŠŸå“åº”ï¼Œæå– data å­—æ®µ
                generatedTitle = typeof result.data === 'string' ? result.data.trim() : (result.data.content || '').trim();
            } else if (result && result.content) {
                generatedTitle = result.content.trim();
            } else if (result && result.data && result.data.content) {
                generatedTitle = result.data.content.trim();
            } else if (result && result.message) {
                generatedTitle = result.message.trim();
            } else if (typeof result === 'string') {
                generatedTitle = result.trim();
            }

            // æ¸…ç†æ ‡é¢˜ï¼ˆç§»é™¤å¯èƒ½çš„å¼•å·ã€æ¢è¡Œç­‰ï¼‰
            generatedTitle = generatedTitle.replace(/^["']|["']$/g, '').replace(/\n/g, ' ').trim();
            
            // é™åˆ¶é•¿åº¦
            if (generatedTitle.length > 50) {
                generatedTitle = generatedTitle.substring(0, 50);
            }

            if (generatedTitle) {
                titleInput.value = generatedTitle;
                titleInput.focus();
            } else {
                alert('ç”Ÿæˆæ ‡é¢˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('ç”Ÿæˆæ ‡é¢˜å¤±è´¥:', error);
            alert('ç”Ÿæˆæ ‡é¢˜å¤±è´¥ï¼š' + error.message);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
            generateBtn.style.opacity = '1';
            generateBtn.style.cursor = 'pointer';
        }
    }

    // æ™ºèƒ½ç”Ÿæˆä¼šè¯æè¿°
    async generateSessionDescription(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæè¿°:', sessionId);
            return;
        }

        const modal = document.body.querySelector('#pet-session-info-editor');
        if (!modal) {
            return;
        }

        const generateBtn = modal.querySelector('.session-editor-generate-description');
        const descriptionInput = modal.querySelector('.session-editor-description-input');
        
        if (!generateBtn || !descriptionInput) {
            return;
        }

        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        const originalText = generateBtn.innerHTML;
        generateBtn.disabled = true;
        generateBtn.innerHTML = 'ç”Ÿæˆä¸­...';
        generateBtn.style.opacity = '0.6';
        generateBtn.style.cursor = 'not-allowed';

        try {
            // è·å–ä¼šè¯ä¸Šä¸‹æ–‡
            const context = this.getSessionContext(sessionId);
            
            // æ„å»ºç”Ÿæˆæè¿°çš„ prompt
            let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŠ©æ‰‹ï¼Œæ“…é•¿æ ¹æ®ä¼šè¯å†…å®¹ç”Ÿæˆç®€æ´ã€å‡†ç¡®çš„ç½‘é¡µæè¿°ã€‚';
            let userPrompt = 'è¯·æ ¹æ®ä»¥ä¸‹ä¼šè¯å†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªç®€æ´ã€å‡†ç¡®çš„ç½‘é¡µæè¿°ï¼ˆ50-200å­—ï¼‰ï¼š\n\n';

            // æ·»åŠ é¡µé¢ä¿¡æ¯
            if (context.pageTitle) {
                userPrompt += `é¡µé¢æ ‡é¢˜ï¼š${context.pageTitle}\n`;
            }
            if (context.url) {
                userPrompt += `é¡µé¢URLï¼š${context.url}\n`;
            }

            // æ·»åŠ æ¶ˆæ¯å†å²
            if (context.messages.length > 0) {
                userPrompt += '\nä¼šè¯å†…å®¹ï¼š\n';
                context.messages.slice(0, 15).forEach((msg, index) => {
                    const role = msg.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                    const content = msg.content.trim();
                    if (content) {
                        userPrompt += `${role}ï¼š${content.substring(0, 300)}\n`;
                    }
                });
            } else if (context.pageContent) {
                // å¦‚æœæ²¡æœ‰æ¶ˆæ¯å†å²ï¼Œä½¿ç”¨é¡µé¢å†…å®¹
                userPrompt += '\né¡µé¢å†…å®¹æ‘˜è¦ï¼š\n';
                userPrompt += context.pageContent.substring(0, 1000);
            }

            userPrompt += '\n\nè¯·ç›´æ¥è¿”å›æè¿°ï¼Œä¸è¦åŒ…å«å…¶ä»–è¯´æ˜æ–‡å­—ã€‚æè¿°åº”è¯¥ç®€æ´æ˜äº†ï¼Œæ¦‚æ‹¬ä¼šè¯æˆ–é¡µé¢çš„ä¸»è¦å†…å®¹ã€‚';

            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );

            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // å…ˆè·å–å“åº”æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ SSE æ ¼å¼
            const responseText = await response.text();
            let result;
            
            try {
                // æ£€æŸ¥æ˜¯å¦åŒ…å« SSE æ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                if (responseText.includes('data: ')) {
                    // å¤„ç† SSE æ ¼å¼å“åº”
                    const lines = responseText.split('\n');
                    let accumulatedData = '';
                    let lastValidData = null;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr === '[DONE]' || dataStr === '') {
                                    continue;
                                }
                                
                                // å°è¯•è§£æ JSON
                                const chunk = JSON.parse(dataStr);
                                
                                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                if (chunk.done === true) {
                                    break;
                                }
                                
                                // ç´¯ç§¯å†…å®¹
                                if (chunk.content) {
                                    accumulatedData += chunk.content;
                                    lastValidData = chunk;
                                } else if (chunk.data) {
                                    accumulatedData += (typeof chunk.data === 'string' ? chunk.data : chunk.data.content || '');
                                    lastValidData = chunk;
                                } else if (chunk.message && chunk.message.content) {
                                    accumulatedData += chunk.message.content;
                                    lastValidData = chunk;
                                }
                            } catch (e) {
                                console.warn('è§£æ SSE æ•°æ®å—å¤±è´¥:', trimmedLine, e);
                            }
                        }
                    }
                    
                    // å¦‚æœæœ‰ç´¯ç§¯çš„å†…å®¹ï¼Œä½¿ç”¨å®ƒ
                    if (accumulatedData) {
                        result = { content: accumulatedData, data: accumulatedData };
                    } else if (lastValidData) {
                        result = lastValidData;
                    } else {
                        // å°è¯•ä»æœ€åä¸€è¡Œæå– JSON
                        const sseMatch = responseText.match(/data:\s*({.+?})/s);
                        if (sseMatch) {
                            result = JSON.parse(sseMatch[1]);
                        } else {
                            throw new Error('æ— æ³•è§£æ SSE å“åº”');
                        }
                    }
                } else {
                    // æ™®é€š JSON å“åº”
                    result = JSON.parse(responseText);
                }
            } catch (parseError) {
                console.error('è§£æå“åº”å¤±è´¥:', parseError, 'å“åº”å†…å®¹:', responseText.substring(0, 200));
                throw new Error('è§£æå“åº”å¤±è´¥: ' + parseError.message);
            }
            
            // æå–ç”Ÿæˆçš„æè¿°ï¼ˆé€‚é…ä¸åŒçš„å“åº”æ ¼å¼ï¼‰
            let generatedDescription = '';
            if (result.status === 200 && result.data) {
                // æˆåŠŸå“åº”ï¼Œæå– data å­—æ®µ
                generatedDescription = typeof result.data === 'string' ? result.data.trim() : (result.data.content || '').trim();
            } else if (result && result.content) {
                generatedDescription = result.content.trim();
            } else if (result && result.data && result.data.content) {
                generatedDescription = result.data.content.trim();
            } else if (result && result.message) {
                generatedDescription = result.message.trim();
            } else if (typeof result === 'string') {
                generatedDescription = result.trim();
            }

            // æ¸…ç†æè¿°ï¼ˆç§»é™¤å¯èƒ½çš„å¼•å·ç­‰ï¼‰
            generatedDescription = generatedDescription.replace(/^["']|["']$/g, '').trim();
            
            // é™åˆ¶é•¿åº¦
            if (generatedDescription.length > 500) {
                generatedDescription = generatedDescription.substring(0, 500);
            }

            if (generatedDescription) {
                descriptionInput.value = generatedDescription;
                descriptionInput.focus();
            } else {
                alert('ç”Ÿæˆæè¿°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('ç”Ÿæˆæè¿°å¤±è´¥:', error);
            alert('ç”Ÿæˆæè¿°å¤±è´¥ï¼š' + error.message);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
            generateBtn.style.opacity = '1';
            generateBtn.style.cursor = 'pointer';
        }
    }

    // æ™ºèƒ½ä¼˜åŒ–ä¼šè¯æè¿°
    async optimizeSessionDescription(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ä¼˜åŒ–æè¿°:', sessionId);
            return;
        }

        const modal = document.body.querySelector('#pet-session-info-editor');
        if (!modal) {
            return;
        }

        const optimizeBtn = modal.querySelector('.session-editor-optimize-description');
        const descriptionInput = modal.querySelector('.session-editor-description-input');
        
        if (!optimizeBtn || !descriptionInput) {
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰æè¿°
        const currentDescription = descriptionInput.value.trim();
        if (!currentDescription) {
            alert('è¯·å…ˆè¾“å…¥æè¿°å†…å®¹ï¼Œç„¶åå†è¿›è¡Œä¼˜åŒ–');
            descriptionInput.focus();
            return;
        }

        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        const originalText = optimizeBtn.innerHTML;
        optimizeBtn.disabled = true;
        optimizeBtn.innerHTML = 'ä¼˜åŒ–ä¸­...';
        optimizeBtn.style.opacity = '0.6';
        optimizeBtn.style.cursor = 'not-allowed';

        try {
            // è·å–ä¼šè¯ä¸Šä¸‹æ–‡
            const context = this.getSessionContext(sessionId);
            
            // æ„å»ºä¼˜åŒ–æè¿°çš„ prompt
            let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŠ©æ‰‹ï¼Œæ“…é•¿ä¼˜åŒ–å’Œæ¶¦è‰²ç½‘é¡µæè¿°ï¼Œä½¿å…¶æ›´åŠ ç®€æ´ã€å‡†ç¡®ã€å¸å¼•äººã€‚';
            let userPrompt = 'è¯·ä¼˜åŒ–ä»¥ä¸‹ç½‘é¡µæè¿°ï¼Œä½¿å…¶æ›´åŠ ç®€æ´ã€å‡†ç¡®ã€å¸å¼•äººï¼ˆ50-200å­—ï¼‰ï¼š\n\n';
            userPrompt += `å½“å‰æè¿°ï¼š${currentDescription}\n\n`;

            // æ·»åŠ é¡µé¢ä¿¡æ¯ä»¥æä¾›ä¸Šä¸‹æ–‡
            if (context.pageTitle) {
                userPrompt += `é¡µé¢æ ‡é¢˜ï¼š${context.pageTitle}\n`;
            }
            if (context.url) {
                userPrompt += `é¡µé¢URLï¼š${context.url}\n`;
            }

            // æ·»åŠ æ¶ˆæ¯å†å²ä»¥æä¾›æ›´å¤šä¸Šä¸‹æ–‡
            if (context.messages.length > 0) {
                userPrompt += '\nä¼šè¯å†…å®¹ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n';
                context.messages.slice(0, 10).forEach((msg, index) => {
                    const role = msg.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                    const content = msg.content.trim();
                    if (content) {
                        userPrompt += `${role}ï¼š${content.substring(0, 200)}\n`;
                    }
                });
            } else if (context.pageContent) {
                // å¦‚æœæ²¡æœ‰æ¶ˆæ¯å†å²ï¼Œä½¿ç”¨é¡µé¢å†…å®¹
                userPrompt += '\né¡µé¢å†…å®¹æ‘˜è¦ï¼ˆä¾›å‚è€ƒï¼‰ï¼š\n';
                userPrompt += context.pageContent.substring(0, 800);
            }

            userPrompt += '\n\nè¯·ç›´æ¥è¿”å›ä¼˜åŒ–åçš„æè¿°ï¼Œä¸è¦åŒ…å«å…¶ä»–è¯´æ˜æ–‡å­—ã€‚ä¼˜åŒ–åçš„æè¿°åº”è¯¥ï¼š\n';
            userPrompt += '1. ä¿æŒåŸæ„ä¸å˜\n';
            userPrompt += '2. æ›´åŠ ç®€æ´æ˜äº†\n';
            userPrompt += '3. è¯­è¨€æ›´åŠ æµç•…è‡ªç„¶\n';
            userPrompt += '4. çªå‡ºå…³é”®ä¿¡æ¯';

            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );

            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // å…ˆè·å–å“åº”æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ SSE æ ¼å¼
            const responseText = await response.text();
            let result;
            
            try {
                // æ£€æŸ¥æ˜¯å¦åŒ…å« SSE æ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                if (responseText.includes('data: ')) {
                    // å¤„ç† SSE æ ¼å¼å“åº”
                    const lines = responseText.split('\n');
                    let accumulatedData = '';
                    let lastValidData = null;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const dataStr = trimmedLine.substring(6).trim();
                                if (dataStr === '[DONE]' || dataStr === '') {
                                    continue;
                                }
                                
                                // å°è¯•è§£æ JSON
                                const chunk = JSON.parse(dataStr);
                                
                                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                if (chunk.done === true) {
                                    break;
                                }
                                
                                // ç´¯ç§¯å†…å®¹
                                if (chunk.content) {
                                    accumulatedData += chunk.content;
                                    lastValidData = chunk;
                                } else if (chunk.data) {
                                    accumulatedData += (typeof chunk.data === 'string' ? chunk.data : chunk.data.content || '');
                                    lastValidData = chunk;
                                } else if (chunk.message && chunk.message.content) {
                                    accumulatedData += chunk.message.content;
                                    lastValidData = chunk;
                                }
                            } catch (e) {
                                console.warn('è§£æ SSE æ•°æ®å—å¤±è´¥:', trimmedLine, e);
                            }
                        }
                    }
                    
                    // å¦‚æœæœ‰ç´¯ç§¯çš„å†…å®¹ï¼Œä½¿ç”¨å®ƒ
                    if (accumulatedData) {
                        result = { content: accumulatedData, data: accumulatedData };
                    } else if (lastValidData) {
                        result = lastValidData;
                    } else {
                        // å°è¯•ä»æœ€åä¸€è¡Œæå– JSON
                        const sseMatch = responseText.match(/data:\s*({.+?})/s);
                        if (sseMatch) {
                            result = JSON.parse(sseMatch[1]);
                        } else {
                            throw new Error('æ— æ³•è§£æ SSE å“åº”');
                        }
                    }
                } else {
                    // æ™®é€š JSON å“åº”
                    result = JSON.parse(responseText);
                }
            } catch (parseError) {
                console.error('è§£æå“åº”å¤±è´¥:', parseError, 'å“åº”å†…å®¹:', responseText.substring(0, 200));
                throw new Error('è§£æå“åº”å¤±è´¥: ' + parseError.message);
            }
            
            // æå–ä¼˜åŒ–åçš„æè¿°ï¼ˆé€‚é…ä¸åŒçš„å“åº”æ ¼å¼ï¼‰
            let optimizedDescription = '';
            if (result.status === 200 && result.data) {
                // æˆåŠŸå“åº”ï¼Œæå– data å­—æ®µ
                optimizedDescription = typeof result.data === 'string' ? result.data.trim() : (result.data.content || '').trim();
            } else if (result && result.content) {
                optimizedDescription = result.content.trim();
            } else if (result && result.data && result.data.content) {
                optimizedDescription = result.data.content.trim();
            } else if (result && result.message) {
                optimizedDescription = result.message.trim();
            } else if (typeof result === 'string') {
                optimizedDescription = result.trim();
            }

            // æ¸…ç†æè¿°ï¼ˆç§»é™¤å¯èƒ½çš„å¼•å·ç­‰ï¼‰
            optimizedDescription = optimizedDescription.replace(/^["']|["']$/g, '').trim();
            
            // é™åˆ¶é•¿åº¦
            if (optimizedDescription.length > 500) {
                optimizedDescription = optimizedDescription.substring(0, 500);
            }

            if (optimizedDescription) {
                descriptionInput.value = optimizedDescription;
                descriptionInput.focus();
            } else {
                alert('ä¼˜åŒ–æè¿°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('ä¼˜åŒ–æè¿°å¤±è´¥:', error);
            alert('ä¼˜åŒ–æè¿°å¤±è´¥ï¼š' + error.message);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            optimizeBtn.disabled = false;
            optimizeBtn.innerHTML = originalText;
            optimizeBtn.style.opacity = '1';
            optimizeBtn.style.cursor = 'pointer';
        }
    }

    // ç¿»è¯‘ä¼šè¯å­—æ®µï¼ˆæ ‡é¢˜æˆ–æè¿°ï¼‰
    async translateSessionField(fieldType, inputElement, targetLanguage) {
        if (!inputElement) return;
        
        const originalText = inputElement.value.trim();
        if (!originalText) {
            this.showNotification('è¯·å…ˆè¾“å…¥å†…å®¹', 'warning');
            return;
        }
        
        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const modal = document.body.querySelector('#pet-session-info-editor');
        const translateBtn = modal ? modal.querySelector(`button[data-translate-field="${fieldType}"][data-target-lang="${targetLanguage}"]`) : null;
        const originalBtnText = translateBtn ? translateBtn.textContent : '';
        if (translateBtn) {
            translateBtn.disabled = true;
            translateBtn.textContent = 'ç¿»è¯‘ä¸­...';
            translateBtn.style.opacity = '0.6';
            translateBtn.style.cursor = 'not-allowed';
        }
        
        try {
            // æ„å»ºç¿»è¯‘æç¤ºè¯
            const languageName = targetLanguage === 'zh' ? 'ä¸­æ–‡' : 'è‹±æ–‡';
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘ä¸“å®¶ï¼Œæ“…é•¿å‡†ç¡®ã€æµç•…åœ°ç¿»è¯‘æ–‡æœ¬ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„æ–‡æœ¬ç¿»è¯‘æˆ${languageName}ï¼Œè¦æ±‚ï¼š
1. ä¿æŒåŸæ–‡çš„æ„æ€å’Œè¯­æ°”ä¸å˜
2. ç¿»è¯‘è‡ªç„¶æµç•…ï¼Œç¬¦åˆ${languageName}çš„è¡¨è¾¾ä¹ æƒ¯
3. ä¿ç•™åŸæ–‡çš„æ ¼å¼å’Œç»“æ„

è¯·ç›´æ¥è¿”å›ç¿»è¯‘åçš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°ã€‚`;
            
            const userPrompt = `è¯·å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆ${languageName}ï¼š

${originalText}

è¯·ç›´æ¥è¿”å›ç¿»è¯‘åçš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«ä»»ä½•è¯´æ˜æ–‡å­—ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼æ ‡è®°ã€‚`;
            
            // æ„å»ºè¯·æ±‚ payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            this._showLoadingAnimation();
            
            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // å…ˆè·å–æ–‡æœ¬å“åº”ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼
            const responseText = await response.text();
            let result;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
            if (responseText.includes('data: ')) {
                // å¤„ç†SSEæµå¼å“åº”
                const lines = responseText.split('\n');
                let accumulatedData = '';
                let lastValidData = null;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ')) {
                        try {
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr === '[DONE]' || dataStr === '') {
                                continue;
                            }
                            
                            // å°è¯•è§£æJSON
                            const chunk = JSON.parse(dataStr);
                            
                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            if (chunk.done === true) {
                                break;
                            }
                            
                            // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                            if (chunk.data) {
                                accumulatedData += chunk.data;
                            } else if (chunk.content) {
                                accumulatedData += chunk.content;
                            } else if (chunk.message && chunk.message.content) {
                                // Ollamaæ ¼å¼
                                accumulatedData += chunk.message.content;
                            } else if (typeof chunk === 'string') {
                                accumulatedData += chunk;
                            }
                            
                            // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                            lastValidData = chunk;
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr && dataStr !== '[DONE]') {
                                accumulatedData += dataStr;
                            }
                        }
                    }
                }
                
                // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                if (accumulatedData || lastValidData) {
                    if (lastValidData && lastValidData.status) {
                        // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                        result = {
                            ...lastValidData,
                            data: accumulatedData || lastValidData.data || '',
                            content: accumulatedData || lastValidData.content || ''
                        };
                    } else {
                        // å¦åˆ™åˆ›å»ºæ–°çš„ç»“æœå¯¹è±¡
                        result = {
                            data: accumulatedData,
                            content: accumulatedData
                        };
                    }
                } else {
                    // å¦‚æœæ— æ³•è§£æSSEæ ¼å¼ï¼Œå°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                    }
                }
            } else {
                // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº”: ${e.message}`);
                }
            }
            
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
            
            // è§£æå“åº”å†…å®¹
            let translatedText;
            // ä¼˜å…ˆæ£€æŸ¥ status å­—æ®µï¼Œå¦‚æœå­˜åœ¨ä¸”ä¸ç­‰äº 200ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
            if (result.status !== undefined && result.status !== 200) {
                throw new Error(result.msg || result.message || 'ç¿»è¯‘å¤±è´¥');
            }
            
            // æŒ‰ä¼˜å…ˆçº§æå–ç¿»è¯‘åçš„æ–‡æœ¬
            if (result.data) {
                translatedText = result.data;
            } else if (result.content) {
                translatedText = result.content;
            } else if (result.message) {
                translatedText = result.message;
            } else if (typeof result === 'string') {
                translatedText = result;
            } else if (result.text) {
                translatedText = result.text;
            } else {
                // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ä¸å­˜åœ¨ï¼Œå°è¯•ä»å¯¹è±¡ä¸­æŸ¥æ‰¾å¯èƒ½çš„æ–‡æœ¬å­—æ®µ
                const possibleFields = ['output', 'response', 'result', 'answer'];
                for (const field of possibleFields) {
                    if (result[field] && typeof result[field] === 'string') {
                        translatedText = result[field];
                        break;
                    }
                }
                
                // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼ŒæŠ›å‡ºé”™è¯¯
                if (!translatedText) {
                    console.error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œå“åº”å¯¹è±¡:', result);
                    throw new Error('æ— æ³•è§£æå“åº”å†…å®¹ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨å“åº”æ ¼å¼');
                }
            }
            
            // æ¸…ç†ç¿»è¯‘åçš„æ–‡æœ¬
            translatedText = translatedText.trim();
            
            // ç§»é™¤å¯èƒ½çš„å¼•å·åŒ…è£¹ï¼ˆæ”¯æŒå¤šç§å¼•å·ç±»å‹ï¼‰
            const quotePairs = [
                ['"', '"'],
                ['"', '"'],
                ['"', '"'],
                ["'", "'"],
                ['`', '`'],
                ['ã€Œ', 'ã€'],
                ['ã€', 'ã€']
            ];
            
            for (const [startQuote, endQuote] of quotePairs) {
                if (translatedText.startsWith(startQuote) && translatedText.endsWith(endQuote)) {
                    translatedText = translatedText.slice(startQuote.length, -endQuote.length).trim();
                }
            }
            
            // ç§»é™¤å¸¸è§çš„AIå›å¤å‰ç¼€
            const prefixes = [
                /^ç¿»è¯‘åçš„[å†…å®¹æ–‡æœ¬]ï¼š?\s*/i,
                /^ä»¥ä¸‹æ˜¯ç¿»è¯‘åçš„[å†…å®¹æ–‡æœ¬]ï¼š?\s*/i,
                /^ç¿»è¯‘ç»“æœï¼š?\s*/i,
                /^ç¿»è¯‘åçš„æ–‡æœ¬ï¼š?\s*/i,
                /^ç¿»è¯‘åçš„[å†…å®¹æ–‡æœ¬]å¦‚ä¸‹ï¼š?\s*/i,
                /^[å†…å®¹æ–‡æœ¬]ç¿»è¯‘å¦‚ä¸‹ï¼š?\s*/i
            ];
            
            for (const prefix of prefixes) {
                translatedText = translatedText.replace(prefix, '').trim();
            }
            
            // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦ï¼ˆä½†ä¿ç•™æ ¼å¼ï¼‰
            translatedText = translatedText.replace(/\n{4,}/g, '\n\n\n');
            translatedText = translatedText.replace(/[ \t]+/g, ' ');
            translatedText = translatedText.trim();
            
            // éªŒè¯ç¿»è¯‘åçš„æ–‡æœ¬æ˜¯å¦æœ‰æ•ˆ
            if (!translatedText || translatedText.length < 1) {
                throw new Error('ç¿»è¯‘åçš„æ–‡æœ¬ä¸ºç©ºï¼Œå¯èƒ½ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            
            // å¦‚æœç¿»è¯‘åçš„æ–‡æœ¬ä¸åŸæ–‡å®Œå…¨ç›¸åŒï¼Œç»™å‡ºæç¤º
            if (translatedText === originalText) {
                this.showNotification('ç¿»è¯‘åçš„å†…å®¹ä¸åŸæ–‡ç›¸åŒ', 'info');
            }
            
            // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
            inputElement.value = translatedText;
            
            // è§¦å‘ input äº‹ä»¶ï¼Œç¡®ä¿å€¼è¢«æ­£ç¡®æ›´æ–°
            inputElement.dispatchEvent(new Event('input', { bubbles: true }));
            
            this.showNotification('ç¿»è¯‘å®Œæˆ', 'success');
        } catch (error) {
            console.error('ç¿»è¯‘å¤±è´¥:', error);
            this.showNotification('ç¿»è¯‘å¤±è´¥ï¼š' + error.message, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (translateBtn) {
                translateBtn.disabled = false;
                translateBtn.textContent = originalBtnText;
                translateBtn.style.opacity = '1';
                translateBtn.style.cursor = 'pointer';
            }
            // éšè—åŠ è½½åŠ¨ç”»
            this._hideLoadingAnimation();
        }
    }

    // æ‰“å¼€æ ‡ç­¾ç®¡ç†å¼¹çª—
    openTagManager(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ç®¡ç†æ ‡ç­¾:', sessionId);
            return;
        }

        const session = this.sessions[sessionId];
        const currentTags = session.tags || [];

        // åˆ›å»ºæ ‡ç­¾ç®¡ç†å¼¹çª—
        this.ensureTagManagerUi();
        const modal = this.chatWindow?.querySelector('#pet-tag-manager');
        if (!modal) {
            console.error('æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }

        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
        modal.dataset.sessionId = sessionId;
        
        // éšè—æŠ˜å æŒ‰é’®ï¼ˆé¿å…åœ¨å¼¹æ¡†ä¸­æ˜¾ç¤ºä¸¤ä¸ªæŠ˜å æŒ‰é’®ï¼‰
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';

        // åŠ è½½å½“å‰æ ‡ç­¾
        this.loadTagsIntoManager(sessionId, currentTags);

        // æ·»åŠ å…³é—­äº‹ä»¶
        const closeBtn = modal.querySelector('.tag-manager-close');
        if (closeBtn) {
            closeBtn.onclick = () => this.closeTagManager();
        }

        // æ·»åŠ ä¿å­˜äº‹ä»¶
        const saveBtn = modal.querySelector('.tag-manager-save');
        if (saveBtn) {
            saveBtn.onclick = () => this.saveTags(sessionId);
        }

        // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶ï¼ˆå…¼å®¹ä¸­æ–‡è¾“å…¥æ³•ï¼‰
        const tagInput = modal.querySelector('.tag-manager-input');
        if (tagInput) {
            // ç¡®ä¿è¾“å…¥æ³•ç»„åˆçŠ¶æ€å·²åˆå§‹åŒ–ï¼ˆå¦‚æœè¾“å…¥æ¡†æ˜¯æ–°åˆ›å»ºçš„ï¼‰
            if (tagInput._isComposing === undefined) {
                tagInput._isComposing = false;
                tagInput.addEventListener('compositionstart', () => {
                    tagInput._isComposing = true;
                });
                tagInput.addEventListener('compositionend', () => {
                    tagInput._isComposing = false;
                });
            }
            
            // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†ï¼ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®šï¼‰
            const existingHandler = tagInput._enterKeyHandler;
            if (existingHandler) {
                tagInput.removeEventListener('keydown', existingHandler);
            }
            
            const enterKeyHandler = (e) => {
                // å¦‚æœåœ¨è¾“å…¥æ³•ç»„åˆè¿‡ç¨‹ä¸­ï¼Œå¿½ç•¥å›è½¦é”®
                if (tagInput._isComposing) {
                    return;
                }
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addTagFromInput(sessionId);
                }
            };
            
            tagInput._enterKeyHandler = enterKeyHandler;
            tagInput.addEventListener('keydown', enterKeyHandler);
            
            tagInput.focus();
        }

        // ESC é”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeTagManager();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    // ç¡®ä¿æ ‡ç­¾ç®¡ç†UIå­˜åœ¨
    ensureTagManagerUi() {
        if (!this.chatWindow) return;
        if (this.chatWindow.querySelector('#pet-tag-manager')) return;

        const modal = document.createElement('div');
        modal.id = 'pet-tag-manager';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 10000 !important;
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeTagManager();
            }
        });

        const panel = document.createElement('div');
        panel.style.cssText = `
            background: white !important;
            border-radius: 12px !important;
            padding: 24px !important;
            width: 90% !important;
            max-width: 800px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        `;

        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 20px !important;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ç®¡ç†æ ‡ç­¾';
        title.style.cssText = `
            margin: 0 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #333 !important;
        `;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'tag-manager-close';
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            color: #999 !important;
            padding: 0 !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#f0f0f0';
            closeBtn.style.color = '#333';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#999';
        });

        header.appendChild(title);
        header.appendChild(closeBtn);

        // è¾“å…¥åŒºåŸŸ
        const inputGroup = document.createElement('div');
        inputGroup.className = 'tag-manager-input-group';
        inputGroup.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
        `;

        const tagInput = document.createElement('input');
        tagInput.className = 'tag-manager-input';
        tagInput.type = 'text';
        tagInput.placeholder = 'è¾“å…¥æ ‡ç­¾åç§°ï¼ŒæŒ‰å›è½¦æ·»åŠ ';
        tagInput.style.cssText = `
            flex: 1 !important;
            padding: 10px 12px !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            outline: none !important;
            transition: border-color 0.2s ease !important;
        `;
        
        // è¾“å…¥æ³•ç»„åˆçŠ¶æ€è·Ÿè¸ªï¼ˆç”¨äºå¤„ç†ä¸­æ–‡è¾“å…¥ï¼‰
        // å°†çŠ¶æ€å­˜å‚¨åœ¨è¾“å…¥æ¡†å…ƒç´ ä¸Šï¼Œä¾¿äºåç»­è®¿é—®
        tagInput._isComposing = false;
        tagInput.addEventListener('compositionstart', () => {
            tagInput._isComposing = true;
        });
        tagInput.addEventListener('compositionend', () => {
            tagInput._isComposing = false;
        });
        
        tagInput.addEventListener('focus', () => {
            tagInput.style.borderColor = '#4CAF50';
        });
        tagInput.addEventListener('blur', () => {
            tagInput.style.borderColor = '#e0e0e0';
        });

        const addBtn = document.createElement('button');
        addBtn.textContent = 'æ·»åŠ ';
        addBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #4CAF50 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.background = '#45a049';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.background = '#4CAF50';
        });
        addBtn.addEventListener('click', () => {
            const sessionId = modal.dataset.sessionId;
            if (sessionId) {
                this.addTagFromInput(sessionId);
            }
        });

        // æ™ºèƒ½ç”Ÿæˆæ ‡ç­¾æŒ‰é’®
        const smartGenerateBtn = document.createElement('button');
        smartGenerateBtn.className = 'tag-manager-smart-generate';
        smartGenerateBtn.textContent = 'âœ¨ æ™ºèƒ½ç”Ÿæˆ';
        smartGenerateBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #9C27B0 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
            white-space: nowrap !important;
        `;
        smartGenerateBtn.addEventListener('mouseenter', () => {
            if (!smartGenerateBtn.disabled) {
                smartGenerateBtn.style.background = '#7B1FA2';
            }
        });
        smartGenerateBtn.addEventListener('mouseleave', () => {
            if (!smartGenerateBtn.disabled) {
                smartGenerateBtn.style.background = '#9C27B0';
            }
        });
        smartGenerateBtn.addEventListener('click', () => {
            const sessionId = modal.dataset.sessionId;
            if (sessionId) {
                this.generateSmartTags(sessionId, smartGenerateBtn);
            }
        });

        inputGroup.appendChild(tagInput);
        inputGroup.appendChild(addBtn);
        inputGroup.appendChild(smartGenerateBtn);

        // å¿«æ·æ ‡ç­¾æŒ‰é’®å®¹å™¨
        const quickTagsContainer = document.createElement('div');
        quickTagsContainer.className = 'tag-manager-quick-tags';
        quickTagsContainer.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
        `;

        // å¿«æ·æ ‡ç­¾åˆ—è¡¨
        const quickTags = ['å·¥å…·', 'å¼€æºé¡¹ç›®', 'å®¶åº­', 'å·¥ä½œ', 'å¨±ä¹', 'æ–‡æ¡£', 'ç½‘æ–‡', 'æ—¥è®°'];
        
        quickTags.forEach(tagName => {
            const quickTagBtn = document.createElement('button');
            quickTagBtn.textContent = tagName;
            quickTagBtn.className = 'tag-manager-quick-tag-btn';
            quickTagBtn.dataset.tagName = tagName;
            quickTagBtn.style.cssText = `
                padding: 6px 12px !important;
                background: #f0f0f0 !important;
                color: #333 !important;
                border: 1px solid #d0d0d0 !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 13px !important;
                transition: all 0.2s ease !important;
            `;
            quickTagBtn.addEventListener('mouseenter', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ”¹å˜æ ·å¼
                if (quickTagBtn.style.background === 'rgb(76, 175, 80)') {
                    return;
                }
                quickTagBtn.style.background = '#e0e0e0';
                quickTagBtn.style.borderColor = '#4CAF50';
            });
            quickTagBtn.addEventListener('mouseleave', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ”¹å˜æ ·å¼
                if (quickTagBtn.style.background === 'rgb(76, 175, 80)') {
                    return;
                }
                quickTagBtn.style.background = '#f0f0f0';
                quickTagBtn.style.borderColor = '#d0d0d0';
            });
            quickTagBtn.addEventListener('click', () => {
                // å¦‚æœæ ‡ç­¾å·²æ·»åŠ ï¼Œä¸æ‰§è¡Œæ“ä½œ
                if (quickTagBtn.style.cursor === 'not-allowed') {
                    return;
                }
                const sessionId = modal.dataset.sessionId;
                if (sessionId) {
                    this.addQuickTag(sessionId, tagName);
                }
            });
            quickTagsContainer.appendChild(quickTagBtn);
        });

        // æ ‡ç­¾åˆ—è¡¨
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'tag-manager-tags';
        tagsContainer.style.cssText = `
            min-height: 100px !important;
            max-height: 300px !important;
            overflow-y: auto !important;
            margin-bottom: 20px !important;
            padding: 12px !important;
            background: #f8f9fa !important;
            border-radius: 6px !important;
        `;

        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = `
            display: flex !important;
            justify-content: flex-end !important;
            gap: 10px !important;
        `;

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #f0f0f0 !important;
            color: #333 !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: background 0.2s ease !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#e0e0e0';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = '#f0f0f0';
        });
        cancelBtn.addEventListener('click', () => this.closeTagManager());

        const saveBtn = document.createElement('button');
        saveBtn.className = 'tag-manager-save';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            background: #2196F3 !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            transition: background 0.2s ease !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = '#1976D2';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = '#2196F3';
        });

        footer.appendChild(cancelBtn);
        footer.appendChild(saveBtn);

        panel.appendChild(header);
        panel.appendChild(inputGroup);
        panel.appendChild(quickTagsContainer);
        panel.appendChild(tagsContainer);
        panel.appendChild(footer);
        modal.appendChild(panel);
        this.chatWindow.appendChild(modal);
    }

    // åŠ è½½æ ‡ç­¾åˆ°ç®¡ç†å™¨
    loadTagsIntoManager(sessionId, tags) {
        const modal = this.chatWindow?.querySelector('#pet-tag-manager');
        if (!modal) return;

        const tagsContainer = modal.querySelector('.tag-manager-tags');
        if (!tagsContainer) return;

        tagsContainer.innerHTML = '';

        if (!tags || tags.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'æš‚æ— æ ‡ç­¾';
            emptyMsg.style.cssText = `
                text-align: center !important;
                color: #999 !important;
                padding: 20px !important;
                font-size: 14px !important;
            `;
            tagsContainer.appendChild(emptyMsg);
            return;
        }

        tags.forEach((tag, index) => {
            const tagItem = document.createElement('div');
            tagItem.style.cssText = `
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                background: #4CAF50 !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 20px !important;
                margin: 4px !important;
                font-size: 13px !important;
            `;

            const tagText = document.createElement('span');
            tagText.textContent = tag;

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = 'âœ•';
            removeBtn.style.cssText = `
                background: rgba(255, 255, 255, 0.3) !important;
                border: none !important;
                color: white !important;
                width: 18px !important;
                height: 18px !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                font-size: 12px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 0 !important;
                transition: background 0.2s ease !important;
            `;
            removeBtn.addEventListener('mouseenter', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.5)';
            });
            removeBtn.addEventListener('mouseleave', () => {
                removeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            });
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const sessionId = modal.dataset.sessionId;
                if (sessionId) {
                    this.removeTag(sessionId, index);
                }
            });

            tagItem.appendChild(tagText);
            tagItem.appendChild(removeBtn);
            tagsContainer.appendChild(tagItem);
        });

        // æ›´æ–°å¿«æ·æ ‡ç­¾æŒ‰é’®çŠ¶æ€
        const quickTagButtons = modal.querySelectorAll('.tag-manager-quick-tag-btn');
        quickTagButtons.forEach(btn => {
            const tagName = btn.dataset.tagName;
            const isAdded = tags && tags.includes(tagName);
            if (isAdded) {
                btn.style.background = '#4CAF50';
                btn.style.color = 'white';
                btn.style.borderColor = '#4CAF50';
                btn.style.opacity = '0.7';
                btn.style.cursor = 'not-allowed';
            } else {
                btn.style.background = '#f0f0f0';
                btn.style.color = '#333';
                btn.style.borderColor = '#d0d0d0';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    }

    // ä»è¾“å…¥æ¡†æ·»åŠ æ ‡ç­¾
    addTagFromInput(sessionId) {
        const modal = this.chatWindow?.querySelector('#pet-tag-manager');
        if (!modal) return;

        const tagInput = modal.querySelector('.tag-manager-input');
        if (!tagInput) return;

        const tagName = tagInput.value.trim();
        if (!tagName) return;

        const session = this.sessions[sessionId];
        if (!session) return;

        if (!session.tags) {
            session.tags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (session.tags.includes(tagName)) {
            tagInput.value = '';
            tagInput.focus();
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        session.tags.push(tagName);
        tagInput.value = '';
        tagInput.focus();

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadTagsIntoManager(sessionId, session.tags);
    }

    // æ·»åŠ å¿«æ·æ ‡ç­¾
    addQuickTag(sessionId, tagName) {
        const modal = this.chatWindow?.querySelector('#pet-tag-manager');
        if (!modal) return;

        const session = this.sessions[sessionId];
        if (!session) return;

        if (!session.tags) {
            session.tags = [];
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if (session.tags.includes(tagName)) {
            return;
        }

        // æ·»åŠ æ ‡ç­¾
        session.tags.push(tagName);

        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
        this.loadTagsIntoManager(sessionId, session.tags);
    }

    // åˆ é™¤æ ‡ç­¾
    removeTag(sessionId, index) {
        const session = this.sessions[sessionId];
        if (!session || !session.tags) return;

        session.tags.splice(index, 1);
        this.loadTagsIntoManager(sessionId, session.tags);
    }

    // æ™ºèƒ½ç”Ÿæˆæ ‡ç­¾
    async generateSmartTags(sessionId, buttonElement) {
        if (!sessionId || !this.sessions[sessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆæ ‡ç­¾:', sessionId);
            return;
        }

        const session = this.sessions[sessionId];
        const modal = this.chatWindow?.querySelector('#pet-tag-manager');
        
        if (!modal) {
            console.error('æ ‡ç­¾ç®¡ç†å¼¹çª—æœªæ‰¾åˆ°');
            return;
        }

        // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        // ä¸´æ—¶ä¿å­˜å½“å‰ä¼šè¯IDï¼Œä»¥ä¾¿ç”Ÿæˆæ ‡ç­¾åæ¢å¤
        const originalSessionId = this.currentSessionId;
        
        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.style.background = '#ccc';
            buttonElement.style.cursor = 'not-allowed';
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // æ”¶é›†é¡µé¢ä¸Šä¸‹æ–‡ä¿¡æ¯
                const pageTitle = session.pageTitle || 'å½“å‰é¡µé¢';
                const pageUrl = session.url || window.location.href;
                const pageDescription = session.pageDescription || '';
                
                // è·å–ä¼šè¯æ¶ˆæ¯æ‘˜è¦ï¼ˆå–å‰5æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡ï¼‰
                let messageSummary = '';
                if (session.messages && Array.isArray(session.messages) && session.messages.length > 0) {
                    const recentMessages = session.messages.slice(0, 5);
                    messageSummary = recentMessages.map((msg, idx) => {
                        const role = msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                        const content = msg.content || '';
                        // é™åˆ¶æ¯æ¡æ¶ˆæ¯é•¿åº¦ï¼Œé¿å…è¿‡é•¿
                        const truncatedContent = content.length > 100 ? content.substring(0, 100) + '...' : content;
                        return `${idx + 1}. ${role}: ${truncatedContent}`;
                    }).join('\n');
                }

                // æ„å»ºç³»ç»Ÿæç¤ºè¯
                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ ‡ç­¾ç”ŸæˆåŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·æä¾›çš„é¡µé¢ä¸Šä¸‹æ–‡å’Œä¼šè¯å†…å®¹ï¼Œç”Ÿæˆåˆé€‚çš„æ ‡ç­¾ã€‚

æ ‡ç­¾è¦æ±‚ï¼š
1. æ ‡ç­¾åº”è¯¥ç®€æ´æ˜äº†ï¼Œæ¯ä¸ªæ ‡ç­¾2-6ä¸ªæ±‰å­—æˆ–3-12ä¸ªè‹±æ–‡å­—ç¬¦
2. æ ‡ç­¾åº”è¯¥å‡†ç¡®åæ˜ é¡µé¢æˆ–ä¼šè¯çš„æ ¸å¿ƒä¸»é¢˜
3. ç”Ÿæˆ3-8ä¸ªæ ‡ç­¾
4. æ ‡ç­¾ä¹‹é—´ç”¨é€—å·åˆ†éš”
5. åªè¿”å›æ ‡ç­¾ï¼Œä¸è¦è¿”å›å…¶ä»–è¯´æ˜æ–‡å­—
6. å¦‚æœå·²æœ‰æ ‡ç­¾ï¼Œé¿å…ç”Ÿæˆé‡å¤çš„æ ‡ç­¾

è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼šæŠ€æœ¯,ç¼–ç¨‹,å‰ç«¯å¼€å‘,JavaScript`;

                // æ„å»ºç”¨æˆ·æç¤ºè¯
                let userPrompt = `é¡µé¢ä¿¡æ¯ï¼š
- æ ‡é¢˜ï¼š${pageTitle}
- ç½‘å€ï¼š${pageUrl}`;

                if (pageDescription) {
                    userPrompt += `\n- æè¿°ï¼š${pageDescription}`;
                }

                if (messageSummary) {
                    userPrompt += `\n\nä¼šè¯å†…å®¹æ‘˜è¦ï¼š\n${messageSummary}`;
                }

                const currentTags = session.tags || [];
                if (currentTags.length > 0) {
                    userPrompt += `\n\nå·²æœ‰æ ‡ç­¾ï¼š${currentTags.join(', ')}\nè¯·é¿å…ç”Ÿæˆé‡å¤çš„æ ‡ç­¾ã€‚`;
                }

                userPrompt += `\n\nè¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ç”Ÿæˆåˆé€‚çš„æ ‡ç­¾ã€‚`;

                // æ„å»º payload
                
                // ä¸´æ—¶è®¾ç½®ä¼šè¯IDä¸ºç›®æ ‡ä¼šè¯IDï¼Œç¡®ä¿ prompt æ¥å£ä½¿ç”¨æ­£ç¡®çš„ä¼šè¯ä¸Šä¸‹æ–‡
                this.currentSessionId = sessionId;
                
                try {
                    const payload = this.buildPromptPayload(
                        systemPrompt,
                        userPrompt,
                        this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
                    );
                    
                    // ç¡®ä¿ payload ä¸­åŒ…å«æ­£ç¡®çš„ä¼šè¯ID
                    payload.conversation_id = sessionId;

                    // è°ƒç”¨ prompt æ¥å£
                    const response = await fetch(PET_CONFIG.api.promptUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    // å…ˆè¯»å–å“åº”æ–‡æœ¬ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæµå¼å“åº”ï¼ˆSSEæ ¼å¼ï¼‰
                    const responseText = await response.text();
                    let result;
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                    if (responseText.includes('data: ')) {
                        // å¤„ç†SSEæµå¼å“åº”
                        const lines = responseText.split('\n');
                        let accumulatedData = '';
                        let lastValidData = null;
                        
                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            if (trimmedLine.startsWith('data: ')) {
                                try {
                                    const dataStr = trimmedLine.substring(6).trim();
                                    if (dataStr === '[DONE]' || dataStr === '') {
                                        continue;
                                    }
                                    
                                    // å°è¯•è§£æJSON
                                    const chunk = JSON.parse(dataStr);
                                    
                                    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                    if (chunk.done === true) {
                                        break;
                                    }
                                    
                                    // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                                    if (chunk.data) {
                                        accumulatedData += chunk.data;
                                    } else if (chunk.content) {
                                        accumulatedData += chunk.content;
                                    } else if (chunk.message && chunk.message.content) {
                                        // Ollamaæ ¼å¼
                                        accumulatedData += chunk.message.content;
                                    } else if (typeof chunk === 'string') {
                                        accumulatedData += chunk;
                                    }
                                    
                                    // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                                    lastValidData = chunk;
                                } catch (e) {
                                    // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                                    const dataStr = trimmedLine.substring(6).trim();
                                    if (dataStr && dataStr !== '[DONE]') {
                                        accumulatedData += dataStr;
                                    }
                                }
                            }
                        }
                        
                        // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                        if (accumulatedData || lastValidData) {
                            if (lastValidData && lastValidData.status) {
                                // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                                result = {
                                    ...lastValidData,
                                    data: accumulatedData || lastValidData.data || '',
                                    content: accumulatedData || lastValidData.content || ''
                                };
                            } else {
                                // å¦åˆ™åˆ›å»ºæ–°çš„ç»“æœå¯¹è±¡
                                result = {
                                    data: accumulatedData,
                                    content: accumulatedData
                                };
                            }
                        } else {
                            // å¦‚æœæ— æ³•è§£æSSEæ ¼å¼ï¼Œå°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”
                            try {
                                result = JSON.parse(responseText);
                            } catch (e) {
                                throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                            }
                        }
                    } else {
                        // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                        try {
                            result = JSON.parse(responseText);
                        } catch (e) {
                            // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾SSEæ ¼å¼çš„æ•°æ®
                            const sseMatch = responseText.match(/data:\s*({.+?})/s);
                            if (sseMatch) {
                                result = JSON.parse(sseMatch[1]);
                            } else {
                                throw new Error(`æ— æ³•è§£æå“åº”: ${responseText.substring(0, 100)}`);
                            }
                        }
                    }
                    
                    // è§£æè¿”å›çš„æ ‡ç­¾
                    let generatedTags = [];
                    // é€‚é…å“åº”æ ¼å¼: {status, msg, data, pagination} æˆ– {content} æˆ– {response}
                    let content = '';
                    if (result.data) {
                        content = result.data;
                    } else if (result.content) {
                        content = result.content;
                    } else if (result.response) {
                        content = result.response;
                    }
                    
                    if (content) {
                        const trimmedContent = content.trim();
                        
                        // å°è¯•è§£æ JSON æ ¼å¼
                        try {
                            const parsed = JSON.parse(trimmedContent);
                            if (Array.isArray(parsed)) {
                                generatedTags = parsed;
                            } else if (typeof parsed === 'object' && parsed.tags) {
                                generatedTags = Array.isArray(parsed.tags) ? parsed.tags : [];
                            }
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯ JSONï¼Œå°è¯•æŒ‰é€—å·åˆ†å‰²
                            generatedTags = trimmedContent.split(/[,ï¼Œã€]/).map(tag => tag.trim()).filter(tag => tag.length > 0);
                        }
                    }

                    if (generatedTags.length === 0) {
                        throw new Error('æœªèƒ½ç”Ÿæˆæœ‰æ•ˆæ ‡ç­¾ï¼Œè¯·é‡è¯•');
                    }

                    // ç¡®ä¿æ ‡ç­¾æ•°ç»„å­˜åœ¨
                    if (!session.tags) {
                        session.tags = [];
                    }

                    // æ·»åŠ æ–°æ ‡ç­¾ï¼ˆæ’é™¤å·²å­˜åœ¨çš„æ ‡ç­¾ï¼‰
                    let addedCount = 0;
                    generatedTags.forEach(tag => {
                        const trimmedTag = tag.trim();
                        if (trimmedTag && !session.tags.includes(trimmedTag)) {
                            session.tags.push(trimmedTag);
                            addedCount++;
                        }
                    });

                    if (addedCount > 0) {
                        // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
                        this.loadTagsIntoManager(sessionId, session.tags);
                        console.log(`æˆåŠŸç”Ÿæˆå¹¶æ·»åŠ  ${addedCount} ä¸ªæ ‡ç­¾:`, generatedTags.filter(tag => session.tags.includes(tag.trim())));
                    } else {
                        console.log('ç”Ÿæˆçš„æ ‡ç­¾éƒ½å·²å­˜åœ¨ï¼Œæœªæ·»åŠ æ–°æ ‡ç­¾');
                    }

                } finally {
                    // æ¢å¤åŸå§‹ä¼šè¯ID
                    this.currentSessionId = originalSessionId;
                }

            } catch (error) {
                console.error('æ™ºèƒ½ç”Ÿæˆæ ‡ç­¾å¤±è´¥:', error);
                
                // ä½¿ç”¨éé˜»å¡çš„é”™è¯¯æç¤ºï¼Œé¿å…é˜»å¡å¼¹æ¡†äº¤äº’
                const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                const errorText = errorMessage.includes('Failed to fetch') 
                    ? 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•' 
                    : `ç”Ÿæˆæ ‡ç­¾å¤±è´¥ï¼š${errorMessage}`;
                
                // åœ¨å¼¹æ¡†å†…æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè€Œä¸æ˜¯ä½¿ç”¨ alertï¼ˆalert ä¼šé˜»å¡ï¼‰
                const modal = this.chatWindow?.querySelector('#pet-tag-manager');
                if (modal) {
                    // ç§»é™¤å·²å­˜åœ¨çš„é”™è¯¯æç¤º
                    const existingError = modal.querySelector('.tag-error-message');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'tag-error-message';
                    errorDiv.textContent = errorText;
                    errorDiv.style.cssText = `
                        padding: 10px 15px !important;
                        margin: 10px 0 !important;
                        background: #ffebee !important;
                        color: #c62828 !important;
                        border: 1px solid #ef5350 !important;
                        border-radius: 6px !important;
                        font-size: 13px !important;
                        animation: fadeIn 0.3s ease !important;
                    `;
                    
                    // æ’å…¥åˆ°è¾“å…¥ç»„ä¸‹æ–¹
                    const inputGroup = modal.querySelector('.tag-manager-input-group');
                    if (inputGroup && inputGroup.parentNode) {
                        // æ’å…¥åˆ°è¾“å…¥ç»„å’Œæ ‡ç­¾å®¹å™¨ä¹‹é—´
                        const tagsContainer = modal.querySelector('.tag-manager-tags');
                        if (tagsContainer && tagsContainer.parentNode) {
                            tagsContainer.parentNode.insertBefore(errorDiv, tagsContainer);
                        } else {
                            inputGroup.parentNode.insertBefore(errorDiv, inputGroup.nextSibling);
                        }
                        
                        // 3ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯æç¤º
                        setTimeout(() => {
                            if (errorDiv.parentNode) {
                                errorDiv.style.opacity = '0';
                                errorDiv.style.transition = 'opacity 0.3s ease';
                                setTimeout(() => {
                                    if (errorDiv.parentNode) {
                                        errorDiv.remove();
                                    }
                                }, 300);
                            }
                        }, 3000);
                    }
                } else {
                    // å¦‚æœå¼¹æ¡†ä¸å­˜åœ¨ï¼Œä½¿ç”¨ alert ä½œä¸ºåå¤‡æ–¹æ¡ˆ
                    alert(errorText);
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.style.background = '#9C27B0';
                    buttonElement.style.cursor = 'pointer';
                    buttonElement.textContent = 'âœ¨ æ™ºèƒ½ç”Ÿæˆ';
                }
                
                // ç¡®ä¿æ¢å¤åŸå§‹ä¼šè¯IDï¼ˆå³ä½¿å‡ºé”™ï¼‰
                if (this.currentSessionId !== originalSessionId) {
                    this.currentSessionId = originalSessionId;
                }
                
                // ç¡®ä¿å¼¹æ¡†æœ¬èº«æ²¡æœ‰è¢«ç¦ç”¨ï¼ˆé˜²æ­¢å…¶ä»–æŒ‰é’®å¤±æ•ˆï¼‰
                const modal = this.chatWindow?.querySelector('#pet-tag-manager');
                if (modal) {
                    modal.style.pointerEvents = 'auto';
                    // ç¡®ä¿æ‰€æœ‰æŒ‰é’®éƒ½æ˜¯å¯ç”¨çš„
                    const allButtons = modal.querySelectorAll('button');
                    allButtons.forEach(btn => {
                        if (btn !== buttonElement) {
                            btn.disabled = false;
                            btn.style.pointerEvents = 'auto';
                            btn.style.cursor = 'pointer';
                        }
                    });
                }
            }
        }
    }

    // ä¿å­˜æ ‡ç­¾
    async saveTags(sessionId) {
        if (!sessionId || !this.sessions[sessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨ï¼Œæ— æ³•ä¿å­˜æ ‡ç­¾:', sessionId);
            return;
        }

        try {
            const session = this.sessions[sessionId];
            // è§„èŒƒåŒ–æ ‡ç­¾ï¼ˆtrimå¤„ç†ï¼Œå»é‡ï¼Œè¿‡æ»¤ç©ºæ ‡ç­¾ï¼‰
            if (session.tags && Array.isArray(session.tags)) {
                const normalizedTags = session.tags
                    .map(tag => tag ? tag.trim() : '')
                    .filter(tag => tag.length > 0);
                // å»é‡
                session.tags = [...new Set(normalizedTags)];
            }
            session.updatedAt = Date.now();

            // ä¿å­˜ä¼šè¯åˆ°æœ¬åœ°
            await this.saveAllSessions(false, true);

            // ç«‹å³åŒæ­¥åˆ°åç«¯ï¼ˆç¡®ä¿æ ‡ç­¾è¢«ä¿å­˜ï¼‰
            if (PET_CONFIG.api.syncSessionsToBackend && this.sessionApi) {
                await this.syncSessionToBackend(sessionId, true);
            }

            // æ›´æ–°UIæ˜¾ç¤º
            await this.updateSessionSidebar(true);

            // å…³é—­å¼¹çª—ï¼ˆä¸è‡ªåŠ¨ä¿å­˜ï¼Œå› ä¸ºå·²ç»ä¿å­˜è¿‡äº†ï¼‰
            const modal = this.chatWindow?.querySelector('#pet-tag-manager');
            if (modal) {
                modal.style.display = 'none';
                const tagInput = modal.querySelector('.tag-manager-input');
                if (tagInput) {
                    tagInput.value = '';
                }
            }

            console.log('æ ‡ç­¾å·²ä¿å­˜:', session.tags);
        } catch (error) {
            console.error('ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
            alert('ä¿å­˜æ ‡ç­¾å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // å…³é—­æ ‡ç­¾ç®¡ç†å™¨ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
    async closeTagManager() {
        const modal = this.chatWindow?.querySelector('#pet-tag-manager');
        if (modal) {
            const sessionId = modal.dataset.sessionId;
            // å…³é—­å‰è‡ªåŠ¨ä¿å­˜
            if (sessionId && this.sessions[sessionId]) {
                try {
                    const session = this.sessions[sessionId];
                    // è§„èŒƒåŒ–æ ‡ç­¾ï¼ˆtrimå¤„ç†ï¼Œå»é‡ï¼Œè¿‡æ»¤ç©ºæ ‡ç­¾ï¼‰
                    if (session.tags && Array.isArray(session.tags)) {
                        const normalizedTags = session.tags
                            .map(tag => tag ? tag.trim() : '')
                            .filter(tag => tag.length > 0);
                        // å»é‡
                        session.tags = [...new Set(normalizedTags)];
                    }
                    session.updatedAt = Date.now();
                    await this.saveAllSessions(false, true);
                    
                    // ç«‹å³åŒæ­¥åˆ°åç«¯ï¼ˆç¡®ä¿æ ‡ç­¾è¢«ä¿å­˜ï¼‰
                    if (PET_CONFIG.api.syncSessionsToBackend && this.sessionApi) {
                        await this.syncSessionToBackend(sessionId, true);
                    }
                    
                    await this.updateSessionSidebar(true);
                } catch (error) {
                    console.error('è‡ªåŠ¨ä¿å­˜æ ‡ç­¾å¤±è´¥:', error);
                }
            }
            
            modal.style.display = 'none';
            
            // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
            const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
            const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
            if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
            if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
            
            const tagInput = modal.querySelector('.tag-manager-input');
            if (tagInput) {
                tagInput.value = '';
            }
        }
    }

    // ç¡®ä¿ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ UI å­˜åœ¨
    ensureContextEditorUi() {
        if (!this.chatWindow) return;
        if (document.getElementById('pet-context-editor')) return;

        const overlay = document.createElement('div');
        overlay.id = 'pet-context-editor';
        // åˆå§‹ä½¿ç”¨é¡¶éƒ¨ä¸é®ä½ chat-header çš„å®šä½ï¼ˆæ ¹æ®å½“å‰ header é«˜åº¦ï¼‰
        const chatHeaderEl = this.chatWindow.querySelector('.chat-header');
        const headerH = chatHeaderEl ? chatHeaderEl.offsetHeight : 60;
        overlay.style.cssText = `
            position: absolute !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            top: ${headerH}px !important;
            background: transparent !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: ${PET_CONFIG.ui.zIndex.inputContainer + 1} !important;
            pointer-events: none !important;
        `;

        const panel = document.createElement('div');
        panel.style.cssText = `
            width: calc(100% - 24px) !important;
            height: calc(100% - 12px) !important;
            margin: 0 12px 12px 12px !important;
            background: #1f1f1f !important;
            color: #fff !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35) !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            min-height: 0 !important;
            pointer-events: auto !important;
        `;

        const header = document.createElement('div');
        header.style.cssText = `
            padding: 10px 14px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            border-bottom: 1px solid rgba(255,255,255,0.08) !important;
            background: rgba(255,255,255,0.04) !important;
        `;
        const title = document.createElement('div');
        title.textContent = 'é¡µé¢ä¸Šä¸‹æ–‡ï¼ˆMarkdownï¼‰';
        title.style.cssText = 'font-weight: 600;';
        const headerBtns = document.createElement('div');
        headerBtns.style.cssText = 'display:flex; gap:8px; align-items:center;';
        // ç®€æ´æ¨¡å¼åˆ‡æ¢ï¼šå¹¶æ’ / ä»…ç¼–è¾‘ / ä»…é¢„è§ˆ
        const modeGroup = document.createElement('div');
        modeGroup.style.cssText = `
            display: inline-flex !important;
            gap: 6px !important;
            background: rgba(255,255,255,0.04) !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
            border-radius: 8px !important;
            padding: 4px !important;
        `;
        const makeModeBtn = (id, label, mode) => {
            const btn = document.createElement('button');
            btn.id = id;
            btn.textContent = label;
            btn.style.cssText = `
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 6px !important;
                border: none !important;
                background: transparent !important;
                color: #e5e7eb !important;
                cursor: pointer !important;
            `;
            btn.addEventListener('click', () => this.setContextMode(mode));
            return btn;
        };
        const btnSplit = makeModeBtn('pet-context-mode-split', 'å¹¶æ’', 'split');
        const btnEdit = makeModeBtn('pet-context-mode-edit', 'ä»…ç¼–è¾‘', 'edit');
        const btnPreview = makeModeBtn('pet-context-mode-preview', 'ä»…é¢„è§ˆ', 'preview');
        modeGroup.appendChild(btnSplit);
        modeGroup.appendChild(btnEdit);
        modeGroup.appendChild(btnPreview);
        const closeBtn = document.createElement('button');
        closeBtn.id = 'pet-context-close-btn';
        closeBtn.className = 'chat-toolbar-btn';
        closeBtn.setAttribute('aria-label', 'å…³é—­ä¸Šä¸‹æ–‡é¢æ¿ (Esc)');
        closeBtn.setAttribute('title', 'å…³é—­ (Esc)');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
            width: 28px !important;
            height: 28px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: transform .12s ease, background .12s ease, border-color .12s ease !important;
            outline: none !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(255,255,255,0.12)';
            closeBtn.style.borderColor = 'rgba(255,255,255,0.25)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(255,255,255,0.04)';
            closeBtn.style.borderColor = 'rgba(255,255,255,0.15)';
        });
        closeBtn.addEventListener('mousedown', () => {
            closeBtn.style.transform = 'scale(0.96)';
        });
        closeBtn.addEventListener('mouseup', () => {
            closeBtn.style.transform = 'scale(1)';
        });
        closeBtn.addEventListener('click', () => this.closeContextEditor());
        headerBtns.appendChild(modeGroup);
        // å¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.id = 'pet-context-copy-btn';
        copyBtn.className = 'chat-toolbar-btn';
        copyBtn.setAttribute('title', 'å¤åˆ¶å†…å®¹');
        copyBtn.textContent = 'å¤åˆ¶';
        copyBtn.style.cssText = `
            padding: 4px 8px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: transform .12s ease, background .12s ease, border-color .12s ease !important;
            outline: none !important;
        `;
        copyBtn.addEventListener('mouseenter', () => {
            copyBtn.style.background = 'rgba(255,255,255,0.12)';
            copyBtn.style.borderColor = 'rgba(255,255,255,0.25)';
        });
        copyBtn.addEventListener('mouseleave', () => {
            copyBtn.style.background = 'rgba(255,255,255,0.04)';
            copyBtn.style.borderColor = 'rgba(255,255,255,0.15)';
        });
        copyBtn.addEventListener('click', () => this.copyContextEditor());
        
        // æ™ºèƒ½ä¼˜åŒ–æŒ‰é’®ç»„
        const optimizeBtnGroup = document.createElement('div');
        optimizeBtnGroup.style.cssText = 'display: flex; gap: 6px; align-items: center;';
        
        const optimizeBtn = document.createElement('button');
        optimizeBtn.id = 'pet-context-optimize-btn';
        optimizeBtn.textContent = 'âœ¨ æ™ºèƒ½ä¼˜åŒ–';
        optimizeBtn.setAttribute('title', 'æ™ºèƒ½ä¼˜åŒ–ä¸Šä¸‹æ–‡å†…å®¹');
        optimizeBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(76, 175, 80, 0.3) !important;
            background: rgba(76, 175, 80, 0.15) !important;
            color: #4caf50 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            transition: all 0.2s !important;
        `;
        optimizeBtn.addEventListener('click', async () => {
            await this.optimizeContext();
        });
        optimizeBtn.addEventListener('mouseenter', () => {
            if (!optimizeBtn.disabled) {
                optimizeBtn.style.background = 'rgba(76, 175, 80, 0.25)';
            }
        });
        optimizeBtn.addEventListener('mouseleave', () => {
            if (!optimizeBtn.disabled) {
                optimizeBtn.style.background = 'rgba(76, 175, 80, 0.15)';
            }
        });
        
        const undoBtn = document.createElement('button');
        undoBtn.id = 'pet-context-undo-btn';
        undoBtn.textContent = 'â†¶ æ’¤é”€';
        undoBtn.setAttribute('title', 'æ’¤é”€ä¼˜åŒ–');
        undoBtn.style.cssText = `
            padding: 4px 12px !important;
            border-radius: 4px !important;
            border: 1px solid rgba(255, 152, 0, 0.3) !important;
            background: rgba(255, 152, 0, 0.15) !important;
            color: #ff9800 !important;
            cursor: pointer !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            display: none !important;
            transition: all 0.2s !important;
        `;
        undoBtn.addEventListener('click', () => {
            const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
            if (textarea) {
                const originalText = textarea.getAttribute('data-original-text');
                if (originalText !== null) {
                    textarea.value = originalText;
                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                    undoBtn.style.display = 'none';
                    this.showNotification('å·²æ’¤é”€ä¼˜åŒ–', 'info');
                }
            }
        });
        undoBtn.addEventListener('mouseenter', () => {
            undoBtn.style.background = 'rgba(255, 152, 0, 0.25)';
        });
        undoBtn.addEventListener('mouseleave', () => {
            undoBtn.style.background = 'rgba(255, 152, 0, 0.15)';
        });
        
        optimizeBtnGroup.appendChild(optimizeBtn);
        optimizeBtnGroup.appendChild(undoBtn);
        
        // æ‹‰å–å½“å‰ç½‘é¡µä¸Šä¸‹æ–‡æŒ‰é’®
        const refreshBtn = document.createElement('button');
        refreshBtn.id = 'pet-context-refresh-btn';
        refreshBtn.className = 'chat-toolbar-btn';
        refreshBtn.setAttribute('title', 'æ‹‰å–å½“å‰ç½‘é¡µä¸Šä¸‹æ–‡');
        refreshBtn.setAttribute('aria-label', 'æ‹‰å–å½“å‰ç½‘é¡µä¸Šä¸‹æ–‡');
        refreshBtn.textContent = 'åˆ·æ–°';
        refreshBtn.style.cssText = `
            padding: 4px 8px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: transform .12s ease, background .12s ease, border-color .12s ease, color .12s ease !important;
            outline: none !important;
        `;
        refreshBtn.addEventListener('mouseenter', () => {
            if (!refreshBtn.hasAttribute('data-refreshing')) {
                refreshBtn.style.background = 'rgba(255,255,255,0.12)';
                refreshBtn.style.borderColor = 'rgba(255,255,255,0.25)';
            }
        });
        refreshBtn.addEventListener('mouseleave', () => {
            if (!refreshBtn.hasAttribute('data-refreshing')) {
                refreshBtn.style.background = 'rgba(255,255,255,0.04)';
                refreshBtn.style.borderColor = 'rgba(255,255,255,0.15)';
            }
        });
        refreshBtn.addEventListener('click', async () => {
            if (refreshBtn.hasAttribute('data-refreshing')) return;
            
            refreshBtn.setAttribute('data-refreshing', 'true');
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = 'æ‹‰å–ä¸­...';
            refreshBtn.style.opacity = '0.6';
            refreshBtn.style.cursor = 'not-allowed';
            
            try {
                await this.refreshContextFromPage();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                refreshBtn.textContent = 'âœ“ å·²æ›´æ–°';
                refreshBtn.style.background = 'rgba(76, 175, 80, 0.2)';
                refreshBtn.style.color = '#4caf50';
                refreshBtn.style.borderColor = 'rgba(76, 175, 80, 0.4)';
                
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.style.background = 'rgba(255,255,255,0.04)';
                    refreshBtn.style.color = '#e5e7eb';
                    refreshBtn.style.borderColor = 'rgba(255,255,255,0.15)';
                    refreshBtn.removeAttribute('data-refreshing');
                    refreshBtn.style.opacity = '1';
                    refreshBtn.style.cursor = 'pointer';
                }, 2000);
            } catch (error) {
                console.error('æ‹‰å–ç½‘é¡µä¸Šä¸‹æ–‡å¤±è´¥:', error);
                
                // æ˜¾ç¤ºå¤±è´¥æç¤º
                refreshBtn.textContent = 'âœ• å¤±è´¥';
                refreshBtn.style.background = 'rgba(244, 67, 54, 0.2)';
                refreshBtn.style.color = '#f44336';
                refreshBtn.style.borderColor = 'rgba(244, 67, 54, 0.4)';
                
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.style.background = 'rgba(255,255,255,0.04)';
                    refreshBtn.style.color = '#e5e7eb';
                    refreshBtn.style.borderColor = 'rgba(255,255,255,0.15)';
                    refreshBtn.removeAttribute('data-refreshing');
                    refreshBtn.style.opacity = '1';
                    refreshBtn.style.cursor = 'pointer';
                }, 2000);
            }
        });
        
        // ä¿å­˜æŒ‰é’®
        const saveBtn = document.createElement('button');
        saveBtn.id = 'pet-context-save-btn';
        saveBtn.className = 'chat-toolbar-btn';
        saveBtn.setAttribute('title', 'ä¿å­˜ä¿®æ”¹ (Ctrl+S / Cmd+S)');
        saveBtn.setAttribute('aria-label', 'ä¿å­˜ä¿®æ”¹');
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 4px 8px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: transform .12s ease, background .12s ease, border-color .12s ease, color .12s ease !important;
            outline: none !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            if (!saveBtn.hasAttribute('data-saving')) {
                saveBtn.style.background = 'rgba(255,255,255,0.12)';
                saveBtn.style.borderColor = 'rgba(255,255,255,0.25)';
            }
        });
        saveBtn.addEventListener('mouseleave', () => {
            if (!saveBtn.hasAttribute('data-saving')) {
                saveBtn.style.background = 'rgba(255,255,255,0.04)';
                saveBtn.style.borderColor = 'rgba(255,255,255,0.15)';
            }
        });
        saveBtn.addEventListener('click', async () => {
            if (saveBtn.hasAttribute('data-saving')) return;
            
            saveBtn.setAttribute('data-saving', 'true');
            const originalText = saveBtn.textContent; // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼ˆåº”è¯¥æ˜¯"ä¿å­˜"ï¼‰
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveBtn.style.opacity = '0.6';
            saveBtn.style.cursor = 'not-allowed';
            
            try {
                const success = await this.saveContextEditor();
                // ä¼ é€’åŸå§‹æ–‡æœ¬ï¼Œç¡®ä¿æ¢å¤æ­£ç¡®
                this._showSaveStatus(saveBtn, success, originalText);
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                // ä¼ é€’åŸå§‹æ–‡æœ¬ï¼Œç¡®ä¿æ¢å¤æ­£ç¡®
                this._showSaveStatus(saveBtn, false, originalText);
            } finally {
                // åœ¨çŠ¶æ€æç¤ºæ˜¾ç¤º2ç§’åï¼Œç§»é™¤ç¦ç”¨çŠ¶æ€
                setTimeout(() => {
                    saveBtn.removeAttribute('data-saving');
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = 'pointer';
                }, 2000);
            }
        });
        
        // ä¸‹è½½æŒ‰é’®ï¼ˆå¯¼å‡º Markdownï¼‰
        const downloadBtn = document.createElement('button');
        downloadBtn.id = 'pet-context-download-btn';
        downloadBtn.className = 'chat-toolbar-btn';
        downloadBtn.setAttribute('title', 'ä¸‹è½½å½“å‰ä¸Šä¸‹æ–‡ä¸º Markdown (.md)');
        downloadBtn.textContent = 'ä¸‹è½½';
        downloadBtn.style.cssText = `
            padding: 4px 8px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
        `;
        downloadBtn.addEventListener('click', () => this.downloadContextMarkdown());
        
        // ç¿»è¯‘æŒ‰é’®ç»„
        const translateBtnGroup = document.createElement('div');
        translateBtnGroup.style.cssText = 'display: flex; gap: 6px; align-items: center;';
        
        // ç¿»è¯‘æˆä¸­æ–‡æŒ‰é’®
        const translateToZhBtn = document.createElement('button');
        translateToZhBtn.id = 'pet-context-translate-zh-btn';
        translateToZhBtn.className = 'chat-toolbar-btn';
        translateToZhBtn.setAttribute('title', 'ç¿»è¯‘æˆä¸­æ–‡');
        translateToZhBtn.textContent = 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡';
        translateToZhBtn.style.cssText = `
            padding: 4px 8px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(33, 150, 243, 0.3) !important;
            background: rgba(33, 150, 243, 0.15) !important;
            color: #2196f3 !important;
            cursor: pointer !important;
            transition: transform .12s ease, background .12s ease, border-color .12s ease !important;
            outline: none !important;
            white-space: nowrap !important;
        `;
        translateToZhBtn.addEventListener('mouseenter', () => {
            if (!translateToZhBtn.hasAttribute('data-translating')) {
                translateToZhBtn.style.background = 'rgba(33, 150, 243, 0.25)';
                translateToZhBtn.style.borderColor = 'rgba(33, 150, 243, 0.4)';
            }
        });
        translateToZhBtn.addEventListener('mouseleave', () => {
            if (!translateToZhBtn.hasAttribute('data-translating')) {
                translateToZhBtn.style.background = 'rgba(33, 150, 243, 0.15)';
                translateToZhBtn.style.borderColor = 'rgba(33, 150, 243, 0.3)';
            }
        });
        translateToZhBtn.addEventListener('click', async () => {
            await this.translateContext('zh');
        });
        
        // ç¿»è¯‘æˆè‹±æ–‡æŒ‰é’®
        const translateToEnBtn = document.createElement('button');
        translateToEnBtn.id = 'pet-context-translate-en-btn';
        translateToEnBtn.className = 'chat-toolbar-btn';
        translateToEnBtn.setAttribute('title', 'ç¿»è¯‘æˆè‹±æ–‡');
        translateToEnBtn.textContent = 'ğŸ‡ºğŸ‡¸ è‹±æ–‡';
        translateToEnBtn.style.cssText = `
            padding: 4px 8px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(156, 39, 176, 0.3) !important;
            background: rgba(156, 39, 176, 0.15) !important;
            color: #9c27b0 !important;
            cursor: pointer !important;
            transition: transform .12s ease, background .12s ease, border-color .12s ease !important;
            outline: none !important;
            white-space: nowrap !important;
        `;
        translateToEnBtn.addEventListener('mouseenter', () => {
            if (!translateToEnBtn.hasAttribute('data-translating')) {
                translateToEnBtn.style.background = 'rgba(156, 39, 176, 0.25)';
                translateToEnBtn.style.borderColor = 'rgba(156, 39, 176, 0.4)';
            }
        });
        translateToEnBtn.addEventListener('mouseleave', () => {
            if (!translateToEnBtn.hasAttribute('data-translating')) {
                translateToEnBtn.style.background = 'rgba(156, 39, 176, 0.15)';
                translateToEnBtn.style.borderColor = 'rgba(156, 39, 176, 0.3)';
            }
        });
        translateToEnBtn.addEventListener('click', async () => {
            await this.translateContext('en');
        });
        
        translateBtnGroup.appendChild(translateToZhBtn);
        translateBtnGroup.appendChild(translateToEnBtn);
        
        headerBtns.appendChild(copyBtn);
        headerBtns.appendChild(optimizeBtnGroup);
        headerBtns.appendChild(translateBtnGroup);
        headerBtns.appendChild(refreshBtn);
        headerBtns.appendChild(saveBtn);
        headerBtns.appendChild(downloadBtn);
        headerBtns.appendChild(closeBtn);
        header.appendChild(title);
        header.appendChild(headerBtns);

        const body = document.createElement('div');
        body.style.cssText = `
            flex: 1 !important;
            display: flex !important;
            padding: 10px !important;
            gap: 10px !important;
            min-height: 0 !important;
        `;
        const textarea = document.createElement('textarea');
        textarea.id = 'pet-context-editor-textarea';
        textarea.style.cssText = `
            flex: 1 !important;
            width: 50% !important;
            height: 100% !important;
            background: #121212 !important;
            color: #fff !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            padding: 12px !important;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace !important;
            font-size: 12px !important;
            line-height: 1.6 !important;
            outline: none !important;
            resize: none !important;
            white-space: pre-wrap !important;
            min-height: 0 !important;
            overflow: auto !important;
            -webkit-overflow-scrolling: touch !important;
        `;
        const preview = document.createElement('div');
        preview.id = 'pet-context-preview';
        preview.className = 'markdown-content'; // æ·»åŠ  markdown-content ç±»ä»¥åº”ç”¨æ ·å¼
        preview.style.cssText = `
            flex: 1 !important;
            width: 50% !important;
            height: 100% !important;
            background: #0e0e0e !important;
            color: #e5e7eb !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            padding: 12px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            -webkit-overflow-scrolling: touch !important;
            pointer-events: auto !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
        `;
        // é˜²æ­¢æ»šåŠ¨äº‹ä»¶å†’æ³¡åˆ°çˆ¶çº§ï¼Œä¿è¯è‡ªèº«æ»šåŠ¨æœ‰æ•ˆ
        preview.addEventListener('wheel', (e) => { e.stopPropagation(); }, { passive: true });
        preview.addEventListener('touchmove', (e) => { e.stopPropagation(); }, { passive: true });
        // ç¼–è¾‘æ—¶å®æ—¶æ›´æ–°é¢„è§ˆï¼ˆé˜²æŠ–ï¼‰
        textarea.addEventListener('input', () => {
            if (this._contextPreviewTimer) clearTimeout(this._contextPreviewTimer);
            this._contextPreviewTimer = setTimeout(() => {
                this.updateContextPreview();
            }, 150);
        });
        // åŒæ­¥æ»šåŠ¨ï¼ˆæ¯”ä¾‹æ˜ å°„ï¼‰
        textarea.addEventListener('scroll', () => {
            const previewEl = this.chatWindow ? this.chatWindow.querySelector('#pet-context-preview') : null;
            if (!previewEl) return;
            const tMax = textarea.scrollHeight - textarea.clientHeight;
            const pMax = previewEl.scrollHeight - previewEl.clientHeight;
            if (tMax > 0 && pMax >= 0) {
                const ratio = textarea.scrollTop / tMax;
                previewEl.scrollTop = ratio * pMax;
            }
        });
        body.appendChild(textarea);
        body.appendChild(preview);

        panel.appendChild(header);
        panel.appendChild(body);
        overlay.appendChild(panel);
        // ç¡®ä¿èŠå¤©çª—å£å®¹å™¨ä¸ºå®šä½ä¸Šä¸‹æ–‡
        const currentPosition = window.getComputedStyle(this.chatWindow).position;
        if (currentPosition === 'static') {
            this.chatWindow.style.position = 'relative';
        }
        this.chatWindow.appendChild(overlay);
    }

    openContextEditor() {
        this.ensureContextEditorUi();
        const overlay = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor') : null;
        if (!overlay) return;
        overlay.style.display = 'flex';
        // æ‰“å¼€æ—¶æ ¹æ®å½“å‰ header é«˜åº¦æ ¡æ­£ä½ç½®
        this.updateContextEditorPosition();
        this.loadContextIntoEditor();
        this.updateContextPreview();
        // éšè—æ’¤é”€æŒ‰é’®ï¼ˆæ‰“å¼€ç¼–è¾‘å™¨æ—¶é‡ç½®çŠ¶æ€ï¼‰
        const undoBtn = this.chatWindow ? this.chatWindow.querySelector('#pet-context-undo-btn') : null;
        if (undoBtn) {
            undoBtn.style.display = 'none';
        }
        // é»˜è®¤å¹¶æ’æ¨¡å¼
        this._contextPreviewMode = this._contextPreviewMode || 'split';
        this.applyContextPreviewMode();
        // éšè—æŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';
        // é”®ç›˜å¿«æ·é”®ï¼šEsc å…³é—­ï¼ŒCtrl+S / Cmd+S ä¿å­˜
        this._contextKeydownHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeContextEditor();
            } else if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const saveBtn = this.chatWindow ? this.chatWindow.querySelector('#pet-context-save-btn') : null;
                if (saveBtn && !saveBtn.hasAttribute('data-saving')) {
                    saveBtn.click();
                }
            }
        };
        document.addEventListener('keydown', this._contextKeydownHandler, { capture: true });
        // ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°è¦†ç›–å±‚ä½ç½®
        this._contextResizeHandler = () => this.updateContextEditorPosition();
        window.addEventListener('resize', this._contextResizeHandler, { passive: true });
    }

    closeContextEditor() {
        const overlay = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor') : null;
        if (overlay) overlay.style.display = 'none';
        
        // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
        if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
        
        if (this._contextKeydownHandler) {
            document.removeEventListener('keydown', this._contextKeydownHandler, { capture: true });
            this._contextKeydownHandler = null;
        }
        if (this._contextResizeHandler) {
            window.removeEventListener('resize', this._contextResizeHandler);
            this._contextResizeHandler = null;
        }
    }

    setContextMode(mode) {
        this._contextPreviewMode = mode; // 'split' | 'edit' | 'preview'
        this.applyContextPreviewMode();
    }

    applyContextPreviewMode() {
        if (!this.chatWindow) return;
        const textarea = this.chatWindow.querySelector('#pet-context-editor-textarea');
        const preview = this.chatWindow.querySelector('#pet-context-preview');
        const btnSplit = this.chatWindow.querySelector('#pet-context-mode-split');
        const btnEdit = this.chatWindow.querySelector('#pet-context-mode-edit');
        const btnPreview = this.chatWindow.querySelector('#pet-context-mode-preview');
        if (!textarea || !preview) return;
        const mode = this._contextPreviewMode;
        const isPreviewOnly = mode === 'preview';
        const isEditOnly = mode === 'edit';
        textarea.style.display = isPreviewOnly ? 'none' : 'block';
        preview.style.display = isEditOnly ? 'none' : 'block';
        textarea.style.width = isEditOnly ? '100%' : (isPreviewOnly ? '0%' : '50%');
        preview.style.width = isPreviewOnly ? '100%' : (isEditOnly ? '0%' : '50%');
        // æ¿€æ´»æ€æ ·å¼æ›´ç®€å•ï¼šå½“å‰æ¨¡å¼é«˜äº®åº•è‰²
        const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
        const resetBtn = (b) => { if (!b) return; b.style.background = 'transparent'; b.style.color = '#e5e7eb'; b.style.border = 'none'; };
        const activateBtn = (b) => { if (!b) return; b.style.background = currentMainColor; b.style.color = '#fff'; b.style.border = 'none'; };
        resetBtn(btnSplit); resetBtn(btnEdit); resetBtn(btnPreview);
        if (mode === 'split') activateBtn(btnSplit);
        if (mode === 'edit') activateBtn(btnEdit);
        if (mode === 'preview') activateBtn(btnPreview);
    }

    // ========== æ¶ˆæ¯ç¼–è¾‘å™¨ï¼ˆç±»ä¼¼ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ï¼‰ ==========
    
    // ç¡®ä¿æ¶ˆæ¯ç¼–è¾‘å™¨ UI å­˜åœ¨
    ensureMessageEditorUi() {
        if (!this.chatWindow) return;
        if (document.getElementById('pet-message-editor')) return;

        const overlay = document.createElement('div');
        overlay.id = 'pet-message-editor';
        const chatHeaderEl = this.chatWindow.querySelector('.chat-header');
        const headerH = chatHeaderEl ? chatHeaderEl.offsetHeight : 60;
        overlay.style.cssText = `
            position: absolute !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            top: ${headerH}px !important;
            background: transparent !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 10002 !important;
            pointer-events: none !important;
        `;

        const panel = document.createElement('div');
        panel.style.cssText = `
            width: calc(100% - 24px) !important;
            height: calc(100% - 12px) !important;
            margin: 0 12px 12px 12px !important;
            background: #1f1f1f !important;
            color: #fff !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35) !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            min-height: 0 !important;
            pointer-events: auto !important;
        `;

        const header = document.createElement('div');
        header.style.cssText = `
            padding: 10px 14px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            border-bottom: 1px solid rgba(255,255,255,0.08) !important;
            background: rgba(255,255,255,0.04) !important;
        `;
        const title = document.createElement('div');
        title.textContent = 'ç¼–è¾‘æ¶ˆæ¯';
        title.style.cssText = 'font-weight: 600;';
        const headerBtns = document.createElement('div');
        headerBtns.style.cssText = 'display:flex; gap:8px; align-items:center;';
        
        // æ¨¡å¼åˆ‡æ¢ï¼šå¹¶æ’ / ä»…ç¼–è¾‘ / ä»…é¢„è§ˆ
        const modeGroup = document.createElement('div');
        modeGroup.style.cssText = `
            display: inline-flex !important;
            gap: 6px !important;
            background: rgba(255,255,255,0.04) !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
            border-radius: 8px !important;
            padding: 4px !important;
        `;
        const makeModeBtn = (id, label, mode) => {
            const btn = document.createElement('button');
            btn.id = id;
            btn.textContent = label;
            btn.style.cssText = `
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 6px !important;
                border: none !important;
                background: transparent !important;
                color: #e5e7eb !important;
                cursor: pointer !important;
            `;
            btn.addEventListener('click', () => this.setMessageEditorMode(mode));
            return btn;
        };
        const btnSplit = makeModeBtn('pet-message-mode-split', 'å¹¶æ’', 'split');
        const btnEdit = makeModeBtn('pet-message-mode-edit', 'ä»…ç¼–è¾‘', 'edit');
        const btnPreview = makeModeBtn('pet-message-mode-preview', 'ä»…é¢„è§ˆ', 'preview');
        modeGroup.appendChild(btnSplit);
        modeGroup.appendChild(btnEdit);
        modeGroup.appendChild(btnPreview);
        
        // ä¿å­˜æŒ‰é’®
        const saveBtn = document.createElement('button');
        saveBtn.id = 'pet-message-save-btn';
        saveBtn.className = 'chat-toolbar-btn';
        saveBtn.setAttribute('title', 'ä¿å­˜ä¿®æ”¹ (Ctrl+S / Cmd+S)');
        saveBtn.setAttribute('aria-label', 'ä¿å­˜ä¿®æ”¹');
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 4px 12px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(76, 175, 80, 0.3) !important;
            color: #4caf50 !important;
            cursor: pointer !important;
        `;
        saveBtn.addEventListener('click', async () => {
            if (saveBtn.hasAttribute('data-saving')) return;
            
            saveBtn.setAttribute('data-saving', 'true');
            const originalText = saveBtn.textContent; // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼ˆåº”è¯¥æ˜¯"ä¿å­˜"ï¼‰
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveBtn.style.opacity = '0.6';
            saveBtn.style.cursor = 'not-allowed';
            
            try {
                const success = await this.saveMessageEditor();
                // ä¼ é€’åŸå§‹æ–‡æœ¬ï¼Œç¡®ä¿æ¢å¤æ­£ç¡®
                this._showSaveStatus(saveBtn, success, originalText);
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                // ä¼ é€’åŸå§‹æ–‡æœ¬ï¼Œç¡®ä¿æ¢å¤æ­£ç¡®
                this._showSaveStatus(saveBtn, false, originalText);
            } finally {
                // åœ¨çŠ¶æ€æç¤ºæ˜¾ç¤º2ç§’åï¼Œç§»é™¤ç¦ç”¨çŠ¶æ€
                setTimeout(() => {
                    saveBtn.removeAttribute('data-saving');
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = 'pointer';
                }, 2000);
            }
        });
        
        // å¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.id = 'pet-message-copy-btn';
        copyBtn.className = 'chat-toolbar-btn';
        copyBtn.setAttribute('title', 'å¤åˆ¶å†…å®¹');
        copyBtn.textContent = 'å¤åˆ¶';
        copyBtn.style.cssText = `
            padding: 4px 8px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: transform .12s ease, background .12s ease, border-color .12s ease !important;
            outline: none !important;
        `;
        copyBtn.addEventListener('mouseenter', () => {
            copyBtn.style.background = 'rgba(255,255,255,0.12)';
            copyBtn.style.borderColor = 'rgba(255,255,255,0.25)';
        });
        copyBtn.addEventListener('mouseleave', () => {
            copyBtn.style.background = 'rgba(255,255,255,0.04)';
            copyBtn.style.borderColor = 'rgba(255,255,255,0.15)';
        });
        copyBtn.addEventListener('click', () => this.copyMessageEditor());
        
        // ä¸‹è½½æŒ‰é’®ï¼ˆå¯¼å‡º Markdownï¼‰
        const downloadBtn = document.createElement('button');
        downloadBtn.id = 'pet-message-download-btn';
        downloadBtn.className = 'chat-toolbar-btn';
        downloadBtn.setAttribute('title', 'ä¸‹è½½ä¸º Markdown (.md)');
        downloadBtn.textContent = 'ä¸‹è½½';
        downloadBtn.style.cssText = `
            padding: 4px 8px !important;
            font-size: 12px !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
        `;
        downloadBtn.addEventListener('click', () => this.downloadMessageMarkdown());
        
        // å–æ¶ˆ/å…³é—­æŒ‰é’®
        const closeBtn = document.createElement('button');
        closeBtn.id = 'pet-message-close-btn';
        closeBtn.className = 'chat-toolbar-btn';
        closeBtn.setAttribute('aria-label', 'å…³é—­ç¼–è¾‘å™¨ (Esc)');
        closeBtn.setAttribute('title', 'å–æ¶ˆ (Esc)');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
            width: 28px !important;
            height: 28px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.04) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: transform .12s ease, background .12s ease, border-color .12s ease !important;
            outline: none !important;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(255,255,255,0.12)';
            closeBtn.style.borderColor = 'rgba(255,255,255,0.25)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(255,255,255,0.04)';
            closeBtn.style.borderColor = 'rgba(255,255,255,0.15)';
        });
        closeBtn.addEventListener('click', () => this.closeMessageEditor());
        
        headerBtns.appendChild(modeGroup);
        headerBtns.appendChild(copyBtn);
        headerBtns.appendChild(downloadBtn);
        headerBtns.appendChild(saveBtn);
        headerBtns.appendChild(closeBtn);
        header.appendChild(title);
        header.appendChild(headerBtns);

        const body = document.createElement('div');
        body.style.cssText = `
            flex: 1 !important;
            display: flex !important;
            padding: 10px !important;
            gap: 10px !important;
            min-height: 0 !important;
        `;
        const textarea = document.createElement('textarea');
        textarea.id = 'pet-message-editor-textarea';
        textarea.style.cssText = `
            flex: 1 !important;
            width: 50% !important;
            height: 100% !important;
            background: #121212 !important;
            color: #fff !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            padding: 12px !important;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace !important;
            font-size: 12px !important;
            line-height: 1.6 !important;
            outline: none !important;
            resize: none !important;
            white-space: pre-wrap !important;
            min-height: 0 !important;
            overflow: auto !important;
            -webkit-overflow-scrolling: touch !important;
        `;
        const preview = document.createElement('div');
        preview.id = 'pet-message-preview';
        preview.className = 'markdown-content';
        preview.style.cssText = `
            flex: 1 !important;
            width: 50% !important;
            height: 100% !important;
            background: #0e0e0e !important;
            color: #e5e7eb !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            padding: 12px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            -webkit-overflow-scrolling: touch !important;
            pointer-events: auto !important;
        `;
        // é˜²æ­¢æ»šåŠ¨äº‹ä»¶å†’æ³¡
        preview.addEventListener('wheel', (e) => { e.stopPropagation(); }, { passive: true });
        preview.addEventListener('touchmove', (e) => { e.stopPropagation(); }, { passive: true });
        
        // ç¼–è¾‘æ—¶å®æ—¶æ›´æ–°é¢„è§ˆï¼ˆé˜²æŠ–ï¼‰
        textarea.addEventListener('input', () => {
            if (this._messagePreviewTimer) clearTimeout(this._messagePreviewTimer);
            this._messagePreviewTimer = setTimeout(() => {
                this.updateMessagePreview();
            }, 150);
        });
        
        // åŒæ­¥æ»šåŠ¨
        textarea.addEventListener('scroll', () => {
            const previewEl = this.chatWindow ? this.chatWindow.querySelector('#pet-message-preview') : null;
            if (!previewEl) return;
            const tMax = textarea.scrollHeight - textarea.clientHeight;
            const pMax = previewEl.scrollHeight - previewEl.clientHeight;
            if (tMax > 0 && pMax >= 0) {
                const ratio = textarea.scrollTop / tMax;
                previewEl.scrollTop = ratio * pMax;
            }
        });
        
        // Ctrl+Enter ä¿å­˜ï¼ŒEsc å…³é—­
        textarea.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                this.saveMessageEditor();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                this.closeMessageEditor();
            }
        });
        
        body.appendChild(textarea);
        body.appendChild(preview);

        panel.appendChild(header);
        panel.appendChild(body);
        overlay.appendChild(panel);
        
        // ç¡®ä¿èŠå¤©çª—å£å®¹å™¨ä¸ºå®šä½ä¸Šä¸‹æ–‡
        const currentPosition = window.getComputedStyle(this.chatWindow).position;
        if (currentPosition === 'static') {
            this.chatWindow.style.position = 'relative';
        }
        this.chatWindow.appendChild(overlay);
    }

    openMessageEditor(messageElement, sender) {
        this.ensureMessageEditorUi();
        const overlay = this.chatWindow ? this.chatWindow.querySelector('#pet-message-editor') : null;
        if (!overlay) return;

        // ä¿å­˜å½“å‰ç¼–è¾‘çš„æ¶ˆæ¯å…ƒç´ å’Œå‘é€è€…
        this._editingMessageElement = messageElement;
        this._editingMessageSender = sender;
        
        // è·å–åŸå§‹å†…å®¹
        let originalText = messageElement.getAttribute('data-original-text') || '';
        if (!originalText) {
            originalText = messageElement.innerText || messageElement.textContent || '';
        }
        
        const textarea = overlay.querySelector('#pet-message-editor-textarea');
        if (textarea) {
            textarea.value = originalText;
        }
        
        overlay.style.display = 'flex';
        this.updateContextEditorPosition(); // å¤ç”¨ä½ç½®æ›´æ–°å‡½æ•°
        this.updateMessagePreview();
        
        // éšè—æŠ˜å æŒ‰é’®ï¼ˆé¿å…åœ¨å¼¹æ¡†ä¸­æ˜¾ç¤ºä¸¤ä¸ªæŠ˜å æŒ‰é’®ï¼‰
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';
        
        // é»˜è®¤å¹¶æ’æ¨¡å¼
        this._messageEditorMode = this._messageEditorMode || 'split';
        this.applyMessageEditorMode();
        
        // é”®ç›˜å¿«æ·é”®ï¼šEsc å…³é—­ï¼ŒCtrl+S / Cmd+S ä¿å­˜
        this._messageKeydownHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeMessageEditor();
            } else if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const saveBtn = this.chatWindow ? this.chatWindow.querySelector('#pet-message-save-btn') : null;
                if (saveBtn && !saveBtn.hasAttribute('data-saving')) {
                    saveBtn.click();
                }
            }
        };
        document.addEventListener('keydown', this._messageKeydownHandler, { capture: true });
        
        // ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–
        this._messageResizeHandler = () => this.updateContextEditorPosition();
        window.addEventListener('resize', this._messageResizeHandler, { passive: true });
        
        // èšç„¦åˆ°æ–‡æœ¬åŒºåŸŸ
        setTimeout(() => {
            if (textarea) {
                textarea.focus();
            }
        }, 100);
    }

    closeMessageEditor() {
        const overlay = this.chatWindow ? this.chatWindow.querySelector('#pet-message-editor') : null;
        if (overlay) overlay.style.display = 'none';
        
        // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
        if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
        
        this._editingMessageElement = null;
        this._editingMessageSender = null;
        
        if (this._messageKeydownHandler) {
            document.removeEventListener('keydown', this._messageKeydownHandler, { capture: true });
            this._messageKeydownHandler = null;
        }
        if (this._messageResizeHandler) {
            window.removeEventListener('resize', this._messageResizeHandler);
            this._messageResizeHandler = null;
        }
        if (this._messagePreviewTimer) {
            clearTimeout(this._messagePreviewTimer);
            this._messagePreviewTimer = null;
        }
    }

    setMessageEditorMode(mode) {
        this._messageEditorMode = mode; // 'split' | 'edit' | 'preview'
        this.applyMessageEditorMode();
    }

    applyMessageEditorMode() {
        if (!this.chatWindow) return;
        const textarea = this.chatWindow.querySelector('#pet-message-editor-textarea');
        const preview = this.chatWindow.querySelector('#pet-message-preview');
        const btnSplit = this.chatWindow.querySelector('#pet-message-mode-split');
        const btnEdit = this.chatWindow.querySelector('#pet-message-mode-edit');
        const btnPreview = this.chatWindow.querySelector('#pet-message-mode-preview');
        if (!textarea || !preview) return;
        
        const mode = this._messageEditorMode;
        const isPreviewOnly = mode === 'preview';
        const isEditOnly = mode === 'edit';
        textarea.style.display = isPreviewOnly ? 'none' : 'block';
        preview.style.display = isEditOnly ? 'none' : 'block';
        textarea.style.width = isEditOnly ? '100%' : (isPreviewOnly ? '0%' : '50%');
        preview.style.width = isPreviewOnly ? '100%' : (isEditOnly ? '0%' : '50%');
        
        // æ¿€æ´»æ€æ ·å¼
        const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
        const resetBtn = (b) => { if (!b) return; b.style.background = 'transparent'; b.style.color = '#e5e7eb'; b.style.border = 'none'; };
        const activateBtn = (b) => { if (!b) return; b.style.background = currentMainColor; b.style.color = '#fff'; b.style.border = 'none'; };
        resetBtn(btnSplit); resetBtn(btnEdit); resetBtn(btnPreview);
        if (mode === 'split') activateBtn(btnSplit);
        if (mode === 'edit') activateBtn(btnEdit);
        if (mode === 'preview') activateBtn(btnPreview);
    }

    updateMessagePreview() {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-message-editor-textarea') : null;
        const preview = this.chatWindow ? this.chatWindow.querySelector('#pet-message-preview') : null;
        if (!textarea || !preview) return;
        
        const markdown = textarea.value || '';
        preview.innerHTML = this.renderMarkdown(markdown);
        
        // æ¸²æŸ“ mermaidï¼ˆè‹¥æœ‰ï¼‰- é˜²æŠ–
        if (preview._mermaidTimer) {
            clearTimeout(preview._mermaidTimer);
            preview._mermaidTimer = null;
        }
        preview._mermaidTimer = setTimeout(async () => {
            await this.processMermaidBlocks(preview);
            preview._mermaidTimer = null;
        }, 200);
    }

    async saveMessageEditor() {
        if (!this._editingMessageElement || !this._editingMessageSender) {
            return false;
        }
        
        const overlay = this.chatWindow ? this.chatWindow.querySelector('#pet-message-editor') : null;
        const textarea = overlay ? overlay.querySelector('#pet-message-editor-textarea') : null;
        if (!textarea) {
            return false;
        }
        
        const newText = textarea.value.trim();
        if (!newText) {
            // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œå…³é—­ç¼–è¾‘å™¨
            this.closeMessageEditor();
            return false;
        }
        
        try {
            const messageElement = this._editingMessageElement;
            const sender = this._editingMessageSender;
            
            // æ›´æ–°æ¶ˆæ¯å†…å®¹
            if (sender === 'pet') {
                // å¯¹äºå® ç‰©æ¶ˆæ¯ï¼Œä½¿ç”¨Markdownæ¸²æŸ“
                const oldText = messageElement.getAttribute('data-original-text') || messageElement.textContent || '';
                messageElement.innerHTML = this.renderMarkdown(newText);
                messageElement.classList.add('markdown-content');
                messageElement.setAttribute('data-original-text', newText);
                
                // æ›´æ–°ä¼šè¯ä¸­å¯¹åº”çš„æ¶ˆæ¯å†…å®¹
                if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                    const session = this.sessions[this.currentSessionId];
                    if (session.messages && Array.isArray(session.messages)) {
                        // æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯å¹¶æ›´æ–°
                        const messageIndex = session.messages.findIndex(msg => 
                            msg.type === 'pet' && 
                            (msg.content === oldText || msg.content.trim() === oldText.trim())
                        );
                        
                        if (messageIndex !== -1) {
                            session.messages[messageIndex].content = newText;
                            session.updatedAt = Date.now();
                            // å¼‚æ­¥ä¿å­˜ä¼šè¯
                            await this.saveAllSessions();
                            console.log(`å·²æ›´æ–°ä¼šè¯ ${this.currentSessionId} ä¸­çš„æ¶ˆæ¯å†…å®¹`);
                        }
                    }
                }
                
                // å¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨
                setTimeout(async () => {
                    try {
                        await this.loadMermaid();
                        const hasMermaidCode = messageElement.querySelector('code.language-mermaid, code.language-mmd, pre code.language-mermaid, pre code.language-mmd, code[class*="mermaid"]');
                        if (hasMermaidCode) {
                            await this.processMermaidBlocks(messageElement);
                        }
                    } catch (error) {
                        console.error('å¤„ç†ç¼–è¾‘åçš„ Mermaid å›¾è¡¨æ—¶å‡ºé”™:', error);
                    }
                }, 200);
            } else {
                // å¯¹äºç”¨æˆ·æ¶ˆæ¯ï¼Œä½¿ç”¨ Markdown æ¸²æŸ“ï¼ˆä¸ pet æ¶ˆæ¯ä¸€è‡´ï¼‰
                const oldText = messageElement.getAttribute('data-original-text') || messageElement.textContent || '';
                messageElement.innerHTML = this.renderMarkdown(newText);
                messageElement.classList.add('markdown-content');
                messageElement.setAttribute('data-original-text', newText);
                
                // å¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨
                setTimeout(async () => {
                    try {
                        await this.loadMermaid();
                        const hasMermaidCode = messageElement.querySelector('code.language-mermaid, code.language-mmd, pre code.language-mermaid, pre code.language-mmd, code[class*="mermaid"]');
                        if (hasMermaidCode) {
                            await this.processMermaidBlocks(messageElement);
                        }
                    } catch (error) {
                        console.error('å¤„ç†ç¼–è¾‘åçš„ Mermaid å›¾è¡¨æ—¶å‡ºé”™:', error);
                    }
                }, 200);
                
                // æ›´æ–°ä¼šè¯ä¸­å¯¹åº”çš„æ¶ˆæ¯å†…å®¹
                if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                    const session = this.sessions[this.currentSessionId];
                    if (session.messages && Array.isArray(session.messages)) {
                        // æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯å¹¶æ›´æ–°
                        const messageIndex = session.messages.findIndex(msg => 
                            msg.type === 'user' && 
                            (msg.content === oldText || msg.content.trim() === oldText.trim())
                        );
                        
                        if (messageIndex !== -1) {
                            session.messages[messageIndex].content = newText;
                            session.updatedAt = Date.now();
                            // å¼‚æ­¥ä¿å­˜ä¼šè¯
                            await this.saveAllSessions();
                            console.log(`å·²æ›´æ–°ä¼šè¯ ${this.currentSessionId} ä¸­çš„ç”¨æˆ·æ¶ˆæ¯å†…å®¹`);
                        }
                    }
                }
            }
            
            messageElement.setAttribute('data-edited', 'true');
            
            // ä¿å­˜åä¸å…³é—­ç¼–è¾‘å™¨ï¼Œå…è®¸ç»§ç»­ç¼–è¾‘
            // æ›´æ–°é¢„è§ˆ
            this.updateMessagePreview();
            
            return true;
        } catch (error) {
            console.error('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', error);
            return false;
        }
    }

    // å¤åˆ¶æ¶ˆæ¯ç¼–è¾‘å™¨å†…å®¹
    copyMessageEditor() {
        const overlay = this.chatWindow ? this.chatWindow.querySelector('#pet-message-editor') : null;
        const textarea = overlay ? overlay.querySelector('#pet-message-editor-textarea') : null;
        if (!textarea) return;
        
        const content = textarea.value || '';
        if (!content.trim()) return;
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        const textArea = document.createElement('textarea');
        textArea.value = content;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸåé¦ˆ
            const copyBtn = overlay ? overlay.querySelector('#pet-message-copy-btn') : null;
            if (copyBtn) {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'å·²å¤åˆ¶';
                copyBtn.style.background = 'rgba(76, 175, 80, 0.3)';
                copyBtn.style.color = '#4caf50';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = 'rgba(255,255,255,0.04)';
                    copyBtn.style.color = '#e5e7eb';
                }, 1500);
            }
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
        }
        
        document.body.removeChild(textArea);
    }

    // ä¸‹è½½æ¶ˆæ¯ç¼–è¾‘å™¨å†…å®¹ä¸º Markdown
    downloadMessageMarkdown() {
        const overlay = this.chatWindow ? this.chatWindow.querySelector('#pet-message-editor') : null;
        const textarea = overlay ? overlay.querySelector('#pet-message-editor-textarea') : null;
        if (!textarea) return;
        
        const content = textarea.value || '';
        if (!content.trim()) return;
        
        // ç”Ÿæˆæ–‡ä»¶åï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        const filename = `message_${stamp}.md`;
        
        try {
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(url);
                if (a.parentNode) a.parentNode.removeChild(a);
            }, 0);
        } catch (e) {
            console.error('ä¸‹è½½å¤±è´¥:', e);
        }
    }

    // ç»Ÿä¸€è·å–è§’è‰²å›¾æ ‡ï¼ˆä¼˜å…ˆè‡ªå®šä¹‰ï¼Œå…¶æ¬¡æŒ‰ actionKey æ˜ å°„ï¼Œæœ€åå…œåº•ï¼‰
    getRoleIcon(roleConfig, allConfigs = null) {
        if (!roleConfig) return 'ğŸ™‚';
        
        // ä¼˜å…ˆä½¿ç”¨é…ç½®ä¸­çš„è‡ªå®šä¹‰å›¾æ ‡
        const icon = roleConfig.icon;
        const custom = icon && typeof icon === 'string' ? icon.trim() : '';
        if (custom) return custom;
        
        // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å›¾æ ‡ï¼Œä»è§’è‰²é…ç½®åˆ—è¡¨ä¸­æŸ¥æ‰¾
        const actionKey = roleConfig.actionKey;
        if (actionKey && allConfigs && Array.isArray(allConfigs)) {
            const foundConfig = allConfigs.find(c => c && c.actionKey === actionKey);
            if (foundConfig && foundConfig.icon && typeof foundConfig.icon === 'string') {
                const foundIcon = foundConfig.icon.trim();
                if (foundIcon) return foundIcon;
            }
        }
        
        // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œè¿”å›é»˜è®¤å›¾æ ‡
        return 'ğŸ™‚';
    }

    // ç»Ÿä¸€è·å–è§’è‰²æ ‡ç­¾/åç§°ï¼ˆä¼˜å…ˆè‡ªå®šä¹‰ï¼Œå…¶æ¬¡ä»è§’è‰²é…ç½®åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼‰
    getRoleLabel(roleConfig, allConfigs = null) {
        if (!roleConfig) return 'è‡ªå®šä¹‰è§’è‰²';
        
        // ä¼˜å…ˆä½¿ç”¨é…ç½®ä¸­çš„è‡ªå®šä¹‰æ ‡ç­¾
        if (roleConfig.label && typeof roleConfig.label === 'string') {
            const label = roleConfig.label.trim();
            if (label) return label;
        }
        
        // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰æ ‡ç­¾ï¼Œä»è§’è‰²é…ç½®åˆ—è¡¨ä¸­æŸ¥æ‰¾
        const actionKey = roleConfig.actionKey;
        if (actionKey && allConfigs && Array.isArray(allConfigs)) {
            const foundConfig = allConfigs.find(c => c && c.actionKey === actionKey);
            if (foundConfig && foundConfig.label && typeof foundConfig.label === 'string') {
                const label = foundConfig.label.trim();
                if (label) return label;
            }
        }
        
        // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨actionKeyä½œä¸ºé»˜è®¤æ ‡ç­¾
        if (actionKey) {
            return actionKey;
        }
        
        return 'è‡ªå®šä¹‰è§’è‰²';
    }

    // ç»Ÿä¸€è·å–è§’è‰²æç¤ºè¯­ï¼ˆç”¨äºæŒ‰é’®çš„ title å±æ€§ï¼Œæ”¯æŒè‡ªå®šä¹‰ï¼‰
    getRoleTooltip(roleConfig) {
        // ä¼˜å…ˆä½¿ç”¨é…ç½®ä¸­çš„è‡ªå®šä¹‰æç¤ºè¯­
        if (roleConfig && roleConfig.tooltip && typeof roleConfig.tooltip === 'string') {
            const tooltip = roleConfig.tooltip.trim();
            if (tooltip) return tooltip;
        }
        
        // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰æç¤ºè¯­ï¼Œä½¿ç”¨æ ‡ç­¾ä½œä¸ºæç¤ºè¯­
        return this.getRoleLabel(roleConfig);
    }

    // ç»Ÿä¸€è·å–è§’è‰²å®Œæ•´ä¿¡æ¯ï¼ˆå›¾æ ‡ã€æ ‡ç­¾ã€æç¤ºè¯­ç­‰ï¼‰
    async getRoleInfoForAction(actionKey) {
        try {
            const configs = await this.getRoleConfigs();
            const cfg = Array.isArray(configs) ? configs.find(c => c && c.actionKey === actionKey) : null;
            
            return {
                icon: this.getRoleIcon(cfg || { actionKey }, configs),
                label: this.getRoleLabel(cfg || { actionKey }, configs),
                tooltip: this.getRoleTooltip(cfg || { actionKey }),
                config: cfg
            };
        } catch (error) {
            console.error('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥:', error);
            // é™çº§å¤„ç†
            const fallbackConfig = { actionKey };
            return {
                icon: this.getRoleIcon(fallbackConfig, null),
                label: this.getRoleLabel(fallbackConfig, null),
                tooltip: this.getRoleTooltip(fallbackConfig),
                config: null
            };
        }
    }

    // æ ¹æ® actionKey ä»è§’è‰²é…ç½®ä¸­è·å–æç¤ºè¯­ï¼ˆå¿…é¡»ä»è§’è‰²é…ç½®ä¸­è·å– promptï¼‰
    async getRolePromptForAction(actionKey, pageInfo) {
        // è·å–è§’è‰²ä¿¡æ¯ï¼ˆå›¾æ ‡ã€æ ‡ç­¾ç­‰ï¼‰
        const roleInfo = await this.getRoleInfoForAction(actionKey);
        const cfg = roleInfo.config;
        
        // æ£€æŸ¥è§’è‰²é…ç½®ä¸­æ˜¯å¦æœ‰ prompt
        if (!cfg || !cfg.prompt || !cfg.prompt.trim()) {
            throw new Error(`è§’è‰² ${actionKey} æœªé…ç½® promptï¼Œè¯·åœ¨è§’è‰²è®¾ç½®ä¸­é…ç½®æç¤ºè¯`);
        }
        
        const pageTitle = pageInfo.title || document.title || 'å½“å‰é¡µé¢';
        const pageUrl = pageInfo.url || window.location.href;
        const pageDescription = pageInfo.description || '';
        const pageContent = pageInfo.content || '';
        
        // æ„å»º userPrompt
        const userPrompt = `é¡µé¢æ ‡é¢˜ï¼š${pageTitle}
é¡µé¢URLï¼š${pageUrl}
${pageDescription ? `é¡µé¢æè¿°ï¼š${pageDescription}` : ''}

é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š
${pageContent || 'æ— å†…å®¹'}

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯è¿›è¡Œåˆ†æå’Œå¤„ç†ã€‚`;
        
        return {
            systemPrompt: cfg.prompt.trim(),
            userPrompt: userPrompt,
            label: roleInfo.label,
            icon: roleInfo.icon
        };
    }

    // é€šç”¨çš„æµå¼ç”Ÿæˆå‡½æ•°ï¼Œæ”¯æŒåŠ¨æ€ systemPrompt å’Œ userPrompt
    async generateContentStream(systemPrompt, userPrompt, onContent, loadingText = 'æ­£åœ¨å¤„ç†...') {
        try {
            console.log('è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆå†…å®¹ï¼ŒsystemPrompté•¿åº¦:', systemPrompt ? systemPrompt.length : 0);
            
            // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel
            );
            
            // è°ƒç”¨å¤§æ¨¡å‹ APIï¼ˆä½¿ç”¨æµå¼æ¥å£ï¼‰
            const apiUrl = PET_CONFIG.api.streamPromptUrl;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            // ä½¿ç”¨é€šç”¨çš„æµå¼å“åº”å¤„ç†
            return await this.processStreamingResponse(response, onContent);
        } catch (error) {
            console.error('ç”Ÿæˆå†…å®¹å¤±è´¥:', error);
            throw error;
        }
    }

    // å°†è§’è‰²è®¾ç½®åº”ç”¨åˆ°æ¬¢è¿æ¶ˆæ¯ä¸‹æ–¹çš„åŠ¨ä½œæŒ‰é’®ï¼ˆæ ¹æ® actionKey åŠ¨æ€æ›´æ–°å›¾æ ‡ã€æ ‡é¢˜å’Œæç¤ºè¯­ï¼‰
    async applyRoleConfigToActionIcon(iconEl, actionKey) {
        try {
            if (!iconEl || !actionKey) return;
            
            // ä½¿ç”¨ç»Ÿä¸€çš„è§’è‰²ä¿¡æ¯è·å–å‡½æ•°
            const roleInfo = await this.getRoleInfoForAction(actionKey);
            
            // æ›´æ–°æŒ‰é’®çš„å›¾æ ‡ã€æ ‡é¢˜å’Œæç¤ºè¯­
            iconEl.innerHTML = roleInfo.icon || iconEl.innerHTML;
            iconEl.title = roleInfo.tooltip;
        } catch (_) { /* å¿½ç•¥å±•ç¤ºæ›´æ–°é”™è¯¯ */ }
    }

    // åˆ›å»ºåŠ¨ä½œæŒ‰é’®ï¼ˆæ ¹æ®è§’è‰²é…ç½®åŠ¨æ€åˆ›å»ºï¼‰
    async createActionButton(actionKey) {
        const button = document.createElement('span');
        button.setAttribute('data-action-key', actionKey);
        
        // ä»è§’è‰²é…ç½®ä¸­åŠ¨æ€è·å–å›¾æ ‡ã€æ ‡ç­¾å’Œæç¤ºè¯­
        try {
            const roleInfo = await this.getRoleInfoForAction(actionKey);
            button.innerHTML = roleInfo.icon || 'ğŸ™‚';
            button.title = roleInfo.tooltip;
        } catch (error) {
            // é™çº§åˆ°é»˜è®¤å€¼
            const fallbackInfo = await this.getRoleInfoForAction(actionKey);
            button.innerHTML = fallbackInfo.icon || 'ğŸ™‚';
            button.title = fallbackInfo.tooltip;
        }
        
        // ç»Ÿä¸€çš„æŒ‰é’®æ ·å¼
        button.style.cssText = `
            padding: 2px !important;
            cursor: pointer !important;
            font-size: 10px !important;
            color: #666 !important;
            font-weight: 300 !important;
            transition: all 0.2s ease !important;
            flex-shrink: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            user-select: none !important;
            width: 18px !important;
            height: 18px !important;
            line-height: 18px !important;
        `;
        
        return button;
    }

    // è·å–æŒ‰è§’è‰²è®¾ç½®åˆ—è¡¨é¡ºåºæ’åˆ—çš„å·²ç»‘å®šè§’è‰²çš„ actionKey åˆ—è¡¨
    // æ­¤æ–¹æ³•ä¸ renderRoleSettingsList() å…±äº«ç›¸åŒçš„é¡ºåºé€»è¾‘
    async getOrderedBoundRoleKeys() {
        const configsRaw = await this.getRoleConfigs();
        const configs = Array.isArray(configsRaw) ? configsRaw : [];
        
        // è¿”å›æ‰€æœ‰æœ‰ actionKey çš„è§’è‰²çš„ actionKeyï¼ˆä¿æŒé…ç½®ä¸­çš„é¡ºåºï¼‰
        const orderedKeys = [];
        const seenKeys = new Set();
        for (const config of configs) {
            if (config && config.actionKey && !seenKeys.has(config.actionKey)) {
                orderedKeys.push(config.actionKey);
                seenKeys.add(config.actionKey);
            }
        }
        
        return orderedKeys;
    }

    // åˆ·æ–°æ¬¢è¿æ¶ˆæ¯æ“ä½œæŒ‰é’®ï¼šæ˜¾ç¤ºè§’è‰²åˆ—è¡¨ä½œä¸ºæŒ‰é’®ï¼ˆè®¾ç½®æŒ‰é’®å·²ç§»åŠ¨åˆ° chat-request-status-button åé¢ï¼‰
    async refreshWelcomeActionButtons() {
        if (!this.chatWindow) return;
        const container = this.chatWindow.querySelector('#pet-welcome-actions');
        if (!container) return;
        
        // é‡å»ºå®¹å™¨
        container.innerHTML = '';
        
        // ç¡®ä¿æŒ‰é’®æ ·å¼å®¹å™¨æ­£ç¡®ï¼ˆæ¨ªå‘æ’åˆ—ï¼‰
        container.style.cssText = `
            display: inline-flex !important;
            align-items: center !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
        `;
        
        // è·å–æ‰€æœ‰è§’è‰²é…ç½®
        const configsRaw = await this.getRoleConfigs();
        
        // ç¡®ä¿ actionIcons å’Œ buttonHandlers å·²åˆå§‹åŒ–
        if (!this.actionIcons) {
            this.actionIcons = {};
        }
        if (!this.buttonHandlers) {
            this.buttonHandlers = {};
        }
        // ç”¨äºå­˜å‚¨æ²¡æœ‰ actionKey çš„è§’è‰²æŒ‰é’®
        if (!this.roleButtonsById) {
            this.roleButtonsById = {};
        }
        
        // å…ˆæ˜¾ç¤ºå·²ç»‘å®šæŒ‰é’®çš„è§’è‰²ï¼ˆæŒ‰æŒ‰é’®é¡ºåºï¼‰
        const orderedKeys = await this.getOrderedBoundRoleKeys();
        const boundRoleIds = new Set();
        
        for (const key of orderedKeys) {
            const config = (configsRaw || []).find(c => c && c.actionKey === key);
            if (config) {
                boundRoleIds.add(config.id);
                
                // åˆ›å»ºè§’è‰²æŒ‰é’®
                let button = this.actionIcons[key];
                if (!button) {
                    button = await this.createActionButton(key);
                    this.actionIcons[key] = button;
                    
                    // åˆ›å»º processing flag å’Œ hover å¤„ç†
                    const processingFlag = { value: false };
                    this.buttonHandlers[key] = {
                        button,
                        processingFlag,
                        hover: {
                            mouseenter: function() {
                                if (!processingFlag.value) {
                                    this.style.fontSize = '12px';
                                    this.style.color = '#333';
                                    this.style.transform = 'scale(1.1)';
                                }
                            },
                            mouseleave: function() {
                                if (!processingFlag.value) {
                                    this.style.fontSize = '10px';
                                    this.style.color = '#666';
                                    this.style.transform = 'scale(1)';
                                }
                            }
                        }
                    };
                    
                    // ç»‘å®š hover äº‹ä»¶
                    button.addEventListener('mouseenter', this.buttonHandlers[key].hover.mouseenter);
                    button.addEventListener('mouseleave', this.buttonHandlers[key].hover.mouseleave);
                    
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    if (!this.buttonHandlers[key].clickHandler) {
                        const clickHandler = this.createRoleButtonHandler(key, button, this.buttonHandlers[key].processingFlag);
                        button.addEventListener('click', clickHandler);
                        this.buttonHandlers[key].clickHandler = clickHandler;
                    }
                }
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºå’Œé…ç½®
                button.style.display = 'inline-flex';
                await this.applyRoleConfigToActionIcon(button, key);
                
                // å¦‚æœæŒ‰é’®å·²ç»åœ¨å®¹å™¨ä¸­ï¼Œä¸è¦é‡å¤æ·»åŠ 
                if (button.parentNode !== container) {
                    container.appendChild(button);
                }
            }
        }
        
        // å†æ˜¾ç¤ºå…¶ä»–è§’è‰²ï¼ˆæ²¡æœ‰ç»‘å®šæŒ‰é’®çš„è§’è‰²ï¼‰ä½œä¸ºå¯ç‚¹å‡»æŒ‰é’®
        const otherRoles = (configsRaw || []).filter(c => c && c.id && !boundRoleIds.has(c.id));
        for (const config of otherRoles) {
            // åˆ›å»ºæˆ–å¤ç”¨è§’è‰²æŒ‰é’®ï¼ˆæ²¡æœ‰ actionKeyï¼Œç‚¹å‡»æ—¶è¯·æ±‚ /prompt æ¥å£ï¼‰
            let button = this.roleButtonsById[config.id];
            if (!button) {
                button = document.createElement('span');
                button.setAttribute('data-role-id', config.id);
                button.style.cssText = `
                    padding: 2px !important;
                    cursor: pointer !important;
                    font-size: 10px !important;
                    color: #666 !important;
                    font-weight: 300 !important;
                    transition: all 0.2s ease !important;
                    flex-shrink: 0 !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    user-select: none !important;
                    width: 18px !important;
                    height: 18px !important;
                    line-height: 18px !important;
                `;
                
                // æ·»åŠ  hover æ•ˆæœ
                button.addEventListener('mouseenter', function() {
                    this.style.fontSize = '12px';
                    this.style.color = '#333';
                    this.style.transform = 'scale(1.1)';
                });
                button.addEventListener('mouseleave', function() {
                    this.style.fontSize = '10px';
                    this.style.color = '#666';
                    this.style.transform = 'scale(1)';
                });
                
                this.roleButtonsById[config.id] = button;
            }
            
            // åˆ›å»º processing flag ç”¨äºé˜²æ­¢é‡å¤ç‚¹å‡»
            if (!this.roleButtonsProcessingFlags) {
                this.roleButtonsProcessingFlags = {};
            }
            if (!this.roleButtonsProcessingFlags[config.id]) {
                this.roleButtonsProcessingFlags[config.id] = { value: false };
            }
            const processingFlag = this.roleButtonsProcessingFlags[config.id];
            
            // ç§»é™¤æ—§çš„ç‚¹å‡»äº‹ä»¶ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹æ¥ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼‰
            // åªæœ‰åœ¨æŒ‰é’®å·²åœ¨ DOM ä¸­æ—¶æ‰éœ€è¦æ›¿æ¢ï¼ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼‰
            if (button.parentNode) {
                const oldButton = button;
                const newButton = oldButton.cloneNode(true);
                oldButton.parentNode.replaceChild(newButton, oldButton);
                button = newButton;
                this.roleButtonsById[config.id] = button;
                
                // é‡æ–°ç»‘å®š hover æ•ˆæœï¼ˆå› ä¸ºå…‹éš†åäº‹ä»¶ç›‘å¬å™¨ä¸¢å¤±äº†ï¼‰
                button.addEventListener('mouseenter', function() {
                    this.style.fontSize = '12px';
                    this.style.color = '#333';
                    this.style.transform = 'scale(1.1)';
                });
                button.addEventListener('mouseleave', function() {
                    this.style.fontSize = '10px';
                    this.style.color = '#666';
                    this.style.transform = 'scale(1)';
                });
            }
            
            // ç‚¹å‡»æ—¶è¯·æ±‚ /prompt æ¥å£ï¼ˆå‚è€ƒ createRoleButtonHandler çš„å®ç°ï¼‰
            // å¯¹äºå·²å­˜åœ¨çš„æŒ‰é’®ï¼Œéœ€è¦å…ˆç§»é™¤æ—§çš„ç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœä¹‹å‰ç»‘å®šè¿‡çš„è¯ï¼‰
            // ä½†ç”±äºæˆ‘ä»¬é€šè¿‡å…‹éš†æ¥ç§»é™¤ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç»‘å®šæ–°äº‹ä»¶å³å¯
            button.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    // å¦‚æœæ˜¯è®¾ç½®æŒ‰é’®æˆ–æ­£åœ¨å¤„ç†ä¸­ï¼Œä¸æ‰§è¡Œ
                    if (processingFlag.value) return;
                    
                    processingFlag.value = true;
                    const originalIcon = button.innerHTML;
                    const originalTitle = button.title;
                    
                    // è·å–æ¶ˆæ¯å®¹å™¨
                    const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
                    if (!messagesContainer) {
                        console.error('æ— æ³•æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
                        processingFlag.value = false;
                        button.innerHTML = originalIcon;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                        return;
                    }
                    
                    // è·å–é¡µé¢ä¿¡æ¯ï¼šä¼˜å…ˆä½¿ç”¨å½“å‰ä¼šè¯ä¿å­˜çš„é¡µé¢ä¸Šä¸‹æ–‡
                    let pageInfo;
                    if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                        const session = this.sessions[this.currentSessionId];
                        pageInfo = {
                            title: session.pageTitle || document.title || 'å½“å‰é¡µé¢',
                            url: session.url || window.location.href,
                            description: session.pageDescription || '',
                            content: session.pageContent || '' // ä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢å†…å®¹
                        };
                    } else {
                        // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ï¼Œä½¿ç”¨å½“å‰é¡µé¢ä¿¡æ¯
                        pageInfo = this.getPageInfo();
                    }
                    
                    // è·å–è§’è‰²é…ç½®ä¿¡æ¯
                    const roleLabel = config.label || 'è‡ªå®šä¹‰è§’è‰²';
                    const roleIcon = this.getRoleIcon(config, configsRaw) || 'ğŸ™‚';
                    const systemPrompt = (config.prompt && config.prompt.trim()) ? config.prompt.trim() : '';
                    
                    // æ„å»ºåŸºç¡€ userPromptï¼ˆé¡µé¢ä¿¡æ¯ï¼‰
                    const pageTitle = pageInfo.title || document.title || 'å½“å‰é¡µé¢';
                    const pageUrl = pageInfo.url || window.location.href;
                    const pageDescription = pageInfo.description || '';
                    const pageContent = pageInfo.content || '';
                    let baseUserPrompt = `é¡µé¢æ ‡é¢˜ï¼š${pageTitle}
é¡µé¢URLï¼š${pageUrl}
${pageDescription ? `é¡µé¢æè¿°ï¼š${pageDescription}` : ''}

é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š
${pageContent || 'æ— å†…å®¹'}

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯è¿›è¡Œåˆ†æå’Œå¤„ç†ã€‚`;
                    
                    // æ„å»ºåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡çš„ fromUser å‚æ•°ï¼ˆä¼šä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢ä¸Šä¸‹æ–‡ï¼‰
                    const fromUser = this.buildFromUserWithContext(baseUserPrompt, roleLabel);
                    
                    // æ‰¾åˆ°æŒ‰é’®æ‰€åœ¨çš„æ¶ˆæ¯å…ƒç´ ï¼ˆå‘ä¸ŠæŸ¥æ‰¾åŒ…å«ç”¨æˆ·æ¶ˆæ¯çš„å…ƒç´ ï¼‰
                    let userMessageDiv = null;
                    let currentElement = button;
                    while (currentElement && currentElement !== messagesContainer) {
                        // æ£€æŸ¥å½“å‰å…ƒç´ æ˜¯å¦åŒ…å« user-bubble
                        if (currentElement.querySelector) {
                            const userBubble = currentElement.querySelector('[data-message-type="user-bubble"]');
                            if (userBubble) {
                                userMessageDiv = currentElement;
                                break;
                            }
                        }
                        // å¦‚æœå½“å‰å…ƒç´ æœ‰ data-message-id å±æ€§ï¼Œä¹Ÿæ£€æŸ¥å®ƒæ˜¯å¦åŒ…å« user-bubbleï¼ˆæ¶ˆæ¯å…ƒç´ æœ‰è¯¥å±æ€§ï¼‰
                        if (currentElement.hasAttribute && currentElement.hasAttribute('data-message-id')) {
                            const userBubble = currentElement.querySelector('[data-message-type="user-bubble"]');
                            if (userBubble) {
                                userMessageDiv = currentElement;
                                break;
                            }
                        }
                        currentElement = currentElement.parentElement;
                    }
                    
                    // åˆ›å»ºæ–°çš„æ¶ˆæ¯ï¼ˆæŒ‰é’®æ“ä½œç”Ÿæˆçš„æ¶ˆæ¯ï¼‰
                    const message = this.createMessageElement('', 'pet');
                    message.setAttribute('data-button-action', 'true'); // æ ‡è®°ä¸ºæŒ‰é’®æ“ä½œç”Ÿæˆ
                    messagesContainer.appendChild(message);
                    const messageText = message.querySelector('[data-message-type="pet-bubble"]');
                    const messageAvatar = message.querySelector('[data-message-type="pet-avatar"]');
                    
                    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                    if (messageAvatar) {
                        messageAvatar.style.animation = 'petTyping 1.2s ease-in-out infinite';
                    }
                    
                    // ä½¿ç”¨è§’è‰²é…ç½®ä¸­çš„å›¾æ ‡æ˜¾ç¤ºåŠ è½½æ–‡æœ¬
                    if (messageText) {
                        messageText.textContent = `${roleIcon} æ­£åœ¨${roleLabel}...`;
                    }
                    
                    try {
                        // ä½¿ç”¨ /prompt æ¥å£ç”Ÿæˆå†…å®¹ï¼ˆéæµå¼ï¼‰
                        console.log('è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆå†…å®¹ï¼Œè§’è‰²:', roleLabel, 'é¡µé¢æ ‡é¢˜:', pageTitle);
                        
                        // åˆ›å»º AbortController ç”¨äºç»ˆæ­¢è¯·æ±‚
                        const abortController = new AbortController();
                        if (this.chatWindow && this.chatWindow._setAbortController) {
                            this.chatWindow._setAbortController(abortController);
                        }
                        if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                            this.chatWindow._updateRequestStatus('loading');
                        }
                        
                        // è®¾ç½®æ ‡å¿—ï¼Œé¿å… prompt è°ƒç”¨åè§¦å‘ä¼šè¯åˆ—è¡¨åˆ·æ–°æ¥å£
                        this.skipSessionListRefresh = true;
                        
                        // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID
                        // å¦‚æœæ‰¾åˆ°äº†ç”¨æˆ·æ¶ˆæ¯å…ƒç´ ï¼Œå°†å…¶ä¼ é€’ç»™ buildPromptPayloadï¼Œä»¥ä¾¿ä»æ­£ç¡®çš„æ¶ˆæ¯ä¸­æå–å›¾ç‰‡
                        const payload = this.buildPromptPayload(
                            systemPrompt,
                            fromUser,
                            this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3'),
                            { messageDiv: userMessageDiv }
                        );
                        
                        const response = await fetch(PET_CONFIG.api.promptUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                            signal: abortController.signal
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                        }
                        
                        // å…ˆè¯»å–å“åº”æ–‡æœ¬ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæµå¼å“åº”ï¼ˆSSEæ ¼å¼ï¼‰
                        const responseText = await response.text();
                        let result;
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                        if (responseText.includes('data: ')) {
                            // å¤„ç†SSEæµå¼å“åº”
                            const lines = responseText.split('\n');
                            let accumulatedData = '';
                            let lastValidData = null;
                            
                            for (const line of lines) {
                                const trimmedLine = line.trim();
                                if (trimmedLine.startsWith('data: ')) {
                                    try {
                                        const dataStr = trimmedLine.substring(6).trim();
                                        if (dataStr === '[DONE]' || dataStr === '') {
                                            continue;
                                        }
                                        
                                        // å°è¯•è§£æJSON
                                        const chunk = JSON.parse(dataStr);
                                        
                                        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                        if (chunk.done === true) {
                                            break;
                                        }
                                        
                                        // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                                        if (chunk.data) {
                                            accumulatedData += chunk.data;
                                        } else if (chunk.content) {
                                            accumulatedData += chunk.content;
                                        } else if (chunk.message && chunk.message.content) {
                                            // Ollamaæ ¼å¼
                                            accumulatedData += chunk.message.content;
                                        } else if (typeof chunk === 'string') {
                                            accumulatedData += chunk;
                                        }
                                        
                                        // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                                        lastValidData = chunk;
                                    } catch (e) {
                                        // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                                        const dataStr = trimmedLine.substring(6).trim();
                                        if (dataStr && dataStr !== '[DONE]') {
                                            accumulatedData += dataStr;
                                        }
                                    }
                                }
                            }
                            
                            // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                            if (accumulatedData || lastValidData) {
                                if (lastValidData && lastValidData.status) {
                                    // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                                    result = {
                                        ...lastValidData,
                                        data: accumulatedData || lastValidData.data || '',
                                        content: accumulatedData || lastValidData.content || ''
                                    };
                                } else {
                                    // å¦åˆ™åˆ›å»ºæ–°çš„ç»“æœå¯¹è±¡
                                    result = {
                                        data: accumulatedData,
                                        content: accumulatedData
                                    };
                                }
                            } else {
                                // å¦‚æœæ— æ³•è§£æSSEæ ¼å¼ï¼Œå°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”
                                try {
                                    result = JSON.parse(responseText);
                                } catch (e) {
                                    throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                                }
                            }
                        } else {
                            // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                            try {
                                result = JSON.parse(responseText);
                            } catch (e) {
                                // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾SSEæ ¼å¼çš„æ•°æ®
                                const sseMatch = responseText.match(/data:\s*({.+?})/s);
                                if (sseMatch) {
                                    result = JSON.parse(sseMatch[1]);
                                } else {
                                    throw new Error(`æ— æ³•è§£æå“åº”: ${responseText.substring(0, 100)}`);
                                }
                            }
                        }
                        
                        // é€‚é…å“åº”æ ¼å¼: {status, msg, data, pagination}
                        let content = '';
                        
                        // ä¼˜å…ˆå°è¯•æå–å†…å®¹ï¼Œä¸ç®¡statuså€¼æ˜¯ä»€ä¹ˆï¼ˆå› ä¸ºå¯èƒ½æœ‰å†…å®¹ä½†statusä¸æ˜¯200ï¼‰
                        if (result.data) {
                            // æå– data å­—æ®µ
                            content = result.data;
                        } else if (result.content) {
                            content = result.content;
                        } else if (result.message && result.message.content) {
                            // Ollamaæ ¼å¼
                            content = result.message.content;
                        } else if (result.message && typeof result.message === 'string') {
                            content = result.message;
                        } else if (typeof result === 'string') {
                            content = result;
                        } else {
                            // æœªçŸ¥æ ¼å¼ï¼Œå°è¯•æå–å¯èƒ½çš„æ–‡æœ¬å†…å®¹
                            content = JSON.stringify(result);
                        }
                        
                        // å¦‚æœæå–åˆ°äº†æœ‰æ•ˆå†…å®¹ï¼Œç›´æ¥ä½¿ç”¨
                        if (content && content.trim()) {
                            // å†…å®¹æå–æˆåŠŸï¼Œç»§ç»­å¤„ç†
                        } else if (result.status !== undefined && result.status !== 200) {
                            // åªæœ‰åœ¨æ˜ç¡®statusä¸æ˜¯200ä¸”æ²¡æœ‰å†…å®¹æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯é”™è¯¯
                            content = result.msg || 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†é”™è¯¯ã€‚';
                            throw new Error(content);
                        } else if (result.msg && !content) {
                            // å¦‚æœæœ‰é”™è¯¯æ¶ˆæ¯ä½†æ²¡æœ‰å†…å®¹ï¼Œä¹Ÿè®¤ä¸ºæ˜¯é”™è¯¯
                            content = result.msg;
                            throw new Error(content);
                        }
                        
                        // åœæ­¢åŠ è½½åŠ¨ç”»
                        if (messageAvatar) {
                            messageAvatar.style.animation = '';
                        }
                        
                        // æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹
                        if (messageText) {
                            // ç¡®ä¿å†…å®¹ä¸ä¸ºç©º
                            if (!content || !content.trim()) {
                                content = 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–åˆ°æœ‰æ•ˆå†…å®¹ã€‚';
                            }
                            messageText.innerHTML = this.renderMarkdown(content);
                            // æ›´æ–°åŸå§‹æ–‡æœ¬ç”¨äºå¤åˆ¶åŠŸèƒ½
                            messageText.setAttribute('data-original-text', content);
                            // æ·»åŠ å¤åˆ¶æŒ‰é’®
                            if (content && content.trim()) {
                                const copyButtonContainer = message.querySelector('[data-copy-button-container]');
                                if (copyButtonContainer) {
                                    this.addCopyButton(copyButtonContainer, messageText);
                                }
                                // æ·»åŠ  try again æŒ‰é’®ï¼ˆä»…å½“ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰
                                const petMessages = Array.from(messagesContainer.children).filter(
                                    child => child.querySelector('[data-message-type="pet-bubble"]')
                                );
                                if (petMessages.length > 1) {
                                    const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                    if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                        this.addTryAgainButton(tryAgainContainer, message);
                                    }
                                }
                                
                                // æ·»åŠ åŠ¨ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬è®¾ç½®æŒ‰é’®ï¼‰
                                await this.addActionButtonsToMessage(message);
                                
                            }
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                        
                        // ç«‹å³ä¿å­˜å® ç‰©å›å¤åˆ°å½“å‰ä¼šè¯
                        this.skipSessionListRefresh = true;
                        if (content && content.trim()) {
                            await this.addMessageToSession('pet', content, null, false);
                        }
                        
                        // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                        await this.saveCurrentSession(false, false);
                        
                        // è¯·æ±‚ç»“æŸåè°ƒç”¨ session/save ä¿å­˜ä¼šè¯åˆ°åç«¯
                        if (this.currentSessionId) {
                            if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                                try {
                                    await this.syncSessionToBackend(this.currentSessionId, true);
                                    console.log(`è§’è‰²æŒ‰é’®æ“ä½œåï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
                                } catch (error) {
                                    console.warn('ä¿å­˜ä¼šè¯åˆ°åç«¯å¤±è´¥:', error);
                                }
                            } else {
                                console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šsessionApi æœªåˆå§‹åŒ–æˆ–åç«¯åŒæ­¥æœªå¯ç”¨');
                            }
                        } else {
                            console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šå½“å‰ä¼šè¯ ID ä¸å­˜åœ¨');
                        }
                        
                        button.innerHTML = 'âœ“';
                        button.style.cursor = 'default';
                        button.style.color = '#4caf50';
                        
                        // 2ç§’åæ¢å¤åˆå§‹çŠ¶æ€ï¼Œå…è®¸å†æ¬¡ç‚¹å‡»
                        setTimeout(() => {
                            button.innerHTML = originalIcon;
                            button.title = originalTitle;
                            button.style.color = '#666';
                            button.style.cursor = 'pointer';
                            button.style.opacity = '1';
                            processingFlag.value = false;
                        }, 2000);
                        
                    } catch (error) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å–æ¶ˆé”™è¯¯
                        const isAbortError = error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ';
                        
                        if (!isAbortError) {
                            console.error(`ç”Ÿæˆ${roleLabel}å¤±è´¥:`, error);
                        }
                        
                        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ˆå–æ¶ˆæ—¶ä¸æ˜¾ç¤ºï¼‰
                        if (!isAbortError && messageText) {
                            const errorMessage = error.message && error.message.includes('HTTP error') 
                                ? `æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼ˆ${error.message}ï¼‰ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚${roleIcon}`
                                : `æŠ±æ­‰ï¼Œæ— æ³•ç”Ÿæˆ"${pageTitle}"çš„${roleLabel}ã€‚${error.message ? `é”™è¯¯ä¿¡æ¯ï¼š${error.message}` : 'æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢åé‡è¯•ã€‚'}${roleIcon}`;
                            messageText.innerHTML = this.renderMarkdown(errorMessage);
                            // æ·»åŠ  try again æŒ‰é’®ï¼ˆä»…å½“ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰
                            const petMessages = Array.from(messagesContainer.children).filter(
                                child => child.querySelector('[data-message-type="pet-bubble"]')
                            );
                            if (petMessages.length > 1) {
                                const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                    this.addTryAgainButton(tryAgainContainer, message);
                                }
                            }
                            
                            // æ·»åŠ åŠ¨ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬è®¾ç½®æŒ‰é’®ï¼‰
                            await this.addActionButtonsToMessage(message);
                            
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        } else if (isAbortError && message) {
                            // è¯·æ±‚è¢«å–æ¶ˆï¼Œç§»é™¤æ¶ˆæ¯
                            message.remove();
                        }
                        
                        if (!isAbortError) {
                            button.innerHTML = 'âœ•';
                            button.style.cursor = 'default';
                            button.style.color = '#f44336';
                            
                            // 1.5ç§’åæ¢å¤åˆå§‹çŠ¶æ€ï¼Œå…è®¸å†æ¬¡ç‚¹å‡»
                            setTimeout(() => {
                                button.innerHTML = originalIcon;
                                button.title = originalTitle;
                                button.style.color = '#666';
                                button.style.cursor = 'pointer';
                                button.style.opacity = '1';
                                processingFlag.value = false;
                            }, 1500);
                        } else {
                            // è¯·æ±‚è¢«å–æ¶ˆï¼Œç«‹å³æ¢å¤çŠ¶æ€
                            button.innerHTML = originalIcon;
                            button.title = originalTitle;
                            button.style.color = '#666';
                            button.style.cursor = 'pointer';
                            button.style.opacity = '1';
                            processingFlag.value = false;
                        }
                    } finally {
                        // ç¡®ä¿è¯·æ±‚çŠ¶æ€æ€»æ˜¯è¢«æ›´æ–°ä¸ºç©ºé—²çŠ¶æ€
                        if (this.chatWindow && this.chatWindow._setAbortController) {
                            this.chatWindow._setAbortController(null);
                        }
                        if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                            this.chatWindow._updateRequestStatus('idle');
                        }
                        // ç¡®ä¿åœæ­¢åŠ è½½åŠ¨ç”»
                        if (messageAvatar) {
                            messageAvatar.style.animation = '';
                        }
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                });
            
            // æ›´æ–°æŒ‰é’®å†…å®¹
            const displayIcon = this.getRoleIcon(config, configsRaw);
            button.innerHTML = displayIcon || 'ğŸ™‚';
            button.title = config.label || '(æœªå‘½å)';
            
            // å¦‚æœæŒ‰é’®å·²ç»åœ¨å®¹å™¨ä¸­ï¼Œä¸è¦é‡å¤æ·»åŠ 
            if (button.parentNode !== container) {
                container.appendChild(button);
            }
        }
        
        // è§’è‰²è®¾ç½®æŒ‰é’®å·²ç§»åŠ¨åˆ° chat-request-status-button åé¢ï¼Œä¸å†æ·»åŠ åˆ°æ¬¢è¿æ¶ˆæ¯å®¹å™¨ä¸­
        
        // æ·»åŠ ä¼å¾®æœºå™¨äººæŒ‰é’®åˆ°æ¬¢è¿æ¶ˆæ¯
        const robotConfigs = await this.getWeWorkRobotConfigs();
        for (const robotConfig of robotConfigs) {
            if (!robotConfig || !robotConfig.webhookUrl) continue;
            
            const robotButton = document.createElement('span');
            robotButton.setAttribute('data-robot-id', robotConfig.id);
            robotButton.style.cssText = `
                padding: 4px !important;
                cursor: pointer !important;
                font-size: 16px !important;
                color: #666 !important;
                font-weight: 300 !important;
                transition: all 0.2s ease !important;
                flex-shrink: 0 !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                user-select: none !important;
                width: 22px !important;
                height: 22px !important;
                line-height: 22px !important;
            `;
            
            robotButton.innerHTML = robotConfig.icon || 'ğŸ¤–';
            robotButton.title = robotConfig.name || 'ä¼å¾®æœºå™¨äºº';
            
            robotButton.addEventListener('mouseenter', function() {
                this.style.fontSize = '18px';
                this.style.color = '#333';
                this.style.transform = 'scale(1.1)';
            });
            robotButton.addEventListener('mouseleave', function() {
                this.style.fontSize = '16px';
                this.style.color = '#666';
                this.style.transform = 'scale(1)';
            });
            
            robotButton.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                // è·å–æ¬¢è¿æ¶ˆæ¯çš„å†…å®¹
                const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
                if (!messagesContainer) return;
                
                const welcomeMessage = messagesContainer.querySelector('[data-welcome-message]');
                if (!welcomeMessage) return;
                
                const messageBubble = welcomeMessage.querySelector('[data-message-type="pet-bubble"]');
                let messageContent = '';
                if (messageBubble) {
                    messageContent = messageBubble.getAttribute('data-original-text') || 
                                   messageBubble.innerText || 
                                   messageBubble.textContent || '';
                }
                
                if (!messageContent || !messageContent.trim()) {
                    this.showNotification('æ¶ˆæ¯å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å‘é€', 'error');
                    return;
                }
                
                const trimmedContent = messageContent.trim();
                const contentLength = trimmedContent.length;
                
                // æ£€æŸ¥å†…å®¹é•¿åº¦é™åˆ¶ï¼ˆ4000å­—ç¬¦ï¼‰
                const MAX_CONTENT_LENGTH = 4000;
                if (contentLength > MAX_CONTENT_LENGTH) {
                    this.showNotification(
                        `æ¶ˆæ¯å†…å®¹è¿‡é•¿ï¼ˆ${contentLength} å­—ç¬¦ï¼‰ï¼Œè¶…è¿‡é™åˆ¶ï¼ˆ${MAX_CONTENT_LENGTH} å­—ç¬¦ï¼‰ï¼Œæ— æ³•å‘é€åˆ°ä¼å¾®æœºå™¨äºº`,
                        'error'
                    );
                    return;
                }
                
                // æ˜¾ç¤ºå‘é€çŠ¶æ€
                const originalIcon = robotButton.innerHTML;
                robotButton.innerHTML = 'â³';
                robotButton.style.color = '#2196F3';
                robotButton.style.cursor = 'default';
                
                try {
                    let finalContent = '';
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ markdown æ ¼å¼
                    if (this.isMarkdownFormat(trimmedContent)) {
                        // å·²ç»æ˜¯ markdown æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                        finalContent = trimmedContent;
                        console.log(`[ä¼å¾®æœºå™¨äºº] å†…å®¹å·²æ˜¯ markdown æ ¼å¼ï¼Œé•¿åº¦: ${finalContent.length}`);
                    } else {
                        // ä¸æ˜¯ markdown æ ¼å¼ï¼Œè½¬æ¢ä¸º markdown
                        console.log('[ä¼å¾®æœºå™¨äºº] å†…å®¹ä¸æ˜¯ markdown æ ¼å¼ï¼Œè½¬æ¢ä¸º markdown...');
                        finalContent = await this.convertToMarkdown(trimmedContent);
                        console.log(`[ä¼å¾®æœºå™¨äºº] è½¬æ¢åé•¿åº¦: ${finalContent.length}`);
                    }
                    
                    // ç¡®ä¿ä¸è¶…è¿‡ 4096 å­—ç¬¦é™åˆ¶ï¼ˆä¼ä¸šå¾®ä¿¡æœºå™¨äººçš„ç¡¬æ€§é™åˆ¶ï¼‰
                    const MAX_MARKDOWN_LENGTH = 4096;
                    if (finalContent.length > MAX_MARKDOWN_LENGTH) {
                        console.warn(`[ä¼å¾®æœºå™¨äºº] è½¬æ¢åé•¿åº¦ ${finalContent.length} è¶…è¿‡ ${MAX_MARKDOWN_LENGTH}ï¼Œè¿›è¡Œæˆªæ–­`);
                        finalContent = this.limitMarkdownLength(finalContent, MAX_MARKDOWN_LENGTH);
                    }
                    
                    // å‘é€åˆ°ä¼å¾®æœºå™¨äºº
                    await this.sendToWeWorkRobot(robotConfig.webhookUrl, finalContent);
                    robotButton.innerHTML = 'âœ“';
                    robotButton.style.color = '#4caf50';
                    this.showNotification(`å·²å‘é€åˆ° ${robotConfig.name || 'ä¼å¾®æœºå™¨äºº'}`, 'success');
                    
                    setTimeout(() => {
                        robotButton.innerHTML = originalIcon;
                        robotButton.style.color = '#666';
                        robotButton.style.cursor = 'pointer';
                    }, 2000);
                } catch (error) {
                    console.error('å‘é€åˆ°ä¼å¾®æœºå™¨äººå¤±è´¥:', error);
                    robotButton.innerHTML = 'âœ•';
                    robotButton.style.color = '#f44336';
                    this.showNotification(`å‘é€å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    
                    setTimeout(() => {
                        robotButton.innerHTML = originalIcon;
                        robotButton.style.color = '#666';
                        robotButton.style.cursor = 'pointer';
                    }, 2000);
                }
            });
            
            container.appendChild(robotButton);
        }
    }
    
    // ä¸ºæ¶ˆæ¯æ·»åŠ åŠ¨ä½œæŒ‰é’®ï¼ˆå¤åˆ¶æ¬¢è¿æ¶ˆæ¯çš„æŒ‰é’®ï¼Œè®¾ç½®æŒ‰é’®å·²ç§»åŠ¨åˆ° chat-request-status-button åé¢ï¼‰
    async addActionButtonsToMessage(messageDiv, forceRefresh = false) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ¬¢è¿æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ·»åŠ ï¼ˆå› ä¸ºå®ƒå·²ç»æœ‰æŒ‰é’®äº†ï¼‰
        const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
        if (!messagesContainer) return;
        
        // æ£€æŸ¥å½“å‰æ¶ˆæ¯æ˜¯å¦æ˜¯æ¬¢è¿æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡ï¼ˆæ¬¢è¿æ¶ˆæ¯å·²ç»æœ‰æŒ‰é’®äº†ï¼‰
        const isWelcome = messageDiv.hasAttribute('data-welcome-message');
        if (isWelcome) return;
        
        // è·å–æ—¶é—´å®¹å™¨ï¼ˆéœ€è¦åœ¨æ—©æœŸè·å–ï¼Œå› ä¸ºåç»­é€»è¾‘éœ€è¦ä½¿ç”¨ï¼‰
        let timeAndCopyContainer = messageDiv.querySelector('[data-message-time]')?.parentElement?.parentElement;
        // å¦‚æœæ—¶é—´å®¹å™¨ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ¶ˆæ¯ç»“æ„è¿˜æ²¡å‡†å¤‡å¥½ï¼Œå°è¯•ç­‰å¾…ä¸€ä¸‹
        if (!timeAndCopyContainer) {
            // ç­‰å¾…æ¶ˆæ¯ç»“æ„å®Œå…¨å‡†å¤‡å¥½ï¼ˆæœ€å¤šç­‰å¾…500msï¼‰
            for (let i = 0; i < 5; i++) {
                await new Promise(resolve => setTimeout(resolve, 100));
                timeAndCopyContainer = messageDiv.querySelector('[data-message-time]')?.parentElement?.parentElement;
                if (timeAndCopyContainer) break;
            }
        }
        
        // å¦‚æœå¼ºåˆ¶åˆ·æ–°ï¼Œå…ˆç§»é™¤ç°æœ‰æŒ‰é’®å®¹å™¨
        const existingContainer = messageDiv.querySelector('[data-message-actions]');
        const isUserMessage = messageDiv.querySelector('[data-message-type="user-bubble"]');
        
        // å¯¹äºç”¨æˆ·æ¶ˆæ¯ï¼Œå¦‚æœæ‰¾ä¸åˆ°timeAndCopyContainerï¼Œå°è¯•ç›´æ¥ä»messageDivæŸ¥æ‰¾copyButtonContainer
        let copyButtonContainer = null;
        if (timeAndCopyContainer) {
            copyButtonContainer = timeAndCopyContainer.querySelector('[data-copy-button-container]');
        } else if (isUserMessage) {
            // ç”¨æˆ·æ¶ˆæ¯ï¼šç›´æ¥ä»messageDivæŸ¥æ‰¾copyButtonContainer
            copyButtonContainer = messageDiv.querySelector('[data-copy-button-container]');
            // å¦‚æœæ‰¾åˆ°äº†copyButtonContainerï¼Œå°è¯•æ‰¾åˆ°å®ƒçš„çˆ¶å®¹å™¨ä½œä¸ºtimeAndCopyContainer
            if (copyButtonContainer && copyButtonContainer.parentElement) {
                timeAndCopyContainer = copyButtonContainer.parentElement;
            }
        }
        
        // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°timeAndCopyContainerï¼ˆä¸”ä¸æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼‰ï¼Œåˆ™è¿”å›
        if (!timeAndCopyContainer && !isUserMessage) {
            console.warn('æ— æ³•æ‰¾åˆ°æ¶ˆæ¯æ—¶é—´å®¹å™¨ï¼ŒæŒ‰é’®æ·»åŠ å¤±è´¥');
            return;
        }
        
        // å¯¹äºç”¨æˆ·æ¶ˆæ¯ï¼Œå¦‚æœä»ç„¶æ‰¾ä¸åˆ°copyButtonContainerï¼Œå°è¯•åˆ›å»ºå®ƒ
        if (isUserMessage && !copyButtonContainer) {
            // å°è¯•æ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯çš„contentå®¹å™¨
            const content = messageDiv.querySelector('div[style*="flex: 1"]') || 
                           messageDiv.querySelector('div:last-child');
            if (content) {
                // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰timeAndCopyContainer
                let existingTimeAndCopyContainer = content.querySelector('div[style*="justify-content: space-between"]');
                if (!existingTimeAndCopyContainer) {
                    // åˆ›å»ºtimeAndCopyContainer
                    existingTimeAndCopyContainer = document.createElement('div');
                    existingTimeAndCopyContainer.style.cssText = `
                        display: flex !important;
                        align-items: center !important;
                        justify-content: space-between !important;
                        max-width: 80% !important;
                        width: 100% !important;
                        margin-top: 4px !important;
                        margin-left: auto !important;
                        box-sizing: border-box !important;
                    `;
                    content.appendChild(existingTimeAndCopyContainer);
                }
                timeAndCopyContainer = existingTimeAndCopyContainer;
                
                // åˆ›å»ºcopyButtonContainer
                copyButtonContainer = document.createElement('div');
                copyButtonContainer.setAttribute('data-copy-button-container', 'true');
                copyButtonContainer.style.cssText = 'display: flex;';
                timeAndCopyContainer.insertBefore(copyButtonContainer, timeAndCopyContainer.firstChild);
            }
        }
        
        if (forceRefresh && existingContainer) {
            // å¯¹äºç”¨æˆ·æ¶ˆæ¯ï¼Œå¦‚æœæŒ‰é’®å·²ç»åœ¨ copyButtonContainer å†…éƒ¨ï¼Œéœ€è¦ç§»é™¤å®ƒä»¬
            if (isUserMessage && copyButtonContainer) {
                // æŸ¥æ‰¾æ‰€æœ‰å¸¦æœ‰ data-action-key æˆ–å…¶ä»–æ ‡è¯†çš„æŒ‰é’®ï¼ˆè§’è‰²æŒ‰é’®ç­‰ï¼‰
                // è¿™äº›æŒ‰é’®å¯èƒ½æ˜¯ä¹‹å‰æ·»åŠ çš„ï¼Œéœ€è¦ç§»é™¤
                const actionButtons = copyButtonContainer.querySelectorAll('[data-action-key], [data-robot-id]');
                actionButtons.forEach(btn => btn.remove());
            }
            existingContainer.remove();
        } else if (existingContainer) {
            // å¦‚æœæŒ‰é’®å®¹å™¨å­˜åœ¨ä½†æ²¡æœ‰æŒ‰é’®ï¼ˆå­å…ƒç´ ä¸ºç©ºï¼‰ï¼Œå¼ºåˆ¶åˆ·æ–°
            if (existingContainer.children.length === 0) {
                existingContainer.remove();
                // ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘æ·»åŠ æŒ‰é’®
            } else {
                // å¯¹äºç”¨æˆ·æ¶ˆæ¯ï¼Œå¦‚æœæŒ‰é’®å®¹å™¨ä¸åœ¨ copyButtonContainer å†…éƒ¨ï¼Œéœ€è¦ç§»åŠ¨
                if (isUserMessage && copyButtonContainer) {
                    // å°†æŒ‰é’®ç§»åŠ¨åˆ° copyButtonContainer å†…éƒ¨
                    while (existingContainer.firstChild) {
                        copyButtonContainer.appendChild(existingContainer.firstChild);
                    }
                    existingContainer.remove();
                    // ç¡®ä¿ copyButtonContainer ä½¿ç”¨ flex å¸ƒå±€ï¼Œä¿ç•™åŸæœ‰æ ·å¼
                    if (!copyButtonContainer.style.display || copyButtonContainer.style.display === 'none') {
                        copyButtonContainer.style.display = 'flex';
                    }
                    copyButtonContainer.style.alignItems = 'center';
                    copyButtonContainer.style.gap = '8px';
                } else {
                    // å® ç‰©æ¶ˆæ¯ï¼šå¦‚æœå·²ç»æœ‰æŒ‰é’®å®¹å™¨ä¸”ä¸å¼ºåˆ¶åˆ·æ–°ï¼Œåˆ™éœ€è¦ç¡®ä¿å®ƒåœ¨ç¼–è¾‘æŒ‰é’®ä¹‹å‰
                    if (copyButtonContainer && existingContainer.nextSibling !== copyButtonContainer) {
                        // å¦‚æœé¡ºåºä¸å¯¹ï¼Œé‡æ–°æ’å…¥åˆ°æ­£ç¡®ä½ç½®
                        timeAndCopyContainer.insertBefore(existingContainer, copyButtonContainer);
                    }
                }
                return;
            }
        }
        
        // è·å–æ¬¢è¿æ¶ˆæ¯çš„æŒ‰é’®å®¹å™¨
        const welcomeActions = this.chatWindow.querySelector('#pet-welcome-actions');
        // å³ä½¿ welcomeActions ä¸å­˜åœ¨ï¼Œä¹Ÿå°è¯•ä»è§’è‰²é…ç½®åˆ›å»ºæŒ‰é’®
        // if (!welcomeActions) return;
        
        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const actionsContainer = document.createElement('div');
        actionsContainer.setAttribute('data-message-actions', 'true');
        
        // æ£€æŸ¥æ˜¯ç”¨æˆ·æ¶ˆæ¯è¿˜æ˜¯å® ç‰©æ¶ˆæ¯ï¼Œè®¾ç½®ä¸åŒçš„æ ·å¼
        // isUserMessage å·²åœ¨å‡½æ•°å¼€å§‹å¤„å£°æ˜
        if (isUserMessage) {
            // ç”¨æˆ·æ¶ˆæ¯ï¼šæŒ‰é’®å®¹å™¨ç´§è·Ÿåœ¨å…¶ä»–æŒ‰é’®åé¢ï¼Œä¸éœ€è¦å·¦è¾¹è·
            actionsContainer.style.cssText = `
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                flex-shrink: 0 !important;
                margin-left: 4px !important;
            `;
        } else {
            // å® ç‰©æ¶ˆæ¯ï¼šä¿æŒåŸæœ‰æ ·å¼
            actionsContainer.style.cssText = `
                display: inline-flex !important;
                align-items: center !important;
                gap: 8px !important;
                flex-shrink: 0 !important;
                margin-left: 8px !important;
            `;
        }
        
        // è·å–æ‰€æœ‰è§’è‰²é…ç½®ï¼ˆç”¨äºæ²¡æœ‰ actionKey çš„æŒ‰é’®ï¼‰
        const configsRaw = await this.getRoleConfigs();
        
        // è·å–å·²ç»‘å®šçš„è§’è‰²é”®ï¼Œç”¨äºæ£€æŸ¥å“ªäº›è§’è‰²å·²ç»æœ‰æŒ‰é’®
        const orderedKeys = await this.getOrderedBoundRoleKeys();
        const boundRoleIds = new Set();
        const configsByActionKey = {};
        const configsById = {};
        
        for (const config of (configsRaw || [])) {
            if (config && config.id) {
                configsById[config.id] = config;
                if (config.actionKey) {
                    configsByActionKey[config.actionKey] = config;
                    if (orderedKeys.includes(config.actionKey)) {
                        boundRoleIds.add(config.id);
                    }
                }
            }
        }
        
        // å¤åˆ¶æ¬¢è¿æ¶ˆæ¯ä¸­çš„æ‰€æœ‰æŒ‰é’®ï¼ˆåŒ…æ‹¬è®¾ç½®æŒ‰é’®ï¼‰
        const buttonsToCopy = welcomeActions ? Array.from(welcomeActions.children) : [];
        const copiedButtonIds = new Set(); // è®°å½•å·²å¤åˆ¶çš„æŒ‰é’®ID
        
        for (const originalButton of buttonsToCopy) {
            // åˆ›å»ºæ–°æŒ‰é’®ï¼ˆé€šè¿‡å…‹éš†å¹¶é‡æ–°ç»‘å®šäº‹ä»¶ï¼‰
            const newButton = originalButton.cloneNode(true);
            
            // å¦‚æœæ˜¯è®¾ç½®æŒ‰é’®ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶
            if (newButton.innerHTML.trim() === 'âš™ï¸' || newButton.innerHTML.trim() === 'ğŸ‘¤' || newButton.title === 'è§’è‰²è®¾ç½®') {
                newButton.innerHTML = 'ğŸ‘¤';
                newButton.title = 'è§’è‰²è®¾ç½®';
                newButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.openRoleSettingsModal();
                });
                actionsContainer.appendChild(newButton);
                continue;
            } else if (newButton.hasAttribute('data-action-key')) {
                // å¦‚æœæ˜¯è§’è‰²æŒ‰é’®ï¼ˆæœ‰ actionKeyï¼‰ï¼Œåˆ›å»ºä½¿ç”¨æ¶ˆæ¯å†…å®¹çš„å¤„ç†å‡½æ•°
                const actionKey = newButton.getAttribute('data-action-key');
                const config = configsByActionKey[actionKey];
                if (config && config.id) {
                    copiedButtonIds.add(config.id);
                }
                
                // ä¸ºæ¶ˆæ¯ä¸‹çš„æŒ‰é’®åˆ›å»ºç‰¹æ®Šçš„å¤„ç†å‡½æ•°ï¼ˆä½¿ç”¨æ¶ˆæ¯å†…å®¹è€Œä¸æ˜¯é¡µé¢å†…å®¹ï¼‰
                newButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    // è·å–å½“å‰æ¶ˆæ¯çš„å†…å®¹ï¼ˆæ ¹æ®æ¶ˆæ¯ç±»å‹é€‰æ‹©æ­£ç¡®çš„å…ƒç´ ï¼‰
                    let messageBubble = null;
                    if (isUserMessage) {
                        // ç”¨æˆ·æ¶ˆæ¯ï¼šä» user-bubble è·å–å†…å®¹
                        messageBubble = messageDiv.querySelector('[data-message-type="user-bubble"]');
                    } else {
                        // å® ç‰©æ¶ˆæ¯ï¼šä» pet-bubble è·å–å†…å®¹
                        messageBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]');
                    }
                    let messageContent = '';
                    if (messageBubble) {
                        // ä¼˜å…ˆä½¿ç”¨ data-original-textï¼ˆåŸå§‹æ–‡æœ¬ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ–‡æœ¬å†…å®¹
                        messageContent = messageBubble.getAttribute('data-original-text') || 
                                       messageBubble.innerText || 
                                       messageBubble.textContent || '';
                    }
                    
                    // è·å–è§’è‰²ä¿¡æ¯
                    const pageInfo = this.getPageInfo(); // ä¿ç•™ç”¨äºè·å–è§’è‰²é…ç½®ï¼Œä½†ä¸ç”¨äº userPrompt
                    let roleInfo;
                    try {
                        roleInfo = await this.getRolePromptForAction(actionKey, pageInfo);
                    } catch (error) {
                        console.error('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥:', error);
                        roleInfo = {
                            systemPrompt: '',
                            userPrompt: '',
                            label: 'è‡ªå®šä¹‰è§’è‰²',
                            icon: 'ğŸ™‚'
                        };
                    }
                    
                    // æ£€æŸ¥é¡µé¢ä¸Šä¸‹æ–‡å¼€å…³çŠ¶æ€
                    let includeContext = true; // é»˜è®¤åŒ…å«ä¸Šä¸‹æ–‡
                    const contextSwitch = this.chatWindow ? this.chatWindow.querySelector('#context-switch') : null;
                    if (contextSwitch) {
                        includeContext = contextSwitch.checked;
                    }
                    
                    // æ„å»º fromUserï¼šä»¥å½“å‰æ¶ˆæ¯å†…å®¹ä¸ºä¸»ï¼ŒåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡
                    const baseMessageContent = messageContent.trim() || 'æ— å†…å®¹';
                    let fromUser = baseMessageContent;
                    
                    // å¦‚æœæ²¡æœ‰å¼€å¯é¡µé¢ä¸Šä¸‹æ–‡ï¼Œç›´æ¥ä½¿ç”¨æ¶ˆæ¯å†…å®¹
                    if (!includeContext) {
                        fromUser = baseMessageContent;
                    } else {
                    // è·å–ä¼šè¯ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                    const context = this.buildConversationContext();
                    
                    // å¦‚æœå­˜åœ¨ä¼šè¯å†å²ï¼Œåœ¨æ¶ˆæ¯å†…å®¹å‰æ·»åŠ ä¸Šä¸‹æ–‡
                    if (context.hasHistory && context.messages.length > 0) {
                        // æ„å»ºæ¶ˆæ¯å†å²ä¸Šä¸‹æ–‡ï¼ˆåªåŒ…å«å½“å‰æ¶ˆæ¯ä¹‹å‰çš„å†å²ï¼‰
                        let conversationContext = '\n\n## ä¼šè¯å†å²ï¼š\n\n';
                        context.messages.forEach((msg) => {
                            const role = msg.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                            const content = msg.content.trim();
                            if (content && content !== baseMessageContent) { // æ’é™¤å½“å‰æ¶ˆæ¯æœ¬èº«
                                conversationContext += `${role}ï¼š${content}\n\n`;
                            }
                        });
                        // å°†ä¸Šä¸‹æ–‡æ”¾åœ¨å‰é¢ï¼Œå½“å‰æ¶ˆæ¯å†…å®¹æ”¾åœ¨åé¢
                        fromUser = conversationContext + `## å½“å‰éœ€è¦å¤„ç†çš„æ¶ˆæ¯ï¼š\n\n${baseMessageContent}`;
                    }
                    
                    // å¦‚æœæœ‰é¡µé¢å†…å®¹ä¸”è§’è‰²æç¤ºè¯åŒ…å«é¡µé¢å†…å®¹ï¼Œä¹Ÿæ·»åŠ é¡µé¢å†…å®¹
                    if (context.pageContent && roleInfo.userPrompt && roleInfo.userPrompt.includes('é¡µé¢å†…å®¹')) {
                        fromUser += `\n\n## é¡µé¢å†…å®¹ï¼š\n\n${context.pageContent}`;
                        }
                    }
                    
                    // è·å–æ¶ˆæ¯å®¹å™¨
                    const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
                    if (!messagesContainer) {
                        console.error('æ— æ³•æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
                        return;
                    }
                    
                    // åˆ›å»ºæ–°çš„æ¶ˆæ¯
                    const message = this.createMessageElement('', 'pet');
                    message.setAttribute('data-button-action', 'true');
                    messagesContainer.appendChild(message);
                    const messageText = message.querySelector('[data-message-type="pet-bubble"]');
                    const messageAvatar = message.querySelector('[data-message-type="pet-avatar"]');
                    
                    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                    if (messageAvatar) {
                        messageAvatar.style.animation = 'petTyping 1.2s ease-in-out infinite';
                    }
                    const loadingIcon = roleInfo.icon || 'ğŸ“–';
                    if (messageText) {
                        messageText.textContent = `${loadingIcon} æ­£åœ¨${roleInfo.label || 'å¤„ç†'}...`;
                    }
                    
                    try {
                        // åˆ›å»º AbortController ç”¨äºç»ˆæ­¢è¯·æ±‚
                        const abortController = new AbortController();
                        if (this.chatWindow && this.chatWindow._setAbortController) {
                            this.chatWindow._setAbortController(abortController);
                        }
                        if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                            this.chatWindow._updateRequestStatus('loading');
                        }
                        
                        // è®¾ç½®æ ‡å¿—ï¼Œé¿å… prompt è°ƒç”¨åè§¦å‘ä¼šè¯åˆ—è¡¨åˆ·æ–°æ¥å£
                        this.skipSessionListRefresh = true;
                        
                        // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID
                        // ä¼ é€’ messageDivï¼Œä»¥ä¾¿ä»å¯¹åº”çš„æ¶ˆæ¯å¯¹è±¡ä¸­è·å– imageDataUrl
                        const payload = this.buildPromptPayload(
                            roleInfo.systemPrompt,
                            fromUser,
                            this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3'),
                            { messageDiv: messageDiv }
                        );
                        
                        const response = await fetch(PET_CONFIG.api.promptUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                            signal: abortController.signal
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                        }
                        
                        // å…ˆè¯»å–å“åº”æ–‡æœ¬ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæµå¼å“åº”ï¼ˆSSEæ ¼å¼ï¼‰
                        const responseText = await response.text();
                        let result;
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                        if (responseText.includes('data: ')) {
                            // å¤„ç†SSEæµå¼å“åº”
                            const lines = responseText.split('\n');
                            let accumulatedData = '';
                            let lastValidData = null;
                            
                            for (const line of lines) {
                                const trimmedLine = line.trim();
                                if (trimmedLine.startsWith('data: ')) {
                                    try {
                                        const dataStr = trimmedLine.substring(6).trim();
                                        if (dataStr === '[DONE]' || dataStr === '') {
                                            continue;
                                        }
                                        
                                        // å°è¯•è§£æJSON
                                        const chunk = JSON.parse(dataStr);
                                        
                                        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                        if (chunk.done === true) {
                                            break;
                                        }
                                        
                                        // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                                        if (chunk.data) {
                                            accumulatedData += chunk.data;
                                        } else if (chunk.content) {
                                            accumulatedData += chunk.content;
                                        } else if (chunk.message && chunk.message.content) {
                                            // Ollamaæ ¼å¼
                                            accumulatedData += chunk.message.content;
                                        } else if (typeof chunk === 'string') {
                                            accumulatedData += chunk;
                                        }
                                        
                                        // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                                        lastValidData = chunk;
                                    } catch (e) {
                                        // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                                        const dataStr = trimmedLine.substring(6).trim();
                                        if (dataStr && dataStr !== '[DONE]') {
                                            accumulatedData += dataStr;
                                        }
                                    }
                                }
                            }
                            
                            // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                            if (accumulatedData || lastValidData) {
                                if (lastValidData && lastValidData.status) {
                                    result = {
                                        ...lastValidData,
                                        data: accumulatedData || lastValidData.data || '',
                                        content: accumulatedData || lastValidData.content || ''
                                    };
                                } else {
                                    result = {
                                        data: accumulatedData,
                                        content: accumulatedData
                                    };
                                }
                            } else {
                                try {
                                    result = JSON.parse(responseText);
                                } catch (e) {
                                    throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                                }
                            }
                        } else {
                            // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                            try {
                                result = JSON.parse(responseText);
                            } catch (e) {
                                const sseMatch = responseText.match(/data:\s*({.+?})/s);
                                if (sseMatch) {
                                    result = JSON.parse(sseMatch[1]);
                                } else {
                                    throw new Error(`æ— æ³•è§£æå“åº”: ${responseText.substring(0, 100)}`);
                                }
                            }
                        }
                        
                        // é€‚é…å“åº”æ ¼å¼
                        let content = '';
                        if (result.data) {
                            content = result.data;
                        } else if (result.content) {
                            content = result.content;
                        } else if (result.message && result.message.content) {
                            content = result.message.content;
                        } else if (result.message && typeof result.message === 'string') {
                            content = result.message;
                        } else if (typeof result === 'string') {
                            content = result;
                        } else {
                            content = JSON.stringify(result);
                        }
                        
                        // å¦‚æœæå–åˆ°äº†æœ‰æ•ˆå†…å®¹ï¼Œç›´æ¥ä½¿ç”¨
                        if (content && content.trim()) {
                            // å†…å®¹æå–æˆåŠŸï¼Œç»§ç»­å¤„ç†
                        } else if (result.status !== undefined && result.status !== 200) {
                            content = result.msg || 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†é”™è¯¯ã€‚';
                            throw new Error(content);
                        } else if (result.msg && !content) {
                            content = result.msg;
                            throw new Error(content);
                        }
                        
                        // åœæ­¢åŠ è½½åŠ¨ç”»
                        if (messageAvatar) {
                            messageAvatar.style.animation = '';
                        }
                        
                        // æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹
                        if (messageText) {
                            if (!content || !content.trim()) {
                                content = 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–åˆ°æœ‰æ•ˆå†…å®¹ã€‚';
                            }
                            messageText.innerHTML = this.renderMarkdown(content);
                            messageText.setAttribute('data-original-text', content);
                            
                            // æ·»åŠ å¤åˆ¶æŒ‰é’®
                            if (content && content.trim()) {
                                const copyButtonContainer = message.querySelector('[data-copy-button-container]');
                                if (copyButtonContainer) {
                                    this.addCopyButton(copyButtonContainer, messageText);
                                }
                                // æ·»åŠ  try again æŒ‰é’®ï¼ˆä»…å½“ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰
                                const petMessages = Array.from(messagesContainer.children).filter(
                                    child => child.querySelector('[data-message-type="pet-bubble"]')
                                );
                                if (petMessages.length > 1) {
                                    const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                    if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                        this.addTryAgainButton(tryAgainContainer, message);
                                    }
                                }
                                
                                // æ·»åŠ åŠ¨ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬è®¾ç½®æŒ‰é’®ï¼‰
                                await this.addActionButtonsToMessage(message);
                                
                            }
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                        
                        // ç«‹å³ä¿å­˜å® ç‰©å›å¤åˆ°å½“å‰ä¼šè¯
                        this.skipSessionListRefresh = true;
                        if (content && content.trim()) {
                            await this.addMessageToSession('pet', content, null, false);
                        }
                        
                        // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                        await this.saveCurrentSession(false, false);
                        
                        // è¯·æ±‚ç»“æŸåè°ƒç”¨ session/save ä¿å­˜ä¼šè¯åˆ°åç«¯
                        if (this.currentSessionId) {
                            if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                                try {
                                    await this.syncSessionToBackend(this.currentSessionId, true);
                                    console.log(`è§’è‰²æŒ‰é’®æ“ä½œåï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
                                } catch (error) {
                                    console.warn('ä¿å­˜ä¼šè¯åˆ°åç«¯å¤±è´¥:', error);
                                }
                            } else {
                                console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šsessionApi æœªåˆå§‹åŒ–æˆ–åç«¯åŒæ­¥æœªå¯ç”¨');
                            }
                        } else {
                            console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šå½“å‰ä¼šè¯ ID ä¸å­˜åœ¨');
                        }
                    } catch (error) {
                        const isAbortError = error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ';
                        
                        if (!isAbortError) {
                            console.error(`ç”Ÿæˆ${roleInfo.label}å¤±è´¥:`, error);
                        }
                        
                        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ˆå–æ¶ˆæ—¶ä¸æ˜¾ç¤ºï¼‰
                        if (!isAbortError && messageText) {
                            const errorMessage = error.message && error.message.includes('HTTP error') 
                                ? `æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼ˆ${error.message}ï¼‰ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚${loadingIcon}`
                                : `æŠ±æ­‰ï¼Œæ— æ³•ç”Ÿæˆ${roleInfo.label}ã€‚${error.message ? `é”™è¯¯ä¿¡æ¯ï¼š${error.message}` : 'æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢åé‡è¯•ã€‚'}${loadingIcon}`;
                            messageText.innerHTML = this.renderMarkdown(errorMessage);
                            // æ·»åŠ  try again æŒ‰é’®
                            const petMessages = Array.from(messagesContainer.children).filter(
                                child => child.querySelector('[data-message-type="pet-bubble"]')
                            );
                            if (petMessages.length > 1) {
                                const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                    this.addTryAgainButton(tryAgainContainer, message);
                                }
                            }
                            await this.addActionButtonsToMessage(message);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        } else if (isAbortError && message) {
                            message.remove();
                        }
                    } finally {
                        // ç¡®ä¿è¯·æ±‚çŠ¶æ€æ€»æ˜¯è¢«æ›´æ–°ä¸ºç©ºé—²çŠ¶æ€
                        if (this.chatWindow && this.chatWindow._setAbortController) {
                            this.chatWindow._setAbortController(null);
                        }
                        if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                            this.chatWindow._updateRequestStatus('idle');
                        }
                        // ç¡®ä¿åœæ­¢åŠ è½½åŠ¨ç”»
                        if (messageAvatar) {
                            messageAvatar.style.animation = '';
                        }
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                });
            } else if (newButton.hasAttribute('data-role-id')) {
                // å¦‚æœæ˜¯æ²¡æœ‰ actionKey çš„è§’è‰²æŒ‰é’®ï¼Œéœ€è¦é‡æ–°åˆ›å»ºç‚¹å‡»å¤„ç†å‡½æ•°
                const roleId = newButton.getAttribute('data-role-id');
                copiedButtonIds.add(roleId); // è®°å½•å·²å¤åˆ¶
                const config = configsById[roleId];
                if (config) {
                    // åˆ›å»º processing flag
                    if (!this.roleButtonsProcessingFlags) {
                        this.roleButtonsProcessingFlags = {};
                    }
                    if (!this.roleButtonsProcessingFlags[roleId]) {
                        this.roleButtonsProcessingFlags[roleId] = { value: false };
                    }
                    const processingFlag = this.roleButtonsProcessingFlags[roleId];
                    
                    // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨ä¸ refreshWelcomeActionButtons ä¸­ç›¸åŒçš„é€»è¾‘ï¼‰
                    newButton.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        
                        if (processingFlag.value) return;
                        processingFlag.value = true;
                        const originalIcon = newButton.innerHTML;
                        const originalTitle = newButton.title;
                        
                        // è·å–å½“å‰æ¶ˆæ¯çš„å†…å®¹ï¼ˆæ ¹æ®æ¶ˆæ¯ç±»å‹é€‰æ‹©æ­£ç¡®çš„å…ƒç´ ï¼‰
                        let messageBubble = null;
                        if (isUserMessage) {
                            // ç”¨æˆ·æ¶ˆæ¯ï¼šä» user-bubble è·å–å†…å®¹
                            messageBubble = messageDiv.querySelector('[data-message-type="user-bubble"]');
                        } else {
                            // å® ç‰©æ¶ˆæ¯ï¼šä» pet-bubble è·å–å†…å®¹
                            messageBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]');
                        }
                        let messageContent = '';
                        if (messageBubble) {
                            // ä¼˜å…ˆä½¿ç”¨ data-original-textï¼ˆåŸå§‹æ–‡æœ¬ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ–‡æœ¬å†…å®¹
                            messageContent = messageBubble.getAttribute('data-original-text') || 
                                           messageBubble.innerText || 
                                           messageBubble.textContent || '';
                        }
                        
                        const roleLabel = config.label || 'è‡ªå®šä¹‰è§’è‰²';
                        const roleIcon = this.getRoleIcon(config, configsRaw) || 'ğŸ™‚';
                        const systemPrompt = (config.prompt && config.prompt.trim()) ? config.prompt.trim() : '';
                        
                        // æ£€æŸ¥é¡µé¢ä¸Šä¸‹æ–‡å¼€å…³çŠ¶æ€
                        let includeContext = true; // é»˜è®¤åŒ…å«ä¸Šä¸‹æ–‡
                        const contextSwitch = this.chatWindow ? this.chatWindow.querySelector('#context-switch') : null;
                        if (contextSwitch) {
                            includeContext = contextSwitch.checked;
                        }
                        
                        // æ„å»º fromUserï¼šä»¥å½“å‰æ¶ˆæ¯å†…å®¹ä¸ºä¸»ï¼ŒåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡
                        const baseMessageContent = messageContent.trim() || 'æ— å†…å®¹';
                        let fromUser = baseMessageContent;
                        
                        // å¦‚æœæ²¡æœ‰å¼€å¯é¡µé¢ä¸Šä¸‹æ–‡ï¼Œç›´æ¥ä½¿ç”¨æ¶ˆæ¯å†…å®¹
                        if (!includeContext) {
                            fromUser = baseMessageContent;
                        } else {
                        // è·å–ä¼šè¯ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                        const context = this.buildConversationContext();
                        
                        // å¦‚æœå­˜åœ¨ä¼šè¯å†å²ï¼Œåœ¨æ¶ˆæ¯å†…å®¹å‰æ·»åŠ ä¸Šä¸‹æ–‡
                        if (context.hasHistory && context.messages.length > 0) {
                            // æ„å»ºæ¶ˆæ¯å†å²ä¸Šä¸‹æ–‡ï¼ˆåªåŒ…å«å½“å‰æ¶ˆæ¯ä¹‹å‰çš„å†å²ï¼‰
                            let conversationContext = '\n\n## ä¼šè¯å†å²ï¼š\n\n';
                            context.messages.forEach((msg) => {
                                const role = msg.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                                const content = msg.content.trim();
                                if (content && content !== baseMessageContent) { // æ’é™¤å½“å‰æ¶ˆæ¯æœ¬èº«
                                    conversationContext += `${role}ï¼š${content}\n\n`;
                                }
                            });
                            // å°†ä¸Šä¸‹æ–‡æ”¾åœ¨å‰é¢ï¼Œå½“å‰æ¶ˆæ¯å†…å®¹æ”¾åœ¨åé¢
                            fromUser = conversationContext + `## å½“å‰éœ€è¦å¤„ç†çš„æ¶ˆæ¯ï¼š\n\n${baseMessageContent}`;
                        }
                        
                        // å¦‚æœæœ‰é¡µé¢å†…å®¹ï¼Œä¹Ÿæ·»åŠ é¡µé¢å†…å®¹
                        if (context.pageContent) {
                            fromUser += `\n\n## é¡µé¢å†…å®¹ï¼š\n\n${context.pageContent}`;
                            }
                        }
                        
                        // åˆ›å»ºæ–°çš„æ¶ˆæ¯
                        const message = this.createMessageElement('', 'pet');
                        message.setAttribute('data-button-action', 'true');
                        messagesContainer.appendChild(message);
                        const messageText = message.querySelector('[data-message-type="pet-bubble"]');
                        const messageAvatar = message.querySelector('[data-message-type="pet-avatar"]');
                        
                        if (messageAvatar) {
                            messageAvatar.style.animation = 'petTyping 1.2s ease-in-out infinite';
                        }
                        if (messageText) {
                            messageText.textContent = `${roleIcon} æ­£åœ¨${roleLabel}...`;
                        }
                        
                        try {
                            const abortController = new AbortController();
                            
                            // è®¾ç½®æ ‡å¿—ï¼Œé¿å… prompt è°ƒç”¨åè§¦å‘ä¼šè¯åˆ—è¡¨åˆ·æ–°æ¥å£
                            this.skipSessionListRefresh = true;
                            
                            // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID
                            // ä¼ é€’ messageDivï¼Œä»¥ä¾¿ä»å¯¹åº”çš„æ¶ˆæ¯å¯¹è±¡ä¸­è·å– imageDataUrl
                            const payload = this.buildPromptPayload(
                                systemPrompt,
                                fromUser,
                                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3'),
                                { messageDiv: messageDiv }
                            );
                            
                            const response = await fetch(PET_CONFIG.api.promptUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(payload),
                                signal: abortController.signal
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                            }
                            
                            // å…ˆè¯»å–å“åº”æ–‡æœ¬ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæµå¼å“åº”ï¼ˆSSEæ ¼å¼ï¼‰
                            const responseText = await response.text();
                            let result;
                            
                            // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
                            if (responseText.includes('data: ')) {
                                // å¤„ç†SSEæµå¼å“åº”
                                const lines = responseText.split('\n');
                                let accumulatedData = '';
                                let lastValidData = null;
                                
                                for (const line of lines) {
                                    const trimmedLine = line.trim();
                                    if (trimmedLine.startsWith('data: ')) {
                                        try {
                                            const dataStr = trimmedLine.substring(6).trim();
                                            if (dataStr === '[DONE]' || dataStr === '') {
                                                continue;
                                            }
                                            
                                            // å°è¯•è§£æJSON
                                            const chunk = JSON.parse(dataStr);
                                            
                                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                            if (chunk.done === true) {
                                                break;
                                            }
                                            
                                            // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                                            if (chunk.data) {
                                                accumulatedData += chunk.data;
                                            } else if (chunk.content) {
                                                accumulatedData += chunk.content;
                                            } else if (chunk.message && chunk.message.content) {
                                                // Ollamaæ ¼å¼
                                                accumulatedData += chunk.message.content;
                                            } else if (typeof chunk === 'string') {
                                                accumulatedData += chunk;
                                            }
                                            
                                            // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—ï¼ˆç”¨äºæå–å…¶ä»–å­—æ®µå¦‚statusç­‰ï¼‰
                                            lastValidData = chunk;
                                        } catch (e) {
                                            // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                                            const dataStr = trimmedLine.substring(6).trim();
                                            if (dataStr && dataStr !== '[DONE]') {
                                                accumulatedData += dataStr;
                                            }
                                        }
                                    }
                                }
                                
                                // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                                if (accumulatedData || lastValidData) {
                                    if (lastValidData && lastValidData.status) {
                                        // å¦‚æœæœ‰statuså­—æ®µï¼Œä¿ç•™åŸæœ‰ç»“æ„ï¼Œä½†æ›¿æ¢data/content
                                        result = {
                                            ...lastValidData,
                                            data: accumulatedData || lastValidData.data || '',
                                            content: accumulatedData || lastValidData.content || ''
                                        };
                                    } else {
                                        // å¦åˆ™åˆ›å»ºæ–°çš„ç»“æœå¯¹è±¡
                                        result = {
                                            data: accumulatedData,
                                            content: accumulatedData
                                        };
                                    }
                                } else {
                                    // å¦‚æœæ— æ³•è§£æSSEæ ¼å¼ï¼Œå°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”
                                    try {
                                        result = JSON.parse(responseText);
                                    } catch (e) {
                                        throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                                    }
                                }
                            } else {
                                // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                                try {
                                    result = JSON.parse(responseText);
                                } catch (e) {
                                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾SSEæ ¼å¼çš„æ•°æ®
                                    const sseMatch = responseText.match(/data:\s*({.+?})/s);
                                    if (sseMatch) {
                                        result = JSON.parse(sseMatch[1]);
                                    } else {
                                        throw new Error(`æ— æ³•è§£æå“åº”: ${responseText.substring(0, 100)}`);
                                    }
                                }
                            }
                            
                            // é€‚é…å“åº”æ ¼å¼: {status, msg, data, pagination}
                            let content = '';
                            
                            // ä¼˜å…ˆå°è¯•æå–å†…å®¹ï¼Œä¸ç®¡statuså€¼æ˜¯ä»€ä¹ˆï¼ˆå› ä¸ºå¯èƒ½æœ‰å†…å®¹ä½†statusä¸æ˜¯200ï¼‰
                            if (result.data) {
                                // æå– data å­—æ®µ
                                content = result.data;
                            } else if (result.content) {
                                content = result.content;
                            } else if (result.message && result.message.content) {
                                // Ollamaæ ¼å¼
                                content = result.message.content;
                            } else if (result.message && typeof result.message === 'string') {
                                content = result.message;
                            } else if (typeof result === 'string') {
                                content = result;
                            } else {
                                // æœªçŸ¥æ ¼å¼ï¼Œå°è¯•æå–å¯èƒ½çš„æ–‡æœ¬å†…å®¹
                                content = JSON.stringify(result);
                            }
                            
                            // å¦‚æœæå–åˆ°äº†æœ‰æ•ˆå†…å®¹ï¼Œç›´æ¥ä½¿ç”¨
                            if (content && content.trim()) {
                                // å†…å®¹æå–æˆåŠŸï¼Œç»§ç»­å¤„ç†
                            } else if (result.status !== undefined && result.status !== 200) {
                                // åªæœ‰åœ¨æ˜ç¡®statusä¸æ˜¯200ä¸”æ²¡æœ‰å†…å®¹æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯é”™è¯¯
                                content = result.msg || 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†é”™è¯¯ã€‚';
                                throw new Error(content);
                            } else if (result.msg && !content) {
                                // å¦‚æœæœ‰é”™è¯¯æ¶ˆæ¯ä½†æ²¡æœ‰å†…å®¹ï¼Œä¹Ÿè®¤ä¸ºæ˜¯é”™è¯¯
                                content = result.msg;
                                throw new Error(content);
                            }
                            
                            // åœæ­¢åŠ è½½åŠ¨ç”»
                            if (messageAvatar) {
                                messageAvatar.style.animation = '';
                            }
                            
                            // æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹
                            if (messageText) {
                                // ç¡®ä¿å†…å®¹ä¸ä¸ºç©º
                                if (!content || !content.trim()) {
                                    content = 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–åˆ°æœ‰æ•ˆå†…å®¹ã€‚';
                                }
                                messageText.innerHTML = this.renderMarkdown(content);
                                // æ›´æ–°åŸå§‹æ–‡æœ¬ç”¨äºå¤åˆ¶åŠŸèƒ½
                                messageText.setAttribute('data-original-text', content);
                                // æ·»åŠ å¤åˆ¶æŒ‰é’®
                                if (content && content.trim()) {
                                    const copyButtonContainer = message.querySelector('[data-copy-button-container]');
                                    if (copyButtonContainer) {
                                        this.addCopyButton(copyButtonContainer, messageText);
                                    }
                                    // æ·»åŠ  try again æŒ‰é’®ï¼ˆä»…å½“ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰
                                    const petMessages = Array.from(messagesContainer.children).filter(
                                        child => child.querySelector('[data-message-type="pet-bubble"]')
                                    );
                                    if (petMessages.length > 1) {
                                        const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                        if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                            this.addTryAgainButton(tryAgainContainer, message);
                                        }
                                    }
                                    
                                    // æ·»åŠ åŠ¨ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬è®¾ç½®æŒ‰é’®ï¼‰
                                    await this.addActionButtonsToMessage(message);
                                }
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                            
                            // ç«‹å³ä¿å­˜å® ç‰©å›å¤åˆ°å½“å‰ä¼šè¯
                            this.skipSessionListRefresh = true;
                            if (content && content.trim()) {
                                await this.addMessageToSession('pet', content, null, false);
                            }
                            
                            // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                            await this.saveCurrentSession(false, false);
                            
                            // prompt æ¥å£è°ƒç”¨åå¿…é¡»è§¦å‘ session/save
                            if (this.currentSessionId) {
                                if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                                    try {
                                        await this.syncSessionToBackend(this.currentSessionId, true);
                                        console.log(`prompt æ¥å£è°ƒç”¨åï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
                                    } catch (error) {
                                        console.warn('ä¿å­˜ä¼šè¯åˆ°åç«¯å¤±è´¥:', error);
                                    }
                                } else {
                                    console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šsessionApi æœªåˆå§‹åŒ–æˆ–åç«¯åŒæ­¥æœªå¯ç”¨');
                                }
                            } else {
                                console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šå½“å‰ä¼šè¯ ID ä¸å­˜åœ¨');
                            }
                            
                            newButton.innerHTML = 'âœ“';
                            newButton.style.cursor = 'default';
                            newButton.style.color = '#4caf50';
                            
                            // 2ç§’åæ¢å¤åˆå§‹çŠ¶æ€ï¼Œå…è®¸å†æ¬¡ç‚¹å‡»
                            setTimeout(() => {
                                newButton.innerHTML = originalIcon;
                                newButton.title = originalTitle;
                                newButton.style.color = '#666';
                                newButton.style.cursor = 'pointer';
                                newButton.style.opacity = '1';
                                processingFlag.value = false;
                            }, 2000);
                            
                        } catch (error) {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯å–æ¶ˆé”™è¯¯
                            const isAbortError = error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ';
                            
                            if (!isAbortError) {
                                console.error(`ç”Ÿæˆ${roleLabel}å¤±è´¥:`, error);
                            }
                            
                            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ˆå–æ¶ˆæ—¶ä¸æ˜¾ç¤ºï¼‰
                            if (!isAbortError && messageText) {
                                const errorMessage = error.message && error.message.includes('HTTP error') 
                                    ? `æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼ˆ${error.message}ï¼‰ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚${roleIcon}`
                                    : `æŠ±æ­‰ï¼Œæ— æ³•ç”Ÿæˆ"${pageTitle}"çš„${roleLabel}ã€‚${error.message ? `é”™è¯¯ä¿¡æ¯ï¼š${error.message}` : 'æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢åé‡è¯•ã€‚'}${roleIcon}`;
                                messageText.innerHTML = this.renderMarkdown(errorMessage);
                                // æ·»åŠ  try again æŒ‰é’®ï¼ˆä»…å½“ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰
                                const petMessages = Array.from(messagesContainer.children).filter(
                                    child => child.querySelector('[data-message-type="pet-bubble"]')
                                );
                                if (petMessages.length > 1) {
                                    const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                    if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                        this.addTryAgainButton(tryAgainContainer, message);
                                    }
                                }
                                
                                // æ·»åŠ åŠ¨ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬è®¾ç½®æŒ‰é’®ï¼‰
                                await this.addActionButtonsToMessage(message);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            } else if (isAbortError && message) {
                                // è¯·æ±‚è¢«å–æ¶ˆï¼Œç§»é™¤æ¶ˆæ¯
                                message.remove();
                            }
                            
                            if (!isAbortError) {
                                newButton.innerHTML = 'âœ•';
                                newButton.style.cursor = 'default';
                                newButton.style.color = '#f44336';
                                
                                // 1.5ç§’åæ¢å¤åˆå§‹çŠ¶æ€ï¼Œå…è®¸å†æ¬¡ç‚¹å‡»
                                setTimeout(() => {
                                    newButton.innerHTML = originalIcon;
                                    newButton.title = originalTitle;
                                    newButton.style.color = '#666';
                                    newButton.style.cursor = 'pointer';
                                    newButton.style.opacity = '1';
                                    processingFlag.value = false;
                                }, 1500);
                            } else {
                                // è¯·æ±‚è¢«å–æ¶ˆï¼Œç«‹å³æ¢å¤çŠ¶æ€
                                newButton.innerHTML = originalIcon;
                                newButton.title = originalTitle;
                                newButton.style.color = '#666';
                                newButton.style.cursor = 'pointer';
                                newButton.style.opacity = '1';
                                processingFlag.value = false;
                            }
                        } finally {
                            // ç¡®ä¿åœæ­¢åŠ è½½åŠ¨ç”»
                            if (messageAvatar) {
                                messageAvatar.style.animation = '';
                            }
                        }
                    });
                }
            }
            
            actionsContainer.appendChild(newButton);
        }
        
        // è¡¥å……é—æ¼çš„è§’è‰²æŒ‰é’®ï¼ˆç¡®ä¿æ‰€æœ‰è§’è‰²æŒ‰é’®éƒ½è¢«æ·»åŠ ï¼‰
        // é¦–å…ˆæ·»åŠ æœ‰ actionKey ä½†å¯èƒ½é—æ¼çš„æŒ‰é’®
        for (const key of orderedKeys) {
            const config = configsByActionKey[key];
            if (config && config.id && !copiedButtonIds.has(config.id)) {
                // è¿™ä¸ªæŒ‰é’®æ²¡æœ‰è¢«å¤åˆ¶ï¼Œéœ€è¦åˆ›å»º
                const button = await this.createActionButton(key);
                if (button) {
                    const clonedButton = button.cloneNode(true);
                    
                    // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨æ¶ˆæ¯å†…å®¹ï¼‰
                    clonedButton.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        
                        const messageBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]');
                        let messageContent = '';
                        if (messageBubble) {
                            messageContent = messageBubble.getAttribute('data-original-text') || 
                                           messageBubble.innerText || 
                                           messageBubble.textContent || '';
                        }
                        
                        const pageInfo = this.getPageInfo();
                        let roleInfo;
                        try {
                            roleInfo = await this.getRolePromptForAction(key, pageInfo);
                        } catch (error) {
                            console.error('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥:', error);
                            roleInfo = {
                                systemPrompt: '',
                                userPrompt: '',
                                label: 'è‡ªå®šä¹‰è§’è‰²',
                                icon: 'ğŸ™‚'
                            };
                        }
                        
                        // æ£€æŸ¥é¡µé¢ä¸Šä¸‹æ–‡å¼€å…³çŠ¶æ€
                        let includeContext = true; // é»˜è®¤åŒ…å«ä¸Šä¸‹æ–‡
                        const contextSwitch = this.chatWindow ? this.chatWindow.querySelector('#context-switch') : null;
                        if (contextSwitch) {
                            includeContext = contextSwitch.checked;
                        }
                        
                        // æ„å»º fromUserï¼šä»¥å½“å‰æ¶ˆæ¯å†…å®¹ä¸ºä¸»ï¼ŒåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡
                        const baseMessageContent = messageContent.trim() || 'æ— å†…å®¹';
                        let fromUser = baseMessageContent;
                        
                        // å¦‚æœæ²¡æœ‰å¼€å¯é¡µé¢ä¸Šä¸‹æ–‡ï¼Œç›´æ¥ä½¿ç”¨æ¶ˆæ¯å†…å®¹
                        if (!includeContext) {
                            fromUser = baseMessageContent;
                        } else {
                        // è·å–ä¼šè¯ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                        const context = this.buildConversationContext();
                        
                        // å¦‚æœå­˜åœ¨ä¼šè¯å†å²ï¼Œåœ¨æ¶ˆæ¯å†…å®¹å‰æ·»åŠ ä¸Šä¸‹æ–‡
                        if (context.hasHistory && context.messages.length > 0) {
                            // æ„å»ºæ¶ˆæ¯å†å²ä¸Šä¸‹æ–‡ï¼ˆåªåŒ…å«å½“å‰æ¶ˆæ¯ä¹‹å‰çš„å†å²ï¼‰
                            let conversationContext = '\n\n## ä¼šè¯å†å²ï¼š\n\n';
                            context.messages.forEach((msg) => {
                                const role = msg.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                                const content = msg.content.trim();
                                if (content && content !== baseMessageContent) { // æ’é™¤å½“å‰æ¶ˆæ¯æœ¬èº«
                                    conversationContext += `${role}ï¼š${content}\n\n`;
                                }
                            });
                            // å°†ä¸Šä¸‹æ–‡æ”¾åœ¨å‰é¢ï¼Œå½“å‰æ¶ˆæ¯å†…å®¹æ”¾åœ¨åé¢
                            fromUser = conversationContext + `## å½“å‰éœ€è¦å¤„ç†çš„æ¶ˆæ¯ï¼š\n\n${baseMessageContent}`;
                        }
                        
                        // å¦‚æœæœ‰é¡µé¢å†…å®¹ä¸”è§’è‰²æç¤ºè¯åŒ…å«é¡µé¢å†…å®¹ï¼Œä¹Ÿæ·»åŠ é¡µé¢å†…å®¹
                        if (context.pageContent && roleInfo.userPrompt && roleInfo.userPrompt.includes('é¡µé¢å†…å®¹')) {
                            fromUser += `\n\n## é¡µé¢å†…å®¹ï¼š\n\n${context.pageContent}`;
                            }
                        }
                        
                        const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
                        if (!messagesContainer) {
                            console.error('æ— æ³•æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
                            return;
                        }
                        
                        const message = this.createMessageElement('', 'pet');
                        message.setAttribute('data-button-action', 'true');
                        messagesContainer.appendChild(message);
                        const messageText = message.querySelector('[data-message-type="pet-bubble"]');
                        const messageAvatar = message.querySelector('[data-message-type="pet-avatar"]');
                        
                        if (messageAvatar) {
                            messageAvatar.style.animation = 'petTyping 1.2s ease-in-out infinite';
                        }
                        const loadingIcon = roleInfo.icon || 'ğŸ“–';
                        if (messageText) {
                            messageText.textContent = `${loadingIcon} æ­£åœ¨${roleInfo.label || 'å¤„ç†'}...`;
                        }
                        
                        try {
                            const abortController = new AbortController();
                            if (this.chatWindow && this.chatWindow._setAbortController) {
                                this.chatWindow._setAbortController(abortController);
                            }
                            if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                                this.chatWindow._updateRequestStatus('loading');
                            }
                            
                            // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID
                            // ä¼ é€’ messageDivï¼Œä»¥ä¾¿ä»å¯¹åº”çš„æ¶ˆæ¯å¯¹è±¡ä¸­è·å– imageDataUrl
                            const payload = this.buildPromptPayload(
                                roleInfo.systemPrompt,
                                fromUser,
                                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3'),
                                { messageDiv: messageDiv }
                            );
                            
                            const response = await fetch(PET_CONFIG.api.promptUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(payload),
                                signal: abortController.signal
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                            }
                            
                            const responseText = await response.text();
                            let result;
                            
                            if (responseText.includes('data: ')) {
                                const lines = responseText.split('\n');
                                let accumulatedData = '';
                                let lastValidData = null;
                                
                                for (const line of lines) {
                                    const trimmedLine = line.trim();
                                    if (trimmedLine.startsWith('data: ')) {
                                        try {
                                            const dataStr = trimmedLine.substring(6).trim();
                                            if (dataStr === '[DONE]' || dataStr === '') {
                                                continue;
                                            }
                                            
                                            const chunk = JSON.parse(dataStr);
                                            if (chunk.done === true) {
                                                break;
                                            }
                                            
                                            if (chunk.data) {
                                                accumulatedData += chunk.data;
                                            } else if (chunk.content) {
                                                accumulatedData += chunk.content;
                                            } else if (chunk.message && chunk.message.content) {
                                                accumulatedData += chunk.message.content;
                                            } else if (typeof chunk === 'string') {
                                                accumulatedData += chunk;
                                            }
                                            
                                            lastValidData = chunk;
                                        } catch (e) {
                                            const dataStr = trimmedLine.substring(6).trim();
                                            if (dataStr && dataStr !== '[DONE]') {
                                                accumulatedData += dataStr;
                                            }
                                        }
                                    }
                                }
                                
                                if (accumulatedData || lastValidData) {
                                    if (lastValidData && lastValidData.status) {
                                        result = {
                                            ...lastValidData,
                                            data: accumulatedData || lastValidData.data || '',
                                            content: accumulatedData || lastValidData.content || ''
                                        };
                                    } else {
                                        result = {
                                            data: accumulatedData,
                                            content: accumulatedData
                                        };
                                    }
                                } else {
                                    try {
                                        result = JSON.parse(responseText);
                                    } catch (e) {
                                        throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                                    }
                                }
                            } else {
                                try {
                                    result = JSON.parse(responseText);
                                } catch (e) {
                                    const sseMatch = responseText.match(/data:\s*({.+?})/s);
                                    if (sseMatch) {
                                        result = JSON.parse(sseMatch[1]);
                                    } else {
                                        throw new Error(`æ— æ³•è§£æå“åº”: ${responseText.substring(0, 100)}`);
                                    }
                                }
                            }
                            
                            let content = '';
                            if (result.data) {
                                content = result.data;
                            } else if (result.content) {
                                content = result.content;
                            } else if (result.message && result.message.content) {
                                content = result.message.content;
                            } else if (result.message && typeof result.message === 'string') {
                                content = result.message;
                            } else if (typeof result === 'string') {
                                content = result;
                            } else {
                                content = JSON.stringify(result);
                            }
                            
                            if (content && content.trim()) {
                                // å†…å®¹æå–æˆåŠŸ
                            } else if (result.status !== undefined && result.status !== 200) {
                                content = result.msg || 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†é”™è¯¯ã€‚';
                                throw new Error(content);
                            } else if (result.msg && !content) {
                                content = result.msg;
                                throw new Error(content);
                            }
                            
                            if (messageAvatar) {
                                messageAvatar.style.animation = '';
                            }
                            
                            if (messageText) {
                                if (!content || !content.trim()) {
                                    content = 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–åˆ°æœ‰æ•ˆå†…å®¹ã€‚';
                                }
                                messageText.innerHTML = this.renderMarkdown(content);
                                messageText.setAttribute('data-original-text', content);
                                
                                if (content && content.trim()) {
                                    const copyButtonContainer = message.querySelector('[data-copy-button-container]');
                                    if (copyButtonContainer) {
                                        this.addCopyButton(copyButtonContainer, messageText);
                                    }
                                    const petMessages = Array.from(messagesContainer.children).filter(
                                        child => child.querySelector('[data-message-type="pet-bubble"]')
                                    );
                                    if (petMessages.length > 1) {
                                        const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                        if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                            this.addTryAgainButton(tryAgainContainer, message);
                                        }
                                    }
                                    
                                    await this.addActionButtonsToMessage(message);
                                }
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                            
                            // ç«‹å³ä¿å­˜å® ç‰©å›å¤åˆ°å½“å‰ä¼šè¯
                            this.skipSessionListRefresh = true;
                            if (content && content.trim()) {
                                await this.addMessageToSession('pet', content, null, false);
                            }
                            
                            // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                            await this.saveCurrentSession(false, false);
                            
                            // prompt æ¥å£è°ƒç”¨åå¿…é¡»è§¦å‘ session/save
                            if (this.currentSessionId) {
                                if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                                    try {
                                        await this.syncSessionToBackend(this.currentSessionId, true);
                                        console.log(`prompt æ¥å£è°ƒç”¨åï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
                                    } catch (error) {
                                        console.warn('ä¿å­˜ä¼šè¯åˆ°åç«¯å¤±è´¥:', error);
                                    }
                                } else {
                                    console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šsessionApi æœªåˆå§‹åŒ–æˆ–åç«¯åŒæ­¥æœªå¯ç”¨');
                                }
                            } else {
                                console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šå½“å‰ä¼šè¯ ID ä¸å­˜åœ¨');
                            }
                        } catch (error) {
                            const isAbortError = error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ';
                            
                            if (!isAbortError) {
                                console.error(`ç”Ÿæˆ${roleInfo.label}å¤±è´¥:`, error);
                            }
                            
                            if (!isAbortError && messageText) {
                                const errorMessage = error.message && error.message.includes('HTTP error') 
                                    ? `æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼ˆ${error.message}ï¼‰ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚${loadingIcon}`
                                    : `æŠ±æ­‰ï¼Œæ— æ³•ç”Ÿæˆ${roleInfo.label}ã€‚${error.message ? `é”™è¯¯ä¿¡æ¯ï¼š${error.message}` : 'æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢åé‡è¯•ã€‚'}${loadingIcon}`;
                                messageText.innerHTML = this.renderMarkdown(errorMessage);
                                const petMessages = Array.from(messagesContainer.children).filter(
                                    child => child.querySelector('[data-message-type="pet-bubble"]')
                                );
                                if (petMessages.length > 1) {
                                    const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                    if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                        this.addTryAgainButton(tryAgainContainer, message);
                                    }
                                }
                                await this.addActionButtonsToMessage(message);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            } else if (isAbortError && message) {
                                message.remove();
                            }
                        } finally {
                            if (this.chatWindow && this.chatWindow._setAbortController) {
                                this.chatWindow._setAbortController(null);
                            }
                            if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                                this.chatWindow._updateRequestStatus('idle');
                            }
                            if (messageAvatar) {
                                messageAvatar.style.animation = '';
                            }
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    });
                    
                    actionsContainer.appendChild(clonedButton);
                    copiedButtonIds.add(config.id);
                }
            }
        }
        
        // ç„¶åæ·»åŠ æ²¡æœ‰ actionKey ä½†é—æ¼çš„è§’è‰²æŒ‰é’®
        const otherRoles = (configsRaw || []).filter(c => c && c.id && !boundRoleIds.has(c.id) && !copiedButtonIds.has(c.id));
        for (const config of otherRoles) {
            // åˆ›å»ºæ–°çš„è§’è‰²æŒ‰é’®ï¼ˆæ²¡æœ‰ actionKeyï¼‰
            const button = document.createElement('span');
            button.setAttribute('data-role-id', config.id);
            button.style.cssText = `
                padding: 4px !important;
                cursor: pointer !important;
                font-size: 16px !important;
                color: #666 !important;
                font-weight: 300 !important;
                transition: all 0.2s ease !important;
                flex-shrink: 0 !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                user-select: none !important;
                width: 22px !important;
                height: 22px !important;
                line-height: 22px !important;
            `;
            
            const displayIcon = this.getRoleIcon(config, configsRaw);
            button.innerHTML = displayIcon || 'ğŸ™‚';
            button.title = config.label || '(æœªå‘½å)';
            
            // æ·»åŠ  hover æ•ˆæœ
            button.addEventListener('mouseenter', function() {
                this.style.fontSize = '18px';
                this.style.color = '#333';
                this.style.transform = 'scale(1.1)';
            });
            button.addEventListener('mouseleave', function() {
                this.style.fontSize = '16px';
                this.style.color = '#666';
                this.style.transform = 'scale(1)';
            });
            
            // åˆ›å»º processing flag
            if (!this.roleButtonsProcessingFlags) {
                this.roleButtonsProcessingFlags = {};
            }
            if (!this.roleButtonsProcessingFlags[config.id]) {
                this.roleButtonsProcessingFlags[config.id] = { value: false };
            }
            const processingFlag = this.roleButtonsProcessingFlags[config.id];
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨ä¸ refreshWelcomeActionButtons ä¸­ç›¸åŒçš„é€»è¾‘ï¼Œä½†ä½¿ç”¨æ¶ˆæ¯å†…å®¹ï¼‰
            button.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                if (processingFlag.value) return;
                processingFlag.value = true;
                const originalIcon = button.innerHTML;
                const originalTitle = button.title;
                
                // è·å–å½“å‰æ¶ˆæ¯çš„å†…å®¹ï¼ˆæ ¹æ®æ¶ˆæ¯ç±»å‹é€‰æ‹©æ­£ç¡®çš„å…ƒç´ ï¼‰
                let messageBubble = null;
                if (isUserMessage) {
                    // ç”¨æˆ·æ¶ˆæ¯ï¼šä» user-bubble è·å–å†…å®¹
                    messageBubble = messageDiv.querySelector('[data-message-type="user-bubble"]');
                } else {
                    // å® ç‰©æ¶ˆæ¯ï¼šä» pet-bubble è·å–å†…å®¹
                    messageBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]');
                }
                let messageContent = '';
                if (messageBubble) {
                    messageContent = messageBubble.getAttribute('data-original-text') || 
                                   messageBubble.innerText || 
                                   messageBubble.textContent || '';
                }
                
                const roleLabel = config.label || 'è‡ªå®šä¹‰è§’è‰²';
                const roleIcon = this.getRoleIcon(config, configsRaw) || 'ğŸ™‚';
                const systemPrompt = (config.prompt && config.prompt.trim()) ? config.prompt.trim() : '';
                
                // æ£€æŸ¥é¡µé¢ä¸Šä¸‹æ–‡å¼€å…³çŠ¶æ€
                let includeContext = true; // é»˜è®¤åŒ…å«ä¸Šä¸‹æ–‡
                const contextSwitch = this.chatWindow ? this.chatWindow.querySelector('#context-switch') : null;
                if (contextSwitch) {
                    includeContext = contextSwitch.checked;
                }
                
                // æ„å»º fromUserï¼šä»¥å½“å‰æ¶ˆæ¯å†…å®¹ä¸ºä¸»ï¼ŒåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡
                const baseMessageContent = messageContent.trim() || 'æ— å†…å®¹';
                let fromUser = baseMessageContent;
                
                // å¦‚æœæ²¡æœ‰å¼€å¯é¡µé¢ä¸Šä¸‹æ–‡ï¼Œç›´æ¥ä½¿ç”¨æ¶ˆæ¯å†…å®¹
                if (!includeContext) {
                    fromUser = baseMessageContent;
                } else {
                // è·å–ä¼šè¯ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                const context = this.buildConversationContext();
                
                // å¦‚æœå­˜åœ¨ä¼šè¯å†å²ï¼Œåœ¨æ¶ˆæ¯å†…å®¹å‰æ·»åŠ ä¸Šä¸‹æ–‡
                if (context.hasHistory && context.messages.length > 0) {
                    // æ„å»ºæ¶ˆæ¯å†å²ä¸Šä¸‹æ–‡ï¼ˆåªåŒ…å«å½“å‰æ¶ˆæ¯ä¹‹å‰çš„å†å²ï¼‰
                    let conversationContext = '\n\n## ä¼šè¯å†å²ï¼š\n\n';
                    context.messages.forEach((msg) => {
                        const role = msg.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                        const content = msg.content.trim();
                        if (content && content !== baseMessageContent) { // æ’é™¤å½“å‰æ¶ˆæ¯æœ¬èº«
                            conversationContext += `${role}ï¼š${content}\n\n`;
                        }
                    });
                    // å°†ä¸Šä¸‹æ–‡æ”¾åœ¨å‰é¢ï¼Œå½“å‰æ¶ˆæ¯å†…å®¹æ”¾åœ¨åé¢
                    fromUser = conversationContext + `## å½“å‰éœ€è¦å¤„ç†çš„æ¶ˆæ¯ï¼š\n\n${baseMessageContent}`;
                }
                
                // å¦‚æœæœ‰é¡µé¢å†…å®¹ï¼Œä¹Ÿæ·»åŠ é¡µé¢å†…å®¹
                if (context.pageContent) {
                    fromUser += `\n\n## é¡µé¢å†…å®¹ï¼š\n\n${context.pageContent}`;
                    }
                }
                
                const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
                if (!messagesContainer) {
                    console.error('æ— æ³•æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
                    processingFlag.value = false;
                    return;
                }
                
                const message = this.createMessageElement('', 'pet');
                message.setAttribute('data-button-action', 'true');
                messagesContainer.appendChild(message);
                const messageText = message.querySelector('[data-message-type="pet-bubble"]');
                const messageAvatar = message.querySelector('[data-message-type="pet-avatar"]');
                
                if (messageAvatar) {
                    messageAvatar.style.animation = 'petTyping 1.2s ease-in-out infinite';
                }
                if (messageText) {
                    messageText.textContent = `${roleIcon} æ­£åœ¨${roleLabel}...`;
                }
                
                try {
                    const abortController = new AbortController();
                    
                    // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID
                    // ä¼ é€’ messageDivï¼Œä»¥ä¾¿ä»å¯¹åº”çš„æ¶ˆæ¯å¯¹è±¡ä¸­è·å– imageDataUrl
                    const payload = this.buildPromptPayload(
                        systemPrompt,
                        fromUser,
                        this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3'),
                        { messageDiv: messageDiv }
                    );
                    
                    const response = await fetch(PET_CONFIG.api.promptUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                        signal: abortController.signal
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                    
                    const responseText = await response.text();
                    let result;
                    
                    if (responseText.includes('data: ')) {
                        const lines = responseText.split('\n');
                        let accumulatedData = '';
                        let lastValidData = null;
                        
                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            if (trimmedLine.startsWith('data: ')) {
                                try {
                                    const dataStr = trimmedLine.substring(6).trim();
                                    if (dataStr === '[DONE]' || dataStr === '') {
                                        continue;
                                    }
                                    
                                    const chunk = JSON.parse(dataStr);
                                    if (chunk.done === true) {
                                        break;
                                    }
                                    
                                    if (chunk.data) {
                                        accumulatedData += chunk.data;
                                    } else if (chunk.content) {
                                        accumulatedData += chunk.content;
                                    } else if (chunk.message && chunk.message.content) {
                                        accumulatedData += chunk.message.content;
                                    } else if (typeof chunk === 'string') {
                                        accumulatedData += chunk;
                                    }
                                    
                                    lastValidData = chunk;
                                } catch (e) {
                                    const dataStr = trimmedLine.substring(6).trim();
                                    if (dataStr && dataStr !== '[DONE]') {
                                        accumulatedData += dataStr;
                                    }
                                }
                            }
                        }
                        
                        if (accumulatedData || lastValidData) {
                            if (lastValidData && lastValidData.status) {
                                result = {
                                    ...lastValidData,
                                    data: accumulatedData || lastValidData.data || '',
                                    content: accumulatedData || lastValidData.content || ''
                                };
                            } else {
                                result = {
                                    data: accumulatedData,
                                    content: accumulatedData
                                };
                            }
                        } else {
                            try {
                                result = JSON.parse(responseText);
                            } catch (e) {
                                throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                            }
                        }
                    } else {
                        try {
                            result = JSON.parse(responseText);
                        } catch (e) {
                            const sseMatch = responseText.match(/data:\s*({.+?})/s);
                            if (sseMatch) {
                                result = JSON.parse(sseMatch[1]);
                            } else {
                                throw new Error(`æ— æ³•è§£æå“åº”: ${responseText.substring(0, 100)}`);
                            }
                        }
                    }
                    
                    let content = '';
                    if (result.data) {
                        content = result.data;
                    } else if (result.content) {
                        content = result.content;
                    } else if (result.message && result.message.content) {
                        content = result.message.content;
                    } else if (result.message && typeof result.message === 'string') {
                        content = result.message;
                    } else if (typeof result === 'string') {
                        content = result;
                    } else {
                        content = JSON.stringify(result);
                    }
                    
                    if (content && content.trim()) {
                        // å†…å®¹æå–æˆåŠŸ
                    } else if (result.status !== undefined && result.status !== 200) {
                        content = result.msg || 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†é”™è¯¯ã€‚';
                        throw new Error(content);
                    } else if (result.msg && !content) {
                        content = result.msg;
                        throw new Error(content);
                    }
                    
                    if (messageAvatar) {
                        messageAvatar.style.animation = '';
                    }
                    
                    if (messageText) {
                        if (!content || !content.trim()) {
                            content = 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–åˆ°æœ‰æ•ˆå†…å®¹ã€‚';
                        }
                        messageText.innerHTML = this.renderMarkdown(content);
                        messageText.setAttribute('data-original-text', content);
                        
                        if (content && content.trim()) {
                            const copyButtonContainer = message.querySelector('[data-copy-button-container]');
                            if (copyButtonContainer) {
                                this.addCopyButton(copyButtonContainer, messageText);
                            }
                            const petMessages = Array.from(messagesContainer.children).filter(
                                child => child.querySelector('[data-message-type="pet-bubble"]')
                            );
                            if (petMessages.length > 1) {
                                const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                                if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                    this.addTryAgainButton(tryAgainContainer, message);
                                }
                            }
                            
                            await this.addActionButtonsToMessage(message);
                        }
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                    
                    // ç«‹å³ä¿å­˜å® ç‰©å›å¤åˆ°å½“å‰ä¼šè¯
                    this.skipSessionListRefresh = true;
                    if (content && content.trim()) {
                        await this.addMessageToSession('pet', content, null, false);
                    }
                    
                    // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                    await this.saveCurrentSession(false, false);
                    
                    // prompt æ¥å£è°ƒç”¨åå¿…é¡»è§¦å‘ session/save
                    if (this.currentSessionId) {
                        if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                            try {
                                await this.syncSessionToBackend(this.currentSessionId, true);
                                console.log(`prompt æ¥å£è°ƒç”¨åï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
                            } catch (error) {
                                console.warn('ä¿å­˜ä¼šè¯åˆ°åç«¯å¤±è´¥:', error);
                            }
                        } else {
                            console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šsessionApi æœªåˆå§‹åŒ–æˆ–åç«¯åŒæ­¥æœªå¯ç”¨');
                        }
                    } else {
                        console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šå½“å‰ä¼šè¯ ID ä¸å­˜åœ¨');
                    }
                    
                    button.innerHTML = 'âœ“';
                    button.style.cursor = 'default';
                    button.style.color = '#4caf50';
                    
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                        button.title = originalTitle;
                        button.style.color = '#666';
                        button.style.cursor = 'pointer';
                        button.style.opacity = '1';
                        processingFlag.value = false;
                    }, 2000);
                } catch (error) {
                    const isAbortError = error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ';
                    
                    if (!isAbortError) {
                        console.error(`ç”Ÿæˆ${roleLabel}å¤±è´¥:`, error);
                    }
                    
                    if (!isAbortError && messageText) {
                        const errorMessage = error.message && error.message.includes('HTTP error') 
                            ? `æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼ˆ${error.message}ï¼‰ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚${roleIcon}`
                            : `æŠ±æ­‰ï¼Œæ— æ³•ç”Ÿæˆ${roleLabel}ã€‚${error.message ? `é”™è¯¯ä¿¡æ¯ï¼š${error.message}` : 'æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢åé‡è¯•ã€‚'}${roleIcon}`;
                        messageText.innerHTML = this.renderMarkdown(errorMessage);
                        const petMessages = Array.from(messagesContainer.children).filter(
                            child => child.querySelector('[data-message-type="pet-bubble"]')
                        );
                        if (petMessages.length > 1) {
                            const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                            if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                this.addTryAgainButton(tryAgainContainer, message);
                            }
                        }
                        await this.addActionButtonsToMessage(message);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    } else if (isAbortError && message) {
                        message.remove();
                    }
                    
                    if (!isAbortError) {
                        button.innerHTML = 'âœ•';
                        button.style.cursor = 'default';
                        button.style.color = '#f44336';
                        
                        setTimeout(() => {
                            button.innerHTML = originalIcon;
                            button.title = originalTitle;
                            button.style.color = '#666';
                            button.style.cursor = 'pointer';
                            button.style.opacity = '1';
                            processingFlag.value = false;
                        }, 1500);
                    } else {
                        button.innerHTML = originalIcon;
                        button.title = originalTitle;
                        button.style.color = '#666';
                        button.style.cursor = 'pointer';
                        button.style.opacity = '1';
                        processingFlag.value = false;
                    }
                } finally {
                    if (messageAvatar) {
                        messageAvatar.style.animation = '';
                    }
                }
            });
            
            actionsContainer.appendChild(button);
        }
        
        // æ·»åŠ ä¼å¾®æœºå™¨äººæŒ‰é’®ï¼ˆå‚è€ƒè§’è‰²æŒ‰é’®å»é‡é€»è¾‘ï¼‰
        const robotConfigs = await this.getWeWorkRobotConfigs();
        // æ£€æŸ¥å®¹å™¨ä¸­å·²å­˜åœ¨çš„æœºå™¨äººæŒ‰é’®IDï¼Œé¿å…é‡å¤æ·»åŠ 
        // éœ€è¦åŒæ—¶æ£€æŸ¥ actionsContainer å’Œ copyButtonContainerï¼ˆç”¨æˆ·æ¶ˆæ¯æ—¶æŒ‰é’®ä¼šç§»åŠ¨åˆ° copyButtonContainerï¼‰
        const existingRobotIds = new Set();
        const existingRobotButtons = actionsContainer.querySelectorAll('[data-robot-id]');
        existingRobotButtons.forEach(btn => {
            const robotId = btn.getAttribute('data-robot-id');
            if (robotId) {
                existingRobotIds.add(robotId);
            }
        });
        // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œè¿˜éœ€è¦æ£€æŸ¥ copyButtonContainer ä¸­æ˜¯å¦å·²æœ‰æŒ‰é’®
        if (isUserMessage && copyButtonContainer) {
            const existingButtonsInCopyContainer = copyButtonContainer.querySelectorAll('[data-robot-id]');
            existingButtonsInCopyContainer.forEach(btn => {
                const robotId = btn.getAttribute('data-robot-id');
                if (robotId) {
                    existingRobotIds.add(robotId);
                }
            });
        }
        
        for (const robotConfig of robotConfigs) {
            if (!robotConfig || !robotConfig.webhookUrl) continue;
            
            // å¦‚æœå·²å­˜åœ¨ç›¸åŒIDçš„æŒ‰é’®ï¼Œè·³è¿‡ï¼ˆå»é‡ï¼‰
            if (existingRobotIds.has(robotConfig.id)) {
                continue;
            }
            
            const robotButton = document.createElement('span');
            robotButton.setAttribute('data-robot-id', robotConfig.id);
            robotButton.style.cssText = `
                padding: 4px !important;
                cursor: pointer !important;
                font-size: 16px !important;
                color: #666 !important;
                font-weight: 300 !important;
                transition: all 0.2s ease !important;
                flex-shrink: 0 !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                user-select: none !important;
                width: 22px !important;
                height: 22px !important;
                line-height: 22px !important;
            `;
            
            robotButton.innerHTML = robotConfig.icon || 'ğŸ¤–';
            robotButton.title = robotConfig.name || 'ä¼å¾®æœºå™¨äºº';
            
            robotButton.addEventListener('mouseenter', function() {
                this.style.fontSize = '18px';
                this.style.color = '#333';
                this.style.transform = 'scale(1.1)';
            });
            robotButton.addEventListener('mouseleave', function() {
                this.style.fontSize = '16px';
                this.style.color = '#666';
                this.style.transform = 'scale(1)';
            });
            
            robotButton.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                // è·å–å½“å‰æ¶ˆæ¯çš„å†…å®¹ï¼ˆæ”¯æŒç”¨æˆ·æ¶ˆæ¯å’Œå® ç‰©æ¶ˆæ¯ï¼‰
                const messageBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]') || 
                                     messageDiv.querySelector('[data-message-type="user-bubble"]');
                let messageContent = '';
                if (messageBubble) {
                    messageContent = messageBubble.getAttribute('data-original-text') || 
                                   messageBubble.innerText || 
                                   messageBubble.textContent || '';
                }
                
                if (!messageContent || !messageContent.trim()) {
                    this.showNotification('æ¶ˆæ¯å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å‘é€', 'error');
                    return;
                }
                
                const trimmedContent = messageContent.trim();
                const contentLength = trimmedContent.length;
                
                // æ£€æŸ¥å†…å®¹é•¿åº¦é™åˆ¶ï¼ˆ4000å­—ç¬¦ï¼‰
                const MAX_CONTENT_LENGTH = 4000;
                if (contentLength > MAX_CONTENT_LENGTH) {
                    this.showNotification(
                        `æ¶ˆæ¯å†…å®¹è¿‡é•¿ï¼ˆ${contentLength} å­—ç¬¦ï¼‰ï¼Œè¶…è¿‡é™åˆ¶ï¼ˆ${MAX_CONTENT_LENGTH} å­—ç¬¦ï¼‰ï¼Œæ— æ³•å‘é€åˆ°ä¼å¾®æœºå™¨äºº`,
                        'error'
                    );
                    return;
                }
                
                // æ˜¾ç¤ºå‘é€çŠ¶æ€
                const originalIcon = robotButton.innerHTML;
                robotButton.innerHTML = 'â³';
                robotButton.style.color = '#2196F3';
                robotButton.style.cursor = 'default';
                
                try {
                    let finalContent = '';
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ markdown æ ¼å¼
                    if (this.isMarkdownFormat(trimmedContent)) {
                        // å·²ç»æ˜¯ markdown æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                        finalContent = trimmedContent;
                        console.log(`[ä¼å¾®æœºå™¨äºº] å†…å®¹å·²æ˜¯ markdown æ ¼å¼ï¼Œé•¿åº¦: ${finalContent.length}`);
                    } else {
                        // ä¸æ˜¯ markdown æ ¼å¼ï¼Œè½¬æ¢ä¸º markdown
                        console.log('[ä¼å¾®æœºå™¨äºº] å†…å®¹ä¸æ˜¯ markdown æ ¼å¼ï¼Œè½¬æ¢ä¸º markdown...');
                        finalContent = await this.convertToMarkdown(trimmedContent);
                        console.log(`[ä¼å¾®æœºå™¨äºº] è½¬æ¢åé•¿åº¦: ${finalContent.length}`);
                    }
                    
                    // ç¡®ä¿ä¸è¶…è¿‡ 4096 å­—ç¬¦é™åˆ¶ï¼ˆä¼ä¸šå¾®ä¿¡æœºå™¨äººçš„ç¡¬æ€§é™åˆ¶ï¼‰
                    const MAX_MARKDOWN_LENGTH = 4096;
                    if (finalContent.length > MAX_MARKDOWN_LENGTH) {
                        console.warn(`[ä¼å¾®æœºå™¨äºº] è½¬æ¢åé•¿åº¦ ${finalContent.length} è¶…è¿‡ ${MAX_MARKDOWN_LENGTH}ï¼Œè¿›è¡Œæˆªæ–­`);
                        finalContent = this.limitMarkdownLength(finalContent, MAX_MARKDOWN_LENGTH);
                    }
                    
                    // å‘é€åˆ°ä¼å¾®æœºå™¨äºº
                    await this.sendToWeWorkRobot(robotConfig.webhookUrl, finalContent);
                    robotButton.innerHTML = 'âœ“';
                    robotButton.style.color = '#4caf50';
                    this.showNotification(`å·²å‘é€åˆ° ${robotConfig.name || 'ä¼å¾®æœºå™¨äºº'}`, 'success');
                    
                    setTimeout(() => {
                        robotButton.innerHTML = originalIcon;
                        robotButton.style.color = '#666';
                        robotButton.style.cursor = 'pointer';
                    }, 2000);
                } catch (error) {
                    console.error('å‘é€åˆ°ä¼å¾®æœºå™¨äººå¤±è´¥:', error);
                    robotButton.innerHTML = 'âœ•';
                    robotButton.style.color = '#f44336';
                    this.showNotification(`å‘é€å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    
                    setTimeout(() => {
                        robotButton.innerHTML = originalIcon;
                        robotButton.style.color = '#666';
                        robotButton.style.cursor = 'pointer';
                    }, 2000);
                }
            });
            
            actionsContainer.appendChild(robotButton);
        }
        
        // ä¼å¾®æœºå™¨äººè®¾ç½®æŒ‰é’®å·²ç§»åŠ¨åˆ° chat-request-status-button åé¢ï¼Œä¸å†æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨ä¸­
        
        // åªæœ‰åœ¨æŒ‰é’®å®¹å™¨ä¸­æœ‰æŒ‰é’®æ—¶æ‰æ’å…¥åˆ°DOMä¸­
        if (actionsContainer.children.length > 0) {
            // æ£€æŸ¥æ˜¯ç”¨æˆ·æ¶ˆæ¯è¿˜æ˜¯å® ç‰©æ¶ˆæ¯
            // isUserMessage å’Œ copyButtonContainer å·²åœ¨å‡½æ•°å¼€å§‹å¤„å£°æ˜
            const messageTimeWrapper = timeAndCopyContainer.querySelector('[data-message-time]')?.parentElement;
            
            if (isUserMessage) {
                // ç”¨æˆ·æ¶ˆæ¯ï¼šå°†æ‰€æœ‰æŒ‰é’®ï¼ˆç¼–è¾‘ã€åˆ é™¤ã€è§’è‰²æŒ‰é’®ç­‰ï¼‰éƒ½æ”¾åœ¨ copyButtonContainer å†…éƒ¨
                // è¿™æ ·æ‰€æœ‰æŒ‰é’®éƒ½ä¼šåœ¨ä¸€èµ·
                if (copyButtonContainer) {
                    // å°† actionsContainer ä¸­çš„æ‰€æœ‰æŒ‰é’®ç§»åŠ¨åˆ° copyButtonContainer å†…éƒ¨
                    // å…ˆç§»é™¤ actionsContainer çš„æ ·å¼ï¼Œå› ä¸ºæŒ‰é’®ä¼šç›´æ¥æ·»åŠ åˆ° copyButtonContainer
                    actionsContainer.style.cssText = '';
                    // å°† actionsContainer ä¸­çš„æ‰€æœ‰å­å…ƒç´ ç§»åŠ¨åˆ° copyButtonContainer
                    while (actionsContainer.firstChild) {
                        copyButtonContainer.appendChild(actionsContainer.firstChild);
                    }
                    // ç§»é™¤ç©ºçš„ actionsContainer
                    actionsContainer.remove();
                    // ç¡®ä¿ copyButtonContainer ä½¿ç”¨ flex å¸ƒå±€ï¼ŒæŒ‰é’®ä¹‹é—´æœ‰é—´è·ï¼Œä¿ç•™åŸæœ‰æ ·å¼
                    if (!copyButtonContainer.style.display || copyButtonContainer.style.display === 'none') {
                        copyButtonContainer.style.display = 'flex';
                    }
                    copyButtonContainer.style.alignItems = 'center';
                    copyButtonContainer.style.gap = '8px';
                } else if (messageTimeWrapper) {
                    // å¦‚æœæ²¡æœ‰å¤åˆ¶æŒ‰é’®å®¹å™¨ï¼Œæ’å…¥åˆ°æ—¶é—´åŒ…è£…å™¨ä¹‹å‰
                    timeAndCopyContainer.insertBefore(actionsContainer, messageTimeWrapper);
                } else {
                    // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œæ·»åŠ åˆ°å¼€å¤´
                    timeAndCopyContainer.insertBefore(actionsContainer, timeAndCopyContainer.firstChild);
                }
            } else {
                // å® ç‰©æ¶ˆæ¯ï¼šæŒ‰é’®åº”è¯¥æ’å…¥åˆ°æ—¶é—´åŒ…è£…å™¨ä¹‹åï¼Œå¤åˆ¶æŒ‰é’®ä¹‹å‰
                if (messageTimeWrapper && messageTimeWrapper.parentNode === timeAndCopyContainer) {
                    if (copyButtonContainer) {
                        // å¦‚æœå­˜åœ¨å¤åˆ¶æŒ‰é’®å®¹å™¨ï¼Œå°†æŒ‰é’®æ’å…¥åˆ°å®ƒä¹‹å‰
                        timeAndCopyContainer.insertBefore(actionsContainer, copyButtonContainer);
                    } else {
                        // å¦‚æœæ²¡æœ‰å¤åˆ¶æŒ‰é’®å®¹å™¨ï¼Œå°†æŒ‰é’®æ’å…¥åˆ°æ—¶é—´åŒ…è£…å™¨ä¹‹å
                        timeAndCopyContainer.insertBefore(actionsContainer, messageTimeWrapper.nextSibling);
                    }
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ° messageTimeWrapper æˆ–è€…ç»“æ„ä¸å¯¹ï¼Œå°è¯•æ‰¾åˆ°ç¬¬ä¸€ä¸ªå­å…ƒç´ ä¹‹åæ’å…¥
                    const firstChild = timeAndCopyContainer.firstElementChild;
                    if (firstChild && firstChild.nextSibling) {
                        timeAndCopyContainer.insertBefore(actionsContainer, firstChild.nextSibling);
                    } else {
                        // å¦‚æœæ²¡æœ‰åˆé€‚çš„æ’å…¥ä½ç½®ï¼Œæ·»åŠ åˆ°å¼€å¤´ï¼ˆåœ¨ç¬¬ä¸€ä¸ªå­å…ƒç´ ä¹‹å‰ï¼‰
                        if (firstChild) {
                            timeAndCopyContainer.insertBefore(actionsContainer, firstChild);
                        } else {
                            timeAndCopyContainer.appendChild(actionsContainer);
                        }
                    }
                }
            }
        }
        
        // æ·»åŠ æ’åºæŒ‰é’®ï¼ˆåœ¨åŠ¨ä½œæŒ‰é’®ä¹‹åï¼‰
        if (copyButtonContainer) {
            this.addSortButtons(copyButtonContainer, messageDiv);
        }
    }
    
    // åˆ·æ–°æ‰€æœ‰æ¶ˆæ¯çš„åŠ¨ä½œæŒ‰é’®ï¼ˆåœ¨è§’è‰²è®¾ç½®æ›´æ–°åè°ƒç”¨ï¼‰
    async refreshAllMessageActionButtons() {
        if (!this.chatWindow) return;
        
        const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
        if (!messagesContainer) return;
        
        // æŸ¥æ‰¾æ‰€æœ‰æœ‰æŒ‰é’®å®¹å™¨çš„æ¶ˆæ¯ï¼ˆä¸åŒ…æ‹¬ç¬¬ä¸€æ¡æ¬¢è¿æ¶ˆæ¯ï¼‰
        const allMessages = Array.from(messagesContainer.children).filter(
            child => child.querySelector('[data-message-type="pet-bubble"]')
        );
        
        // è·³è¿‡ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œä»ç¬¬äºŒæ¡å¼€å§‹åˆ·æ–°
        for (let i = 1; i < allMessages.length; i++) {
            const messageDiv = allMessages[i];
            // å¼ºåˆ¶åˆ·æ–°æŒ‰é’®
            await this.addActionButtonsToMessage(messageDiv, true);
        }
    }

    // æ„å»ºä¼šè¯ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«æ¶ˆæ¯å†å²å’Œé¡µé¢å†…å®¹ï¼‰
    buildConversationContext() {
        const context = {
            messages: [],
            pageContent: '',
            hasHistory: false
        };

        // è·å–å½“å‰ä¼šè¯
        if (this.currentSessionId && this.sessions[this.currentSessionId]) {
            const session = this.sessions[this.currentSessionId];
            
            // è·å–æ¶ˆæ¯å†å²ï¼ˆæ’é™¤æ¬¢è¿æ¶ˆæ¯å’ŒæŒ‰é’®æ“ä½œç”Ÿæˆçš„æ¶ˆæ¯ï¼‰
            if (session.messages && Array.isArray(session.messages) && session.messages.length > 0) {
                context.messages = session.messages.filter(msg => {
                    // åªåŒ…å«ç”¨æˆ·æ¶ˆæ¯å’Œå® ç‰©æ¶ˆæ¯ï¼Œæ’é™¤æŒ‰é’®æ“ä½œç”Ÿæˆçš„æ¶ˆæ¯
                    return msg.type === 'user' || msg.type === 'pet';
                });
                context.hasHistory = context.messages.length > 0;
            }
            
            // è·å–é¡µé¢å†…å®¹
            if (session.pageContent && session.pageContent.trim()) {
                context.pageContent = session.pageContent.trim();
            }
        }

        return context;
    }

    // æ„å»ºåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡çš„ fromUser å‚æ•°
    buildFromUserWithContext(baseUserPrompt, roleLabel) {
        // æ£€æŸ¥é¡µé¢ä¸Šä¸‹æ–‡å¼€å…³çŠ¶æ€
        let includeContext = true; // é»˜è®¤åŒ…å«ä¸Šä¸‹æ–‡
        const contextSwitch = this.chatWindow ? this.chatWindow.querySelector('#context-switch') : null;
        if (contextSwitch) {
            includeContext = contextSwitch.checked;
        }
        
        const context = this.buildConversationContext();
        
        // å¦‚æœ baseUserPrompt å·²ç»åŒ…å«äº†é¡µé¢å†…å®¹ï¼Œæ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ›¿æ¢æˆ–ç§»é™¤
        let finalBasePrompt = baseUserPrompt;
        if (baseUserPrompt.includes('é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š')) {
            if (includeContext && context.pageContent) {
                // å¼€å…³æ‰“å¼€ä¸”æœ‰ä¼šè¯é¡µé¢å†…å®¹ï¼šä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢ä¸Šä¸‹æ–‡æ›¿æ¢å®ƒ
                const pageContentMatch = baseUserPrompt.match(/é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š\s*\n([\s\S]*?)(?=\n\n|$)/);
                if (pageContentMatch) {
                    // æ›¿æ¢ä¸ºä¼šè¯ä¿å­˜çš„é¡µé¢å†…å®¹
                    finalBasePrompt = baseUserPrompt.replace(
                        /é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š\s*\n[\s\S]*?(?=\n\n|$)/,
                        `é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š\n${context.pageContent}`
                    );
                }
            } else if (!includeContext) {
                // å¼€å…³å…³é—­ï¼šç§»é™¤é¡µé¢å†…å®¹éƒ¨åˆ†
                finalBasePrompt = baseUserPrompt.replace(
                    /é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š\s*\n[\s\S]*?(?=\n\n|$)/,
                    'é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š\næ— å†…å®¹ï¼ˆé¡µé¢ä¸Šä¸‹æ–‡å·²å…³é—­ï¼‰'
                );
            }
        }
        
        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯å†å²ï¼Œç›´æ¥ä½¿ç”¨åŸºç¡€æç¤ºè¯ï¼ˆå¯èƒ½å·²åŒ…å«é¡µé¢å†…å®¹ï¼‰
        if (!context.hasHistory) {
            // å¦‚æœå¼€å…³æ‰“å¼€ã€baseUserPrompt ä¸­æ²¡æœ‰é¡µé¢å†…å®¹ï¼Œä½†ä¼šè¯æœ‰é¡µé¢å†…å®¹ï¼Œæ·»åŠ é¡µé¢å†…å®¹
            if (includeContext && context.pageContent && !finalBasePrompt.includes('é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š')) {
                const pageContext = '\n\n## é¡µé¢å†…å®¹ï¼š\n\n' + context.pageContent;
                return finalBasePrompt + pageContext;
            }
            return finalBasePrompt;
        }

        // æ„å»ºæ¶ˆæ¯å†å²ä¸Šä¸‹æ–‡
        let conversationContext = '';
        if (context.messages.length > 0) {
            conversationContext = '\n\n## ä¼šè¯å†å²ï¼š\n\n';
            context.messages.forEach((msg, index) => {
                const role = msg.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                const content = msg.content.trim();
                if (content) {
                    conversationContext += `${role}ï¼š${content}\n\n`;
                }
            });
        }

        // å¦‚æœå¼€å…³æ‰“å¼€ã€baseUserPrompt ä¸­æ²¡æœ‰é¡µé¢å†…å®¹ï¼Œä½†ä¼šè¯æœ‰é¡µé¢å†…å®¹ï¼Œæ·»åŠ é¡µé¢å†…å®¹
        let pageContext = '';
        if (includeContext && context.pageContent && !finalBasePrompt.includes('é¡µé¢å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ï¼š')) {
            pageContext = '\n\n## é¡µé¢å†…å®¹ï¼š\n\n' + context.pageContent;
        }

        // ç»„åˆï¼šåŸºç¡€æç¤ºè¯ï¼ˆå·²åŒ…å«ä¼šè¯çš„é¡µé¢ä¸Šä¸‹æ–‡ï¼‰+ ä¼šè¯å†å² + é¡µé¢å†…å®¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
        return finalBasePrompt + conversationContext + pageContext;
    }

    // åˆ›å»ºè§’è‰²æŒ‰é’®ç‚¹å‡»å¤„ç†å‡½æ•°ï¼ˆç”¨äºæœ‰ actionKey çš„è§’è‰²ï¼‰
    createRoleButtonHandler(actionKey, iconEl, processingFlag) {
        return async () => {
            if (processingFlag.value) return;

            processingFlag.value = true;

            // è·å–æ¶ˆæ¯å®¹å™¨
            const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
            if (!messagesContainer) {
                console.error('æ— æ³•æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
                processingFlag.value = false;
                return;
            }

            // è·å–é¡µé¢ä¿¡æ¯ï¼šä¼˜å…ˆä½¿ç”¨å½“å‰ä¼šè¯ä¿å­˜çš„é¡µé¢ä¸Šä¸‹æ–‡
            let pageInfo;
            if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                const session = this.sessions[this.currentSessionId];
                pageInfo = {
                    title: session.pageTitle || document.title || 'å½“å‰é¡µé¢',
                    url: session.url || window.location.href,
                    description: session.pageDescription || '',
                    content: session.pageContent || '' // ä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢å†…å®¹
                };
            } else {
                // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ï¼Œä½¿ç”¨å½“å‰é¡µé¢ä¿¡æ¯
                pageInfo = this.getPageInfo();
            }
            
            // ä»è§’è‰²é…ç½®ä¸­è·å–æç¤ºè¯­ã€åç§°ã€å›¾æ ‡
            let roleInfo;
            try {
                roleInfo = await this.getRolePromptForAction(actionKey, pageInfo);
            } catch (error) {
                console.error('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥:', error);
                roleInfo = {
                    systemPrompt: '',
                    userPrompt: '',
                    label: 'è‡ªå®šä¹‰è§’è‰²',
                    icon: 'ğŸ™‚'
                };
            }

            // æ„å»ºåŒ…å«ä¼šè¯ä¸Šä¸‹æ–‡çš„ fromUser å‚æ•°ï¼ˆä¼šä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢ä¸Šä¸‹æ–‡ï¼‰
            const fromUser = this.buildFromUserWithContext(roleInfo.userPrompt, roleInfo.label);

            // æ‰¾åˆ°æŒ‰é’®æ‰€åœ¨çš„æ¶ˆæ¯å…ƒç´ ï¼ˆå‘ä¸ŠæŸ¥æ‰¾åŒ…å«ç”¨æˆ·æ¶ˆæ¯çš„å…ƒç´ ï¼‰
            let userMessageDiv = null;
            let currentElement = iconEl;
            while (currentElement && currentElement !== messagesContainer) {
                // æ£€æŸ¥å½“å‰å…ƒç´ æ˜¯å¦åŒ…å« user-bubble
                if (currentElement.querySelector) {
                    const userBubble = currentElement.querySelector('[data-message-type="user-bubble"]');
                    if (userBubble) {
                        userMessageDiv = currentElement;
                        break;
                    }
                }
                // å¦‚æœå½“å‰å…ƒç´ æœ‰ data-message-id å±æ€§ï¼Œä¹Ÿæ£€æŸ¥å®ƒæ˜¯å¦åŒ…å« user-bubbleï¼ˆæ¶ˆæ¯å…ƒç´ æœ‰è¯¥å±æ€§ï¼‰
                if (currentElement.hasAttribute && currentElement.hasAttribute('data-message-id')) {
                    const userBubble = currentElement.querySelector('[data-message-type="user-bubble"]');
                    if (userBubble) {
                        userMessageDiv = currentElement;
                        break;
                    }
                }
                currentElement = currentElement.parentElement;
            }

            // åˆ›å»ºæ–°çš„æ¶ˆæ¯ï¼ˆæŒ‰é’®æ“ä½œç”Ÿæˆçš„æ¶ˆæ¯ï¼‰
            const message = this.createMessageElement('', 'pet');
            message.setAttribute('data-button-action', 'true'); // æ ‡è®°ä¸ºæŒ‰é’®æ“ä½œç”Ÿæˆ
            messagesContainer.appendChild(message);
            const messageText = message.querySelector('[data-message-type="pet-bubble"]');
            const messageAvatar = message.querySelector('[data-message-type="pet-avatar"]');

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            if (messageAvatar) {
                messageAvatar.style.animation = 'petTyping 1.2s ease-in-out infinite';
            }

            // ä½¿ç”¨è§’è‰²é…ç½®ä¸­çš„å›¾æ ‡æ˜¾ç¤ºåŠ è½½æ–‡æœ¬
            const loadingIcon = roleInfo.icon || 'ğŸ“–';
            if (messageText) {
                messageText.textContent = `${loadingIcon} æ­£åœ¨${roleInfo.label || 'å¤„ç†'}...`;
            }

            try {
                // ä½¿ç”¨ /prompt æ¥å£ç”Ÿæˆå†…å®¹ï¼ˆéæµå¼ï¼‰
                console.log('è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆå†…å®¹ï¼Œè§’è‰²:', roleInfo.label, 'é¡µé¢æ ‡é¢˜:', pageInfo.title || 'å½“å‰é¡µé¢');
                
                // åˆ›å»º AbortController ç”¨äºç»ˆæ­¢è¯·æ±‚
                const abortController = new AbortController();
                
                // è®¾ç½®æ ‡å¿—ï¼Œé¿å… prompt è°ƒç”¨åè§¦å‘ä¼šè¯åˆ—è¡¨åˆ·æ–°æ¥å£
                this.skipSessionListRefresh = true;
                
                // ä½¿ç”¨ç»Ÿä¸€çš„ payload æ„å»ºå‡½æ•°ï¼Œè‡ªåŠ¨åŒ…å«ä¼šè¯ ID
                // å¦‚æœæ‰¾åˆ°äº†ç”¨æˆ·æ¶ˆæ¯å…ƒç´ ï¼Œå°†å…¶ä¼ é€’ç»™ buildPromptPayloadï¼Œä»¥ä¾¿ä»æ­£ç¡®çš„æ¶ˆæ¯ä¸­æå–å›¾ç‰‡
                const payload = this.buildPromptPayload(
                    roleInfo.systemPrompt,
                    fromUser,
                    this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3'),
                    { messageDiv: userMessageDiv }
                );
                
                const response = await fetch(PET_CONFIG.api.promptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                
                // å¤„ç†åç«¯è¿”å›çš„ä¼šè¯ IDï¼ˆå¦‚æœè¿”å›äº†ï¼‰
                if (result.conversation_id) {
                    const conversationId = result.conversation_id;
                    if (conversationId && !this.currentSessionId) {
                        // å¦‚æœå½“å‰æ²¡æœ‰ä¼šè¯ IDï¼Œä½¿ç”¨åç«¯è¿”å›çš„ä¼šè¯ ID
                        this.currentSessionId = conversationId;
                        console.log('ä»åç«¯åŒæ­¥ä¼šè¯ ID:', conversationId);
                        // ç¡®ä¿ä¼šè¯å­˜åœ¨
                        if (!this.sessions[this.currentSessionId]) {
                            // åˆ›å»ºåŸºç¡€ä¼šè¯å¯¹è±¡
                            const pageInfo = this.getPageInfo();
                            const newSession = this.createSessionObject(conversationId, pageInfo);
                            this.sessions[conversationId] = newSession;
                            // æ ‡è®°å½“å‰é¡µé¢å·²è‡ªåŠ¨åˆ›å»ºä¼šè¯
                            this.hasAutoCreatedSessionForPage = true;
                            this.currentPageUrl = pageInfo.url;
                        }
                    } else if (conversationId && this.currentSessionId !== conversationId) {
                        // å¦‚æœåç«¯è¿”å›çš„ä¼šè¯ ID ä¸å½“å‰ä¸åŒï¼Œè®°å½•æ—¥å¿—
                        console.log('åç«¯è¿”å›çš„ä¼šè¯ ID ä¸å½“å‰ä¸åŒ:', conversationId, 'vs', this.currentSessionId);
                    }
                }
                
                // é€‚é…å“åº”æ ¼å¼: {status, msg, data, pagination}
                let content = '';
                if (result.status === 200 && result.data) {
                    // æˆåŠŸå“åº”ï¼Œæå– data å­—æ®µ
                    content = result.data;
                } else if (result.status !== 200) {
                    // API è¿”å›é”™è¯¯ï¼Œä½¿ç”¨ msg å­—æ®µ
                    content = result.msg || 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†é”™è¯¯ã€‚';
                    throw new Error(content);
                } else if (result.content) {
                    content = result.content;
                } else if (result.message) {
                    content = result.message;
                } else if (typeof result === 'string') {
                    content = result;
                } else {
                    // æœªçŸ¥æ ¼å¼ï¼Œå°è¯•æå–å¯èƒ½çš„æ–‡æœ¬å†…å®¹
                    content = JSON.stringify(result);
                }

                // åœæ­¢åŠ è½½åŠ¨ç”»
                if (messageAvatar) {
                    messageAvatar.style.animation = '';
                }

                // æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹
                if (messageText) {
                    // ç¡®ä¿å†…å®¹ä¸ä¸ºç©º
                    if (!content || !content.trim()) {
                        content = 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–åˆ°æœ‰æ•ˆå†…å®¹ã€‚';
                    }
                    messageText.innerHTML = this.renderMarkdown(content);
                    // æ›´æ–°åŸå§‹æ–‡æœ¬ç”¨äºå¤åˆ¶åŠŸèƒ½
                    messageText.setAttribute('data-original-text', content);
                    // æ·»åŠ å¤åˆ¶æŒ‰é’®
                    if (content && content.trim()) {
                        const copyButtonContainer = message.querySelector('[data-copy-button-container]');
                        if (copyButtonContainer) {
                            this.addCopyButton(copyButtonContainer, messageText);
                        }
                        // æ·»åŠ  try again æŒ‰é’®ï¼ˆä»…å½“ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰
                        const petMessages = Array.from(messagesContainer.children).filter(
                            child => child.querySelector('[data-message-type="pet-bubble"]')
                        );
                        if (petMessages.length > 1) {
                            const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                            if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                                this.addTryAgainButton(tryAgainContainer, message);
                            }
                        }
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }

                // ç«‹å³ä¿å­˜å® ç‰©å›å¤åˆ°å½“å‰ä¼šè¯ï¼ˆå‚è€ƒç”¨æˆ·è¾“å…¥åçš„ä¿å­˜é€»è¾‘ï¼‰
                // è®¾ç½®æ ‡å¿—ï¼Œé¿å…è§¦å‘ä¼šè¯åˆ—è¡¨åˆ·æ–°æ¥å£ï¼ˆprompt æ¥å£è°ƒç”¨å®Œæˆåä¼šè§¦å‘ session/saveï¼‰
                this.skipSessionListRefresh = true;
                if (content && content.trim()) {
                    await this.addMessageToSession('pet', content, null, false);
                }

                // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                await this.saveCurrentSession(false, false);
                
                // è¯·æ±‚ç»“æŸåè°ƒç”¨ session/save ä¿å­˜ä¼šè¯åˆ°åç«¯
                if (this.currentSessionId) {
                    if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                        try {
                            await this.syncSessionToBackend(this.currentSessionId, true);
                            console.log(`è§’è‰²æŒ‰é’®æ“ä½œåï¼Œä¼šè¯ ${this.currentSessionId} å·²ä¿å­˜åˆ°åç«¯`);
                        } catch (error) {
                            console.warn('ä¿å­˜ä¼šè¯åˆ°åç«¯å¤±è´¥:', error);
                        }
                    } else {
                        console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šsessionApi æœªåˆå§‹åŒ–æˆ–åç«¯åŒæ­¥æœªå¯ç”¨');
                    }
                } else {
                    console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šå½“å‰ä¼šè¯ ID ä¸å­˜åœ¨');
                }

                iconEl.innerHTML = 'âœ“';
                iconEl.style.cursor = 'default';
                iconEl.style.color = '#4caf50';

                // 2ç§’åæ¢å¤åˆå§‹çŠ¶æ€ï¼Œå…è®¸å†æ¬¡ç‚¹å‡»ï¼ˆæ ¹æ®è§’è‰²è®¾ç½®æ¢å¤å›¾æ ‡ä¸æ ‡é¢˜ï¼‰
                setTimeout(() => {
                    this.applyRoleConfigToActionIcon(iconEl, actionKey);
                    iconEl.style.color = '#666';
                    iconEl.style.cursor = 'pointer';
                    iconEl.style.opacity = '1';
                    processingFlag.value = false;
                }, 2000);

            } catch (error) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯å–æ¶ˆé”™è¯¯
                const isAbortError = error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ';
                
                if (!isAbortError) {
                    console.error(`ç”Ÿæˆ${roleInfo.label}å¤±è´¥:`, error);
                }
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ˆå–æ¶ˆæ—¶ä¸æ˜¾ç¤ºï¼‰
                if (!isAbortError && messageText) {
                    const errorMessage = error.message && error.message.includes('HTTP error') 
                        ? `æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼ˆ${error.message}ï¼‰ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚${loadingIcon}`
                        : `æŠ±æ­‰ï¼Œæ— æ³•ç”Ÿæˆ"${pageInfo.title || 'å½“å‰é¡µé¢'}"çš„${roleInfo.label || 'å†…å®¹'}ã€‚${error.message ? `é”™è¯¯ä¿¡æ¯ï¼š${error.message}` : 'æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢åé‡è¯•ã€‚'}${loadingIcon}`;
                    messageText.innerHTML = this.renderMarkdown(errorMessage);
                    // æ·»åŠ  try again æŒ‰é’®ï¼ˆä»…å½“ä¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶ï¼‰
                    const petMessages = Array.from(messagesContainer.children).filter(
                        child => child.querySelector('[data-message-type="pet-bubble"]')
                    );
                    if (petMessages.length > 1) {
                        const tryAgainContainer = message.querySelector('[data-try-again-button-container]');
                        if (tryAgainContainer && !tryAgainContainer.querySelector('.try-again-button')) {
                            this.addTryAgainButton(tryAgainContainer, message);
                        }
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else if (isAbortError && messageText) {
                    // è¯·æ±‚è¢«å–æ¶ˆï¼Œç§»é™¤æ¶ˆæ¯
                    message.remove();
                }
                
                if (!isAbortError) {
                    iconEl.innerHTML = 'âœ•';
                    iconEl.style.cursor = 'default';
                    iconEl.style.color = '#f44336';

                    // 1.5ç§’åæ¢å¤åˆå§‹çŠ¶æ€ï¼Œå…è®¸å†æ¬¡ç‚¹å‡»ï¼ˆæ ¹æ®è§’è‰²è®¾ç½®æ¢å¤å›¾æ ‡ä¸æ ‡é¢˜ï¼‰
                    setTimeout(() => {
                        this.applyRoleConfigToActionIcon(iconEl, actionKey);
                        iconEl.style.color = '#666';
                        iconEl.style.cursor = 'pointer';
                        iconEl.style.opacity = '1';
                        processingFlag.value = false;
                    }, 1500);
                } else {
                    // è¯·æ±‚è¢«å–æ¶ˆï¼Œç«‹å³æ¢å¤çŠ¶æ€
                    this.applyRoleConfigToActionIcon(iconEl, actionKey);
                    iconEl.style.color = '#666';
                    iconEl.style.cursor = 'pointer';
                    iconEl.style.opacity = '1';
                    processingFlag.value = false;
                }
            } finally {
                // ç¡®ä¿åœæ­¢åŠ è½½åŠ¨ç”»
                if (messageAvatar) {
                    messageAvatar.style.animation = '';
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        };
    }

    // å·²ç§»é™¤ custom-role-shortcuts åŠŸèƒ½

    // -------- è§’è‰²è®¾ç½®å¼¹æ¡†ï¼ˆæ–°å¢/ç¼–è¾‘/åˆ é™¤ï¼‰ --------
    openRoleSettingsModal(editId = null) {
        if (!this.chatWindow) return;
        let overlay = this.chatWindow.querySelector('#pet-role-settings');
        const currentColor = this.colors[this.colorIndex];
        const mainColor = this.getMainColorFromGradient(currentColor);
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'pet-role-settings';
            const chatHeaderEl = this.chatWindow.querySelector('.chat-header');
            const headerH = chatHeaderEl ? chatHeaderEl.offsetHeight : 60;
            overlay.style.cssText = `
                position: absolute !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                top: ${headerH}px !important;
                background: transparent !important;
                display: none !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: ${PET_CONFIG.ui.zIndex.inputContainer + 1} !important;
                pointer-events: none !important;
            `;

            const panel = document.createElement('div');
            panel.id = 'pet-role-settings-panel';
            panel.style.cssText = `
                width: calc(100% - 24px) !important;
                height: calc(100% - 12px) !important;
                margin: 0 12px 12px 12px !important;
                background: #1f1f1f !important;
                color: #fff !important;
                border-radius: 12px !important;
                border: 1px solid rgba(255,255,255,0.12) !important;
                box-shadow: 0 20px 60px rgba(0,0,0,0.35) !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
                pointer-events: auto !important;
            `;

            const header = document.createElement('div');
            header.style.cssText = `
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 16px 20px !important;
                border-bottom: 1px solid rgba(255,255,255,0.08) !important;
                background: rgba(255,255,255,0.04) !important;
                flex-shrink: 0 !important;
            `;
            const title = document.createElement('div');
            title.textContent = 'è§’è‰²è®¾ç½®';
            title.style.cssText = 'font-weight: 600; font-size: 16px; color: #fff;';

            const headerBtns = document.createElement('div');
            headerBtns.style.cssText = 'display:flex; gap:10px; align-items:center;';
            const closeBtn = document.createElement('button');
            closeBtn.id = 'pet-role-settings-close-btn';
            closeBtn.setAttribute('aria-label', 'å…³é—­è§’è‰²è®¾ç½® (Esc)');
            closeBtn.setAttribute('title', 'å…³é—­ (Esc)');
            closeBtn.textContent = 'âœ•';
            closeBtn.style.cssText = `
                width: 32px !important;
                height: 32px !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 6px !important;
                border: 1px solid rgba(255,255,255,0.15) !important;
                background: rgba(255,255,255,0.06) !important;
                color: #e5e7eb !important;
                cursor: pointer !important;
                font-size: 16px !important;
                transition: all 0.2s ease !important;
                outline: none !important;
            `;
            closeBtn.addEventListener('mouseenter', () => {
                closeBtn.style.background = 'rgba(239, 68, 68, 0.15)';
                closeBtn.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                closeBtn.style.color = '#ef4444';
                closeBtn.style.transform = 'translateY(-1px)';
            });
            closeBtn.addEventListener('mouseleave', () => {
                closeBtn.style.background = 'rgba(255,255,255,0.06)';
                closeBtn.style.borderColor = 'rgba(255,255,255,0.15)';
                closeBtn.style.color = '#e5e7eb';
                closeBtn.style.transform = 'translateY(0)';
            });
            closeBtn.addEventListener('mousedown', () => {
                closeBtn.style.transform = 'scale(0.96)';
            });
            closeBtn.addEventListener('mouseup', () => {
                closeBtn.style.transform = 'scale(1)';
            });
            closeBtn.addEventListener('click', () => this.closeRoleSettingsModal());
            headerBtns.appendChild(closeBtn);
            header.appendChild(title);
            header.appendChild(headerBtns);

            const body = document.createElement('div');
            body.id = 'pet-role-settings-body';
            body.style.cssText = `
                display: flex !important;
                gap: 16px !important;
                padding: 16px 20px !important;
                height: 100% !important;
                min-height: 0 !important;
                overflow: hidden !important;
            `;

            // å·¦ä¾§ï¼šè§’è‰²åˆ—è¡¨
            const listContainer = document.createElement('div');
            listContainer.style.cssText = `
                width: 38% !important;
                min-width: 280px !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            `;
            
            // æ–°å¢è§’è‰²æŒ‰é’®ï¼ˆæ”¾åœ¨åˆ—è¡¨é¡¶éƒ¨ï¼‰
            const addBtn = document.createElement('button');
            addBtn.textContent = 'æ–°å¢è§’è‰²';
            addBtn.style.cssText = `
                padding: 8px 16px !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                border-radius: 6px !important;
                border: 1px solid rgba(255,255,255,0.15) !important;
                background: rgba(255,255,255,0.06) !important;
                color: #e5e7eb !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                flex-shrink: 0 !important;
            `;
            addBtn.addEventListener('mouseenter', () => {
                addBtn.style.background = 'rgba(255,255,255,0.12)';
                addBtn.style.borderColor = 'rgba(255,255,255,0.25)';
                addBtn.style.transform = 'translateY(-1px)';
            });
            addBtn.addEventListener('mouseleave', () => {
                addBtn.style.background = 'rgba(255,255,255,0.06)';
                addBtn.style.borderColor = 'rgba(255,255,255,0.15)';
                addBtn.style.transform = 'translateY(0)';
            });
            addBtn.addEventListener('click', () => this.renderRoleSettingsForm(null, false));
            listContainer.appendChild(addBtn);
            
            const list = document.createElement('div');
            list.id = 'pet-role-list';
            list.style.cssText = `
                flex: 1 !important;
                min-height: 0 !important;
                background: #181818 !important;
                color: #e5e7eb !important;
                border: 1px solid rgba(255,255,255,0.12) !important;
                border-radius: 10px !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                padding: 12px !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 10px !important;
            `;
            listContainer.appendChild(list);

            // å³ä¾§ï¼šè¡¨å•åŒº
            const form = document.createElement('div');
            form.id = 'pet-role-form';
            form.style.cssText = `
                flex: 1 !important;
                background: #181818 !important;
                color: #e5e7eb !important;
                border: 1px solid rgba(255,255,255,0.12) !important;
                border-radius: 10px !important;
                padding: 20px !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 16px !important;
            `;

            body.appendChild(listContainer);
            body.appendChild(form);
            panel.appendChild(header);
            panel.appendChild(body);
            overlay.appendChild(panel);
            this.chatWindow.appendChild(overlay);
        }

        overlay.style.display = 'flex';
        
        // éšè—æŠ˜å æŒ‰é’®ï¼ˆé¿å…åœ¨å¼¹æ¡†ä¸­æ˜¾ç¤ºä¸¤ä¸ªæŠ˜å æŒ‰é’®ï¼‰
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';
        
        // ç›´æ¥æ¸²æŸ“å½“å‰é…ç½®ï¼ˆä¸å†å¼ºåˆ¶è¡¥é½é»˜è®¤é¡¹ï¼Œä¾¿äº"åˆ é™¤"ç”Ÿæ•ˆï¼‰
        this.renderRoleSettingsList();
        if (editId) {
            this.renderRoleSettingsForm(editId);
        } else {
            this.renderRoleSettingsForm(null, true); // ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¾ç¤ºç©ºç™½çŠ¶æ€
        }
    }

    closeRoleSettingsModal() {
        if (!this.chatWindow) return;
        const overlay = this.chatWindow.querySelector('#pet-role-settings');
        if (overlay) overlay.style.display = 'none';
        
        // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
        if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
    }

    // æ‰“å¼€ä¼å¾®æœºå™¨äººè®¾ç½®æ¨¡æ€æ¡†
    openWeWorkRobotSettingsModal(editId = null) {
        if (!this.chatWindow) return;
        let overlay = this.chatWindow.querySelector('#pet-wework-robot-settings');
        const currentColor = this.colors[this.colorIndex];
        const mainColor = this.getMainColorFromGradient(currentColor);
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'pet-wework-robot-settings';
            const chatHeaderEl = this.chatWindow.querySelector('.chat-header');
            const headerH = chatHeaderEl ? chatHeaderEl.offsetHeight : 60;
            overlay.style.cssText = `
                position: absolute !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                top: ${headerH}px !important;
                background: transparent !important;
                display: none !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: ${PET_CONFIG.ui.zIndex.inputContainer + 1} !important;
                pointer-events: none !important;
            `;

            const panel = document.createElement('div');
            panel.id = 'pet-wework-robot-settings-panel';
            panel.style.cssText = `
                width: calc(100% - 24px) !important;
                height: calc(100% - 12px) !important;
                margin: 0 12px 12px 12px !important;
                background: #1f1f1f !important;
                color: #fff !important;
                border-radius: 12px !important;
                border: 1px solid rgba(255,255,255,0.12) !important;
                box-shadow: 0 20px 60px rgba(0,0,0,0.35) !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
                pointer-events: auto !important;
            `;

            const header = document.createElement('div');
            header.style.cssText = `
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 16px 20px !important;
                border-bottom: 1px solid rgba(255,255,255,0.08) !important;
                background: rgba(255,255,255,0.04) !important;
                flex-shrink: 0 !important;
            `;
            const title = document.createElement('div');
            title.textContent = 'ä¼å¾®æœºå™¨äººè®¾ç½®';
            title.style.cssText = 'font-weight: 600; font-size: 16px; color: #fff;';

            const headerBtns = document.createElement('div');
            headerBtns.style.cssText = 'display:flex; gap:10px; align-items:center;';
            const closeBtn = document.createElement('button');
            closeBtn.id = 'pet-wework-robot-settings-close-btn';
            closeBtn.setAttribute('aria-label', 'å…³é—­ä¼å¾®æœºå™¨äººè®¾ç½® (Esc)');
            closeBtn.setAttribute('title', 'å…³é—­ (Esc)');
            closeBtn.textContent = 'âœ•';
            closeBtn.style.cssText = `
                width: 32px !important;
                height: 32px !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 6px !important;
                border: 1px solid rgba(255,255,255,0.15) !important;
                background: rgba(255,255,255,0.06) !important;
                color: #e5e7eb !important;
                cursor: pointer !important;
                font-size: 16px !important;
                transition: all 0.2s ease !important;
                outline: none !important;
            `;
            closeBtn.addEventListener('mouseenter', () => {
                closeBtn.style.background = 'rgba(239, 68, 68, 0.15)';
                closeBtn.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                closeBtn.style.color = '#ef4444';
                closeBtn.style.transform = 'translateY(-1px)';
            });
            closeBtn.addEventListener('mouseleave', () => {
                closeBtn.style.background = 'rgba(255,255,255,0.06)';
                closeBtn.style.borderColor = 'rgba(255,255,255,0.15)';
                closeBtn.style.color = '#e5e7eb';
                closeBtn.style.transform = 'translateY(0)';
            });
            closeBtn.addEventListener('mousedown', () => {
                closeBtn.style.transform = 'scale(0.96)';
            });
            closeBtn.addEventListener('mouseup', () => {
                closeBtn.style.transform = 'scale(1)';
            });
            closeBtn.addEventListener('click', () => this.closeWeWorkRobotSettingsModal());
            headerBtns.appendChild(closeBtn);
            header.appendChild(title);
            header.appendChild(headerBtns);

            const body = document.createElement('div');
            body.id = 'pet-wework-robot-settings-body';
            body.style.cssText = `
                display: flex !important;
                gap: 16px !important;
                padding: 16px 20px !important;
                height: 100% !important;
                min-height: 0 !important;
                overflow: hidden !important;
            `;

            // å·¦ä¾§ï¼šæœºå™¨äººåˆ—è¡¨
            const listContainer = document.createElement('div');
            listContainer.style.cssText = `
                width: 38% !important;
                min-width: 280px !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            `;
            
            // æ–°å¢æœºå™¨äººæŒ‰é’®
            const addBtn = document.createElement('button');
            addBtn.textContent = 'æ–°å¢æœºå™¨äºº';
            addBtn.style.cssText = `
                padding: 8px 16px !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                border-radius: 6px !important;
                border: 1px solid rgba(255,255,255,0.15) !important;
                background: rgba(255,255,255,0.06) !important;
                color: #e5e7eb !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                flex-shrink: 0 !important;
            `;
            addBtn.addEventListener('mouseenter', () => {
                addBtn.style.background = 'rgba(255,255,255,0.12)';
                addBtn.style.borderColor = 'rgba(255,255,255,0.25)';
                addBtn.style.transform = 'translateY(-1px)';
            });
            addBtn.addEventListener('mouseleave', () => {
                addBtn.style.background = 'rgba(255,255,255,0.06)';
                addBtn.style.borderColor = 'rgba(255,255,255,0.15)';
                addBtn.style.transform = 'translateY(0)';
            });
            addBtn.addEventListener('click', () => this.renderWeWorkRobotSettingsForm(null, false));
            listContainer.appendChild(addBtn);
            
            const list = document.createElement('div');
            list.id = 'pet-wework-robot-list';
            list.style.cssText = `
                flex: 1 !important;
                min-height: 0 !important;
                background: #181818 !important;
                color: #e5e7eb !important;
                border: 1px solid rgba(255,255,255,0.12) !important;
                border-radius: 10px !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                padding: 12px !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 10px !important;
            `;
            listContainer.appendChild(list);

            // å³ä¾§ï¼šè¡¨å•åŒº
            const form = document.createElement('div');
            form.id = 'pet-wework-robot-form';
            form.style.cssText = `
                flex: 1 !important;
                background: #181818 !important;
                color: #e5e7eb !important;
                border: 1px solid rgba(255,255,255,0.12) !important;
                border-radius: 10px !important;
                padding: 20px !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 16px !important;
            `;

            body.appendChild(listContainer);
            body.appendChild(form);
            panel.appendChild(header);
            panel.appendChild(body);
            overlay.appendChild(panel);
            this.chatWindow.appendChild(overlay);
        }

        overlay.style.display = 'flex';
        
        // éšè—æŠ˜å æŒ‰é’®ï¼ˆé¿å…åœ¨å¼¹æ¡†ä¸­æ˜¾ç¤ºä¸¤ä¸ªæŠ˜å æŒ‰é’®ï¼‰
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
        if (inputToggleBtn) inputToggleBtn.style.display = 'none';
        
        this.renderWeWorkRobotSettingsList();
        if (editId) {
            this.renderWeWorkRobotSettingsForm(editId);
        } else {
            this.renderWeWorkRobotSettingsForm(null, true);
        }
    }

    closeWeWorkRobotSettingsModal() {
        if (!this.chatWindow) return;
        const overlay = this.chatWindow.querySelector('#pet-wework-robot-settings');
        if (overlay) overlay.style.display = 'none';
        
        // æ˜¾ç¤ºæŠ˜å æŒ‰é’®
        const sidebarToggleBtn = this.chatWindow?.querySelector('#sidebar-toggle-btn');
        const inputToggleBtn = this.chatWindow?.querySelector('#input-container-toggle-btn');
        if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'flex';
        if (inputToggleBtn) inputToggleBtn.style.display = 'flex';
    }

    async renderWeWorkRobotSettingsList() {
        if (!this.chatWindow) return;
        const list = this.chatWindow.querySelector('#pet-wework-robot-list');
        if (!list) return;
        const configs = await this.getWeWorkRobotConfigs();
        list.innerHTML = '';

        configs.forEach((config) => {
            const row = this.createWeWorkRobotListItem(config);
            list.appendChild(row);
        });

        if (list.children.length === 0) {
            const empty = document.createElement('div');
            empty.textContent = 'æš‚æ— å¯ç¼–è¾‘æœºå™¨äººã€‚ç‚¹å‡»"æ–°å¢æœºå™¨äºº"å¼€å§‹åˆ›å»º';
            empty.style.cssText = 'color: #64748b; font-size: 13px; padding: 24px 12px; text-align: center; line-height: 1.5;';
            list.appendChild(empty);
        }
    }

    createWeWorkRobotListItem(config) {
        const row = document.createElement('div');
        row.style.cssText = `
            display:flex !important;
            align-items:center !important;
            justify-content: space-between !important;
            gap: 12px !important;
            padding: 12px !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
            border-radius: 8px !important;
            background: rgba(255,255,255,0.02) !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
        `;
        row.addEventListener('mouseenter', () => {
            row.style.background = 'rgba(255,255,255,0.05)';
            row.style.borderColor = 'rgba(255,255,255,0.15)';
            row.style.transform = 'translateX(2px)';
        });
        row.addEventListener('mouseleave', () => {
            row.style.background = 'rgba(255,255,255,0.02)';
            row.style.borderColor = 'rgba(255,255,255,0.08)';
            row.style.transform = 'translateX(0)';
        });
        const info = document.createElement('div');
        info.style.cssText = 'display:flex; flex-direction:column; gap:6px; flex:1; min-width:0;';
        const name = document.createElement('div');
        name.textContent = `${config.icon || 'ğŸ¤–'} ${config.name || '(æœªå‘½å)'}`;
        name.style.cssText = 'font-weight: 600; font-size: 13px; color: #fff; line-height: 1.4; word-break: break-word;';
        info.appendChild(name);

        const btns = document.createElement('div');
        btns.style.cssText = 'display:flex; gap:6px; flex-shrink:0;';
        const edit = document.createElement('button');
        edit.textContent = 'ç¼–è¾‘';
        edit.style.cssText = `
            padding: 6px 10px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.06) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        edit.addEventListener('mouseenter', () => {
            edit.style.background = 'rgba(59, 130, 246, 0.15)';
            edit.style.borderColor = 'rgba(59, 130, 246, 0.3)';
            edit.style.color = '#60a5fa';
            edit.style.transform = 'translateY(-1px)';
        });
        edit.addEventListener('mouseleave', () => {
            edit.style.background = 'rgba(255,255,255,0.06)';
            edit.style.borderColor = 'rgba(255,255,255,0.15)';
            edit.style.color = '#e5e7eb';
            edit.style.transform = 'translateY(0)';
        });
        edit.addEventListener('click', () => this.renderWeWorkRobotSettingsForm(config.id));
        const del = document.createElement('button');
        del.textContent = 'åˆ é™¤';
        del.style.cssText = `
            padding: 6px 10px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.06) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        del.addEventListener('mouseenter', () => {
            del.style.background = 'rgba(239, 68, 68, 0.15)';
            del.style.borderColor = 'rgba(239, 68, 68, 0.3)';
            del.style.color = '#f87171';
            del.style.transform = 'translateY(-1px)';
        });
        del.addEventListener('mouseleave', () => {
            del.style.background = 'rgba(255,255,255,0.06)';
            del.style.borderColor = 'rgba(255,255,255,0.15)';
            del.style.color = '#e5e7eb';
            del.style.transform = 'translateY(0)';
        });
        del.addEventListener('click', async () => {
            const next = (await this.getWeWorkRobotConfigs()).filter(x => x.id !== config.id);
            await this.setWeWorkRobotConfigs(next);
            this.renderWeWorkRobotSettingsList();
            this.renderWeWorkRobotSettingsForm(null, true);
        });
        btns.appendChild(edit);
        btns.appendChild(del);

        row.appendChild(info);
        row.appendChild(btns);
        row.addEventListener('click', () => this.renderWeWorkRobotSettingsForm(config.id));
        return row;
    }

    async renderWeWorkRobotSettingsForm(editId = null, showEmptyState = false) {
        if (!this.chatWindow) return;
        const form = this.chatWindow.querySelector('#pet-wework-robot-form');
        if (!form) return;
        const configsAll = await this.getWeWorkRobotConfigs();
        const current = editId ? (configsAll || []).find(c => c && c.id === editId) : null;
        
        form.innerHTML = '';

        if (showEmptyState && !editId && !current) {
            const emptyState = document.createElement('div');
            emptyState.style.cssText = `
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                height: 100% !important;
                padding: 40px 20px !important;
                text-align: center !important;
            `;
            
            const icon = document.createElement('div');
            icon.textContent = 'ğŸ¤–';
            icon.style.cssText = `
                font-size: 64px !important;
                margin-bottom: 20px !important;
                opacity: 0.6 !important;
            `;
            
            const title = document.createElement('div');
            title.textContent = 'é€‰æ‹©ä¸€ä¸ªæœºå™¨äººå¼€å§‹ç¼–è¾‘';
            title.style.cssText = `
                font-weight: 600 !important;
                font-size: 16px !important;
                color: #e5e7eb !important;
                margin-bottom: 8px !important;
            `;
            
            const desc = document.createElement('div');
            desc.textContent = 'ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©æœºå™¨äººè¿›è¡Œç¼–è¾‘ï¼Œæˆ–ç‚¹å‡»"æ–°å¢æœºå™¨äºº"åˆ›å»ºæ–°æœºå™¨äºº';
            desc.style.cssText = `
                font-size: 13px !important;
                color: #94a3b8 !important;
                line-height: 1.6 !important;
                max-width: 320px !important;
            `;
            
            const actionBtn = document.createElement('button');
            actionBtn.textContent = 'æ–°å¢æœºå™¨äºº';
            actionBtn.style.cssText = `
                margin-top: 24px !important;
                padding: 10px 24px !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                border-radius: 8px !important;
                border: 1px solid rgba(255,255,255,0.15) !important;
                background: rgba(255,255,255,0.06) !important;
                color: #e5e7eb !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
            `;
            actionBtn.addEventListener('mouseenter', () => {
                actionBtn.style.background = 'rgba(255,255,255,0.12)';
                actionBtn.style.borderColor = 'rgba(255,255,255,0.25)';
                actionBtn.style.transform = 'translateY(-2px)';
            });
            actionBtn.addEventListener('mouseleave', () => {
                actionBtn.style.background = 'rgba(255,255,255,0.06)';
                actionBtn.style.borderColor = 'rgba(255,255,255,0.15)';
                actionBtn.style.transform = 'translateY(0)';
            });
            actionBtn.addEventListener('click', () => {
                this.renderWeWorkRobotSettingsForm(null, false);
            });
            
            emptyState.appendChild(icon);
            emptyState.appendChild(title);
            emptyState.appendChild(desc);
            emptyState.appendChild(actionBtn);
            form.appendChild(emptyState);
            return;
        }

        const title = document.createElement('div');
        title.textContent = current ? 'ç¼–è¾‘æœºå™¨äºº' : 'æ–°å¢æœºå™¨äºº';
        title.style.cssText = 'font-weight: 600; font-size: 18px; color: #fff; margin-bottom: 4px;';

        const row = (labelText, inputEl) => {
            const wrap = document.createElement('div');
            wrap.style.cssText = 'display:flex; flex-direction:column; gap:8px;';
            const lab = document.createElement('label');
            lab.textContent = labelText;
            lab.style.cssText = 'font-size: 13px; font-weight: 500; color: #cbd5e1;';
            wrap.appendChild(lab);
            wrap.appendChild(inputEl);
            return wrap;
        };

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = current?.name || '';
        nameInput.placeholder = 'æœºå™¨äººåç§°ï¼Œå¦‚ï¼šé€šçŸ¥æœºå™¨äºº';
        nameInput.style.cssText = `
            padding: 10px 12px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            outline: none !important;
            background: #121212 !important;
            color: #fff !important;
            font-size: 13px !important;
            transition: all 0.2s ease !important;
        `;
        nameInput.addEventListener('focus', () => {
            nameInput.style.borderColor = 'rgba(255,255,255,0.25)';
            nameInput.style.background = '#1a1a1a';
        });
        nameInput.addEventListener('blur', () => {
            nameInput.style.borderColor = 'rgba(255,255,255,0.12)';
            nameInput.style.background = '#121212';
        });

        const iconInput = document.createElement('input');
        iconInput.type = 'text';
        iconInput.value = current?.icon || 'ğŸ¤–';
        iconInput.placeholder = 'å›¾æ ‡ï¼ˆEmojiï¼‰';
        iconInput.style.cssText = `
            padding: 10px 12px !important;
            width: 80px !important;
            text-align: center !important;
            font-size: 18px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            outline: none !important;
            background: #121212 !important;
            color: #fff !important;
            transition: all 0.2s ease !important;
        `;
        iconInput.addEventListener('focus', () => {
            iconInput.style.borderColor = 'rgba(255,255,255,0.25)';
            iconInput.style.background = '#1a1a1a';
        });
        iconInput.addEventListener('blur', () => {
            iconInput.style.borderColor = 'rgba(255,255,255,0.12)';
            iconInput.style.background = '#121212';
        });

        const webhookInput = document.createElement('input');
        webhookInput.type = 'text';
        webhookInput.value = current?.webhookUrl || '';
        webhookInput.placeholder = 'Webhookåœ°å€ï¼Œå¦‚ï¼šhttps://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx';
        webhookInput.style.cssText = `
            padding: 10px 12px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            outline: none !important;
            background: #121212 !important;
            color: #fff !important;
            font-size: 13px !important;
            transition: all 0.2s ease !important;
        `;
        webhookInput.addEventListener('focus', () => {
            webhookInput.style.borderColor = 'rgba(255,255,255,0.25)';
            webhookInput.style.background = '#1a1a1a';
        });
        webhookInput.addEventListener('blur', () => {
            webhookInput.style.borderColor = 'rgba(255,255,255,0.12)';
            webhookInput.style.background = '#121212';
        });

        const helpText = document.createElement('div');
        helpText.innerHTML = 'ğŸ’¡ è·å–Webhookåœ°å€ï¼š<a href="https://developer.work.weixin.qq.com/document/path/91770" target="_blank" style="color: #60a5fa; text-decoration: underline;">æŸ¥çœ‹ä¼å¾®æœºå™¨äººæ–‡æ¡£</a>';
        helpText.style.cssText = 'font-size: 12px; color: #94a3b8; line-height: 1.5; margin-top: -8px;';

        const btns = document.createElement('div');
        btns.style.cssText = 'display:flex; gap:10px; margin-top: 8px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08);';
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            border-radius: 8px !important;
            border: 1px solid rgba(34, 197, 94, 0.3) !important;
            background: rgba(34, 197, 94, 0.15) !important;
            color: #4ade80 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            flex: 1 !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = 'rgba(34, 197, 94, 0.25)';
            saveBtn.style.borderColor = 'rgba(34, 197, 94, 0.4)';
            saveBtn.style.transform = 'translateY(-1px)';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = 'rgba(34, 197, 94, 0.15)';
            saveBtn.style.borderColor = 'rgba(34, 197, 94, 0.3)';
            saveBtn.style.transform = 'translateY(0)';
        });
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.06) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            flex: 1 !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = 'rgba(255,255,255,0.12)';
            cancelBtn.style.borderColor = 'rgba(255,255,255,0.25)';
            cancelBtn.style.transform = 'translateY(-1px)';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'rgba(255,255,255,0.06)';
            cancelBtn.style.borderColor = 'rgba(255,255,255,0.15)';
            cancelBtn.style.transform = 'translateY(0)';
        });

        saveBtn.addEventListener('click', async () => {
            const originalText = saveBtn.textContent;
            const isLoading = saveBtn.dataset.loading === 'true';
            if (isLoading) return;
            
            saveBtn.dataset.loading = 'true';
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.7';
            saveBtn.style.cursor = 'not-allowed';
            
            try {
                if (!webhookInput.value.trim()) {
                    throw new Error('Webhookåœ°å€ä¸èƒ½ä¸ºç©º');
                }
                
                const next = {
                    id: current?.id || ('robot_' + Math.random().toString(36).slice(2, 10)),
                    name: nameInput.value.trim() || 'æœªå‘½åæœºå™¨äºº',
                    icon: iconInput.value.trim() || 'ğŸ¤–',
                    webhookUrl: webhookInput.value.trim(),
                };
                
                const arr = await this.getWeWorkRobotConfigs();
                
                const idx = arr.findIndex(x => x.id === next.id);
                const isEdit = idx >= 0;
                if (isEdit) {
                    arr[idx] = next;
                } else {
                    arr.push(next);
                }
                
                await this.setWeWorkRobotConfigs(arr);
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.renderWeWorkRobotSettingsList();
                this.renderWeWorkRobotSettingsForm(null, true);
                
                const successMessage = isEdit ? `âœ… æœºå™¨äºº "${next.name}" å·²æ›´æ–°` : `âœ… æœºå™¨äºº "${next.name}" å·²åˆ›å»º`;
                this.showNotification(successMessage, 'success');
                
            } catch (error) {
                console.error('ä¿å­˜ä¼å¾®æœºå™¨äººè®¾ç½®å¤±è´¥:', error);
                this.showNotification(`âŒ ä¿å­˜å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            } finally {
                saveBtn.dataset.loading = 'false';
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            }
        });

        cancelBtn.addEventListener('click', () => {
            this.renderWeWorkRobotSettingsForm(null, true);
        });

        form.appendChild(title);
        form.appendChild(row('æœºå™¨äººåç§°', nameInput));
        form.appendChild(row('å›¾æ ‡', iconInput));
        form.appendChild(row('Webhookåœ°å€', webhookInput));
        form.appendChild(helpText);
        form.appendChild(btns);
        btns.appendChild(saveBtn);
        btns.appendChild(cancelBtn);
    }

    async getRoleConfigs() {
        return new Promise((resolve) => {
            chrome.storage.local.get(['roleConfigs'], (result) => {
                resolve(Array.isArray(result.roleConfigs) ? result.roleConfigs : []);
            });
        });
    }

    async setRoleConfigs(configs) {
        return new Promise((resolve) => {
            chrome.storage.local.set({ roleConfigs: configs }, () => resolve(true));
        });
    }

    // ä¼å¾®æœºå™¨äººé…ç½®å­˜å‚¨å’Œè¯»å–
    async getWeWorkRobotConfigs() {
        return new Promise((resolve) => {
            chrome.storage.local.get(['weWorkRobotConfigs'], (result) => {
                resolve(Array.isArray(result.weWorkRobotConfigs) ? result.weWorkRobotConfigs : []);
            });
        });
    }

    async setWeWorkRobotConfigs(configs) {
        return new Promise((resolve) => {
            chrome.storage.local.set({ weWorkRobotConfigs: configs }, () => resolve(true));
        });
    }

    // åˆ¤æ–­å†…å®¹æ˜¯å¦æ˜¯ markdown æ ¼å¼
    isMarkdownFormat(content) {
        if (!content || typeof content !== 'string') {
            return false;
        }
        
        // æ£€æŸ¥å¸¸è§çš„ markdown è¯­æ³•ç‰¹å¾
        const markdownPatterns = [
            /^#{1,6}\s+.+/m,                    // æ ‡é¢˜ (# æ ‡é¢˜)
            /\*\*[^*]+\*\*/,                    // åŠ ç²— (**text**)
            /\*[^*]+\*/,                        // æ–œä½“ (*text*)
            /\[.+\]\(.+\)/,                     // é“¾æ¥ ([text](url))
            /`[^`]+`/,                          // è¡Œå†…ä»£ç  (`code`)
            /```[\s\S]*?```/,                    // ä»£ç å— (```code```)
            /^>\s+.+/m,                          // å¼•ç”¨ (> text)
            /^[-*+]\s+.+/m,                      // æ— åºåˆ—è¡¨ (- item)
            /^\d+\.\s+.+/m,                      // æœ‰åºåˆ—è¡¨ (1. item)
            /\[.+\]:\s*https?:\/\/.+/,          // é“¾æ¥å®šä¹‰
            /<font\s+color=["'](info|comment|warning)["']>.+<\/font>/i, // ä¼å¾®é¢œè‰²æ ‡ç­¾
        ];
        
        // å¦‚æœåŒ¹é…åˆ°ä»»ä½•ä¸€ä¸ª markdown æ¨¡å¼ï¼Œè®¤ä¸ºæ˜¯ markdown æ ¼å¼
        return markdownPatterns.some(pattern => pattern.test(content));
    }

    // è°ƒç”¨ prompt æ¥å£å°†å†…å®¹è½¬æ¢ä¸º markdown æ ¼å¼
    async convertToMarkdown(content) {
        try {
            const systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æœ¬æ ¼å¼åŒ–åŠ©æ‰‹ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„å†…å®¹è½¬æ¢ä¸ºé€‚åˆä¼ä¸šå¾®ä¿¡æœºå™¨äººçš„ markdown æ ¼å¼ã€‚è¦æ±‚ï¼š\n1. ä¿æŒåŸæ„ä¸å˜\n2. ä½¿ç”¨åˆé€‚çš„ markdown è¯­æ³•ï¼ˆæ ‡é¢˜ã€åŠ ç²—ã€åˆ—è¡¨ç­‰ï¼‰\n3. ç¡®ä¿æ ¼å¼æ¸…æ™°æ˜“è¯»\n4. å¦‚æœå†…å®¹å·²ç»æ˜¯ markdown æ ¼å¼ï¼Œç›´æ¥è¿”å›åŸå†…å®¹\n5. è¾“å‡ºçº¯ markdown æ–‡æœ¬ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Š';
            
            const userPrompt = `è¯·å°†ä»¥ä¸‹å†…å®¹è½¬æ¢ä¸º markdown æ ¼å¼ï¼š\n\n${content}`;
            
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );
            
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const responseText = await response.text();
            let result;
            
            // å¤„ç†æµå¼å“åº”
            if (responseText.includes('data: ')) {
                const lines = responseText.split('\n');
                let accumulatedData = '';
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ')) {
                        try {
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr === '[DONE]' || dataStr === '') {
                                continue;
                            }
                            
                            const chunk = JSON.parse(dataStr);
                            if (chunk.done === true) {
                                break;
                            }
                            
                            if (chunk.data) {
                                accumulatedData += chunk.data;
                            } else if (chunk.content) {
                                accumulatedData += chunk.content;
                            } else if (chunk.message && chunk.message.content) {
                                accumulatedData += chunk.message.content;
                            }
                        } catch (e) {
                            // å¿½ç•¥è§£æé”™è¯¯
                        }
                    }
                }
                
                result = accumulatedData || content;
            } else {
                // å¤„ç†éæµå¼å“åº”
                try {
                    const jsonResult = JSON.parse(responseText);
                    if (jsonResult.status === 200 && jsonResult.data) {
                        result = jsonResult.data;
                    } else if (jsonResult.content) {
                        result = jsonResult.content;
                    } else if (jsonResult.message) {
                        result = jsonResult.message;
                    } else {
                        result = content; // å¦‚æœæ— æ³•è§£æï¼Œä½¿ç”¨åŸå†…å®¹
                    }
                } catch (e) {
                    result = content; // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå†…å®¹
                }
            }
            
            // å¦‚æœè½¬æ¢ç»“æœä¸ºç©ºï¼Œä½¿ç”¨åŸå†…å®¹
            return (result && result.trim()) ? result.trim() : content;
        } catch (error) {
            console.error('è½¬æ¢ä¸º markdown å¤±è´¥:', error);
            // è½¬æ¢å¤±è´¥æ—¶è¿”å›åŸå†…å®¹
            return content;
        }
    }

    // å¤„ç†æ¶ˆæ¯å†…å®¹ï¼Œé€šè¿‡ prompt æ¥å£å¤„ç†å¹¶è¿”å› md æ ¼å¼
    async processMessageForRobot(messageContent) {
        try {
            // æ„å»º system promptï¼Œè¦æ±‚è¿”å›ç²¾ç®€çš„ md æ ¼å¼ä¸”ä¸¥æ ¼ä¸è¶…è¿‡ 4096 å­—ç¬¦
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå†…å®¹ç²¾ç®€ä¸“å®¶ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„æ¶ˆæ¯å†…å®¹è¿›è¡Œ**å¤§å¹…ç²¾ç®€å’Œå‹ç¼©**ï¼Œå¹¶ä»¥ Markdown æ ¼å¼è¿”å›ã€‚

**æ ¸å¿ƒè¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š**
1. **é•¿åº¦é™åˆ¶æ˜¯ç¡¬æ€§è¦æ±‚**ï¼šæœ€ç»ˆè¾“å‡ºå†…å®¹ï¼ˆåŒ…æ‹¬æ‰€æœ‰ Markdown è¯­æ³•å­—ç¬¦å’Œè¡¨æƒ…ç¬¦å·ï¼‰å¿…é¡»ä¸¥æ ¼æ§åˆ¶åœ¨ 4096 å­—ç¬¦ä»¥å†…ï¼Œè¿™æ˜¯ä¼ä¸šå¾®ä¿¡æœºå™¨äººçš„é™åˆ¶ï¼Œè¶…è¿‡ä¼šå¯¼è‡´å‘é€å¤±è´¥
2. **ä¼˜å…ˆä¿ç•™æ ¸å¿ƒä¿¡æ¯**ï¼šåªä¿ç•™æœ€å…³é”®ã€æœ€é‡è¦çš„ä¿¡æ¯ï¼Œåˆ é™¤æ‰€æœ‰å†—ä½™ã€é‡å¤ã€æ¬¡è¦çš„å†…å®¹
3. **ä½¿ç”¨ç´§å‡‘æ ¼å¼**ï¼š
   - ä¼˜å…ˆä½¿ç”¨åˆ—è¡¨ï¼ˆæœ‰åº/æ— åºï¼‰è€Œéæ®µè½
   - ä½¿ç”¨æ ‡é¢˜å±‚çº§ï¼ˆ##ã€###ï¼‰ç»„ç»‡å†…å®¹
   - ä½¿ç”¨**åŠ ç²—**çªå‡ºå…³é”®ç‚¹ï¼Œé¿å…å†—é•¿æè¿°
   - åˆ é™¤ä¸å¿…è¦çš„ç©ºè¡Œå’Œè£…é¥°æ€§å†…å®¹
4. **ç²¾ç®€ç­–ç•¥**ï¼š
   - åˆå¹¶ç›¸ä¼¼å†…å®¹ï¼Œå»é™¤é‡å¤è¡¨è¾¾
   - ç”¨å…³é”®è¯å’ŒçŸ­è¯­æ›¿ä»£å®Œæ•´å¥å­
   - åˆ é™¤ç¤ºä¾‹ã€è¯¦ç»†è§£é‡Šç­‰éæ ¸å¿ƒå†…å®¹
   - å¦‚æœåŸå†…å®¹è¿‡é•¿ï¼Œåªä¿ç•™æ‘˜è¦å’Œè¦ç‚¹
5. **æ ¼å¼è¦æ±‚**ï¼š
   - å¦‚æœåŸå†…å®¹å·²ç»æ˜¯ Markdownï¼Œå¤§å¹…ç²¾ç®€åä¿æŒæ ¼å¼
   - å¦‚æœåŸå†…å®¹ä¸æ˜¯ Markdownï¼Œè½¬æ¢ä¸ºç²¾ç®€çš„ Markdown æ ¼å¼
   - ä½¿ç”¨ç®€æ´çš„ Markdown è¯­æ³•ï¼Œé¿å…å¤æ‚çš„åµŒå¥—ç»“æ„
6. **è¡¨æƒ…ç¬¦å·ä½¿ç”¨ï¼ˆé‡è¦ï¼‰**ï¼š
   - **é€‚åº¦ä½¿ç”¨è¡¨æƒ…ç¬¦å·**ï¼Œè®©å†…å®¹æ›´ç”ŸåŠ¨æœ‰è¶£ã€æ›´å®¹æ˜“è®°å¿†
   - åœ¨æ ‡é¢˜ã€å…³é”®ç‚¹ã€é‡è¦ä¿¡æ¯å¤„ä½¿ç”¨åˆé€‚çš„è¡¨æƒ…ç¬¦å·
   - å¸¸ç”¨è¡¨æƒ…ç¬¦å·è¯­ä¹‰æ˜ å°„ï¼š
     * ğŸ“‹ æŠ¥å‘Š/æ–‡æ¡£/æ€»ç»“
     * ğŸ“ ç¬”è®°/è®°å½•/è¦ç‚¹
     * ğŸ’¡ æƒ³æ³•/å»ºè®®/æç¤º
     * ğŸ”‘ å…³é”®/æ ¸å¿ƒ/é‡ç‚¹
     * âš ï¸ æ³¨æ„/è­¦å‘Š/é£é™©
     * âœ… å®Œæˆ/æˆåŠŸ/ä¼˜åŠ¿
     * âŒ é”™è¯¯/é—®é¢˜/ç¼ºç‚¹
     * ğŸ“Š æ•°æ®/ç»Ÿè®¡/å›¾è¡¨
     * ğŸ¯ ç›®æ ‡/ç›®çš„/æ–¹å‘
     * ğŸš€ è¶‹åŠ¿/å‘å±•/æå‡
     * â­ é‡è¦/äº®ç‚¹/æ¨è
     * ğŸ” åˆ†æ/ç ”ç©¶/æ¢ç´¢
     * ğŸ’¬ è§‚ç‚¹/è¯„è®º/è®¨è®º
     * ğŸ“Œ æ ‡è®°/å¼ºè°ƒ/å›ºå®š
     * ğŸ‰ åº†ç¥/æˆå°±/å¥½æ¶ˆæ¯
     * ğŸ“ˆ å¢é•¿/ä¸Šå‡/ç§¯æ
     * ğŸ“‰ ä¸‹é™/å‡å°‘/æ¶ˆæ
     * ğŸ”¥ çƒ­é—¨/ç´§æ€¥/é‡è¦
     * ğŸ’° è´¢åŠ¡/æˆæœ¬/ä»·å€¼
     * ğŸ“ å­¦ä¹ /æ•™è‚²/çŸ¥è¯†
     * â° æ—¶é—´/æœŸé™/è®¡åˆ’
     * ğŸ† æˆå°±/ä¼˜ç§€/æ’å
     * ğŸŒŸ äº®ç‚¹/ç‰¹è‰²/çªå‡º
   - è¡¨æƒ…ç¬¦å·ä½¿ç”¨åŸåˆ™ï¼š
     * æ¯ä¸ªæ ‡é¢˜æˆ–å…³é”®ç‚¹ä½¿ç”¨ 1-2 ä¸ªç›¸å…³è¡¨æƒ…ç¬¦å·
     * ä¸è¦è¿‡åº¦ä½¿ç”¨ï¼Œä¿æŒå†…å®¹ç®€æ´
     * è¡¨æƒ…ç¬¦å·åº”è¯¥å¢å¼ºè¯­ä¹‰ï¼Œè€Œä¸æ˜¯è£…é¥°

**é‡è¦æé†’**ï¼šå¦‚æœåŸå†…å®¹å¾ˆé•¿ï¼Œå¿…é¡»è¿›è¡Œ**å¤§å¹…å‹ç¼©**ï¼Œåªä¿ç•™æ ¸å¿ƒè¦ç‚¹ã€‚å®å¯å†…å®¹ç®€çŸ­ï¼Œä¹Ÿç»ä¸èƒ½è¶…è¿‡ 4096 å­—ç¬¦é™åˆ¶ã€‚è¡¨æƒ…ç¬¦å·çš„ä½¿ç”¨è¦é€‚åº¦ï¼Œä¸èƒ½å½±å“å†…å®¹çš„ç²¾ç®€ã€‚

è¯·ç›´æ¥è¿”å›ç²¾ç®€åçš„ Markdown å†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è¯´æ˜æ–‡å­—ã€å‰ç¼€æˆ–åç¼€ã€‚`;

            // æ„å»º userPromptï¼Œæ·»åŠ ç²¾ç®€å’Œè¡¨æƒ…ç¬¦å·æç¤º
            const userPrompt = `è¯·å°†ä»¥ä¸‹å†…å®¹**å¤§å¹…ç²¾ç®€å’Œå‹ç¼©**ä¸º Markdown æ ¼å¼ï¼Œç¡®ä¿æœ€ç»ˆè¾“å‡ºä¸¥æ ¼æ§åˆ¶åœ¨ 4096 å­—ç¬¦ä»¥å†…ã€‚

**è¦æ±‚**ï¼š
- ä½¿ç”¨åˆé€‚çš„è¡¨æƒ…ç¬¦å·è®©å†…å®¹æ›´ç”ŸåŠ¨æœ‰è¶£ã€æ›´å®¹æ˜“è®°å¿†
- åœ¨æ ‡é¢˜ã€å…³é”®ç‚¹ã€é‡è¦ä¿¡æ¯å¤„æ·»åŠ ç›¸å…³è¡¨æƒ…ç¬¦å·
- ä¿æŒå†…å®¹ç²¾ç®€ï¼Œè¡¨æƒ…ç¬¦å·è¦é€‚åº¦ä½¿ç”¨

å†…å®¹ï¼š

${messageContent}`;

            // æ„å»º payload
            const payload = this.buildPromptPayload(
                systemPrompt,
                userPrompt,
                this.currentModel || ((PET_CONFIG.chatModels && PET_CONFIG.chatModels.default) || 'qwen3')
            );

            // è°ƒç”¨ prompt æ¥å£
            const response = await fetch(PET_CONFIG.api.promptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            // è¯»å–å“åº”æ–‡æœ¬
            const responseText = await response.text();
            let result;

            // æ£€æŸ¥æ˜¯å¦åŒ…å«SSEæ ¼å¼ï¼ˆåŒ…å« "data: "ï¼‰
            if (responseText.includes('data: ')) {
                // å¤„ç†SSEæµå¼å“åº”
                const lines = responseText.split('\n');
                let accumulatedData = '';
                let lastValidData = null;

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ')) {
                        try {
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr === '[DONE]' || dataStr === '') {
                                continue;
                            }

                            // å°è¯•è§£æJSON
                            const chunk = JSON.parse(dataStr);

                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            if (chunk.done === true) {
                                break;
                            }

                            // ç´¯ç§¯å†…å®¹ï¼ˆå¤„ç†æµå¼å†…å®¹å—ï¼‰
                            if (chunk.data) {
                                accumulatedData += chunk.data;
                            } else if (chunk.content) {
                                accumulatedData += chunk.content;
                            } else if (chunk.message && chunk.message.content) {
                                // Ollamaæ ¼å¼
                                accumulatedData += chunk.message.content;
                            } else if (typeof chunk === 'string') {
                                accumulatedData += chunk;
                            }

                            // ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®å—
                            lastValidData = chunk;
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬å†…å®¹
                            const dataStr = trimmedLine.substring(6).trim();
                            if (dataStr && dataStr !== '[DONE]') {
                                accumulatedData += dataStr;
                            }
                        }
                    }
                }

                // å¦‚æœç´¯ç§¯äº†å†…å®¹ï¼Œåˆ›å»ºç»“æœå¯¹è±¡
                if (accumulatedData || lastValidData) {
                    if (lastValidData && lastValidData.status) {
                        result = {
                            ...lastValidData,
                            data: accumulatedData || lastValidData.data || '',
                            content: accumulatedData || lastValidData.content || ''
                        };
                    } else {
                        result = {
                            data: accumulatedData,
                            content: accumulatedData
                        };
                    }
                } else {
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
                    }
                }
            } else {
                // éSSEæ ¼å¼ï¼Œç›´æ¥è§£æJSON
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    const sseMatch = responseText.match(/data:\s*({.+?})/s);
                    if (sseMatch) {
                        result = JSON.parse(sseMatch[1]);
                    } else {
                        throw new Error(`æ— æ³•è§£æå“åº”: ${responseText.substring(0, 100)}`);
                    }
                }
            }

            // é€‚é…å“åº”æ ¼å¼
            let content = '';
            if (result.data) {
                content = result.data;
            } else if (result.content) {
                content = result.content;
            } else if (result.message && result.message.content) {
                content = result.message.content;
            } else if (result.message && typeof result.message === 'string') {
                content = result.message;
            } else if (typeof result === 'string') {
                content = result;
            } else {
                content = JSON.stringify(result);
            }

            // å¦‚æœæå–åˆ°äº†æœ‰æ•ˆå†…å®¹ï¼Œå»é™¤ markdown ä»£ç å—æ ‡è®°
            if (content && content.trim()) {
                let cleanedContent = content.trim();
                
                // å»é™¤å¼€å¤´çš„ ```markdown æˆ– ``` æ ‡è®°
                cleanedContent = cleanedContent.replace(/^```(?:markdown)?\s*/i, '');
                
                // å»é™¤ç»“å°¾çš„ ``` æ ‡è®°
                cleanedContent = cleanedContent.replace(/\s*```\s*$/, '');
                
                return cleanedContent.trim();
            } else if (result.status !== undefined && result.status !== 200) {
                const errorMsg = result.msg || 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†é”™è¯¯ã€‚';
                throw new Error(errorMsg);
            } else if (result.msg && !content) {
                throw new Error(result.msg);
            } else {
                throw new Error('æ— æ³•è·å–æœ‰æ•ˆå†…å®¹');
            }
        } catch (error) {
            console.error('å¤„ç†æ¶ˆæ¯å†…å®¹å¤±è´¥:', error);
            throw error;
        }
    }

    // é™åˆ¶ Markdown å†…å®¹é•¿åº¦ï¼Œç¡®ä¿ä¸è¶…è¿‡æŒ‡å®šå­—æ•°
    limitMarkdownLength(content, maxLength) {
        if (!content || typeof content !== 'string') {
            return '';
        }

        // å¦‚æœå†…å®¹é•¿åº¦å·²ç»å°äºç­‰äºé™åˆ¶ï¼Œç›´æ¥è¿”å›
        if (content.length <= maxLength) {
            return content;
        }

        // è®¡ç®—æˆªæ–­æç¤ºæ–‡æœ¬ï¼ˆå›ºå®šæ ¼å¼ï¼Œé•¿åº¦å¯é¢„æµ‹ï¼‰
        const truncateHint = '\n\n*(å†…å®¹å·²æˆªæ–­)*';
        const hintLength = truncateHint.length;
        
        // é¢„ç•™ç©ºé—´ï¼šæç¤ºæ–‡æœ¬ + å¯èƒ½çš„æ¢è¡Œç¬¦
        const reservedLength = hintLength + 1; // +1 ä¸ºå¯èƒ½çš„æ¢è¡Œç¬¦é¢„ç•™
        const availableLength = maxLength - reservedLength;
        
        // å¦‚æœå¯ç”¨é•¿åº¦å¤ªå°ï¼Œç›´æ¥æˆªæ–­åˆ°æœ€å¤§é•¿åº¦ï¼ˆä¸æ·»åŠ æç¤ºï¼‰
        if (availableLength < 50) {
            return content.substring(0, maxLength);
        }

        // æˆªæ–­å†…å®¹åˆ°å¯ç”¨é•¿åº¦
        let truncated = content.substring(0, availableLength);

        // å°è¯•åœ¨æœ€åä¸€ä¸ªå®Œæ•´çš„å¥å­æˆ–æ®µè½å¤„æˆªæ–­ï¼Œé¿å…æˆªæ–­ Markdown è¯­æ³•
        // æŸ¥æ‰¾æœ€åä¸€ä¸ªæ¢è¡Œç¬¦ã€å¥å·ã€é—®å·æˆ–æ„Ÿå¹å·
        const searchStart = Math.max(0, availableLength - 200);
        const lastBreak = Math.max(
            truncated.lastIndexOf('\n\n', availableLength - 1),
            truncated.lastIndexOf('\n', availableLength - 1),
            truncated.lastIndexOf('ã€‚', availableLength - 1),
            truncated.lastIndexOf('ï¼', availableLength - 1),
            truncated.lastIndexOf('ï¼Ÿ', availableLength - 1),
            truncated.lastIndexOf('.', availableLength - 1),
            truncated.lastIndexOf('!', availableLength - 1),
            truncated.lastIndexOf('?', availableLength - 1)
        );

        // å¦‚æœæ‰¾åˆ°äº†åˆé€‚çš„æˆªæ–­ç‚¹ï¼ˆåœ¨æœç´¢èŒƒå›´å†…ï¼‰ï¼Œä½¿ç”¨è¯¥ç‚¹æˆªæ–­
        if (lastBreak >= searchStart && lastBreak > 0) {
            truncated = truncated.substring(0, lastBreak + 1);
        }

        // ç¡®ä¿æˆªæ–­åçš„å†…å®¹ä»¥æ¢è¡Œç¬¦ç»“å°¾ï¼ˆä½†è¦ç¡®ä¿åŠ ä¸Šæç¤ºåä¸è¶…è¿‡é™åˆ¶ï¼‰
        if (!truncated.endsWith('\n') && truncated.length + hintLength + 1 <= maxLength) {
            truncated += '\n';
        }

        // æ·»åŠ æˆªæ–­æç¤º
        truncated += truncateHint;

        // æœ€ç»ˆä¸¥æ ¼æ£€æŸ¥ï¼šç¡®ä¿ä¸è¶…è¿‡æœ€å¤§é•¿åº¦ï¼ˆè¿™æ˜¯æœ€åä¸€é“é˜²çº¿ï¼‰
        if (truncated.length > maxLength) {
            // å¦‚æœä»ç„¶è¶…è¿‡ï¼Œå¼ºåˆ¶æˆªæ–­åˆ°æœ€å¤§é•¿åº¦ï¼ˆå»æ‰æç¤ºæ–‡æœ¬ï¼‰
            truncated = content.substring(0, maxLength);
        }

        return truncated;
    }

    // å‘é€æ¶ˆæ¯åˆ°ä¼å¾®æœºå™¨äººï¼ˆé€šè¿‡ background script é¿å… CORS é—®é¢˜ï¼‰
    async sendToWeWorkRobot(webhookUrl, content) {
        try {
            // å‚æ•°éªŒè¯
            if (!webhookUrl || typeof webhookUrl !== 'string') {
                throw new Error('webhookUrl å‚æ•°æ— æ•ˆ');
            }
            
            if (!content || typeof content !== 'string') {
                throw new Error('content å‚æ•°æ— æ•ˆ');
            }
            
            // æ£€æŸ¥å†…å®¹æ˜¯å¦æ˜¯ markdown æ ¼å¼
            let markdownContent = content;
            
            if (!this.isMarkdownFormat(content)) {
                // å¦‚æœä¸æ˜¯ markdown æ ¼å¼ï¼Œå…ˆè½¬æ¢ä¸º markdown
                console.log('[ä¼å¾®æœºå™¨äºº] å†…å®¹ä¸æ˜¯ markdown æ ¼å¼ï¼Œæ­£åœ¨è½¬æ¢ä¸º markdown...');
                markdownContent = await this.convertToMarkdown(content);
                console.log(`[ä¼å¾®æœºå™¨äºº] è½¬æ¢åé•¿åº¦: ${markdownContent.length}`);
            }
            
            // æœ€ç»ˆé•¿åº¦æ£€æŸ¥ï¼šç¡®ä¿ä¸è¶…è¿‡ä¼å¾®æœºå™¨äººçš„ 4096 å­—ç¬¦é™åˆ¶
            const MAX_LENGTH = 4096;
            const originalLength = markdownContent.length;
            
            if (originalLength > MAX_LENGTH) {
                console.warn(`[ä¼å¾®æœºå™¨äºº] å†…å®¹é•¿åº¦ ${originalLength} è¶…è¿‡é™åˆ¶ ${MAX_LENGTH}ï¼Œè¿›è¡Œæˆªæ–­`);
                markdownContent = this.limitMarkdownLength(markdownContent, MAX_LENGTH);
                console.log(`[ä¼å¾®æœºå™¨äºº] æˆªæ–­åé•¿åº¦: ${markdownContent.length}`);
            }
            
            // å†æ¬¡éªŒè¯é•¿åº¦ï¼ˆåŒé‡ä¿é™©ï¼‰
            if (markdownContent.length > MAX_LENGTH) {
                console.error(`[ä¼å¾®æœºå™¨äºº] æˆªæ–­åä»ç„¶è¶…è¿‡é™åˆ¶: ${markdownContent.length} > ${MAX_LENGTH}ï¼Œå¼ºåˆ¶æˆªæ–­`);
                markdownContent = markdownContent.substring(0, MAX_LENGTH);
            }
            
            // é€šè¿‡ background script å‘é€è¯·æ±‚ï¼Œé¿å… CORS é—®é¢˜
            const response = await chrome.runtime.sendMessage({
                action: 'sendToWeWorkRobot',
                webhookUrl: webhookUrl,
                content: markdownContent
            });

            if (!response || !response.success) {
                throw new Error(response?.error || 'å‘é€å¤±è´¥');
            }

            return response.result;
        } catch (error) {
            console.error('å‘é€åˆ°ä¼å¾®æœºå™¨äººå¤±è´¥:', error);
            throw error;
        }
    }

    // è¯»å–å†…ç½®è§’è‰²å®šä¹‰å¹¶è½¬ä¸ºé»˜è®¤é…ç½®ï¼ˆä»å·²æœ‰é…ç½®ä¸­è·å–labelã€iconå’Œpromptï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
    buildDefaultRoleConfigsFromBuiltins(existingConfigs = null) {
        const keys = ['summary', 'mindmap', 'flashcard', 'report', 'bestPractice'];
        const includeChartsMap = {
            summary: false,
            mindmap: true,
            flashcard: false,
            report: true,
            bestPractice: true
        };
        const arr = [];
        keys.forEach(k => {
            // ä»å·²æœ‰é…ç½®ä¸­æŸ¥æ‰¾å¯¹åº”çš„labelã€iconå’Œprompt
            let label = k; // é»˜è®¤ä½¿ç”¨actionKey
            let icon = ''; // é»˜è®¤iconä¸ºç©ºï¼Œç”±ç”¨æˆ·é…ç½®
            let prompt = ''; // é»˜è®¤promptä¸ºç©ºï¼Œç”±ç”¨æˆ·é…ç½®
            if (existingConfigs && Array.isArray(existingConfigs)) {
                const existing = existingConfigs.find(c => c && c.actionKey === k);
                if (existing) {
                    if (existing.label && typeof existing.label === 'string') {
                        const trimmedLabel = existing.label.trim();
                        if (trimmedLabel) {
                            label = trimmedLabel;
                        }
                    }
                    if (existing.icon && typeof existing.icon === 'string') {
                        const trimmedIcon = existing.icon.trim();
                        if (trimmedIcon) {
                            icon = trimmedIcon;
                        }
                    }
                    if (existing.prompt && typeof existing.prompt === 'string') {
                        const trimmedPrompt = existing.prompt.trim();
                        if (trimmedPrompt) {
                            prompt = trimmedPrompt;
                        }
                    }
                }
            }
            arr.push({
                id: 'builtin_' + k,
                label: label,
                actionKey: k,
                icon: icon,
                includeCharts: includeChartsMap[k] || false,
                prompt: prompt
            });
        });
        return arr;
    }

    // ç¡®ä¿é»˜è®¤è§’è‰²å·²å­˜åœ¨ï¼ˆä»…åœ¨ä¸ºç©ºæˆ–ç¼ºå°‘æ—¶è¡¥é½ï¼‰
    async ensureDefaultRoleConfigs() {
        const existing = await this.getRoleConfigs();
        const defaults = this.buildDefaultRoleConfigsFromBuiltins(existing);
        if (!existing || existing.length === 0) {
            await this.setRoleConfigs(defaults);
            return true;
        }
        // è¡¥é½ç¼ºå¤±çš„å†…ç½®é¡¹
        const haveKeys = new Set(existing.map(c => c.actionKey));
        let updated = false;
        defaults.forEach(d => {
            if (!haveKeys.has(d.actionKey)) {
                existing.push({
                    id: d.id,
                    label: d.label,
                    actionKey: d.actionKey,
                    icon: d.icon,
                    includeCharts: d.includeCharts,
                    prompt: d.prompt
                });
                updated = true;
            }
        });
        // å›å¡«ç¼ºå¤±å›¾æ ‡ï¼ˆè€æ•°æ®å…¼å®¹ï¼‰
        for (const c of existing) {
            if ((!c.icon || !String(c.icon).trim()) && c.actionKey) {
                c.icon = this.getRoleIcon(c, existing);
                updated = true;
            }
        }
        if (updated) {
            await this.setRoleConfigs(existing);
        }
        return true;
    }

    async renderRoleSettingsList() {
        if (!this.chatWindow) return;
        const list = this.chatWindow.querySelector('#pet-role-list');
        if (!list) return;
        const configsRaw = await this.getRoleConfigs();
        list.innerHTML = '';

        // å…ˆæ˜¾ç¤ºå·²ç»‘å®šæŒ‰é’®çš„è§’è‰²ï¼ˆæŒ‰æŒ‰é’®é¡ºåºï¼‰
        // ä½¿ç”¨ getOrderedBoundRoleKeys() ç¡®ä¿ä¸ refreshWelcomeActionButtons() é¡ºåºä¸€è‡´
        const orderedKeys = await this.getOrderedBoundRoleKeys();
        const boundRoleIds = new Set();
        for (const key of orderedKeys) {
            const config = (configsRaw || []).find(c => c && c.actionKey === key);
            if (config) {
                boundRoleIds.add(config.id);
                // ä½¿ç”¨ç»Ÿä¸€çš„è§’è‰²ä¿¡æ¯è·å–å‡½æ•°è·å–æ ‡ç­¾
                const roleInfo = await this.getRoleInfoForAction(key);
                const row = this.createRoleListItem(config, roleInfo.label, configsRaw);
                list.appendChild(row);
            }
        }

        // å†æ˜¾ç¤ºå…¶ä»–è§’è‰²ï¼ˆæ²¡æœ‰ç»‘å®šæŒ‰é’®çš„è§’è‰²ï¼‰
        const otherRoles = (configsRaw || []).filter(c => c && c.id && !boundRoleIds.has(c.id));
        if (otherRoles.length > 0) {
            // å¦‚æœæœ‰å·²ç»‘å®šçš„è§’è‰²ï¼Œæ·»åŠ åˆ†éš”çº¿
            if (orderedKeys.length > 0) {
                const separator = document.createElement('div');
                separator.style.cssText = 'height: 1px; background: rgba(255,255,255,0.08); margin: 8px 0; border-radius: 1px;';
                list.appendChild(separator);
            }
            
            otherRoles.forEach((config) => {
                const row = this.createRoleListItem(config, '', configsRaw);
                list.appendChild(row);
            });
        }

        // å¦‚æœæ²¡æœ‰ä»»ä½•è§’è‰²
        if (list.children.length === 0) {
            const empty = document.createElement('div');
            empty.textContent = 'æš‚æ— å¯ç¼–è¾‘è§’è‰²ã€‚ç‚¹å‡»"æ–°å¢è§’è‰²"å¼€å§‹åˆ›å»º';
            empty.style.cssText = 'color: #64748b; font-size: 13px; padding: 24px 12px; text-align: center; line-height: 1.5;';
            list.appendChild(empty);
        }
    }

    // åˆ›å»ºè§’è‰²åˆ—è¡¨é¡¹
    createRoleListItem(c, buttonLabel, allConfigs = null) {
        const row = document.createElement('div');
        row.style.cssText = `
            display:flex !important;
            align-items:center !important;
            justify-content: space-between !important;
            gap: 12px !important;
            padding: 12px !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
            border-radius: 8px !important;
            background: rgba(255,255,255,0.02) !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
        `;
        row.addEventListener('mouseenter', () => {
            row.style.background = 'rgba(255,255,255,0.05)';
            row.style.borderColor = 'rgba(255,255,255,0.15)';
            row.style.transform = 'translateX(2px)';
        });
        row.addEventListener('mouseleave', () => {
            row.style.background = 'rgba(255,255,255,0.02)';
            row.style.borderColor = 'rgba(255,255,255,0.08)';
            row.style.transform = 'translateX(0)';
        });
        const info = document.createElement('div');
        info.style.cssText = 'display:flex; flex-direction:column; gap:6px; flex:1; min-width:0;';
        const name = document.createElement('div');
        const displayIcon = this.getRoleIcon(c, allConfigs);
        name.textContent = `${displayIcon ? (displayIcon + ' ') : ''}${c.label || '(æœªå‘½å)'}`;
        name.style.cssText = 'font-weight: 600; font-size: 13px; color: #fff; line-height: 1.4; word-break: break-word;';
        info.appendChild(name);
        if (buttonLabel && buttonLabel.trim()) {
            const sub = document.createElement('div');
            sub.textContent = buttonLabel;
            sub.style.cssText = 'color: #94a3b8; font-size: 11px; line-height: 1.3;';
            info.appendChild(sub);
        }

        const btns = document.createElement('div');
        btns.style.cssText = 'display:flex; gap:6px; flex-shrink:0;';
        const edit = document.createElement('button');
        edit.textContent = 'ç¼–è¾‘';
        edit.style.cssText = `
            padding: 6px 10px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.06) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        edit.addEventListener('mouseenter', () => {
            edit.style.background = 'rgba(59, 130, 246, 0.15)';
            edit.style.borderColor = 'rgba(59, 130, 246, 0.3)';
            edit.style.color = '#60a5fa';
            edit.style.transform = 'translateY(-1px)';
        });
        edit.addEventListener('mouseleave', () => {
            edit.style.background = 'rgba(255,255,255,0.06)';
            edit.style.borderColor = 'rgba(255,255,255,0.15)';
            edit.style.color = '#e5e7eb';
            edit.style.transform = 'translateY(0)';
        });
        edit.addEventListener('click', () => this.renderRoleSettingsForm(c.id));
        const del = document.createElement('button');
        del.textContent = 'åˆ é™¤';
        del.style.cssText = `
            padding: 6px 10px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            border-radius: 6px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.06) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        `;
        del.addEventListener('mouseenter', () => {
            del.style.background = 'rgba(239, 68, 68, 0.15)';
            del.style.borderColor = 'rgba(239, 68, 68, 0.3)';
            del.style.color = '#f87171';
            del.style.transform = 'translateY(-1px)';
        });
        del.addEventListener('mouseleave', () => {
            del.style.background = 'rgba(255,255,255,0.06)';
            del.style.borderColor = 'rgba(255,255,255,0.15)';
            del.style.color = '#e5e7eb';
            del.style.transform = 'translateY(0)';
        });
        del.addEventListener('click', async () => {
            const next = (await this.getRoleConfigs()).filter(x => x.id !== c.id);
            await this.setRoleConfigs(next);
            this.renderRoleSettingsList();
            this.renderRoleSettingsForm(null, true); // æ˜¾ç¤ºç©ºç™½çŠ¶æ€
            // åŒæ­¥åˆ·æ–°æ¬¢è¿æ¶ˆæ¯ä¸‹çš„åŠ¨ä½œæŒ‰é’®
            await this.refreshWelcomeActionButtons();
            // åˆ·æ–°æ‰€æœ‰æ¶ˆæ¯ä¸‹çš„æŒ‰é’®
            await this.refreshAllMessageActionButtons();
        });
        btns.appendChild(edit);
        btns.appendChild(del);

        row.appendChild(info);
        row.appendChild(btns);
        return row;
    }

    async renderRoleSettingsForm(editId = null, showEmptyState = false) {
        if (!this.chatWindow) return;
        const form = this.chatWindow.querySelector('#pet-role-form');
        if (!form) return;
        const configsAll = await this.getRoleConfigs();
        // ç”¨äºæŸ¥æ‰¾å·²ç»‘å®šæŒ‰é’®çš„è§’è‰²åˆ—è¡¨ï¼ˆç”¨äºæ£€æŸ¥å ç”¨æƒ…å†µï¼‰
        const configs = (configsAll || []).filter(c => c && c.actionKey);
        // å½“å‰ç¼–è¾‘çš„è§’è‰²ï¼ˆä»æ‰€æœ‰è§’è‰²ä¸­æŸ¥æ‰¾ï¼‰
        const current = editId ? (configsAll || []).find(c => c && c.id === editId) : null;
        
        form.innerHTML = '';

        // å¦‚æœæ˜¾ç¤ºç©ºç™½çŠ¶æ€ï¼ˆæ²¡æœ‰é€‰ä¸­è§’è‰²ä¸”ä¸æ˜¯ä¸»åŠ¨æ–°å¢ï¼‰
        if (showEmptyState && !editId && !current) {
            const emptyState = document.createElement('div');
            emptyState.style.cssText = `
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                height: 100% !important;
                padding: 40px 20px !important;
                text-align: center !important;
            `;
            
            const icon = document.createElement('div');
            icon.textContent = 'ğŸ‘¤';
            icon.style.cssText = `
                font-size: 64px !important;
                margin-bottom: 20px !important;
                opacity: 0.6 !important;
            `;
            
            const title = document.createElement('div');
            title.textContent = 'é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹ç¼–è¾‘';
            title.style.cssText = `
                font-weight: 600 !important;
                font-size: 16px !important;
                color: #e5e7eb !important;
                margin-bottom: 8px !important;
            `;
            
            const desc = document.createElement('div');
            desc.textContent = 'ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©è§’è‰²è¿›è¡Œç¼–è¾‘ï¼Œæˆ–ç‚¹å‡»"æ–°å¢è§’è‰²"åˆ›å»ºæ–°è§’è‰²';
            desc.style.cssText = `
                font-size: 13px !important;
                color: #94a3b8 !important;
                line-height: 1.6 !important;
                max-width: 320px !important;
            `;
            
            const actionBtn = document.createElement('button');
            actionBtn.textContent = 'æ–°å¢è§’è‰²';
            actionBtn.style.cssText = `
                margin-top: 24px !important;
                padding: 10px 24px !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                border-radius: 8px !important;
                border: 1px solid rgba(255,255,255,0.15) !important;
                background: rgba(255,255,255,0.06) !important;
                color: #e5e7eb !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
            `;
            actionBtn.addEventListener('mouseenter', () => {
                actionBtn.style.background = 'rgba(255,255,255,0.12)';
                actionBtn.style.borderColor = 'rgba(255,255,255,0.25)';
                actionBtn.style.transform = 'translateY(-2px)';
            });
            actionBtn.addEventListener('mouseleave', () => {
                actionBtn.style.background = 'rgba(255,255,255,0.06)';
                actionBtn.style.borderColor = 'rgba(255,255,255,0.15)';
                actionBtn.style.transform = 'translateY(0)';
            });
            actionBtn.addEventListener('click', () => {
                this.renderRoleSettingsForm(null, false); // æ˜¾ç¤ºæ–°å¢è¡¨å•
            });
            
            emptyState.appendChild(icon);
            emptyState.appendChild(title);
            emptyState.appendChild(desc);
            emptyState.appendChild(actionBtn);
            form.appendChild(emptyState);
            return;
        }

        const title = document.createElement('div');
        title.textContent = current ? 'ç¼–è¾‘è§’è‰²' : 'æ–°å¢è§’è‰²';
        title.style.cssText = 'font-weight: 600; font-size: 18px; color: #fff; margin-bottom: 4px;';

        const row = (labelText, inputEl) => {
            const wrap = document.createElement('div');
            wrap.style.cssText = 'display:flex; flex-direction:column; gap:8px;';
            const lab = document.createElement('label');
            lab.textContent = labelText;
            lab.style.cssText = 'font-size: 13px; font-weight: 500; color: #cbd5e1;';
            wrap.appendChild(lab);
            wrap.appendChild(inputEl);
            return wrap;
        };

        const currentColor = this.colors[this.colorIndex];
        const mainColor = this.getMainColorFromGradient(currentColor);

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = current?.label || '';
        nameInput.placeholder = 'è§’è‰²åç§°ï¼Œå¦‚ï¼šä¼šè®®çºªè¦æ‘˜è¦';
        nameInput.style.cssText = `
            padding: 10px 12px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            outline: none !important;
            background: #121212 !important;
            color: #fff !important;
            font-size: 13px !important;
            transition: all 0.2s ease !important;
        `;
        nameInput.addEventListener('focus', () => {
            nameInput.style.borderColor = 'rgba(255,255,255,0.25)';
            nameInput.style.background = '#1a1a1a';
        });
        nameInput.addEventListener('blur', () => {
            nameInput.style.borderColor = 'rgba(255,255,255,0.12)';
            nameInput.style.background = '#121212';
        });

        // è§’è‰²å›¾æ ‡ï¼ˆå¯ç”¨ Emoji æˆ–çŸ­æ–‡æœ¬ï¼‰
        const iconInput = document.createElement('input');
        iconInput.type = 'text';
        iconInput.value = current?.icon || '';
        iconInput.placeholder = 'å›¾æ ‡ï¼ˆEmoji æˆ–çŸ­æ–‡æœ¬ï¼Œå¦‚ï¼šğŸ“ / AIï¼‰';
        // å–æ¶ˆ maxLengthï¼Œé¿å…å¤šç ç‚¹ Emoji è¢«æˆªæ–­
        iconInput.style.cssText = `
            padding: 10px 12px !important;
            width: 80px !important;
            text-align: center !important;
            font-size: 18px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            outline: none !important;
            background: #121212 !important;
            color: #fff !important;
            transition: all 0.2s ease !important;
        `;
        iconInput.addEventListener('focus', () => {
            iconInput.style.borderColor = 'rgba(255,255,255,0.25)';
            iconInput.style.background = '#1a1a1a';
        });
        iconInput.addEventListener('blur', () => {
            iconInput.style.borderColor = 'rgba(255,255,255,0.12)';
            iconInput.style.background = '#121212';
        });

        // å›¾æ ‡é¢„è§ˆä¸å¿«æ·é€‰æ‹©
        const iconRow = document.createElement('div');
        iconRow.style.cssText = 'display:flex; align-items:center; gap:12px;';
        const iconPreview = document.createElement('div');
        iconPreview.textContent = iconInput.value || 'ğŸ™‚';
        iconPreview.style.cssText = `
            width: 48px !important;
            height: 48px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 10px !important;
            background: #121212 !important;
            color: #e5e7eb !important;
            font-size: 24px !important;
            flex-shrink: 0 !important;
        `;
        const emojiQuick = document.createElement('div');
        emojiQuick.style.cssText = 'display:flex; gap:8px; flex-wrap:wrap; margin-top: 4px;';
        const commonEmojis = ['ğŸ“','ğŸ§ ','ğŸ“š','ğŸ“Œ','âœ…','ğŸ’¡','ğŸ”','ğŸ“„','ğŸ—‚ï¸','â­'];
        commonEmojis.forEach(e => {
            const b = document.createElement('button');
            b.type = 'button';
            b.textContent = e;
            b.style.cssText = `
                width: 36px !important;
                height: 36px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                border: 1px solid rgba(255,255,255,0.15) !important;
                background: rgba(255,255,255,0.04) !important;
                color: #e5e7eb !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                font-size: 18px !important;
                transition: all 0.2s ease !important;
            `;
            b.addEventListener('mouseenter', () => {
                b.style.background = 'rgba(255,255,255,0.12)';
                b.style.borderColor = 'rgba(255,255,255,0.3)';
                b.style.transform = 'scale(1.1)';
            });
            b.addEventListener('mouseleave', () => {
                b.style.background = 'rgba(255,255,255,0.04)';
                b.style.borderColor = 'rgba(255,255,255,0.15)';
                b.style.transform = 'scale(1)';
            });
            b.addEventListener('click', () => {
                iconInput.value = e;
                iconPreview.textContent = e || 'ğŸ™‚';
            });
            emojiQuick.appendChild(b);
        });
        iconInput.addEventListener('input', () => {
            iconPreview.textContent = iconInput.value || 'ğŸ™‚';
        });

        // å»é™¤â€œå¯¹åº”åŠŸèƒ½â€ä¸‹æ‹‰æ¡†

        // å·²ç§»é™¤â€œç”Ÿæˆå†…å®¹åŒ…å«å›¾è¡¨ï¼ˆå¦‚ Mermaidï¼‰â€é€‰é¡¹

        const promptArea = document.createElement('textarea');
        promptArea.rows = 16;
        promptArea.placeholder = 'æç¤ºè¯­ï¼ˆå¯é€‰ï¼‰ï¼šä¸ºè¯¥è§’è‰²çš„ç”Ÿæˆæä¾›é£æ ¼/ç»“æ„æŒ‡å¯¼';
        promptArea.value = current?.prompt || '';
        promptArea.style.cssText = `
            padding: 12px !important;
            border: 1px solid rgba(255,255,255,0.12) !important;
            border-radius: 8px !important;
            resize: vertical !important;
            outline: none !important;
            background: #121212 !important;
            color: #fff !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
            font-family: inherit !important;
            transition: all 0.2s ease !important;
            min-height: 200px !important;
        `;
        promptArea.addEventListener('focus', () => {
            promptArea.style.borderColor = 'rgba(255,255,255,0.25)';
            promptArea.style.background = '#1a1a1a';
        });
        promptArea.addEventListener('blur', () => {
            promptArea.style.borderColor = 'rgba(255,255,255,0.12)';
            promptArea.style.background = '#121212';
        });

        const btns = document.createElement('div');
        btns.style.cssText = 'display:flex; gap:10px; margin-top: 8px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08);';
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            border-radius: 8px !important;
            border: 1px solid rgba(34, 197, 94, 0.3) !important;
            background: rgba(34, 197, 94, 0.15) !important;
            color: #4ade80 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            flex: 1 !important;
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = 'rgba(34, 197, 94, 0.25)';
            saveBtn.style.borderColor = 'rgba(34, 197, 94, 0.4)';
            saveBtn.style.transform = 'translateY(-1px)';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = 'rgba(34, 197, 94, 0.15)';
            saveBtn.style.borderColor = 'rgba(34, 197, 94, 0.3)';
            saveBtn.style.transform = 'translateY(0)';
        });
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            background: rgba(255,255,255,0.06) !important;
            color: #e5e7eb !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            flex: 1 !important;
        `;
        cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = 'rgba(255,255,255,0.12)';
            cancelBtn.style.borderColor = 'rgba(255,255,255,0.25)';
            cancelBtn.style.transform = 'translateY(-1px)';
        });
        cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'rgba(255,255,255,0.06)';
            cancelBtn.style.borderColor = 'rgba(255,255,255,0.15)';
            cancelBtn.style.transform = 'translateY(0)';
        });

        // æå–é¦–ä¸ªâ€œå¯è§å­—ç¬¦â€çš„ç®€æ˜“å‡½æ•°ï¼ˆä¼˜å…ˆä¿ç•™å®Œæ•´ Emojiï¼‰
        const getSafeIcon = (raw) => {
            try {
                if (typeof Intl !== 'undefined' && Intl.Segmenter) {
                    const seg = new Intl.Segmenter(undefined, { granularity: 'grapheme' });
                    const it = seg.segment(raw);
                    const first = it[Symbol.iterator]().next();
                    return first && first.value ? first.value.segment : raw.trim();
                }
            } catch (_) {}
            return raw.trim();
        };

        saveBtn.addEventListener('click', async () => {
            // ä¿å­˜æŒ‰é’®åŠ è½½çŠ¶æ€
            const originalText = saveBtn.textContent;
            const isLoading = saveBtn.dataset.loading === 'true';
            if (isLoading) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
            
            // è®¾ç½®åŠ è½½çŠ¶æ€
            saveBtn.dataset.loading = 'true';
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.7';
            saveBtn.style.cursor = 'not-allowed';
            
            // ä¿å­˜åŠ è½½çŠ¶æ€æ ·å¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            if (!document.getElementById('role-save-loading-styles')) {
                const loadingStyle = document.createElement('style');
                loadingStyle.id = 'role-save-loading-styles';
                loadingStyle.textContent = `
                    @keyframes roleSavePulse {
                        0%, 100% { opacity: 0.7; }
                        50% { opacity: 1; }
                    }
                    button[data-loading="true"] {
                        animation: roleSavePulse 1.5s ease-in-out infinite !important;
                    }
                `;
                document.head.appendChild(loadingStyle);
            }
            
            try {
                const next = {
                    id: current?.id || ('r_' + Math.random().toString(36).slice(2, 10)),
                    label: nameInput.value.trim() || 'æœªå‘½åè§’è‰²',
                    actionKey: current?.actionKey || '',
                    includeCharts: current?.includeCharts ?? false,
                    icon: (iconInput.value.trim() === '' ? (current?.icon || '') : getSafeIcon(iconInput.value)),
                    prompt: promptArea.value.trim(),
                };
                
                const arr = await this.getRoleConfigs();
                
                // æ›´æ–°æˆ–æ·»åŠ è§’è‰²
                const idx = arr.findIndex(x => x.id === next.id);
                const isEdit = idx >= 0;
                if (isEdit) {
                    arr[idx] = next;
                } else {
                    arr.push(next);
                }
                
                await this.setRoleConfigs(arr);
                
                // çŸ­æš‚å»¶è¿Ÿä»¥æä¾›æ›´å¥½çš„è§†è§‰åé¦ˆ
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // åˆ·æ–°ç•Œé¢
                this.renderRoleSettingsList();
                this.renderRoleSettingsForm(null, true); // æ˜¾ç¤ºç©ºç™½çŠ¶æ€
                // åŒæ­¥åˆ·æ–°æ¬¢è¿æ¶ˆæ¯ä¸‹çš„åŠ¨ä½œæŒ‰é’®
                await this.refreshWelcomeActionButtons();
                // åˆ·æ–°æ‰€æœ‰æ¶ˆæ¯ä¸‹çš„æŒ‰é’®
                await this.refreshAllMessageActionButtons();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                const successMessage = isEdit ? `âœ… è§’è‰² "${next.label}" å·²æ›´æ–°` : `âœ… è§’è‰² "${next.label}" å·²åˆ›å»º`;
                this.showNotification(successMessage, 'success');
                
            } catch (error) {
                console.error('ä¿å­˜è§’è‰²è®¾ç½®å¤±è´¥:', error);
                this.showNotification(`âŒ ä¿å­˜å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.dataset.loading = 'false';
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            }
        });

        cancelBtn.addEventListener('click', () => {
            this.renderRoleSettingsForm(null, true); // æ˜¾ç¤ºç©ºç™½çŠ¶æ€
        });

        form.appendChild(title);
        form.appendChild(row('è§’è‰²åç§°', nameInput));
        // å›¾æ ‡è®¾ç½®åŒºï¼šé¢„è§ˆ + è¾“å…¥ + å¿«é€‰
        const iconWrap = document.createElement('div');
        iconWrap.style.cssText = 'display:flex; flex-direction:column; gap:8px;';
        const iconLabel = document.createElement('label');
        iconLabel.textContent = 'å›¾æ ‡';
        iconLabel.style.cssText = 'font-size: 13px; font-weight: 500; color: #cbd5e1;';
        const iconRowOuter = document.createElement('div');
        iconRowOuter.style.cssText = 'display:flex; align-items:center; gap:10px;';
        iconRowOuter.appendChild(iconPreview);
        iconRowOuter.appendChild(iconInput);
        iconWrap.appendChild(iconLabel);
        iconWrap.appendChild(iconRowOuter);
        iconWrap.appendChild(emojiQuick);
        form.appendChild(iconWrap);
        form.appendChild(row('æç¤ºè¯­', promptArea));
        form.appendChild(btns);
        btns.appendChild(saveBtn);
        btns.appendChild(cancelBtn);
    }

    // åŠ¨æ€æ›´æ–°ä¸Šä¸‹æ–‡è¦†ç›–å±‚çš„ä½ç½®ä¸å°ºå¯¸ï¼Œé¿å…é®æŒ¡ chat-header
    updateContextEditorPosition() {
        if (!this.chatWindow) return;
        const overlay = this.chatWindow.querySelector('#pet-context-editor');
        if (!overlay) return;
        const chatHeaderEl = this.chatWindow.querySelector('.chat-header');
        const headerH = chatHeaderEl ? chatHeaderEl.offsetHeight : 60;
        overlay.style.top = headerH + 'px';
        overlay.style.left = '0px';
        overlay.style.right = '0px';
        overlay.style.bottom = '0px';
    }

    /**
     * ä»å½“å‰ç½‘é¡µæ‹‰å–ä¸Šä¸‹æ–‡å¹¶æ›´æ–°ç¼–è¾‘å™¨
     * @returns {Promise<void>}
     */
    async refreshContextFromPage() {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
        if (!textarea) {
            throw new Error('æœªæ‰¾åˆ°ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨');
        }

        try {
            // è·å–å½“å‰ç½‘é¡µæ¸²æŸ“åçš„ HTML å†…å®¹å¹¶è½¬æ¢ä¸º Markdown
            const pageContent = this.getRenderedHTMLAsMarkdown();
            
            // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹
            textarea.value = pageContent || '';
            
            // æ›´æ–°é¢„è§ˆ
            this.updateContextPreview();
            
            // å¦‚æœå½“å‰æœ‰ä¼šè¯ï¼Œä¹Ÿæ›´æ–°ä¼šè¯ä¸­çš„é¡µé¢å†…å®¹
            if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                const pageTitle = document.title || 'å½“å‰é¡µé¢';
                const session = this.sessions[this.currentSessionId];
                session.pageContent = pageContent;
                session.pageTitle = pageTitle;
                // æ›´æ–°ä¼šè¯æ—¶é—´æˆ³ï¼Œç¡®ä¿ä¿å­˜é€»è¾‘è¯†åˆ«åˆ°å˜åŒ–
                session.updatedAt = Date.now();
                session.lastAccessTime = Date.now();
                // é™é»˜ä¿å­˜ï¼Œä¸æ˜¾ç¤ºæç¤ºï¼ˆåŒæ­¥åˆ°åç«¯ï¼‰
                this.saveAllSessions(true, true).catch(err => {
                    console.error('è‡ªåŠ¨ä¿å­˜æ›´æ–°çš„ä¸Šä¸‹æ–‡å¤±è´¥:', err);
                });
            }
        } catch (error) {
            console.error('æ‹‰å–ç½‘é¡µä¸Šä¸‹æ–‡å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * è·å–å½“å‰ç½‘é¡µæ¸²æŸ“åçš„ HTML å†…å®¹å¹¶è½¬æ¢ä¸º Markdown
     * è¯¥æ–¹æ³•ä¸“é—¨ç”¨äºåˆ·æ–°æŒ‰é’®åŠŸèƒ½ï¼Œç¡®ä¿è·å–æœ€æ–°çš„æ¸²æŸ“å†…å®¹
     */
    getRenderedHTMLAsMarkdown() {
        try {
            // æ£€æŸ¥ Turndown æ˜¯å¦å¯ç”¨
            if (typeof TurndownService === 'undefined') {
                console.warn('Turndown æœªåŠ è½½ï¼Œè¿”å›çº¯æ–‡æœ¬å†…å®¹');
                return this.getFullPageText();
            }

            // å®šä¹‰éœ€è¦æ’é™¤çš„é€‰æ‹©å™¨
            const excludeSelectors = [
                'script', 'style', 'noscript', 'iframe', 'embed', 'object',
                'svg', 'canvas', 'video', 'audio',
                '.ad', '.advertisement', '.ads', '.advertisement-container',
                '[class*="ad-"]', '[class*="banner"]', '[class*="promo"]',
                '[id*="ad-"]', '[id*="banner"]', '[id*="promo"]',
                'nav', 'header', 'footer', 'aside',
                '.sidebar', '.menu', '.navigation', '.navbar', '.nav',
                '.header', '.footer', '.comment', '.comments', '.social-share',
                '.related-posts', '.related', '.widget', '.sidebar-widget'
            ];

            // å®šä¹‰ä¸»è¦æ­£æ–‡å†…å®¹é€‰æ‹©å™¨ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰
            const contentSelectors = [
                'article',
                'main',
                '[role="main"]',
                '[role="article"]',
                '.post-content', '.entry-content', '.article-content',
                '.post-body', '.article-body', '.text-content',
                '.content', '.main-content', '.page-content',
                '.article', '.blog-post', '.entry', '.post',
                '#content', '#main-content', '#main',
                '.content-area', '.content-wrapper',
                '.text-wrapper', '.text-container'
            ];

            // å°è¯•ä»ä¸»è¦å†…å®¹åŒºåŸŸè·å–æ¸²æŸ“åçš„ HTML
            let mainContent = null;
            for (const selector of contentSelectors) {
                const element = document.querySelector(selector);
                if (element && element.textContent.trim().length > 100) {
                    mainContent = element;
                    break;
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸»è¦å†…å®¹åŒºåŸŸï¼Œä½¿ç”¨ bodyï¼ˆä½†æ’é™¤å¯¼èˆªã€ä¾§è¾¹æ ç­‰ï¼‰
            if (!mainContent) {
                mainContent = document.body;
            }

            // æ·±åº¦å…‹éš†å†…å®¹ï¼Œä¿ç•™æ‰€æœ‰æ¸²æŸ“åçš„å±æ€§å’ŒçŠ¶æ€
            const cloned = mainContent.cloneNode(true);

            // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
            excludeSelectors.forEach(sel => {
                try {
                    const elements = cloned.querySelectorAll(sel);
                    elements.forEach(el => {
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                    });
                } catch (e) {
                    console.warn('ç§»é™¤å…ƒç´ å¤±è´¥:', sel, e);
                }
            });

            // é…ç½® Turndown æœåŠ¡
            const turndownService = new TurndownService({
                headingStyle: 'atx',
                hr: '---',
                bulletListMarker: '-',
                codeBlockStyle: 'fenced',
                fence: '```',
                emDelimiter: '_',
                strongDelimiter: '**',
                linkStyle: 'inlined',
                linkReferenceStyle: 'full',
                preformattedCode: true
            });

            // æ·»åŠ è‡ªå®šä¹‰è§„åˆ™ï¼Œæ›´å¥½åœ°å¤„ç†ç‰¹æ®Šå…ƒç´ 
            turndownService.addRule('preserveLineBreaks', {
                filter: ['br'],
                replacement: () => '\n'
            });

            // è½¬æ¢ä¸º Markdown
            let markdown = turndownService.turndown(cloned);

            // æ¸…ç†å¤šä½™çš„ç©ºè¡Œï¼ˆä¿ç•™åŒç©ºè¡Œç”¨äºæ®µè½åˆ†éš”ï¼‰
            markdown = markdown
                .replace(/\n{4,}/g, '\n\n\n')  // æœ€å¤šä¿ç•™ä¸‰ä¸ªæ¢è¡Œï¼ˆä¸¤ä¸ªç©ºè¡Œï¼‰
                .trim();

            // å¦‚æœ Markdown å†…å®¹å¤ªçŸ­æˆ–ä¸ºç©ºï¼Œå°è¯•è·å–çº¯æ–‡æœ¬
            if (!markdown || markdown.trim().length < 50) {
                console.warn('Markdown å†…å®¹è¿‡çŸ­ï¼Œå°è¯•è·å–çº¯æ–‡æœ¬');
                const textContent = cloned.textContent || cloned.innerText || '';
                return textContent.trim();
            }

            return markdown;
        } catch (error) {
            console.error('å°†æ¸²æŸ“åçš„ HTML è½¬æ¢ä¸º Markdown æ—¶å‡ºé”™:', error);
            // å‡ºé”™æ—¶è¿”å›çº¯æ–‡æœ¬
            return this.getFullPageText();
        }
    }

    /**
     * å¤„ç†æ‰‹åŠ¨ä¿å­˜ä¼šè¯ï¼ˆä»æ¬¢è¿æ¶ˆæ¯æŒ‰é’®è§¦å‘ï¼‰
     * @param {HTMLElement} button - ä¿å­˜æŒ‰é’®å…ƒç´ 
     */
    async handleManualSaveSession(button) {
        if (!this.currentSessionId) {
            console.warn('å½“å‰æ²¡æœ‰æ´»åŠ¨ä¼šè¯');
            this._showManualSaveStatus(button, false);
            return;
        }

        if (!this.sessions[this.currentSessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨');
            this._showManualSaveStatus(button, false);
            return;
        }

        // è·å–æŒ‰é’®å…ƒç´ 
        const iconEl = button.querySelector('.save-btn-icon');
        const textEl = button.querySelector('.save-btn-text');
        const loaderEl = button.querySelector('.save-btn-loader');

        try {
            // è®¾ç½® loading çŠ¶æ€
            button.disabled = true;
            button.classList.add('loading');
            // éšè—å›¾æ ‡å’Œæ–‡æœ¬ï¼Œæ˜¾ç¤º loader
            if (iconEl) {
                iconEl.style.opacity = '0';
                iconEl.style.display = 'none';
            }
            if (textEl) {
                textEl.style.opacity = '0';
                textEl.textContent = 'ä¿å­˜ä¸­...';
            }
            if (loaderEl) {
                loaderEl.style.display = 'block';
            }

            const session = this.sessions[this.currentSessionId];
            
            // è·å–å½“å‰é¡µé¢å†…å®¹å¹¶æ›´æ–°åˆ°ä¼šè¯
            const pageContent = this.getPageContentAsMarkdown();
            session.pageContent = pageContent || '';
            
            // æ›´æ–°é¡µé¢ä¿¡æ¯ï¼ˆç¡®ä¿ä¿¡æ¯æ˜¯æœ€æ–°çš„ï¼‰
            const pageInfo = this.getPageInfo();
            session.pageTitle = pageInfo.title || session.pageTitle || document.title || 'å½“å‰é¡µé¢';
            session.pageDescription = pageInfo.description || session.pageDescription || '';
            session.url = pageInfo.url || session.url || window.location.href;
            
            // æ›´æ–°ä¼šè¯æ—¶é—´æˆ³
            session.updatedAt = Date.now();
            session.lastAccessTime = Date.now();
            
            // å…ˆä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            await this.saveAllSessions(true, true);
            
            // æ‰‹åŠ¨ä¿å­˜æ—¶ï¼ŒåŒæ­¥åˆ°åç«¯å¹¶åŒ…å« pageContent å­—æ®µ
            await this.syncSessionToBackend(this.currentSessionId, true, true);
            
            // å°†ä¼šè¯IDæ·»åŠ åˆ°åç«¯ä¼šè¯IDé›†åˆä¸­ï¼ˆè¡¨ç¤ºå·²ä¿å­˜åˆ°åç«¯ï¼‰
            this.backendSessionIds.add(this.currentSessionId);
            
            // åˆ·æ–°æ¬¢è¿æ¶ˆæ¯ä»¥éšè—ä¿å­˜æŒ‰é’®ï¼ˆå› ä¸ºç°åœ¨å·²å­˜åœ¨äºåç«¯åˆ—è¡¨ä¸­ï¼‰
            await this.refreshWelcomeMessage();
            
            // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            this._showManualSaveStatus(button, true);
            
            console.log('ä¼šè¯å·²æ‰‹åŠ¨ä¿å­˜:', this.currentSessionId);
        } catch (error) {
            console.error('æ‰‹åŠ¨ä¿å­˜ä¼šè¯å¤±è´¥:', error);
            this._showManualSaveStatus(button, false);
        }
    }

    /**
     * æ˜¾ç¤ºæ‰‹åŠ¨ä¿å­˜æŒ‰é’®çš„çŠ¶æ€
     * @param {HTMLElement} button - æŒ‰é’®å…ƒç´ 
     * @param {boolean} success - æ˜¯å¦æˆåŠŸ
     */
    _showManualSaveStatus(button, success) {
        const iconEl = button.querySelector('.save-btn-icon');
        const textEl = button.querySelector('.save-btn-text');
        const loaderEl = button.querySelector('.save-btn-loader');

        // ç§»é™¤ loading çŠ¶æ€
        button.classList.remove('loading');
        if (loaderEl) loaderEl.style.display = 'none';

        if (success) {
            // æˆåŠŸçŠ¶æ€
            button.classList.add('success');
            button.classList.remove('error');
            if (iconEl) {
                iconEl.textContent = 'âœ“';
                iconEl.style.display = 'inline-flex';
            }
            if (textEl) textEl.textContent = 'å·²ä¿å­˜';
        } else {
            // å¤±è´¥çŠ¶æ€
            button.classList.add('error');
            button.classList.remove('success');
            if (iconEl) {
                iconEl.textContent = 'âœ•';
                iconEl.style.display = 'inline-flex';
            }
            if (textEl) textEl.textContent = 'ä¿å­˜å¤±è´¥';
        }

        // 2.5ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
        setTimeout(() => {
            button.disabled = false;
            button.classList.remove('success', 'error');
            if (iconEl) {
                iconEl.textContent = 'ğŸ’¾';
                iconEl.style.display = 'inline-flex';
            }
            if (textEl) textEl.textContent = 'ä¿å­˜ä¼šè¯';
        }, 2500);
    }

    /**
     * ä¿å­˜é¡µé¢ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å†…å®¹åˆ°ä¼šè¯
     * @returns {Promise<boolean>} ä¿å­˜æ˜¯å¦æˆåŠŸ
     */
    async saveContextEditor() {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
        if (!textarea) {
            console.warn('æœªæ‰¾åˆ°ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨');
            return false;
        }

        if (!this.currentSessionId) {
            console.warn('å½“å‰æ²¡æœ‰æ´»åŠ¨ä¼šè¯');
            return false;
        }

        if (!this.sessions[this.currentSessionId]) {
            console.warn('ä¼šè¯ä¸å­˜åœ¨');
            return false;
        }

        try {
            const editedContent = textarea.value || '';
            const session = this.sessions[this.currentSessionId];
            
            // æ›´æ–°é¡µé¢å†…å®¹
            session.pageContent = editedContent;
            // æ›´æ–°ä¼šè¯æ—¶é—´æˆ³ï¼Œç¡®ä¿ä¿å­˜é€»è¾‘è¯†åˆ«åˆ°å˜åŒ–
            session.updatedAt = Date.now();
            session.lastAccessTime = Date.now();
            
            // å¦‚æœé¡µé¢æ ‡é¢˜è¿˜æ²¡æœ‰è®¾ç½®ï¼ŒåŒæ—¶æ›´æ–°é¡µé¢æ ‡é¢˜
            if (!session.pageTitle || session.pageTitle === 'å½“å‰é¡µé¢') {
                session.pageTitle = document.title || 'å½“å‰é¡µé¢';
            }
            
            // å¼‚æ­¥ä¿å­˜åˆ°å­˜å‚¨ï¼ˆåŒæ­¥åˆ°åç«¯ï¼‰
            await this.saveAllSessions(true, true);
            
            // æ‰‹åŠ¨ä¿å­˜é¡µé¢ä¸Šä¸‹æ–‡æ—¶ï¼Œéœ€è¦åŒæ­¥åˆ°åç«¯å¹¶åŒ…å« pageContent å­—æ®µ
            await this.syncSessionToBackend(this.currentSessionId, true, true);
            
            console.log('é¡µé¢ä¸Šä¸‹æ–‡å·²ä¿å­˜åˆ°ä¼šè¯:', this.currentSessionId);
            return true;
        } catch (error) {
            console.error('ä¿å­˜é¡µé¢ä¸Šä¸‹æ–‡å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * æ˜¾ç¤ºä¿å­˜çŠ¶æ€æç¤º
     * @param {HTMLElement} button - ä¿å­˜æŒ‰é’®å…ƒç´ 
     * @param {boolean} success - æ˜¯å¦æˆåŠŸ
     * @param {string} originalText - åŸå§‹æŒ‰é’®æ–‡æœ¬ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ 'ä¿å­˜'ï¼‰
     */
    _showSaveStatus(button, success, originalText = 'ä¿å­˜') {
        const originalBackground = button.style.background;
        const originalColor = button.style.color;
        
        if (success) {
            button.textContent = 'âœ“ å·²ä¿å­˜';
            button.style.background = 'rgba(76, 175, 80, 0.2)';
            button.style.color = '#4caf50';
            button.style.borderColor = 'rgba(76, 175, 80, 0.4)';
        } else {
            button.textContent = 'âœ• ä¿å­˜å¤±è´¥';
            button.style.background = 'rgba(244, 67, 54, 0.2)';
            button.style.color = '#f44336';
            button.style.borderColor = 'rgba(244, 67, 54, 0.4)';
        }
        
        // 2ç§’åæ¢å¤åŸçŠ¶æ€
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = originalBackground;
            button.style.color = originalColor;
            button.style.borderColor = 'rgba(255,255,255,0.15)';
        }, 2000);
    }

    // å¤åˆ¶é¡µé¢ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨å†…å®¹
    copyContextEditor() {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
        if (!textarea) return;
        
        const content = textarea.value || '';
        if (!content.trim()) return;
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        const textArea = document.createElement('textarea');
        textArea.value = content;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸåé¦ˆ
            const copyBtn = this.chatWindow ? this.chatWindow.querySelector('#pet-context-copy-btn') : null;
            if (copyBtn) {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'å·²å¤åˆ¶';
                copyBtn.style.background = 'rgba(76, 175, 80, 0.3)';
                copyBtn.style.color = '#4caf50';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = 'rgba(255,255,255,0.04)';
                    copyBtn.style.color = '#e5e7eb';
                }, 1500);
            }
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
        }
        
        document.body.removeChild(textArea);
    }

    downloadContextMarkdown() {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
        if (!textarea) return;
        const content = textarea.value || '';
        const title = (document.title || 'page').replace(/\s+/g, '_').replace(/[^\w\-_.]/g, '');
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
        const filename = `${title}_${stamp}.md`;
        try {
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(url);
                if (a.parentNode) a.parentNode.removeChild(a);
            }, 0);
        } catch (e) {
            // å¿½ç•¥ä¸‹è½½é”™è¯¯
        }
    }


    loadContextIntoEditor() {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
        if (!textarea) return;
        try {
            // ä¼˜å…ˆä½¿ç”¨ä¼šè¯ä¿å­˜çš„é¡µé¢å†…å®¹
            let md = '';
            if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                const session = this.sessions[this.currentSessionId];
                // å¦‚æœä¼šè¯çš„pageContentå­—æ®µä¸ºç©ºï¼Œåˆ™å¼¹æ¡†å†…å®¹ä¹Ÿä¸ºç©º
                md = (session.pageContent && session.pageContent.trim() !== '') ? session.pageContent : '';
            } else {
                md = this.getPageContentAsMarkdown();
            }
            textarea.value = md || '';
        } catch (e) {
            textarea.value = 'è·å–é¡µé¢ä¸Šä¸‹æ–‡å¤±è´¥ã€‚';
        }
    }

    updateContextPreview() {
        const textarea = this.chatWindow ? this.chatWindow.querySelector('#pet-context-editor-textarea') : null;
        const preview = this.chatWindow ? this.chatWindow.querySelector('#pet-context-preview') : null;
        if (!textarea || !preview) return;
        const markdown = textarea.value || '';
        // ä½¿ç”¨å·²å­˜åœ¨çš„ Markdown æ¸²æŸ“
        preview.innerHTML = this.renderMarkdown(markdown);
        // æ¸²æŸ“ mermaidï¼ˆè‹¥æœ‰ï¼‰- é˜²æŠ–ï¼Œé¿å…é¢‘ç¹è§¦å‘
        if (preview._mermaidTimer) {
            clearTimeout(preview._mermaidTimer);
            preview._mermaidTimer = null;
        }
        preview._mermaidTimer = setTimeout(async () => {
            await this.processMermaidBlocks(preview);
            preview._mermaidTimer = null;
        }, 200);
    }

    // åˆå§‹åŒ–èŠå¤©æ»šåŠ¨åŠŸèƒ½
    initializeChatScroll() {
        if (!this.chatWindow) return;

        const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
        if (messagesContainer) {
            // ç¡®ä¿æ»šåŠ¨åŠŸèƒ½æ­£å¸¸
            messagesContainer.style.overflowY = 'auto';

            // æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);

            // å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€
            messagesContainer.style.height = 'auto';
            messagesContainer.offsetHeight; // è§¦å‘é‡æ’

            // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿æ»šåŠ¨åŠŸèƒ½æ­£å¸¸
            messagesContainer.addEventListener('scroll', () => {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ»šåŠ¨ç›¸å…³çš„é€»è¾‘
            });
        }
    }

    // æ›´æ–°èŠå¤©çª—å£ä¸­çš„æ¨¡å‹é€‰æ‹©å™¨æ˜¾ç¤º
    updateChatModelSelector() {
        if (!this.chatWindow) return;

        const modelSelector = this.chatWindow.querySelector('.chat-model-selector');
        if (modelSelector) {
            modelSelector.value = this.currentModel;
        }
    }

    // åˆ›å»ºèŠå¤©çª—å£
    async createChatWindow() {
        // æ³¨æ„ï¼šchatWindowState å·²åœ¨ openChatWindow() ä¸­åˆå§‹åŒ–

        // åˆ›å»ºèŠå¤©çª—å£å®¹å™¨
        this.chatWindow = document.createElement('div');
        this.chatWindow.id = 'pet-chat-window';
        this.updateChatWindowStyle();

        // æ ¹æ®å® ç‰©é¢œè‰²è·å–å½“å‰ä¸»é¢˜è‰²è°ƒ
        const currentColor = this.colors[this.colorIndex];
        // æå–ä¸»è‰²è°ƒä½œä¸ºè¾¹æ¡†é¢œè‰²
        const getMainColor = (gradient) => {
            const match = gradient.match(/#[0-9a-fA-F]{6}/);
            return match ? match[0] : '#3b82f6';
        };
        const mainColor = getMainColor(currentColor);

        // åˆ›å»ºèŠå¤©å¤´éƒ¨ï¼ˆæ‹–æ‹½åŒºåŸŸï¼‰- ä½¿ç”¨å® ç‰©é¢œè‰²ä¸»é¢˜
        const chatHeader = document.createElement('div');
        chatHeader.className = 'chat-header';
        chatHeader.style.cssText = `
            background: ${currentColor} !important;
            color: white !important;
            padding: 15px 20px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            cursor: move !important;
            user-select: none !important;
            border-radius: 16px 16px 0 0 !important;
            transition: background 0.2s ease !important;
        `;

        // æ·»åŠ æ‹–æ‹½æç¤º
        chatHeader.title = 'æ‹–æ‹½ç§»åŠ¨çª—å£ | åŒå‡»å…¨å±';

        const headerTitle = document.createElement('div');
        headerTitle.className = 'chat-header-title';
        headerTitle.id = 'pet-chat-header-title';
        headerTitle.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
        `;
        
        // åˆ›å»ºæ ‡é¢˜å†…å®¹
        const titleContent = document.createElement('div');
        titleContent.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
        `;
        titleContent.innerHTML = `
            <span style="font-size: 20px;">ğŸ’•</span>
            <span id="pet-chat-header-title-text" style="font-weight: 600; font-size: 16px;">ä¸æˆ‘èŠå¤©</span>
        `;
        headerTitle.appendChild(titleContent);

        // åˆ›å»ºæŠ˜å ä¾§è¾¹æ æŒ‰é’®ï¼ˆå°†æ”¾åœ¨ä¾§è¾¹æ å³ä¾§å‚ç›´å±…ä¸­ä½ç½®ï¼Œå‚è€ƒè¾“å…¥æ¡†æŠ˜å æŒ‰é’®çš„æ ·å¼ï¼‰
        let toggleSidebarBtn = document.createElement('button');
        toggleSidebarBtn.id = 'sidebar-toggle-btn';
        toggleSidebarBtn.innerHTML = '<span class="toggle-icon">â—€</span>';
        toggleSidebarBtn.title = 'æŠ˜å ä¾§è¾¹æ ';
        toggleSidebarBtn.style.cssText = `
            position: absolute !important;
            top: 50% !important;
            transform: translateY(-50%) translateX(14px) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85)) !important;
            border: 1px solid rgba(229, 231, 235, 0.8) !important;
            color: #374151 !important;
            font-size: 14px !important;
            cursor: pointer !important;
            padding: 0 !important;
            border-radius: 50% !important;
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
            z-index: 5 !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            opacity: 0.9 !important;
        `;
        const sidebarIcon = toggleSidebarBtn.querySelector('.toggle-icon');
        if (sidebarIcon) {
            sidebarIcon.style.cssText = `
                display: inline-block !important;
                transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
            `;
        }
        toggleSidebarBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ‹–æ‹½
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»åé¦ˆ
            toggleSidebarBtn.style.transform = 'translateY(-50%) translateX(14px) scale(0.9)';
            setTimeout(() => {
                toggleSidebarBtn.style.transform = 'translateY(-50%) translateX(14px) scale(1)';
            }, 150);
            this.toggleSidebar();
        });
        toggleSidebarBtn.addEventListener('mouseenter', () => {
            toggleSidebarBtn.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(249, 250, 251, 0.95))';
            toggleSidebarBtn.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1)';
            toggleSidebarBtn.style.transform = 'translateY(-50%) translateX(14px) scale(1.1)';
            toggleSidebarBtn.style.opacity = '1';
            if (sidebarIcon) {
                sidebarIcon.style.transform = 'scale(1.15)';
            }
        });
        toggleSidebarBtn.addEventListener('mouseleave', () => {
            toggleSidebarBtn.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85))';
            toggleSidebarBtn.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06)';
            toggleSidebarBtn.style.transform = 'translateY(-50%) translateX(14px) scale(1)';
            toggleSidebarBtn.style.opacity = '0.9';
            if (sidebarIcon) {
                sidebarIcon.style.transform = 'scale(1)';
            }
        });
        toggleSidebarBtn.addEventListener('mousedown', () => {
            toggleSidebarBtn.style.transform = 'translateY(-50%) translateX(14px) scale(0.95)';
        });
        toggleSidebarBtn.addEventListener('mouseup', () => {
            toggleSidebarBtn.style.transform = 'translateY(-50%) translateX(14px) scale(1.1)';
        });

        // åˆ›å»ºæŠ˜å è¾“å…¥æ¡†å®¹å™¨æŒ‰é’®ï¼ˆå°†æ”¾åœ¨è¾“å…¥æ¡†ä¸Šæ–¹æ°´å¹³å±…ä¸­ä½ç½®ï¼‰
        let toggleInputContainerBtn = document.createElement('button');
        toggleInputContainerBtn.id = 'input-container-toggle-btn';
        toggleInputContainerBtn.innerHTML = '<span class="toggle-icon">â–¼</span>';
        toggleInputContainerBtn.title = 'æŠ˜å è¾“å…¥æ¡†';
        toggleInputContainerBtn.style.cssText = `
            position: absolute !important;
            bottom: 100% !important;
            left: 50% !important;
            transform: translateX(-50%) translateY(-8px) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85)) !important;
            border: 1px solid rgba(229, 231, 235, 0.8) !important;
            color: #374151 !important;
            font-size: 14px !important;
            cursor: pointer !important;
            padding: 0 !important;
            border-radius: 50% !important;
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
            z-index: 5 !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            opacity: 0.9 !important;
        `;
        const inputIcon = toggleInputContainerBtn.querySelector('.toggle-icon');
        if (inputIcon) {
            inputIcon.style.cssText = `
                display: inline-block !important;
                transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
            `;
        }
        toggleInputContainerBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘æ‹–æ‹½
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»åé¦ˆ
            toggleInputContainerBtn.style.transform = 'translateX(-50%) translateY(-8px) scale(0.9)';
            setTimeout(() => {
                toggleInputContainerBtn.style.transform = 'translateX(-50%) translateY(-8px) scale(1)';
            }, 150);
            this.toggleInputContainer();
        });
        toggleInputContainerBtn.addEventListener('mouseenter', () => {
            toggleInputContainerBtn.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(249, 250, 251, 0.95))';
            toggleInputContainerBtn.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1)';
            toggleInputContainerBtn.style.transform = 'translateX(-50%) translateY(-8px) scale(1.1)';
            toggleInputContainerBtn.style.opacity = '1';
            if (inputIcon) {
                inputIcon.style.transform = 'scale(1.15)';
            }
        });
        toggleInputContainerBtn.addEventListener('mouseleave', () => {
            toggleInputContainerBtn.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85))';
            toggleInputContainerBtn.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06)';
            toggleInputContainerBtn.style.transform = 'translateX(-50%) translateY(-8px) scale(1)';
            toggleInputContainerBtn.style.opacity = '0.9';
            if (inputIcon) {
                inputIcon.style.transform = 'scale(1)';
            }
        });
        toggleInputContainerBtn.addEventListener('mousedown', () => {
            toggleInputContainerBtn.style.transform = 'translateX(-50%) translateY(-8px) scale(0.95)';
        });
        toggleInputContainerBtn.addEventListener('mouseup', () => {
            toggleInputContainerBtn.style.transform = 'translateX(-50%) translateY(-8px) scale(1.1)';
        });

        // åˆ›å»ºå…³é—­æŒ‰é’®ï¼ˆä¿æŒåœ¨å³ä¾§ï¼‰
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none !important;
            border: none !important;
            color: white !important;
            font-size: 18px !important;
            cursor: pointer !important;
            padding: 5px !important;
            border-radius: 50% !important;
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: background 0.3s ease !important;
        `;
        closeBtn.addEventListener('click', () => this.closeChatWindow());
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(255,255,255,0.2)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
        });

        chatHeader.appendChild(headerTitle);
        chatHeader.appendChild(closeBtn);

        // åˆ›å»ºä¸»å†…å®¹å®¹å™¨ï¼ˆåŒ…å«ä¾§è¾¹æ å’Œæ¶ˆæ¯åŒºåŸŸï¼‰
        const mainContentContainer = document.createElement('div');
        mainContentContainer.style.cssText = `
            display: flex !important;
            flex: 1 !important;
            overflow: hidden !important;
            background: linear-gradient(135deg, #f8f9fa, #ffffff) !important;
            position: relative !important;
        `;

        // åˆ›å»ºä¼šè¯ä¾§è¾¹æ 
        // åŠ è½½ä¿å­˜çš„ä¾§è¾¹æ å®½åº¦å’ŒæŠ˜å çŠ¶æ€
        this.loadSidebarWidth();
        this.loadSidebarCollapsed();
        // åŠ è½½è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€
        this.loadInputContainerCollapsed();
        // åŠ è½½æ—¥å†æŠ˜å çŠ¶æ€
        this.loadCalendarCollapsed();
        
        this.sessionSidebar = document.createElement('div');
        this.sessionSidebar.className = 'session-sidebar';
        this.sessionSidebar.style.cssText = `
            width: ${this.sidebarWidth}px !important;
            min-width: 150px !important;
            max-width: 500px !important;
            background: white !important;
            border-right: 1px solid #e5e7eb !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            position: relative !important;
            resize: none !important;
        `;

        // ä¾§è¾¹æ æ ‡é¢˜å®¹å™¨
        const sidebarHeader = document.createElement('div');
        sidebarHeader.style.cssText = `
            padding: 12px 15px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
        `;
        
        // ç¬¬ä¸€è¡Œï¼šæœç´¢è¾“å…¥æ¡†å’ŒOSSåˆ‡æ¢æŒ‰é’®
        const firstRow = document.createElement('div');
        firstRow.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            width: 100% !important;
        `;
        
        // ç¬¬äºŒè¡Œï¼šå…¶ä»–æ“ä½œæŒ‰é’®
        const secondRow = document.createElement('div');
        secondRow.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            width: 100% !important;
            flex-wrap: wrap !important;
        `;
        
        // åˆ›å»ºå·¦ä¾§æŒ‰é’®ç»„ï¼ˆæ‰¹é‡ã€å¯¼å‡ºã€å¯¼å…¥ï¼‰
        const leftButtonGroup = document.createElement('div');
        leftButtonGroup.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            flex: 1 !important;
        `;
        
        // åˆ›å»ºæœç´¢è¾“å…¥æ¡†å®¹å™¨ï¼ˆå¸¦å›¾æ ‡å’Œæ¸…é™¤æŒ‰é’®ï¼‰
        const searchContainer = document.createElement('div');
        searchContainer.style.cssText = `
            position: relative !important;
            flex: 1 !important;
            display: flex !important;
            align-items: center !important;
        `;
        
        // æœç´¢å›¾æ ‡
        const searchIcon = document.createElement('span');
        searchIcon.textContent = 'ğŸ”';
        searchIcon.style.cssText = `
            position: absolute !important;
            left: 10px !important;
            font-size: 14px !important;
            pointer-events: none !important;
            z-index: 1 !important;
            opacity: 0.5 !important;
            transition: opacity 0.2s ease !important;
        `;
        
        // åˆ›å»ºæœç´¢è¾“å…¥æ¡†
        const sidebarTitle = document.createElement('input');
        sidebarTitle.type = 'text';
        sidebarTitle.placeholder = 'æœç´¢ä¼šè¯...';
        sidebarTitle.value = this.sessionTitleFilter || '';
        sidebarTitle.id = 'session-search-input';
        sidebarTitle.style.cssText = `
            width: 100% !important;
            font-weight: 400 !important;
            font-size: 13px !important;
            color: #374151 !important;
            padding: 8px 32px 8px 32px !important;
            border: 1.5px solid #e5e7eb !important;
            border-radius: 8px !important;
            background: #ffffff !important;
            outline: none !important;
            transition: all 0.2s ease !important;
            box-sizing: border-box !important;
        `;
        
        // æ·»åŠ å ä½ç¬¦æ ·å¼ï¼ˆé€šè¿‡åŠ¨æ€æ ·å¼è¡¨ï¼‰
        if (!document.getElementById('session-search-placeholder-style')) {
            const style = document.createElement('style');
            style.id = 'session-search-placeholder-style';
            style.textContent = `
                #session-search-input::placeholder {
                    color: #9ca3af !important;
                    opacity: 1 !important;
                }
                #session-search-input:focus::placeholder {
                    color: #d1d5db !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // æ¸…é™¤æŒ‰é’®
        const clearBtn = document.createElement('button');
        clearBtn.innerHTML = 'âœ•';
        clearBtn.type = 'button';
        clearBtn.style.cssText = `
            position: absolute !important;
            right: 6px !important;
            width: 20px !important;
            height: 20px !important;
            border: none !important;
            background: #e5e7eb !important;
            color: #6b7280 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            padding: 0 !important;
            transition: all 0.2s ease !important;
            z-index: 2 !important;
            line-height: 1 !important;
        `;
        
        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        const updateClearButton = () => {
            if (sidebarTitle.value.trim() !== '') {
                clearBtn.style.display = 'flex';
                searchIcon.style.opacity = '0.3';
            } else {
                clearBtn.style.display = 'none';
                searchIcon.style.opacity = '0.5';
            }
        };
        
        // åˆå§‹çŠ¶æ€
        updateClearButton();
        
        // æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        clearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sidebarTitle.value = '';
            this.sessionTitleFilter = '';
            updateClearButton();
            // æ ¹æ®å½“å‰æ¨¡å¼å†³å®šæ›´æ–°å“ªä¸ªåˆ—è¡¨
            if (this.newsListVisible) {
                this.updateNewsSidebar();
            } else if (this.ossFileListVisible) {
                this.updateOssFileSidebar();
            } else if (this.apiRequestListVisible) {
                this.updateApiRequestSidebar();
            } else {
                this.updateSessionSidebar();
            }
            sidebarTitle.focus();
        });
        
        // æ¸…é™¤æŒ‰é’®æ‚¬åœæ•ˆæœ
        clearBtn.addEventListener('mouseenter', () => {
            clearBtn.style.background = '#d1d5db';
            clearBtn.style.transform = 'scale(1.1)';
        });
        clearBtn.addEventListener('mouseleave', () => {
            clearBtn.style.background = '#e5e7eb';
            clearBtn.style.transform = 'scale(1)';
        });
        
        // è¾“å…¥æ¡†èšç„¦å’Œå¤±ç„¦æ ·å¼
        sidebarTitle.addEventListener('focus', () => {
            sidebarTitle.style.borderColor = mainColor;
            sidebarTitle.style.boxShadow = `0 0 0 3px ${mainColor}22`;
            searchIcon.style.opacity = '0.7';
        });
        sidebarTitle.addEventListener('blur', () => {
            sidebarTitle.style.borderColor = '#e5e7eb';
            sidebarTitle.style.boxShadow = 'none';
            searchIcon.style.opacity = sidebarTitle.value.trim() !== '' ? '0.3' : '0.5';
        });
        
        // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶è¿‡æ»¤ä¼šè¯åˆ—è¡¨æˆ–OSSæ–‡ä»¶åˆ—è¡¨ï¼ˆæ·»åŠ é˜²æŠ–ï¼‰
        let searchDebounceTimer = null;
        sidebarTitle.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            this.sessionTitleFilter = value;
            updateClearButton();
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            // é˜²æŠ–å¤„ç†ï¼š300msåæ‰§è¡Œè¿‡æ»¤
            searchDebounceTimer = setTimeout(() => {
                // æ ¹æ®å½“å‰æ¨¡å¼å†³å®šæ›´æ–°å“ªä¸ªåˆ—è¡¨
                if (this.newsListVisible) {
                    this.updateNewsSidebar();
                } else if (this.ossFileListVisible) {
                    this.updateOssFileSidebar();
                } else if (this.apiRequestListVisible) {
                    this.updateApiRequestSidebar();
                } else {
                    this.updateSessionSidebar();
                }
            }, 300);
        });
        
        // é˜»æ­¢è¾“å…¥æ¡†äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å…¶ä»–æ“ä½œ
        sidebarTitle.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // é”®ç›˜å¿«æ·é”®ï¼šESCæ¸…é™¤è¾“å…¥
        sidebarTitle.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebarTitle.value.trim() !== '') {
                sidebarTitle.value = '';
                this.sessionTitleFilter = '';
                updateClearButton();
                // æ ¹æ®å½“å‰æ¨¡å¼å†³å®šæ›´æ–°å“ªä¸ªåˆ—è¡¨
                if (this.newsListVisible) {
                    this.updateNewsSidebar();
                } else if (this.ossFileListVisible) {
                    this.updateOssFileSidebar();
                } else if (this.apiRequestListVisible) {
                    this.updateApiRequestSidebar();
                } else {
                    this.updateSessionSidebar();
                }
                e.stopPropagation();
            }
        });
        
        // ç»„è£…æœç´¢å®¹å™¨
        searchContainer.appendChild(searchIcon);
        searchContainer.appendChild(sidebarTitle);
        searchContainer.appendChild(clearBtn);
        
        // åˆ›å»ºæ‰¹é‡æ¨¡å¼æŒ‰é’®
        const batchModeBtn = document.createElement('span');
        batchModeBtn.innerHTML = 'â˜‘ï¸ æ‰¹é‡é€‰æ‹©';
        batchModeBtn.title = 'æ‰¹é‡é€‰æ‹©';
        batchModeBtn.style.cssText = `
            padding: 4px 10px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            color: white !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            user-select: none !important;
            border-radius: 4px !important;
            background: linear-gradient(135deg, #6366f1, #4f46e5) !important;
            border: 1px solid #4f46e5 !important;
            flex-shrink: 0 !important;
            white-space: nowrap !important;
        `;
        
        // æ‰¹é‡æ¨¡å¼æŒ‰é’®æ‚¬åœæ•ˆæœ
        batchModeBtn.addEventListener('mouseenter', function() {
            if (this.classList.contains('batch-mode-active')) {
                this.style.background = 'linear-gradient(135deg, #059669, #047857) !important';
                this.style.transform = 'translateY(-1px)';
                this.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.3) !important';
            } else {
                this.style.background = 'linear-gradient(135deg, #4f46e5, #4338ca) !important';
                this.style.transform = 'translateY(-1px)';
                this.style.boxShadow = '0 2px 8px rgba(99, 102, 241, 0.3) !important';
            }
        });
        batchModeBtn.addEventListener('mouseleave', function() {
            if (this.classList.contains('batch-mode-active')) {
                this.style.background = 'linear-gradient(135deg, #10b981, #059669) !important';
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none !important';
            } else {
                this.style.background = 'linear-gradient(135deg, #6366f1, #4f46e5) !important';
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none !important';
            }
        });
        
        // æ‰¹é‡æ¨¡å¼æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        batchModeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (this.batchMode) {
                this.exitBatchMode();
            } else {
                this.enterBatchMode();
            }
        });
        
        // åˆ›å»ºå¯¼å‡ºæŒ‰é’®
        const exportBtn = document.createElement('span');
        exportBtn.innerHTML = 'â¬‡ï¸ å¯¼å‡º';
        exportBtn.title = 'å¯¼å‡ºä¼šè¯';
        exportBtn.style.cssText = `
            padding: 4px 10px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            color: white !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            user-select: none !important;
            border-radius: 4px !important;
            background: linear-gradient(135deg, #2196F3, #1976D2) !important;
            border: 1px solid #1976D2 !important;
            flex-shrink: 0 !important;
            white-space: nowrap !important;
        `;
        
        // å¯¼å‡ºæŒ‰é’®æ‚¬åœæ•ˆæœ
        exportBtn.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #1976D2, #1565C0) !important';
            this.style.transform = 'translateY(-1px)';
            this.style.boxShadow = '0 2px 8px rgba(33, 150, 243, 0.3) !important';
        });
        exportBtn.addEventListener('mouseleave', function() {
            this.style.background = 'linear-gradient(135deg, #2196F3, #1976D2) !important';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none !important';
        });
        
        // å¯¼å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        exportBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            exportBtn.style.pointerEvents = 'none';
            exportBtn.style.opacity = '0.6';
            exportBtn.style.cursor = 'wait';
            
            try {
                await this.exportSessionsToZip();
            } catch (error) {
                console.error('å¯¼å‡ºä¼šè¯å¤±è´¥:', error);
                this.showNotification('å¯¼å‡ºä¼šè¯å¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    exportBtn.style.pointerEvents = 'auto';
                    exportBtn.style.opacity = '1';
                    exportBtn.style.cursor = 'pointer';
                }, 500);
            }
        });
        
        // åˆ›å»ºæ·»åŠ æ–°ä¼šè¯æŒ‰é’®
        const addSessionBtn = document.createElement('button');
        addSessionBtn.innerHTML = 'â• æ–°å»º';
        addSessionBtn.title = 'æ–°å»º';
        addSessionBtn.style.cssText = `
            padding: 4px 10px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            color: white !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            user-select: none !important;
            border-radius: 4px !important;
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            border: 1px solid #764ba2 !important;
            flex-shrink: 0 !important;
            white-space: nowrap !important;
        `;
        
        // æŒ‰é’®æ‚¬åœæ•ˆæœ
        addSessionBtn.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #764ba2, #6a3d9a) !important';
            this.style.transform = 'translateY(-1px)';
            this.style.boxShadow = '0 2px 8px rgba(118, 75, 162, 0.3) !important';
        });
        addSessionBtn.addEventListener('mouseleave', function() {
            this.style.background = 'linear-gradient(135deg, #667eea, #764ba2) !important';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none !important';
        });
        
        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼šåˆ›å»ºç©ºç™½æ–°ä¼šè¯ã€ä¸Šä¼ æ–‡ä»¶åˆ°OSSæˆ–æ–°å»ºæ¥å£
        addSessionBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // å¦‚æœåœ¨OSSæ–‡ä»¶è§†å›¾ä¸‹ï¼Œè§¦å‘æ–‡ä»¶ä¸Šä¼ 
            if (this.ossFileListVisible) {
                await this.uploadFileToOss();
                return;
            }
            
            // å¦‚æœåœ¨æ¥å£è¯·æ±‚è§†å›¾ä¸‹ï¼Œåˆ›å»ºæ–°æ¥å£
            if (this.apiRequestListVisible) {
                this.createNewApiRequest();
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            addSessionBtn.disabled = true;
            addSessionBtn.style.opacity = '0.6';
            addSessionBtn.style.cursor = 'wait';
            
            try {
                await this.createBlankSession();
            } catch (error) {
                console.error('åˆ›å»ºæ–°ä¼šè¯å¤±è´¥:', error);
                this.showNotification('åˆ›å»ºæ–°ä¼šè¯å¤±è´¥', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    addSessionBtn.disabled = false;
                    addSessionBtn.style.opacity = '1';
                    addSessionBtn.style.cursor = 'pointer';
                }, 500);
            }
        });
        
        // åˆ›å»ºå¯¼å…¥æŒ‰é’®
        const importBtn = document.createElement('span');
        importBtn.innerHTML = 'â¬†ï¸ å¯¼å…¥';
        importBtn.title = 'å¯¼å…¥ä¼šè¯';
        importBtn.style.cssText = `
            padding: 4px 10px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            color: white !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            user-select: none !important;
            border-radius: 4px !important;
            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
            border: 1px solid #45a049 !important;
            flex-shrink: 0 !important;
            white-space: nowrap !important;
        `;
        
        // å¯¼å…¥æŒ‰é’®æ‚¬åœæ•ˆæœ
        importBtn.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #45a049, #3d8b40) !important';
            this.style.transform = 'translateY(-1px)';
            this.style.boxShadow = '0 2px 8px rgba(76, 175, 80, 0.3) !important';
        });
        importBtn.addEventListener('mouseleave', function() {
            this.style.background = 'linear-gradient(135deg, #4CAF50, #45a049) !important';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none !important';
        });
        
        // å¯¼å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        importBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.zip';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                
                // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                importBtn.style.pointerEvents = 'none';
                importBtn.style.opacity = '0.6';
                importBtn.style.cursor = 'wait';
                
                try {
                    await this.importSessionsFromZip(file);
                } catch (error) {
                    console.error('å¯¼å…¥ä¼šè¯å¤±è´¥:', error);
                    this.showNotification('å¯¼å…¥ä¼šè¯å¤±è´¥: ' + error.message, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    setTimeout(() => {
                        importBtn.style.pointerEvents = 'auto';
                        importBtn.style.opacity = '1';
                        importBtn.style.cursor = 'pointer';
                    }, 500);
                    
                    // æ¸…ç†æ–‡ä»¶è¾“å…¥
                    if (fileInput.parentNode) {
                        fileInput.parentNode.removeChild(fileInput);
                    }
                }
            });
            
            // æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ç‚¹å‡»
            document.body.appendChild(fileInput);
            fileInput.click();
        });
        
        // åˆ›å»ºOSSæ–‡ä»¶åˆ—è¡¨åˆ‡æ¢æŒ‰é’®
        // åˆ›å»ºè§†å›¾åˆ‡æ¢æŒ‰é’®ç»„ï¼ˆå‚è€ƒä¸Šä¸‹æ–‡å¼¹æ¡†çš„æ ·å¼ï¼‰
        const viewToggleGroup = document.createElement('div');
        viewToggleGroup.style.cssText = `
            display: inline-flex !important;
            gap: 6px !important;
            background: rgba(0, 0, 0, 0.04) !important;
            border: 1px solid rgba(0, 0, 0, 0.08) !important;
            border-radius: 8px !important;
            padding: 4px !important;
            flex-shrink: 0 !important;
        `;
        
        // åˆ›å»ºæŒ‰é’®çš„è¾…åŠ©å‡½æ•°ï¼ˆå‚è€ƒä¸Šä¸‹æ–‡å¼¹æ¡†çš„makeModeBtnï¼‰
        const makeViewToggleBtn = (id, label, mode) => {
            const btn = document.createElement('button');
            btn.id = id;
            btn.textContent = label;
            btn.setAttribute('data-view-mode', mode);
            btn.style.cssText = `
                padding: 4px 8px !important;
                font-size: 12px !important;
                border-radius: 6px !important;
                border: none !important;
                background: transparent !important;
                color: #6b7280 !important;
                cursor: pointer !important;
                transition: all 0.12s ease !important;
                font-weight: 500 !important;
                white-space: nowrap !important;
            `;
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                await this.setViewMode(mode);
            });
            return btn;
        };
        
        const btnSession = makeViewToggleBtn('view-toggle-session', 'ğŸ’¬', 'session');
        const btnOss = makeViewToggleBtn('view-toggle-oss', 'ğŸ“¦', 'oss');
        const btnNews = makeViewToggleBtn('view-toggle-news', 'ğŸ“°', 'news');
        const btnApi = makeViewToggleBtn('view-toggle-api', 'ğŸ”Œ', 'api');
        
        viewToggleGroup.appendChild(btnSession);
        viewToggleGroup.appendChild(btnOss);
        viewToggleGroup.appendChild(btnNews);
        viewToggleGroup.appendChild(btnApi);
        
        // ç¬¬ä¸€è¡Œï¼šæœç´¢è¾“å…¥æ¡† + è§†å›¾åˆ‡æ¢æŒ‰é’®ç»„
        firstRow.appendChild(searchContainer);
        firstRow.appendChild(viewToggleGroup);
        
        // ç»„è£…å·¦ä¾§æŒ‰é’®ç»„
        leftButtonGroup.appendChild(batchModeBtn);
        leftButtonGroup.appendChild(exportBtn);
        leftButtonGroup.appendChild(importBtn);
        
        // ç¬¬äºŒè¡Œï¼šå·¦ä¾§æŒ‰é’®ç»„ + å³ä¾§æ–°å»ºæŒ‰é’®
        secondRow.appendChild(leftButtonGroup);
        secondRow.appendChild(addSessionBtn);
        
        // ç»„è£…ä¾§è¾¹æ æ ‡é¢˜
        // åˆ›å»ºæ—¥å†ç»„ä»¶ï¼ˆåœ¨æœç´¢è¾“å…¥æ¡†ä¸Šæ–¹ï¼‰
        const calendarContainer = this.createCalendarComponent();
        sidebarHeader.appendChild(calendarContainer);
        
        sidebarHeader.appendChild(firstRow);
        sidebarHeader.appendChild(secondRow);
        this.sessionSidebar.appendChild(sidebarHeader);
        
        // åˆå§‹åŒ–è§†å›¾åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        this.applyViewMode();
        
        // åˆ›å»ºæ‰¹é‡æ“ä½œå·¥å…·æ å®¹å™¨ï¼ˆåˆå§‹éšè—ï¼‰
        const batchToolbar = document.createElement('div');
        batchToolbar.id = 'batch-toolbar';
        batchToolbar.style.cssText = `
            padding: 8px 12px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
            display: none !important;
            align-items: center !important;
            gap: 8px !important;
            flex-wrap: wrap !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            opacity: 0 !important;
            transform: translateY(-10px) !important;
        `;
        // é€‰ä¸­æ•°é‡æ˜¾ç¤º
        const selectedCount = document.createElement('span');
        selectedCount.id = 'selected-count';
        selectedCount.textContent = 'å·²é€‰æ‹© 0 ä¸ª';
        selectedCount.style.cssText = `
            font-size: 12px !important;
            font-weight: 500 !important;
            color: #6b7280 !important;
            flex: 1 !important;
            padding: 2px 8px !important;
            background: transparent !important;
            border-radius: 4px !important;
            transition: color 0.2s ease !important;
            text-align: left !important;
        `;
        
        // å…¨é€‰æŒ‰é’®
        const selectAllBtn = document.createElement('button');
        selectAllBtn.id = 'select-all-btn';
        selectAllBtn.textContent = 'å…¨é€‰';
        selectAllBtn.style.cssText = `
            padding: 4px 10px !important;
            border-radius: 4px !important;
            background: #ffffff !important;
            color: #374151 !important;
            border: 1px solid #e5e7eb !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease !important;
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        `;
        
        selectAllBtn.addEventListener('mouseenter', () => {
            selectAllBtn.style.background = '#f9fafb';
            selectAllBtn.style.borderColor = '#d1d5db';
        });
        
        selectAllBtn.addEventListener('mouseleave', () => {
            selectAllBtn.style.background = '#ffffff';
            selectAllBtn.style.borderColor = '#e5e7eb';
        });
        
        // å…¨é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        selectAllBtn.addEventListener('click', () => {
            this.toggleSelectAll();
        });
        
        // æ‰¹é‡åˆ é™¤æŒ‰é’®
        const batchDeleteBtn = document.createElement('button');
        batchDeleteBtn.id = 'batch-delete-btn';
        batchDeleteBtn.style.cssText = `
            padding: 4px 10px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            color: white !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            user-select: none !important;
            border-radius: 4px !important;
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            border: 1px solid #dc2626 !important;
            flex-shrink: 0 !important;
            white-space: nowrap !important;
            position: relative !important;
            overflow: hidden !important;
        `;
        
        // æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
        const deleteLoader = document.createElement('span');
        deleteLoader.className = 'delete-loader';
        deleteLoader.style.cssText = `
            display: none !important;
            width: 14px !important;
            height: 14px !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            border-top-color: white !important;
            border-radius: 50% !important;
            animation: spin 0.8s linear infinite !important;
        `;
        
        // æŒ‰é’®æ–‡æœ¬
        const deleteIcon = document.createElement('span');
        deleteIcon.textContent = 'ğŸ—‘ï¸';
        deleteIcon.style.cssText = 'font-size: 12px !important;';
        
        const deleteText = document.createElement('span');
        deleteText.textContent = 'åˆ é™¤';
        
        batchDeleteBtn.appendChild(deleteLoader);
        batchDeleteBtn.appendChild(deleteIcon);
        batchDeleteBtn.appendChild(deleteText);
        
        // æ·»åŠ åŠ è½½åŠ¨ç”»æ ·å¼
        if (!document.getElementById('delete-loader-style')) {
            const style = document.createElement('style');
            style.id = 'delete-loader-style';
            style.textContent = `
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
        
        batchDeleteBtn.addEventListener('mouseenter', function() {
            if (!this.disabled) {
                this.style.background = 'linear-gradient(135deg, #dc2626, #b91c1c) !important';
                this.style.transform = 'translateY(-1px)';
                this.style.boxShadow = '0 2px 8px rgba(239, 68, 68, 0.3) !important';
            }
        });
        batchDeleteBtn.addEventListener('mouseleave', function() {
            if (!this.disabled) {
                this.style.background = 'linear-gradient(135deg, #ef4444, #dc2626) !important';
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none !important';
            }
        });
        
        // å–æ¶ˆæ‰¹é‡æ¨¡å¼æŒ‰é’®
        const cancelBatchBtn = document.createElement('button');
        cancelBatchBtn.innerHTML = '<span style="margin-right: 3px;">âœ•</span>å–æ¶ˆ';
        cancelBatchBtn.style.cssText = `
            padding: 4px 10px !important;
            border-radius: 4px !important;
            background: #ffffff !important;
            color: #6b7280 !important;
            border: 1px solid #e5e7eb !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease !important;
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        `;
        
        cancelBatchBtn.addEventListener('mouseenter', () => {
            cancelBatchBtn.style.background = '#f9fafb';
            cancelBatchBtn.style.borderColor = '#d1d5db';
            cancelBatchBtn.style.color = '#374151';
        });
        cancelBatchBtn.addEventListener('mouseleave', () => {
            cancelBatchBtn.style.background = '#ffffff';
            cancelBatchBtn.style.borderColor = '#e5e7eb';
            cancelBatchBtn.style.color = '#6b7280';
        });
        // æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶
        batchDeleteBtn.addEventListener('click', async () => {
            if (batchDeleteBtn.disabled) return;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loader = batchDeleteBtn.querySelector('.delete-loader');
            const spans = batchDeleteBtn.querySelectorAll('span:not(.delete-loader)');
            const deleteIcon = spans[0];
            const deleteText = spans[1];
            
            if (loader) {
                loader.style.display = 'block';
            }
            if (deleteIcon) {
                deleteIcon.style.display = 'none';
            }
            if (deleteText) {
                deleteText.textContent = 'åˆ é™¤ä¸­...';
            }
            
            batchDeleteBtn.disabled = true;
            batchDeleteBtn.style.opacity = '0.7';
            
            try {
                await this.batchDeleteSessions();
            } finally {
                // éšè—åŠ è½½çŠ¶æ€
                if (loader) {
                    loader.style.display = 'none';
                }
                if (deleteIcon) {
                    deleteIcon.style.display = 'inline';
                }
            if (deleteText) {
                deleteText.textContent = 'åˆ é™¤';
            }
                batchDeleteBtn.disabled = false;
                batchDeleteBtn.style.opacity = '1';
            }
        });
        
        // å–æ¶ˆæ‰¹é‡æ¨¡å¼æŒ‰é’®äº‹ä»¶
        cancelBatchBtn.addEventListener('click', () => {
            this.exitBatchMode();
        });
        
        batchToolbar.appendChild(selectedCount);
        batchToolbar.appendChild(selectAllBtn);
        batchToolbar.appendChild(batchDeleteBtn);
        batchToolbar.appendChild(cancelBatchBtn);
        this.sessionSidebar.appendChild(batchToolbar);

        // æ ‡ç­¾è¿‡æ»¤å™¨å®¹å™¨
        const tagFilterContainer = document.createElement('div');
        tagFilterContainer.className = 'tag-filter-container';
        tagFilterContainer.style.cssText = `
            padding: 8px 12px !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #ffffff !important;
            overflow: visible !important;
            flex-shrink: 0 !important;
        `;

        // è¿‡æ»¤å™¨æ ‡é¢˜è¡Œï¼ˆåŒ…å«æœç´¢è¾“å…¥æ¡†å’Œæ“ä½œæŒ‰é’®ï¼‰
        const filterHeader = document.createElement('div');
        filterHeader.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 8px !important;
            margin-bottom: 6px !important;
        `;

        // å³ä¾§æ“ä½œåŒºï¼ˆåå‘è¿‡æ»¤å¼€å…³ + æ¸…é™¤æŒ‰é’®ï¼‰
        const filterActions = document.createElement('div');
        filterActions.style.cssText = `
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
        `;

        // åå‘è¿‡æ»¤å¼€å…³ï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨å›¾æ ‡ï¼‰
        const reverseFilterBtn = document.createElement('button');
        reverseFilterBtn.className = 'tag-filter-reverse';
        reverseFilterBtn.title = 'åå‘è¿‡æ»¤';
        reverseFilterBtn.innerHTML = 'â‡„';
        reverseFilterBtn.style.cssText = `
            font-size: 12px !important;
            color: ${this.tagFilterReverse ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.tagFilterReverse ? '1' : '0.6'} !important;
        `;
        reverseFilterBtn.addEventListener('mouseenter', () => {
            reverseFilterBtn.style.opacity = '1';
            reverseFilterBtn.style.background = '#f3f4f6';
        });
        reverseFilterBtn.addEventListener('mouseleave', () => {
            if (!this.tagFilterReverse) {
                reverseFilterBtn.style.opacity = '0.6';
            }
            reverseFilterBtn.style.background = 'none';
        });
        reverseFilterBtn.addEventListener('click', () => {
            this.tagFilterReverse = !this.tagFilterReverse;
            reverseFilterBtn.style.color = this.tagFilterReverse ? '#4CAF50' : '#9ca3af';
            reverseFilterBtn.style.opacity = this.tagFilterReverse ? '1' : '0.6';
            this.updateSessionSidebar();
        });

        // æ— æ ‡ç­¾ç­›é€‰å¼€å…³ï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨å›¾æ ‡ï¼‰
        const noTagsFilterBtn = document.createElement('button');
        noTagsFilterBtn.className = 'tag-filter-no-tags';
        noTagsFilterBtn.title = 'ç­›é€‰æ— æ ‡ç­¾';
        noTagsFilterBtn.innerHTML = 'âˆ…';
        noTagsFilterBtn.style.cssText = `
            font-size: 12px !important;
            color: ${this.tagFilterNoTags ? '#4CAF50' : '#9ca3af'} !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: ${this.tagFilterNoTags ? '1' : '0.6'} !important;
        `;
        noTagsFilterBtn.addEventListener('mouseenter', () => {
            noTagsFilterBtn.style.opacity = '1';
            noTagsFilterBtn.style.background = '#f3f4f6';
        });
        noTagsFilterBtn.addEventListener('mouseleave', () => {
            if (!this.tagFilterNoTags) {
                noTagsFilterBtn.style.opacity = '0.6';
            }
            noTagsFilterBtn.style.background = 'none';
        });
        noTagsFilterBtn.addEventListener('click', () => {
            this.tagFilterNoTags = !this.tagFilterNoTags;
            noTagsFilterBtn.style.color = this.tagFilterNoTags ? '#4CAF50' : '#9ca3af';
            noTagsFilterBtn.style.opacity = this.tagFilterNoTags ? '1' : '0.6';
            this.updateTagFilterUI();
            this.updateSessionSidebar();
        });

        // å±•å¼€/æ”¶èµ·æŒ‰é’®ï¼ˆç±»ä¼¼ç­›é€‰æ— æ ‡ç­¾æŒ‰é’®çš„æ ·å¼ï¼‰
        const expandToggleBtn = document.createElement('button');
        expandToggleBtn.className = 'tag-filter-expand-btn';
        expandToggleBtn.title = 'å±•å¼€æ ‡ç­¾';
        expandToggleBtn.innerHTML = 'â–¼';
        expandToggleBtn.style.cssText = `
            font-size: 10px !important;
            color: #9ca3af !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            line-height: 1 !important;
            opacity: 0.6 !important;
            display: none !important;
        `;
        expandToggleBtn.addEventListener('mouseenter', () => {
            expandToggleBtn.style.opacity = '1';
            expandToggleBtn.style.background = '#f3f4f6';
        });
        expandToggleBtn.addEventListener('mouseleave', () => {
            expandToggleBtn.style.opacity = '0.6';
            expandToggleBtn.style.background = 'none';
        });
        expandToggleBtn.addEventListener('click', () => {
            this.tagFilterExpanded = !this.tagFilterExpanded;
            this.updateTagFilterUI();
        });

        // æ¸…é™¤æŒ‰é’®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const clearFilterBtn = document.createElement('button');
        clearFilterBtn.className = 'tag-filter-clear';
        clearFilterBtn.textContent = 'Ã—';
        clearFilterBtn.title = 'æ¸…é™¤ç­›é€‰';
        clearFilterBtn.style.cssText = `
            font-size: 16px !important;
            color: #9ca3af !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 0 !important;
            width: 18px !important;
            height: 18px !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 3px !important;
            transition: all 0.2s ease !important;
            opacity: 0.6 !important;
        `;
        clearFilterBtn.addEventListener('mouseenter', () => {
            const hasSelectedTags = this.selectedFilterTags && this.selectedFilterTags.length > 0;
            const hasSearchKeyword = this.tagFilterSearchKeyword && this.tagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.tagFilterNoTags || hasSearchKeyword;
            if (hasActiveFilter) {
                clearFilterBtn.style.color = '#ef4444';
                clearFilterBtn.style.opacity = '1';
                clearFilterBtn.style.background = '#fee2e2';
            } else {
                clearFilterBtn.style.opacity = '0.4';
            }
        });
        clearFilterBtn.addEventListener('mouseleave', () => {
            const hasSelectedTags = this.selectedFilterTags && this.selectedFilterTags.length > 0;
            const hasSearchKeyword = this.tagFilterSearchKeyword && this.tagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.tagFilterNoTags || hasSearchKeyword;
            clearFilterBtn.style.color = '#9ca3af';
            clearFilterBtn.style.opacity = hasActiveFilter ? '0.8' : '0.4';
            clearFilterBtn.style.background = 'none';
        });
        clearFilterBtn.addEventListener('click', () => {
            const hasSelectedTags = this.selectedFilterTags && this.selectedFilterTags.length > 0;
            const hasSearchKeyword = this.tagFilterSearchKeyword && this.tagFilterSearchKeyword.trim() !== '';
            const hasActiveFilter = hasSelectedTags || this.tagFilterNoTags || hasSearchKeyword;
            if (hasActiveFilter) {
                this.selectedFilterTags = [];
                this.tagFilterNoTags = false;
                this.tagFilterSearchKeyword = '';
                // æ›´æ–°æœç´¢è¾“å…¥æ¡†çš„å€¼å’Œæ¸…é™¤æŒ‰é’®çŠ¶æ€
                const tagSearchInput = this.sessionSidebar.querySelector('.tag-filter-search');
                const tagSearchClearBtn = this.sessionSidebar.querySelector('.tag-filter-search-clear');
                if (tagSearchInput) {
                    tagSearchInput.value = '';
                }
                if (tagSearchClearBtn) {
                    tagSearchClearBtn.style.display = 'none';
                }
                const tagSearchIcon = this.sessionSidebar.querySelector('.tag-filter-search-container span');
                if (tagSearchIcon && tagSearchIcon.textContent === 'ğŸ”') {
                    tagSearchIcon.style.opacity = '0.5';
                }
                this.updateTagFilterUI();
                this.updateSessionSidebar();
            }
        });

        filterActions.appendChild(reverseFilterBtn);
        filterActions.appendChild(noTagsFilterBtn);
        filterActions.appendChild(expandToggleBtn);
        filterActions.appendChild(clearFilterBtn);

        // åˆ›å»ºæ ‡ç­¾æœç´¢è¾“å…¥æ¡†å®¹å™¨ï¼ˆå¸¦å›¾æ ‡å’Œæ¸…é™¤æŒ‰é’®ï¼‰
        const tagSearchContainer = document.createElement('div');
        tagSearchContainer.className = 'tag-filter-search-container';
        tagSearchContainer.style.cssText = `
            position: relative !important;
            flex: 1 !important;
            display: flex !important;
            align-items: center !important;
        `;

        // æœç´¢å›¾æ ‡
        const tagSearchIcon = document.createElement('span');
        tagSearchIcon.textContent = 'ğŸ”';
        tagSearchIcon.style.cssText = `
            position: absolute !important;
            left: 8px !important;
            font-size: 12px !important;
            pointer-events: none !important;
            z-index: 1 !important;
            opacity: 0.5 !important;
            transition: opacity 0.2s ease !important;
        `;

        // æ ‡ç­¾æœç´¢è¾“å…¥æ¡†
        const tagSearchInput = document.createElement('input');
        tagSearchInput.className = 'tag-filter-search';
        tagSearchInput.type = 'text';
        tagSearchInput.placeholder = 'æœç´¢æ ‡ç­¾...';
        tagSearchInput.value = this.tagFilterSearchKeyword || '';
        tagSearchInput.style.cssText = `
            width: 100% !important;
            font-weight: 400 !important;
            font-size: 12px !important;
            color: #374151 !important;
            padding: 4px 24px 4px 24px !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 6px !important;
            background: #ffffff !important;
            outline: none !important;
            transition: all 0.2s ease !important;
            box-sizing: border-box !important;
            height: 24px !important;
        `;

        // æ·»åŠ å ä½ç¬¦æ ·å¼
        if (!document.getElementById('tag-search-placeholder-style')) {
            const style = document.createElement('style');
            style.id = 'tag-search-placeholder-style';
            style.textContent = `
                .tag-filter-search::placeholder {
                    color: #9ca3af !important;
                    opacity: 1 !important;
                }
                .tag-filter-search:focus::placeholder {
                    color: #d1d5db !important;
                }
            `;
            document.head.appendChild(style);
        }

        // æ¸…é™¤æŒ‰é’®ï¼ˆä½äºè¾“å…¥æ¡†å³ä¾§ï¼‰
        const tagSearchClearBtn = document.createElement('button');
        tagSearchClearBtn.innerHTML = 'âœ•';
        tagSearchClearBtn.type = 'button';
        tagSearchClearBtn.className = 'tag-filter-search-clear';
        tagSearchClearBtn.style.cssText = `
            position: absolute !important;
            right: 4px !important;
            width: 16px !important;
            height: 16px !important;
            border: none !important;
            background: #e5e7eb !important;
            color: #6b7280 !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            padding: 0 !important;
            transition: all 0.2s ease !important;
            z-index: 2 !important;
            line-height: 1 !important;
        `;

        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        const updateTagSearchClearButton = () => {
            if (tagSearchInput.value.trim() !== '') {
                tagSearchClearBtn.style.display = 'flex';
                tagSearchIcon.style.opacity = '0.3';
            } else {
                tagSearchClearBtn.style.display = 'none';
                tagSearchIcon.style.opacity = '0.5';
            }
        };

        // åˆå§‹çŠ¶æ€
        updateTagSearchClearButton();

        // æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        tagSearchClearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            tagSearchInput.value = '';
            this.tagFilterSearchKeyword = '';
            updateTagSearchClearButton();
            this.updateTagFilterUI();
            tagSearchInput.focus();
        });

        // æ¸…é™¤æŒ‰é’®æ‚¬åœæ•ˆæœ
        tagSearchClearBtn.addEventListener('mouseenter', () => {
            tagSearchClearBtn.style.background = '#d1d5db';
            tagSearchClearBtn.style.transform = 'scale(1.15)';
        });
        tagSearchClearBtn.addEventListener('mouseleave', () => {
            tagSearchClearBtn.style.background = '#e5e7eb';
            tagSearchClearBtn.style.transform = 'scale(1)';
        });

        // è¾“å…¥æ¡†èšç„¦å’Œå¤±ç„¦æ ·å¼
        tagSearchInput.addEventListener('focus', () => {
            tagSearchInput.style.borderColor = mainColor;
            tagSearchInput.style.boxShadow = `0 0 0 2px ${mainColor}22`;
            tagSearchIcon.style.opacity = '0.7';
        });
        tagSearchInput.addEventListener('blur', () => {
            tagSearchInput.style.borderColor = '#e5e7eb';
            tagSearchInput.style.boxShadow = 'none';
            tagSearchIcon.style.opacity = tagSearchInput.value.trim() !== '' ? '0.3' : '0.5';
        });

        // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶è¿‡æ»¤æ ‡ç­¾ï¼ˆæ·»åŠ é˜²æŠ–ï¼‰
        let tagSearchDebounceTimer = null;
        tagSearchInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            this.tagFilterSearchKeyword = value;
            updateTagSearchClearButton();
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (tagSearchDebounceTimer) {
                clearTimeout(tagSearchDebounceTimer);
            }
            
            // é˜²æŠ–å¤„ç†ï¼š300msåæ‰§è¡Œè¿‡æ»¤
            tagSearchDebounceTimer = setTimeout(() => {
                this.updateTagFilterUI();
            }, 300);
        });

        // é˜»æ­¢è¾“å…¥æ¡†äº‹ä»¶å†’æ³¡
        tagSearchInput.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // é”®ç›˜å¿«æ·é”®ï¼šESCæ¸…é™¤è¾“å…¥
        tagSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && tagSearchInput.value.trim() !== '') {
                tagSearchInput.value = '';
                this.tagFilterSearchKeyword = '';
                updateTagSearchClearButton();
                this.updateTagFilterUI();
                e.stopPropagation();
            }
        });

        // ç»„è£…æœç´¢å®¹å™¨
        tagSearchContainer.appendChild(tagSearchIcon);
        tagSearchContainer.appendChild(tagSearchInput);
        tagSearchContainer.appendChild(tagSearchClearBtn);

        // å°†æœç´¢å®¹å™¨å’Œæ“ä½œæŒ‰é’®æ·»åŠ åˆ°æ ‡é¢˜è¡Œ
        filterHeader.appendChild(tagSearchContainer);
        filterHeader.appendChild(filterActions);

        // æ ‡ç­¾åˆ—è¡¨å®¹å™¨
        const tagFilterList = document.createElement('div');
        tagFilterList.className = 'tag-filter-list';
        tagFilterList.style.cssText = `
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 4px !important;
            overflow: visible !important;
        `;

        tagFilterContainer.appendChild(filterHeader);
        tagFilterContainer.appendChild(tagFilterList);

        // åˆå§‹åŒ–æ ‡ç­¾è¿‡æ»¤å™¨çŠ¶æ€
        if (this.selectedFilterTags === undefined) {
            this.selectedFilterTags = [];
        }
        if (this.tagFilterReverse === undefined) {
            this.tagFilterReverse = false;
        }
        if (this.tagFilterExpanded === undefined) {
            this.tagFilterExpanded = false;
        }

        // åˆ›å»ºå…±åŒçš„æ»šåŠ¨å®¹å™¨ï¼ˆåŒ…å«æ ‡ç­¾åˆ—è¡¨å’Œä¼šè¯åˆ—è¡¨ï¼‰
        const scrollableContent = document.createElement('div');
        scrollableContent.className = 'session-sidebar-scrollable-content';
        scrollableContent.style.cssText = `
            flex: 1 !important;
            overflow-y: auto !important;
            display: flex !important;
            flex-direction: column !important;
            min-height: 0 !important;
        `;
        // éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½
        if (!document.getElementById('hide-scrollbar-style')) {
            const hideScrollbarStyle = document.createElement('style');
            hideScrollbarStyle.id = 'hide-scrollbar-style';
            hideScrollbarStyle.textContent = `
                .session-sidebar-scrollable-content::-webkit-scrollbar,
                .oss-file-list::-webkit-scrollbar,
                .news-list::-webkit-scrollbar,
                .api-request-list::-webkit-scrollbar {
                    display: none !important;
                    width: 0 !important;
                    height: 0 !important;
                }
                .session-sidebar-scrollable-content,
                .oss-file-list,
                .news-list,
                .api-request-list {
                    -ms-overflow-style: none !important;
                    scrollbar-width: none !important;
                }
            `;
            document.head.appendChild(hideScrollbarStyle);
        }

        // ä¼šè¯åˆ—è¡¨å®¹å™¨ï¼ˆç§»é™¤ç‹¬ç«‹æ»šåŠ¨ï¼‰
        const sessionList = document.createElement('div');
        sessionList.className = 'session-list';
        sessionList.style.cssText = `
            flex: 1 !important;
            overflow: visible !important;
            padding: 8px 8px 220px 8px !important;
            scroll-padding-bottom: 20px !important;
            box-sizing: border-box !important;
        `;

        // æ·»åŠ ä¼šè¯åˆ—è¡¨æ ·å¼
        if (!document.getElementById('session-sidebar-styles')) {
            const style = document.createElement('style');
            style.id = 'session-sidebar-styles';
            style.textContent = `
                .session-item {
                    padding: 12px !important;
                    margin-bottom: 8px !important;
                    border-radius: 8px !important;
                    cursor: pointer !important;
                    transition: all 0.2s ease !important;
                    position: relative !important;
                    user-select: none !important;
                }
                .session-item:hover:not(.switching):not(.active) {
                    background: #f9fafb !important;
                    border-color: #d1d5db !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
                }
                .session-item.active {
                    background: #eff6ff !important;
                    border-color: #3b82f6 !important;
                    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2) !important;
                }
                .session-item.clicked {
                    transform: scale(0.97) translateX(2px) !important;
                    background: ${mainColor}25 !important;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                }
                .session-item.switching {
                    cursor: wait !important;
                    opacity: 0.8 !important;
                    pointer-events: none !important;
                    position: relative !important;
                    background: ${mainColor}10 !important;
                    border-color: ${mainColor}40 !important;
                }
                .session-item.switching::after {
                    content: '' !important;
                    position: absolute !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    width: 16px !important;
                    height: 16px !important;
                    border: 2px solid ${mainColor} !important;
                    border-top-color: transparent !important;
                    border-radius: 50% !important;
                    animation: session-switching-spin 0.6s linear infinite !important;
                }
                @keyframes session-switching-spin {
                    0% { transform: translate(-50%, -50%) rotate(0deg) !important; }
                    100% { transform: translate(-50%, -50%) rotate(360deg) !important; }
                }
                .session-item.long-press-start {
                    background: rgba(244, 67, 54, 0.08) !important;
                    border-color: rgba(244, 67, 54, 0.3) !important;
                    transform: scale(0.99) !important;
                    transition: all 0.2s ease !important;
                }
                .session-item.long-press-stage-1 {
                    background: rgba(244, 67, 54, 0.12) !important;
                    border-color: rgba(244, 67, 54, 0.4) !important;
                    transform: scale(0.985) !important;
                    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2) !important;
                }
                .session-item.long-press-stage-2 {
                    background: rgba(244, 67, 54, 0.18) !important;
                    border-color: rgba(244, 67, 54, 0.6) !important;
                    transform: scale(0.975) !important;
                    box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3) !important;
                }
                .session-item.long-press-stage-3 {
                    background: rgba(244, 67, 54, 0.22) !important;
                    border-color: rgba(244, 67, 54, 0.7) !important;
                    transform: scale(0.97) !important;
                    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4) !important;
                }
                .session-item.long-pressing {
                    background: rgba(244, 67, 54, 0.25) !important;
                    border-color: rgba(244, 67, 54, 0.8) !important;
                    transform: scale(0.96) !important;
                    box-shadow: 0 6px 16px rgba(244, 67, 54, 0.5) !important;
                    animation: long-press-pulse 0.6s ease-in-out infinite !important;
                }
                @keyframes long-press-pulse {
                    0%, 100% {
                        box-shadow: 0 6px 16px rgba(244, 67, 54, 0.5) !important;
                    }
                    50% {
                        box-shadow: 0 6px 20px rgba(244, 67, 54, 0.7) !important;
                    }
                }
                .session-title {
                    font-size: 13px !important;
                    font-weight: 500 !important;
                    color: #374151 !important;
                    margin-bottom: 4px !important;
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                    white-space: nowrap !important;
                    max-width: 100% !important;
                }
                .session-item.active .session-title {
                    color: ${mainColor} !important;
                    font-weight: 600 !important;
                }
                .session-meta {
                    font-size: 11px !important;
                    color: #9ca3af !important;
                }
                .session-item.active .session-meta {
                    color: ${mainColor} !important;
                }
                .session-item.new-session-highlight {
                    animation: new-session-highlight 1.5s ease-out !important;
                }
                @keyframes new-session-highlight {
                    0% {
                        background: ${mainColor}30 !important;
                        transform: scale(1.02) !important;
                    }
                    50% {
                        background: ${mainColor}20 !important;
                    }
                    100% {
                        background: ${mainColor}15 !important;
                        transform: scale(1) !important;
                    }
                }
                .session-list .session-item:last-child {
                    margin-bottom: 0 !important;
                }
                .session-list::after {
                    content: '' !important;
                    display: block !important;
                    height: 20px !important;
                    flex-shrink: 0 !important;
                }
                .oss-file-item.switching {
                    cursor: wait !important;
                    opacity: 0.8 !important;
                    pointer-events: none !important;
                    position: relative !important;
                    background: ${mainColor}10 !important;
                    border-color: ${mainColor}40 !important;
                }
                .oss-file-item.switching::after {
                    content: '' !important;
                    position: absolute !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    width: 16px !important;
                    height: 16px !important;
                    border: 2px solid ${mainColor} !important;
                    border-top-color: transparent !important;
                    border-radius: 50% !important;
                    animation: oss-file-switching-spin 0.6s linear infinite !important;
                }
                @keyframes oss-file-switching-spin {
                    0% { transform: translate(-50%, -50%) rotate(0deg) !important; }
                    100% { transform: translate(-50%, -50%) rotate(360deg) !important; }
                }
            `;
            document.head.appendChild(style);
        }

        this.sessionSidebar.appendChild(sidebarHeader);
        // å°†æ ‡ç­¾åˆ—è¡¨å’Œä¼šè¯åˆ—è¡¨éƒ½æ”¾å…¥æ»šåŠ¨å®¹å™¨
        scrollableContent.appendChild(tagFilterContainer);
        scrollableContent.appendChild(sessionList);
        this.sessionSidebar.appendChild(scrollableContent);
        
        // åœ¨æ‰€æœ‰å†…å®¹æ·»åŠ å®Œæˆåï¼Œåˆ›å»ºæ‹–æ‹½è°ƒæ•´è¾¹æ¡†ï¼ˆç¡®ä¿åœ¨æœ€ä¸Šå±‚ï¼‰
        this.createSidebarResizer();

        // åˆ›å»ºæ¶ˆæ¯åŒºåŸŸ
        const messagesContainer = document.createElement('div');
        messagesContainer.id = 'pet-chat-messages';
        messagesContainer.style.cssText = `
            flex: 1 !important;
            padding: 20px !important;
            padding-bottom: 160px !important;
            overflow-y: auto !important;
            background: linear-gradient(135deg, #f8f9fa, #ffffff) !important;
            position: relative !important;
            min-height: 200px !important;
            user-select: text !important;
        `;

        // å°†ä¾§è¾¹æ å’Œæ¶ˆæ¯åŒºåŸŸæ·»åŠ åˆ°ä¸»å®¹å™¨
        mainContentContainer.appendChild(this.sessionSidebar);
        mainContentContainer.appendChild(messagesContainer);
        
        // å°†ä¾§è¾¹æ æŠ˜å æŒ‰é’®æ·»åŠ åˆ°ä¸»å®¹å™¨ï¼ˆå®šä½åœ¨ä¾§è¾¹æ å³ä¾§ï¼‰
        // ç¡®ä¿æŒ‰é’®å­˜åœ¨ï¼šå¦‚æœæ‰¾ä¸åˆ°ï¼Œä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„æŒ‰é’®å˜é‡
        if (!toggleSidebarBtn) {
            toggleSidebarBtn = this.chatWindow.querySelector('#sidebar-toggle-btn');
        }
        if (toggleSidebarBtn && mainContentContainer) {
            // æ›´æ–°æŒ‰é’®å®šä½å‡½æ•°ï¼ˆå‚è€ƒè¾“å…¥æ¡†æŠ˜å æŒ‰é’®çš„å®ç°æ–¹å¼ï¼‰
            const updateSidebarToggleBtnPosition = () => {
                // æ ¹æ®æŠ˜å çŠ¶æ€è®¾ç½®æŒ‰é’®ä½ç½®ï¼šæŠ˜å æ—¶åœ¨å·¦ä¾§è¾¹ç¼˜ï¼Œå±•å¼€æ—¶åœ¨ä¾§è¾¹æ å³è¾¹ç¼˜
                // ä½¿ç”¨ translateX(14px) è®©æŒ‰é’®å®Œå…¨åœ¨ä¾§è¾¹æ å¤–é¢
                const buttonLeft = this.sidebarCollapsed ? '0px' : `${this.sidebarWidth}px`;
                toggleSidebarBtn.style.left = buttonLeft;
            };
            
            // è®¾ç½®æŒ‰é’®åŸºç¡€æ ·å¼ï¼ˆå‚è€ƒè¾“å…¥æ¡†æŠ˜å æŒ‰é’®ï¼‰
            toggleSidebarBtn.style.cssText = `
                position: absolute !important;
                top: 50% !important;
                transform: translateY(-50%) translateX(14px) !important;
                background: rgba(255, 255, 255, 0.9) !important;
                border: 1px solid #e5e7eb !important;
                color: #374151 !important;
                font-size: 14px !important;
                cursor: pointer !important;
                padding: 0 !important;
                border-radius: 50% !important;
                width: 28px !important;
                height: 28px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                transition: all 0.3s ease !important;
                z-index: 10001 !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            `;
            
            // ç¡®ä¿æŒ‰é’®æ²¡æœ‰è¢«é‡å¤æ·»åŠ 
            if (!toggleSidebarBtn.parentNode) {
                mainContentContainer.appendChild(toggleSidebarBtn);
            } else if (toggleSidebarBtn.parentNode !== mainContentContainer) {
                // å¦‚æœæŒ‰é’®åœ¨å…¶ä»–ä½ç½®ï¼Œå…ˆç§»é™¤å†æ·»åŠ 
                toggleSidebarBtn.parentNode.removeChild(toggleSidebarBtn);
                mainContentContainer.appendChild(toggleSidebarBtn);
            }
            
            // å»¶è¿Ÿæ›´æ–°ä½ç½®ï¼Œç¡®ä¿ä¾§è¾¹æ å·²æ¸²æŸ“
            setTimeout(() => {
                updateSidebarToggleBtnPosition();
            }, 100);
            
            // ç›‘å¬ä¾§è¾¹æ å®½åº¦å˜åŒ–ï¼ˆä½¿ç”¨ResizeObserverï¼‰
            if (window.ResizeObserver && this.sessionSidebar) {
                const resizeObserver = new ResizeObserver(() => {
                    updateSidebarToggleBtnPosition();
                });
                resizeObserver.observe(this.sessionSidebar);
            }
        }
        
        // åº”ç”¨ä¾§è¾¹æ æŠ˜å çŠ¶æ€
        this.applySidebarCollapsedState();
        
        // æ›´æ–°æŠ˜å æŒ‰é’®å›¾æ ‡ï¼ˆæ ¹æ®å½“å‰çŠ¶æ€ï¼‰
        if (toggleSidebarBtn) {
            const icon = toggleSidebarBtn.querySelector('.toggle-icon');
            if (icon) {
                icon.textContent = this.sidebarCollapsed ? 'â–¶' : 'â—€';
            }
            toggleSidebarBtn.title = this.sidebarCollapsed ? 'å±•å¼€ä¾§è¾¹æ ' : 'æŠ˜å ä¾§è¾¹æ ';
        }

        // ç»Ÿä¸€çš„ AbortControllerï¼Œç”¨äºç»ˆæ­¢æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
        let currentAbortController = null;

        // åŠ¨æ€æ›´æ–°åº•éƒ¨paddingï¼Œç¡®ä¿å†…å®¹ä¸è¢«è¾“å…¥æ¡†é®ä½
        const updatePaddingBottom = () => {
            if (!this.chatWindow) return;
            const inputContainer = this.chatWindow.querySelector('.chat-input-container');
            const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
            if (inputContainer && messagesContainer) {
                const inputHeight = inputContainer.offsetHeight || 160;
                // æ·»åŠ é¢å¤–20pxçš„ç¼“å†²ç©ºé—´
                messagesContainer.style.paddingBottom = (inputHeight + 20) + 'px';
            }
        };

        // åˆå§‹åŒ–æŒ‰é’®ç›¸å…³çš„å¯¹è±¡ï¼ˆä¿ç•™ä»¥é¿å…å…¶ä»–åœ°æ–¹å‡ºé”™ï¼‰
        this.actionIcons = {};
        this.buttonHandlers = {};

        // åˆ›å»ºæ¬¢è¿æ¶ˆæ¯ï¼ˆä½¿ç”¨ç»Ÿä¸€æ–¹æ³•ï¼‰
        const welcomeMessage = await this.createWelcomeMessage(messagesContainer);

        // å°†æŒ‰é’®æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨ä¸­ï¼Œå’Œæ—¶é—´æˆ³åŒä¸€è¡Œ
        setTimeout(() => {
            const messageTime = welcomeMessage?.querySelector('[data-message-time="true"]');
            if (messageTime) {
                // ä¿®æ”¹æ—¶é—´æˆ³å®¹å™¨ä¸º flex å¸ƒå±€
                messageTime.style.cssText = `
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                    font-size: 11px !important;
                    color: #999 !important;
                    margin-top: 4px !important;
                    max-width: 100% !important;
                    width: 100% !important;
                `;

                // åˆ›å»ºæ—¶é—´æ–‡æœ¬å®¹å™¨
                const timeText = document.createElement('span');
                timeText.style.cssText = 'flex: 1 !important; min-width: 0 !important;';
                timeText.textContent = this.getCurrentTime();

                // å°†åŸæœ‰å†…å®¹æ›¿æ¢ä¸º flex å¸ƒå±€çš„å†…å®¹
                messageTime.innerHTML = '';
                messageTime.appendChild(timeText);
                const actionsGroup = document.createElement('div');
                actionsGroup.id = 'pet-welcome-actions';
                actionsGroup.style.cssText = `
                    display: inline-flex !important;
                    align-items: center !important;
                    gap: 8px !important;
                    flex-shrink: 0 !important;
                `;

                // æŠŠ actionsGroup æ”¾åˆ°ä¸€ä¸ªç›¸å¯¹å®šä½å®¹å™¨é‡Œï¼Œä»¥ä¾¿èœå•å®šä½
                const actionsWrapper = document.createElement('div');
                actionsWrapper.style.cssText = `
                    position: relative !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    gap: 8px !important;
                `;

                actionsWrapper.appendChild(actionsGroup);
                messageTime.appendChild(actionsWrapper);
                
                // æ ¹æ®è§’è‰²è®¾ç½®åŠ¨æ€åˆ›å»ºæŒ‰é’®ï¼ˆä¸è§’è‰²è®¾ç½®åˆ—è¡¨ä¿æŒä¸€è‡´ï¼‰
                // refreshWelcomeActionButtons() ä¼šä»è§’è‰²é…ç½®ä¸­è·å–åˆ—è¡¨ï¼Œå¹¶ç¡®ä¿è®¾ç½®æŒ‰é’®å§‹ç»ˆåœ¨æœ€å
                this.refreshWelcomeActionButtons();
            }
        }, 100);

        // æ’­æ”¾å® ç‰©æ¬¢è¿åŠ¨ç”»
        this.playChatAnimation();

        // åˆ›å»ºè¾“å…¥åŒºåŸŸ - ä½¿ç”¨å® ç‰©é¢œè‰²ä¸»é¢˜
        const inputContainer = document.createElement('div');
        inputContainer.className = 'chat-input-container';
        inputContainer.style.cssText = `
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            padding: 20px !important;
            background: white !important;
            border-top: 1px solid #e5e7eb !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
            border-radius: 0 !important;
            z-index: ${PET_CONFIG.ui.zIndex.inputContainer} !important;
        `;

        // åˆ›å»ºé¡¶éƒ¨å·¥å…·æ ï¼ˆå·¦ä¾§æŒ‰é’®å’Œå³ä¾§çŠ¶æ€ï¼‰
        const topToolbar = document.createElement('div');
        topToolbar.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 8px !important;
        `;

        // å·¦ä¾§æŒ‰é’®ç»„
        const inputLeftButtonGroup = document.createElement('div');
        inputLeftButtonGroup.style.cssText = `
            display: flex !important;
            gap: 6px !important;
            align-items: center !important;
        `;

        // åˆ›å»º @ æŒ‰é’®ï¼ˆä½¿ç”¨å® ç‰©é¢œè‰²ä¸»é¢˜ï¼‰
        const mentionButton = document.createElement('button');
        mentionButton.innerHTML = '@';
        mentionButton.title = 'æåŠ';
        mentionButton.style.cssText = `
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            background: white !important;
            color: ${mainColor} !important;
            border: 1px solid ${mainColor} !important;
            cursor: pointer !important;
            font-size: 16px !important;
            font-weight: 500 !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        `;
        mentionButton.addEventListener('mouseenter', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            mentionButton.style.background = currentMainColor;
            mentionButton.style.color = 'white';
            mentionButton.style.borderColor = currentMainColor;
        });
        mentionButton.addEventListener('mouseleave', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            mentionButton.style.background = 'white';
            mentionButton.style.color = currentMainColor;
            mentionButton.style.borderColor = currentMainColor;
        });

        // åˆ›å»ºå›¾ç‰‡ä¸Šä¼ æŒ‰é’®ï¼ˆä½¿ç”¨å® ç‰©é¢œè‰²ä¸»é¢˜ï¼‰
        const imageUploadButton = document.createElement('button');
        imageUploadButton.innerHTML = 'ğŸ“·';
        imageUploadButton.className = 'chat-image-upload-button';
        imageUploadButton.title = 'ä¸Šä¼ å›¾ç‰‡';
        imageUploadButton.style.cssText = `
            width: 32px !important;
            height: 32px !important;
            border-radius: 6px !important;
            background: white !important;
            color: ${mainColor} !important;
            border: 1px solid ${mainColor} !important;
            cursor: pointer !important;
            font-size: 16px !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        `;

        imageUploadButton.addEventListener('mouseenter', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            imageUploadButton.style.background = currentMainColor;
            imageUploadButton.style.color = 'white';
            imageUploadButton.style.borderColor = currentMainColor;
        });
        imageUploadButton.addEventListener('mouseleave', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            imageUploadButton.style.background = 'white';
            imageUploadButton.style.color = currentMainColor;
            imageUploadButton.style.borderColor = currentMainColor;
        });

        // åˆ›å»ºéšè—çš„æ–‡ä»¶è¾“å…¥
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageDataUrl = event.target.result;
                    this.sendImageMessage(imageDataUrl);
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        });

        imageUploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        // å³ä¾§çŠ¶æ€ç»„
        const rightStatusGroup = document.createElement('div');
        rightStatusGroup.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            align-items: center !important;
        `;

        // åˆ›å»ºé¡µé¢ä¸Šä¸‹æ–‡å¼€å…³ï¼ˆæ‰å¹³åŒ–ç®€çº¦è®¾è®¡ï¼‰
        const contextSwitchContainer = document.createElement('div');
        contextSwitchContainer.className = 'context-switch-container';
        contextSwitchContainer.style.cssText = `
            display: inline-flex !important;
            align-items: center !important;
            gap: 10px !important;
            padding: 4px 0 !important;
            cursor: pointer !important;
            user-select: none !important;
            transition: opacity 0.2s ease !important;
        `;
        contextSwitchContainer.title = 'å¼€å¯/å…³é—­é¡µé¢ä¸Šä¸‹æ–‡ï¼Œå¸®åŠ©AIç†è§£å½“å‰é¡µé¢å†…å®¹';

        // åˆ›å»ºæ ‡ç­¾ï¼ˆç®€çº¦å­—ä½“ï¼‰
        const contextSwitchLabel = document.createElement('span');
        contextSwitchLabel.textContent = 'é¡µé¢ä¸Šä¸‹æ–‡';
        contextSwitchLabel.style.cssText = `
            font-size: 12px !important;
            font-weight: 400 !important;
            color: #64748b !important;
            white-space: nowrap !important;
            transition: color 0.2s ease !important;
            letter-spacing: 0.3px !important;
        `;

        // åˆ›å»ºæ‰å¹³åŒ–å¼€å…³å®¹å™¨
        const switchWrapper = document.createElement('div');
        switchWrapper.style.cssText = `
            position: relative !important;
            width: 40px !important;
            height: 20px !important;
            border-radius: 10px !important;
            background: #cbd5e1 !important;
            transition: background-color 0.2s ease !important;
            cursor: pointer !important;
        `;

        // åˆ›å»ºæ‰å¹³åŒ–å¼€å…³æ»‘å—
        const switchThumb = document.createElement('div');
        switchThumb.style.cssText = `
            position: absolute !important;
            top: 2px !important;
            left: 2px !important;
            width: 16px !important;
            height: 16px !important;
            border-radius: 50% !important;
            background: #ffffff !important;
            transition: transform 0.2s ease !important;
            transform: translateX(0) !important;
        `;

        // éšè—åŸç”Ÿcheckboxï¼Œä½†ä¿ç•™åŠŸèƒ½
        const contextSwitch = document.createElement('input');
        contextSwitch.type = 'checkbox';
        contextSwitch.id = 'context-switch';
        contextSwitch.checked = true; // é»˜è®¤å¼€å¯
        contextSwitch.style.cssText = `
            position: absolute !important;
            opacity: 0 !important;
            width: 0 !important;
            height: 0 !important;
            margin: 0 !important;
            pointer-events: none !important;
        `;

        // æ›´æ–°å¼€å…³çŠ¶æ€çš„å‡½æ•°ï¼ˆæ‰å¹³åŒ–é£æ ¼ï¼‰
        const updateSwitchState = (isChecked) => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            if (isChecked) {
                switchWrapper.style.background = currentMainColor;
                switchThumb.style.transform = 'translateX(20px)';
                contextSwitchLabel.style.color = currentMainColor;
            } else {
                switchWrapper.style.background = '#cbd5e1';
                switchThumb.style.transform = 'translateX(0)';
                contextSwitchLabel.style.color = '#64748b';
            }
        };

        // åˆå§‹çŠ¶æ€
        updateSwitchState(contextSwitch.checked);

        // ç»„è£…å¼€å…³
        switchWrapper.appendChild(switchThumb);
        contextSwitchContainer.appendChild(contextSwitchLabel);
        contextSwitchContainer.appendChild(switchWrapper);
        contextSwitchContainer.appendChild(contextSwitch);

        // ç®€çº¦æ‚¬åœæ•ˆæœï¼ˆæ‰å¹³åŒ–ï¼‰
        contextSwitchContainer.addEventListener('mouseenter', () => {
            contextSwitchContainer.style.opacity = '0.8';
        });

        contextSwitchContainer.addEventListener('mouseleave', () => {
            contextSwitchContainer.style.opacity = '1';
        });

        // ç‚¹å‡»æ•´ä¸ªå®¹å™¨åˆ‡æ¢å¼€å…³
        contextSwitchContainer.addEventListener('click', (e) => {
            e.stopPropagation();
            contextSwitch.checked = !contextSwitch.checked;
            updateSwitchState(contextSwitch.checked);
            contextSwitch.dispatchEvent(new Event('change'));
        });

        // ä»å­˜å‚¨ä¸­è¯»å–å¼€å…³çŠ¶æ€
        chrome.storage.local.get(['contextSwitchEnabled'], (result) => {
            if (result.contextSwitchEnabled !== undefined) {
                contextSwitch.checked = result.contextSwitchEnabled;
                updateSwitchState(contextSwitch.checked);
            }
        });

        // ç›‘å¬å¼€å…³çŠ¶æ€å˜åŒ–å¹¶ä¿å­˜
        contextSwitch.addEventListener('change', () => {
            updateSwitchState(contextSwitch.checked);
            chrome.storage.local.set({ contextSwitchEnabled: contextSwitch.checked });
        });

        // ç›‘å¬é¢œè‰²å˜åŒ–ï¼Œæ›´æ–°å¼€å…³é¢œè‰²
        const updateSwitchColor = () => {
            if (contextSwitch.checked) {
                updateSwitchState(true);
            }
        };
        
        // å­˜å‚¨æ›´æ–°å‡½æ•°ä»¥ä¾¿åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨
        contextSwitchContainer.updateColor = updateSwitchColor;

        inputLeftButtonGroup.appendChild(mentionButton);
        inputLeftButtonGroup.appendChild(imageUploadButton);
        rightStatusGroup.appendChild(contextSwitchContainer);
        
        // æ·»åŠ ï¼šé¡µé¢ä¸Šä¸‹æ–‡é¢„è§ˆ/ç¼–è¾‘æŒ‰é’®
        const contextBtn = document.createElement('button');
        contextBtn.className = 'chat-toolbar-btn';
        contextBtn.setAttribute('title', 'é¢„è§ˆ/ç¼–è¾‘é¡µé¢ä¸Šä¸‹æ–‡');
        contextBtn.textContent = 'ğŸ“ ä¸Šä¸‹æ–‡';
        contextBtn.style.cssText = `
            padding: 6px 10px !important;
            border-radius: 6px !important;
            background: white !important;
            color: ${mainColor} !important;
            border: 1px solid ${mainColor} !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 500 !important;
        `;
        contextBtn.addEventListener('mouseenter', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            contextBtn.style.background = currentMainColor;
            contextBtn.style.color = 'white';
            contextBtn.style.borderColor = currentMainColor;
        });
        contextBtn.addEventListener('mouseleave', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            contextBtn.style.background = 'white';
            contextBtn.style.color = currentMainColor;
            contextBtn.style.borderColor = currentMainColor;
        });
        contextBtn.addEventListener('click', () => this.openContextEditor());
        inputLeftButtonGroup.appendChild(contextBtn);

        // ===== åˆ›å»ºå¸¸è§é—®é¢˜æŒ‰é’® =====
        const faqBtn = document.createElement('button');
        faqBtn.innerHTML = 'ğŸ’¡ å¸¸è§é—®é¢˜';
        faqBtn.title = 'å¸¸è§é—®é¢˜';
        faqBtn.style.cssText = `
            padding: 6px 10px !important;
            border-radius: 6px !important;
            background: white !important;
            color: ${mainColor} !important;
            border: 1px solid ${mainColor} !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
            transition: all 0.2s ease !important;
        `;

        faqBtn.addEventListener('mouseenter', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            faqBtn.style.background = currentMainColor;
            faqBtn.style.color = 'white';
            faqBtn.style.borderColor = currentMainColor;
        });

        faqBtn.addEventListener('mouseleave', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            faqBtn.style.background = 'white';
            faqBtn.style.color = currentMainColor;
            faqBtn.style.borderColor = currentMainColor;
        });

        faqBtn.addEventListener('click', () => this.openFaqManager());
        inputLeftButtonGroup.appendChild(faqBtn);
        // å·²ç§»é™¤è‡ªå®šä¹‰è§’è‰²å¿«æ·å…¥å£

        topToolbar.appendChild(inputLeftButtonGroup);
        topToolbar.appendChild(rightStatusGroup);
        inputContainer.appendChild(topToolbar);
        // ===== å¸¸è§é—®é¢˜æŒ‰é’®ç»“æŸ =====

        // åˆ›å»ºè¾“å…¥æ¡†å®¹å™¨ï¼ˆæš—è‰²ä¸»é¢˜ï¼‰
        const inputWrapper = document.createElement('div');
        inputWrapper.style.cssText = `
            display: flex !important;
            gap: 8px !important;
            align-items: flex-end !important;
            position: relative !important;
            width: 100% !important;
        `;

        const messageInput = document.createElement('textarea');
        messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯... (Enterå‘é€, Shift+Enteræ¢è¡Œ)';
        messageInput.maxLength = PET_CONFIG.chatWindow.input.maxLength;
        messageInput.className = 'chat-message-input';
        messageInput.rows = 2; // åˆå§‹2è¡Œ
        messageInput.style.cssText = `
            flex: 1 !important;
            width: 100% !important;
            padding: 12px 16px !important;
            border: 2px solid ${mainColor} !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-weight: 400 !important;
            color: #1f2937 !important;
            background: #f9fafb !important;
            outline: none !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            resize: none !important;
            min-height: 60px !important;
            max-height: 200px !important;
            overflow-y: auto !important;
            line-height: 1.5 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        `;


        // è®¾ç½®placeholderå’Œæ»šåŠ¨æ¡æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .chat-message-input::placeholder {
                color: #888888 !important;
                opacity: 1 !important;
                font-size: 14px !important;
                font-weight: 400 !important;
            }
            .chat-message-input::-webkit-input-placeholder {
                color: #9ca3af !important;
                opacity: 1 !important;
                font-size: 14px !important;
            }
            .chat-message-input::-moz-placeholder {
                color: #9ca3af !important;
                opacity: 1 !important;
                font-size: 14px !important;
            }
            .chat-message-input:-ms-input-placeholder {
                color: #9ca3af !important;
                opacity: 1 !important;
                font-size: 14px !important;
            }
            .chat-message-input::-webkit-scrollbar {
                width: 4px !important;
            }
            .chat-message-input::-webkit-scrollbar-track {
                background: #1e1e1e !important;
            }
            .chat-message-input::-webkit-scrollbar-thumb {
                background: #555555 !important;
                border-radius: 2px !important;
            }
            .chat-message-input::-webkit-scrollbar-thumb:hover {
                background: #666666 !important;
            }
        `;
        document.head.appendChild(style);

        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦å’Œè¾“å…¥æ—¶çš„è§†è§‰åé¦ˆ
        const updateInputState = () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            const hasContent = messageInput.value.trim().length > 0;
            if (hasContent) {
                messageInput.style.borderColor = currentMainColor;
                messageInput.style.background = '#ffffff';
            } else {
                messageInput.style.borderColor = currentMainColor;
                messageInput.style.background = '#f9fafb';
            }
        };

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            const newHeight = Math.max(60, messageInput.scrollHeight);
            messageInput.style.height = newHeight + 'px';
            updateInputState();
            // æ›´æ–°æ¶ˆæ¯å®¹å™¨çš„åº•éƒ¨padding
            setTimeout(() => {
                const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
                if (inputContainer && messagesContainer) {
                    const inputHeight = inputContainer.offsetHeight || 160;
                    messagesContainer.style.paddingBottom = (inputHeight + 20) + 'px';
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 0);
        });

        // å°†é¢œè‰²è½¬æ¢ä¸ºrgbaç”¨äºé˜´å½±
        const hexToRgba = (hex, alpha) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };
        const shadowColor = hexToRgba(mainColor, 0.1);

        messageInput.addEventListener('focus', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            messageInput.style.borderColor = currentMainColor;
            messageInput.style.background = '#ffffff';
            const currentShadowColor = currentMainColor.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(',');
            messageInput.style.boxShadow = `0 0 0 3px rgba(${currentShadowColor}, 0.1)`;
        });

        messageInput.addEventListener('blur', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            if (messageInput.value.length === 0) {
                messageInput.style.borderColor = currentMainColor;
                messageInput.style.background = '#f9fafb';
            }
            messageInput.style.boxShadow = 'none';
        });

        // æ·»åŠ ç²˜è´´å›¾ç‰‡æ”¯æŒ
        messageInput.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageDataUrl = event.target.result;
                        this.sendImageMessage(imageDataUrl);
                    };
                    reader.readAsDataURL(file);
                    break;
                }
            }
        });

        // å‘é€æ¶ˆæ¯åŠŸèƒ½ï¼ˆè°ƒç”¨ session/save æ¥å£ï¼‰
        const sendMessage = async () => {
            const message = messageInput.value.trim();
            if (!message) return;

            // ç¡®ä¿æœ‰å½“å‰ä¼šè¯ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œå…ˆåˆå§‹åŒ–ä¼šè¯ï¼‰
            if (!this.currentSessionId) {
                await this.initSession();
                // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜
                this.updateChatHeaderTitle();
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = this.createMessageElement(message, 'user');
            messagesContainer.appendChild(userMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ä¼šè¯ï¼ˆæ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ï¼Œä»…åœ¨ prompt æ¥å£è°ƒç”¨åä¿å­˜ï¼‰
            await this.addMessageToSession('user', message, null, false);
            
            // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ æ“ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬æœºå™¨äººæŒ‰é’®ï¼‰
            await this.addActionButtonsToMessage(userMessage);
            
            // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ é™¤ã€ç¼–è¾‘å’Œé‡æ–°å‘é€æŒ‰é’®
            const userBubble = userMessage.querySelector('[data-message-type="user-bubble"]');
            const copyButtonContainer = userMessage.querySelector('[data-copy-button-container]');
            if (copyButtonContainer && userBubble) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™äº›æŒ‰é’®ï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æŒ‰é’®ï¼‰
                if (!copyButtonContainer.querySelector('.delete-button')) {
                    this.addDeleteButtonForUserMessage(copyButtonContainer, userBubble);
                }
                // æ·»åŠ æ’åºæŒ‰é’®
                this.addSortButtons(copyButtonContainer, userMessage);
            }

            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
            messageInput.value = '';
            messageInput.style.height = '';
            // å¼ºåˆ¶é‡æ’ä»¥ç¡®ä¿é«˜åº¦è¢«æ­£ç¡®é‡ç½®
            void messageInput.offsetHeight;
            messageInput.style.height = '60px';

            // æ›´æ–°è¾“å…¥çŠ¶æ€
            updateInputState();

            // è°ƒç”¨ session/save ä¿å­˜ä¼šè¯åˆ°åç«¯
            try {
                // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
                await this.saveCurrentSession(false, false);
                
                // è°ƒç”¨ session/save æ¥å£ä¿å­˜ä¼šè¯
                if (this.currentSessionId && this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                    await this.syncSessionToBackend(this.currentSessionId, true);
                    console.log('ä¼šè¯å·²ä¿å­˜åˆ°åç«¯:', this.currentSessionId);
                } else {
                    console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šç¼ºå°‘ä¼šè¯IDã€APIç®¡ç†å™¨æˆ–åŒæ­¥é…ç½®');
                }
            } catch (error) {
                console.error('ä¿å­˜ä¼šè¯å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆå¯é€‰ï¼‰
                const errorMessage = this.createMessageElement('ä¿å­˜ä¼šè¯æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚ğŸ˜”', 'pet');
                messagesContainer.appendChild(errorMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // æ›´æ–°çŠ¶æ€ä¸ºç©ºé—²
            currentAbortController = null;
            if (this.chatWindow && this.chatWindow._setAbortController) {
                this.chatWindow._setAbortController(null);
            }
            if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                this.chatWindow._updateRequestStatus('idle');
            } else {
                updateRequestStatus('idle');
            }
        };

        // ä¸­æ–‡è¾“å…¥æ³•çŠ¶æ€è·Ÿè¸ª
        let isComposing = false;
        let compositionEndTime = 0;
        const COMPOSITION_END_DELAY = 100; // ç»„åˆè¾“å…¥ç»“æŸåå»¶è¿Ÿå¤„ç†å›è½¦é”®çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        
        // ç›‘å¬è¾“å…¥æ³•ç»„åˆå¼€å§‹äº‹ä»¶ï¼ˆä¸­æ–‡è¾“å…¥æ³•å¼€å§‹è¾“å…¥ï¼‰
        messageInput.addEventListener('compositionstart', () => {
            isComposing = true;
            compositionEndTime = 0;
        });
        
        // ç›‘å¬è¾“å…¥æ³•ç»„åˆæ›´æ–°äº‹ä»¶ï¼ˆè¾“å…¥æ³•æ­£åœ¨è¾“å…¥ï¼‰
        messageInput.addEventListener('compositionupdate', () => {
            isComposing = true;
            compositionEndTime = 0;
        });
        
        // ç›‘å¬è¾“å…¥æ³•ç»„åˆç»“æŸäº‹ä»¶ï¼ˆä¸­æ–‡è¾“å…¥æ³•è¾“å…¥å®Œæˆï¼‰
        messageInput.addEventListener('compositionend', (e) => {
            isComposing = false;
            // è®°å½•ç»„åˆè¾“å…¥ç»“æŸçš„æ—¶é—´ï¼Œç”¨äºåç»­åˆ¤æ–­
            compositionEndTime = Date.now();
        });
        
        // é”®ç›˜äº‹ä»¶å¤„ç†ï¼šEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œï¼ŒESCæ¸…é™¤
        messageInput.addEventListener('keydown', (e) => {
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­æ–‡è¾“å…¥æ³•ç»„åˆè¾“å…¥
            if (e.isComposing) {
                // å¦‚æœæ­£åœ¨ç»„åˆè¾“å…¥ï¼Œä¸å¤„ç†å›è½¦é”®ï¼Œè®©è¾“å…¥æ³•æ­£å¸¸å¤„ç†
                return;
            }
            
            // æ£€æŸ¥è‡ªå®šä¹‰çš„ isComposing çŠ¶æ€
            if (isComposing) {
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åˆšåˆšç»“æŸç»„åˆè¾“å…¥ï¼ˆé˜²æ­¢ç»„åˆè¾“å…¥åˆšç»“æŸæ—¶è¯¯è§¦å‘ï¼‰
            // å¦‚æœç»„åˆè¾“å…¥ç»“æŸæ—¶é—´è·ç¦»ç°åœ¨ä¸åˆ° COMPOSITION_END_DELAY æ¯«ç§’ï¼Œä¸”æŒ‰çš„æ˜¯å›è½¦é”®ï¼Œåˆ™ä¸å¤„ç†
            if (e.key === 'Enter' && compositionEndTime > 0) {
                const timeSinceCompositionEnd = Date.now() - compositionEndTime;
                if (timeSinceCompositionEnd < COMPOSITION_END_DELAY) {
                    // ç»„åˆè¾“å…¥åˆšç»“æŸï¼Œè¿™æ¬¡å›è½¦é”®å¯èƒ½æ˜¯ç”¨æ¥ç¡®è®¤è¾“å…¥æ³•é€‰æ‹©ï¼Œä¸å‘é€æ¶ˆæ¯
                    return;
                }
            }
            
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
                // å‘é€æ¶ˆæ¯åé‡ç½®ç»„åˆè¾“å…¥ç»“æŸæ—¶é—´
                compositionEndTime = 0;
            } else if (e.key === 'Escape') {
                e.preventDefault();
                messageInput.value = '';
                messageInput.style.height = '';
                messageInput.style.height = '60px';
                updateInputState();
                messageInput.blur();
            }
        });

        inputWrapper.appendChild(messageInput);
        inputContainer.appendChild(inputWrapper);

        // åˆ›å»ºåº•éƒ¨å·¥å…·æ 
        const bottomToolbar = document.createElement('div');
        bottomToolbar.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-top: 8px !important;
            width: 100% !important;
        `;

        // å·¦ä¾§ï¼šæ¨¡å‹é€‰æ‹©å™¨
        const leftBottomGroup = document.createElement('div');
        leftBottomGroup.style.cssText = `
            display: flex !important;
            gap: 6px !important;
            align-items: center !important;
        `;

        // åˆ›å»ºæ¨¡å‹é€‰æ‹©å™¨ï¼ˆä½¿ç”¨å® ç‰©é¢œè‰²ä¸»é¢˜ï¼‰
        const modelSelector = document.createElement('select');
        modelSelector.className = 'chat-model-selector';
        modelSelector.style.cssText = `
            padding: 6px 10px !important;
            background: white !important;
            color: #1f2937 !important;
            border: 1px solid ${mainColor} !important;
            border-radius: 6px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            outline: none !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            min-width: 100px !important;
        `;

        // æ·»åŠ æ¨¡å‹é€‰é¡¹
        if (PET_CONFIG.chatModels && PET_CONFIG.chatModels.models) {
            PET_CONFIG.chatModels.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.icon} ${model.name}`;
                option.selected = model.id === this.currentModel;
                modelSelector.appendChild(option);
            });
        }

        // æ¨¡å‹åˆ‡æ¢äº‹ä»¶
        modelSelector.addEventListener('change', (e) => {
            const selectedModel = e.target.value;
            this.setModel(selectedModel);
            // æ˜¾ç¤ºåˆ‡æ¢æç¤º
            const modelConfig = (PET_CONFIG.chatModels && PET_CONFIG.chatModels.models) ? PET_CONFIG.chatModels.models.find(m => m.id === selectedModel) : null;
            if (modelConfig) {
                this.showNotification(`å·²åˆ‡æ¢åˆ° ${modelConfig.name}`, 'info');
            }
        });

        // æ·»åŠ æ‚¬åœæ•ˆæœ
        modelSelector.addEventListener('mouseenter', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            modelSelector.style.borderColor = currentMainColor;
            modelSelector.style.background = '#f0f9ff';
        });
        modelSelector.addEventListener('mouseleave', () => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            modelSelector.style.borderColor = currentMainColor;
            modelSelector.style.background = 'white';
        });

        leftBottomGroup.appendChild(modelSelector);
        bottomToolbar.appendChild(leftBottomGroup);

        // å³ä¾§ï¼šè¯·æ±‚çŠ¶æ€æŒ‰é’®
        const rightBottomGroup = document.createElement('div');
        rightBottomGroup.style.cssText = `
            display: flex !important;
            gap: 6px !important;
            align-items: center !important;
        `;

        // åˆ›å»ºè¯·æ±‚çŠ¶æ€æŒ‰é’®ï¼ˆä½¿ç”¨å® ç‰©é¢œè‰²ä¸»é¢˜ï¼‰
        const requestStatusButton = document.createElement('button');
        requestStatusButton.className = 'chat-request-status-button';
        requestStatusButton.innerHTML = 'â¹ï¸';
        requestStatusButton.title = 'è¯·æ±‚çŠ¶æ€ï¼šç©ºé—²';
        requestStatusButton.style.cssText = `
            width: 32px !important;
            height: 32px !important;
            border-radius: 6px !important;
            background: white !important;
            color: ${mainColor} !important;
            border: 1px solid ${mainColor} !important;
            cursor: pointer !important;
            font-size: 16px !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            opacity: 0.5 !important;
            pointer-events: none !important;
        `;

        // æ›´æ–°è¯·æ±‚çŠ¶æ€æŒ‰é’®çš„å‡½æ•°ï¼ˆä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ currentAbortControllerï¼‰
        const updateRequestStatus = (status) => {
            const currentMainColor = this.getMainColorFromGradient(this.colors[this.colorIndex]);
            if (status === 'idle') {
                // ç©ºé—²çŠ¶æ€
                requestStatusButton.innerHTML = 'â¹ï¸';
                requestStatusButton.title = 'è¯·æ±‚çŠ¶æ€ï¼šç©ºé—²';
                requestStatusButton.style.opacity = '0.5';
                requestStatusButton.style.pointerEvents = 'none';
                requestStatusButton.disabled = true;
                requestStatusButton.style.background = 'white';
                requestStatusButton.style.color = currentMainColor;
            } else if (status === 'loading') {
                // è¯·æ±‚è¿›è¡Œä¸­
                requestStatusButton.innerHTML = 'â¸ï¸';
                requestStatusButton.title = 'ç‚¹å‡»ç»ˆæ­¢è¯·æ±‚';
                requestStatusButton.style.opacity = '1';
                requestStatusButton.style.pointerEvents = 'auto';
                requestStatusButton.disabled = false;
                requestStatusButton.style.background = '#fee2e2';
                requestStatusButton.style.color = '#dc2626';
                requestStatusButton.style.borderColor = '#dc2626';
            } else if (status === 'stopping') {
                // æ­£åœ¨ç»ˆæ­¢
                requestStatusButton.innerHTML = 'â¹ï¸';
                requestStatusButton.title = 'æ­£åœ¨ç»ˆæ­¢è¯·æ±‚...';
                requestStatusButton.style.opacity = '0.7';
                requestStatusButton.style.pointerEvents = 'none';
                requestStatusButton.disabled = true;
            }
        };

        // ç»ˆæ­¢è¯·æ±‚çš„å¤„ç†å‡½æ•°
        const abortRequest = () => {
            // è·å–å½“å‰çš„ AbortControllerï¼ˆå¯èƒ½åœ¨å…¶ä»–ä½œç”¨åŸŸä¸­ï¼‰
            const controller = currentAbortController || (this.chatWindow && this.chatWindow._currentAbortController ? this.chatWindow._currentAbortController() : null);
            
            if (controller) {
                updateRequestStatus('stopping');
                controller.abort();
                
                // æ¸…é™¤ AbortController å¼•ç”¨
                currentAbortController = null;
                if (this.chatWindow && this.chatWindow._setAbortController) {
                    this.chatWindow._setAbortController(null);
                }
                
                // æ¸…ç†æ‰“å­—æŒ‡ç¤ºå™¨
                const typingIndicator = messagesContainer.querySelector('[data-typing-indicator="true"]');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // æ˜¾ç¤ºå–æ¶ˆæç¤º
                this.showNotification('è¯·æ±‚å·²å–æ¶ˆ', 'info');
                
                // å»¶è¿Ÿæ¢å¤ç©ºé—²çŠ¶æ€
                setTimeout(() => {
                    updateRequestStatus('idle');
                }, 500);
            }
        };

        requestStatusButton.addEventListener('mouseenter', () => {
            if (!requestStatusButton.disabled && requestStatusButton.title.includes('ç»ˆæ­¢')) {
                requestStatusButton.style.background = '#dc2626';
                requestStatusButton.style.color = 'white';
                requestStatusButton.style.borderColor = '#dc2626';
            }
        });
        requestStatusButton.addEventListener('mouseleave', () => {
            if (!requestStatusButton.disabled && requestStatusButton.title.includes('ç»ˆæ­¢')) {
                requestStatusButton.style.background = '#fee2e2';
                requestStatusButton.style.color = '#dc2626';
                requestStatusButton.style.borderColor = '#dc2626';
            }
        });

        // ç‚¹å‡»æŒ‰é’®ç»ˆæ­¢è¯·æ±‚
        requestStatusButton.addEventListener('click', abortRequest);

        // å…ˆæ·»åŠ è¯·æ±‚çŠ¶æ€æŒ‰é’®
        rightBottomGroup.appendChild(requestStatusButton);
        
        // æ·»åŠ ä¼å¾®æœºå™¨äººè®¾ç½®æŒ‰é’®ï¼ˆåœ¨ requestStatusButton ä¹‹åï¼‰
        let robotSettingsButton = this.robotSettingsButton;
        if (!robotSettingsButton) {
            robotSettingsButton = document.createElement('span');
            robotSettingsButton.innerHTML = 'ğŸ¤–';
            robotSettingsButton.title = 'ä¼å¾®æœºå™¨äººè®¾ç½®';
            robotSettingsButton.style.cssText = `
                padding: 4px !important;
                cursor: pointer !important;
                font-size: 18px !important;
                color: #666 !important;
                font-weight: 300 !important;
                transition: all 0.2s ease !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                user-select: none !important;
                width: 24px !important;
                height: 24px !important;
                line-height: 24px !important;
            `;
            robotSettingsButton.addEventListener('mouseenter', function() {
                this.style.color = '#10b981';
                this.style.transform = 'scale(1.1)';
            });
            robotSettingsButton.addEventListener('mouseleave', function() {
                this.style.color = '#666';
                this.style.transform = 'scale(1)';
            });
            robotSettingsButton.addEventListener('click', (e) => {
                e.stopPropagation();
                this.openWeWorkRobotSettingsModal();
            });
            this.robotSettingsButton = robotSettingsButton;
        }
        
        // å¦‚æœä¼å¾®æœºå™¨äººè®¾ç½®æŒ‰é’®å·²ç»åœ¨å…¶ä»–å®¹å™¨ä¸­ï¼Œå…ˆç§»é™¤å®ƒ
        if (robotSettingsButton.parentNode && robotSettingsButton.parentNode !== rightBottomGroup) {
            robotSettingsButton.parentNode.removeChild(robotSettingsButton);
        }
        
        // å¦‚æœä¼å¾®æœºå™¨äººè®¾ç½®æŒ‰é’®ä¸åœ¨ rightBottomGroup ä¸­ï¼Œæ·»åŠ å®ƒï¼ˆåœ¨ requestStatusButton ä¹‹åï¼‰
        if (robotSettingsButton.parentNode !== rightBottomGroup) {
            rightBottomGroup.appendChild(robotSettingsButton);
        }
        
        // ç„¶åæ·»åŠ è§’è‰²è®¾ç½®æŒ‰é’®åˆ° rightBottomGroupï¼ˆåœ¨ä¼å¾®æœºå™¨äººè®¾ç½®æŒ‰é’®ä¹‹åï¼‰
        let settingsButton = this.settingsButton;
        if (!settingsButton) {
            settingsButton = document.createElement('span');
            settingsButton.innerHTML = 'ğŸ‘¤';
            settingsButton.title = 'è§’è‰²è®¾ç½®';
            settingsButton.style.cssText = `
                padding: 4px !important;
                cursor: pointer !important;
                font-size: 18px !important;
                color: #666 !important;
                font-weight: 300 !important;
                transition: all 0.2s ease !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                user-select: none !important;
                width: 24px !important;
                height: 24px !important;
                line-height: 24px !important;
            `;
            settingsButton.addEventListener('mouseenter', function() {
                this.style.color = '#2196F3';
                this.style.transform = 'scale(1.1)';
            });
            settingsButton.addEventListener('mouseleave', function() {
                this.style.color = '#666';
                this.style.transform = 'scale(1)';
            });
            settingsButton.addEventListener('click', (e) => {
                e.stopPropagation();
                this.openRoleSettingsModal();
            });
            this.settingsButton = settingsButton;
        }
        
        // å¦‚æœè®¾ç½®æŒ‰é’®å·²ç»åœ¨å…¶ä»–å®¹å™¨ä¸­ï¼Œå…ˆç§»é™¤å®ƒ
        if (settingsButton.parentNode && settingsButton.parentNode !== rightBottomGroup) {
            settingsButton.parentNode.removeChild(settingsButton);
        }
        
        // å¦‚æœè®¾ç½®æŒ‰é’®ä¸åœ¨ rightBottomGroup ä¸­ï¼Œæ·»åŠ å®ƒï¼ˆåœ¨ä¼å¾®æœºå™¨äººè®¾ç½®æŒ‰é’®ä¹‹åï¼‰
        if (settingsButton.parentNode !== rightBottomGroup) {
            rightBottomGroup.appendChild(settingsButton);
        }
        
        bottomToolbar.appendChild(rightBottomGroup);
        inputContainer.appendChild(bottomToolbar);

        // å°†æ–‡ä»¶è¾“å…¥æ·»åŠ åˆ°å®¹å™¨
        inputContainer.appendChild(fileInput);

        // å°† currentAbortController å’Œ updateRequestStatus æš´éœ²ç»™å¤–éƒ¨å‡½æ•°ä½¿ç”¨
        // é€šè¿‡å­˜å‚¨åˆ° chatWindow å¯¹è±¡çš„æ–¹å¼ï¼Œè®©è§’è‰²æŒ‰é’®ä¹Ÿèƒ½è®¿é—®
        this.chatWindow._currentAbortController = () => currentAbortController;
        this.chatWindow._setAbortController = (controller) => { currentAbortController = controller; };
        this.chatWindow._updateRequestStatus = updateRequestStatus;

        // ç¡®ä¿ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ UI é¢„åˆ›å»ºï¼ˆéšè—ï¼‰
        this.ensureContextEditorUi();
        // ç¡®ä¿æ¶ˆæ¯ç¼–è¾‘å™¨ UI é¢„åˆ›å»ºï¼ˆéšè—ï¼‰
        this.ensureMessageEditorUi();

        // åˆ›å»ºå››ä¸ªç¼©æ”¾æ‰‹æŸ„ï¼ˆå››ä¸ªè§’ï¼‰
        const createResizeHandle = (position) => {
            const handle = document.createElement('div');
			handle.className = `resize-handle resize-handle-${position}`;

            let styles = `
                position: absolute !important;
				width: 20px !important;
				height: 20px !important;
                background: linear-gradient(-45deg, transparent 30%, #ccc 30%, #ccc 70%, transparent 70%) !important;
                z-index: ${PET_CONFIG.ui.zIndex.resizeHandle} !important;
                transition: background 0.2s ease !important;
            `;

            // æ ¹æ®ä½ç½®è®¾ç½®æ ·å¼
            switch(position) {
                case 'top-left':
                    styles += `
                        top: 0 !important;
                        left: 0 !important;
                        cursor: nw-resize !important;
                        border-radius: 16px 0 0 0 !important;
                    `;
                    break;
                case 'top-right':
                    styles += `
                        top: 0 !important;
                        right: 0 !important;
                        cursor: ne-resize !important;
                        border-radius: 0 16px 0 0 !important;
                    `;
                    break;
                case 'bottom-left':
                    styles += `
                        bottom: 0 !important;
                        left: 0 !important;
                        cursor: sw-resize !important;
                        border-radius: 0 0 0 16px !important;
                    `;
                    break;
                case 'bottom-right':
                    styles += `
                        bottom: 0 !important;
                        right: 0 !important;
                        cursor: nw-resize !important;
                        border-radius: 0 0 16px 0 !important;
                    `;
                    break;
				case 'left':
					styles += `
						top: 20px !important;
						bottom: 20px !important;
						left: 0 !important;
						width: 8px !important;
						height: auto !important;
						cursor: ew-resize !important;
						background: transparent !important;
					`;
					break;
				case 'right':
					styles += `
						top: 20px !important;
						bottom: 20px !important;
						right: 0 !important;
						width: 8px !important;
						height: auto !important;
						cursor: ew-resize !important;
						background: transparent !important;
					`;
					break;
				case 'bottom':
					styles += `
						left: 20px !important;
						right: 20px !important;
						bottom: 0 !important;
						height: 8px !important;
						width: auto !important;
						cursor: ns-resize !important;
						background: transparent !important;
					`;
					break;
                case 'top':
                    styles += `
                        left: 20px !important;
                        right: 20px !important;
                        top: 0 !important;
                        height: 8px !important;
                        width: auto !important;
                        cursor: ns-resize !important;
                        background: transparent !important;
                    `;
                    break;
            }

            handle.style.cssText = styles;
            handle.title = 'æ‹–æ‹½è°ƒæ•´å¤§å°';
            return handle;
        };

		// åˆ›å»ºå››ä¸ªè§’çš„ç¼©æ”¾æ‰‹æŸ„
        const resizeHandleTL = createResizeHandle('top-left');
        const resizeHandleTR = createResizeHandle('top-right');
        const resizeHandleBL = createResizeHandle('bottom-left');
        const resizeHandleBR = createResizeHandle('bottom-right');
		// åˆ›å»ºè¾¹ç¼˜ç¼©æ”¾æ‰‹æŸ„ï¼ˆå·¦ã€å³ã€ä¸‹ï¼‰
		const resizeHandleL = createResizeHandle('left');
		const resizeHandleR = createResizeHandle('right');
		const resizeHandleB = createResizeHandle('bottom');
		const resizeHandleT = createResizeHandle('top');

        // ç»„è£…èŠå¤©çª—å£
        this.chatWindow.appendChild(chatHeader);
        this.chatWindow.appendChild(mainContentContainer);
        this.chatWindow.appendChild(inputContainer);
        
        // å°†è¾“å…¥æ¡†æŠ˜å æŒ‰é’®æ·»åŠ åˆ°èŠå¤©çª—å£ï¼ˆå®šä½åœ¨è¾“å…¥æ¡†å®¹å™¨ä¸Šæ–¹ï¼‰
        // å¦‚æœæŒ‰é’®è¿˜æ²¡æœ‰è¢«æ·»åŠ åˆ° DOMï¼Œåˆ™é€šè¿‡ querySelector æŸ¥æ‰¾
        if (!toggleInputContainerBtn.parentNode) {
            const existingBtn = this.chatWindow.querySelector('#input-container-toggle-btn');
            if (existingBtn) {
                toggleInputContainerBtn = existingBtn;
            }
        }
        if (toggleInputContainerBtn && this.chatWindow) {
            // æ›´æ–°æŒ‰é’®å®šä½ï¼Œç›¸å¯¹äºchatWindow
            const updateInputToggleBtnPosition = () => {
                const inputHeight = inputContainer.offsetHeight || 160;
                if (this.inputContainerCollapsed) {
                    toggleInputContainerBtn.style.bottom = '0px';
                } else {
                    toggleInputContainerBtn.style.bottom = `${inputHeight}px`;
                }
            };
            
            toggleInputContainerBtn.style.cssText = `
                position: absolute !important;
                left: 50% !important;
                transform: translateX(-50%) translateY(-8px) !important;
                background: rgba(255, 255, 255, 0.9) !important;
                border: 1px solid #e5e7eb !important;
                color: #374151 !important;
                font-size: 14px !important;
                cursor: pointer !important;
                padding: 0 !important;
                border-radius: 50% !important;
                width: 28px !important;
                height: 28px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                transition: all 0.3s ease !important;
                z-index: 10001 !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            `;
            this.chatWindow.appendChild(toggleInputContainerBtn);
            
            // å»¶è¿Ÿæ›´æ–°ä½ç½®ï¼Œç¡®ä¿è¾“å…¥æ¡†å·²æ¸²æŸ“
            setTimeout(() => {
                updateInputToggleBtnPosition();
            }, 100);
            
            // ç›‘å¬è¾“å…¥æ¡†é«˜åº¦å˜åŒ–ï¼ˆä½¿ç”¨ResizeObserverï¼‰
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(() => {
                    updateInputToggleBtnPosition();
                });
                resizeObserver.observe(inputContainer);
            }
        }
		this.chatWindow.appendChild(resizeHandleTL);
		this.chatWindow.appendChild(resizeHandleTR);
		this.chatWindow.appendChild(resizeHandleBL);
		this.chatWindow.appendChild(resizeHandleBR);
		this.chatWindow.appendChild(resizeHandleL);
		this.chatWindow.appendChild(resizeHandleR);
		this.chatWindow.appendChild(resizeHandleB);
		this.chatWindow.appendChild(resizeHandleT);

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(this.chatWindow);

        // åº”ç”¨è¾“å…¥æ¡†å®¹å™¨æŠ˜å çŠ¶æ€
        this.applyInputContainerCollapsedState();
        
        // æ›´æ–°è¾“å…¥æ¡†æŠ˜å æŒ‰é’®å›¾æ ‡ï¼ˆæ ¹æ®å½“å‰çŠ¶æ€ï¼‰
        const inputToggleBtn = this.chatWindow.querySelector('#input-container-toggle-btn');
        if (inputToggleBtn) {
            const icon = inputToggleBtn.querySelector('.toggle-icon');
            if (icon) {
                icon.textContent = this.inputContainerCollapsed ? 'â–²' : 'â–¼';
            }
            inputToggleBtn.title = this.inputContainerCollapsed ? 'å±•å¼€è¾“å…¥æ¡†' : 'æŠ˜å è¾“å…¥æ¡†';
        }

        // æ·»åŠ æ‹–æ‹½å’Œç¼©æ”¾åŠŸèƒ½
        this.addChatWindowInteractions();

        // æ·»åŠ æ»šåŠ¨æ¡æ ·å¼
        this.addChatScrollbarStyles();

        // åˆå§‹åŒ–æ»šåŠ¨åŠŸèƒ½
        this.initializeChatScroll();

        // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨æ˜¾ç¤º
        this.updateChatModelSelector();

        // åˆå§‹åŒ–æ¶ˆæ¯å®¹å™¨çš„åº•éƒ¨padding
        this.updateMessagesPaddingBottom = updatePaddingBottom;
        setTimeout(() => this.updateMessagesPaddingBottom(), 50);

        // åŠ è½½æ‰€æœ‰ä¼šè¯æ•°æ®ï¼ˆç¡®ä¿ä¼šè¯æ•°æ®å·²åŠ è½½ï¼‰
        await this.loadAllSessions();
        
        // æ›´æ–°ä¼šè¯ä¾§è¾¹æ ï¼ˆæ˜¾ç¤ºæ‰€æœ‰ä¼šè¯ï¼‰
        await this.updateSessionSidebar();
        
        // åŠ è½½ä¼šè¯æ¶ˆæ¯
        await this.loadSessionMessages();

        // ç›‘å¬è§’è‰²é…ç½®å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°æŒ‰é’®åˆ—è¡¨
        if (!this.roleConfigChangeListener) {
            this.roleConfigChangeListener = async (changes, namespace) => {
                if (namespace === 'local' && changes.roleConfigs) {
                    // è§’è‰²é…ç½®å‘ç”Ÿå˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°æ¬¢è¿æ¶ˆæ¯ä¸‹çš„æŒ‰é’®åˆ—è¡¨
                    await this.refreshWelcomeActionButtons();
                    // åˆ·æ–°æ‰€æœ‰æ¶ˆæ¯ä¸‹çš„æŒ‰é’®
                    await this.refreshAllMessageActionButtons();
                }
            };
            chrome.storage.onChanged.addListener(this.roleConfigChangeListener);
        }
    }

    // æ›´æ–°æ¶ˆæ¯å®¹å™¨çš„åº•éƒ¨paddingï¼ˆå…¬å…±æ–¹æ³•ï¼‰
    updateMessagesPaddingBottom() {
        if (!this.chatWindow) return;
        const inputContainer = this.chatWindow.querySelector('.chat-input-container');
        const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
        if (inputContainer && messagesContainer) {
            const inputHeight = inputContainer.offsetHeight || 160;
            // æ·»åŠ é¢å¤–20pxçš„ç¼“å†²ç©ºé—´
            messagesContainer.style.paddingBottom = (inputHeight + 20) + 'px';
            // ç¡®ä¿å†…å®¹å®Œå…¨å¯è§ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 0);
        }
    }

    // æ›´æ–°èŠå¤©çª—å£æ ·å¼
    updateChatWindowStyle() {
        if (!this.chatWindow || !this.chatWindowState) return;

        const { x, y, width, height, isFullscreen } = this.chatWindowState;

        if (isFullscreen) {
            // å…¨å±æ¨¡å¼ï¼šé“ºæ»¡æ•´ä¸ªè§†å£
            this.chatWindow.style.cssText = `
                position: fixed !important;
                left: 0 !important;
                top: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: white !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                z-index: ${PET_CONFIG.ui.zIndex.chatWindow} !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                resize: none !important;
            `;
        } else {
            // æ­£å¸¸æ¨¡å¼ï¼šä½¿ç”¨ä¿å­˜çš„ä½ç½®å’Œå¤§å°
            this.chatWindow.style.cssText = `
                position: fixed !important;
                left: ${x}px !important;
                top: ${y}px !important;
                width: ${width}px !important;
                height: ${height}px !important;
                background: white !important;
                border-radius: 16px !important;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3) !important;
                z-index: ${PET_CONFIG.ui.zIndex.chatWindow} !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                resize: none !important;
            `;
        }
    }

    // åˆ‡æ¢å…¨å±æ¨¡å¼
    toggleFullscreen() {
        if (!this.chatWindow || !this.chatWindowState) return;

        if (this.chatWindowState.isFullscreen) {
            // é€€å‡ºå…¨å±ï¼šæ¢å¤åŸå§‹çŠ¶æ€
            if (this.chatWindowState.originalState) {
                this.chatWindowState.x = this.chatWindowState.originalState.x;
                this.chatWindowState.y = this.chatWindowState.originalState.y;
                this.chatWindowState.width = this.chatWindowState.originalState.width;
                this.chatWindowState.height = this.chatWindowState.originalState.height;
                this.chatWindowState.originalState = null;
            }
            this.chatWindowState.isFullscreen = false;
        } else {
            // è¿›å…¥å…¨å±ï¼šä¿å­˜å½“å‰çŠ¶æ€
            this.chatWindowState.originalState = {
                x: this.chatWindowState.x,
                y: this.chatWindowState.y,
                width: this.chatWindowState.width,
                height: this.chatWindowState.height
            };
            this.chatWindowState.isFullscreen = true;
        }

        // æ›´æ–°çª—å£æ ·å¼
        this.updateChatWindowStyle();

        // æ›´æ–°å¤´éƒ¨æç¤ºæ–‡æœ¬å’Œæ ·å¼
        const header = this.chatWindow.querySelector('.chat-header');
        if (header) {
            if (this.chatWindowState.isFullscreen) {
                header.title = 'åŒå‡»é€€å‡ºå…¨å±';
                header.style.setProperty('border-radius', '0', 'important');
            } else {
                header.title = 'æ‹–æ‹½ç§»åŠ¨çª—å£ | åŒå‡»å…¨å±';
                header.style.setProperty('border-radius', '16px 16px 0 0', 'important');
            }
        }

        // é‡æ–°åˆå§‹åŒ–æ»šåŠ¨åŠŸèƒ½
        this.initializeChatScroll();

        // æ›´æ–°æ¶ˆæ¯å®¹å™¨çš„åº•éƒ¨padding
        this.updateMessagesPaddingBottom();
    }

    // ä»æ¸å˜è‰²ä¸­æå–ä¸»è‰²è°ƒ
    getMainColorFromGradient(gradient) {
        const match = gradient.match(/#[0-9a-fA-F]{6}/);
        return match ? match[0] : '#3b82f6';
    }

    // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜ï¼ˆæ˜¾ç¤ºå½“å‰ä¼šè¯åç§°ï¼‰
    updateChatHeaderTitle() {
        if (!this.chatWindow) return;
        
        const titleTextEl = this.chatWindow.querySelector('#pet-chat-header-title-text');
        if (!titleTextEl) return;
        
        // è·å–å½“å‰ä¼šè¯åç§°
        if (this.currentSessionId && this.sessions[this.currentSessionId]) {
            const sessionTitle = this.sessions[this.currentSessionId].pageTitle || 'æœªå‘½åä¼šè¯';
            // å¦‚æœæ ‡é¢˜å¤ªé•¿ï¼Œæˆªæ–­å¹¶æ·»åŠ çœç•¥å·
            const displayTitle = sessionTitle.length > 20 
                ? sessionTitle.substring(0, 20) + '...' 
                : sessionTitle;
            titleTextEl.textContent = displayTitle;
        } else {
            // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
            titleTextEl.textContent = 'ä¸æˆ‘èŠå¤©';
        }
    }

    // æ›´æ–°èŠå¤©çª—å£é¢œè‰²ï¼ˆè·Ÿéšå® ç‰©é¢œè‰²ï¼‰
    updateChatWindowColor() {
        if (!this.chatWindow) return;

        // è·å–å½“å‰å® ç‰©é¢œè‰²
        const currentColor = this.colors[this.colorIndex];
        const mainColor = this.getMainColorFromGradient(currentColor);

        // æ›´æ–°èŠå¤©çª—å£å¤´éƒ¨å…ƒç´ 
        const chatHeader = this.chatWindow.querySelector('.chat-header');
        if (chatHeader) {
            chatHeader.style.setProperty('background', currentColor, 'important');
        }

        // æ›´æ–°è¾“å…¥æ¡†è¾¹æ¡†é¢œè‰²
        const messageInput = this.chatWindow.querySelector('.chat-message-input');
        if (messageInput) {
            messageInput.style.setProperty('border-color', mainColor, 'important');
        }

        // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨è¾¹æ¡†é¢œè‰²
        const modelSelector = this.chatWindow.querySelector('.chat-model-selector');
        if (modelSelector) {
            modelSelector.style.setProperty('border-color', mainColor, 'important');
        }

        // æ›´æ–°æ‰€æœ‰ä½¿ç”¨é¢œè‰²çš„æŒ‰é’®
        const allButtons = this.chatWindow.querySelectorAll('button');
        allButtons.forEach(button => {
            // è·³è¿‡å…³é—­æŒ‰é’®ï¼ˆä¿æŒç™½è‰²ï¼‰
            if (button.textContent.includes('âœ•')) return;

            // æ›´æ–°@æŒ‰é’®å’Œ+æŒ‰é’®
            if (button.innerHTML === '@' || button.innerHTML === '+') {
                button.style.setProperty('color', mainColor, 'important');
                button.style.setProperty('border-color', mainColor, 'important');
                button.setAttribute('data-theme-color', mainColor);
            }

            // æ›´æ–°å›¾ç‰‡ä¸Šä¼ æŒ‰é’®
            if (button.className.includes('chat-image-upload-button')) {
                button.style.setProperty('color', mainColor, 'important');
                button.style.setProperty('border-color', mainColor, 'important');
                button.setAttribute('data-theme-color', mainColor);
            }
        });

        // æ›´æ–°é¡µé¢ä¸Šä¸‹æ–‡å¼€å…³é¢œè‰²
        const contextSwitchContainer = this.chatWindow.querySelector('.context-switch-container');
        if (contextSwitchContainer && contextSwitchContainer.updateColor) {
            contextSwitchContainer.updateColor();
        }

        // æ›´æ–°æ‰€æœ‰å·²æœ‰æ¶ˆæ¯çš„æ°”æ³¡å’Œå¤´åƒé¢œè‰²ï¼ˆä»…å® ç‰©æ¶ˆæ¯ï¼‰
        const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
        if (messagesContainer) {
            // æ›´æ–°å® ç‰©å¤´åƒ
            const petAvatars = messagesContainer.querySelectorAll('[data-message-type="pet-avatar"]');
            petAvatars.forEach(avatar => {
                avatar.style.setProperty('background', currentColor, 'important');
            });

            // æ›´æ–°å® ç‰©æ¶ˆæ¯æ°”æ³¡
            const petBubbles = messagesContainer.querySelectorAll('[data-message-type="pet-bubble"]');
            petBubbles.forEach(bubble => {
                bubble.style.setProperty('background', currentColor, 'important');
            });
        }
    }

    // æ·»åŠ èŠå¤©çª—å£äº¤äº’åŠŸèƒ½
    addChatWindowInteractions() {
        if (!this.chatWindow) return;

        const header = this.chatWindow.querySelector('.chat-header');
        const resizeHandles = this.chatWindow.querySelectorAll('.resize-handle');

        // æ‹–æ‹½åŠŸèƒ½
        if (header) {
            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('button')) return; // å¿½ç•¥æŒ‰é’®ç‚¹å‡»
                if (this.chatWindowState.isFullscreen) return; // å…¨å±æ¨¡å¼ä¸‹ç¦ç”¨æ‹–æ‹½

                this.chatWindowState.isDragging = true;
                this.chatWindowState.dragStart = {
                    x: e.clientX - this.chatWindowState.x,
                    y: e.clientY - this.chatWindowState.y
                };

                header.style.cursor = 'grabbing';
                e.preventDefault();
            });

            // åŒå‡»å…¨å±åŠŸèƒ½
            header.addEventListener('dblclick', (e) => {
                if (e.target.closest('button')) return; // å¿½ç•¥æŒ‰é’®åŒå‡»
                e.preventDefault();
                e.stopPropagation();
                this.toggleFullscreen();
            });
        }

        // ç¼©æ”¾åŠŸèƒ½ - ä¸ºæ¯ä¸ªç¼©æ”¾æ‰‹æŸ„æ·»åŠ äº‹ä»¶ç›‘å¬
        resizeHandles.forEach((resizeHandle) => {
            resizeHandle.addEventListener('mousedown', (e) => {
                if (this.chatWindowState.isFullscreen) return; // å…¨å±æ¨¡å¼ä¸‹ç¦ç”¨ç¼©æ”¾
                this.chatWindowState.isResizing = true;

                // æ ¹æ®æ‰‹æŸ„ä½ç½®ç¡®å®šç¼©æ”¾ç±»å‹
                if (resizeHandle.classList.contains('resize-handle-top-left')) {
                    this.chatWindowState.resizeType = 'top-left';
                } else if (resizeHandle.classList.contains('resize-handle-top-right')) {
                    this.chatWindowState.resizeType = 'top-right';
                } else if (resizeHandle.classList.contains('resize-handle-bottom-left')) {
                    this.chatWindowState.resizeType = 'bottom-left';
                } else if (resizeHandle.classList.contains('resize-handle-bottom-right')) {
                    this.chatWindowState.resizeType = 'bottom-right';
				} else if (resizeHandle.classList.contains('resize-handle-left')) {
					this.chatWindowState.resizeType = 'left';
				} else if (resizeHandle.classList.contains('resize-handle-right')) {
					this.chatWindowState.resizeType = 'right';
				} else if (resizeHandle.classList.contains('resize-handle-bottom')) {
					this.chatWindowState.resizeType = 'bottom';
                } else if (resizeHandle.classList.contains('resize-handle-top')) {
                    this.chatWindowState.resizeType = 'top';
                }

                this.chatWindowState.resizeStart = {
                    x: e.clientX,
                    y: e.clientY,
                    width: this.chatWindowState.width,
                    height: this.chatWindowState.height,
                    startX: this.chatWindowState.x,
                    startY: this.chatWindowState.y
                };

                // æ·»åŠ ç¼©æ”¾æ—¶çš„è§†è§‰åé¦ˆ
                this.chatWindow.style.boxShadow = '0 25px 50px rgba(0,0,0,0.4)';
                // ä½¿ç”¨å® ç‰©çš„ä¸»è‰²è°ƒ
                const currentColor = this.colors[this.colorIndex];
                const getMainColor = (gradient) => {
                    const match = gradient.match(/#[0-9a-fA-F]{6}/);
                    return match ? match[0] : '#ff6b6b';
                };
                const mainColor = getMainColor(currentColor);
                resizeHandle.style.background = `linear-gradient(-45deg, transparent 30%, ${mainColor} 30%, ${mainColor} 70%, transparent 70%)`;

                e.preventDefault();
                e.stopPropagation();
            });
        });

        // å…¨å±€é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        document.addEventListener('mousemove', (e) => {
            if (this.chatWindowState.isDragging) {
                const newX = e.clientX - this.chatWindowState.dragStart.x;
                const newY = e.clientY - this.chatWindowState.dragStart.y;

                // è¾¹ç•Œæ£€æŸ¥
                this.chatWindowState.x = Math.max(0, Math.min(window.innerWidth - this.chatWindowState.width, newX));
                this.chatWindowState.y = Math.max(0, Math.min(window.innerHeight - this.chatWindowState.height, newY));

                // æ·»åŠ æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ
                this.chatWindow.style.transform = 'scale(1.02)';
                this.chatWindow.style.boxShadow = '0 25px 50px rgba(0,0,0,0.4)';

                this.updateChatWindowStyle();
            }

            if (this.chatWindowState.isResizing) {
                const deltaX = e.clientX - this.chatWindowState.resizeStart.x;
                const deltaY = e.clientY - this.chatWindowState.resizeStart.y;

                const resizeType = this.chatWindowState.resizeType;
                let newWidth, newHeight, newX, newY;

				// æ ¹æ®ä¸åŒçš„ç¼©æ”¾ç±»å‹è®¡ç®—æ–°çš„å®½åº¦ã€é«˜åº¦å’Œä½ç½®
                switch(resizeType) {
                    case 'bottom-right':
                        // å³ä¸‹è§’ï¼šè°ƒæ•´å®½åº¦å’Œé«˜åº¦
                        newWidth = Math.max(PET_CONFIG.chatWindow.sizeLimits.minWidth, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxWidth, this.chatWindowState.resizeStart.width + deltaX));
                        newHeight = Math.max(PET_CONFIG.chatWindow.sizeLimits.minHeight, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxHeight, this.chatWindowState.resizeStart.height + deltaY));
                        newX = this.chatWindowState.resizeStart.startX;
                        newY = this.chatWindowState.resizeStart.startY;
                        break;

                    case 'bottom-left':
                        // å·¦ä¸‹è§’ï¼šè°ƒæ•´å®½åº¦ï¼ˆè´Ÿæ–¹å‘ï¼‰å’Œé«˜åº¦ï¼ŒåŒæ—¶ç§»åŠ¨xä½ç½®
                        newWidth = Math.max(PET_CONFIG.chatWindow.sizeLimits.minWidth, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxWidth, this.chatWindowState.resizeStart.width - deltaX));
                        newHeight = Math.max(PET_CONFIG.chatWindow.sizeLimits.minHeight, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxHeight, this.chatWindowState.resizeStart.height + deltaY));
                        newX = Math.max(0, this.chatWindowState.resizeStart.startX + deltaX);
                        newY = this.chatWindowState.resizeStart.startY;
                        break;

                    case 'top-right':
                        // å³ä¸Šè§’ï¼šè°ƒæ•´å®½åº¦å’Œé«˜åº¦ï¼ˆè´Ÿæ–¹å‘ï¼‰ï¼ŒåŒæ—¶ç§»åŠ¨yä½ç½®
                        newWidth = Math.max(PET_CONFIG.chatWindow.sizeLimits.minWidth, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxWidth, this.chatWindowState.resizeStart.width + deltaX));
                        newHeight = Math.max(PET_CONFIG.chatWindow.sizeLimits.minHeight, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxHeight, this.chatWindowState.resizeStart.height - deltaY));
                        newX = this.chatWindowState.resizeStart.startX;
                        newY = Math.max(0, this.chatWindowState.resizeStart.startY + deltaY);
                        break;

                    case 'top-left':
                        // å·¦ä¸Šè§’ï¼šè°ƒæ•´å®½åº¦å’Œé«˜åº¦ï¼ˆè´Ÿæ–¹å‘ï¼‰ï¼ŒåŒæ—¶ç§»åŠ¨xå’Œyä½ç½®
                        newWidth = Math.max(PET_CONFIG.chatWindow.sizeLimits.minWidth, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxWidth, this.chatWindowState.resizeStart.width - deltaX));
                        newHeight = Math.max(PET_CONFIG.chatWindow.sizeLimits.minHeight, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxHeight, this.chatWindowState.resizeStart.height - deltaY));
                        newX = Math.max(0, this.chatWindowState.resizeStart.startX + deltaX);
                        newY = Math.max(0, this.chatWindowState.resizeStart.startY + deltaY);
                        break;

					case 'left':
						// å·¦è¾¹ï¼šè°ƒæ•´å®½åº¦ï¼ˆè´Ÿæ–¹å‘ï¼‰ï¼ŒåŒæ—¶ç§»åŠ¨xä½ç½®
						newWidth = Math.max(
							PET_CONFIG.chatWindow.sizeLimits.minWidth,
							Math.min(
								PET_CONFIG.chatWindow.sizeLimits.maxWidth,
								this.chatWindowState.resizeStart.width - deltaX
							)
						);
						newHeight = this.chatWindowState.resizeStart.height;
						newX = Math.max(0, this.chatWindowState.resizeStart.startX + deltaX);
						newY = this.chatWindowState.resizeStart.startY;
						break;

					case 'right':
						// å³è¾¹ï¼šè°ƒæ•´å®½åº¦ï¼ˆæ­£æ–¹å‘ï¼‰
						newWidth = Math.max(
							PET_CONFIG.chatWindow.sizeLimits.minWidth,
							Math.min(
								PET_CONFIG.chatWindow.sizeLimits.maxWidth,
								this.chatWindowState.resizeStart.width + deltaX
							)
						);
						newHeight = this.chatWindowState.resizeStart.height;
						newX = this.chatWindowState.resizeStart.startX;
						newY = this.chatWindowState.resizeStart.startY;
						break;

					case 'bottom':
						// ä¸‹è¾¹ï¼šä»…è°ƒæ•´é«˜åº¦ï¼ˆæ­£æ–¹å‘ï¼‰
						newWidth = this.chatWindowState.resizeStart.width;
						newHeight = Math.max(
							PET_CONFIG.chatWindow.sizeLimits.minHeight,
							Math.min(
								PET_CONFIG.chatWindow.sizeLimits.maxHeight,
								this.chatWindowState.resizeStart.height + deltaY
							)
						);
						newX = this.chatWindowState.resizeStart.startX;
						newY = this.chatWindowState.resizeStart.startY;
						break;

                    case 'top':
                        // ä¸Šè¾¹ï¼šä»…è°ƒæ•´é«˜åº¦ï¼ˆè´Ÿæ–¹å‘ï¼‰ï¼ŒåŒæ—¶ç§»åŠ¨yä½ç½®
                        newWidth = this.chatWindowState.resizeStart.width;
                        newHeight = Math.max(
                            PET_CONFIG.chatWindow.sizeLimits.minHeight,
                            Math.min(
                                PET_CONFIG.chatWindow.sizeLimits.maxHeight,
                                this.chatWindowState.resizeStart.height - deltaY
                            )
                        );
                        newX = this.chatWindowState.resizeStart.startX;
                        newY = Math.max(0, this.chatWindowState.resizeStart.startY + deltaY);
                        break;

                    default:
                        return;
                }

                // è¾¹ç•Œæ£€æŸ¥ï¼Œç¡®ä¿çª—å£ä¸è¶…å‡ºå±å¹•
                const maxX = window.innerWidth - newWidth;
                const maxY = window.innerHeight - newHeight;

                if (newX + newWidth > window.innerWidth) {
                    newX = Math.max(0, maxX);
                }

                if (newY + newHeight > window.innerHeight) {
                    newY = Math.max(0, maxY);
                }

                this.chatWindowState.width = newWidth;
                this.chatWindowState.height = newHeight;
                this.chatWindowState.x = newX;
                this.chatWindowState.y = newY;

                this.updateChatWindowStyle();
            }
        });

        // å…¨å±€é¼ æ ‡é‡Šæ”¾äº‹ä»¶
        document.addEventListener('mouseup', () => {
            if (this.chatWindowState.isDragging) {
                this.chatWindowState.isDragging = false;
                if (header) {
                    header.style.cursor = 'move';
                }
                // æ¢å¤æ­£å¸¸çš„è§†è§‰æ ·å¼
                this.chatWindow.style.transform = 'scale(1)';
                this.chatWindow.style.boxShadow = '0 20px 40px rgba(0,0,0,0.3)';
                this.saveChatWindowState();
            }

            if (this.chatWindowState.isResizing) {
                this.chatWindowState.isResizing = false;

                // æ¢å¤æ‰€æœ‰ç¼©æ”¾æ‰‹æŸ„çš„æ ·å¼
                const allResizeHandles = this.chatWindow.querySelectorAll('.resize-handle');
                allResizeHandles.forEach(handle => {
                    handle.style.background = 'linear-gradient(-45deg, transparent 30%, #ccc 30%, #ccc 70%, transparent 70%)';
                });

                // æ¢å¤çª—å£é˜´å½±
                this.chatWindow.style.boxShadow = '0 20px 40px rgba(0,0,0,0.3)';

                // é‡æ–°åˆå§‹åŒ–æ»šåŠ¨åŠŸèƒ½
                this.initializeChatScroll();

                // æ›´æ–°æ¶ˆæ¯å®¹å™¨çš„åº•éƒ¨padding
                this.updateMessagesPaddingBottom();

                this.saveChatWindowState();
            }
        });

        // æ‚¬åœæ•ˆæœ - ä¸ºæ‰€æœ‰ç¼©æ”¾æ‰‹æŸ„æ·»åŠ æ‚¬åœæ•ˆæœ
        resizeHandles.forEach((resizeHandle) => {
            resizeHandle.addEventListener('mouseenter', () => {
                if (!this.chatWindowState.isResizing) {
                    resizeHandle.style.background = 'linear-gradient(-45deg, transparent 30%, #999 30%, #999 70%, transparent 70%)';
                    resizeHandle.style.transform = 'scale(1.1)';
                }
            });

            resizeHandle.addEventListener('mouseleave', () => {
                if (!this.chatWindowState.isResizing) {
                    resizeHandle.style.background = 'linear-gradient(-45deg, transparent 30%, #ccc 30%, #ccc 70%, transparent 70%)';
                    resizeHandle.style.transform = 'scale(1)';
                }
            });
        });
    }

    // ä¿å­˜èŠå¤©çª—å£çŠ¶æ€
    saveChatWindowState() {
        if (!this.chatWindowState) return;

        try {
            const state = {
                x: this.chatWindowState.x,
                y: this.chatWindowState.y,
                width: this.chatWindowState.width,
                height: this.chatWindowState.height,
                timestamp: Date.now()
            };

            // ä¿å­˜åˆ°chrome.storage.localé¿å…å†™å…¥é…é¢é™åˆ¶
            chrome.storage.local.set({ [PET_CONFIG.storage.keys.chatWindowState]: state }, () => {
                if (chrome.runtime.lastError) {
                    console.warn('ä¿å­˜èŠå¤©çª—å£çŠ¶æ€å¤±è´¥:', chrome.runtime.lastError.message);
                } else {
                    console.log('èŠå¤©çª—å£çŠ¶æ€å·²ä¿å­˜åˆ°localå­˜å‚¨:', state);
                }
            });

            // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ç”¨
            localStorage.setItem('petChatWindowState', JSON.stringify(state));
            console.log('èŠå¤©çª—å£çŠ¶æ€å·²ä¿å­˜:', state);
        } catch (error) {
            console.log('ä¿å­˜èŠå¤©çª—å£çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // åŠ è½½èŠå¤©çª—å£çŠ¶æ€
    loadChatWindowState(callback) {
        try {
            // é¦–å…ˆå°è¯•ä»Chromeå­˜å‚¨APIåŠ è½½å…¨å±€çŠ¶æ€
            chrome.storage.sync.get([PET_CONFIG.storage.keys.chatWindowState], (result) => {
                if (result[PET_CONFIG.storage.keys.chatWindowState]) {
                    const state = result[PET_CONFIG.storage.keys.chatWindowState];
                    this.restoreChatWindowState(state);

                    // æ›´æ–°èŠå¤©çª—å£æ ·å¼ï¼ˆå¦‚æœå·²ç»åˆ›å»ºï¼‰
                    if (this.chatWindow) {
                        this.updateChatWindowStyle();
                    }

                    if (callback) callback(true);
                } else {
                    // å¦‚æœå…¨å±€çŠ¶æ€ä¸å­˜åœ¨ï¼Œå°è¯•ä»localStorageåŠ è½½
                    const success = this.loadChatWindowStateFromLocalStorage();
                    if (callback) callback(success);
                }
            });

            // ç›‘å¬å­˜å‚¨å˜åŒ–ï¼Œå®ç°è·¨é¡µé¢åŒæ­¥
            chrome.storage.onChanged.addListener((changes, namespace) => {
                // ç›‘å¬ local å­˜å‚¨çš„å˜åŒ–ï¼ˆæ–°ç‰ˆæœ¬ä½¿ç”¨ local é¿å…å†™å…¥é…é¢é™åˆ¶ï¼‰
                if (namespace === 'local' && changes[PET_CONFIG.storage.keys.chatWindowState]) {
                    const newState = changes[PET_CONFIG.storage.keys.chatWindowState].newValue;
                    if (newState && !this.chatWindowState.isDragging && !this.chatWindowState.isResizing) {
                        this.restoreChatWindowState(newState);

                        // æ›´æ–°èŠå¤©çª—å£æ ·å¼ï¼ˆå¦‚æœå·²ç»åˆ›å»ºï¼‰
                        if (this.chatWindow) {
                            this.updateChatWindowStyle();
                            console.log('èŠå¤©çª—å£çŠ¶æ€å·²ä»localå­˜å‚¨æ›´æ–°:', newState);
                        }
                    }
                }
                // å…¼å®¹æ—§ç‰ˆæœ¬çš„ sync å­˜å‚¨
                if (namespace === 'sync' && changes[PET_CONFIG.storage.keys.chatWindowState]) {
                    const newState = changes[PET_CONFIG.storage.keys.chatWindowState].newValue;
                    if (newState && !this.chatWindowState.isDragging && !this.chatWindowState.isResizing) {
                        this.restoreChatWindowState(newState);
                        if (this.chatWindow) {
                            this.updateChatWindowStyle();
                            console.log('èŠå¤©çª—å£çŠ¶æ€å·²ä»syncå­˜å‚¨æ›´æ–°ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰:', newState);
                        }
                    }
                }
            });

            return true;
        } catch (error) {
            console.log('æ¢å¤èŠå¤©çª—å£çŠ¶æ€å¤±è´¥:', error);
            const success = this.loadChatWindowStateFromLocalStorage();
            if (callback) callback(success);
            return success;
        }
    }

    // ä»localStorageåŠ è½½èŠå¤©çª—å£çŠ¶æ€ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
    loadChatWindowStateFromLocalStorage() {
        try {
            const savedState = localStorage.getItem('petChatWindowState');
            if (savedState) {
                const state = JSON.parse(savedState);
                this.restoreChatWindowState(state);
                console.log('èŠå¤©çª—å£çŠ¶æ€å·²ä»æœ¬åœ°å­˜å‚¨æ¢å¤:', this.chatWindowState);
                return true;
            }
        } catch (error) {
            console.log('æ¢å¤æœ¬åœ°èŠå¤©çª—å£çŠ¶æ€å¤±è´¥:', error);
        }
        return false;
    }

    // æ¢å¤èŠå¤©çª—å£çŠ¶æ€ï¼ˆåº”ç”¨ä½ç½®å’Œå¤§å°ï¼‰
    restoreChatWindowState(state) {
        this.chatWindowState = {
            ...this.chatWindowState,
            ...state,
            isDragging: false,
            isResizing: false,
            resizeType: 'bottom-right' // é»˜è®¤ç¼©æ”¾ç±»å‹
        };

        // éªŒè¯ä½ç½®å’Œå¤§å°
        this.chatWindowState.width = Math.max(PET_CONFIG.chatWindow.sizeLimits.minWidth, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxWidth, this.chatWindowState.width));
        this.chatWindowState.height = Math.max(PET_CONFIG.chatWindow.sizeLimits.minHeight, Math.min(PET_CONFIG.chatWindow.sizeLimits.maxHeight, this.chatWindowState.height));
        this.chatWindowState.x = Math.max(0, Math.min(window.innerWidth - this.chatWindowState.width, this.chatWindowState.x));
        this.chatWindowState.y = Math.max(0, Math.min(window.innerHeight - this.chatWindowState.height, this.chatWindowState.y));

        console.log('èŠå¤©çª—å£çŠ¶æ€å·²æ¢å¤:', this.chatWindowState);
    }

    // åŠ è½½ Mermaid.js (CDN)
    async loadMermaid() {
        if (this.mermaidLoaded || this.mermaidLoading) {
            return this.mermaidLoaded;
        }

        this.mermaidLoading = true;

        return new Promise((resolve, reject) => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½ï¼ˆä» content_scripts è‡ªåŠ¨åŠ è½½æˆ–ä¹‹å‰åŠ¨æ€åŠ è½½ï¼‰
            const mermaidLib = (typeof mermaid !== 'undefined') ? mermaid : 
                              (typeof window !== 'undefined' && window.mermaid) ? window.mermaid : null;
            
            if (mermaidLib && typeof mermaidLib.initialize === 'function') {
                try {
                    // åˆå§‹åŒ– mermaid
                    mermaidLib.initialize({
                        startOnLoad: false,
                        theme: 'default',
                        securityLevel: 'loose',
                        flowchart: {
                            useMaxWidth: true,
                            htmlLabels: true
                        }
                    });
                    this.mermaidLoaded = true;
                    this.mermaidLoading = false;
                    console.log('Mermaid.js å·²åŠ è½½å¹¶åˆå§‹åŒ–');
                    resolve(true);
                    return;
                } catch (error) {
                    console.error('åˆå§‹åŒ– Mermaid å¤±è´¥:', error);
                    this.mermaidLoading = false;
                    reject(error);
                    return;
                }
            }

            // ä½¿ç”¨æ³¨å…¥è„šæœ¬åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­åŠ è½½ mermaid
            // è¿™æ ·å¯ä»¥ç¡®ä¿ mermaid åœ¨é¡µé¢çš„ window å¯¹è±¡ä¸­å¯ç”¨
            const scriptUrl = chrome.runtime.getURL('mermaid.min.js');
            const loadScriptUrl = chrome.runtime.getURL('load-mermaid.js');
            console.log('å°è¯•åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­åŠ è½½ Mermaid.jsï¼ŒURL:', scriptUrl);
            
            // é€šè¿‡ data å±æ€§ä¼ é€’ URLï¼ˆé¿å…å†…è”è„šæœ¬ï¼‰
            // æ³¨ï¼šæˆ‘ä»¬ä»ç„¶éœ€è¦é€šè¿‡é¡µé¢ä¸Šä¸‹æ–‡ä¼ é€’ URLï¼Œä½¿ç”¨éšè—çš„ data å±æ€§
            const urlContainer = document.createElement('div');
            urlContainer.id = '__mermaid_url_container__';
            urlContainer.style.display = 'none';
            urlContainer.setAttribute('data-mermaid-url', scriptUrl);
            (document.head || document.documentElement).appendChild(urlContainer);
            
            // ä¿®æ”¹ load-mermaid.js ä»¥ä» data å±æ€§è¯»å– URL
            // ä½†æ›´ç®€å•çš„æ–¹æ³•æ˜¯åœ¨ load-mermaid.js ä¸­ç›´æ¥ä½¿ç”¨ chrome.runtime.getURL
            // å› ä¸º load-mermaid.js åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œæ— æ³•ç›´æ¥è®¿é—® chrome API
            // æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ data å±æ€§ä¼ é€’
            
            // åŠ è½½å¤–éƒ¨è„šæœ¬æ–‡ä»¶ï¼ˆé¿å… CSP é™åˆ¶ï¼‰
            const injectedScript = document.createElement('script');
            injectedScript.src = loadScriptUrl;
            injectedScript.charset = 'UTF-8';
            injectedScript.async = false;
            
            // ç›‘å¬é¡µé¢ä¸­çš„ mermaid åŠ è½½äº‹ä»¶ï¼ˆåœ¨è„šæœ¬åŠ è½½å‰è®¾ç½®ï¼‰
            const handleMermaidLoaded = () => {
                console.log('[Content] æ”¶åˆ° Mermaid åŠ è½½å®Œæˆäº‹ä»¶');
                // Mermaid å·²ç»åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­åŠ è½½ï¼ˆé€šè¿‡ load-mermaid.jsï¼‰
                // ç”±äº content script çš„éš”ç¦»ç¯å¢ƒï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—®é¡µé¢çš„ window.mermaid
                // ä½†æˆ‘ä»¬çŸ¥é“å®ƒå·²ç»åŠ è½½ï¼Œå¯ä»¥é€šè¿‡å¤–éƒ¨è„šæœ¬æ‰§è¡Œæ¸²æŸ“
                this.mermaidLoaded = true;
                this.mermaidLoading = false;
                console.log('[Content] Mermaid.js åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­å·²åŠ è½½');
                window.removeEventListener('mermaid-loaded', handleMermaidLoaded);
                window.removeEventListener('mermaid-error', handleMermaidError);
                resolve(true);
            };
            
            const handleMermaidError = () => {
                console.error('[Content] æ”¶åˆ° Mermaid åŠ è½½å¤±è´¥äº‹ä»¶');
                this.mermaidLoading = false;
                window.removeEventListener('mermaid-loaded', handleMermaidLoaded);
                window.removeEventListener('mermaid-error', handleMermaidError);
                reject(new Error('é¡µé¢ä¸Šä¸‹æ–‡ä¸­çš„ Mermaid.js åŠ è½½å¤±è´¥'));
            };
            
            // ç›‘å¬é¡µé¢äº‹ä»¶ï¼ˆé€šè¿‡æ³¨å…¥çš„äº‹ä»¶ç›‘å¬å™¨ï¼‰
            window.addEventListener('mermaid-loaded', handleMermaidLoaded);
            window.addEventListener('mermaid-error', handleMermaidError);
            
            // æ³¨å…¥è„šæœ¬åˆ°é¡µé¢ä¸Šä¸‹æ–‡
            (document.head || document.documentElement).appendChild(injectedScript);
            
            // æ¸…ç†æ³¨å…¥çš„è„šæœ¬
            setTimeout(() => {
                if (injectedScript.parentNode) {
                    injectedScript.parentNode.removeChild(injectedScript);
                }
            }, 1000);
        });
    }

    // å¤„ç† Markdown ä¸­çš„ Mermaid ä»£ç å—
    async processMermaidBlocks(container) {
        if (!container) return;

        // æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½ mermaid - æ›´å…¨é¢çš„é€‰æ‹©å™¨
        const mermaidBlocks = container.querySelectorAll('code.language-mermaid, code.language-mmd, pre code.language-mermaid, pre code.language-mmd, code[class*="mermaid"]');
        
        if (mermaidBlocks.length === 0) return;

        // è¿‡æ»¤æ‰å·²ç»å¤„ç†è¿‡çš„å—
        const unprocessedBlocks = Array.from(mermaidBlocks).filter(block => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯mermaid divæˆ–è¢«æ ‡è®°ä¸ºå·²å¤„ç†
            const preElement = block.parentElement;
            if (preElement && preElement.tagName === 'PRE') {
                // å¦‚æœçˆ¶å…ƒç´ çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ æ˜¯mermaid divï¼Œè¯´æ˜å·²ç»å¤„ç†è¿‡
                const nextSibling = preElement.nextElementSibling;
                if (nextSibling && nextSibling.classList.contains('mermaid')) {
                    return false;
                }
                // æ£€æŸ¥æ˜¯å¦æœ‰å¤„ç†æ ‡è®°
                if (block.classList.contains('mermaid-processed')) {
                    return false;
                }
            }
            return true;
        });

        if (unprocessedBlocks.length === 0) return;

        // åŠ è½½ mermaidï¼ˆå¦‚æœéœ€è¦ï¼‰
        const mermaidAvailable = await this.loadMermaid().catch(() => false);
        if (!mermaidAvailable) {
            console.warn('Mermaid.js æœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“å›¾è¡¨');
            return;
        }

        // å¤„ç†æ¯ä¸ªæœªå¤„ç†çš„ mermaid ä»£ç å—
        unprocessedBlocks.forEach((codeBlock, index) => {
            const preElement = codeBlock.parentElement;
            if (preElement && preElement.tagName === 'PRE') {
                const mermaidId = `mermaid-${Date.now()}-${index}-${Math.random().toString(36).substr(2, 9)}`;
                const mermaidContent = codeBlock.textContent || codeBlock.innerText || '';

                if (!mermaidContent.trim()) {
                    return; // è·³è¿‡ç©ºå†…å®¹
                }

                // åˆ›å»º mermaid å®¹å™¨
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.id = mermaidId;
                mermaidDiv.textContent = mermaidContent;
                // ä¿å­˜æºä»£ç ä»¥ä¾¿åç»­å¤åˆ¶åŠŸèƒ½ä½¿ç”¨
                mermaidDiv.setAttribute('data-mermaid-source', mermaidContent);
                mermaidDiv.style.cssText = `
                    background: rgba(255, 255, 255, 0.1) !important;
                    padding: 15px !important;
                    border-radius: 8px !important;
                    margin: 15px 0 !important;
                    overflow-x: auto !important;
                    min-height: 100px !important;
                `;

                // æ ‡è®°ä¸ºå·²å¤„ç†
                codeBlock.classList.add('mermaid-processed');
                
                // æ›¿æ¢ä»£ç å—
                try {
                    preElement.parentNode.replaceChild(mermaidDiv, preElement);

                    // æ¸²æŸ“ mermaid å›¾è¡¨ - ä½¿ç”¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­çš„ mermaid
                    // å› ä¸º mermaid åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æ³¨å…¥è„šæœ¬æ‰§è¡Œæ¸²æŸ“
                    // é€šè¿‡ data å±æ€§ä¼ é€’æ¸²æŸ“ IDï¼ˆé¿å…å†…è”è„šæœ¬ï¼‰
                    // ä¸ºæ¯ä¸ª mermaid å—ä½¿ç”¨å”¯ä¸€çš„å®¹å™¨ IDï¼Œé¿å…å†²çª
                    const renderIdContainer = document.createElement('div');
                    renderIdContainer.id = `__mermaid_render_id_container__${mermaidId}`;
                    renderIdContainer.style.display = 'none';
                    renderIdContainer.setAttribute('data-mermaid-id', mermaidId);
                    // ç¡®ä¿å®¹å™¨åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­ï¼ˆä¸æ˜¯åœ¨ content script çš„éš”ç¦» DOMï¼‰
                    (document.head || document.documentElement).appendChild(renderIdContainer);
                    
                    // ç›‘å¬æ¸²æŸ“ç»“æœï¼ˆåœ¨åŠ è½½è„šæœ¬ä¹‹å‰è®¾ç½®ï¼‰
                    const handleRender = (event) => {
                        if (event.detail.id === mermaidId) {
                            window.removeEventListener('mermaid-rendered', handleRender);
                            if (!event.detail.success) {
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'mermaid-error';
                                errorDiv.style.cssText = `
                                    background: rgba(255, 0, 0, 0.1) !important;
                                    padding: 10px !important;
                                    border-radius: 5px !important;
                                    color: #ff6b6b !important;
                                    font-size: 12px !important;
                                    margin: 10px 0 !important;
                                `;
                                errorDiv.innerHTML = `
                                    <div>âŒ Mermaid å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>
                                    <pre style="font-size: 10px; margin-top: 5px; overflow-x: auto;">${this.escapeHtml(mermaidContent)}</pre>
                                `;
                                if (mermaidDiv.parentNode) {
                                    mermaidDiv.parentNode.replaceChild(errorDiv, mermaidDiv);
                                }
                            } else {
                                // æ¸²æŸ“æˆåŠŸï¼Œæ·»åŠ å¤åˆ¶å’Œä¸‹è½½æŒ‰é’®
                                setTimeout(() => {
                                    this.addMermaidActions(mermaidDiv, event.detail.svgContent || '', mermaidContent);
                                }, 100);
                            }
                            // æ¸…ç† ID å®¹å™¨
                            if (renderIdContainer.parentNode) {
                                renderIdContainer.parentNode.removeChild(renderIdContainer);
                            }
                        }
                    };
                    window.addEventListener('mermaid-rendered', handleRender);
                    
                    // å»¶è¿ŸåŠ è½½æ¸²æŸ“è„šæœ¬ï¼Œç¡®ä¿ mermaid div å·²ç»æ·»åŠ åˆ° DOM ä¸”äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®
                    // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿ DOM å®Œå…¨æ›´æ–°
                    setTimeout(() => {
                        // å†æ¬¡æ£€æŸ¥ mermaid div æ˜¯å¦å­˜åœ¨ï¼ˆç¡®ä¿ DOM å·²æ›´æ–°ï¼‰
                        const checkDiv = document.getElementById(mermaidId);
                        if (!checkDiv) {
                            console.warn('[ProcessMermaid] mermaid div å°šæœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿæ¸²æŸ“:', mermaidId);
                            // å¦‚æœè¿˜æ²¡å‡†å¤‡å¥½ï¼Œå†ç­‰ä¸€ä¼š
                            setTimeout(() => {
                                const renderScript = document.createElement('script');
                                renderScript.src = chrome.runtime.getURL('render-mermaid.js');
                                renderScript.charset = 'UTF-8';
                                renderScript.async = false;
                                document.documentElement.appendChild(renderScript);
                                
                                setTimeout(() => {
                                    if (renderScript.parentNode) {
                                        renderScript.parentNode.removeChild(renderScript);
                                    }
                                }, 3000);
                            }, 150);
                            return;
                        }
                        
                        // åŠ è½½å¤–éƒ¨æ¸²æŸ“è„šæœ¬ï¼ˆé¿å… CSP é™åˆ¶ï¼‰
                        const renderScript = document.createElement('script');
                        renderScript.src = chrome.runtime.getURL('render-mermaid.js');
                        renderScript.charset = 'UTF-8';
                        renderScript.async = false;
                        
                        // æ³¨å…¥æ¸²æŸ“è„šæœ¬åˆ°é¡µé¢ä¸Šä¸‹æ–‡
                        document.documentElement.appendChild(renderScript);
                        
                        // æ¸…ç†è„šæœ¬ï¼ˆæ¸²æŸ“å®Œæˆåï¼‰
                        setTimeout(() => {
                            if (renderScript.parentNode) {
                                renderScript.parentNode.removeChild(renderScript);
                            }
                        }, 3000);
                    }, 200);
                } catch (error) {
                    console.error('æ›¿æ¢ Mermaid ä»£ç å—æ—¶å‡ºé”™:', error);
                    // å‡ºé”™æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä½†ä¿ç•™åŸå§‹ä»£ç 
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'mermaid-error';
                    errorDiv.style.cssText = `
                        background: rgba(255, 0, 0, 0.1) !important;
                        padding: 10px !important;
                        border-radius: 5px !important;
                        color: #ff6b6b !important;
                        font-size: 12px !important;
                        margin: 10px 0 !important;
                    `;
                    errorDiv.innerHTML = `
                        <div>âŒ Mermaid å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>
                        <pre style="font-size: 10px; margin-top: 5px; overflow-x: auto;">${this.escapeHtml(mermaidContent)}</pre>
                    `;
                    if (mermaidDiv.parentNode) {
                        mermaidDiv.parentNode.replaceChild(errorDiv, mermaidDiv);
                    }
                }
            }
        });
    }

    // æ¸²æŸ“ Markdown ä¸º HTMLï¼ˆä¿æŒåŒæ­¥ä»¥å…¼å®¹ç°æœ‰ä»£ç ï¼‰
    renderMarkdown(markdown) {
        if (!markdown) return '';

        try {
            // æ£€æŸ¥ marked æ˜¯å¦å¯ç”¨
            if (typeof marked !== 'undefined') {
                // é…ç½® marked ä»¥å¢å¼ºå®‰å…¨æ€§
                marked.setOptions({
                    breaks: true, // æ”¯æŒæ¢è¡Œ
                    gfm: true, // GitHub Flavored Markdown
                    sanitize: false // å…è®¸ HTMLï¼Œä½†æˆ‘ä»¬ä¼šé€šè¿‡ DOMPurify æˆ–å…¶ä»–æ–¹å¼å¤„ç†
                });
                return marked.parse(markdown);
            } else {
                // å¦‚æœ marked ä¸å¯ç”¨ï¼Œè¿”å›è½¬ä¹‰çš„çº¯æ–‡æœ¬
                return this.escapeHtml(markdown);
            }
        } catch (error) {
            console.error('æ¸²æŸ“ Markdown å¤±è´¥:', error);
            return this.escapeHtml(markdown);
        }
    }

    // æ¸²æŸ“ Markdown å¹¶å¤„ç† Mermaidï¼ˆå®Œæ•´æµç¨‹ï¼‰
    async renderMarkdownWithMermaid(markdown, container) {
        // å…ˆæ¸²æŸ“ Markdown
        const html = this.renderMarkdown(markdown);
        
        // å¦‚æœæä¾›äº†å®¹å™¨ï¼Œå¤„ç†å…¶ä¸­çš„ Mermaid ä»£ç å—
        if (container) {
            // éœ€è¦ç­‰å¾… DOM æ›´æ–°åå†å¤„ç†
            setTimeout(async () => {
                await this.processMermaidBlocks(container);
            }, 100);
        }
        
        return html;
    }

    // HTML è½¬ä¹‰è¾…åŠ©å‡½æ•°
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }


    // ä¸º Mermaid å›¾è¡¨æ·»åŠ å¤åˆ¶å’Œä¸‹è½½æŒ‰é’®
    addMermaidActions(mermaidDiv, svgContent, mermaidSourceCode) {
        if (!mermaidDiv) return;

        // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº†æŒ‰é’®
        if (mermaidDiv.querySelector('.mermaid-actions')) {
            return;
        }

        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'mermaid-actions';
        actionsContainer.style.cssText = `
            position: absolute !important;
            top: 10px !important;
            right: 10px !important;
            display: flex !important;
            gap: 8px !important;
            z-index: 10 !important;
            opacity: 0 !important;
            transition: opacity 0.2s ease !important;
        `;

        // ç¡®ä¿ mermaid div æœ‰ç›¸å¯¹å®šä½
        const currentPosition = window.getComputedStyle(mermaidDiv).position;
        if (currentPosition === 'static') {
            mermaidDiv.style.position = 'relative';
        }

        // åˆ›å»ºå¤åˆ¶æŒ‰é’®
        const copyButton = document.createElement('button');
        copyButton.className = 'mermaid-copy-button';
        copyButton.title = 'å¤åˆ¶ Mermaid ä»£ç ';
        copyButton.innerHTML = 'ğŸ“‹';
        copyButton.style.cssText = `
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            border-radius: 4px !important;
            width: 28px !important;
            height: 28px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: all 0.2s ease !important;
            opacity: 0.8 !important;
            backdrop-filter: blur(4px) !important;
        `;

        // åˆ›å»ºä¸‹è½½ SVG æŒ‰é’®
        const downloadButton = document.createElement('button');
        downloadButton.className = 'mermaid-download-button';
        downloadButton.title = 'ä¸‹è½½ SVG';
        downloadButton.innerHTML = 'ğŸ’¾';
        downloadButton.style.cssText = `
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            border-radius: 4px !important;
            width: 28px !important;
            height: 28px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: all 0.2s ease !important;
            opacity: 0.8 !important;
            backdrop-filter: blur(4px) !important;
        `;

        // åˆ›å»ºä¸‹è½½ PNG æŒ‰é’®
        const downloadPngButton = document.createElement('button');
        downloadPngButton.className = 'mermaid-download-png-button';
        downloadPngButton.title = 'ä¸‹è½½ PNG';
        downloadPngButton.innerHTML = 'ğŸ–¼ï¸';
        downloadPngButton.style.cssText = `
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            border-radius: 4px !important;
            width: 28px !important;
            height: 28px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: all 0.2s ease !important;
            opacity: 0.8 !important;
            backdrop-filter: blur(4px) !important;
        `;

        // åˆ›å»ºç¼–è¾‘æŒ‰é’®ï¼ˆåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ Mermaid Live Editorï¼‰
        const editButton = document.createElement('button');
        editButton.className = 'mermaid-edit-button';
        editButton.title = 'åœ¨ Mermaid Live Editor ä¸­æ‰“å¼€';
        editButton.innerHTML = 'âœï¸';
        editButton.style.cssText = `
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            border-radius: 4px !important;
            width: 28px !important;
            height: 28px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: all 0.2s ease !important;
            opacity: 0.8 !important;
            backdrop-filter: blur(4px) !important;
        `;

        // è·å– SVG å†…å®¹çš„è¾…åŠ©å‡½æ•°
        const getSvgContent = () => {
            return new Promise((resolve) => {
                // é¦–å…ˆå°è¯•ä½¿ç”¨äº‹ä»¶ä¼ é€’çš„å†…å®¹
                if (svgContent) {
                    resolve(svgContent);
                    return;
                }

                // å°è¯•ä» DOM è·å–ï¼ˆcontent script å¯ä»¥ç›´æ¥è®¿é—® DOMï¼‰
                const svgElement = mermaidDiv.querySelector('svg');
                if (svgElement) {
                    try {
                        const clone = svgElement.cloneNode(true);
                        if (!clone.getAttribute('xmlns')) {
                            clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                        }
                        const svgString = new XMLSerializer().serializeToString(clone);
                        resolve(svgString);
                        return;
                    } catch (error) {
                        console.warn('é€šè¿‡ DOM è·å– SVG å¤±è´¥ï¼Œå°è¯•æ³¨å…¥è„šæœ¬:', error);
                    }
                }

                // å¦‚æœéƒ½å¤±è´¥ï¼Œé€šè¿‡æ³¨å…¥è„šæœ¬ä»é¡µé¢ä¸Šä¸‹æ–‡è·å–
                const script = document.createElement('script');
                script.textContent = `
                    (function() {
                        const mermaidDiv = document.getElementById('${mermaidDiv.id}');
                        if (mermaidDiv) {
                            const svgElement = mermaidDiv.querySelector('svg');
                            if (svgElement) {
                                const clone = svgElement.cloneNode(true);
                                if (!clone.getAttribute('xmlns')) {
                                    clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                                }
                                const svgString = new XMLSerializer().serializeToString(clone);
                                window.postMessage({
                                    type: 'mermaid-svg-content',
                                    id: '${mermaidDiv.id}',
                                    svgContent: svgString
                                }, '*');
                            }
                        }
                    })();
                `;
                document.documentElement.appendChild(script);
                
                const messageHandler = (event) => {
                    if (event.data && event.data.type === 'mermaid-svg-content' && event.data.id === mermaidDiv.id) {
                        window.removeEventListener('message', messageHandler);
                        document.documentElement.removeChild(script);
                        resolve(event.data.svgContent || '');
                    }
                };
                window.addEventListener('message', messageHandler);
                
                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    if (script.parentNode) {
                        document.documentElement.removeChild(script);
                    }
                    resolve('');
                }, 1000);
            });
        };

        // å¤åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - å¤åˆ¶ Mermaid æºä»£ç 
        copyButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            e.preventDefault();
            
            try {
                // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œå…¶æ¬¡ä» data å±æ€§è·å–
                let codeToCopy = mermaidSourceCode || mermaidDiv.getAttribute('data-mermaid-source') || '';

                if (codeToCopy) {
                    await navigator.clipboard.writeText(codeToCopy);
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    copyButton.innerHTML = 'âœ“';
                    copyButton.style.background = 'rgba(76, 175, 80, 0.3) !important';
                    setTimeout(() => {
                        copyButton.innerHTML = 'ğŸ“‹';
                        copyButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
                    }, 1000);
                } else {
                    throw new Error('æ— æ³•è·å– Mermaid æºä»£ç ');
                }
            } catch (error) {
                console.error('å¤åˆ¶ Mermaid ä»£ç å¤±è´¥:', error);
                copyButton.innerHTML = 'âœ—';
                copyButton.style.background = 'rgba(244, 67, 54, 0.3) !important';
                setTimeout(() => {
                    copyButton.innerHTML = 'ğŸ“‹';
                    copyButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
                }, 1000);
            }
        });

        // ä¸‹è½½ SVG æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        downloadButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            e.preventDefault();
            
            try {
                const svg = await getSvgContent();

                if (svg) {
                    // åˆ›å»º Blob å¹¶ä¸‹è½½
                    const blob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `mermaid-diagram-${Date.now()}.svg`;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    downloadButton.innerHTML = 'âœ“';
                    downloadButton.style.background = 'rgba(76, 175, 80, 0.3) !important';
                    setTimeout(() => {
                        downloadButton.innerHTML = 'ğŸ’¾';
                        downloadButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
                    }, 1000);
                } else {
                    throw new Error('æ— æ³•è·å– SVG å†…å®¹');
                }
            } catch (error) {
                console.error('ä¸‹è½½ SVG å¤±è´¥:', error);
                downloadButton.innerHTML = 'âœ—';
                downloadButton.style.background = 'rgba(244, 67, 54, 0.3) !important';
                setTimeout(() => {
                    downloadButton.innerHTML = 'ğŸ’¾';
                    downloadButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
                }, 1000);
            }
        });

        // å°† SVG è½¬æ¢ä¸º PNG çš„è¾…åŠ©å‡½æ•°
        const svgToPng = (svgString) => {
            return new Promise((resolve, reject) => {
                // æ–¹æ³•1: ä¼˜å…ˆå°è¯•ç›´æ¥ä» DOM ä¸­çš„ SVG å…ƒç´ ç»˜åˆ¶ï¼ˆæœ€å¯é ï¼Œå·²æ¸²æŸ“å¥½çš„å…ƒç´ ï¼‰
                const svgElementInDom = mermaidDiv.querySelector('svg');
                if (svgElementInDom) {
                    try {
                        // è·å– SVG çš„å®é™…å°ºå¯¸
                        const bbox = svgElementInDom.getBBox();
                        let width = bbox.width || 800;
                        let height = bbox.height || 600;
                        
                        // å¦‚æœ bbox æ— æ•ˆï¼Œå°è¯•ä»å±æ€§è·å–
                        if (width <= 0 || height <= 0) {
                            width = parseFloat(svgElementInDom.getAttribute('width')) || 
                                   parseFloat(svgElementInDom.getAttribute('viewBox')?.split(/\s+/)[2]) || 800;
                            height = parseFloat(svgElementInDom.getAttribute('height')) || 
                                    parseFloat(svgElementInDom.getAttribute('viewBox')?.split(/\s+/)[3]) || 600;
                        }
                        
                        // ç¡®ä¿å®½é«˜æœ‰æ•ˆ
                        if (width <= 0 || height <= 0 || !isFinite(width) || !isFinite(height)) {
                            width = 800;
                            height = 600;
                        }
                        
                        // åˆ›å»º Canvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 2; // æé«˜æ¸…æ™°åº¦
                        
                        canvas.width = width * scale;
                        canvas.height = height * scale;
                        
                        // è®¾ç½®ç™½è‰²èƒŒæ™¯
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // å°† SVG åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²å¹¶åˆ›å»º data URI
                        const clone = svgElementInDom.cloneNode(true);
                        if (!clone.getAttribute('xmlns')) {
                            clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                        }
                        // ç¡®ä¿æœ‰æ˜ç¡®çš„å®½é«˜
                        if (!clone.getAttribute('width')) {
                            clone.setAttribute('width', width.toString());
                        }
                        if (!clone.getAttribute('height')) {
                            clone.setAttribute('height', height.toString());
                        }
                        
                        const clonedSvgString = new XMLSerializer().serializeToString(clone);
                        const svgDataUri = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(clonedSvgString);
                        
                        // åˆ›å»ºå›¾ç‰‡å¹¶ç»˜åˆ¶
                        const img = new Image();
                        img.onload = () => {
                            try {
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                canvas.toBlob((blob) => {
                                    if (blob) {
                                        resolve(blob);
                                    } else {
                                        // å¦‚æœ DOM æ–¹æ³•å¤±è´¥ï¼Œå›é€€åˆ°å­—ç¬¦ä¸²æ–¹æ³•
                                        tryStringMethod(svgString, width, height, resolve, reject);
                                    }
                                }, 'image/png');
                            } catch (error) {
                                // å¦‚æœ DOM æ–¹æ³•å¤±è´¥ï¼Œå›é€€åˆ°å­—ç¬¦ä¸²æ–¹æ³•
                                tryStringMethod(svgString, width, height, resolve, reject);
                            }
                        };
                        img.onerror = () => {
                            // å¦‚æœ DOM æ–¹æ³•å¤±è´¥ï¼Œå›é€€åˆ°å­—ç¬¦ä¸²æ–¹æ³•
                            tryStringMethod(svgString, width, height, resolve, reject);
                        };
                        img.src = svgDataUri;
                        return; // æˆåŠŸå¯åŠ¨ DOM æ–¹æ³•ï¼Œé€€å‡º
                    } catch (error) {
                        // DOM æ–¹æ³•å‡ºé”™ï¼Œç»§ç»­å°è¯•å­—ç¬¦ä¸²æ–¹æ³•
                        console.warn('ä» DOM ç»˜åˆ¶ SVG å¤±è´¥ï¼Œå°è¯•å­—ç¬¦ä¸²æ–¹æ³•:', error);
                    }
                }
                
                // æ–¹æ³•2: ä½¿ç”¨ SVG å­—ç¬¦ä¸²ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
                tryStringMethod(svgString, null, null, resolve, reject);
            });
            
            // è¾…åŠ©å‡½æ•°ï¼šå°è¯•ä½¿ç”¨ SVG å­—ç¬¦ä¸²æ–¹æ³•
            function tryStringMethod(svgString, preferredWidth, preferredHeight, resolve, reject) {
                try {
                    // ç¡®ä¿ SVG å­—ç¬¦ä¸²ä¸ä¸ºç©º
                    if (!svgString || typeof svgString !== 'string') {
                        reject(new Error('SVG å†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆ'));
                        return;
                    }

                    // è§£æ SVG å­—ç¬¦ä¸²ä»¥è·å–å°ºå¯¸ä¿¡æ¯
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
                    
                    // æ£€æŸ¥è§£æé”™è¯¯
                    const parserError = svgDoc.querySelector('parsererror');
                    if (parserError) {
                        reject(new Error('SVG æ ¼å¼é”™è¯¯: ' + parserError.textContent));
                        return;
                    }
                    
                    const svgElement = svgDoc.documentElement;
                    
                    // ç¡®ä¿ SVG æœ‰æ­£ç¡®çš„å‘½åç©ºé—´
                    if (!svgElement.getAttribute('xmlns')) {
                        svgElement.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                    }
                    
                    // è·å– SVG çš„å®½é«˜
                    let width = preferredWidth || svgElement.getAttribute('width');
                    let height = preferredHeight || svgElement.getAttribute('height');
                    
                    // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„å®½é«˜ï¼Œå°è¯•ä» viewBox è·å–
                    if (!width || !height) {
                        const viewBox = svgElement.getAttribute('viewBox');
                        if (viewBox) {
                            const parts = viewBox.split(/\s+/);
                            if (parts.length >= 4) {
                                width = parts[2];
                                height = parts[3];
                            }
                        }
                    }
                    
                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œä½¿ç”¨é»˜è®¤å€¼æˆ–ä»å®é™…æ¸²æŸ“çš„å…ƒç´ è·å–
                    if (!width || !height || width === '0' || height === '0') {
                        const svgElementInDom = mermaidDiv.querySelector('svg');
                        if (svgElementInDom) {
                            try {
                                const bbox = svgElementInDom.getBBox();
                                width = bbox.width || '800';
                                height = bbox.height || '600';
                            } catch (e) {
                                width = '800';
                                height = '600';
                            }
                        } else {
                            width = '800';
                            height = '600';
                        }
                    }
                    
                    // ç§»é™¤å•ä½ï¼ˆpx, em ç­‰ï¼‰ï¼Œåªä¿ç•™æ•°å­—
                    width = parseFloat(width) || 800;
                    height = parseFloat(height) || 600;
                    
                    // ç¡®ä¿å®½é«˜æœ‰æ•ˆ
                    if (width <= 0 || height <= 0 || !isFinite(width) || !isFinite(height)) {
                        width = 800;
                        height = 600;
                    }
                    
                    // é‡æ–°åºåˆ—åŒ– SVGï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
                    const serializer = new XMLSerializer();
                    let finalSvgString = serializer.serializeToString(svgElement);
                    
                    // å¦‚æœ SVG æ²¡æœ‰æ˜ç¡®çš„å®½é«˜ï¼Œåœ¨åŠ è½½å‰è®¾ç½®
                    if (!svgElement.getAttribute('width') || !svgElement.getAttribute('height')) {
                        finalSvgString = finalSvgString.replace(
                            /<svg([^>]*)>/,
                            `<svg$1 width="${width}" height="${height}">`
                        );
                    }
                    
                    // ä½¿ç”¨ data URI
                    const svgDataUri = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(finalSvgString);
                    
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    // è®¾ç½®è¶…æ—¶å¤„ç†
                    const timeout = setTimeout(() => {
                        reject(new Error('åŠ è½½ SVG è¶…æ—¶'));
                    }, 10000); // 10ç§’è¶…æ—¶
                    
                    img.onload = () => {
                        clearTimeout(timeout);
                        try {
                            // åˆ›å»º Canvas
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // è®¾ç½® Canvas å°ºå¯¸ï¼ˆå¯ä»¥è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ï¼Œé»˜è®¤ 2x æé«˜æ¸…æ™°åº¦ï¼‰
                            const scale = 2;
                            // ä½¿ç”¨å®é™…å›¾ç‰‡å°ºå¯¸æˆ–è§£æçš„å°ºå¯¸
                            const finalWidth = (img.width && img.width > 0) ? img.width : width;
                            const finalHeight = (img.height && img.height > 0) ? img.height : height;
                            
                            canvas.width = finalWidth * scale;
                            canvas.height = finalHeight * scale;
                            
                            // è®¾ç½®ç™½è‰²èƒŒæ™¯ï¼ˆPNG éœ€è¦èƒŒæ™¯è‰²ï¼‰
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            // ç»˜åˆ¶å›¾ç‰‡åˆ° Canvas
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // è½¬æ¢ä¸º PNG
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('Canvas è½¬æ¢å¤±è´¥'));
                                }
                            }, 'image/png');
                        } catch (error) {
                            reject(new Error('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™: ' + error.message));
                        }
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timeout);
                        // æœ€åå°è¯•ä½¿ç”¨ Blob URL
                        try {
                            const svgBlob = new Blob([finalSvgString], { type: 'image/svg+xml;charset=utf-8' });
                            const svgUrl = URL.createObjectURL(svgBlob);
                            
                            const img2 = new Image();
                            img2.crossOrigin = 'anonymous';
                            
                            const timeout2 = setTimeout(() => {
                                URL.revokeObjectURL(svgUrl);
                                reject(new Error('åŠ è½½ SVG è¶…æ—¶ï¼ˆä½¿ç”¨ Blob URLï¼‰'));
                            }, 10000);
                            
                            img2.onload = () => {
                                clearTimeout(timeout2);
                                try {
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    const scale = 2;
                                    const finalWidth = (img2.width && img2.width > 0) ? img2.width : width;
                                    const finalHeight = (img2.height && img2.height > 0) ? img2.height : height;
                                    
                                    canvas.width = finalWidth * scale;
                                    canvas.height = finalHeight * scale;
                                    
                                    ctx.fillStyle = '#ffffff';
                                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                                    ctx.drawImage(img2, 0, 0, canvas.width, canvas.height);
                                    
                                    canvas.toBlob((blob) => {
                                        URL.revokeObjectURL(svgUrl);
                                        if (blob) {
                                            resolve(blob);
                                        } else {
                                            reject(new Error('Canvas è½¬æ¢å¤±è´¥'));
                                        }
                                    }, 'image/png');
                                } catch (error) {
                                    URL.revokeObjectURL(svgUrl);
                                    reject(new Error('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™: ' + error.message));
                                }
                            };
                            
                            img2.onerror = () => {
                                clearTimeout(timeout2);
                                URL.revokeObjectURL(svgUrl);
                                reject(new Error('åŠ è½½ SVG å›¾ç‰‡å¤±è´¥ï¼šå¯èƒ½æ˜¯ SVG æ ¼å¼é—®é¢˜æˆ–åŒ…å«æ— æ³•åŠ è½½çš„å¤–éƒ¨èµ„æºã€‚è¯·ç¡®ä¿ SVG ä¸åŒ…å«å¤–éƒ¨å›¾ç‰‡é“¾æ¥ã€‚'));
                            };
                            
                            img2.src = svgUrl;
                        } catch (error) {
                            reject(new Error('åŠ è½½ SVG å›¾ç‰‡å¤±è´¥: ' + error.message));
                        }
                    };
                    
                    img.src = svgDataUri;
                } catch (error) {
                    reject(new Error('å¤„ç† SVG æ—¶å‡ºé”™: ' + error.message));
                }
            }
        };

        // ä¸‹è½½ PNG æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        downloadPngButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            e.preventDefault();
            
            try {
                const svg = await getSvgContent();

                if (svg) {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    downloadPngButton.innerHTML = 'â³';
                    downloadPngButton.style.cursor = 'wait';
                    
                    // è½¬æ¢ä¸º PNG
                    const pngBlob = await svgToPng(svg);
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const url = URL.createObjectURL(pngBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `mermaid-diagram-${Date.now()}.png`;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    downloadPngButton.innerHTML = 'âœ“';
                    downloadPngButton.style.background = 'rgba(76, 175, 80, 0.3) !important';
                    downloadPngButton.style.cursor = 'pointer';
                    setTimeout(() => {
                        downloadPngButton.innerHTML = 'ğŸ–¼ï¸';
                        downloadPngButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
                    }, 1000);
                } else {
                    throw new Error('æ— æ³•è·å– SVG å†…å®¹');
                }
            } catch (error) {
                console.error('ä¸‹è½½ PNG å¤±è´¥:', error);
                downloadPngButton.innerHTML = 'âœ—';
                downloadPngButton.style.background = 'rgba(244, 67, 54, 0.3) !important';
                downloadPngButton.style.cursor = 'pointer';
                setTimeout(() => {
                    downloadPngButton.innerHTML = 'ğŸ–¼ï¸';
                    downloadPngButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
                }, 1000);
            }
        });

        // ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ Mermaid Live Editor
        editButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            e.preventDefault();
            
            try {
                // è·å– Mermaid æºä»£ç 
                const codeToEdit = mermaidSourceCode || mermaidDiv.getAttribute('data-mermaid-source') || '';
                
                if (!codeToEdit || !codeToEdit.trim()) {
                    // å¦‚æœæ²¡æœ‰æºä»£ç ï¼Œç›´æ¥æ‰“å¼€ç¼–è¾‘å™¨
                    window.open('https://mermaid.live/edit', '_blank');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const originalHTML = editButton.innerHTML;
                editButton.innerHTML = 'â³';
                editButton.style.cursor = 'wait';

                // åŒæ—¶ä½¿ç”¨å¤šç§æ–¹å¼ä¼ é€’ä»£ç ï¼Œæé«˜æˆåŠŸç‡
                let urlOpened = false;
                let clipboardSuccess = false;

                // æ–¹å¼1: ä¼˜å…ˆå°†ä»£ç å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆæœ€å¯é çš„æ–¹å¼ï¼‰
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(codeToEdit);
                        clipboardSuccess = true;
                        console.log('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }
                } catch (clipboardError) {
                    console.warn('å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥ï¼Œå°è¯• fallback æ–¹æ³•:', clipboardError);
                    // å¦‚æœ Clipboard API å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ fallback æ–¹æ³•
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = codeToEdit;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        textArea.style.left = '-9999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) {
                            clipboardSuccess = true;
                            console.log('ä»£ç å·²é€šè¿‡ fallback æ–¹æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿');
                        }
                    } catch (fallbackError) {
                        console.error('Fallback å¤åˆ¶æ–¹æ³•ä¹Ÿå¤±è´¥:', fallbackError);
                    }
                }

                // æ–¹å¼2: å°è¯•é€šè¿‡ URL ä¼ é€’ä»£ç ï¼ˆå¤šç§æ ¼å¼å°è¯•ï¼‰
                const urlFormats = [];
                
                // æ ¼å¼1: state å‚æ•°ï¼ˆJSON å¯¹è±¡ base64 ç¼–ç ï¼‰
                try {
                    const stateObj = {
                        code: codeToEdit,
                        mermaid: { theme: 'default' }
                    };
                    const stateJson = JSON.stringify(stateObj);
                    const stateBase64 = btoa(unescape(encodeURIComponent(stateJson)));
                    urlFormats.push(`https://mermaid.live/edit#state/${stateBase64}`);
                } catch (e) {
                    console.warn('ç”Ÿæˆ state æ ¼å¼ URL å¤±è´¥:', e);
                }
                
                // æ ¼å¼2: code å‚æ•°ï¼ˆä»£ç ç›´æ¥ base64 ç¼–ç ï¼‰
                try {
                    const codeBase64 = btoa(unescape(encodeURIComponent(codeToEdit)));
                    urlFormats.push(`https://mermaid.live/edit#code/${codeBase64}`);
                } catch (e) {
                    console.warn('ç”Ÿæˆ code æ ¼å¼ URL å¤±è´¥:', e);
                }
                
                // æ ¼å¼3: æŸ¥è¯¢å‚æ•°æ–¹å¼
                try {
                    const encodedCode = encodeURIComponent(codeToEdit);
                    urlFormats.push(`https://mermaid.live/edit?code=${encodedCode}`);
                } catch (e) {
                    console.warn('ç”ŸæˆæŸ¥è¯¢å‚æ•° URL å¤±è´¥:', e);
                }

                // å°è¯•æ‰“å¼€ç¼–è¾‘å™¨ï¼ˆä½¿ç”¨å¤šç§ URL æ ¼å¼ï¼‰
                for (const editorUrl of urlFormats) {
                    try {
                        const newWindow = window.open(editorUrl, '_blank');
                        if (newWindow) {
                            urlOpened = true;
                            console.log('Mermaid Live Editor å·²æ‰“å¼€ï¼Œå°è¯•é€šè¿‡ URL ä¼ é€’ä»£ç ');
                            break; // æˆåŠŸæ‰“å¼€åå°±åœæ­¢å°è¯•
                        }
                    } catch (error) {
                        console.warn('æ‰“å¼€ç¼–è¾‘å™¨å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª URL æ ¼å¼:', error);
                    }
                }

                // å¦‚æœæ‰€æœ‰ URL æ ¼å¼éƒ½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸºç¡€ URL
                if (!urlOpened) {
                    try {
                        const newWindow = window.open('https://mermaid.live/edit', '_blank');
                        urlOpened = !!newWindow;
                        if (urlOpened) {
                            console.log('Mermaid Live Editor å·²æ‰“å¼€ï¼ˆä»£ç å·²åœ¨å‰ªè´´æ¿ä¸­ï¼‰');
                        }
                    } catch (error) {
                        console.error('æ‰“å¼€ç¼–è¾‘å™¨çª—å£å¤±è´¥:', error);
                    }
                }


                // æ˜¾ç¤ºæˆåŠŸæç¤º
                setTimeout(() => {
                    // æ ¹æ®ç»“æœæ˜¾ç¤ºä¸åŒçš„æç¤º
                    let tipMessage = '';
                    if (clipboardSuccess && urlOpened) {
                        tipMessage = 'âœ“ ç¼–è¾‘å™¨å·²æ‰“å¼€ï¼Œä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
                    } else if (clipboardSuccess) {
                        tipMessage = 'âœ“ ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·åœ¨æ–°æ‰“å¼€çš„ç¼–è¾‘å™¨ä¸­ç²˜è´´';
                    } else if (urlOpened) {
                        tipMessage = 'âœ“ ç¼–è¾‘å™¨å·²æ‰“å¼€';
                    } else {
                        tipMessage = 'âš ï¸ ç¼–è¾‘å™¨å·²æ‰“å¼€ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»£ç ';
                    }

                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    if (clipboardSuccess || urlOpened) {
                        editButton.innerHTML = 'âœ“';
                        editButton.style.background = clipboardSuccess ? 'rgba(76, 175, 80, 0.3) !important' : 'rgba(255, 193, 7, 0.3) !important';
                    }
                    
                    // åˆ›å»ºä¸´æ—¶æç¤ºï¼ˆä»…åœ¨æˆåŠŸå¤åˆ¶æˆ–æ‰“å¼€æ—¶æ˜¾ç¤ºï¼‰
                    if (clipboardSuccess || urlOpened) {
                        const tip = document.createElement('div');
                        tip.textContent = tipMessage;
                        tip.style.cssText = `
                            position: fixed !important;
                            top: 50% !important;
                            left: 50% !important;
                            transform: translate(-50%, -50%) !important;
                            background: rgba(0, 0, 0, 0.85) !important;
                            color: white !important;
                            padding: 14px 28px !important;
                            border-radius: 8px !important;
                            font-size: 14px !important;
                            z-index: 10000 !important;
                            pointer-events: none !important;
                            animation: fadeInOut 2.5s ease-in-out !important;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
                            max-width: 90% !important;
                            text-align: center !important;
                            word-wrap: break-word !important;
                        `;
                        
                        // æ·»åŠ åŠ¨ç”»æ ·å¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                        if (!document.getElementById('mermaid-tip-styles')) {
                            const style = document.createElement('style');
                            style.id = 'mermaid-tip-styles';
                            style.textContent = `
                                @keyframes fadeInOut {
                                    0%, 100% { opacity: 0; transform: translate(-50%, -50%) translateY(-10px); }
                                    10%, 90% { opacity: 1; transform: translate(-50%, -50%) translateY(0); }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        document.body.appendChild(tip);
                        setTimeout(() => {
                            if (tip.parentNode) {
                                tip.parentNode.removeChild(tip);
                            }
                        }, 2500);
                    }
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    setTimeout(() => {
                        editButton.innerHTML = originalHTML;
                        editButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
                        editButton.style.cursor = 'pointer';
                    }, 2000);
                }, 100);

            } catch (error) {
                console.error('æ‰“å¼€ Mermaid Live Editor å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä»å°è¯•æ‰“å¼€ç¼–è¾‘å™¨
                try {
                    window.open('https://mermaid.live/edit', '_blank');
                } catch (openError) {
                    console.error('æ— æ³•æ‰“å¼€ç¼–è¾‘å™¨çª—å£:', openError);
                }
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    editButton.innerHTML = 'âœï¸';
                    editButton.style.cursor = 'pointer';
                }, 1000);
            }
        });

        // åˆ›å»ºå…¨å±æŒ‰é’®
        const fullscreenButton = document.createElement('button');
        fullscreenButton.className = 'mermaid-fullscreen-button';
        fullscreenButton.title = 'å…¨å±æŸ¥çœ‹';
        fullscreenButton.innerHTML = 'â›¶';
        fullscreenButton.style.cssText = `
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            border-radius: 4px !important;
            width: 28px !important;
            height: 28px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: all 0.2s ease !important;
            opacity: 0.8 !important;
            backdrop-filter: blur(4px) !important;
        `;

        // å…¨å±æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        fullscreenButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            e.preventDefault();
            this.openMermaidFullscreen(mermaidDiv, mermaidSourceCode);
        });

        // æ‚¬åœæ˜¾ç¤ºæŒ‰é’®
        mermaidDiv.addEventListener('mouseenter', () => {
            actionsContainer.style.opacity = '1';
        });
        mermaidDiv.addEventListener('mouseleave', () => {
            actionsContainer.style.opacity = '0';
        });

        actionsContainer.appendChild(copyButton);
        actionsContainer.appendChild(downloadButton);
        actionsContainer.appendChild(downloadPngButton);
        actionsContainer.appendChild(editButton);
        actionsContainer.appendChild(fullscreenButton);
        mermaidDiv.appendChild(actionsContainer);

        // æŒ‰é’®æ‚¬åœæ•ˆæœ
        copyButton.addEventListener('mouseenter', () => {
            copyButton.style.background = 'rgba(255, 255, 255, 0.3) !important';
            copyButton.style.transform = 'scale(1.1)';
            copyButton.style.opacity = '1';
        });
        copyButton.addEventListener('mouseleave', () => {
            copyButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
            copyButton.style.transform = 'scale(1)';
            copyButton.style.opacity = '0.8';
        });

        downloadButton.addEventListener('mouseenter', () => {
            downloadButton.style.background = 'rgba(255, 255, 255, 0.3) !important';
            downloadButton.style.transform = 'scale(1.1)';
            downloadButton.style.opacity = '1';
        });
        downloadButton.addEventListener('mouseleave', () => {
            downloadButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
            downloadButton.style.transform = 'scale(1)';
            downloadButton.style.opacity = '0.8';
        });

        downloadPngButton.addEventListener('mouseenter', () => {
            downloadPngButton.style.background = 'rgba(255, 255, 255, 0.3) !important';
            downloadPngButton.style.transform = 'scale(1.1)';
            downloadPngButton.style.opacity = '1';
        });
        downloadPngButton.addEventListener('mouseleave', () => {
            downloadPngButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
            downloadPngButton.style.transform = 'scale(1)';
            downloadPngButton.style.opacity = '0.8';
        });

        editButton.addEventListener('mouseenter', () => {
            editButton.style.background = 'rgba(255, 255, 255, 0.3) !important';
            editButton.style.transform = 'scale(1.1)';
            editButton.style.opacity = '1';
        });
        editButton.addEventListener('mouseleave', () => {
            editButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
            editButton.style.transform = 'scale(1)';
            editButton.style.opacity = '0.8';
        });

        fullscreenButton.addEventListener('mouseenter', () => {
            fullscreenButton.style.background = 'rgba(255, 255, 255, 0.3) !important';
            fullscreenButton.style.transform = 'scale(1.1)';
            fullscreenButton.style.opacity = '1';
        });
        fullscreenButton.addEventListener('mouseleave', () => {
            fullscreenButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
            fullscreenButton.style.transform = 'scale(1)';
            fullscreenButton.style.opacity = '0.8';
        });
    }

    // æ‰“å¼€ Mermaid å›¾è¡¨å…¨å±æŸ¥çœ‹
    openMermaidFullscreen(mermaidDiv, mermaidSourceCode) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å…¨å±å®¹å™¨
        const existingFullscreen = document.getElementById('mermaid-fullscreen-container');
        if (existingFullscreen) {
            existingFullscreen.remove();
        }

        // è·å–èŠå¤©çª—å£
        const chatWindow = document.getElementById('pet-chat-window');
        if (!chatWindow) {
            console.error('æ‰¾ä¸åˆ°èŠå¤©çª—å£');
            return;
        }

        // è·å–èŠå¤©çª—å£çš„ä½ç½®å’Œå°ºå¯¸
        const chatRect = chatWindow.getBoundingClientRect();

        // åˆ›å»ºå…¨å±å®¹å™¨
        const fullscreenContainer = document.createElement('div');
        fullscreenContainer.id = 'mermaid-fullscreen-container';
        // ä½¿ç”¨æ¯”èŠå¤©çª—å£æ›´é«˜çš„ z-indexï¼ˆèŠå¤©çª—å£æ˜¯ 2147483648ï¼‰
        const fullscreenZIndex = 2147483649;
        fullscreenContainer.style.cssText = `
            position: fixed !important;
            top: ${chatRect.top}px !important;
            left: ${chatRect.left}px !important;
            width: ${chatRect.width}px !important;
            height: ${chatRect.height}px !important;
            background: rgba(0, 0, 0, 0.95) !important;
            z-index: ${fullscreenZIndex} !important;
            display: flex !important;
            flex-direction: column !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5) !important;
        `;

        // åˆ›å»ºå¤´éƒ¨æ ï¼ˆåŒ…å«å…³é—­æŒ‰é’®ï¼‰
        const headerBar = document.createElement('div');
        headerBar.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 10px 15px !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            flex-shrink: 0 !important;
        `;

        const title = document.createElement('div');
        title.textContent = 'Mermaid å›¾è¡¨å…¨å±æŸ¥çœ‹';
        title.style.cssText = `
            color: white !important;
            font-size: 14px !important;
            font-weight: 500 !important;
        `;

        const closeButton = document.createElement('button');
        closeButton.innerHTML = 'âœ•';
        closeButton.title = 'å…³é—­å…¨å±';
        closeButton.style.cssText = `
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            color: white !important;
            font-size: 18px !important;
            cursor: pointer !important;
            width: 28px !important;
            height: 28px !important;
            border-radius: 4px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
        `;
        closeButton.addEventListener('click', () => {
            fullscreenContainer.remove();
        });
        closeButton.addEventListener('mouseenter', () => {
            closeButton.style.background = 'rgba(255, 255, 255, 0.3) !important';
        });
        closeButton.addEventListener('mouseleave', () => {
            closeButton.style.background = 'rgba(255, 255, 255, 0.2) !important';
        });

        headerBar.appendChild(title);
        headerBar.appendChild(closeButton);

        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const contentArea = document.createElement('div');
        contentArea.style.cssText = `
            flex: 1 !important;
            overflow: hidden !important;
            display: flex !important;
            align-items: stretch !important;
            justify-content: stretch !important;
            padding: 0 !important;
            position: relative !important;
        `;

        // å…‹éš† mermaid å›¾è¡¨
        const clonedMermaid = mermaidDiv.cloneNode(true);
        clonedMermaid.style.cssText = `
            width: 100% !important;
            height: 100% !important;
            min-width: 0 !important;
            min-height: 0 !important;
            background: rgba(255, 255, 255, 0.1) !important;
            padding: 20px !important;
            border-radius: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
        `;

        // ç§»é™¤å…‹éš†å…ƒç´ ä¸­çš„æ“ä½œæŒ‰é’®
        const clonedActions = clonedMermaid.querySelector('.mermaid-actions');
        if (clonedActions) {
            clonedActions.remove();
        }

        // è°ƒæ•´ SVG æ ·å¼ä½¿å…¶è‡ªé€‚åº”
        const adjustSvgSize = () => {
            const svg = clonedMermaid.querySelector('svg');
            if (svg) {
                svg.style.cssText = `
                    width: 100% !important;
                    height: 100% !important;
                    max-width: 100% !important;
                    max-height: 100% !important;
                `;
                // ç¡®ä¿ SVG æœ‰ viewBox å±æ€§ä»¥ä¾¿è‡ªé€‚åº”
                if (!svg.getAttribute('viewBox') && svg.getAttribute('width') && svg.getAttribute('height')) {
                    const width = svg.getAttribute('width');
                    const height = svg.getAttribute('height');
                    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                    svg.removeAttribute('width');
                    svg.removeAttribute('height');
                }
            }
        };

        contentArea.appendChild(clonedMermaid);

        // ç»„è£…å…¨å±å®¹å™¨
        fullscreenContainer.appendChild(headerBar);
        fullscreenContainer.appendChild(contentArea);

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(fullscreenContainer);

        // æ·»åŠ å››ä¸ªè§’çš„æ‹–æ‹½è°ƒæ•´å¤§å°åŠŸèƒ½
        this.addResizeHandles(fullscreenContainer, chatWindow);

        // é‡æ–°æ¸²æŸ“ mermaidï¼ˆå¦‚æœéœ€è¦ï¼‰
        const clonedMermaidId = clonedMermaid.id || `mermaid-fullscreen-${Date.now()}`;
        clonedMermaid.id = clonedMermaidId;
        
        // å¦‚æœå…‹éš†çš„å›¾è¡¨è¿˜æ²¡æœ‰æ¸²æŸ“ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“
        if (!clonedMermaid.querySelector('svg')) {
            const mermaidContent = mermaidSourceCode || clonedMermaid.getAttribute('data-mermaid-source') || clonedMermaid.textContent || '';
            if (mermaidContent.trim()) {
                clonedMermaid.textContent = mermaidContent;
                clonedMermaid.className = 'mermaid';
                
                // ä½¿ç”¨æ³¨å…¥è„šæœ¬é‡æ–°æ¸²æŸ“
                const renderIdContainer = document.createElement('div');
                renderIdContainer.id = `__mermaid_render_id_container__${clonedMermaidId}`;
                renderIdContainer.setAttribute('data-mermaid-id', clonedMermaidId);
                renderIdContainer.style.display = 'none';
                document.body.appendChild(renderIdContainer);

                const handleRender = (event) => {
                    if (event.detail.id === clonedMermaidId) {
                        window.removeEventListener('mermaid-rendered', handleRender);
                        renderIdContainer.remove();
                        // æ¸²æŸ“å®Œæˆåè°ƒæ•´ SVG å¤§å°
                        setTimeout(() => {
                            adjustSvgSize();
                        }, 100);
                    }
                };
                window.addEventListener('mermaid-rendered', handleRender);

                setTimeout(() => {
                    const renderScript = document.createElement('script');
                    renderScript.src = chrome.runtime.getURL('render-mermaid.js');
                    renderScript.onload = () => {
                        if (renderScript.parentNode) {
                            renderScript.parentNode.removeChild(renderScript);
                        }
                    };
                    document.documentElement.appendChild(renderScript);
                }, 100);
            }
        } else {
            // å¦‚æœå·²ç»æœ‰ SVGï¼Œç«‹å³è°ƒæ•´å¤§å°
            setTimeout(() => {
                adjustSvgSize();
            }, 100);
        }

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–å’Œå®¹å™¨å¤§å°å˜åŒ–ï¼Œè‡ªé€‚åº”è°ƒæ•´å›¾è¡¨
        const resizeObserver = new ResizeObserver(() => {
            adjustSvgSize();
        });
        resizeObserver.observe(fullscreenContainer);
        resizeObserver.observe(contentArea);
        
        // å½“å…¨å±å®¹å™¨è¢«ç§»é™¤æ—¶ï¼Œæ¸…ç†è§‚å¯Ÿè€…
        const originalRemove = fullscreenContainer.remove.bind(fullscreenContainer);
        fullscreenContainer.remove = function() {
            resizeObserver.disconnect();
            originalRemove();
        };
    }

    // æ·»åŠ å››ä¸ªè§’çš„æ‹–æ‹½è°ƒæ•´å¤§å°åŠŸèƒ½
    addResizeHandles(container, chatWindow) {
        const handles = ['nw', 'ne', 'sw', 'se']; // å››ä¸ªè§’ï¼šå·¦ä¸Šã€å³ä¸Šã€å·¦ä¸‹ã€å³ä¸‹
        const handleSize = 12;
        let isResizing = false;
        let resizeHandle = null;
        let startX = 0;
        let startY = 0;
        let startWidth = 0;
        let startHeight = 0;
        let startLeft = 0;
        let startTop = 0;

        handles.forEach(position => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${position}`;
            handle.style.cssText = `
                position: absolute !important;
                width: ${handleSize}px !important;
                height: ${handleSize}px !important;
                background: rgba(255, 255, 255, 0.3) !important;
                border: 2px solid rgba(255, 255, 255, 0.6) !important;
                border-radius: 2px !important;
                cursor: ${this.getResizeCursor(position)} !important;
                z-index: 1000 !important;
                transition: all 0.2s ease !important;
            `;

            // è®¾ç½®ä½ç½®
            switch(position) {
                case 'nw': // å·¦ä¸Š
                    handle.style.top = '0';
                    handle.style.left = '0';
                    break;
                case 'ne': // å³ä¸Š
                    handle.style.top = '0';
                    handle.style.right = '0';
                    break;
                case 'sw': // å·¦ä¸‹
                    handle.style.bottom = '0';
                    handle.style.left = '0';
                    break;
                case 'se': // å³ä¸‹
                    handle.style.bottom = '0';
                    handle.style.right = '0';
                    break;
            }

            // é¼ æ ‡æ‚¬åœæ•ˆæœ
            handle.addEventListener('mouseenter', () => {
                handle.style.background = 'rgba(255, 255, 255, 0.5) !important';
                handle.style.borderColor = 'rgba(255, 255, 255, 0.9) !important';
                handle.style.transform = 'scale(1.2)';
            });
            handle.addEventListener('mouseleave', () => {
                if (!isResizing) {
                    handle.style.background = 'rgba(255, 255, 255, 0.3) !important';
                    handle.style.borderColor = 'rgba(255, 255, 255, 0.6) !important';
                    handle.style.transform = 'scale(1)';
                }
            });

            // é¼ æ ‡æŒ‰ä¸‹å¼€å§‹è°ƒæ•´å¤§å°
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                isResizing = true;
                resizeHandle = position;
                startX = e.clientX;
                startY = e.clientY;
                const rect = container.getBoundingClientRect();
                startWidth = rect.width;
                startHeight = rect.height;
                startLeft = rect.left;
                startTop = rect.top;

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            container.appendChild(handle);
        });

        const handleMouseMove = (e) => {
            if (!isResizing || !resizeHandle) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            const chatRect = chatWindow.getBoundingClientRect();
            const minWidth = 300;
            const minHeight = 200;
            const maxWidth = window.innerWidth;
            const maxHeight = window.innerHeight;

            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = startLeft;
            let newTop = startTop;

            switch(resizeHandle) {
                case 'nw': // å·¦ä¸Šè§’
                    newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth - deltaX));
                    newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight - deltaY));
                    newLeft = startLeft + (startWidth - newWidth);
                    newTop = startTop + (startHeight - newHeight);
                    break;
                case 'ne': // å³ä¸Šè§’
                    newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
                    newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight - deltaY));
                    newTop = startTop + (startHeight - newHeight);
                    break;
                case 'sw': // å·¦ä¸‹è§’
                    newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth - deltaX));
                    newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight + deltaY));
                    newLeft = startLeft + (startWidth - newWidth);
                    break;
                case 'se': // å³ä¸‹è§’
                    newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
                    newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight + deltaY));
                    break;
            }

            // ç¡®ä¿ä¸è¶…å‡ºçª—å£è¾¹ç•Œ
            newLeft = Math.max(0, Math.min(window.innerWidth - newWidth, newLeft));
            newTop = Math.max(0, Math.min(window.innerHeight - newHeight, newTop));

            container.style.width = `${newWidth}px`;
            container.style.height = `${newHeight}px`;
            container.style.left = `${newLeft}px`;
            container.style.top = `${newTop}px`;
            
            // è°ƒæ•´å¤§å°åï¼Œè§¦å‘å›¾è¡¨è‡ªé€‚åº”ï¼ˆResizeObserver ä¼šè‡ªåŠ¨å¤„ç†ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é˜²æŠ–ä¼˜åŒ–ï¼‰
        };

        const handleMouseUp = () => {
            isResizing = false;
            resizeHandle = null;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
    }

    // è·å–è°ƒæ•´å¤§å°çš„å…‰æ ‡æ ·å¼
    getResizeCursor(position) {
        switch(position) {
            case 'nw': return 'nw-resize';
            case 'ne': return 'ne-resize';
            case 'sw': return 'sw-resize';
            case 'se': return 'se-resize';
            default: return 'default';
        }
    }

    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    createMessageElement(text, sender, imageDataUrl = null, timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            display: flex !important;
            margin-bottom: 15px !important;
            animation: messageSlideIn 0.3s ease-out !important;
        `;

        if (sender === 'user') {
            messageDiv.style.flexDirection = 'row-reverse';
        }

        // è·å–å® ç‰©é¢œè‰²ç”¨äºå® ç‰©æ¶ˆæ¯
        const currentColor = this.colors[this.colorIndex];

        const avatar = document.createElement('div');
        avatar.style.cssText = `
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 16px !important;
            margin-right: 10px !important;
            flex-shrink: 0 !important;
            background: ${sender === 'user' ? 'linear-gradient(135deg, #2196F3, #1976D2)' : currentColor} !important;
        `;
        avatar.textContent = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¾';
        // æ·»åŠ æ ‡è¯†ä»¥ä¾¿åç»­æ›´æ–°
        if (sender === 'pet') {
            avatar.setAttribute('data-message-type', 'pet-avatar');
        }

        if (sender === 'user') {
            avatar.style.marginRight = '0';
            avatar.style.marginLeft = '10px';
        }

        const content = document.createElement('div');
        content.style.cssText = `
            flex: 1 !important;
            min-width: 0 !important;
        `;

        const messageText = document.createElement('div');
        messageText.style.cssText = `
            background: ${sender === 'user' ? 'linear-gradient(135deg, #2196F3, #1976D2)' : currentColor} !important;
            color: white !important;
            padding: 12px 16px !important;
            border-radius: 12px !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
            word-wrap: break-word !important;
            position: relative !important;
            max-width: 80% !important;
            width: 100% !important;
            margin-left: ${sender === 'user' ? 'auto' : '0'} !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            overflow: hidden !important;
        `;

        // ä¸ºå® ç‰©æ¶ˆæ¯å’Œç”¨æˆ·æ¶ˆæ¯æ·»åŠ  Markdown æ ·å¼
        if (sender === 'pet' || sender === 'user') {
            messageText.classList.add('markdown-content');
        }

        // æ·»åŠ æ ‡è¯†ä»¥ä¾¿åç»­æ›´æ–°
        if (sender === 'pet') {
            messageText.setAttribute('data-message-type', 'pet-bubble');
        } else {
            messageText.setAttribute('data-message-type', 'user-bubble');
        }

        // ä¸ºæ¶ˆæ¯ä¿å­˜åŸå§‹æ–‡æœ¬ç”¨äºå¤åˆ¶å’Œç¼–è¾‘åŠŸèƒ½
        if (text) {
            if (sender === 'pet') {
                messageText.setAttribute('data-original-text', text);
            } else {
                // ç”¨æˆ·æ¶ˆæ¯ä¹Ÿä¿å­˜åŸå§‹æ–‡æœ¬ï¼Œç”¨äºç¼–è¾‘åŠŸèƒ½
                messageText.setAttribute('data-original-text', text);
            }
        }

        if (sender === 'user') {
            messageText.style.borderBottomRightRadius = '4px';
        } else {
            messageText.style.borderBottomLeftRadius = '4px';
        }

        // å¦‚æœåŒ…å«å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡å…ƒç´ 
        if (imageDataUrl) {
            const imageContainer = document.createElement('div');
            imageContainer.style.cssText = `
                margin-bottom: ${text ? '8px' : '0'} !important;
                border-radius: 8px !important;
                overflow: hidden !important;
                max-width: 100% !important;
                width: 100% !important;
            `;

            const img = document.createElement('img');
            img.src = imageDataUrl;
            img.style.cssText = `
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                max-height: 300px !important;
                border-radius: 8px !important;
                display: block !important;
                cursor: pointer !important;
                object-fit: contain !important;
            `;

            // ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
            img.addEventListener('click', () => {
                this.showImagePreview(imageDataUrl);
            });

            imageContainer.appendChild(img);
            messageText.appendChild(imageContainer);
        }

        // å¦‚æœæœ‰æ–‡æœ¬ï¼Œæ·»åŠ æ–‡æœ¬ï¼ˆæ”¯æŒ Markdown æ¸²æŸ“ï¼‰
        if (text) {
            if (sender === 'pet') {
                // å¯¹äºå® ç‰©æ¶ˆæ¯ï¼Œä½¿ç”¨ Markdown æ¸²æŸ“
                const displayText = this.renderMarkdown(text);
                if (imageDataUrl) {
                    // å¦‚æœå·²ç»æ·»åŠ äº†å›¾ç‰‡ï¼Œåˆ™è¿½åŠ æ–‡æœ¬
                    const textSpan = document.createElement('span');
                    textSpan.innerHTML = displayText;
                    messageText.appendChild(textSpan);
                } else {
                    messageText.innerHTML = displayText;
                    // å¯¹äºå® ç‰©æ¶ˆæ¯ï¼Œå¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨
                    if (!messageText.hasAttribute('data-mermaid-processing')) {
                        messageText.setAttribute('data-mermaid-processing', 'true');
                        setTimeout(async () => {
                            await this.processMermaidBlocks(messageText);
                            messageText.removeAttribute('data-mermaid-processing');
                        }, 100);
                    }
                }
            } else {
                // å¯¹äºç”¨æˆ·æ¶ˆæ¯ï¼Œä½¿ç”¨ Markdown æ¸²æŸ“ï¼ˆä¸ pet æ¶ˆæ¯ä¸€è‡´ï¼‰
                const displayText = this.renderMarkdown(text);
                if (imageDataUrl) {
                    // å¦‚æœå·²ç»æ·»åŠ äº†å›¾ç‰‡ï¼Œåˆ™è¿½åŠ æ–‡æœ¬
                    const textSpan = document.createElement('span');
                    textSpan.innerHTML = displayText;
                    messageText.appendChild(textSpan);
                } else {
                    messageText.innerHTML = displayText;
                }
                // å¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨
                if (!messageText.hasAttribute('data-mermaid-processing')) {
                    messageText.setAttribute('data-mermaid-processing', 'true');
                    setTimeout(async () => {
                        try {
                            await this.loadMermaid();
                            const hasMermaidCode = messageText.querySelector('code.language-mermaid, code.language-mmd, pre code.language-mermaid, pre code.language-mmd, code[class*="mermaid"]');
                            if (hasMermaidCode) {
                                await this.processMermaidBlocks(messageText);
                            }
                        } catch (error) {
                            console.error('å¤„ç†ç”¨æˆ·æ¶ˆæ¯çš„ Mermaid å›¾è¡¨æ—¶å‡ºé”™:', error);
                        }
                        messageText.removeAttribute('data-mermaid-processing');
                    }, 100);
                }
            }
        } else if (imageDataUrl) {
            // å¦‚æœæ²¡æœ‰æ–‡æœ¬åªæœ‰å›¾ç‰‡ï¼Œä¿æŒå®¹å™¨ä¸ºç©º
            messageText.style.padding = '0';
        }

        const messageTime = document.createElement('div');
        messageTime.setAttribute('data-message-time', 'true');
        messageTime.style.cssText = `
            font-size: 11px !important;
            color: #999 !important;
            margin-top: 4px !important;
        `;
        // å¦‚æœæœ‰æ—¶é—´æˆ³ï¼Œä½¿ç”¨æ—¶é—´æˆ³ï¼›å¦åˆ™ä½¿ç”¨å½“å‰æ—¶é—´
        messageTime.textContent = timestamp ? this.formatTimestamp(timestamp) : this.getCurrentTime();

        content.appendChild(messageText);

        // ä¸ºå® ç‰©æ¶ˆæ¯åˆ›å»ºæ—¶é—´å’Œå¤åˆ¶æŒ‰é’®çš„å®¹å™¨
        if (sender === 'pet') {
            const timeAndCopyContainer = document.createElement('div');
            timeAndCopyContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                max-width: calc(80% + 36px) !important;
                width: 100% !important;
                margin-top: 4px !important;
            `;

            const messageTimeWrapper = document.createElement('div');
            messageTimeWrapper.style.cssText = 'flex: 1;';
            messageTimeWrapper.appendChild(messageTime);
            timeAndCopyContainer.appendChild(messageTimeWrapper);

            const copyButtonContainer = document.createElement('div');
            copyButtonContainer.setAttribute('data-copy-button-container', 'true');
            copyButtonContainer.style.cssText = 'display: none; margin-left: 8px;';
            timeAndCopyContainer.appendChild(copyButtonContainer);

            // æ·»åŠ  try again æŒ‰é’®å®¹å™¨
            const tryAgainButtonContainer = document.createElement('div');
            tryAgainButtonContainer.setAttribute('data-try-again-button-container', 'true');
            tryAgainButtonContainer.style.cssText = 'display: none; margin-left: 8px; align-items: center;';
            timeAndCopyContainer.appendChild(tryAgainButtonContainer);

            content.appendChild(timeAndCopyContainer);

            // å¦‚æœå·²ç»æœ‰æ–‡æœ¬ï¼Œç«‹å³æ·»åŠ å¤åˆ¶æŒ‰é’®
            if (text && text.trim()) {
                this.addCopyButton(copyButtonContainer, messageText);
            }

            // ä¸ºå® ç‰©æ¶ˆæ¯æ·»åŠ å¯¼å‡ºå›¾ç‰‡æŒ‰é’®
            this.addExportButtonForMessage(copyButtonContainer, messageDiv, 'pet');

            // ä¸ºæ¶ˆæ¯å…ƒç´ æ·»åŠ æ ‡è¯†ï¼Œç”¨äºåç»­åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªæ¶ˆæ¯
            messageDiv.setAttribute('data-message-id', Date.now().toString());
        } else {
            // ç”¨æˆ·æ¶ˆæ¯åˆ›å»ºæ—¶é—´å’Œåˆ é™¤æŒ‰é’®çš„å®¹å™¨ï¼ˆä¸æ°”æ³¡å®½åº¦å¯¹é½ï¼‰
            const timeAndCopyContainer = document.createElement('div');
            timeAndCopyContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                max-width: 80% !important;
                width: 100% !important;
                margin-top: 4px !important;
                margin-left: auto !important;
                box-sizing: border-box !important;
            `;

            const messageTimeWrapper = document.createElement('div');
            messageTimeWrapper.style.cssText = `
                margin: 0 !important;
                padding: 0 !important;
                display: flex !important;
                align-items: flex-start !important;
            `;
            messageTime.style.cssText = `
                font-size: 11px !important;
                color: #999 !important;
                margin: 0 !important;
                padding: 0 !important;
            `;
            messageTimeWrapper.appendChild(messageTime);

            const copyButtonContainer = document.createElement('div');
            copyButtonContainer.setAttribute('data-copy-button-container', 'true');
            copyButtonContainer.style.cssText = 'display: flex;';
            timeAndCopyContainer.appendChild(copyButtonContainer);
            timeAndCopyContainer.appendChild(messageTimeWrapper);

            content.appendChild(timeAndCopyContainer);

            // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ å¤åˆ¶æŒ‰é’®ï¼ˆåŒ…æ‹¬å¤åˆ¶å’Œåˆ é™¤æŒ‰é’®ï¼‰
            if (text && text.trim()) {
                this.addCopyButton(copyButtonContainer, messageText);
            }
            
            // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ é™¤ã€ç¼–è¾‘å’Œé‡æ–°å‘é€æŒ‰é’®
            this.addDeleteButtonForUserMessage(copyButtonContainer, messageText);
            
            // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ å¯¼å‡ºå›¾ç‰‡æŒ‰é’®ï¼ˆåœ¨ç¼–è¾‘æŒ‰é’®åé¢ï¼‰
            this.addExportButtonForMessage(copyButtonContainer, messageDiv, 'user');
            
            // åŒæ­¥æ—¶é—´å®¹å™¨ä¸æ°”æ³¡çš„å®½åº¦å’Œä½ç½®ï¼Œç¡®ä¿ç²¾ç¡®å¯¹é½
            const syncTimeContainerAlignment = () => {
                // ä½¿ç”¨åŒé‡ requestAnimationFrame ç¡®ä¿ DOM å®Œå…¨æ¸²æŸ“
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const bubbleRect = messageText.getBoundingClientRect();
                        const containerRect = timeAndCopyContainer.getBoundingClientRect();
                        
                        // åŒæ­¥å®½åº¦ï¼šç›´æ¥ä½¿ç”¨æ°”æ³¡çš„å®é™…å®½åº¦
                        if (bubbleRect.width > 0) {
                            timeAndCopyContainer.style.width = `${bubbleRect.width}px`;
                            timeAndCopyContainer.style.maxWidth = `${bubbleRect.width}px`;
                        }
                        
                        // é‡æ–°è·å–å®¹å™¨ä½ç½®ä»¥æ£€æŸ¥å¯¹é½
                        const updatedContainerRect = timeAndCopyContainer.getBoundingClientRect();
                        
                        // æ£€æŸ¥å¹¶ä¿®æ­£å·¦è¾¹ç¼˜å¯¹é½ï¼ˆå…è®¸1pxçš„è¯¯å·®ï¼‰
                        if (Math.abs(bubbleRect.left - updatedContainerRect.left) > 1) {
                            // è®¡ç®—ç›¸å¯¹äºçˆ¶å®¹å™¨çš„åç§»
                            const contentRect = content.getBoundingClientRect();
                            const bubbleOffset = bubbleRect.left - contentRect.left;
                            const containerOffset = updatedContainerRect.left - contentRect.left;
                            
                            // è®¡ç®—éœ€è¦çš„ margin-left è°ƒæ•´
                            const marginDiff = bubbleOffset - containerOffset;
                            
                            // è·å–å½“å‰è®¡ç®—åçš„ margin-left å€¼ï¼ˆå³ä½¿ CSS æ˜¯ autoï¼Œè®¡ç®—å€¼ä¹Ÿæ˜¯åƒç´ ï¼‰
                            const computedStyle = window.getComputedStyle(timeAndCopyContainer);
                            const computedMarginLeft = computedStyle.marginLeft;
                            const numericMargin = parseFloat(computedMarginLeft) || 0;
                            
                            // åº”ç”¨ä¿®æ­£åçš„ margin-left
                            timeAndCopyContainer.style.marginLeft = `${numericMargin + marginDiff}px`;
                        }
                    });
                });
            };
            
            // ç«‹å³åŒæ­¥ä¸€æ¬¡
            syncTimeContainerAlignment();
            
            // ç›‘å¬æ°”æ³¡å¤§å°å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°åŒæ­¥
            if (typeof ResizeObserver !== 'undefined') {
                const resizeObserver = new ResizeObserver(() => {
                    syncTimeContainerAlignment();
                });
                resizeObserver.observe(messageText);
                
                // å°† observer ä¿å­˜åˆ°å…ƒç´ ä¸Šï¼Œä»¥ä¾¿åç»­æ¸…ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
                messageText._timeContainerObserver = resizeObserver;
            }
            
            // å»¶è¿Ÿå†æ¬¡åŒæ­¥ï¼Œç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½å·²æ¸²æŸ“
            setTimeout(syncTimeContainerAlignment, 100);
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content);

        return messageDiv;
    }

    // ä¸ºæ¶ˆæ¯æ·»åŠ å¯¼å‡ºå›¾ç‰‡æŒ‰é’®
    addExportButtonForMessage(buttonContainer, messageDiv, messageType) {
        if (!buttonContainer || !messageDiv) {
            return;
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å¯¼å‡ºæŒ‰é’®
        if (buttonContainer.querySelector('.export-message-button')) {
            return;
        }

        // åˆ›å»ºå¯¼å‡ºæŒ‰é’®
        const exportBtn = document.createElement('button');
        exportBtn.className = 'export-message-button';
        // ä½¿ç”¨ SVG å›¾æ ‡æ›¿ä»£ emojiï¼Œæ›´ä¸“ä¸šç¾è§‚
        exportBtn.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="7 10 12 15 17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        `;
        exportBtn.title = 'å¯¼å‡ºæ¶ˆæ¯ä¸ºå›¾ç‰‡';
        exportBtn.style.cssText = `
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            border-radius: 50% !important;
            width: 22px !important;
            height: 22px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            color: currentColor !important;
            transition: all 0.2s ease !important;
            opacity: 0.8 !important;
            flex-shrink: 0 !important;
            margin-left: 4px !important;
            padding: 0 !important;
        `;

        // æ‚¬åœæ•ˆæœ
        exportBtn.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(59, 130, 246, 0.3) !important';
            this.style.transform = 'scale(1.1)';
            this.style.opacity = '1';
        });

        exportBtn.addEventListener('mouseleave', function() {
            this.style.background = 'rgba(255, 255, 255, 0.2) !important';
            this.style.transform = 'scale(1)';
            this.style.opacity = '0.8';
        });

        // ç‚¹å‡»äº‹ä»¶
        exportBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            // è°ƒç”¨å¯¼å‡ºå‡½æ•°
            if (window.exportSingleMessageToPNG) {
                await window.exportSingleMessageToPNG(messageDiv, messageType);
            } else {
                console.error('å¯¼å‡ºå‡½æ•°æœªåŠ è½½');
                this.showNotification('å¯¼å‡ºåŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'error');
            }
        });

        // å°†æŒ‰é’®æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼ˆåœ¨ç¼–è¾‘æŒ‰é’®åé¢ï¼‰
        buttonContainer.appendChild(exportBtn);
    }


    // åˆ›å»ºæ‰“å­—æŒ‡ç¤ºå™¨ï¼ˆæœ‰è¶£çš„ç­‰å¾…åŠ¨ç”»ï¼‰
    createTypingIndicator() {
        const currentColor = this.colors[this.colorIndex];

        // è·å–ç¬¬ä¸€ä¸ªèŠå¤©ä¸‹é¢ç¬¬ä¸€ä¸ªæŒ‰é’®çš„å›¾æ ‡
        let indicatorIcon = 'ğŸ¾'; // é»˜è®¤å›¾æ ‡
        if (this.chatWindow) {
            const welcomeActions = this.chatWindow.querySelector('#pet-welcome-actions');
            if (welcomeActions) {
                const firstButton = welcomeActions.querySelector('[data-action-key]');
                if (firstButton && firstButton.innerHTML) {
                    indicatorIcon = firstButton.innerHTML.trim();
                }
            }
        }

        const messageDiv = document.createElement('div');
        messageDiv.setAttribute('data-typing-indicator', 'true');
        messageDiv.style.cssText = `
            display: flex !important;
            margin-bottom: 15px !important;
            animation: messageSlideIn 0.3s ease-out !important;
        `;

        const avatar = document.createElement('div');
        avatar.style.cssText = `
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 16px !important;
            margin-right: 10px !important;
            flex-shrink: 0 !important;
            background: ${currentColor} !important;
            animation: petTyping 1.2s ease-in-out infinite !important;
        `;
        avatar.textContent = indicatorIcon;
        avatar.setAttribute('data-message-type', 'pet-avatar');

        const content = document.createElement('div');
        content.style.cssText = `
            flex: 1 !important;
            min-width: 0 !important;
        `;

        const messageText = document.createElement('div');
        messageText.style.cssText = `
            background: ${currentColor} !important;
            color: white !important;
            padding: 12px 16px !important;
            border-radius: 12px !important;
            border-bottom-left-radius: 4px !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
            max-width: 80% !important;
        `;
        messageText.setAttribute('data-message-type', 'pet-bubble');
        messageText.textContent = 'ğŸ’­ æ­£åœ¨æ€è€ƒä¸­...';

        const messageTime = document.createElement('div');
        messageTime.style.cssText = `
            font-size: 11px !important;
            color: #999 !important;
            margin-top: 4px !important;
            text-align: left !important;
        `;

        content.appendChild(messageText);
        content.appendChild(messageTime);
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content);

        return messageDiv;
    }

    // æ·»åŠ å¤åˆ¶æŒ‰é’®çš„è¾…åŠ©æ–¹æ³•
    addCopyButton(container, messageTextElement) {
        // å¦‚æœå·²ç»æœ‰å¤åˆ¶æŒ‰é’®ï¼Œå°±ä¸å†æ·»åŠ 
        if (container.querySelector('.copy-button')) {
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç¼–è¾‘æŒ‰é’®ï¼ˆè¯´æ˜ä¹‹å‰å·²ç»æ·»åŠ è¿‡å…¶ä»–æŒ‰é’®ï¼‰
        const hasEditButton = container.querySelector('.edit-button');
        const hasDeleteButton = container.querySelector('.delete-button');

        // åˆ›å»ºå¤åˆ¶æŒ‰é’®
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.innerHTML = 'ğŸ“‹';
        copyButton.setAttribute('title', 'å¤åˆ¶æ¶ˆæ¯');

        // ç‚¹å‡»å¤åˆ¶
        copyButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            
            try {
                // è·å–æ¶ˆæ¯çš„åŸå§‹æ–‡æœ¬å†…å®¹
                // é¦–å…ˆå°è¯•ä»ä¼ å…¥çš„å…ƒç´ è·å–
                let messageContent = messageTextElement.getAttribute('data-original-text') || 
                                    messageTextElement.innerText || 
                                    messageTextElement.textContent || '';
                
                // å¦‚æœè·å–ä¸åˆ°å†…å®¹ï¼Œå°è¯•ä»æ¶ˆæ¯å®¹å™¨ä¸­æŸ¥æ‰¾æ°”æ³¡å…ƒç´ 
                if (!messageContent || !messageContent.trim()) {
                    const messageDiv = container.closest('[style*="margin-bottom: 15px"]') || 
                                      container.closest('[data-message-type]')?.parentElement ||
                                      container.parentElement?.parentElement;
                    
                    if (messageDiv) {
                        const petBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]');
                        const userBubble = messageDiv.querySelector('[data-message-type="user-bubble"]');
                        const messageBubble = petBubble || userBubble;
                        
                        if (messageBubble) {
                            messageContent = messageBubble.getAttribute('data-original-text') || 
                                          messageBubble.innerText || 
                                          messageBubble.textContent || '';
                        }
                    }
                }
                
                if (!messageContent || !messageContent.trim()) {
                    this.showNotification('æ¶ˆæ¯å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤åˆ¶', 'error');
                    return;
                }
                
                // ä½¿ç”¨ Clipboard API å¤åˆ¶æ–‡æœ¬
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(messageContent.trim());
                    this.showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®å›¾æ ‡ï¼Œè¡¨ç¤ºå¤åˆ¶æˆåŠŸ
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = 'âœ“';
                    copyButton.style.color = '#4caf50';
                    setTimeout(() => {
                        copyButton.innerHTML = originalHTML;
                        copyButton.style.color = '';
                    }, 1000);
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿçš„å¤åˆ¶æ–¹æ³•
                    const textArea = document.createElement('textarea');
                    textArea.value = messageContent.trim();
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    
                    // ä¸´æ—¶æ”¹å˜æŒ‰é’®å›¾æ ‡ï¼Œè¡¨ç¤ºå¤åˆ¶æˆåŠŸ
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = 'âœ“';
                    copyButton.style.color = '#4caf50';
                    setTimeout(() => {
                        copyButton.innerHTML = originalHTML;
                        copyButton.style.color = '';
                    }, 1000);
                }
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                this.showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });

        // åˆ›å»ºç¼–è¾‘æŒ‰é’®ï¼ˆä»…å¯¹å® ç‰©æ¶ˆæ¯æ˜¾ç¤ºï¼‰
        const isPetMessage = messageTextElement.closest('[data-message-type="pet-bubble"]');
        
        // å¦‚æœå·²ç»æœ‰ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®ï¼Œåªæ·»åŠ å¤åˆ¶æŒ‰é’®
        if (hasEditButton && hasDeleteButton) {
            // åœ¨ç¼–è¾‘æŒ‰é’®ä¹‹å‰æ’å…¥å¤åˆ¶æŒ‰é’®
            container.insertBefore(copyButton, hasEditButton);
        } else {
            // å¦‚æœæ²¡æœ‰å…¶ä»–æŒ‰é’®ï¼Œåˆ›å»ºå®Œæ•´çš„æŒ‰é’®ç»„
            // åˆ›å»ºåˆ é™¤æŒ‰é’®
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-button';
            deleteButton.innerHTML = 'ğŸ—‘ï¸';
            deleteButton.setAttribute('title', 'åˆ é™¤æ¶ˆæ¯');

            // ç‚¹å‡»åˆ é™¤
            deleteButton.addEventListener('click', async (e) => {
                e.stopPropagation();

                // ç¡®è®¤åˆ é™¤
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                    // æ‰¾åˆ°åŒ…å«å¤åˆ¶æŒ‰é’®å®¹å™¨çš„æ¶ˆæ¯å…ƒç´ 
                    let currentMessage = container.parentElement;
                    while (currentMessage && !currentMessage.style.cssText.includes('margin-bottom: 15px')) {
                        currentMessage = currentMessage.parentElement;
                    }

                    if (currentMessage) {
                        // ä»ä¼šè¯ä¸­åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯
                        if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                            const session = this.sessions[this.currentSessionId];
                            if (session.messages && Array.isArray(session.messages)) {
                                // è·å–æ¶ˆæ¯å†…å®¹ï¼Œç”¨äºåŒ¹é…ä¼šè¯ä¸­çš„æ¶ˆæ¯
                                const petBubble = currentMessage.querySelector('[data-message-type="pet-bubble"]');
                                const userBubble = currentMessage.querySelector('[data-message-type="user-bubble"]');
                                const messageBubble = petBubble || userBubble;
                                
                                if (messageBubble) {
                                    const messageContent = messageBubble.getAttribute('data-original-text') || 
                                                          messageBubble.textContent || '';
                                    
                                    // ç¡®å®šæ¶ˆæ¯ç±»å‹
                                    const messageType = petBubble ? 'pet' : 'user';
                                    
                                    // æ‰¾åˆ°å¹¶åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯
                                    const messageIndex = session.messages.findIndex(msg => 
                                        msg.type === messageType && 
                                        (msg.content === messageContent || msg.content.trim() === messageContent.trim())
                                    );
                                    
                                    if (messageIndex !== -1) {
                                        // ä»æœ¬åœ°ä¼šè¯ä¸­åˆ é™¤æ¶ˆæ¯
                                        session.messages.splice(messageIndex, 1);
                                        session.updatedAt = Date.now();
                                        // ä¿å­˜ä¼šè¯
                                        await this.saveAllSessions();
                                        console.log(`å·²ä»ä¼šè¯ ${this.currentSessionId} ä¸­åˆ é™¤æ¶ˆæ¯ï¼Œå‰©ä½™ ${session.messages.length} æ¡æ¶ˆæ¯`);
                                    }
                                }
                            }
                        }
                        
                        // åŠ¨ç”»åˆ é™¤æ¶ˆæ¯
                        currentMessage.style.transition = 'opacity 0.3s ease';
                        currentMessage.style.opacity = '0';
                        setTimeout(() => {
                            currentMessage.remove();
                            // åˆ é™¤åä¿å­˜ä¼šè¯ï¼ˆç¡®ä¿æ•°æ®åŒæ­¥ï¼‰
                            this.saveCurrentSession().catch(err => {
                                console.error('åˆ é™¤æ¶ˆæ¯åä¿å­˜ä¼šè¯å¤±è´¥:', err);
                            });
                        }, 300);
                    }
                }
            });

            // åˆ›å»ºç¼–è¾‘æŒ‰é’®ï¼ˆç”¨æˆ·æ¶ˆæ¯å’Œå® ç‰©æ¶ˆæ¯éƒ½æ˜¾ç¤ºï¼‰
            const editButton = document.createElement('button');
            editButton.className = 'edit-button';
            editButton.innerHTML = 'âœï¸';
            editButton.setAttribute('title', 'ç¼–è¾‘æ¶ˆæ¯');

            // ç‚¹å‡»ç¼–è¾‘ - æ‰“å¼€å¼¹çª—ç¼–è¾‘å™¨
            editButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const messageType = isPetMessage ? 'pet' : 'user';
                this.openMessageEditor(messageTextElement, messageType);
            });

            // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ‰€æœ‰æŒ‰é’®
            container.innerHTML = '';
            container.appendChild(copyButton);
            container.appendChild(editButton);
            container.appendChild(deleteButton);
        }
        
        container.style.display = 'flex';
        container.style.gap = '8px';
    }

    // æ·»åŠ æ’åºæŒ‰é’®ï¼ˆä¸Šç§»å’Œä¸‹ç§»ï¼‰
    addSortButtons(container, messageDiv) {
        // å¦‚æœå·²ç»æœ‰æ’åºæŒ‰é’®ï¼Œå°±ä¸å†æ·»åŠ 
        if (container.querySelector('.sort-up-button') || container.querySelector('.sort-down-button')) {
            return;
        }

        const messagesContainer = this.chatWindow?.querySelector('#pet-chat-messages');
        if (!messagesContainer) return;

        // è·å–æ‰€æœ‰æ¶ˆæ¯å…ƒç´ ï¼ˆæ’é™¤æ¬¢è¿æ¶ˆæ¯ï¼‰
        const allMessages = Array.from(messagesContainer.children).filter(msg => 
            !msg.hasAttribute('data-welcome-message')
        );
        const currentIndex = allMessages.indexOf(messageDiv);

        // åˆ›å»ºä¸Šç§»æŒ‰é’®
        const sortUpButton = document.createElement('button');
        sortUpButton.className = 'sort-up-button';
        sortUpButton.innerHTML = 'â¬†ï¸';
        sortUpButton.setAttribute('title', 'ä¸Šç§»æ¶ˆæ¯');
        sortUpButton.style.cssText = `
            background: transparent !important;
            border: none !important;
            cursor: pointer !important;
            padding: 4px 8px !important;
            opacity: ${currentIndex > 0 ? '0.7' : '0.3'} !important;
            transition: opacity 0.2s ease, transform 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px !important;
            min-width: 24px !important;
            min-height: 24px !important;
            pointer-events: ${currentIndex > 0 ? 'auto' : 'none'} !important;
        `;

        // æ‚¬åœæ•ˆæœ
        sortUpButton.addEventListener('mouseenter', () => {
            if (currentIndex > 0) {
                sortUpButton.style.opacity = '1';
                sortUpButton.style.transform = 'scale(1.1)';
            }
        });
        sortUpButton.addEventListener('mouseleave', () => {
            if (currentIndex > 0) {
                sortUpButton.style.opacity = '0.7';
                sortUpButton.style.transform = 'scale(1)';
            }
        });

        // ç‚¹å‡»ä¸Šç§»
        sortUpButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (currentIndex > 0) {
                await this.moveMessageUp(messageDiv, currentIndex);
            }
        });

        // åˆ›å»ºä¸‹ç§»æŒ‰é’®
        const sortDownButton = document.createElement('button');
        sortDownButton.className = 'sort-down-button';
        sortDownButton.innerHTML = 'â¬‡ï¸';
        sortDownButton.setAttribute('title', 'ä¸‹ç§»æ¶ˆæ¯');
        sortDownButton.style.cssText = `
            background: transparent !important;
            border: none !important;
            cursor: pointer !important;
            padding: 4px 8px !important;
            opacity: ${currentIndex < allMessages.length - 1 ? '0.7' : '0.3'} !important;
            transition: opacity 0.2s ease, transform 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px !important;
            min-width: 24px !important;
            min-height: 24px !important;
            pointer-events: ${currentIndex < allMessages.length - 1 ? 'auto' : 'none'} !important;
        `;

        // æ‚¬åœæ•ˆæœ
        sortDownButton.addEventListener('mouseenter', () => {
            if (currentIndex < allMessages.length - 1) {
                sortDownButton.style.opacity = '1';
                sortDownButton.style.transform = 'scale(1.1)';
            }
        });
        sortDownButton.addEventListener('mouseleave', () => {
            if (currentIndex < allMessages.length - 1) {
                sortDownButton.style.opacity = '0.7';
                sortDownButton.style.transform = 'scale(1)';
            }
        });

        // ç‚¹å‡»ä¸‹ç§»
        sortDownButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (currentIndex < allMessages.length - 1) {
                await this.moveMessageDown(messageDiv, currentIndex);
            }
        });

        // å°†æ’åºæŒ‰é’®æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼ˆåœ¨å¤åˆ¶æŒ‰é’®ä¹‹å‰ï¼‰
        const copyButton = container.querySelector('.copy-button');
        if (copyButton) {
            container.insertBefore(sortUpButton, copyButton);
            container.insertBefore(sortDownButton, copyButton);
        } else {
            // å¦‚æœæ²¡æœ‰å¤åˆ¶æŒ‰é’®ï¼Œç›´æ¥æ·»åŠ åˆ°å®¹å™¨æœ«å°¾
            container.appendChild(sortUpButton);
            container.appendChild(sortDownButton);
        }
    }

    // ä¸Šç§»æ¶ˆæ¯
    async moveMessageUp(messageDiv, currentIndex) {
        const messagesContainer = this.chatWindow?.querySelector('#pet-chat-messages');
        if (!messagesContainer || !this.currentSessionId) return;

        // è·å–æ‰€æœ‰æ¶ˆæ¯å…ƒç´ ï¼ˆæ’é™¤æ¬¢è¿æ¶ˆæ¯ï¼‰
        const allMessages = Array.from(messagesContainer.children).filter(msg => 
            !msg.hasAttribute('data-welcome-message')
        );

        if (currentIndex <= 0 || currentIndex >= allMessages.length) return;

        const previousMessage = allMessages[currentIndex - 1];
        
        // åœ¨DOMä¸­äº¤æ¢ä½ç½®
        messageDiv.style.transition = 'transform 0.3s ease';
        previousMessage.style.transition = 'transform 0.3s ease';
        
        // ä½¿ç”¨ insertBefore äº¤æ¢ä½ç½®
        messagesContainer.insertBefore(messageDiv, previousMessage);
        
        // æ›´æ–°ä¼šè¯ä¸­çš„æ¶ˆæ¯é¡ºåº
        const session = this.sessions[this.currentSessionId];
        if (session && session.messages && Array.isArray(session.messages)) {
            // äº¤æ¢æ•°ç»„ä¸­çš„ä½ç½®
            const temp = session.messages[currentIndex];
            session.messages[currentIndex] = session.messages[currentIndex - 1];
            session.messages[currentIndex - 1] = temp;
            
            session.updatedAt = Date.now();
            
            // ä¿å­˜ä¼šè¯
            await this.saveAllSessions();
            
            // åŒæ­¥åˆ°åç«¯
            if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                await this.syncSessionToBackend(this.currentSessionId, true);
            }
            
            // æ›´æ–°æ‰€æœ‰æ¶ˆæ¯çš„æ’åºæŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                this.updateAllSortButtons();
            }, 100);
        }
    }

    // ä¸‹ç§»æ¶ˆæ¯
    async moveMessageDown(messageDiv, currentIndex) {
        const messagesContainer = this.chatWindow?.querySelector('#pet-chat-messages');
        if (!messagesContainer || !this.currentSessionId) return;

        // è·å–æ‰€æœ‰æ¶ˆæ¯å…ƒç´ ï¼ˆæ’é™¤æ¬¢è¿æ¶ˆæ¯ï¼‰
        const allMessages = Array.from(messagesContainer.children).filter(msg => 
            !msg.hasAttribute('data-welcome-message')
        );

        if (currentIndex < 0 || currentIndex >= allMessages.length - 1) return;

        const nextMessage = allMessages[currentIndex + 1];
        
        // åœ¨DOMä¸­äº¤æ¢ä½ç½®
        messageDiv.style.transition = 'transform 0.3s ease';
        nextMessage.style.transition = 'transform 0.3s ease';
        
        // ä½¿ç”¨ insertBefore äº¤æ¢ä½ç½®ï¼ˆå°†å½“å‰æ¶ˆæ¯æ’å…¥åˆ°ä¸‹ä¸€ä¸ªæ¶ˆæ¯ä¹‹åï¼‰
        // å…ˆç§»é™¤å½“å‰æ¶ˆæ¯ï¼Œç„¶åæ’å…¥åˆ°ä¸‹ä¸€ä¸ªæ¶ˆæ¯ä¹‹å
        messageDiv.remove();
        if (nextMessage.nextSibling) {
            messagesContainer.insertBefore(messageDiv, nextMessage.nextSibling);
        } else {
            messagesContainer.appendChild(messageDiv);
        }
        
        // æ›´æ–°ä¼šè¯ä¸­çš„æ¶ˆæ¯é¡ºåº
        const session = this.sessions[this.currentSessionId];
        if (session && session.messages && Array.isArray(session.messages)) {
            // äº¤æ¢æ•°ç»„ä¸­çš„ä½ç½®
            const temp = session.messages[currentIndex];
            session.messages[currentIndex] = session.messages[currentIndex + 1];
            session.messages[currentIndex + 1] = temp;
            
            session.updatedAt = Date.now();
            
            // ä¿å­˜ä¼šè¯
            await this.saveAllSessions();
            
            // åŒæ­¥åˆ°åç«¯
            if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                await this.syncSessionToBackend(this.currentSessionId, true);
            }
            
            // æ›´æ–°æ‰€æœ‰æ¶ˆæ¯çš„æ’åºæŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                this.updateAllSortButtons();
            }, 100);
        }
    }

    // æ›´æ–°æ‰€æœ‰æ¶ˆæ¯çš„æ’åºæŒ‰é’®çŠ¶æ€
    updateAllSortButtons() {
        const messagesContainer = this.chatWindow?.querySelector('#pet-chat-messages');
        if (!messagesContainer) return;

        // è·å–æ‰€æœ‰æ¶ˆæ¯å…ƒç´ ï¼ˆæ’é™¤æ¬¢è¿æ¶ˆæ¯ï¼‰
        const allMessages = Array.from(messagesContainer.children).filter(msg => 
            !msg.hasAttribute('data-welcome-message')
        );

        allMessages.forEach((messageDiv, index) => {
            const copyButtonContainer = messageDiv.querySelector('[data-copy-button-container]');
            if (!copyButtonContainer) return;

            const sortUpButton = copyButtonContainer.querySelector('.sort-up-button');
            const sortDownButton = copyButtonContainer.querySelector('.sort-down-button');

            if (sortUpButton) {
                const canMoveUp = index > 0;
                sortUpButton.style.opacity = canMoveUp ? '0.7' : '0.3';
                sortUpButton.style.pointerEvents = canMoveUp ? 'auto' : 'none';
            }

            if (sortDownButton) {
                const canMoveDown = index < allMessages.length - 1;
                sortDownButton.style.opacity = canMoveDown ? '0.7' : '0.3';
                sortDownButton.style.pointerEvents = canMoveDown ? 'auto' : 'none';
            }
        });
    }

    /**
     * æŸ¥æ‰¾ä¸å® ç‰©æ¶ˆæ¯å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
     * @param {HTMLElement} messageDiv - å® ç‰©æ¶ˆæ¯å…ƒç´ 
     * @param {HTMLElement} messagesContainer - æ¶ˆæ¯å®¹å™¨
     * @returns {string|null} ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
     */
    _findUserMessageForRetry(messageDiv, messagesContainer) {
        const allMessages = Array.from(messagesContainer.children);
        const currentIndex = allMessages.indexOf(messageDiv);
        
        if (currentIndex === -1) {
            throw new Error('å½“å‰æ¶ˆæ¯ä¸åœ¨æ¶ˆæ¯å®¹å™¨ä¸­');
        }
        
        // å‘å‰éå†æ‰€æœ‰æ¶ˆæ¯ï¼Œæ‰¾åˆ°æœ€è¿‘çš„ç”¨æˆ·æ¶ˆæ¯
        for (let i = currentIndex - 1; i >= 0; i--) {
            const messageElement = allMessages[i];
            const userBubble = messageElement.querySelector('[data-message-type="user-bubble"]');
            
            if (userBubble) {
                // ä¼˜å…ˆä½¿ç”¨ data-original-textï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ–‡æœ¬å†…å®¹
                const userMessageText = userBubble.getAttribute('data-original-text') || 
                                       userBubble.textContent || 
                                       userBubble.innerText;
                
                if (userMessageText && userMessageText.trim()) {
                    return userMessageText.trim();
                }
            }
        }
        
        return null;
    }

    /**
     * è·å–ç­‰å¾…å›¾æ ‡ï¼ˆä»æ¬¢è¿åŠ¨ä½œæŒ‰é’®ä¸­è·å–ï¼‰
     * @returns {string} ç­‰å¾…å›¾æ ‡
     */
    _getWaitingIcon() {
        if (this.chatWindow) {
            const welcomeActions = this.chatWindow.querySelector('#pet-welcome-actions');
            if (welcomeActions) {
                const firstButton = welcomeActions.querySelector('[data-action-key]');
                if (firstButton && firstButton.innerHTML) {
                    return firstButton.innerHTML.trim();
                }
            }
        }
        return 'â³'; // é»˜è®¤å›¾æ ‡
    }

    /**
     * æ›´æ–°é‡æ–°ç”ŸæˆæŒ‰é’®çš„çŠ¶æ€
     * @param {HTMLElement} button - æŒ‰é’®å…ƒç´ 
     * @param {string} state - çŠ¶æ€: 'idle' | 'loading' | 'success' | 'error'
     */
    _updateTryAgainButtonState(button, state) {
        const states = {
            idle: {
                icon: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                    <path d="M23 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M1 20v-6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`,
                opacity: '0.7',
                cursor: 'pointer',
                color: ''
            },
            loading: {
                icon: this._getWaitingIcon(),
                opacity: '0.6',
                cursor: 'not-allowed',
                color: ''
            },
            success: {
                icon: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                    <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`,
                opacity: '0.7',
                cursor: 'pointer',
                color: '#4caf50'
            },
            error: {
                icon: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                    <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>`,
                opacity: '0.7',
                cursor: 'pointer',
                color: '#f44336'
            }
        };

        const buttonState = states[state] || states.idle;
        button.innerHTML = buttonState.icon;
        button.style.opacity = buttonState.opacity;
        button.style.cursor = buttonState.cursor;
        button.style.color = buttonState.color;
    }

    /**
     * æ›´æ–°è¯·æ±‚çŠ¶æ€ï¼ˆloading/idleï¼‰
     * @param {string} status - çŠ¶æ€: 'loading' | 'idle'
     * @param {AbortController|null} abortController - ä¸­æ­¢æ§åˆ¶å™¨
     */
    _updateRequestStatus(status, abortController = null) {
        if (this.chatWindow) {
            if (this.chatWindow._setAbortController) {
                this.chatWindow._setAbortController(abortController);
            }
            if (this.chatWindow._updateRequestStatus) {
                this.chatWindow._updateRequestStatus(status);
            }
        }
    }

    /**
     * åˆ›å»ºæµå¼å†…å®¹æ›´æ–°å›è°ƒ
     * @param {HTMLElement} messageBubble - æ¶ˆæ¯æ°”æ³¡å…ƒç´ 
     * @param {HTMLElement} messagesContainer - æ¶ˆæ¯å®¹å™¨
     * @returns {Function} å†…å®¹æ›´æ–°å›è°ƒå‡½æ•°
     */
    _createStreamContentCallback(messageBubble, messagesContainer) {
        let fullContent = '';
        
        return (chunk, accumulatedContent) => {
            fullContent = accumulatedContent;
            messageBubble.innerHTML = this.renderMarkdown(fullContent);
            messageBubble.setAttribute('data-original-text', fullContent);
            
            // å¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨
            if (messageBubble._mermaidTimeout) {
                clearTimeout(messageBubble._mermaidTimeout);
            }
            messageBubble._mermaidTimeout = setTimeout(async () => {
                await this.processMermaidBlocks(messageBubble);
                messageBubble._mermaidTimeout = null;
            }, 500);

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return fullContent;
        };
    }

    /**
     * æ‰§è¡Œé‡æ–°ç”Ÿæˆå›å¤çš„æ ¸å¿ƒé€»è¾‘
     * @param {HTMLElement} messageDiv - å® ç‰©æ¶ˆæ¯å…ƒç´ 
     * @param {string} userMessageText - ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬
     * @param {HTMLElement} messagesContainer - æ¶ˆæ¯å®¹å™¨
     * @returns {Promise<string>} ç”Ÿæˆçš„å›å¤å†…å®¹
     */
    async _retryGenerateResponse(messageDiv, userMessageText, messagesContainer) {
        const messageBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]');
        if (!messageBubble) {
            throw new Error('æœªæ‰¾åˆ°æ¶ˆæ¯æ°”æ³¡');
        }

        const waitingIcon = this._getWaitingIcon();
        messageBubble.innerHTML = this.renderMarkdown(`${waitingIcon} æ­£åœ¨é‡æ–°ç”Ÿæˆå›å¤...`);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // åˆ›å»ºæµå¼å†…å®¹æ›´æ–°å›è°ƒ
        const onStreamContent = this._createStreamContentCallback(messageBubble, messagesContainer);

        // åˆ›å»º AbortController ç”¨äºç»ˆæ­¢è¯·æ±‚
        const abortController = new AbortController();
        this._updateRequestStatus('loading', abortController);
        
        try {
            // è°ƒç”¨ API é‡æ–°ç”Ÿæˆ
            const reply = await this.generatePetResponseStream(userMessageText, onStreamContent, abortController);

            // ç¡®ä¿æœ€ç»ˆå†…å®¹è¢«æ˜¾ç¤ºï¼ˆæµå¼æ›´æ–°å¯èƒ½å·²ç»å®Œæˆï¼Œä½†å†æ¬¡ç¡®è®¤ï¼‰
            if (reply && reply.trim()) {
                messageBubble.innerHTML = this.renderMarkdown(reply);
                messageBubble.setAttribute('data-original-text', reply);
                setTimeout(async () => {
                    await this.processMermaidBlocks(messageBubble);
                }, 100);
            }

            // æ›´æ–°å¤åˆ¶æŒ‰é’®
            const copyButtonContainer = messageDiv.querySelector('[data-copy-button-container]');
            if (copyButtonContainer && reply && reply.trim()) {
                this.addCopyButton(copyButtonContainer, messageBubble);
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return reply;
        } finally {
            this._updateRequestStatus('idle', null);
        }
    }

    /**
     * å¤„ç†é‡æ–°ç”Ÿæˆå¤±è´¥çš„æƒ…å†µ
     * @param {HTMLElement} messageDiv - å® ç‰©æ¶ˆæ¯å…ƒç´ 
     * @param {Error} error - é”™è¯¯å¯¹è±¡
     */
    _handleRetryError(messageDiv, error) {
        const isAbortError = error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ';
        
        if (!isAbortError) {
            console.error('é‡æ–°ç”Ÿæˆå›å¤å¤±è´¥:', error);
            
            const messageBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]');
            if (messageBubble) {
                const originalText = messageBubble.getAttribute('data-original-text') || 
                                   'æŠ±æ­‰ï¼Œé‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                messageBubble.innerHTML = this.renderMarkdown(originalText);
            }
        }
        
        return isAbortError;
    }

    /**
     * ä¸ºå® ç‰©æ¶ˆæ¯æ·»åŠ é‡æ–°ç”ŸæˆæŒ‰é’®
     * @param {HTMLElement} container - æŒ‰é’®å®¹å™¨
     * @param {HTMLElement} messageDiv - å® ç‰©æ¶ˆæ¯å…ƒç´ 
     */
    addTryAgainButton(container, messageDiv) {
        // å¦‚æœå·²ç»æ·»åŠ è¿‡ï¼Œå°±ä¸å†æ·»åŠ 
        if (container.querySelector('.try-again-button')) {
            return;
        }
        
        // å¦‚æœæ˜¯æŒ‰é’®æ“ä½œç”Ÿæˆçš„æ¶ˆæ¯ï¼Œä¸æ·»åŠ  try again æŒ‰é’®
        if (messageDiv.hasAttribute('data-button-action')) {
            return;
        }

        const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
        if (!messagesContainer) {
            return;
        }

        // åˆ›å»ºé‡æ–°ç”ŸæˆæŒ‰é’®
        const tryAgainButton = document.createElement('button');
        tryAgainButton.className = 'try-again-button';
        tryAgainButton.setAttribute('title', 'é‡æ–°ç”Ÿæˆå›å¤');
        tryAgainButton.setAttribute('aria-label', 'é‡æ–°ç”Ÿæˆå›å¤');
        tryAgainButton.style.cssText = `
            background: transparent !important;
            border: none !important;
            cursor: pointer !important;
            padding: 4px 8px !important;
            opacity: 0.7 !important;
            transition: opacity 0.2s ease, color 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: currentColor !important;
        `;

        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        this._updateTryAgainButtonState(tryAgainButton, 'idle');

        // æ‚¬åœæ•ˆæœ
        tryAgainButton.addEventListener('mouseenter', () => {
            if (!tryAgainButton.hasAttribute('data-retrying')) {
                tryAgainButton.style.opacity = '1';
            }
        });
        tryAgainButton.addEventListener('mouseleave', () => {
            if (!tryAgainButton.hasAttribute('data-retrying')) {
                tryAgainButton.style.opacity = '0.7';
            }
        });

        // ç‚¹å‡»é‡æ–°ç”Ÿæˆ
        tryAgainButton.addEventListener('click', async (e) => {
            e.stopPropagation();

            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (tryAgainButton.hasAttribute('data-retrying')) {
                return;
            }

            tryAgainButton.setAttribute('data-retrying', 'true');
            this._updateTryAgainButtonState(tryAgainButton, 'loading');

            try {
                // æŸ¥æ‰¾å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
                const userMessageText = this._findUserMessageForRetry(messageDiv, messagesContainer);

                if (!userMessageText) {
                    // å¦‚æœæ‰¾ä¸åˆ°ç”¨æˆ·æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯é€šè¿‡æŒ‰é’®è§¦å‘çš„æ“ä½œ
                    console.warn('æœªæ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆå›å¤');
                    
                    const messageBubble = messageDiv.querySelector('[data-message-type="pet-bubble"]');
                    if (messageBubble) {
                        const originalText = messageBubble.getAttribute('data-original-text') || 
                                           messageBubble.textContent ||
                                           'æ­¤æ¶ˆæ¯æ— æ³•é‡æ–°ç”Ÿæˆ';
                        messageBubble.innerHTML = this.renderMarkdown(
                            `${originalText}\n\nğŸ’¡ **æç¤º**ï¼šæ­¤æ¶ˆæ¯å¯èƒ½æ˜¯é€šè¿‡æŒ‰é’®æ“ä½œç”Ÿæˆçš„ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆã€‚`
                        );
                    }
                    
                    this._updateTryAgainButtonState(tryAgainButton, 'idle');
                    tryAgainButton.removeAttribute('data-retrying');
                    return;
                }

                // æ‰§è¡Œé‡æ–°ç”Ÿæˆ
                await this._retryGenerateResponse(messageDiv, userMessageText, messagesContainer);

                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                this._updateTryAgainButtonState(tryAgainButton, 'success');
                
                // 1.5ç§’åæ¢å¤ä¸ºåˆå§‹çŠ¶æ€
                setTimeout(() => {
                    this._updateTryAgainButtonState(tryAgainButton, 'idle');
                    tryAgainButton.removeAttribute('data-retrying');
                }, 1500);

            } catch (error) {
                // å¤„ç†é”™è¯¯
                const isAbortError = this._handleRetryError(messageDiv, error);
                
                if (!isAbortError) {
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    this._updateTryAgainButtonState(tryAgainButton, 'error');
                    
                    // 1.5ç§’åæ¢å¤ä¸ºåˆå§‹çŠ¶æ€
                    setTimeout(() => {
                        this._updateTryAgainButtonState(tryAgainButton, 'idle');
                        tryAgainButton.removeAttribute('data-retrying');
                    }, 1500);
                } else {
                    // è¯·æ±‚è¢«å–æ¶ˆï¼Œç›´æ¥æ¢å¤çŠ¶æ€
                    this._updateTryAgainButtonState(tryAgainButton, 'idle');
                    tryAgainButton.removeAttribute('data-retrying');
                }
            }
        });

        container.appendChild(tryAgainButton);
        container.style.display = 'flex';
        container.style.gap = '8px';
        
        // ç¡®ä¿å®¹å™¨å¯è§
        if (container.style.display === 'none') {
            container.style.display = 'flex';
        }
    }

    // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ é™¤å’Œç¼–è¾‘æŒ‰é’®
    addDeleteButtonForUserMessage(container, messageTextElement) {
        // å¦‚æœå·²ç»æ·»åŠ è¿‡ï¼Œå°±ä¸å†æ·»åŠ 
        if (container.querySelector('.delete-button') && 
            container.querySelector('.edit-button') && 
            container.querySelector('.resend-button')) {
            return;
        }

        const deleteButton = document.createElement('button');
        deleteButton.className = 'delete-button';
        deleteButton.innerHTML = 'ğŸ—‘ï¸';
        deleteButton.setAttribute('title', 'åˆ é™¤æ¶ˆæ¯');

        // ç‚¹å‡»åˆ é™¤
        deleteButton.addEventListener('click', async (e) => {
            e.stopPropagation();

            // ç¡®è®¤åˆ é™¤
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                // æ‰¾åˆ°åŒ…å«åˆ é™¤æŒ‰é’®å®¹å™¨çš„æ¶ˆæ¯å…ƒç´ 
                let currentMessage = container.parentElement;
                while (currentMessage && !currentMessage.style.cssText.includes('margin-bottom: 15px')) {
                    currentMessage = currentMessage.parentElement;
                }

                if (currentMessage) {
                    // ä»ä¼šè¯ä¸­åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯
                    if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                        const session = this.sessions[this.currentSessionId];
                        if (session.messages && Array.isArray(session.messages)) {
                            // è·å–æ¶ˆæ¯å†…å®¹ï¼Œç”¨äºåŒ¹é…ä¼šè¯ä¸­çš„æ¶ˆæ¯
                            const userBubble = currentMessage.querySelector('[data-message-type="user-bubble"]');
                            if (userBubble) {
                                const messageContent = userBubble.getAttribute('data-original-text') || 
                                                      userBubble.textContent || '';
                                
                                // æ‰¾åˆ°å¹¶åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯
                                const messageIndex = session.messages.findIndex(msg => 
                                    msg.type === 'user' && 
                                    (msg.content === messageContent || msg.content.trim() === messageContent.trim())
                                );
                                
                                if (messageIndex !== -1) {
                                    // ä»æœ¬åœ°ä¼šè¯ä¸­åˆ é™¤æ¶ˆæ¯
                                    session.messages.splice(messageIndex, 1);
                                    session.updatedAt = Date.now();
                                    // ä¿å­˜ä¼šè¯
                                    await this.saveAllSessions();
                                    console.log(`å·²ä»ä¼šè¯ ${this.currentSessionId} ä¸­åˆ é™¤æ¶ˆæ¯ï¼Œå‰©ä½™ ${session.messages.length} æ¡æ¶ˆæ¯`);
                                }
                            }
                        }
                    }
                    
                    // åŠ¨ç”»åˆ é™¤æ¶ˆæ¯
                    currentMessage.style.transition = 'opacity 0.3s ease';
                    currentMessage.style.opacity = '0';
                    setTimeout(() => {
                        currentMessage.remove();
                        // åˆ é™¤åä¿å­˜ä¼šè¯ï¼ˆç¡®ä¿æ•°æ®åŒæ­¥ï¼‰
                        this.saveCurrentSession().catch(err => {
                            console.error('åˆ é™¤æ¶ˆæ¯åä¿å­˜ä¼šè¯å¤±è´¥:', err);
                        });
                    }, 300);
                }
            }
        });

        // åˆ›å»ºç¼–è¾‘æŒ‰é’®
        const editButton = document.createElement('button');
        editButton.className = 'edit-button';
        editButton.innerHTML = 'âœï¸';
        editButton.setAttribute('title', 'ç¼–è¾‘æ¶ˆæ¯');

        // ç‚¹å‡»ç¼–è¾‘ - æ‰“å¼€å¼¹çª—ç¼–è¾‘å™¨ï¼ˆç±»ä¼¼ä¸Šä¸‹æ–‡ç¼–è¾‘å™¨ï¼Œä¸å® ç‰©æ¶ˆæ¯ä¿æŒä¸€è‡´ï¼‰
        editButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (messageTextElement) {
                this.openMessageEditor(messageTextElement, 'user');
            }
        });

        // åˆ›å»ºé‡æ–°å‘é€æŒ‰é’®
        const resendButton = document.createElement('button');
        resendButton.className = 'resend-button';
        // ä½¿ç”¨ SVG å›¾æ ‡æ›¿ä»£ emojiï¼Œæ›´ä¸“ä¸šç¾è§‚
        resendButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                <line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
        `;
        resendButton.setAttribute('title', 'é‡æ–°å‘é€ prompt è¯·æ±‚');

        // è®¾ç½®æŒ‰é’®æ ·å¼ï¼ˆä¸ try again æŒ‰é’®ä¿æŒä¸€è‡´ï¼‰
        resendButton.style.cssText = `
            background: transparent !important;
            border: none !important;
            cursor: pointer !important;
            padding: 4px 8px !important;
            opacity: 0.7 !important;
            transition: opacity 0.2s ease, color 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: currentColor !important;
            min-width: 24px !important;
            min-height: 24px !important;
        `;

        // æ‚¬åœæ•ˆæœ
        resendButton.addEventListener('mouseenter', () => {
            resendButton.style.opacity = '1';
        });
        resendButton.addEventListener('mouseleave', () => {
            resendButton.style.opacity = '0.7';
        });

        // ç‚¹å‡»é‡æ–°å‘é€
        let isResending = false;
        resendButton.addEventListener('click', async (e) => {
            e.stopPropagation();

            if (isResending) return;
            isResending = true;

            try {
                // è·å–ç”¨æˆ·æ¶ˆæ¯çš„åŸå§‹æ–‡æœ¬
                let userMessageText = messageTextElement.getAttribute('data-original-text');
                if (!userMessageText) {
                    userMessageText = messageTextElement.textContent || messageTextElement.innerText || '';
                }

                if (!userMessageText || !userMessageText.trim()) {
                    console.warn('æ— æ³•è·å–ç”¨æˆ·æ¶ˆæ¯å†…å®¹');
                    isResending = false;
                    return;
                }

                // è·å–æ¶ˆæ¯å®¹å™¨
                const messagesContainer = this.chatWindow ? this.chatWindow.querySelector('#pet-chat-messages') : null;
                if (!messagesContainer) {
                    console.warn('æ— æ³•æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
                    isResending = false;
                    return;
                }

                // æ‰¾åˆ°å½“å‰ç”¨æˆ·æ¶ˆæ¯å…ƒç´ 
                let currentMessage = container.parentElement;
                while (currentMessage && !currentMessage.style.cssText.includes('margin-bottom: 15px')) {
                    currentMessage = currentMessage.parentElement;
                }

                if (!currentMessage) {
                    console.warn('æ— æ³•æ‰¾åˆ°å½“å‰æ¶ˆæ¯å…ƒç´ ');
                    isResending = false;
                    return;
                }

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                resendButton.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416" opacity="0.3">
                            <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416;0 31.416" repeatCount="indefinite"/>
                            <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416;-31.416" repeatCount="indefinite"/>
                        </circle>
                    </svg>
                `;
                resendButton.style.opacity = '0.6';
                resendButton.style.cursor = 'not-allowed';
                resendButton.style.color = '';

                // åˆ›å»ºæ‰“å­—æŒ‡ç¤ºå™¨
                const typingIndicator = this.createTypingIndicator();
                
                // åœ¨å½“å‰ç”¨æˆ·æ¶ˆæ¯ä¹‹åæ’å…¥æ‰“å­—æŒ‡ç¤ºå™¨
                if (currentMessage.nextSibling) {
                    messagesContainer.insertBefore(typingIndicator, currentMessage.nextSibling);
                } else {
                    messagesContainer.appendChild(typingIndicator);
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // ç”Ÿæˆå›å¤
                let fullContent = '';
                const messageBubble = typingIndicator.querySelector('[data-message-type="pet-bubble"]');
                
                const onStreamContent = (chunk, accumulatedContent) => {
                    fullContent = accumulatedContent;
                    if (messageBubble) {
                        messageBubble.innerHTML = this.renderMarkdown(fullContent);
                        messageBubble.setAttribute('data-original-text', fullContent);
                        
                        // å¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨
                        if (messageBubble._mermaidTimeout) {
                            clearTimeout(messageBubble._mermaidTimeout);
                        }
                        messageBubble._mermaidTimeout = setTimeout(async () => {
                            await this.processMermaidBlocks(messageBubble);
                            messageBubble._mermaidTimeout = null;
                        }, 500);

                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                };

                // åˆ›å»º AbortController ç”¨äºç»ˆæ­¢è¯·æ±‚
                const abortController = new AbortController();
                if (this.chatWindow && this.chatWindow._setAbortController) {
                    this.chatWindow._setAbortController(abortController);
                }
                if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                    this.chatWindow._updateRequestStatus('loading');
                }

                // è°ƒç”¨ API ç”Ÿæˆå›å¤
                const reply = await this.generatePetResponseStream(userMessageText.trim(), onStreamContent, abortController);

                // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨ï¼Œåˆ›å»ºæ­£å¼çš„æ¶ˆæ¯å…ƒç´ 
                typingIndicator.remove();

                // åˆ›å»ºæ­£å¼çš„å® ç‰©æ¶ˆæ¯
                const petMessage = this.createMessageElement(reply, 'pet');
                if (currentMessage.nextSibling) {
                    messagesContainer.insertBefore(petMessage, currentMessage.nextSibling);
                } else {
                    messagesContainer.appendChild(petMessage);
                }

                // ç¡®ä¿æœ€ç»ˆå†…å®¹è¢«æ˜¾ç¤º
                const finalMessageBubble = petMessage.querySelector('[data-message-type="pet-bubble"]');
                if (finalMessageBubble && fullContent !== reply) {
                    finalMessageBubble.innerHTML = this.renderMarkdown(reply);
                    finalMessageBubble.setAttribute('data-original-text', reply);
                    setTimeout(async () => {
                        await this.processMermaidBlocks(finalMessageBubble);
                    }, 100);
                }

                // æ·»åŠ å¤åˆ¶æŒ‰é’®ç­‰æ“ä½œæŒ‰é’®
                const copyButtonContainer = petMessage.querySelector('[data-copy-button-container]');
                if (copyButtonContainer && reply && reply.trim()) {
                    this.addCopyButton(copyButtonContainer, finalMessageBubble);
                }
                
                // æ·»åŠ æ’åºæŒ‰é’®
                if (copyButtonContainer) {
                    this.addSortButtons(copyButtonContainer, petMessage);
                }

                // æ·»åŠ é‡è¯•æŒ‰é’®
                const tryAgainButtonContainer = petMessage.querySelector('[data-try-again-button-container]');
                if (tryAgainButtonContainer) {
                    this.addTryAgainButton(tryAgainButtonContainer, petMessage);
                }

                // æ·»åŠ æ¶ˆæ¯åˆ°ä¼šè¯
                if (this.currentSessionId && reply && reply.trim()) {
                    await this.addMessageToSession('pet', reply, null, true);
                    
                    // è°ƒç”¨ session/save ä¿å­˜ä¼šè¯åˆ°åç«¯
                    if (this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                        await this.syncSessionToBackend(this.currentSessionId, true);
                    }
                }

                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // æ›´æ–°çŠ¶æ€ä¸ºç©ºé—²
                if (this.chatWindow && this.chatWindow._setAbortController) {
                    this.chatWindow._setAbortController(null);
                }
                if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                    this.chatWindow._updateRequestStatus('idle');
                }

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                resendButton.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                        <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;
                resendButton.style.color = '#4caf50';
                
                setTimeout(() => {
                    resendButton.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                            <line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        </svg>
                    `;
                    resendButton.style.color = '';
                    resendButton.style.opacity = '0.7';
                    resendButton.style.cursor = 'pointer';
                    isResending = false;
                }, 1500);

            } catch (error) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯å–æ¶ˆé”™è¯¯
                const isAbortError = error.name === 'AbortError' || error.message === 'è¯·æ±‚å·²å–æ¶ˆ';
                
                if (!isAbortError) {
                    console.error('é‡æ–°å‘é€ prompt è¯·æ±‚å¤±è´¥:', error);
                }

                // æ›´æ–°çŠ¶æ€ä¸ºç©ºé—²
                if (this.chatWindow && this.chatWindow._setAbortController) {
                    this.chatWindow._setAbortController(null);
                }
                if (this.chatWindow && this.chatWindow._updateRequestStatus) {
                    this.chatWindow._updateRequestStatus('idle');
                }

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                resendButton.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                        <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                `;
                resendButton.style.color = '#f44336';
                
                setTimeout(() => {
                    resendButton.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: block;">
                            <line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        </svg>
                    `;
                    resendButton.style.color = '';
                    resendButton.style.opacity = '0.7';
                    resendButton.style.cursor = 'pointer';
                    isResending = false;
                }, 1500);
            }
        });

        // åªæ·»åŠ ç¼ºå¤±çš„æŒ‰é’®ï¼Œä¸æ¸…ç©ºå®¹å™¨ï¼ˆä¿ç•™å·²æœ‰çš„å¤åˆ¶æŒ‰é’®ç­‰ï¼‰
        if (!container.querySelector('.edit-button')) {
            container.appendChild(editButton);
        }
        if (!container.querySelector('.resend-button')) {
            container.appendChild(resendButton);
        }
        if (!container.querySelector('.delete-button')) {
            container.appendChild(deleteButton);
        }
        container.style.display = 'flex';
        container.style.gap = '8px';
    }

    // å¯ç”¨æ¶ˆæ¯ç¼–è¾‘åŠŸèƒ½
    enableMessageEdit(messageElement, editButton, sender) {
        // ä¿å­˜åŸå§‹å†…å®¹ - ä¼˜å…ˆä»data-original-textè·å–ï¼ˆä¿ç•™åŸå§‹æ ¼å¼ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»å…ƒç´ å†…å®¹è·å–
        let originalText = messageElement.getAttribute('data-original-text') || '';
        
        // å¦‚æœdata-original-textä¸ºç©ºï¼Œåˆ™ä»å…ƒç´ å†…å®¹ä¸­æå–
        if (!originalText) {
            if (sender === 'pet') {
                // å¯¹äºå® ç‰©æ¶ˆæ¯ï¼Œä»innerTextè·å–ï¼ˆå»æ‰Markdownæ ¼å¼ï¼‰
                originalText = messageElement.innerText || messageElement.textContent || '';
            } else {
                // å¯¹äºç”¨æˆ·æ¶ˆæ¯ï¼Œç›´æ¥è·å–æ–‡æœ¬å†…å®¹
                originalText = messageElement.innerText || messageElement.textContent || '';
            }
        }

        // ä¿å­˜åŸå§‹HTMLï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const originalHTML = messageElement.innerHTML;

        // ä¿å­˜åˆ°dataå±æ€§
        messageElement.setAttribute('data-original-content', originalHTML);
        messageElement.setAttribute('data-editing', 'true');

        // åˆ›å»ºæ–‡æœ¬è¾“å…¥æ¡†
        const textarea = document.createElement('textarea');
        textarea.value = originalText;
        textarea.style.cssText = `
            width: 100% !important;
            min-height: 80px !important;
            max-height: 400px !important;
            padding: 12px 16px !important;
            border: 2px solid rgba(255, 255, 255, 0.5) !important;
            border-radius: 8px !important;
            background: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            font-size: 14px !important;
            font-family: inherit !important;
            line-height: 1.6 !important;
            resize: vertical !important;
            outline: none !important;
            box-sizing: border-box !important;
            overflow-y: auto !important;
        `;
        textarea.setAttribute('placeholder', 'ç¼–è¾‘æ¶ˆæ¯å†…å®¹...');

        // æ›¿æ¢æ¶ˆæ¯å†…å®¹ä¸ºè¾“å…¥æ¡†
        messageElement.innerHTML = '';
        messageElement.appendChild(textarea);

        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦ä»¥é€‚åº”å†…å®¹
        const adjustHeight = () => {
            textarea.style.height = 'auto';
            const scrollHeight = textarea.scrollHeight;
            const minHeight = 80;
            const maxHeight = 400;
            const newHeight = Math.max(minHeight, Math.min(scrollHeight, maxHeight));
            textarea.style.height = newHeight + 'px';
        };

        // åˆå§‹è°ƒæ•´é«˜åº¦
        setTimeout(() => {
            adjustHeight();
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }, 10);

        // æ›´æ–°ç¼–è¾‘æŒ‰é’®çŠ¶æ€
        editButton.setAttribute('data-editing', 'true');
        editButton.innerHTML = 'ğŸ’¾';
        editButton.setAttribute('title', 'ä¿å­˜ç¼–è¾‘');

        // æ·»åŠ å›è½¦ä¿å­˜åŠŸèƒ½ï¼ˆCtrl+Enteræˆ–Cmd+Enterï¼‰
        textarea.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                this.saveMessageEdit(messageElement, editButton, sender);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                this.cancelMessageEdit(messageElement, editButton, sender);
            }
        });

        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦ï¼ˆè¾“å…¥æ—¶å®æ—¶è°ƒæ•´ï¼‰
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            const scrollHeight = textarea.scrollHeight;
            const minHeight = 80;
            const maxHeight = 400;
            const newHeight = Math.max(minHeight, Math.min(scrollHeight, maxHeight));
            textarea.style.height = newHeight + 'px';
            
            // å¦‚æœå†…å®¹è¶…è¿‡æœ€å¤§é«˜åº¦ï¼Œæ˜¾ç¤ºæ»šåŠ¨æ¡
            if (scrollHeight > maxHeight) {
                textarea.style.overflowY = 'auto';
            } else {
                textarea.style.overflowY = 'hidden';
            }
        });
    }

    // ä¿å­˜æ¶ˆæ¯ç¼–è¾‘
    saveMessageEdit(messageElement, editButton, sender) {
        const textarea = messageElement.querySelector('textarea');
        if (!textarea) return;

        const newText = textarea.value.trim();
        
        if (!newText) {
            // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œå–æ¶ˆç¼–è¾‘
            this.cancelMessageEdit(messageElement, editButton, sender);
            return;
        }

        // æ›´æ–°æ¶ˆæ¯å†…å®¹
        if (sender === 'pet') {
            // å¯¹äºå® ç‰©æ¶ˆæ¯ï¼Œä½¿ç”¨Markdownæ¸²æŸ“
            messageElement.innerHTML = this.renderMarkdown(newText);
            messageElement.classList.add('markdown-content');
            // æ›´æ–°åŸå§‹æ–‡æœ¬
            messageElement.setAttribute('data-original-text', newText);
            // å¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨ - ä½¿ç”¨æ›´å¯é çš„æ–¹å¼
            // å…ˆç­‰å¾…DOMæ›´æ–°å®Œæˆï¼Œç„¶åå¤„ç†mermaid
            setTimeout(async () => {
                try {
                    // ç¡®ä¿ mermaid å·²åŠ è½½
                    await this.loadMermaid();
                    // å†æ¬¡æ£€æŸ¥ DOM æ˜¯å¦å·²æ›´æ–°
                    const hasMermaidCode = messageElement.querySelector('code.language-mermaid, code.language-mmd, pre code.language-mermaid, pre code.language-mmd, code[class*="mermaid"]');
                    if (hasMermaidCode) {
                        // å¤„ç† mermaid å›¾è¡¨
                        await this.processMermaidBlocks(messageElement);
                    }
                } catch (error) {
                    console.error('å¤„ç†ç¼–è¾‘åçš„ Mermaid å›¾è¡¨æ—¶å‡ºé”™:', error);
                }
            }, 200);
        } else {
            // å¯¹äºç”¨æˆ·æ¶ˆæ¯ï¼Œä¹Ÿæ”¯æŒ Markdown å’Œ Mermaid é¢„è§ˆ
            // æ£€æŸ¥æ˜¯å¦åŒ…å« markdown è¯­æ³•ï¼ˆç®€å•æ£€æµ‹ï¼‰
            const hasMarkdown = /[#*_`\[\]()!]|```/.test(newText);
            
            if (hasMarkdown) {
                // ä½¿ç”¨ Markdown æ¸²æŸ“
                messageElement.innerHTML = this.renderMarkdown(newText);
                messageElement.classList.add('markdown-content');
                // æ›´æ–°åŸå§‹æ–‡æœ¬
                messageElement.setAttribute('data-original-text', newText);
                // å¤„ç†å¯èƒ½çš„ Mermaid å›¾è¡¨
                setTimeout(async () => {
                    try {
                        // ç¡®ä¿ mermaid å·²åŠ è½½
                        await this.loadMermaid();
                        // å†æ¬¡æ£€æŸ¥ DOM æ˜¯å¦å·²æ›´æ–°
                        const hasMermaidCode = messageElement.querySelector('code.language-mermaid, code.language-mmd, pre code.language-mermaid, pre code.language-mmd, code[class*="mermaid"]');
                        if (hasMermaidCode) {
                            // å¤„ç† mermaid å›¾è¡¨
                            await this.processMermaidBlocks(messageElement);
                        }
                    } catch (error) {
                        console.error('å¤„ç†ç¼–è¾‘åçš„ Mermaid å›¾è¡¨æ—¶å‡ºé”™:', error);
                    }
                }, 200);
            } else {
                // çº¯æ–‡æœ¬ï¼Œä¸ä½¿ç”¨ Markdown
                messageElement.textContent = newText;
                // æ›´æ–°åŸå§‹æ–‡æœ¬ï¼Œä»¥ä¾¿å†æ¬¡ç¼–è¾‘æ—¶å¯ä»¥è·å–
                messageElement.setAttribute('data-original-text', newText);
            }
        }

        // æ¢å¤ç¼–è¾‘çŠ¶æ€
        messageElement.removeAttribute('data-editing');
        messageElement.setAttribute('data-edited', 'true');

        // æ›´æ–°ç¼–è¾‘æŒ‰é’®çŠ¶æ€
        editButton.setAttribute('data-editing', 'false');
        editButton.innerHTML = 'âœï¸';
        editButton.setAttribute('title', 'ç¼–è¾‘æ¶ˆæ¯');
    }

    // å–æ¶ˆæ¶ˆæ¯ç¼–è¾‘
    cancelMessageEdit(messageElement, editButton, sender) {
        const originalHTML = messageElement.getAttribute('data-original-content');
        
        if (originalHTML) {
            messageElement.innerHTML = originalHTML;
        }

        // æ¢å¤ç¼–è¾‘çŠ¶æ€
        messageElement.removeAttribute('data-editing');

        // æ›´æ–°ç¼–è¾‘æŒ‰é’®çŠ¶æ€
        editButton.setAttribute('data-editing', 'false');
        editButton.innerHTML = 'âœï¸';
        editButton.setAttribute('title', 'ç¼–è¾‘æ¶ˆæ¯');
    }

    // å‘é€å›¾ç‰‡æ¶ˆæ¯
    async sendImageMessage(imageDataUrl) {
        const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
        if (!messagesContainer) return;

        // ç¡®ä¿æœ‰å½“å‰ä¼šè¯ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œå…ˆåˆå§‹åŒ–ä¼šè¯ï¼‰
        if (!this.currentSessionId) {
            await this.initSession();
            // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜
            this.updateChatHeaderTitle();
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¸¦å›¾ç‰‡ï¼‰
        const userMessage = this.createMessageElement('', 'user', imageDataUrl);
        messagesContainer.appendChild(userMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ä¼šè¯ï¼ˆæ³¨æ„ï¼šå·²ç§»é™¤è‡ªåŠ¨ä¿å­˜ï¼Œä»…åœ¨ä¿å­˜æ—¶åŒæ­¥ï¼‰
        await this.addMessageToSession('user', '', null, false, imageDataUrl);
        
        // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ æ“ä½œæŒ‰é’®ï¼ˆåŒ…æ‹¬æœºå™¨äººæŒ‰é’®ï¼‰
        await this.addActionButtonsToMessage(userMessage);
        
        // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ é™¤ã€ç¼–è¾‘å’Œé‡æ–°å‘é€æŒ‰é’®
        const userBubble = userMessage.querySelector('[data-message-type="user-bubble"]');
        const copyButtonContainer = userMessage.querySelector('[data-copy-button-container]');
        if (copyButtonContainer && userBubble) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™äº›æŒ‰é’®ï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æŒ‰é’®ï¼‰
            if (!copyButtonContainer.querySelector('.delete-button')) {
                this.addDeleteButtonForUserMessage(copyButtonContainer, userBubble);
            }
            // æ·»åŠ æ’åºæŒ‰é’®
            this.addSortButtons(copyButtonContainer, userMessage);
        }

        // è°ƒç”¨ session/save ä¿å­˜ä¼šè¯åˆ°åç«¯
        try {
            // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆåŒæ­¥DOMä¸­çš„å®Œæ•´æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
            await this.saveCurrentSession(false, false);
            
            // è°ƒç”¨ session/save æ¥å£ä¿å­˜ä¼šè¯
            // ä¼ å…¥ processImages: trueï¼Œè¡¨ç¤ºéœ€è¦å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            if (this.currentSessionId && this.sessionApi && PET_CONFIG.api.syncSessionsToBackend) {
                await this.syncSessionToBackend(this.currentSessionId, true, false, true);
                console.log('å›¾ç‰‡æ¶ˆæ¯ä¼šè¯å·²ä¿å­˜åˆ°åç«¯:', this.currentSessionId);
                
                // ä¿å­˜æˆåŠŸåï¼Œé€šè¿‡ä¼šè¯æ¥å£åˆ·æ–°è¯¥ä¼šè¯å†…å®¹
                try {
                    const refreshedSession = await this.sessionApi.getSession(this.currentSessionId, true);
                    if (refreshedSession && this.sessions[this.currentSessionId]) {
                        // æ›´æ–°æœ¬åœ°ä¼šè¯æ•°æ®ï¼Œä¿ç•™æœ¬åœ°çš„æœ€æ–°æ¶ˆæ¯ï¼ˆå¯èƒ½åŒ…å«æœªåŒæ­¥çš„æ•°æ®ï¼‰
                        const localSession = this.sessions[this.currentSessionId];
                        this.sessions[this.currentSessionId] = {
                            ...refreshedSession,
                            // å¦‚æœæœ¬åœ°æ¶ˆæ¯æ›´æ–°ï¼Œä¿ç•™æœ¬åœ°æ¶ˆæ¯
                            messages: localSession.messages?.length > refreshedSession.messages?.length
                                ? localSession.messages
                                : refreshedSession.messages,
                            // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ pageContentï¼ˆå¦‚æœæœ¬åœ°æœ‰å†…å®¹ï¼‰
                            pageContent: (localSession.pageContent && localSession.pageContent.trim() !== '')
                                ? localSession.pageContent
                                : (refreshedSession.pageContent || localSession.pageContent || ''),
                            // ä¼˜å…ˆä¿ç•™æœ¬åœ°çš„ pageTitleï¼ˆå¦‚æœæœ¬åœ°æœ‰å†…å®¹ï¼‰
                            pageTitle: (localSession.pageTitle && localSession.pageTitle.trim() !== '')
                                ? localSession.pageTitle
                                : (refreshedSession.pageTitle || localSession.pageTitle || ''),
                            // ä¿ç•™OSSæ–‡ä»¶ä¼šè¯ä¿¡æ¯
                            _isOssFileSession: localSession._isOssFileSession,
                            _ossFileInfo: localSession._ossFileInfo
                        };
                        console.log('ä¼šè¯å†…å®¹å·²ä»åç«¯åˆ·æ–°:', this.currentSessionId);
                    }
                } catch (refreshError) {
                    console.warn('åˆ·æ–°ä¼šè¯å†…å®¹å¤±è´¥:', refreshError);
                    // åˆ·æ–°å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼Œåªè®°å½•è­¦å‘Š
                }
            } else {
                console.warn('æ— æ³•ä¿å­˜ä¼šè¯ï¼šç¼ºå°‘ä¼šè¯IDã€APIç®¡ç†å™¨æˆ–åŒæ­¥é…ç½®');
            }
        } catch (error) {
            console.error('ä¿å­˜å›¾ç‰‡æ¶ˆæ¯ä¼šè¯å¤±è´¥:', error);
            // æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆå¯é€‰ï¼‰
            const errorMessage = this.createMessageElement('ä¿å­˜ä¼šè¯æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚ğŸ˜”', 'pet');
            messagesContainer.appendChild(errorMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // å›¾ç‰‡æ¶ˆæ¯ä¸å†è‡ªåŠ¨å›å¤
    }

    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
    // @param {string} imageUrl - å›¾ç‰‡URLæˆ–DataURL
    // @param {string} fileName - æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰
    showImagePreview(imageUrl, fileName = '') {
        // å¦‚æœå·²æœ‰é¢„è§ˆå¼¹çª—ï¼Œå…ˆå…³é—­
        const existingModal = document.querySelector('.image-preview-modal');
        if (existingModal) {
            existingModal.remove();
        }

        const modal = document.createElement('div');
        modal.className = 'image-preview-modal';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.95) !important;
            z-index: 2147483650 !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            animation: fadeIn 0.3s ease-out !important;
        `;

        // æ·»åŠ fadeInåŠ¨ç”»
        if (!document.getElementById('image-preview-fade-style')) {
            const style = document.createElement('style');
            style.id = 'image-preview-fade-style';
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }

        // åˆ›å»ºå›¾ç‰‡å®¹å™¨
        const imageContainer = document.createElement('div');
        imageContainer.style.cssText = `
            position: relative !important;
            max-width: 95% !important;
            max-height: 90% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        `;

        // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
        const loadingIndicator = document.createElement('div');
        loadingIndicator.style.cssText = `
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 40px !important;
            height: 40px !important;
            border: 3px solid rgba(255, 255, 255, 0.3) !important;
            border-top-color: #fff !important;
            border-radius: 50% !important;
            animation: spin 0.8s linear infinite !important;
        `;

        // æ·»åŠ spinåŠ¨ç”»
        if (!document.getElementById('image-preview-spin-style')) {
            const style = document.createElement('style');
            style.id = 'image-preview-spin-style';
            style.textContent = `
                @keyframes spin {
                    to { transform: translate(-50%, -50%) rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }

        imageContainer.appendChild(loadingIndicator);

        const img = document.createElement('img');
        img.style.cssText = `
            max-width: 100% !important;
            max-height: 85vh !important;
            border-radius: 8px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5) !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
            object-fit: contain !important;
        `;
        img.alt = fileName || 'å›¾ç‰‡é¢„è§ˆ';

        // å›¾ç‰‡åŠ è½½æˆåŠŸ
        img.onload = () => {
            loadingIndicator.style.display = 'none';
            img.style.opacity = '1';
        };

        // å›¾ç‰‡åŠ è½½å¤±è´¥
        img.onerror = () => {
            loadingIndicator.style.display = 'none';
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = `
                color: white !important;
                text-align: center !important;
                padding: 20px !important;
                font-size: 16px !important;
            `;
            errorMsg.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
            imageContainer.appendChild(errorMsg);
        };

        // ç›´æ¥ä½¿ç”¨OSSæ–‡ä»¶çš„åŸå§‹åœ°å€è¿›è¡Œé¢„è§ˆ
        img.src = imageUrl;
        imageContainer.appendChild(img);

        // åˆ›å»ºæ ‡é¢˜æ ï¼ˆæ˜¾ç¤ºæ–‡ä»¶åï¼‰
        let titleBar = null;
        if (fileName) {
            titleBar = document.createElement('div');
            titleBar.style.cssText = `
                position: absolute !important;
                top: 20px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                background: rgba(0, 0, 0, 0.6) !important;
                color: white !important;
                padding: 8px 16px !important;
                border-radius: 20px !important;
                font-size: 14px !important;
                max-width: 80% !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
                backdrop-filter: blur(10px) !important;
            `;
            titleBar.textContent = fileName;
            modal.appendChild(titleBar);
        }

        // åˆ›å»ºæŒ‰é’®å®¹å™¨ï¼ˆä¸‹è½½å’Œå…³é—­æŒ‰é’®ï¼‰
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
            position: absolute !important;
            top: 20px !important;
            right: 20px !important;
            display: flex !important;
            gap: 12px !important;
            align-items: center !important;
        `;

        // åˆ›å»ºä¸‹è½½æŒ‰é’®ï¼ˆä»…å½“æœ‰æ–‡ä»¶åæ—¶æ˜¾ç¤ºï¼‰
        let downloadBtn = null;
        if (fileName) {
            downloadBtn = document.createElement('button');
            downloadBtn.innerHTML = 'â¬‡ï¸';
            downloadBtn.title = 'ä¸‹è½½æ–‡ä»¶';
            downloadBtn.style.cssText = `
                background: rgba(255, 255, 255, 0.15) !important;
                color: white !important;
                border: none !important;
                width: 44px !important;
                height: 44px !important;
                border-radius: 50% !important;
                font-size: 20px !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                backdrop-filter: blur(10px) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                line-height: 1 !important;
            `;
            downloadBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                // fileName å°±æ˜¯æ–‡ä»¶å¯¹è±¡åï¼ˆobjectNameï¼‰ï¼Œç›´æ¥ä½¿ç”¨
                await this.downloadOssFile(fileName);
            });

            downloadBtn.addEventListener('mouseenter', () => {
                downloadBtn.style.background = 'rgba(255, 255, 255, 0.25)';
                downloadBtn.style.transform = 'scale(1.1)';
            });

            downloadBtn.addEventListener('mouseleave', () => {
                downloadBtn.style.background = 'rgba(255, 255, 255, 0.15)';
                downloadBtn.style.transform = 'scale(1)';
            });

            buttonContainer.appendChild(downloadBtn);
        }

        // åˆ›å»ºå…³é—­æŒ‰é’®
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
            background: rgba(255, 255, 255, 0.15) !important;
            color: white !important;
            border: none !important;
            width: 44px !important;
            height: 44px !important;
            border-radius: 50% !important;
            font-size: 24px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            backdrop-filter: blur(10px) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            line-height: 1 !important;
        `;
        closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            modal.remove();
        });

        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(255, 255, 255, 0.25)';
            closeBtn.style.transform = 'scale(1.1)';
        });

        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(255, 255, 255, 0.15)';
            closeBtn.style.transform = 'scale(1)';
        });

        buttonContainer.appendChild(closeBtn);

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });

        // æŒ‰ESCé”®å…³é—­
        const handleKeyDown = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', handleKeyDown);
            }
        };
        document.addEventListener('keydown', handleKeyDown);

        modal.appendChild(imageContainer);
        modal.appendChild(buttonContainer);
        document.body.appendChild(modal);
    }

    // è·å–å½“å‰æ—¶é—´
    // è·å–é¡µé¢å›¾æ ‡URLï¼ˆè¾…åŠ©æ–¹æ³•ï¼‰
    getPageIconUrl() {
        let iconUrl = '';
        const linkTags = document.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"]');
        if (linkTags.length > 0) {
            iconUrl = linkTags[0].href;
            if (!iconUrl.startsWith('http')) {
                iconUrl = new URL(iconUrl, window.location.origin).href;
            }
        }
        if (!iconUrl) {
            iconUrl = '/favicon.ico';
            if (!iconUrl.startsWith('http')) {
                iconUrl = new URL(iconUrl, window.location.origin).href;
            }
        }
        return iconUrl;
    }

    // åˆ›å»ºæ¬¢è¿æ¶ˆæ¯ï¼ˆé‡æ„åçš„ç»Ÿä¸€æ–¹æ³•ï¼‰
    // @param {HTMLElement} messagesContainer - æ¶ˆæ¯å®¹å™¨
    // @param {Object} pageInfo - é¡µé¢ä¿¡æ¯å¯¹è±¡ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨å½“å‰é¡µé¢ä¿¡æ¯ï¼‰
    //   - title: é¡µé¢æ ‡é¢˜
    //   - url: é¡µé¢URL
    //   - description: é¡µé¢æè¿°ï¼ˆå¯é€‰ï¼‰
    async createWelcomeMessage(messagesContainer, pageInfo = null) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯OSSæ–‡ä»¶ä¼šè¯
        const session = this.currentSessionId ? this.sessions[this.currentSessionId] : null;
        const isOssFileSession = session && session._isOssFileSession;
        const ossFileInfo = session && session._ossFileInfo ? session._ossFileInfo : null;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥å£ä¼šè¯
        const isApiRequestSession = session && session._isApiRequestSession;
        const apiRequestInfo = session && session._apiRequestInfo ? session._apiRequestInfo : null;
        
        // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œä½¿ç”¨OSSæ–‡ä»¶ä¿¡æ¯
        if (isOssFileSession && ossFileInfo) {
            return await this.createOssFileWelcomeMessage(messagesContainer, ossFileInfo);
        }
        
        // å¦‚æœæ˜¯æ¥å£ä¼šè¯ï¼Œä½¿ç”¨æ¥å£ä¿¡æ¯
        if (isApiRequestSession && apiRequestInfo) {
            return await this.createApiRequestWelcomeMessage(messagesContainer, apiRequestInfo);
        }
        
        // å¦‚æœæ²¡æœ‰æä¾›é¡µé¢ä¿¡æ¯ï¼Œä½¿ç”¨å½“å‰é¡µé¢ä¿¡æ¯æˆ–ä¼šè¯ä¿¡æ¯
        if (!pageInfo) {
            // ä¼˜å…ˆä½¿ç”¨å½“å‰ä¼šè¯çš„é¡µé¢ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰é¡µé¢ä¿¡æ¯
            if (this.currentSessionId && this.sessions[this.currentSessionId]) {
                const session = this.sessions[this.currentSessionId];
                pageInfo = {
                    title: session.pageTitle || document.title || 'å½“å‰é¡µé¢',
                    url: session.url || window.location.href,
                    description: session.pageDescription || ''
                };
            } else {
                // ä½¿ç”¨ getPageInfo æ–¹æ³•è·å–å½“å‰é¡µé¢ä¿¡æ¯
                const currentPageInfo = this.getPageInfo();
                pageInfo = {
                    title: currentPageInfo.title,
                    url: currentPageInfo.url,
                    description: currentPageInfo.description || ''
                };
            }
        }

        // è·å–é¡µé¢å›¾æ ‡
        const pageIconUrl = this.getPageIconUrl();

        // æ„å»ºé¡µé¢ä¿¡æ¯æ˜¾ç¤ºå†…å®¹ï¼ˆä¼˜åŒ–åçš„HTMLç»“æ„ï¼‰
        let pageInfoHtml = `
            <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(68, 160, 141, 0.05)); border-radius: 12px; border-left: 3px solid #4ECDC4;">
                <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <img src="${pageIconUrl}" alt="é¡µé¢å›¾æ ‡" style="width: 20px; height: 20px; border-radius: 4px; object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none'">
                    <span style="font-weight: 600; font-size: 15px; color: #374151;">${this.escapeHtml(pageInfo.title)}</span>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; font-weight: 500;">ğŸ”— ç½‘å€</div>
                    <a href="${pageInfo.url}" target="_blank" style="word-break: break-all; color: #2196F3; text-decoration: none; font-size: 13px; display: inline-block; max-width: 100%;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${this.escapeHtml(pageInfo.url)}</a>
                </div>
        `;

        if (pageInfo.description && pageInfo.description.trim()) {
            pageInfoHtml += `
                <div style="margin-bottom: 0;">
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; font-weight: 500;">ğŸ“ é¡µé¢æè¿°</div>
                    <div class="markdown-content" style="font-size: 13px; color: #4B5563; line-height: 1.5;">${this.renderMarkdown(pageInfo.description)}</div>
                </div>
            `;
        }

        pageInfoHtml += `</div>`;
        
        // æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦å·²å­˜åœ¨äºåç«¯ä¼šè¯åˆ—è¡¨ä¸­ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºä¿å­˜æŒ‰é’®
        const shouldShowSaveButton = !(await this.isSessionInBackendList(this.currentSessionId));
        
        // æ ¹æ®æ£€æŸ¥ç»“æœå†³å®šæ˜¯å¦æ·»åŠ æ‰‹åŠ¨ä¿å­˜ä¼šè¯æŒ‰é’®
        if (shouldShowSaveButton) {
        pageInfoHtml += `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(78, 205, 196, 0.2);">
                <button id="pet-manual-save-session-btn" class="pet-manual-save-btn" style="
                    position: relative !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    gap: 8px !important;
                    width: 100% !important;
                    padding: 10px 20px !important;
                    background: linear-gradient(135deg, #4ECDC4, #44A08D) !important;
                    color: white !important;
                    border: none !important;
                    border-radius: 10px !important;
                    font-size: 14px !important;
                    font-weight: 600 !important;
                    cursor: pointer !important;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                    box-shadow: 0 2px 8px rgba(78, 205, 196, 0.25), 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                    overflow: hidden !important;
                    user-select: none !important;
                ">
                    <span class="save-btn-icon" style="
                        display: inline-flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        font-size: 16px !important;
                        transition: transform 0.3s ease !important;
                    ">ğŸ’¾</span>
                    <span class="save-btn-text">ä¿å­˜ä¼šè¯</span>
                    <span class="save-btn-loader" style="
                        display: none !important;
                        position: absolute !important;
                        width: 16px !important;
                        height: 16px !important;
                        border: 2px solid rgba(255, 255, 255, 0.3) !important;
                        border-top-color: white !important;
                        border-radius: 50% !important;
                        animation: spin 0.8s linear infinite !important;
                    "></span>
                </button>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                    .pet-manual-save-btn:hover:not(:disabled) {
                        transform: translateY(-2px) !important;
                        box-shadow: 0 4px 12px rgba(78, 205, 196, 0.35), 0 2px 6px rgba(0, 0, 0, 0.15) !important;
                    }
                    .pet-manual-save-btn:active:not(:disabled) {
                        transform: translateY(0) !important;
                        box-shadow: 0 1px 4px rgba(78, 205, 196, 0.2) !important;
                    }
                    .pet-manual-save-btn:disabled {
                        opacity: 0.7 !important;
                        cursor: not-allowed !important;
                        transform: none !important;
                    }
                    .pet-manual-save-btn.loading .save-btn-icon,
                    .pet-manual-save-btn.loading .save-btn-text {
                        opacity: 0 !important;
                    }
                    .pet-manual-save-btn.loading .save-btn-loader {
                        display: block !important;
                    }
                    .pet-manual-save-btn.success {
                        background: linear-gradient(135deg, #4CAF50, #45a049) !important;
                        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3) !important;
                    }
                    .pet-manual-save-btn.error {
                        background: linear-gradient(135deg, #f44336, #d32f2f) !important;
                        box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3) !important;
                    }
                </style>
            </div>
        `;
        }

        // åˆ›å»ºæ¬¢è¿æ¶ˆæ¯å…ƒç´ 
        const welcomeMessage = this.createMessageElement('', 'pet');
        welcomeMessage.setAttribute('data-welcome-message', 'true');
        messagesContainer.appendChild(welcomeMessage);
        
        const messageText = welcomeMessage.querySelector('[data-message-type="pet-bubble"]');
        if (messageText) {
            messageText.innerHTML = pageInfoHtml;
            // ä¿å­˜åŸå§‹HTMLç”¨äºåç»­ä¿å­˜ï¼ˆè™½ç„¶æ¬¢è¿æ¶ˆæ¯ä¸ä¼šè¢«ä¿å­˜åˆ°æ¶ˆæ¯æ•°ç»„ä¸­ï¼‰
            messageText.setAttribute('data-original-text', pageInfoHtml);
            
            // ç»‘å®šæ‰‹åŠ¨ä¿å­˜æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const saveBtn = messageText.querySelector('#pet-manual-save-session-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    this.handleManualSaveSession(saveBtn);
                });
            }
        }

        return welcomeMessage;
    }
    
    // åˆ›å»ºOSSæ–‡ä»¶æ¬¢è¿æ¶ˆæ¯
    async createOssFileWelcomeMessage(messagesContainer, fileInfo) {
        // æ„å»ºOSSæ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºå†…å®¹
        let fileInfoHtml = `
            <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(68, 160, 141, 0.05)); border-radius: 12px; border-left: 3px solid #4ECDC4;">
                <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">ğŸ“„</span>
                    <span style="font-weight: 600; font-size: 15px; color: #374151;">${this.escapeHtml(fileInfo.name || 'OSSæ–‡ä»¶')}</span>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; font-weight: 500;">ğŸ”— æ–‡ä»¶åœ°å€</div>
                    <a href="${fileInfo.url}" target="_blank" style="word-break: break-all; color: #2196F3; text-decoration: none; font-size: 13px; display: inline-block; max-width: 100%;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${this.escapeHtml(fileInfo.url)}</a>
                </div>
        `;
        
        // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼ˆç´§æŒ¨ç€æ–‡ä»¶åœ°å€ä¸‹é¢ï¼Œä½¿ç”¨å ä½ç¬¦ï¼Œç¨åå¼‚æ­¥åŠ è½½ï¼‰
        if (fileInfo.isImage && (fileInfo.url || fileInfo.name)) {
            const objectName = fileInfo.url || fileInfo.name;
            const previewId = `oss-preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            fileInfoHtml += `
                <div style="margin-bottom: 12px;" data-oss-preview-section data-oss-object-name="${this.escapeHtml(objectName)}">
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px; font-weight: 500;">ğŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆ</div>
                    <div id="${previewId}" data-oss-preview-container style="border-radius: 8px; overflow: hidden; background: #f3f4f6; padding: 8px; display: inline-block; max-width: 100%;">
                        <div style="padding: 40px; text-align: center; color: #9ca3af; font-size: 14px;">æ­£åœ¨åŠ è½½å›¾ç‰‡...</div>
                    </div>
                </div>
            `;
            
            // å¼‚æ­¥åŠ è½½å›¾ç‰‡ï¼ˆåœ¨ DOM æ›´æ–°åï¼‰
            setTimeout(async () => {
                const previewContainer = document.getElementById(previewId);
                if (!previewContainer) {
                    return;
                }
                
                try {
                    let downloadUrl = null;
                    const objectNameValue = objectName;
                    
                    // å¦‚æœå¯¹è±¡åçœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„URLï¼ˆåŒ…å« http:// æˆ– https://ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
                    if (objectNameValue.startsWith('http://') || objectNameValue.startsWith('https://')) {
                        downloadUrl = objectNameValue;
                        console.log('æ£€æµ‹åˆ°å®Œæ•´URLï¼Œç›´æ¥ä½¿ç”¨:', downloadUrl);
                    } else {
                        // å¦åˆ™ï¼Œé€šè¿‡OSS APIè·å–ä¸‹è½½URL
                        if (!this.ossApi || !this.ossApi.isEnabled()) {
                            throw new Error('OSS APIæœªå¯ç”¨ï¼Œæ— æ³•è·å–å›¾ç‰‡ä¸‹è½½URL');
                        }
                        
                        console.log('æ­£åœ¨é€šè¿‡OSS APIè·å–ä¸‹è½½URLï¼ˆåˆ›å»ºæ¬¢è¿æ¶ˆæ¯ï¼‰ï¼Œå¯¹è±¡å:', objectNameValue);
                        downloadUrl = await this.ossApi.getDownloadUrl(objectNameValue, 3600);
                        
                        if (!downloadUrl) {
                            throw new Error('è·å–ä¸‹è½½URLå¤±è´¥ï¼Œè¿”å›ä¸ºç©º');
                        }
                        
                        console.log('æˆåŠŸè·å–OSSå›¾ç‰‡ä¸‹è½½URLï¼ˆåˆ›å»ºæ¬¢è¿æ¶ˆæ¯ï¼‰:', downloadUrl);
                    }
                    
                    // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                    const img = document.createElement('img');
                    // ä½¿ç”¨OSSå›¾ç‰‡å¤„ç†ä¼˜åŒ–æ¬¢è¿æ¶ˆæ¯ä¸­çš„å›¾ç‰‡ï¼ˆæœ€å¤§å®½åº¦800pxï¼Œè´¨é‡80ï¼‰
                    const optimizedUrl = this.generateOssImageProcessUrl(downloadUrl, {
                        width: 800,
                        quality: 80,
                        keepAspectRatio: true
                    });
                    img.src = optimizedUrl;
                    img.alt = this.escapeHtml(fileInfo.name || 'å›¾ç‰‡é¢„è§ˆ');
                    img.style.cssText = 'max-width: 100%; max-height: 400px; border-radius: 4px; object-fit: contain; display: block; margin: 0 auto; cursor: pointer;';
                    
                    // å›¾ç‰‡åŠ è½½æˆåŠŸå¤„ç†
                    img.addEventListener('load', () => {
                        console.log('OSSå›¾ç‰‡åŠ è½½æˆåŠŸï¼ˆåˆ›å»ºæ¬¢è¿æ¶ˆæ¯ï¼‰:', downloadUrl);
                    });
                    
                    // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
                    img.addEventListener('error', () => {
                        console.warn('OSSå›¾ç‰‡åŠ è½½å¤±è´¥ï¼ˆåˆ›å»ºæ¬¢è¿æ¶ˆæ¯ï¼‰:', downloadUrl);
                        previewContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
                    });
                    
                    // ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
                    img.addEventListener('click', () => {
                        this.showImagePreview(downloadUrl);
                    });
                    
                    // æ›´æ–°å®¹å™¨å†…å®¹
                    previewContainer.innerHTML = '';
                    previewContainer.appendChild(img);
                    
                } catch (error) {
                    console.error('è·å–OSSå›¾ç‰‡ä¸‹è½½URLå¤±è´¥ï¼ˆåˆ›å»ºæ¬¢è¿æ¶ˆæ¯ï¼‰:', error);
                    previewContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #ef4444;">æ— æ³•åŠ è½½å›¾ç‰‡é¢„è§ˆï¼š${this.escapeHtml(error.message || 'æœªçŸ¥é”™è¯¯')}</div>`;
                }
            }, 0);
        }
        
        // å¦‚æœæœ‰æè¿°ï¼Œæ˜¾ç¤ºæè¿°ï¼ˆåœ¨å›¾ç‰‡é¢„è§ˆä¹‹åï¼‰
        if (fileInfo.description && fileInfo.description.trim()) {
            fileInfoHtml += `
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; font-weight: 500;">ğŸ“ æ–‡ä»¶æè¿°</div>
                    <div style="font-size: 13px; color: #4B5563; line-height: 1.5;">${this.escapeHtml(fileInfo.description)}</div>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶å…ƒä¿¡æ¯ï¼ˆå¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰ï¼‰
        if (fileInfo.size_human || fileInfo.last_modified_str) {
            fileInfoHtml += `
                <div style="margin-bottom: 0; padding-top: 12px; border-top: 1px solid rgba(78, 205, 196, 0.2);">
                    <div style="font-size: 12px; color: #6B7280; display: flex; gap: 16px; flex-wrap: wrap;">
                        ${fileInfo.size_human ? `<span>ğŸ“Š å¤§å°: ${this.escapeHtml(fileInfo.size_human)}</span>` : ''}
                        ${fileInfo.last_modified_str ? `<span>ğŸ“… ä¿®æ”¹æ—¶é—´: ${this.escapeHtml(fileInfo.last_modified_str)}</span>` : ''}
                    </div>
                </div>
            `;
        }
        
        fileInfoHtml += `</div>`;
        
        // æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦å·²å­˜åœ¨äºåç«¯ä¼šè¯åˆ—è¡¨ä¸­ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºä¿å­˜æŒ‰é’®
        const shouldShowSaveButton = !(await this.isSessionInBackendList(this.currentSessionId));
        
        // æ ¹æ®æ£€æŸ¥ç»“æœå†³å®šæ˜¯å¦æ·»åŠ æ‰‹åŠ¨ä¿å­˜ä¼šè¯æŒ‰é’®
        if (shouldShowSaveButton) {
            fileInfoHtml += `
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(78, 205, 196, 0.2);">
                    <button id="pet-manual-save-session-btn" class="pet-manual-save-btn" style="
                        position: relative !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 8px !important;
                        width: 100% !important;
                        padding: 10px 20px !important;
                        background: linear-gradient(135deg, #4ECDC4, #44A08D) !important;
                        color: white !important;
                        border: none !important;
                        border-radius: 10px !important;
                        font-size: 14px !important;
                        font-weight: 600 !important;
                        cursor: pointer !important;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                        box-shadow: 0 2px 8px rgba(78, 205, 196, 0.25), 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                        overflow: hidden !important;
                        user-select: none !important;
                    ">
                        <span class="save-btn-icon" style="
                            display: inline-flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            font-size: 16px !important;
                            transition: transform 0.3s ease !important;
                        ">ğŸ’¾</span>
                        <span class="save-btn-text">ä¿å­˜ä¼šè¯</span>
                        <span class="save-btn-loader" style="
                            display: none !important;
                            position: absolute !important;
                            width: 16px !important;
                            height: 16px !important;
                            border: 2px solid rgba(255, 255, 255, 0.3) !important;
                            border-top-color: white !important;
                            border-radius: 50% !important;
                            animation: spin 0.8s linear infinite !important;
                        "></span>
                    </button>
                    <style>
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                        .pet-manual-save-btn:hover:not(:disabled) {
                            transform: translateY(-2px) !important;
                            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.35), 0 2px 6px rgba(0, 0, 0, 0.15) !important;
                        }
                        .pet-manual-save-btn:active:not(:disabled) {
                            transform: translateY(0) !important;
                            box-shadow: 0 1px 4px rgba(78, 205, 196, 0.2) !important;
                        }
                        .pet-manual-save-btn:disabled {
                            opacity: 0.7 !important;
                            cursor: not-allowed !important;
                            transform: none !important;
                        }
                        .pet-manual-save-btn.loading .save-btn-icon,
                        .pet-manual-save-btn.loading .save-btn-text {
                            opacity: 0 !important;
                        }
                        .pet-manual-save-btn.loading .save-btn-loader {
                            display: block !important;
                        }
                        .pet-manual-save-btn.success {
                            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
                            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3) !important;
                        }
                        .pet-manual-save-btn.error {
                            background: linear-gradient(135deg, #f44336, #d32f2f) !important;
                            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3) !important;
                        }
                    </style>
                </div>
            `;
        }
        
        // åˆ›å»ºæ¬¢è¿æ¶ˆæ¯å…ƒç´ 
        const welcomeMessage = this.createMessageElement('', 'pet');
        welcomeMessage.setAttribute('data-welcome-message', 'true');
        messagesContainer.appendChild(welcomeMessage);
        
        const messageText = welcomeMessage.querySelector('[data-message-type="pet-bubble"]');
        if (messageText) {
            messageText.innerHTML = fileInfoHtml;
            // ä¿å­˜åŸå§‹HTMLç”¨äºåç»­ä¿å­˜ï¼ˆè™½ç„¶æ¬¢è¿æ¶ˆæ¯ä¸ä¼šè¢«ä¿å­˜åˆ°æ¶ˆæ¯æ•°ç»„ä¸­ï¼‰
            messageText.setAttribute('data-original-text', fileInfoHtml);
            
            // ç»‘å®šæ‰‹åŠ¨ä¿å­˜æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const saveBtn = messageText.querySelector('#pet-manual-save-session-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    this.handleManualSaveSession(saveBtn);
                });
            }
        }
        
        return welcomeMessage;
    }
    
    // åˆ›å»ºæ¥å£è¯·æ±‚æ¬¢è¿æ¶ˆæ¯
    async createApiRequestWelcomeMessage(messagesContainer, apiRequestInfo) {
        // ä¼˜å…ˆä½¿ç”¨ requestUrl å­—æ®µï¼ˆæ–°å»ºçš„è¯·æ±‚æ¥å£ï¼‰ï¼Œå…¼å®¹ url å­—æ®µï¼ˆæ—§æ•°æ®ï¼‰
        const requestUrl = apiRequestInfo.requestUrl || apiRequestInfo.url || '';
        // æ„å»ºæ¥å£è¯·æ±‚ä¿¡æ¯æ˜¾ç¤ºå†…å®¹
        const apiPath = this._extractApiPath(requestUrl);
        const method = apiRequestInfo.method || 'GET';
        const status = apiRequestInfo.status || 0;
        const statusText = apiRequestInfo.statusText || '';
        const duration = apiRequestInfo.duration || 0;
        const timestamp = apiRequestInfo.timestamp || Date.now();
        
        // ä¼˜åŒ–åçš„æ’ç‰ˆï¼šä½¿ç”¨æ›´æ¸…æ™°çš„è§†è§‰å±‚æ¬¡å’Œé—´è·
        let apiRequestHtml = `
            <div style="margin: 0; padding: 0;">
                <!-- æ ‡é¢˜åŒºåŸŸ -->
                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.15);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="font-size: 22px; line-height: 1;">ğŸ”Œ</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="display: inline-block; padding: 4px 10px; background: rgba(255, 255, 255, 0.2); border-radius: 6px; font-size: 12px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;">${this.escapeHtml(method)}</span>
                                <span style="font-weight: 600; font-size: 15px; color: rgba(255, 255, 255, 0.95); word-break: break-word;">${this.escapeHtml(apiPath)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ä¿¡æ¯åŒºåŸŸ -->
                <div style="display: flex; flex-direction: column; gap: 14px;">
        `;
        
        // æ¥å£åœ°å€
        apiRequestHtml += `
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 14px; opacity: 0.9;">ğŸ”—</span>
                            <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7); font-weight: 500;">æ¥å£åœ°å€</span>
                        </div>
                        <a href="${requestUrl}" target="_blank" style="word-break: break-all; color: rgba(255, 255, 255, 0.9); text-decoration: none; font-size: 13px; line-height: 1.5; padding: 8px 10px; background: rgba(0, 0, 0, 0.15); border-radius: 6px; transition: all 0.2s ease; display: block;" onmouseover="this.style.background='rgba(0, 0, 0, 0.25)'; this.style.textDecoration='underline'" onmouseout="this.style.background='rgba(0, 0, 0, 0.15)'; this.style.textDecoration='none'">${this.escapeHtml(requestUrl)}</a>
                    </div>
        `;
        
        // å¦‚æœæœ‰çŠ¶æ€ç ï¼Œæ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        if (status > 0) {
            const statusColor = status >= 200 && status < 300 ? 'rgba(76, 175, 80, 0.9)' : status >= 400 ? 'rgba(244, 67, 54, 0.9)' : 'rgba(255, 152, 0, 0.9)';
            apiRequestHtml += `
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 14px; opacity: 0.9;">ğŸ“Š</span>
                            <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7); font-weight: 500;">å“åº”çŠ¶æ€</span>
                        </div>
                        <div style="font-size: 14px; color: ${statusColor}; font-weight: 600; padding: 6px 10px; background: rgba(0, 0, 0, 0.15); border-radius: 6px; display: inline-block;">${status} ${statusText || ''}</div>
                    </div>
            `;
        }
        
        // å¦‚æœæœ‰å“åº”æ—¶é—´ï¼Œæ˜¾ç¤ºå“åº”æ—¶é—´
        if (duration > 0) {
            apiRequestHtml += `
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 14px; opacity: 0.9;">â±ï¸</span>
                            <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7); font-weight: 500;">å“åº”æ—¶é—´</span>
                        </div>
                        <div style="font-size: 14px; color: rgba(255, 255, 255, 0.9); padding: 6px 10px; background: rgba(0, 0, 0, 0.15); border-radius: 6px; display: inline-block; font-weight: 500;">${duration}ms</div>
                    </div>
            `;
        }
        
        // å¦‚æœæœ‰é¡µé¢URLï¼Œæ˜¾ç¤ºé¡µé¢URL
        if (apiRequestInfo.pageUrl) {
            apiRequestHtml += `
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 14px; opacity: 0.9;">ğŸŒ</span>
                            <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7); font-weight: 500;">é¡µé¢åœ°å€</span>
                        </div>
                        <a href="${apiRequestInfo.pageUrl}" target="_blank" style="word-break: break-all; color: rgba(255, 255, 255, 0.9); text-decoration: none; font-size: 13px; line-height: 1.5; padding: 8px 10px; background: rgba(0, 0, 0, 0.15); border-radius: 6px; transition: all 0.2s ease; display: block;" onmouseover="this.style.background='rgba(0, 0, 0, 0.25)'; this.style.textDecoration='underline'" onmouseout="this.style.background='rgba(0, 0, 0, 0.15)'; this.style.textDecoration='none'">${this.escapeHtml(apiRequestInfo.pageUrl)}</a>
                    </div>
            `;
        }
        
        // å¦‚æœæœ‰å“åº”å†…å®¹ï¼Œæ˜¾ç¤ºå“åº”å†…å®¹é¢„è§ˆ
        if (apiRequestInfo.responseText || apiRequestInfo.responseBody) {
            const responseContent = apiRequestInfo.responseText || JSON.stringify(apiRequestInfo.responseBody, null, 2);
            // å¯¹äºè¾ƒé•¿çš„å†…å®¹ï¼Œåªæ˜¾ç¤ºå‰500å­—ç¬¦ï¼Œä¸è®¾ç½®æ»šåŠ¨æ¡
            const previewText = responseContent.length > 500 ? responseContent.substring(0, 500) + '...' : responseContent;
            apiRequestHtml += `
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 14px; opacity: 0.9;">ğŸ“„</span>
                            <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7); font-weight: 500;">å“åº”å†…å®¹</span>
                        </div>
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.85); line-height: 1.6; background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 6px; font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Consolas', 'Courier New', monospace; white-space: pre-wrap; word-break: break-word; border: 1px solid rgba(255, 255, 255, 0.1); overflow: visible;">${this.escapeHtml(previewText)}</div>
                    </div>
            `;
        }
        
        apiRequestHtml += `
                </div>
            </div>
        `;
        
        // æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦å·²å­˜åœ¨äºåç«¯ä¼šè¯åˆ—è¡¨ä¸­ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºä¿å­˜æŒ‰é’®
        const shouldShowSaveButton = !(await this.isSessionInBackendList(this.currentSessionId));
        
        // æ ¹æ®æ£€æŸ¥ç»“æœå†³å®šæ˜¯å¦æ·»åŠ æ‰‹åŠ¨ä¿å­˜ä¼šè¯æŒ‰é’®
        if (shouldShowSaveButton) {
            apiRequestHtml += `
                <div style="margin-top: 20px; padding-top: 18px; border-top: 1px solid rgba(255, 255, 255, 0.15);">
                    <button id="pet-manual-save-session-btn" class="pet-manual-save-btn" style="
                        position: relative !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 10px !important;
                        width: 100% !important;
                        padding: 12px 20px !important;
                        background: linear-gradient(135deg, rgba(78, 205, 196, 0.9), rgba(68, 160, 141, 0.9)) !important;
                        color: white !important;
                        border: none !important;
                        border-radius: 8px !important;
                        font-size: 14px !important;
                        font-weight: 600 !important;
                        cursor: pointer !important;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                        box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2) !important;
                        overflow: hidden !important;
                        user-select: none !important;
                    ">
                        <span class="save-btn-icon" style="
                            display: inline-flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            font-size: 16px !important;
                            transition: transform 0.3s ease !important;
                        ">ğŸ’¾</span>
                        <span class="save-btn-text">ä¿å­˜ä¼šè¯</span>
                        <span class="save-btn-loader" style="
                            display: none !important;
                            position: absolute !important;
                            width: 16px !important;
                            height: 16px !important;
                            border: 2px solid rgba(255, 255, 255, 0.3) !important;
                            border-top-color: white !important;
                            border-radius: 50% !important;
                            animation: spin 0.8s linear infinite !important;
                        "></span>
                    </button>
                    <style>
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                        .pet-manual-save-btn:hover:not(:disabled) {
                            transform: translateY(-2px) !important;
                            box-shadow: 0 4px 16px rgba(78, 205, 196, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2) !important;
                            background: linear-gradient(135deg, rgba(78, 205, 196, 1), rgba(68, 160, 141, 1)) !important;
                        }
                        .pet-manual-save-btn:active:not(:disabled) {
                            transform: translateY(0) !important;
                            box-shadow: 0 1px 4px rgba(78, 205, 196, 0.3) !important;
                        }
                        .pet-manual-save-btn:disabled {
                            opacity: 0.6 !important;
                            cursor: not-allowed !important;
                            transform: none !important;
                        }
                        .pet-manual-save-btn.loading .save-btn-icon,
                        .pet-manual-save-btn.loading .save-btn-text {
                            opacity: 0 !important;
                        }
                        .pet-manual-save-btn.loading .save-btn-loader {
                            display: block !important;
                        }
                        .pet-manual-save-btn.success {
                            background: linear-gradient(135deg, rgba(76, 175, 80, 0.9), rgba(69, 160, 73, 0.9)) !important;
                            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.35) !important;
                        }
                        .pet-manual-save-btn.error {
                            background: linear-gradient(135deg, rgba(244, 67, 54, 0.9), rgba(211, 47, 47, 0.9)) !important;
                            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.35) !important;
                        }
                    </style>
                </div>
            `;
        }
        
        // åˆ›å»ºæ¬¢è¿æ¶ˆæ¯å…ƒç´ 
        const welcomeMessage = this.createMessageElement('', 'pet');
        welcomeMessage.setAttribute('data-welcome-message', 'true');
        messagesContainer.appendChild(welcomeMessage);
        
        const messageText = welcomeMessage.querySelector('[data-message-type="pet-bubble"]');
        if (messageText) {
            messageText.innerHTML = apiRequestHtml;
            // ä¿å­˜åŸå§‹HTMLç”¨äºåç»­ä¿å­˜ï¼ˆè™½ç„¶æ¬¢è¿æ¶ˆæ¯ä¸ä¼šè¢«ä¿å­˜åˆ°æ¶ˆæ¯æ•°ç»„ä¸­ï¼‰
            messageText.setAttribute('data-original-text', apiRequestHtml);
            
            // ç»‘å®šæ‰‹åŠ¨ä¿å­˜æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const saveBtn = messageText.querySelector('#pet-manual-save-session-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    this.handleManualSaveApiRequestSession(saveBtn);
                });
            }
        }
        
        return welcomeMessage;
    }

    // åˆ·æ–°ç¬¬ä¸€æ¡æ¬¢è¿æ¶ˆæ¯ï¼ˆå½“ä¼šè¯ä¿¡æ¯æ›´æ–°æ—¶è°ƒç”¨ï¼‰
    async refreshWelcomeMessage() {
        if (!this.chatWindow || !this.currentSessionId) {
            return;
        }

        const messagesContainer = this.chatWindow.querySelector('#pet-chat-messages');
        if (!messagesContainer) {
            return;
        }

        // æŸ¥æ‰¾ç¬¬ä¸€æ¡æ¬¢è¿æ¶ˆæ¯
        const welcomeMessage = messagesContainer.querySelector('[data-welcome-message]');
        if (!welcomeMessage) {
            console.log('æœªæ‰¾åˆ°æ¬¢è¿æ¶ˆæ¯ï¼Œè·³è¿‡åˆ·æ–°');
            return;
        }

        // è·å–å½“å‰ä¼šè¯çš„æ›´æ–°åçš„é¡µé¢ä¿¡æ¯
        const session = this.sessions[this.currentSessionId];
        if (!session) {
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯OSSæ–‡ä»¶ä¼šè¯
        const isOssFileSession = session && session._isOssFileSession;
        const ossFileInfo = session && session._ossFileInfo ? session._ossFileInfo : null;

        // å¦‚æœæ˜¯OSSæ–‡ä»¶ä¼šè¯ï¼Œä½¿ç”¨OSSæ–‡ä»¶ä¿¡æ¯æ›´æ–°æ¬¢è¿æ¶ˆæ¯
        if (isOssFileSession && ossFileInfo) {
            // è·å–å½“å‰æ¬¢è¿æ¶ˆæ¯ä¸­çš„å›¾ç‰‡é¢„è§ˆå®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const messageText = welcomeMessage.querySelector('[data-message-type="pet-bubble"]');
            let existingPreviewInfo = null;
            let needReloadImage = true;
            
            if (messageText) {
                // æŸ¥æ‰¾ç°æœ‰çš„å›¾ç‰‡é¢„è§ˆå®¹å™¨
                const previewSection = messageText.querySelector('[data-oss-preview-section]');
                if (previewSection) {
                    const existingPreviewContainer = previewSection.querySelector('[data-oss-preview-container]');
                    const existingObjectName = previewSection.getAttribute('data-oss-object-name');
                    const existingImg = existingPreviewContainer ? existingPreviewContainer.querySelector('img') : null;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªæ–‡ä»¶
                    const currentObjectName = ossFileInfo.url || ossFileInfo.name;
                    if (existingImg && existingObjectName === currentObjectName && ossFileInfo.isImage) {
                        // æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜ç°æœ‰å›¾ç‰‡ä¿¡æ¯ä»¥ä¾¿åç»­æ¢å¤
                        needReloadImage = false;
                        existingPreviewInfo = {
                            src: existingImg.src,
                            alt: existingImg.alt,
                            style: existingImg.style.cssText
                        };
                        console.log('æ£€æµ‹åˆ°ç›¸åŒOSSæ–‡ä»¶ï¼Œä¿ç•™ç°æœ‰å›¾ç‰‡é¢„è§ˆï¼Œä¸é‡æ–°åŠ è½½');
                    }
                }
            }
            
            // æ„å»ºOSSæ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºå†…å®¹
            let fileInfoHtml = `
                <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(68, 160, 141, 0.05)); border-radius: 12px; border-left: 3px solid #4ECDC4;">
                    <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">ğŸ“„</span>
                        <span style="font-weight: 600; font-size: 15px; color: #374151;">${this.escapeHtml(ossFileInfo.name || 'OSSæ–‡ä»¶')}</span>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; font-weight: 500;">ğŸ”— æ–‡ä»¶åœ°å€</div>
                        <a href="${ossFileInfo.url}" target="_blank" style="word-break: break-all; color: #2196F3; text-decoration: none; font-size: 13px; display: inline-block; max-width: 100%;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${this.escapeHtml(ossFileInfo.url)}</a>
                    </div>
            `;
            
            // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼ˆç´§æŒ¨ç€æ–‡ä»¶åœ°å€ä¸‹é¢ï¼Œä½¿ç”¨å ä½ç¬¦ï¼Œç¨åå¼‚æ­¥åŠ è½½ï¼‰
            if (ossFileInfo.isImage && (ossFileInfo.url || ossFileInfo.name)) {
                const objectName = ossFileInfo.url || ossFileInfo.name;
                const previewId = `oss-preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                fileInfoHtml += `
                    <div style="margin-bottom: 12px;" data-oss-preview-section data-oss-object-name="${this.escapeHtml(objectName)}">
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px; font-weight: 500;">ğŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆ</div>
                        <div id="${previewId}" data-oss-preview-container style="border-radius: 8px; overflow: hidden; background: #f3f4f6; padding: 8px; display: inline-block; max-width: 100%;">
                            <div style="padding: 40px; text-align: center; color: #9ca3af; font-size: 14px;">æ­£åœ¨åŠ è½½å›¾ç‰‡...</div>
                        </div>
                    </div>
                `;
                
                // åªæœ‰åœ¨éœ€è¦é‡æ–°åŠ è½½å›¾ç‰‡æ—¶æ‰æ‰§è¡Œå¼‚æ­¥åŠ è½½
                if (needReloadImage) {
                    // å¼‚æ­¥åŠ è½½å›¾ç‰‡ï¼ˆåœ¨ DOM æ›´æ–°åï¼‰
                    setTimeout(async () => {
                        const previewContainer = document.getElementById(previewId);
                        if (!previewContainer) {
                            return;
                        }
                        
                        try {
                            let downloadUrl = null;
                            const objectNameValue = objectName;
                            
                            // å¦‚æœå¯¹è±¡åçœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„URLï¼ˆåŒ…å« http:// æˆ– https://ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
                            if (objectNameValue.startsWith('http://') || objectNameValue.startsWith('https://')) {
                                downloadUrl = objectNameValue;
                                console.log('æ£€æµ‹åˆ°å®Œæ•´URLï¼Œç›´æ¥ä½¿ç”¨:', downloadUrl);
                            } else {
                                // å¦åˆ™ï¼Œé€šè¿‡OSS APIè·å–ä¸‹è½½URL
                                if (!this.ossApi || !this.ossApi.isEnabled()) {
                                    throw new Error('OSS APIæœªå¯ç”¨ï¼Œæ— æ³•è·å–å›¾ç‰‡ä¸‹è½½URL');
                                }
                                
                                console.log('æ­£åœ¨é€šè¿‡OSS APIè·å–ä¸‹è½½URLï¼ˆæ¬¢è¿æ¶ˆæ¯ï¼‰ï¼Œå¯¹è±¡å:', objectNameValue);
                                downloadUrl = await this.ossApi.getDownloadUrl(objectNameValue, 3600);
                                
                                if (!downloadUrl) {
                                    throw new Error('è·å–ä¸‹è½½URLå¤±è´¥ï¼Œè¿”å›ä¸ºç©º');
                                }
                                
                                console.log('æˆåŠŸè·å–OSSå›¾ç‰‡ä¸‹è½½URLï¼ˆæ¬¢è¿æ¶ˆæ¯ï¼‰:', downloadUrl);
                            }
                            
                            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                            const img = document.createElement('img');
                            // ä½¿ç”¨OSSå›¾ç‰‡å¤„ç†ä¼˜åŒ–æ¬¢è¿æ¶ˆæ¯ä¸­çš„å›¾ç‰‡ï¼ˆæœ€å¤§å®½åº¦800pxï¼Œè´¨é‡80ï¼‰
                            const optimizedUrl = this.generateOssImageProcessUrl(downloadUrl, {
                                width: 800,
                                quality: 80,
                                keepAspectRatio: true
                            });
                            img.src = optimizedUrl;
                            img.alt = this.escapeHtml(ossFileInfo.name || 'å›¾ç‰‡é¢„è§ˆ');
                            img.style.cssText = 'max-width: 100%; max-height: 400px; border-radius: 4px; object-fit: contain; display: block; margin: 0 auto; cursor: pointer;';
                            
                            // å›¾ç‰‡åŠ è½½æˆåŠŸå¤„ç†
                            img.addEventListener('load', () => {
                                console.log('OSSå›¾ç‰‡åŠ è½½æˆåŠŸï¼ˆæ¬¢è¿æ¶ˆæ¯ï¼‰:', downloadUrl);
                            });
                            
                            // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
                            img.addEventListener('error', () => {
                                console.warn('OSSå›¾ç‰‡åŠ è½½å¤±è´¥ï¼ˆæ¬¢è¿æ¶ˆæ¯ï¼‰:', downloadUrl);
                                previewContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
                            });
                            
                            // ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
                            img.addEventListener('click', () => {
                                this.showImagePreview(downloadUrl);
                            });
                            
                            // æ›´æ–°å®¹å™¨å†…å®¹
                            previewContainer.innerHTML = '';
                            previewContainer.appendChild(img);
                            
                        } catch (error) {
                            console.error('è·å–OSSå›¾ç‰‡ä¸‹è½½URLå¤±è´¥ï¼ˆæ¬¢è¿æ¶ˆæ¯ï¼‰:', error);
                            previewContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #ef4444;">æ— æ³•åŠ è½½å›¾ç‰‡é¢„è§ˆï¼š${this.escapeHtml(error.message || 'æœªçŸ¥é”™è¯¯')}</div>`;
                        }
                    }, 0);
                } else if (existingPreviewInfo) {
                    // ä¿ç•™ç°æœ‰å›¾ç‰‡é¢„è§ˆï¼Œåœ¨DOMæ›´æ–°åæ¢å¤å›¾ç‰‡
                    setTimeout(() => {
                        const newPreviewSection = messageText.querySelector('[data-oss-preview-section]');
                        const newPreviewContainer = newPreviewSection ? newPreviewSection.querySelector('[data-oss-preview-container]') : null;
                        if (newPreviewContainer && existingPreviewInfo) {
                            // æ¢å¤å›¾ç‰‡å…ƒç´ 
                            const img = document.createElement('img');
                            // å¦‚æœåŸURLæ˜¯OSS URLï¼Œä½¿ç”¨ä¼˜åŒ–åçš„URL
                            const optimizedSrc = this.generateOssImageProcessUrl(existingPreviewInfo.src, {
                                width: 800,
                                quality: 80,
                                keepAspectRatio: true
                            });
                            img.src = optimizedSrc;
                            img.alt = existingPreviewInfo.alt;
                            img.style.cssText = existingPreviewInfo.style;
                            
                            // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                            img.addEventListener('click', () => {
                                this.showImagePreview(existingPreviewInfo.src);
                            });
                            
                            // æ›´æ–°å®¹å™¨å†…å®¹
                            newPreviewContainer.innerHTML = '';
                            newPreviewContainer.appendChild(img);
                            console.log('å·²æ¢å¤ç°æœ‰å›¾ç‰‡é¢„è§ˆï¼Œæ— éœ€é‡æ–°åŠ è½½');
                        }
                    }, 0);
                }
            }
            
            // å¦‚æœæœ‰æè¿°ï¼Œæ˜¾ç¤ºæè¿°ï¼ˆåœ¨å›¾ç‰‡é¢„è§ˆä¹‹åï¼‰
            if (ossFileInfo.description && ossFileInfo.description.trim()) {
                fileInfoHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; font-weight: 500;">ğŸ“ æ–‡ä»¶æè¿°</div>
                        <div style="font-size: 13px; color: #4B5563; line-height: 1.5;">${this.escapeHtml(ossFileInfo.description)}</div>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶å…ƒä¿¡æ¯ï¼ˆå¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰ï¼‰
            if (ossFileInfo.size_human || ossFileInfo.last_modified_str) {
                fileInfoHtml += `
                    <div style="margin-bottom: 0; padding-top: 12px; border-top: 1px solid rgba(78, 205, 196, 0.2);">
                        <div style="font-size: 12px; color: #6B7280; display: flex; gap: 16px; flex-wrap: wrap;">
                            ${ossFileInfo.size_human ? `<span>ğŸ“Š å¤§å°: ${this.escapeHtml(ossFileInfo.size_human)}</span>` : ''}
                            ${ossFileInfo.last_modified_str ? `<span>ğŸ“… ä¿®æ”¹æ—¶é—´: ${this.escapeHtml(ossFileInfo.last_modified_str)}</span>` : ''}
                        </div>
                    </div>
                `;
            }
            
            fileInfoHtml += `</div>`;
            
            // æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦å·²å­˜åœ¨äºåç«¯ä¼šè¯åˆ—è¡¨ä¸­ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            const shouldShowSaveButton = !(await this.isSessionInBackendList(this.currentSessionId));
            
            // æ ¹æ®æ£€æŸ¥ç»“æœå†³å®šæ˜¯å¦æ·»åŠ æ‰‹åŠ¨ä¿å­˜ä¼šè¯æŒ‰é’®
            if (shouldShowSaveButton) {
                fileInfoHtml += `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(78, 205, 196, 0.2);">
                        <button id="pet-manual-save-session-btn" class="pet-manual-save-btn" style="
                            position: relative !important;
                            display: flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            gap: 8px !important;
                            width: 100% !important;
                            padding: 10px 20px !important;
                            background: linear-gradient(135deg, #4ECDC4, #44A08D) !important;
                            color: white !important;
                            border: none !important;
                            border-radius: 10px !important;
                            font-size: 14px !important;
                            font-weight: 600 !important;
                            cursor: pointer !important;
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.25), 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                            overflow: hidden !important;
                            user-select: none !important;
                        ">
                            <span class="save-btn-icon" style="
                                display: inline-flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                font-size: 16px !important;
                                transition: transform 0.3s ease !important;
                            ">ğŸ’¾</span>
                            <span class="save-btn-text">ä¿å­˜ä¼šè¯</span>
                            <span class="save-btn-loader" style="
                                display: none !important;
                                position: absolute !important;
                                width: 16px !important;
                                height: 16px !important;
                                border: 2px solid rgba(255, 255, 255, 0.3) !important;
                                border-top-color: white !important;
                                border-radius: 50% !important;
                                animation: spin 0.8s linear infinite !important;
                            "></span>
                        </button>
                        <style>
                            @keyframes spin {
                                to { transform: rotate(360deg); }
                            }
                            .pet-manual-save-btn:hover:not(:disabled) {
                                transform: translateY(-2px) !important;
                                box-shadow: 0 4px 12px rgba(78, 205, 196, 0.35), 0 2px 6px rgba(0, 0, 0, 0.15) !important;
                            }
                            .pet-manual-save-btn:active:not(:disabled) {
                                transform: translateY(0) !important;
                                box-shadow: 0 1px 4px rgba(78, 205, 196, 0.2) !important;
                            }
                            .pet-manual-save-btn:disabled {
                                opacity: 0.7 !important;
                                cursor: not-allowed !important;
                                transform: none !important;
                            }
                            .pet-manual-save-btn.loading .save-btn-icon,
                            .pet-manual-save-btn.loading .save-btn-text {
                                opacity: 0 !important;
                            }
                            .pet-manual-save-btn.loading .save-btn-loader {
                                display: block !important;
                            }
                            .pet-manual-save-btn.success {
                                background: linear-gradient(135deg, #4CAF50, #45a049) !important;
                                box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3) !important;
                            }
                            .pet-manual-save-btn.error {
                                background: linear-gradient(135deg, #f44336, #d32f2f) !important;
                                box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3) !important;
                            }
                        </style>
                    </div>
                `;
            }
            
            // æ›´æ–°æ¬¢è¿æ¶ˆæ¯çš„å†…å®¹
            // messageText å·²åœ¨ä¸Šé¢å£°æ˜ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
            if (messageText) {
                messageText.innerHTML = fileInfoHtml;
                // æ›´æ–°åŸå§‹HTML
                messageText.setAttribute('data-original-text', fileInfoHtml);
                
                // é‡æ–°ç»‘å®šæ‰‹åŠ¨ä¿å­˜æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼ˆinnerHTML ä¼šç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œæ‰€ä»¥ç›´æ¥ç»‘å®šå³å¯ï¼‰
                const saveBtn = messageText.querySelector('#pet-manual-save-session-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        this.handleManualSaveSession(saveBtn);
                    });
                }
            }
            
            console.log('OSSæ–‡ä»¶æ¬¢è¿æ¶ˆæ¯å·²åˆ·æ–°');
            return;
        }

        const pageInfo = {
            title: session.pageTitle || document.title || 'å½“å‰é¡µé¢',
            url: session.url || window.location.href,
            description: session.pageDescription || ''
        };

        // è·å–é¡µé¢å›¾æ ‡
        const pageIconUrl = this.getPageIconUrl();

        // é‡æ–°æ„å»ºé¡µé¢ä¿¡æ¯æ˜¾ç¤ºå†…å®¹
        let pageInfoHtml = `
            <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(68, 160, 141, 0.05)); border-radius: 12px; border-left: 3px solid #4ECDC4;">
                <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <img src="${pageIconUrl}" alt="é¡µé¢å›¾æ ‡" style="width: 20px; height: 20px; border-radius: 4px; object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none'">
                    <span style="font-weight: 600; font-size: 15px; color: #374151;">${this.escapeHtml(pageInfo.title)}</span>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; font-weight: 500;">ğŸ”— ç½‘å€</div>
                    <a href="${pageInfo.url}" target="_blank" style="word-break: break-all; color: #2196F3; text-decoration: none; font-size: 13px; display: inline-block; max-width: 100%;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${this.escapeHtml(pageInfo.url)}</a>
                </div>
        `;

        if (pageInfo.description && pageInfo.description.trim()) {
            pageInfoHtml += `
                <div style="margin-bottom: 0;">
                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; font-weight: 500;">ğŸ“ é¡µé¢æè¿°</div>
                    <div class="markdown-content" style="font-size: 13px; color: #4B5563; line-height: 1.5;">${this.renderMarkdown(pageInfo.description)}</div>
                </div>
            `;
        }

        pageInfoHtml += `</div>`;
        
        // æ£€æŸ¥å½“å‰ä¼šè¯æ˜¯å¦å·²å­˜åœ¨äºåç«¯ä¼šè¯åˆ—è¡¨ä¸­ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºä¿å­˜æŒ‰é’®
        const shouldShowSaveButton = !(await this.isSessionInBackendList(this.currentSessionId));
        
        // æ ¹æ®æ£€æŸ¥ç»“æœå†³å®šæ˜¯å¦æ·»åŠ æ‰‹åŠ¨ä¿å­˜ä¼šè¯æŒ‰é’®
        if (shouldShowSaveButton) {
        pageInfoHtml += `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(78, 205, 196, 0.2);">
                <button id="pet-manual-save-session-btn" class="pet-manual-save-btn" style="
                    position: relative !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    gap: 8px !important;
                    width: 100% !important;
                    padding: 10px 20px !important;
                    background: linear-gradient(135deg, #4ECDC4, #44A08D) !important;
                    color: white !important;
                    border: none !important;
                    border-radius: 10px !important;
                    font-size: 14px !important;
                    font-weight: 600 !important;
                    cursor: pointer !important;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                    box-shadow: 0 2px 8px rgba(78, 205, 196, 0.25), 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                    overflow: hidden !important;
                    user-select: none !important;
                ">
                    <span class="save-btn-icon" style="
                        display: inline-flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        font-size: 16px !important;
                        transition: transform 0.3s ease !important;
                    ">ğŸ’¾</span>
                    <span class="save-btn-text">ä¿å­˜ä¼šè¯</span>
                    <span class="save-btn-loader" style="
                        display: none !important;
                        position: absolute !important;
                        width: 16px !important;
                        height: 16px !important;
                        border: 2px solid rgba(255, 255, 255, 0.3) !important;
                        border-top-color: white !important;
                        border-radius: 50% !important;
                        animation: spin 0.8s linear infinite !important;
                    "></span>
                </button>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                    .pet-manual-save-btn:hover:not(:disabled) {
                        transform: translateY(-2px) !important;
                        box-shadow: 0 4px 12px rgba(78, 205, 196, 0.35), 0 2px 6px rgba(0, 0, 0, 0.15) !important;
                    }
                    .pet-manual-save-btn:active:not(:disabled) {
                        transform: translateY(0) !important;
                        box-shadow: 0 1px 4px rgba(78, 205, 196, 0.2) !important;
                    }
                    .pet-manual-save-btn:disabled {
                        opacity: 0.7 !important;
                        cursor: not-allowed !important;
                        transform: none !important;
                    }
                    .pet-manual-save-btn.loading .save-btn-icon,
                    .pet-manual-save-btn.loading .save-btn-text {
                        opacity: 0 !important;
                    }
                    .pet-manual-save-btn.loading .save-btn-loader {
                        display: block !important;
                    }
                    .pet-manual-save-btn.success {
                        background: linear-gradient(135deg, #4CAF50, #45a049) !important;
                        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3) !important;
                    }
                    .pet-manual-save-btn.error {
                        background: linear-gradient(135deg, #f44336, #d32f2f) !important;
                        box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3) !important;
                    }
                </style>
            </div>
        `;
        }

        // æ›´æ–°æ¬¢è¿æ¶ˆæ¯çš„å†…å®¹
        const messageText = welcomeMessage.querySelector('[data-message-type="pet-bubble"]');
        if (messageText) {
            messageText.innerHTML = pageInfoHtml;
            // æ›´æ–°åŸå§‹HTML
            messageText.setAttribute('data-original-text', pageInfoHtml);
            
            // é‡æ–°ç»‘å®šæ‰‹åŠ¨ä¿å­˜æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼ˆinnerHTML ä¼šç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œæ‰€ä»¥ç›´æ¥ç»‘å®šå³å¯ï¼‰
            const saveBtn = messageText.querySelector('#pet-manual-save-session-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    this.handleManualSaveSession(saveBtn);
                });
            }
        }

        console.log('æ¬¢è¿æ¶ˆæ¯å·²åˆ·æ–°');
    }

    // HTMLè½¬ä¹‰è¾…åŠ©æ–¹æ³•ï¼ˆé˜²æ­¢XSSï¼‰
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    getCurrentTime() {
        const now = new Date();
        return this.formatTimestamp(now.getTime());
    }

    // æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºå¹´æœˆæ—¥æ—¶åˆ†æ ¼å¼
    formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}:${minute}`;
    }

    // æ·»åŠ èŠå¤©æ»šåŠ¨æ¡æ ·å¼
    addChatScrollbarStyles() {
        if (document.getElementById('pet-chat-styles')) return;

        const style = document.createElement('style');
        style.id = 'pet-chat-styles';
        style.textContent = `
            @keyframes messageSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Chrome/Safari æ»šåŠ¨æ¡æ ·å¼ */
            #pet-chat-messages::-webkit-scrollbar {
                width: 8px;
            }

            #pet-chat-messages::-webkit-scrollbar-track {
                background: rgba(241, 241, 241, 0.5);
                border-radius: 4px;
            }

            #pet-chat-messages::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 4px;
                border: 1px solid transparent;
                background-clip: padding-box;
            }

            #pet-chat-messages::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }

            /* Firefox æ»šåŠ¨æ¡æ ·å¼ */
            #pet-chat-messages {
                scrollbar-width: thin;
                scrollbar-color: #c1c1c1 rgba(241, 241, 241, 0.5);
            }

            /* ç¡®ä¿æ¶ˆæ¯å®¹å™¨å¯ä»¥æ»šåŠ¨ */
            #pet-chat-messages {
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }
        `;
        document.head.appendChild(style);
    }

    // æ’­æ”¾èŠå¤©åŠ¨ç”»
    playChatAnimation() {
        if (!this.pet) return;

        // å…ˆæ¸…ç†ä¹‹å‰çš„åŠ¨ç”»
        if (this.chatBubbleInterval) {
            clearInterval(this.chatBubbleInterval);
            this.chatBubbleInterval = null;
        }
        if (this.lastChatBubble && this.lastChatBubble.parentNode) {
            this.lastChatBubble.parentNode.removeChild(this.lastChatBubble);
            this.lastChatBubble = null;
        }

        // æ·»åŠ æ€è€ƒåŠ¨ç”»ï¼ˆæ›´ä¸°å¯Œçš„åŠ¨ç”»æ•ˆæœï¼‰
        this.pet.style.animation = 'none';
        setTimeout(() => {
            // éšæœºé€‰æ‹©ä¸åŒçš„åŠ¨ç”»æ•ˆæœ
            const animations = [
                'petThinking 0.8s ease-in-out infinite',
                'petThinkingBounce 1.2s ease-in-out infinite',
                'petThinkingPulse 1s ease-in-out infinite'
            ];
            const selectedAnimation = animations[Math.floor(Math.random() * animations.length)];
            this.pet.style.animation = selectedAnimation;
        }, 10);

        // æ·»åŠ èŠå¤©æ°”æ³¡æ•ˆæœ
        this.showChatBubble();
    }

    // æ˜¾ç¤ºèŠå¤©æ°”æ³¡
    showChatBubble() {
        if (!this.pet) return;

        // åˆ›å»ºèŠå¤©æ°”æ³¡
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        bubble.style.cssText = `
            position: absolute !important;
            top: -40px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: rgba(0, 0, 0, 0.8) !important;
            color: white !important;
            padding: 8px 12px !important;
            border-radius: 12px !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            z-index: 2147483648 !important;
            pointer-events: none !important;
            animation: bubbleAppear 0.5s ease-out !important;
        `;

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('chat-bubble-styles')) {
            const style = document.createElement('style');
            style.id = 'chat-bubble-styles';
            style.textContent = `
                @keyframes petThinking {
                    0%, 100% { transform: scale(1) rotate(0deg); }
                    25% { transform: scale(1.1) rotate(-5deg); }
                    50% { transform: scale(1.05) rotate(5deg); }
                    75% { transform: scale(1.1) rotate(-3deg); }
                }

                @keyframes petThinkingBounce {
                    0%, 100% { transform: translateY(0) scale(1); }
                    50% { transform: translateY(-8px) scale(1.08); }
                }

                @keyframes petThinkingPulse {
                    0%, 100% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.15); opacity: 0.9; }
                }

                @keyframes bubbleAppear {
                    0% {
                        opacity: 0;
                        transform: translateX(-50%) translateY(10px) scale(0.8);
                    }
                    100% {
                        opacity: 1;
                        transform: translateX(-50%) translateY(0) scale(1);
                    }
                }
            `;
            if (document.head) {
                document.head.appendChild(style);
            }
        }

        // éšæœºé€‰æ‹©æ€è€ƒæ–‡æœ¬ï¼ˆæ›´æœ‰è¶£çš„æç¤ºè¯­ï¼‰
        const thinkingTexts = [
            'ğŸ¤” è®©æˆ‘æƒ³æƒ³...',
            'ğŸ’­ æ€è€ƒä¸­...',
            'âœ¨ çµæ„Ÿæ¶Œç°',
            'ğŸŒŸ æ•´ç†æ€è·¯',
            'ğŸ¯ æ·±åº¦åˆ†æ',
            'ğŸ” æœç´¢ç­”æ¡ˆ',
            'ğŸ’¡ æƒ³æ³•æ¥äº†',
            'ğŸŒŠ å¤´è„‘é£æš´',
            'ğŸ“ ç»„ç»‡è¯­è¨€',
            'ğŸ¨ é…é…¿å›å¤',
            'âš¡ å¿«æƒ³å¥½äº†',
            'ğŸŒˆ æ— é™æ¥è¿‘',
            'ğŸš€ é©¬ä¸Šå°±æ¥'
        ];
        bubble.textContent = thinkingTexts[Math.floor(Math.random() * thinkingTexts.length)];

        this.pet.appendChild(bubble);

        // ä¿å­˜æ°”æ³¡åˆ°å®ä¾‹ä»¥ä¾¿åç»­æ›´æ–°
        this.lastChatBubble = bubble;

        // åŠ¨æ€æ›´æ–°æ°”æ³¡æ–‡æœ¬ï¼ˆè®©ç”¨æˆ·æ„Ÿå—åˆ°è¿›å±•ï¼‰
        const updateBubbleInterval = setInterval(() => {
            if (bubble.parentNode) {
                let newText;
                do {
                    newText = thinkingTexts[Math.floor(Math.random() * thinkingTexts.length)];
                } while (newText === bubble.textContent && thinkingTexts.length > 1);
                bubble.textContent = newText;
            } else {
                clearInterval(updateBubbleInterval);
            }
        }, 1500);

        // ä¿å­˜intervalä»¥ä¾¿åç»­æ¸…ç†
        this.chatBubbleInterval = updateBubbleInterval;

        // 3ç§’åç§»é™¤æ°”æ³¡
        setTimeout(() => {
            clearInterval(updateBubbleInterval);
            if (bubble.parentNode) {
                bubble.style.animation = 'bubbleAppear 0.3s ease-out reverse';
                setTimeout(() => {
                    if (bubble.parentNode) {
                        bubble.parentNode.removeChild(bubble);
                    }
                    this.lastChatBubble = null;
                }, 300);
            }
        }, 3000);
    }

    // æˆªå›¾åŠŸèƒ½ï¼ˆæ”¯æŒåŒºåŸŸé€‰æ‹©ï¼‰
    async takeScreenshot() {
        try {
            console.log('å¼€å§‹æˆªå›¾...');

            // æ£€æŸ¥Chrome APIå¯ç”¨æ€§
            if (!this.checkChromeAPIAvailability()) {
                this.showScreenshotNotification('Chrome APIä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'error');
                return;
            }

            // æ·»åŠ è¯¦ç»†çš„æƒé™è¯Šæ–­
            await this.diagnosePermissions();

            // æ£€æŸ¥æƒé™
            const hasPermission = await this.checkScreenshotPermission();
            if (!hasPermission) {
                this.showScreenshotNotification('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°åŠ è½½æ‰©å±•æˆ–æ‰‹åŠ¨æˆäºˆæƒé™', 'error');
                this.showPermissionHelp();
                return;
            }

            // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦å…è®¸æˆªå›¾
            if (this.isSystemPage()) {
                this.showScreenshotNotification('æ— æ³•æˆªå–ç³»ç»Ÿé¡µé¢ï¼Œè¯·åœ¨å…¶ä»–ç½‘é¡µä¸­ä½¿ç”¨æˆªå›¾åŠŸèƒ½', 'error');
                return;
            }

            // éšè—èŠå¤©çª—å£ä»¥è·å–æ›´æ¸…æ™°çš„æˆªå›¾
            const originalDisplay = this.chatWindow ? this.chatWindow.style.display : 'block';
            if (this.chatWindow) {
                this.chatWindow.style.display = 'none';
            }

            // éšè—å® ç‰©ï¼ˆå¦‚æœæ˜¾ç¤ºçš„è¯ï¼‰
            const originalPetDisplay = this.pet ? this.pet.style.display : 'block';
            if (this.pet) {
                this.pet.style.display = 'none';
            }

            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿çª—å£å®Œå…¨éšè—
            await new Promise(resolve => setTimeout(resolve, 200));

            // å°è¯•ä½¿ç”¨Chromeçš„captureVisibleTab APIæˆªå›¾
            let dataUrl = await this.captureVisibleTab();

            // å¦‚æœä¸»è¦æ–¹æ³•å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•
            if (!dataUrl) {
                console.log('ä¸»è¦æˆªå›¾æ–¹æ³•å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•...');
                this.showScreenshotNotification('ä¸»è¦æ–¹æ³•å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•...', 'info');
                dataUrl = await this.fallbackScreenshot();
            }

            if (dataUrl) {
                // ä¿æŒèŠå¤©çª—å£å’Œå® ç‰©éšè—ï¼Œç›´åˆ°åŒºåŸŸé€‰æ‹©å®Œæˆ
                this.showAreaSelector(dataUrl, originalDisplay, originalPetDisplay);
            } else {
                // å¦‚æœæˆªå›¾å¤±è´¥ï¼Œæ¢å¤æ˜¾ç¤º
                if (this.chatWindow) {
                    this.chatWindow.style.display = originalDisplay;
                }
                if (this.pet) {
                    this.pet.style.display = originalPetDisplay;
                }
                this.showScreenshotNotification('æˆªå›¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®æˆ–å°è¯•åˆ·æ–°é¡µé¢', 'error');
                this.showPermissionHelp();
            }

        } catch (error) {
            console.error('æˆªå›¾å¤±è´¥:', error);
            this.showScreenshotNotification('æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');

            // ç¡®ä¿èŠå¤©çª—å£å’Œå® ç‰©æ¢å¤æ˜¾ç¤º
            if (this.chatWindow) {
                this.chatWindow.style.display = 'block';
            }
            if (this.pet) {
                this.pet.style.display = 'block';
            }
        }
    }

    // æ˜¾ç¤ºåŒºåŸŸé€‰æ‹©å™¨
    showAreaSelector(dataUrl, originalChatDisplay = 'block', originalPetDisplay = 'block') {
        // åˆ›å»ºåŒºåŸŸé€‰æ‹©å™¨è¦†ç›–å±‚
        const overlay = document.createElement('div');
        overlay.id = 'area-selector-overlay';
        overlay.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 2147483651 !important;
            cursor: crosshair !important;
            user-select: none !important;
        `;

        // å…ˆåŠ è½½å›¾ç‰‡ä»¥è·å–çœŸå®å°ºå¯¸
        const img = new Image();
        img.src = dataUrl;

        // åˆ›å»ºæˆªå›¾èƒŒæ™¯å®¹å™¨
        const screenshotBg = document.createElement('div');
        screenshotBg.style.cssText = `
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            opacity: 0.7 !important;
        `;

        // åˆ›å»ºå®é™…å›¾ç‰‡å…ƒç´ 
        const screenshotImg = document.createElement('img');
        screenshotImg.src = dataUrl;
        screenshotImg.style.cssText = `
            max-width: 100% !important;
            max-height: 100% !important;
            object-fit: contain !important;
        `;

        screenshotBg.appendChild(screenshotImg);

        // åˆ›å»ºé€‰æ‹©æ¡†
        const selectionBox = document.createElement('div');
        selectionBox.id = 'selection-box';
        selectionBox.style.cssText = `
            position: absolute !important;
            border: 2px solid #2196F3 !important;
            background: rgba(33, 150, 243, 0.1) !important;
            pointer-events: none !important;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3) !important;
            display: none !important;
        `;

        // åˆ›å»ºå·¥å…·æç¤º
        const tipText = document.createElement('div');
        tipText.id = 'selection-tip';
        tipText.textContent = 'æ‹–åŠ¨é¼ æ ‡é€‰æ‹©æˆªå›¾åŒºåŸŸï¼ŒåŒå‡»ç¡®è®¤';
        tipText.style.cssText = `
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: rgba(0, 0, 0, 0.8) !important;
            color: white !important;
            padding: 12px 20px !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            pointer-events: none !important;
            z-index: 2147483652 !important;
        `;

        overlay.appendChild(screenshotBg);
        overlay.appendChild(selectionBox);
        overlay.appendChild(tipText);

        // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåå†æ·»åŠ åˆ°é¡µé¢å¹¶è®¾ç½®äº‹ä»¶ç›‘å¬
        img.onload = () => {
            document.body.appendChild(overlay);
            setupEventListeners();
        };

        // å¦‚æœå›¾ç‰‡å·²ç»åŠ è½½å®Œæˆ
        if (img.complete && img.naturalHeight !== 0) {
            document.body.appendChild(overlay);
            setupEventListeners();
        }

        let isSelecting = false;
        let startX = 0;
        let startY = 0;

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨çš„å‡½æ•°
        const setupEventListeners = () => {
            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
            overlay.addEventListener('mousedown', (e) => {
                isSelecting = true;
                startX = e.clientX;
                startY = e.clientY;

                selectionBox.style.left = startX + 'px';
                selectionBox.style.top = startY + 'px';
                selectionBox.style.width = '0px';
                selectionBox.style.height = '0px';
                selectionBox.style.display = 'block';

                // éšè—æç¤º
                tipText.style.display = 'none';

                e.preventDefault();
            });

            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            overlay.addEventListener('mousemove', (e) => {
                if (!isSelecting) return;

                const currentX = e.clientX;
                const currentY = e.clientY;

                const left = Math.min(startX, currentX);
                const top = Math.min(startY, currentY);
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);

                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
            });

            // é¼ æ ‡é‡Šæ”¾æˆ–åŒå‡»äº‹ä»¶
            const finishSelection = (e) => {
                if (!isSelecting) return;
                isSelecting = false;

                const rect = selectionBox.getBoundingClientRect();

                // å¦‚æœåŒºåŸŸå¤ªå°ï¼Œå…³é—­é€‰æ‹©å™¨å¹¶æ¢å¤æ˜¾ç¤º
                if (rect.width < 10 || rect.height < 10) {
                    if (tipText) tipText.remove();
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    // æ¢å¤èŠå¤©çª—å£å’Œå® ç‰©æ˜¾ç¤º
                    this.restoreElements(originalChatDisplay, originalPetDisplay);
                    return;
                }

                // è®¡ç®—æˆªå–åŒºåŸŸçš„ç›¸å¯¹åæ ‡ï¼ˆç›¸å¯¹äºåŸå§‹æˆªå›¾å°ºå¯¸ï¼‰
                // ä½¿ç”¨å·²ç»åŠ è½½çš„å›¾ç‰‡
                const imgRect = screenshotImg.getBoundingClientRect();

                // è®¡ç®—å›¾ç‰‡åœ¨é¡µé¢ä¸­çš„å®é™…æ˜¾ç¤ºå°ºå¯¸å’Œä½ç½®
                const imgDisplayWidth = imgRect.width;
                const imgDisplayHeight = imgRect.height;
                const imgDisplayX = imgRect.left;
                const imgDisplayY = imgRect.top;

                // è®¡ç®—åŸå§‹å›¾ç‰‡å’Œæ˜¾ç¤ºå›¾ç‰‡çš„ç¼©æ”¾æ¯”ä¾‹
                const scaleX = img.width / imgDisplayWidth;
                const scaleY = img.height / imgDisplayHeight;

                // å°†é€‰æ‹©æ¡†ç›¸å¯¹äºå›¾ç‰‡çš„ä½ç½®è½¬æ¢ä¸ºåŸå§‹å›¾ç‰‡çš„åæ ‡
                const relativeX = rect.left - imgDisplayX;
                const relativeY = rect.top - imgDisplayY;
                const relativeWidth = rect.width;
                const relativeHeight = rect.height;

                // è½¬æ¢ä¸ºåŸå§‹å›¾ç‰‡åæ ‡
                const actualX = relativeX * scaleX;
                const actualY = relativeY * scaleY;
                const actualWidth = relativeWidth * scaleX;
                const actualHeight = relativeHeight * scaleY;

                // ç§»é™¤é€‰æ‹©å™¨
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }

                // æ¢å¤èŠå¤©çª—å£å’Œå® ç‰©æ˜¾ç¤º
                this.restoreElements(originalChatDisplay, originalPetDisplay);

                // è£å‰ªå›¾ç‰‡
                this.cropAndDisplayScreenshot(dataUrl, actualX, actualY, actualWidth, actualHeight);
            };

            overlay.addEventListener('mouseup', finishSelection);
            overlay.addEventListener('dblclick', finishSelection);

            // ESCé”®å–æ¶ˆ
            const cancelHandler = (e) => {
                if (e.key === 'Escape') {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    // æ¢å¤èŠå¤©çª—å£å’Œå® ç‰©æ˜¾ç¤º
                    this.restoreElements(originalChatDisplay, originalPetDisplay);
                    window.removeEventListener('keydown', cancelHandler);
                }
            };
            window.addEventListener('keydown', cancelHandler);
        };
    }

    // æ¢å¤å…ƒç´ æ˜¾ç¤º
    restoreElements(chatDisplay, petDisplay) {
        if (this.chatWindow) {
            this.chatWindow.style.display = chatDisplay;
        }
        if (this.pet) {
            this.pet.style.display = petDisplay;
        }
    }

    // è£å‰ªå¹¶æ˜¾ç¤ºæˆªå›¾
    cropAndDisplayScreenshot(dataUrl, x, y, width, height) {
        const img = new Image();
        img.src = dataUrl;

        img.onload = () => {
            // åˆ›å»ºcanvasè¿›è¡Œè£å‰ª
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, x, y, width, height, 0, 0, width, height);

            // è½¬æ¢ä¸ºdata URL
            const croppedDataUrl = canvas.toDataURL('image/png');

            this.showScreenshotPreview(croppedDataUrl);
        };
    }

    // æƒé™è¯Šæ–­
    async diagnosePermissions() {
        console.log('=== æƒé™è¯Šæ–­å¼€å§‹ ===');

        // æ£€æŸ¥Chrome APIå¯ç”¨æ€§
        console.log('Chrome APIå¯ç”¨æ€§:', {
            chrome: typeof chrome !== 'undefined',
            runtime: typeof chrome !== 'undefined' && !!chrome.runtime,
            tabs: typeof chrome !== 'undefined' && !!chrome.tabs,
            permissions: 'é€šè¿‡background scriptæ£€æŸ¥'
        });

        // æ£€æŸ¥å½“å‰é¡µé¢ä¿¡æ¯
        console.log('å½“å‰é¡µé¢ä¿¡æ¯:', {
            url: window.location.href,
            protocol: window.location.protocol,
            hostname: window.location.hostname,
            isSystemPage: this.isSystemPage()
        });

        // æ£€æŸ¥æ‰©å±•ä¿¡æ¯
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            try {
                const manifest = chrome.runtime.getManifest();
                console.log('æ‰©å±•ä¿¡æ¯:', {
                    name: manifest.name,
                    version: manifest.version,
                    permissions: manifest.permissions,
                    host_permissions: manifest.host_permissions
                });
            } catch (error) {
                console.error('è·å–æ‰©å±•ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // é€šè¿‡background scriptè·å–æƒé™ä¿¡æ¯
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({
                action: 'checkPermissions'
            }, (response) => {
                if (chrome.runtime.lastError) {
                    console.error('è·å–æƒé™ä¿¡æ¯å¤±è´¥:', chrome.runtime.lastError.message);
                } else if (response && response.success) {
                    console.log('æƒé™çŠ¶æ€:', response.permissions);
                }
            });
        }

        console.log('=== æƒé™è¯Šæ–­ç»“æŸ ===');
    }

    // æ˜¾ç¤ºæƒé™å¸®åŠ©
    showPermissionHelp() {
        const helpModal = document.createElement('div');
        helpModal.id = 'permission-help-modal';
        helpModal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.8) !important;
            z-index: 2147483651 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            animation: fadeIn 0.3s ease-out !important;
        `;

        const helpContainer = document.createElement('div');
        helpContainer.style.cssText = `
            background: white !important;
            border-radius: 16px !important;
            padding: 30px !important;
            max-width: 500px !important;
            max-height: 80% !important;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3) !important;
            position: relative !important;
            animation: scaleIn 0.3s ease-out !important;
            overflow-y: auto !important;
        `;

        helpContainer.innerHTML = `
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 20px; font-weight: 600; text-align: center;">
                ğŸ”§ æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ
            </h3>

            <div style="margin-bottom: 20px;">
                <h4 style="color: #ff6b6b; margin-bottom: 10px;">ğŸ“‹ è§£å†³æ­¥éª¤ï¼š</h4>
                <ol style="color: #666; line-height: 1.6; padding-left: 20px;">
                    <li>æ‰“å¼€ Chrome æ‰©å±•ç®¡ç†é¡µé¢ï¼š<code>chrome://extensions/</code></li>
                    <li>æ‰¾åˆ°"æ¸©æŸ”é™ªä¼´åŠ©æ‰‹"æ‰©å±•</li>
                    <li>ç‚¹å‡»"é‡æ–°åŠ è½½"æŒ‰é’®</li>
                    <li>ç¡®ä¿"åœ¨æ‰€æœ‰ç½‘ç«™ä¸Š"æƒé™å·²å¯ç”¨</li>
                    <li>åˆ·æ–°å½“å‰ç½‘é¡µ</li>
                    <li>é‡æ–°å°è¯•æˆªå›¾åŠŸèƒ½</li>
                </ol>
            </div>

            <div style="margin-bottom: 20px;">
                <h4 style="color: #FF9800; margin-bottom: 10px;">âš ï¸ Chrome APIé—®é¢˜ï¼š</h4>
                <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                    <li>å¦‚æœæ˜¾ç¤º"Chrome APIä¸å¯ç”¨"ï¼Œè¯·åˆ·æ–°é¡µé¢</li>
                    <li>ç¡®ä¿åœ¨æ™®é€šç½‘é¡µä¸­ä½¿ç”¨ï¼ˆéç³»ç»Ÿé¡µé¢ï¼‰</li>
                    <li>æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ˜¯æœ€æ–°ç‰ˆæœ¬</li>
                    <li>å°è¯•é‡å¯æµè§ˆå™¨</li>
                </ul>
            </div>

            <div style="margin-bottom: 20px;">
                <h4 style="color: #4CAF50; margin-bottom: 10px;">ğŸ’¡ å…¶ä»–è§£å†³æ–¹æ¡ˆï¼š</h4>
                <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                    <li>å°è¯•åœ¨å…¶ä»–ç½‘é¡µä¸­ä½¿ç”¨æˆªå›¾åŠŸèƒ½</li>
                    <li>æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ˜¯æœ€æ–°ç‰ˆæœ¬</li>
                    <li>æš‚æ—¶ç¦ç”¨å…¶ä»–å¯èƒ½å†²çªçš„æ‰©å±•</li>
                    <li>é‡å¯æµè§ˆå™¨åé‡è¯•</li>
                </ul>
            </div>

            <div style="text-align: center;">
                <button id="open-extensions-page" style="
                    padding: 12px 24px;
                    background: linear-gradient(135deg, #2196F3, #1976D2);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-right: 10px;
                    transition: all 0.3s ease;
                ">ğŸš€ æ‰“å¼€æ‰©å±•ç®¡ç†é¡µé¢</button>

                <button id="close-help-modal" style="
                    padding: 12px 24px;
                    background: linear-gradient(135deg, #f44336, #d32f2f);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">å…³é—­</button>
            </div>
        `;

        helpModal.appendChild(helpContainer);
        document.body.appendChild(helpModal);

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('open-extensions-page').addEventListener('click', () => {
            window.open('chrome://extensions/', '_blank');
        });

        document.getElementById('close-help-modal').addEventListener('click', () => {
            this.closePermissionHelp();
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                this.closePermissionHelp();
            }
        });

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('help-modal-styles')) {
            const style = document.createElement('style');
            style.id = 'help-modal-styles';
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }

                @keyframes scaleIn {
                    from {
                        opacity: 0;
                        transform: scale(0.8);
                    }
                    to {
                        opacity: 1;
                        transform: scale(1);
                    }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // å…³é—­æƒé™å¸®åŠ©
    closePermissionHelp() {
        const modal = document.getElementById('permission-help-modal');
        if (modal) {
            modal.style.animation = 'fadeIn 0.3s ease-out reverse';
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿé¡µé¢
    isSystemPage() {
        const url = window.location.href;
        return url.startsWith('chrome://') ||
               url.startsWith('chrome-extension://') ||
               url.startsWith('moz-extension://') ||
               url.startsWith('about:') ||
               url.startsWith('edge://') ||
               url.startsWith('browser://');
    }

    // æ£€æŸ¥Chrome APIå¯ç”¨æ€§
    checkChromeAPIAvailability() {
        console.log('æ£€æŸ¥Chrome APIå¯ç”¨æ€§...');

        const apiStatus = {
            chrome: typeof chrome !== 'undefined',
            runtime: typeof chrome !== 'undefined' && !!chrome.runtime,
            tabs: typeof chrome !== 'undefined' && !!chrome.tabs
        };

        console.log('APIçŠ¶æ€:', apiStatus);

        if (!apiStatus.chrome) {
            console.error('Chromeå¯¹è±¡ä¸å­˜åœ¨');
            return false;
        }

        if (!apiStatus.runtime) {
            console.error('Chrome runtime APIä¸å¯ç”¨');
            return false;
        }

        // æµ‹è¯•runtime APIæ˜¯å¦æ­£å¸¸å·¥ä½œ
        try {
            const manifest = chrome.runtime.getManifest();
            if (!manifest || !manifest.name) {
                console.error('æ— æ³•è·å–æ‰©å±•manifest');
                return false;
            }
            console.log('âœ… Chrome APIå¯ç”¨ï¼Œæ‰©å±•:', manifest.name);
            return true;
        } catch (error) {
            console.error('Chrome runtime APIæµ‹è¯•å¤±è´¥:', error);
            return false;
        }
    }

    // æ£€æŸ¥æˆªå›¾æƒé™
    async checkScreenshotPermission() {
        return new Promise((resolve) => {
            console.log('å¼€å§‹æ£€æŸ¥æˆªå›¾æƒé™...');

            // æ£€æŸ¥chrome runtime APIæ˜¯å¦å¯ç”¨
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                console.error('Chrome runtime APIä¸å¯ç”¨');
                resolve(false);
                return;
            }

            // é€šè¿‡background scriptæ£€æŸ¥æƒé™
            chrome.runtime.sendMessage({
                action: 'checkPermissions'
            }, (response) => {
                console.log('æƒé™æ£€æŸ¥å“åº”:', response);

                if (chrome.runtime.lastError) {
                    console.error('æƒé™æ£€æŸ¥å¤±è´¥:', chrome.runtime.lastError.message);
                    resolve(false);
                    return;
                }

                if (response && response.success && response.permissions) {
                    const permissions = response.permissions;
                    console.log('å½“å‰æƒé™åˆ—è¡¨:', permissions);

                    // æ£€æŸ¥æ˜¯å¦æœ‰activeTabæƒé™
                    const hasActiveTab = permissions.permissions && permissions.permissions.includes('activeTab');
                    console.log('activeTabæƒé™çŠ¶æ€:', hasActiveTab);

                    if (hasActiveTab) {
                        console.log('âœ… activeTabæƒé™å·²å­˜åœ¨');
                        resolve(true);
                    } else {
                        console.log('âŒ activeTabæƒé™ä¸å­˜åœ¨');
                        resolve(false);
                    }
                } else {
                    console.error('æƒé™æ£€æŸ¥å“åº”æ— æ•ˆ:', response);
                    resolve(false);
                }
            });
        });
    }

    // å¤‡ç”¨æˆªå›¾æ–¹æ³•
    async fallbackScreenshot() {
        try {
            console.log('å°è¯•å¤‡ç”¨æˆªå›¾æ–¹æ³•...');

            // æ–¹æ³•1: ä½¿ç”¨html2canvasåº“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (typeof html2canvas !== 'undefined') {
                console.log('ä½¿ç”¨html2canvasåº“æˆªå›¾...');
                try {
                    const canvas = await html2canvas(document.body, {
                        allowTaint: true,
                        useCORS: true,
                        scale: 0.5, // é™ä½åˆ†è¾¨ç‡ä»¥æé«˜æ€§èƒ½
                        logging: false,
                        width: window.innerWidth,
                        height: window.innerHeight
                    });
                    return canvas.toDataURL('image/png');
                } catch (error) {
                    console.error('html2canvasæˆªå›¾å¤±è´¥:', error);
                }
            }

            // æ–¹æ³•2: ä½¿ç”¨getDisplayMedia API
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                console.log('å°è¯•ä½¿ç”¨getDisplayMedia API...');
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            mediaSource: 'screen',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });

                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.style.position = 'fixed';
                    video.style.top = '-9999px';
                    video.style.left = '-9999px';
                    video.style.opacity = '0';
                    video.style.pointerEvents = 'none';
                    document.body.appendChild(video);

                    return new Promise((resolve) => {
                        const timeout = setTimeout(() => {
                            console.error('getDisplayMediaè¶…æ—¶');
                            // æ¸…ç†èµ„æº
                            stream.getTracks().forEach(track => track.stop());
                            if (video.parentNode) {
                                document.body.removeChild(video);
                            }
                            resolve(null);
                        }, 10000); // 10ç§’è¶…æ—¶

                        video.addEventListener('loadedmetadata', () => {
                            clearTimeout(timeout);
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;

                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(video, 0, 0);

                                // æ¸…ç†èµ„æº
                                stream.getTracks().forEach(track => track.stop());
                                if (video.parentNode) {
                                    document.body.removeChild(video);
                                }

                                resolve(canvas.toDataURL('image/png'));
                            } catch (error) {
                                console.error('å¤„ç†getDisplayMediaè§†é¢‘æ—¶å‡ºé”™:', error);
                                // æ¸…ç†èµ„æº
                                stream.getTracks().forEach(track => track.stop());
                                if (video.parentNode) {
                                    document.body.removeChild(video);
                                }
                                resolve(null);
                            }
                        });

                        video.addEventListener('error', (error) => {
                            clearTimeout(timeout);
                            console.error('è§†é¢‘åŠ è½½é”™è¯¯:', error);
                            // æ¸…ç†èµ„æº
                            stream.getTracks().forEach(track => track.stop());
                            if (video.parentNode) {
                                document.body.removeChild(video);
                            }
                            resolve(null);
                        });

                        video.play().catch(error => {
                            clearTimeout(timeout);
                            console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
                            // æ¸…ç†èµ„æº
                            stream.getTracks().forEach(track => track.stop());
                            if (video.parentNode) {
                                document.body.removeChild(video);
                            }
                            resolve(null);
                        });
                    });
                } catch (error) {
                    console.error('getDisplayMediaæˆªå›¾å¤±è´¥:', error);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æƒé™è¢«æ‹’ç»
                    if (error.name === 'NotAllowedError') {
                        console.log('ç”¨æˆ·æ‹’ç»äº†å±å¹•å…±äº«æƒé™');
                    }
                }
            }

            // æ–¹æ³•3: ç®€å•çš„é¡µé¢æˆªå›¾ï¼ˆä»…å¯è§åŒºåŸŸï¼‰
            console.log('å°è¯•ç®€å•é¡µé¢æˆªå›¾...');
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // è®¾ç½®ç”»å¸ƒå¤§å°ä¸ºè§†å£å¤§å°
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                // å¡«å……èƒŒæ™¯è‰²
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // æ·»åŠ æ–‡æœ¬è¯´æ˜
                ctx.fillStyle = '#333333';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æˆªå›¾åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨', canvas.width / 2, canvas.height / 2);
                ctx.fillText('è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–é‡æ–°åŠ è½½æ‰©å±•', canvas.width / 2, canvas.height / 2 + 30);

                return canvas.toDataURL('image/png');
            } catch (error) {
                console.error('ç®€å•æˆªå›¾å¤±è´¥:', error);
            }

            return null;
        } catch (error) {
            console.error('å¤‡ç”¨æˆªå›¾æ–¹æ³•å¤±è´¥:', error);
            return null;
        }
    }

    // ä½¿ç”¨Chrome APIæˆªå›¾
    async captureVisibleTab() {
        return new Promise((resolve) => {
            console.log('å‘é€æˆªå›¾è¯·æ±‚åˆ°background script...');

            // æ£€æŸ¥chrome APIæ˜¯å¦å¯ç”¨
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                console.error('Chrome APIä¸å¯ç”¨');
                resolve(null);
                return;
            }

            // è®¾ç½®è¶…æ—¶å¤„ç†
            const timeout = setTimeout(() => {
                console.error('æˆªå›¾è¯·æ±‚è¶…æ—¶');
                resolve(null);
            }, 10000); // 10ç§’è¶…æ—¶

            chrome.runtime.sendMessage({
                action: 'captureVisibleTab'
            }, (response) => {
                clearTimeout(timeout);
                console.log('æ”¶åˆ°background scriptå“åº”:', response);

                if (chrome.runtime.lastError) {
                    console.error('Chrome runtimeé”™è¯¯:', chrome.runtime.lastError.message);
                    console.error('é”™è¯¯è¯¦æƒ…:', chrome.runtime.lastError);

                    // æ£€æŸ¥æ˜¯å¦æ˜¯æƒé™ç›¸å…³é”™è¯¯
                    if (chrome.runtime.lastError.message.includes('permission') ||
                        chrome.runtime.lastError.message.includes('denied') ||
                        chrome.runtime.lastError.message.includes('not allowed')) {
                        console.error('æƒé™è¢«æ‹’ç»ï¼Œéœ€è¦é‡æ–°æˆæƒ');
                    }

                    resolve(null);
                } else if (response && response.success) {
                    console.log('æˆªå›¾æˆåŠŸï¼Œæ•°æ®URLé•¿åº¦:', response.dataUrl ? response.dataUrl.length : 0);
                    resolve(response.dataUrl);
                } else {
                    console.error('æˆªå›¾APIè°ƒç”¨å¤±è´¥:', response);
                    console.error('å“åº”è¯¦æƒ…:', JSON.stringify(response, null, 2));
                    resolve(null);
                }
            });
        });
    }

    // æ˜¾ç¤ºæˆªå›¾é¢„è§ˆ
    showScreenshotPreview(dataUrl) {
        // åˆ›å»ºæˆªå›¾é¢„è§ˆæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.id = 'screenshot-preview-modal';
        modal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.8) !important;
            z-index: 2147483649 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            animation: fadeIn 0.3s ease-out !important;
        `;

        // åˆ›å»ºé¢„è§ˆå®¹å™¨
        const previewContainer = document.createElement('div');
        previewContainer.style.cssText = `
            background: white !important;
            border-radius: 16px !important;
            padding: 20px !important;
            max-width: 90% !important;
            max-height: 90% !important;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3) !important;
            position: relative !important;
            animation: scaleIn 0.3s ease-out !important;
        `;

        // åˆ›å»ºæ ‡é¢˜
        const title = document.createElement('h3');
        title.innerHTML = 'ğŸ“· æˆªå›¾é¢„è§ˆ';
        title.style.cssText = `
            margin: 0 0 20px 0 !important;
            color: #333 !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            text-align: center !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
        `;

        // åˆ›å»ºå›¾ç‰‡é¢„è§ˆ
        const img = document.createElement('img');
        img.src = dataUrl;
        img.style.cssText = `
            max-width: 100% !important;
            max-height: 60vh !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        `;

        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
            display: flex !important;
            gap: 12px !important;
            margin-top: 20px !important;
            justify-content: center !important;
        `;

        // ä¿å­˜æŒ‰é’®
        const saveButton = document.createElement('button');
        saveButton.innerHTML = 'ğŸ’¾ ä¿å­˜å›¾ç‰‡';
        saveButton.style.cssText = `
            padding: 12px 24px !important;
            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        `;
        saveButton.addEventListener('click', () => {
            this.downloadScreenshot(dataUrl);
            this.closeScreenshotPreview();
        });

        // å¤åˆ¶æŒ‰é’®
        const copyButton = document.createElement('button');
        copyButton.innerHTML = 'ğŸ“‹ å¤åˆ¶';
        copyButton.style.cssText = `
            padding: 12px 24px !important;
            background: linear-gradient(135deg, #2196F3, #1976D2) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        `;
        copyButton.addEventListener('click', async () => {
            try {
                // å°†å›¾ç‰‡è½¬æ¢ä¸ºblob
                const response = await fetch(dataUrl);
                const blob = await response.blob();

                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                await navigator.clipboard.write([
                    new ClipboardItem({
                        [blob.type]: blob
                    })
                ]);
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                this.showScreenshotNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨ä¿å­˜åŠŸèƒ½', 'error');
            }
        });

        // å…³é—­æŒ‰é’®
        const closeButton = document.createElement('button');
        closeButton.textContent = 'å…³é—­';
        closeButton.style.cssText = `
            padding: 12px 24px !important;
            background: linear-gradient(135deg, #f44336, #d32f2f) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        `;
        closeButton.addEventListener('click', () => {
            this.closeScreenshotPreview();
        });

        // æ·»åŠ æ‚¬åœæ•ˆæœ
        [saveButton, copyButton, closeButton].forEach(button => {
            button.addEventListener('mouseenter', () => {
                button.style.transform = 'translateY(-2px)';
                button.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            });
            button.addEventListener('mouseleave', () => {
                button.style.transform = 'translateY(0)';
                button.style.boxShadow = 'none';
            });
        });

        // ç»„è£…é¢„è§ˆæ¡†
        buttonContainer.appendChild(saveButton);
        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(closeButton);
        previewContainer.appendChild(title);
        previewContainer.appendChild(img);
        previewContainer.appendChild(buttonContainer);
        modal.appendChild(previewContainer);

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(modal);

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeScreenshotPreview();
            }
        });

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('screenshot-modal-styles')) {
            const style = document.createElement('style');
            style.id = 'screenshot-modal-styles';
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }

                @keyframes scaleIn {
                    from {
                        opacity: 0;
                        transform: scale(0.8);
                    }
                    to {
                        opacity: 1;
                        transform: scale(1);
                    }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // å…³é—­æˆªå›¾é¢„è§ˆ
    closeScreenshotPreview() {
        const modal = document.getElementById('screenshot-preview-modal');
        if (modal) {
            modal.style.animation = 'fadeIn 0.3s ease-out reverse';
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }
    }

    // ä¸‹è½½æˆªå›¾
    downloadScreenshot(dataUrl) {
        try {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `screenshot_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;

            // è§¦å‘ä¸‹è½½
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            this.showScreenshotNotification('å›¾ç‰‡å·²ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹', 'success');
        } catch (error) {
            console.error('ä¸‹è½½å¤±è´¥:', error);
            this.showScreenshotNotification('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    // æ˜¾ç¤ºé€šçŸ¥
    showNotification(message, type = 'success') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `pet-notification ${type}`;
        notification.textContent = message;

        const backgroundColor = type === 'error' ? '#f44336' :
                               type === 'info' ? '#2196F3' : '#4CAF50';

        notification.style.cssText = `
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            background: ${backgroundColor} !important;
            color: white !important;
            padding: 12px 20px !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            z-index: 2147483650 !important;
            animation: slideInRight 0.3s ease-out !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
        `;

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `;
            document.head.appendChild(style);
        }

        document.body.appendChild(notification);

        // 3ç§’åç§»é™¤é€šçŸ¥
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, 3000);
    }

    // æ˜¾ç¤ºæˆªå›¾é€šçŸ¥
    showScreenshotNotification(message, type = 'success') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `screenshot-notification ${type}`;
        notification.textContent = message;

        const backgroundColor = type === 'error' ? '#f44336' :
                               type === 'info' ? '#2196F3' : '#4CAF50';

        notification.style.cssText = `
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            background: ${backgroundColor} !important;
            color: white !important;
            padding: 12px 20px !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            z-index: 2147483650 !important;
            animation: slideInRight 0.3s ease-out !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
        `;

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('screenshot-notification-styles')) {
            const style = document.createElement('style');
            style.id = 'screenshot-notification-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `;
            document.head.appendChild(style);
        }

        document.body.appendChild(notification);

        // 3ç§’åç§»é™¤é€šçŸ¥
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, 3000);
    }

} // ç»“æŸ PetManager ç±»
    
    // å°† PetManager èµ‹å€¼ç»™ windowï¼Œé˜²æ­¢é‡å¤å£°æ˜
    window.PetManager = PetManager;
})(); // ç»“æŸç«‹å³æ‰§è¡Œå‡½æ•°

// åˆå§‹åŒ–å® ç‰©ç®¡ç†å™¨ï¼ˆé˜²æ­¢é‡å¤åˆå§‹åŒ–ï¼‰
if (typeof window.petManager === 'undefined') {
    window.petManager = new window.PetManager();
}

// é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
window.addEventListener('beforeunload', () => {
    if (window.petManager) {
        window.petManager.cleanup();
    }
});

// é¡µé¢éšè—æ—¶æš‚åœæŸäº›åŠŸèƒ½
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('é¡µé¢éšè—ï¼Œæš‚åœæŸäº›åŠŸèƒ½');
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æš‚åœé€»è¾‘
    } else {
        console.log('é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤åŠŸèƒ½');
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ¢å¤é€»è¾‘
    }
});

console.log('Content Script å®Œæˆ');






















































